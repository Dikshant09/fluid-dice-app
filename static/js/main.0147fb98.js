/*! For license information please see main.0147fb98.js.LICENSE.txt */
(()=>{var e={2264:(e,t,n)=>{"use strict";n.d(t,{CL:()=>g,G0:()=>h,Ln:()=>f,fG:()=>p,lh:()=>s,uz:()=>d});var r=n(8400),i=n(5994);const s=new r.d((()=>a(u()))),o={getRawConfig:()=>{}},a=e=>void 0!==e&&null!==e?new h(void 0,{getRawConfig:t=>{try{var n,r;return null===(n=l(null!==(r=e.getItem(t))&&void 0!==r?r:void 0))||void 0===n?void 0:n.raw}catch{return}}}):o;function c(e){switch(e){case"boolean":case"number":case"string":return!0;default:return!1}}function l(e){let t,n=e;if("string"===typeof e)try{n=JSON.parse(e),t={raw:e,string:e}}catch{}if(void 0===n)return t;const r=typeof n;if(c(r))return{...t,raw:e,[r]:n};if(Array.isArray(n)){const r=typeof n[0];if(!c(r))return t;for(const e of n)if(typeof e!==r)return t;return{...t,raw:e,["".concat(r,"[]")]:n}}return t}const u=()=>{try{var e;return null!==(e=globalThis.sessionStorage)&&void 0!==e?e:void 0}catch{return}};class h{constructor(e){this.logger=e,this.configCache=new Map,this.orderedBaseProviders=[];const t=new Set;for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];const s=[...r];for(;s.length>0;){const e=s.shift();void 0!==e&&m(e)&&!t.has(e)&&(t.add(e),e instanceof h?s.push(...e.orderedBaseProviders):this.orderedBaseProviders.push(e))}}getBoolean(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.boolean}getNumber(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.number}getString(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.string}getBooleanArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["boolean[]"]}getNumberArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["number[]"]}getStringArray(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t["string[]"]}getRawConfig(e){var t;return null===(t=this.getCacheEntry(e))||void 0===t?void 0:t.raw}getCacheEntry(e){if(!this.configCache.has(e)){for(const n of this.orderedBaseProviders){const r=l(null===n||void 0===n?void 0:n.getRawConfig(e));var t;if(void 0!==r)return this.configCache.set(e,r),null===(t=this.logger)||void 0===t||t.send({category:"generic",eventName:"ConfigRead",...(0,i.Df)({configName:e,configValue:JSON.stringify(r)})}),r}this.configCache.set(e,{raw:void 0})}return this.configCache.get(e)}}function d(e){const t=e;return m(null===t||void 0===t?void 0:t.config)&&void 0!==(null===t||void 0===t?void 0:t.logger)}function f(e){return d(e)?e:p(e,s.value)}function p(e){if(d(e))throw new Error("Logger is already a monitoring context");const t=e;for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return t.config=new h(e,...r),t.logger=e,t}function m(e){return"function"===typeof(null===e||void 0===e?void 0:e.getRawConfig)}function g(e){return f((0,i.pW)(e))}},56:(e,t,n)=>{"use strict";n.d(t,{iq:()=>k,i5:()=>N,AV:()=>d,oD:()=>g,aX:()=>v,OQ:()=>T,vt:()=>w,dy:()=>f,qp:()=>C,cQ:()=>p,J4:()=>y,G:()=>b});const r={randomUUID:"undefined"!==typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let i;const s=new Uint8Array(16);function o(){if(!i&&(i="undefined"!==typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!i))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return i(s)}const a=[];for(let I=0;I<256;++I)a.push((I+256).toString(16).slice(1));function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return a[e[t+0]]+a[e[t+1]]+a[e[t+2]]+a[e[t+3]]+"-"+a[e[t+4]]+a[e[t+5]]+"-"+a[e[t+6]]+a[e[t+7]]+"-"+a[e[t+8]]+a[e[t+9]]+"-"+a[e[t+10]]+a[e[t+11]]+a[e[t+12]]+a[e[t+13]]+a[e[t+14]]+a[e[t+15]]}const l=function(e,t,n){if(r.randomUUID&&!t&&!e)return r.randomUUID();const i=(e=e||{}).random||(e.rng||o)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=i[e];return t}return c(i)};var u=n(3941);const h=e=>null!==e&&!Array.isArray(e)&&"object"===typeof e;function d(e,t){const n={message:"string"===typeof(null===e||void 0===e?void 0:e.message)?e.message:String(e)};if(h(e)){const{errorType:r,stack:i,name:s}=e;if("string"===typeof r&&(n.errorType=r),"string"===typeof i){const e="string"===typeof s?s:void 0;n.stack=((e,n)=>{if(!t)return e;const r=e.split("\n");return r.shift(),void 0!==n&&r.unshift(n),r.join("\n")})(i,e)}}return n}const f=e=>"function"===typeof(null===e||void 0===e?void 0:e.getTelemetryProperties);function p(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var n;if((0,u.cp)(e)&&function(e){const t=e;void 0===t.errorInstanceId&&(t.errorInstanceId=l())}(e),(0,u.Xy)(e))return e.addTelemetryProperties(null!==(n=t.props)&&void 0!==n?n:{}),e;const{message:r,stack:i}=d(e,!1),s=new F({message:r,stack:i});if("object"===typeof e&&null!==e){const t=e;let n;var o,a;if("canRetry"in e)null!==(o=n)&&void 0!==o||(n={}),n.canRetry=t.canRetry;if("retryAfterSeconds"in e)null!==(a=n)&&void 0!==a||(n={}),n.retryAfterSeconds=t.retryAfterSeconds;void 0!==n&&Object.assign(s,n)}"object"!==typeof e&&s.addTelemetryProperties({typeofError:typeof e});const c=k.typeCheck(e)?e.getTelemetryProperties():{untrustedOrigin:1};return s.addTelemetryProperties({...c,...t.props}),s}let m;function g(){const e=new Error("<<generated stack>>");if(void 0===m&&(m=void 0!==e.stack),m)return e;try{throw e}catch(t){return t}}function v(){return g().stack}function y(e,t){const{message:n,stack:r}=d(e,!1),i=t(n);return void 0!==r&&S(i,r),w(e)&&i.addTelemetryProperties({untrustedOrigin:1}),(0,u.fV)(e)&&(i.overwriteErrorInstanceId(e.errorInstanceId),i.addTelemetryProperties({innerErrorInstanceId:e.errorInstanceId})),f(e)&&i.addTelemetryProperties(e.getTelemetryProperties()),i}function b(e,t,n){const r=y(e,t),i=r.errorInstanceId,s=i;return n.sendTelemetryEvent({eventName:"WrapError",errorInstanceId:i,wrappedByErrorInstanceId:s},e),r}function S(e,t){try{Object.assign(e,{stack:t})}catch{e.addTelemetryProperties({stack2:t})}}function w(e){return k.typeCheck(e)?e.errorType===N&&1===e.getTelemetryProperties().untrustedOrigin:!(0,u.cp)(e)}function C(e){return"string"===typeof(null===e||void 0===e?void 0:e.tag)}function x(e,t){return Array.isArray(e)&&e.every((e=>E(e)))?JSON.stringify(e):E(e)?e:(console.error("UnSupported Format of Logging Error Property for key ".concat(t,":"),e),"REDACTED (arbitrary object)")}function E(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return!0;default:return!1}}const T=()=>{const e=new WeakSet;return(t,n)=>{if("object"===typeof n&&null!==n){if(e.has(n))return"<removed/circular>";e.add(n)}return n}};class k extends Error{get errorInstanceId(){return this._errorInstanceId}overwriteErrorInstanceId(e){this._errorInstanceId=e}constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Set;super(e),this.omitPropsFromLogging=n,this._errorInstanceId=l(),this.fluidErrorCode="-",n.add("omitPropsFromLogging"),n.add("_errorInstanceId"),t&&this.addTelemetryProperties(t)}static typeCheck(e){return"object"===typeof e&&null!==e&&("function"===typeof e.addTelemetryProperties&&"function"===typeof e.getTelemetryProperties&&"string"===typeof e.errorInstanceId)}addTelemetryProperties(e){!function(e,t){for(const n of Object.keys(t))void 0===e[n]&&(e[n]=t[n])}(this,e)}getTelemetryProperties(){return{...function(e,t){const n={};for(const r of Object.keys(e)){if(t.has(r))continue;const i=e[r];n[r]=C(i)?{value:x(i.value,r),tag:i.tag}:x(i,r)}return n}(this,this.omitPropsFromLogging),stack:this.stack,message:this.message,errorInstanceId:this._errorInstanceId}}}const N="genericError";class F extends k{constructor(e){super(e.message),this.errorType=N,void 0!==e.stack&&S(this,e.stack)}}},3941:(e,t,n)=>{"use strict";n.d(t,{Xy:()=>s,cp:()=>o,fV:()=>i});const r=e=>"function"===typeof(null===e||void 0===e?void 0:e.getTelemetryProperties)&&"function"===typeof(null===e||void 0===e?void 0:e.addTelemetryProperties),i=e=>"string"===typeof(null===e||void 0===e?void 0:e.errorInstanceId);function s(e){return"string"===typeof(null===e||void 0===e?void 0:e.errorType)&&"string"===typeof(null===e||void 0===e?void 0:e.message)&&i(e)&&r(e)}function o(e){return"string"===typeof(null===e||void 0===e?void 0:e.errorType)&&"string"===typeof(null===e||void 0===e?void 0:e.message)&&r(e)}},5994:(e,t,n)=>{"use strict";n.d(t,{Bt:()=>v,Df:()=>S,Hf:()=>u,T0:()=>l,Z:()=>m,ZK:()=>c,gn:()=>d,mc:()=>r,pW:()=>f});var r,i=n(107),s=n(1605),o=n(2264),a=n(56);function c(e){if(void 0===e||null===e)return;const t=Number(e);return Number.isNaN(t)?e:t}function l(e){return Math.floor(e)}!function(e){e.CodeArtifact="CodeArtifact",e.UserData="UserData"}(r||(r={}));const u=":";class h{static sanitizePkgName(e){return e.replace("@","").replace("/","-")}static prepareErrorObject(e,t,n){const{message:r,errorType:i,stack:s}=(0,a.AV)(t,!0);if(e.stack=s,e.error=r,e.errorType=i,(0,a.dy)(t)){const n=t.getTelemetryProperties();for(const t of Object.keys(n))void 0===e[t]&&(e[t]=n[t])}void 0===e.stack&&n&&(e.stack=(0,a.aX)())}constructor(e,t){this.namespace=e,this.properties=t}sendTelemetryEvent(e,t){var n;let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:i.$.default;this.sendTelemetryEventCore({...e,category:null!==(n=e.category)&&void 0!==n?n:"generic"},t,"error"===e.category?i.$.error:r)}sendTelemetryEventCore(e,t,n){const r=function(e){let{category:t,eventName:n,...r}=e;const i={category:t,eventName:n};for(const s of Object.keys(r))i[s]=y(r[s]);return i}(e);void 0!==t&&h.prepareErrorObject(r,t,!1),"number"===typeof r.duration&&(r.duration=l(r.duration)),this.send(r,n)}sendErrorEvent(e,t){this.sendTelemetryEventCore({error:e.eventName,...e,category:"error"},t,i.$.error)}sendPerformanceEvent(e,t){var n;let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:i.$.default;const s={...e,category:null!==(n=e.category)&&void 0!==n?n:"performance"};this.sendTelemetryEventCore(s,t,"error"===s.category?i.$.error:r)}prepareEvent(e){const t="error"===e.category||void 0!==e.error,n={...e};return void 0!==this.namespace&&(n.eventName="".concat(this.namespace).concat(h.eventNamespaceSeparator).concat(n.eventName)),this.extendProperties(n,t)}extendProperties(e,t){const n=e;if(this.properties){const e=[];e.push(this.properties.all),t&&e.push(this.properties.error);for(const t of e)if(void 0!==t)for(const e of Object.keys(t)){if(void 0!==n[e])continue;const r=t[e],i="function"===typeof r?r():r;void 0!==i&&(n[e]=i)}}return e}}h.eventNamespaceSeparator=u;class d{constructor(e){this.logger=e}send(e){const t={category:e.category,eventName:e.eventName};for(const n of Object.keys(e)){const i=e[n],{value:s,tag:o}="object"===typeof i?i:{value:i,tag:void 0};switch(o){case void 0:case"PackageData":case r.CodeArtifact:t[n]=s;break;case r.UserData:t[n]="REDACTED (UserData)";break;default:t[n]="REDACTED (unknown tag)"}}this.logger.send(t)}}function f(e){return p.create(null===e||void 0===e?void 0:e.logger,null===e||void 0===e?void 0:e.namespace,null===e||void 0===e?void 0:e.properties)}class p extends h{static create(e,t,n){if(e instanceof p){const r={};for(const t of[e.properties,n])void 0!==t&&(void 0!==t.all&&(r.all={...r.all,...t.all}),void 0!==t.error&&(r.error={...r.error,...t.error}));const i=void 0===e.namespace?t:void 0===t?e.namespace:"".concat(e.namespace).concat(h.eventNamespaceSeparator).concat(t),s=new p(e.baseLogger,i,r);return!(0,o.uz)(s)&&(0,o.uz)(e)&&(0,o.fG)(s,e.config),s}return new p(null!==e&&void 0!==e?e:{send(){}},t,n)}constructor(e,t,n){super(t,n),this.baseLogger=e,(0,o.uz)(e)&&(0,o.fG)(this,new o.G0(this,e.config))}get minLogLevel(){return this.baseLogger.minLogLevel}shouldFilterOutEvent(e,t){var n;return(null!==t&&void 0!==t?t:i.$.default)<(null!==(n=this.baseLogger.minLogLevel)&&void 0!==n?n:i.$.default)}send(e,t){this.shouldFilterOutEvent(e,t)||this.baseLogger.send(this.prepareEvent(e),t)}}function m(e){var t;return new g(e.namespace,e.properties,null===(t=e.loggers)||void 0===t?void 0:t.filter((e=>void 0!==e)),e.tryInheritProperties)}class g extends h{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=arguments.length>3?arguments[3]:void 0,s=void 0===t?void 0:{...t};if(!0===r){var o;const e=null!==(o=s)&&void 0!==o?o:s={};n.filter((e=>e instanceof h)).map((e=>{var t;return null!==(t=e.properties)&&void 0!==t?t:{}})).forEach((t=>{Object.keys(t).forEach((n=>{e[n]={...t[n],...null===e||void 0===e?void 0:e[n]}}))}))}super(e,s),this.loggers=n,this._minLogLevelOfAllLoggers=i.$.default,this.calculateMinLogLevel()}get minLogLevel(){return this._minLogLevelOfAllLoggers}calculateMinLogLevel(){if(this.loggers.length>0){const t=[];for(const n of this.loggers){var e;t.push(null!==(e=n.minLogLevel)&&void 0!==e?e:i.$.default)}this._minLogLevelOfAllLoggers=Math.min(...t)}}addLogger(e){void 0!==e&&null!==e&&(this.loggers.push(e),this.calculateMinLogLevel())}send(e){const t=this.prepareEvent(e);for(const n of this.loggers)n.send(t)}}class v{static start(e,t,n){return new v(e,t,n,arguments.length>3&&void 0!==arguments[3]&&arguments[3],!(arguments.length>4&&void 0!==arguments[4])||arguments[4])}static timedExec(e,t,n,r){let i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;const s=v.start(e,t,r,void 0,v.shouldReport(t,i));try{const e=n(s);return s.autoEnd(),e}catch(o){throw s.cancel(void 0,o),o}}static async timedExecAsync(e,t,n,r,i){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1;const o=v.start(e,t,r,i,v.shouldReport(t,s));try{const e=await n(o);return o.autoEnd(),e}catch(a){throw o.cancel(void 0,a),a}}get duration(){return s.F.now()-this.startTime}constructor(e,t){var n;let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{end:!0,cancel:"generic"},i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];this.logger=e,this.markers=r,this.recordHeapSize=i,this.emitLogs=o,this.startTime=s.F.now(),this.startMemoryCollection=0,this.event={...t},this.markers.start&&this.reportEvent("start"),"object"===typeof window&&null!==(n=window)&&void 0!==n&&null!==(n=n.performance)&&void 0!==n&&n.mark&&(this.startMark="".concat(t.eventName,"-start"),window.performance.mark(this.startMark))}reportProgress(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"update";this.reportEvent(t,e)}autoEnd(){this.event&&this.markers.end&&this.reportEvent("end"),this.performanceEndMark(),this.event=void 0}end(e){this.reportEvent("end",e),this.performanceEndMark(),this.event=void 0}performanceEndMark(){if(this.startMark&&this.event){const e="".concat(this.event.eventName,"-end");window.performance.mark(e),window.performance.measure("".concat(this.event.eventName),this.startMark,e),this.startMark=void 0}}cancel(e,t){void 0!==this.markers.cancel&&this.reportEvent("cancel",{category:this.markers.cancel,...e},t),this.event=void 0}reportEvent(e,t,n){if(!this.event)return;if(!this.emitLogs)return;const r={...this.event,...t};if(r.eventName="".concat(r.eventName,"_").concat(e),"start"!==e){if(r.duration=this.duration,this.startMemoryCollection){var i;const e=null===s.F||void 0===s.F||null===(i=s.F.memory)||void 0===i?void 0:i.usedJSHeapSize,t=Math.floor((e-this.startMemoryCollection)/1024);t>0&&(r.usedJSHeapSize=t)}}else if(this.recordHeapSize){var o;this.startMemoryCollection=null===s.F||void 0===s.F||null===(o=s.F.memory)||void 0===o?void 0:o.usedJSHeapSize}this.logger.sendPerformanceEvent(r,n)}static shouldReport(e,t){var n;const r=".".concat(e.category,".").concat(e.eventName),i=null!==(n=v.eventHits.get(r))&&void 0!==n?n:0;return v.eventHits.set(r,i>=t?1:i+1),i%t===0}}v.eventHits=new Map;function y(e){return(0,a.qp)(e)?{value:b(e.value),tag:e.tag}:b(e)}function b(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":return e;case"object":return JSON.stringify(e);default:return console.error("convertToBasePropertyTypeUntagged: INVALID PROPERTY (typed as ".concat(typeof e,")")),"INVALID PROPERTY (typed as ".concat(typeof e,")")}}const S=e=>((e,t)=>Object.entries(t).filter((e=>void 0!==e[1])).reduce(((t,n)=>{const[r,i]=n;return t[r]="function"===typeof i?()=>({tag:e,value:i()}):{tag:e,value:i},t}),{}))(r.CodeArtifact,e)},350:(e,t)=>{var n={userAgent:!1},r={},i=i||function(e,t){var n={},r=n.lib={},i=r.Base=function(){function e(){}return{extend:function(t){e.prototype=this;var n=new e;return t&&n.mixIn(t),n.hasOwnProperty("init")||(n.init=function(){n.$super.init.apply(this,arguments)}),n.init.prototype=n,n.$super=this,n},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}}}(),s=r.WordArray=i.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=undefined!=t?t:4*e.length},toString:function(e){return(e||a).stringify(this)},concat:function(e){var t=this.words,n=e.words,r=this.sigBytes,i=e.sigBytes;if(this.clamp(),r%4)for(var s=0;s<i;s++){var o=n[s>>>2]>>>24-s%4*8&255;t[r+s>>>2]|=o<<24-(r+s)%4*8}else for(s=0;s<i;s+=4)t[r+s>>>2]=n[s>>>2];return this.sigBytes+=i,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-n%4*8,t.length=e.ceil(n/4)},clone:function(){var e=i.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n=[],r=0;r<t;r+=4)n.push(4294967296*e.random()|0);return new s.init(n,t)}}),o=n.enc={},a=o.Hex={stringify:function(e){for(var t=e.words,n=e.sigBytes,r=[],i=0;i<n;i++){var s=t[i>>>2]>>>24-i%4*8&255;r.push((s>>>4).toString(16)),r.push((15&s).toString(16))}return r.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r+=2)n[r>>>3]|=parseInt(e.substr(r,2),16)<<24-r%8*4;return new s.init(n,t/2)}},c=o.Latin1={stringify:function(e){for(var t=e.words,n=e.sigBytes,r=[],i=0;i<n;i++){var s=t[i>>>2]>>>24-i%4*8&255;r.push(String.fromCharCode(s))}return r.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r++)n[r>>>2]|=(255&e.charCodeAt(r))<<24-r%4*8;return new s.init(n,t)}},l=o.Utf8={stringify:function(e){try{return decodeURIComponent(escape(c.stringify(e)))}catch(t){throw new Error("Malformed UTF-8 data")}},parse:function(e){return c.parse(unescape(encodeURIComponent(e)))}},u=r.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new s.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=l.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var n=this._data,r=n.words,i=n.sigBytes,o=this.blockSize,a=i/(4*o),c=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*o,l=e.min(4*c,i);if(c){for(var u=0;u<c;u+=o)this._doProcessBlock(r,u);var h=r.splice(0,c);n.sigBytes-=l}return new s.init(h,l)},clone:function(){var e=i.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),h=(r.Hasher=u.extend({cfg:i.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){u.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new h.HMAC.init(e,n).finalize(t)}}}),n.algo={});return n}(Math);!function(e){var t,n=(t=i).lib,r=n.Base,s=n.WordArray;(t=t.x64={}).Word=r.extend({init:function(e,t){this.high=e,this.low=t}}),t.WordArray=r.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=undefined!=t?t:8*e.length},toX32:function(){for(var e=this.words,t=e.length,n=[],r=0;r<t;r++){var i=e[r];n.push(i.high),n.push(i.low)}return s.create(n,this.sigBytes)},clone:function(){for(var e=r.clone.call(this),t=e.words=this.words.slice(0),n=t.length,i=0;i<n;i++)t[i]=t[i].clone();return e}})}(),i.lib.Cipher||function(e){var t=(p=i).lib,n=t.Base,r=t.WordArray,s=t.BufferedBlockAlgorithm,o=p.enc.Base64,a=p.algo.EvpKDF,c=t.Cipher=s.extend({cfg:n.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,n){this.cfg=this.cfg.extend(n),this._xformMode=e,this._key=t,this.reset()},reset:function(){s.reset.call(this),this._doReset()},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(e){return{encrypt:function(t,n,r){return("string"==typeof n?m:f).encrypt(e,t,n,r)},decrypt:function(t,n,r){return("string"==typeof n?m:f).decrypt(e,t,n,r)}}}});t.StreamCipher=c.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var l=p.mode={},u=function(e,t,n){var r=this._iv;r?this._iv=undefined:r=this._prevBlock;for(var i=0;i<n;i++)e[t+i]^=r[i]},h=(t.BlockCipherMode=n.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t}})).extend();h.Encryptor=h.extend({processBlock:function(e,t){var n=this._cipher,r=n.blockSize;u.call(this,e,t,r),n.encryptBlock(e,t),this._prevBlock=e.slice(t,t+r)}}),h.Decryptor=h.extend({processBlock:function(e,t){var n=this._cipher,r=n.blockSize,i=e.slice(t,t+r);n.decryptBlock(e,t),u.call(this,e,t,r),this._prevBlock=i}}),l=l.CBC=h,h=(p.pad={}).Pkcs7={pad:function(e,t){for(var n,i=(n=(n=4*t)-e.sigBytes%n)<<24|n<<16|n<<8|n,s=[],o=0;o<n;o+=4)s.push(i);n=r.create(s,n),e.concat(n)},unpad:function(e){e.sigBytes-=255&e.words[e.sigBytes-1>>>2]}},t.BlockCipher=c.extend({cfg:c.cfg.extend({mode:l,padding:h}),reset:function(){c.reset.call(this);var e=(t=this.cfg).iv,t=t.mode;if(this._xformMode==this._ENC_XFORM_MODE)var n=t.createEncryptor;else n=t.createDecryptor,this._minBufferSize=1;this._mode=n.call(t,this,e&&e.words)},_doProcessBlock:function(e,t){this._mode.processBlock(e,t)},_doFinalize:function(){var e=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){e.pad(this._data,this.blockSize);var t=this._process(!0)}else t=this._process(!0),e.unpad(t);return t},blockSize:4});var d=t.CipherParams=n.extend({init:function(e){this.mixIn(e)},toString:function(e){return(e||this.formatter).stringify(this)}}),f=(l=(p.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext;return((e=e.salt)?r.create([1398893684,1701076831]).concat(e).concat(t):t).toString(o)},parse:function(e){var t=(e=o.parse(e)).words;if(1398893684==t[0]&&1701076831==t[1]){var n=r.create(t.slice(2,4));t.splice(0,4),e.sigBytes-=16}return d.create({ciphertext:e,salt:n})}},t.SerializableCipher=n.extend({cfg:n.extend({format:l}),encrypt:function(e,t,n,r){r=this.cfg.extend(r);var i=e.createEncryptor(n,r);return t=i.finalize(t),i=i.cfg,d.create({ciphertext:t,key:n,iv:i.iv,algorithm:e,mode:i.mode,padding:i.padding,blockSize:e.blockSize,formatter:r.format})},decrypt:function(e,t,n,r){return r=this.cfg.extend(r),t=this._parse(t,r.format),e.createDecryptor(n,r).finalize(t.ciphertext)},_parse:function(e,t){return"string"==typeof e?t.parse(e,this):e}})),p=(p.kdf={}).OpenSSL={execute:function(e,t,n,i){return i||(i=r.random(8)),e=a.create({keySize:t+n}).compute(e,i),n=r.create(e.words.slice(t),4*n),e.sigBytes=4*t,d.create({key:e,iv:n,salt:i})}},m=t.PasswordBasedCipher=f.extend({cfg:f.cfg.extend({kdf:p}),encrypt:function(e,t,n,r){return n=(r=this.cfg.extend(r)).kdf.execute(n,e.keySize,e.ivSize),r.iv=n.iv,(e=f.encrypt.call(this,e,t,n.key,r)).mixIn(n),e},decrypt:function(e,t,n,r){return r=this.cfg.extend(r),t=this._parse(t,r.format),n=r.kdf.execute(n,e.keySize,e.ivSize,t.salt),r.iv=n.iv,f.decrypt.call(this,e,t,n.key,r)}})}(),function(){for(var e=i,t=e.lib.BlockCipher,n=e.algo,r=[],s=[],o=[],a=[],c=[],l=[],u=[],h=[],d=[],f=[],p=[],m=0;256>m;m++)p[m]=128>m?m<<1:m<<1^283;var g=0,v=0;for(m=0;256>m;m++){var y=(y=v^v<<1^v<<2^v<<3^v<<4)>>>8^255&y^99;r[g]=y,s[y]=g;var b=p[g],S=p[b],w=p[S],C=257*p[y]^16843008*y;o[g]=C<<24|C>>>8,a[g]=C<<16|C>>>16,c[g]=C<<8|C>>>24,l[g]=C,C=16843009*w^65537*S^257*b^16843008*g,u[y]=C<<24|C>>>8,h[y]=C<<16|C>>>16,d[y]=C<<8|C>>>24,f[y]=C,g?(g=b^p[p[p[w^b]]],v^=p[p[v]]):g=v=1}var x=[0,1,2,4,8,16,32,64,128,27,54];n=n.AES=t.extend({_doReset:function(){for(var e=(n=this._key).words,t=n.sigBytes/4,n=4*((this._nRounds=t+6)+1),i=this._keySchedule=[],s=0;s<n;s++)if(s<t)i[s]=e[s];else{var o=i[s-1];s%t?6<t&&4==s%t&&(o=r[o>>>24]<<24|r[o>>>16&255]<<16|r[o>>>8&255]<<8|r[255&o]):(o=r[(o=o<<8|o>>>24)>>>24]<<24|r[o>>>16&255]<<16|r[o>>>8&255]<<8|r[255&o],o^=x[s/t|0]<<24),i[s]=i[s-t]^o}for(e=this._invKeySchedule=[],t=0;t<n;t++)s=n-t,o=t%4?i[s]:i[s-4],e[t]=4>t||4>=s?o:u[r[o>>>24]]^h[r[o>>>16&255]]^d[r[o>>>8&255]]^f[r[255&o]]},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._keySchedule,o,a,c,l,r)},decryptBlock:function(e,t){var n=e[t+1];e[t+1]=e[t+3],e[t+3]=n,this._doCryptBlock(e,t,this._invKeySchedule,u,h,d,f,s),n=e[t+1],e[t+1]=e[t+3],e[t+3]=n},_doCryptBlock:function(e,t,n,r,i,s,o,a){for(var c=this._nRounds,l=e[t]^n[0],u=e[t+1]^n[1],h=e[t+2]^n[2],d=e[t+3]^n[3],f=4,p=1;p<c;p++){var m=r[l>>>24]^i[u>>>16&255]^s[h>>>8&255]^o[255&d]^n[f++],g=r[u>>>24]^i[h>>>16&255]^s[d>>>8&255]^o[255&l]^n[f++],v=r[h>>>24]^i[d>>>16&255]^s[l>>>8&255]^o[255&u]^n[f++];d=r[d>>>24]^i[l>>>16&255]^s[u>>>8&255]^o[255&h]^n[f++],l=m,u=g,h=v}m=(a[l>>>24]<<24|a[u>>>16&255]<<16|a[h>>>8&255]<<8|a[255&d])^n[f++],g=(a[u>>>24]<<24|a[h>>>16&255]<<16|a[d>>>8&255]<<8|a[255&l])^n[f++],v=(a[h>>>24]<<24|a[d>>>16&255]<<16|a[l>>>8&255]<<8|a[255&u])^n[f++],d=(a[d>>>24]<<24|a[l>>>16&255]<<16|a[u>>>8&255]<<8|a[255&h])^n[f++],e[t]=m,e[t+1]=g,e[t+2]=v,e[t+3]=d},keySize:8});e.AES=t._createHelper(n)}(),function(){function e(e,t){var n=(this._lBlock>>>e^this._rBlock)&t;this._rBlock^=n,this._lBlock^=n<<e}function t(e,t){var n=(this._rBlock>>>e^this._lBlock)&t;this._lBlock^=n,this._rBlock^=n<<e}var n=i,r=(s=n.lib).WordArray,s=s.BlockCipher,o=n.algo,a=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4],c=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32],l=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],u=[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}],h=[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679],d=o.DES=s.extend({_doReset:function(){for(var e=this._key.words,t=[],n=0;56>n;n++){var r=a[n]-1;t[n]=e[r>>>5]>>>31-r%32&1}for(e=this._subKeys=[],r=0;16>r;r++){var i=e[r]=[],s=l[r];for(n=0;24>n;n++)i[n/6|0]|=t[(c[n]-1+s)%28]<<31-n%6,i[4+(n/6|0)]|=t[28+(c[n+24]-1+s)%28]<<31-n%6;for(i[0]=i[0]<<1|i[0]>>>31,n=1;7>n;n++)i[n]>>>=4*(n-1)+3;i[7]=i[7]<<5|i[7]>>>27}for(t=this._invSubKeys=[],n=0;16>n;n++)t[n]=e[15-n]},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._subKeys)},decryptBlock:function(e,t){this._doCryptBlock(e,t,this._invSubKeys)},_doCryptBlock:function(n,r,i){this._lBlock=n[r],this._rBlock=n[r+1],e.call(this,4,252645135),e.call(this,16,65535),t.call(this,2,858993459),t.call(this,8,16711935),e.call(this,1,1431655765);for(var s=0;16>s;s++){for(var o=i[s],a=this._lBlock,c=this._rBlock,l=0,d=0;8>d;d++)l|=u[d][((c^o[d])&h[d])>>>0];this._lBlock=c,this._rBlock=a^l}i=this._lBlock,this._lBlock=this._rBlock,this._rBlock=i,e.call(this,1,1431655765),t.call(this,8,16711935),t.call(this,2,858993459),e.call(this,16,65535),e.call(this,4,252645135),n[r]=this._lBlock,n[r+1]=this._rBlock},keySize:2,ivSize:2,blockSize:2});n.DES=s._createHelper(d),o=o.TripleDES=s.extend({_doReset:function(){var e=this._key.words;this._des1=d.createEncryptor(r.create(e.slice(0,2))),this._des2=d.createEncryptor(r.create(e.slice(2,4))),this._des3=d.createEncryptor(r.create(e.slice(4,6)))},encryptBlock:function(e,t){this._des1.encryptBlock(e,t),this._des2.decryptBlock(e,t),this._des3.encryptBlock(e,t)},decryptBlock:function(e,t){this._des3.decryptBlock(e,t),this._des2.encryptBlock(e,t),this._des1.decryptBlock(e,t)},keySize:6,ivSize:2,blockSize:2}),n.TripleDES=s._createHelper(o)}(),function(){var e=i,t=e.lib.WordArray;e.enc.Base64={stringify:function(e){var t=e.words,n=e.sigBytes,r=this._map;e.clamp(),e=[];for(var i=0;i<n;i+=3)for(var s=(t[i>>>2]>>>24-i%4*8&255)<<16|(t[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|t[i+2>>>2]>>>24-(i+2)%4*8&255,o=0;4>o&&i+.75*o<n;o++)e.push(r.charAt(s>>>6*(3-o)&63));if(t=r.charAt(64))for(;e.length%4;)e.push(t);return e.join("")},parse:function(e){var n=e.length,r=this._map;(i=r.charAt(64))&&(-1!=(i=e.indexOf(i))&&(n=i));for(var i=[],s=0,o=0;o<n;o++)if(o%4){var a=r.indexOf(e.charAt(o-1))<<o%4*2,c=r.indexOf(e.charAt(o))>>>6-o%4*2;i[s>>>2]|=(a|c)<<24-s%4*8,s++}return t.create(i,s)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),function(e){function t(e,t,n,r,i,s,o){return((e=e+(t&n|~t&r)+i+o)<<s|e>>>32-s)+t}function n(e,t,n,r,i,s,o){return((e=e+(t&r|n&~r)+i+o)<<s|e>>>32-s)+t}function r(e,t,n,r,i,s,o){return((e=e+(t^n^r)+i+o)<<s|e>>>32-s)+t}function s(e,t,n,r,i,s,o){return((e=e+(n^(t|~r))+i+o)<<s|e>>>32-s)+t}for(var o=i,a=(l=o.lib).WordArray,c=l.Hasher,l=o.algo,u=[],h=0;64>h;h++)u[h]=4294967296*e.abs(e.sin(h+1))|0;l=l.MD5=c.extend({_doReset:function(){this._hash=new a.init([1732584193,4023233417,2562383102,271733878])},_doProcessBlock:function(e,i){for(var o=0;16>o;o++){var a=e[c=i+o];e[c]=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8)}o=this._hash.words;var c=e[i+0],l=(a=e[i+1],e[i+2]),h=e[i+3],d=e[i+4],f=e[i+5],p=e[i+6],m=e[i+7],g=e[i+8],v=e[i+9],y=e[i+10],b=e[i+11],S=e[i+12],w=e[i+13],C=e[i+14],x=e[i+15],E=t(E=o[0],N=o[1],k=o[2],T=o[3],c,7,u[0]),T=t(T,E,N,k,a,12,u[1]),k=t(k,T,E,N,l,17,u[2]),N=t(N,k,T,E,h,22,u[3]);E=t(E,N,k,T,d,7,u[4]),T=t(T,E,N,k,f,12,u[5]),k=t(k,T,E,N,p,17,u[6]),N=t(N,k,T,E,m,22,u[7]),E=t(E,N,k,T,g,7,u[8]),T=t(T,E,N,k,v,12,u[9]),k=t(k,T,E,N,y,17,u[10]),N=t(N,k,T,E,b,22,u[11]),E=t(E,N,k,T,S,7,u[12]),T=t(T,E,N,k,w,12,u[13]),k=t(k,T,E,N,C,17,u[14]),E=n(E,N=t(N,k,T,E,x,22,u[15]),k,T,a,5,u[16]),T=n(T,E,N,k,p,9,u[17]),k=n(k,T,E,N,b,14,u[18]),N=n(N,k,T,E,c,20,u[19]),E=n(E,N,k,T,f,5,u[20]),T=n(T,E,N,k,y,9,u[21]),k=n(k,T,E,N,x,14,u[22]),N=n(N,k,T,E,d,20,u[23]),E=n(E,N,k,T,v,5,u[24]),T=n(T,E,N,k,C,9,u[25]),k=n(k,T,E,N,h,14,u[26]),N=n(N,k,T,E,g,20,u[27]),E=n(E,N,k,T,w,5,u[28]),T=n(T,E,N,k,l,9,u[29]),k=n(k,T,E,N,m,14,u[30]),E=r(E,N=n(N,k,T,E,S,20,u[31]),k,T,f,4,u[32]),T=r(T,E,N,k,g,11,u[33]),k=r(k,T,E,N,b,16,u[34]),N=r(N,k,T,E,C,23,u[35]),E=r(E,N,k,T,a,4,u[36]),T=r(T,E,N,k,d,11,u[37]),k=r(k,T,E,N,m,16,u[38]),N=r(N,k,T,E,y,23,u[39]),E=r(E,N,k,T,w,4,u[40]),T=r(T,E,N,k,c,11,u[41]),k=r(k,T,E,N,h,16,u[42]),N=r(N,k,T,E,p,23,u[43]),E=r(E,N,k,T,v,4,u[44]),T=r(T,E,N,k,S,11,u[45]),k=r(k,T,E,N,x,16,u[46]),E=s(E,N=r(N,k,T,E,l,23,u[47]),k,T,c,6,u[48]),T=s(T,E,N,k,m,10,u[49]),k=s(k,T,E,N,C,15,u[50]),N=s(N,k,T,E,f,21,u[51]),E=s(E,N,k,T,S,6,u[52]),T=s(T,E,N,k,h,10,u[53]),k=s(k,T,E,N,y,15,u[54]),N=s(N,k,T,E,a,21,u[55]),E=s(E,N,k,T,g,6,u[56]),T=s(T,E,N,k,x,10,u[57]),k=s(k,T,E,N,p,15,u[58]),N=s(N,k,T,E,w,21,u[59]),E=s(E,N,k,T,d,6,u[60]),T=s(T,E,N,k,b,10,u[61]),k=s(k,T,E,N,l,15,u[62]),N=s(N,k,T,E,v,21,u[63]);o[0]=o[0]+E|0,o[1]=o[1]+N|0,o[2]=o[2]+k|0,o[3]=o[3]+T|0},_doFinalize:function(){var t=this._data,n=t.words,r=8*this._nDataBytes,i=8*t.sigBytes;n[i>>>5]|=128<<24-i%32;var s=e.floor(r/4294967296);for(n[15+(i+64>>>9<<4)]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),n[14+(i+64>>>9<<4)]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8),t.sigBytes=4*(n.length+1),this._process(),n=(t=this._hash).words,r=0;4>r;r++)i=n[r],n[r]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8);return t},clone:function(){var e=c.clone.call(this);return e._hash=this._hash.clone(),e}}),o.MD5=c._createHelper(l),o.HmacMD5=c._createHmacHelper(l)}(Math),function(){var e=i,t=(s=e.lib).WordArray,n=s.Hasher,r=[],s=e.algo.SHA1=n.extend({_doReset:function(){this._hash=new t.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var n=this._hash.words,i=n[0],s=n[1],o=n[2],a=n[3],c=n[4],l=0;80>l;l++){if(16>l)r[l]=0|e[t+l];else{var u=r[l-3]^r[l-8]^r[l-14]^r[l-16];r[l]=u<<1|u>>>31}u=(i<<5|i>>>27)+c+r[l],u=20>l?u+(1518500249+(s&o|~s&a)):40>l?u+(1859775393+(s^o^a)):60>l?u+((s&o|s&a|o&a)-1894007588):u+((s^o^a)-899497514),c=a,a=o,o=s<<30|s>>>2,s=i,i=u}n[0]=n[0]+i|0,n[1]=n[1]+s|0,n[2]=n[2]+o|0,n[3]=n[3]+a|0,n[4]=n[4]+c|0},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;return t[r>>>5]|=128<<24-r%32,t[14+(r+64>>>9<<4)]=Math.floor(n/4294967296),t[15+(r+64>>>9<<4)]=n,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e}});e.SHA1=n._createHelper(s),e.HmacSHA1=n._createHmacHelper(s)}(),function(e){for(var t=i,n=(s=t.lib).WordArray,r=s.Hasher,s=t.algo,o=[],a=[],c=function(e){return 4294967296*(e-(0|e))|0},l=2,u=0;64>u;){var h;e:{h=l;for(var d=e.sqrt(h),f=2;f<=d;f++)if(!(h%f)){h=!1;break e}h=!0}h&&(8>u&&(o[u]=c(e.pow(l,.5))),a[u]=c(e.pow(l,1/3)),u++),l++}var p=[];s=s.SHA256=r.extend({_doReset:function(){this._hash=new n.init(o.slice(0))},_doProcessBlock:function(e,t){for(var n=this._hash.words,r=n[0],i=n[1],s=n[2],o=n[3],c=n[4],l=n[5],u=n[6],h=n[7],d=0;64>d;d++){if(16>d)p[d]=0|e[t+d];else{var f=p[d-15],m=p[d-2];p[d]=((f<<25|f>>>7)^(f<<14|f>>>18)^f>>>3)+p[d-7]+((m<<15|m>>>17)^(m<<13|m>>>19)^m>>>10)+p[d-16]}f=h+((c<<26|c>>>6)^(c<<21|c>>>11)^(c<<7|c>>>25))+(c&l^~c&u)+a[d]+p[d],m=((r<<30|r>>>2)^(r<<19|r>>>13)^(r<<10|r>>>22))+(r&i^r&s^i&s),h=u,u=l,l=c,c=o+f|0,o=s,s=i,i=r,r=f+m|0}n[0]=n[0]+r|0,n[1]=n[1]+i|0,n[2]=n[2]+s|0,n[3]=n[3]+o|0,n[4]=n[4]+c|0,n[5]=n[5]+l|0,n[6]=n[6]+u|0,n[7]=n[7]+h|0},_doFinalize:function(){var t=this._data,n=t.words,r=8*this._nDataBytes,i=8*t.sigBytes;return n[i>>>5]|=128<<24-i%32,n[14+(i+64>>>9<<4)]=e.floor(r/4294967296),n[15+(i+64>>>9<<4)]=r,t.sigBytes=4*n.length,this._process(),this._hash},clone:function(){var e=r.clone.call(this);return e._hash=this._hash.clone(),e}});t.SHA256=r._createHelper(s),t.HmacSHA256=r._createHmacHelper(s)}(Math),function(){var e=i,t=e.lib.WordArray,n=(r=e.algo).SHA256,r=r.SHA224=n.extend({_doReset:function(){this._hash=new t.init([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428])},_doFinalize:function(){var e=n._doFinalize.call(this);return e.sigBytes-=4,e}});e.SHA224=n._createHelper(r),e.HmacSHA224=n._createHmacHelper(r)}(),function(){function e(){return r.create.apply(r,arguments)}for(var t=i,n=t.lib.Hasher,r=(o=t.x64).Word,s=o.WordArray,o=t.algo,a=[e(1116352408,3609767458),e(1899447441,602891725),e(3049323471,3964484399),e(3921009573,2173295548),e(961987163,4081628472),e(1508970993,3053834265),e(2453635748,2937671579),e(2870763221,3664609560),e(3624381080,2734883394),e(310598401,1164996542),e(607225278,1323610764),e(1426881987,3590304994),e(1925078388,4068182383),e(2162078206,991336113),e(2614888103,633803317),e(3248222580,3479774868),e(3835390401,2666613458),e(4022224774,944711139),e(264347078,2341262773),e(604807628,2007800933),e(770255983,1495990901),e(1249150122,1856431235),e(1555081692,3175218132),e(1996064986,2198950837),e(2554220882,3999719339),e(2821834349,766784016),e(2952996808,2566594879),e(3210313671,3203337956),e(3336571891,1034457026),e(3584528711,2466948901),e(113926993,3758326383),e(338241895,168717936),e(666307205,1188179964),e(773529912,1546045734),e(1294757372,1522805485),e(1396182291,2643833823),e(1695183700,2343527390),e(1986661051,1014477480),e(2177026350,1206759142),e(2456956037,344077627),e(2730485921,1290863460),e(2820302411,3158454273),e(3259730800,3505952657),e(3345764771,106217008),e(3516065817,3606008344),e(3600352804,1432725776),e(4094571909,1467031594),e(275423344,851169720),e(430227734,3100823752),e(506948616,1363258195),e(659060556,3750685593),e(883997877,3785050280),e(958139571,3318307427),e(1322822218,3812723403),e(1537002063,2003034995),e(1747873779,3602036899),e(1955562222,1575990012),e(2024104815,1125592928),e(2227730452,2716904306),e(2361852424,442776044),e(2428436474,593698344),e(2756734187,3733110249),e(3204031479,2999351573),e(3329325298,3815920427),e(3391569614,3928383900),e(3515267271,566280711),e(3940187606,3454069534),e(4118630271,4000239992),e(116418474,1914138554),e(174292421,2731055270),e(289380356,3203993006),e(460393269,320620315),e(685471733,587496836),e(852142971,1086792851),e(1017036298,365543100),e(1126000580,2618297676),e(1288033470,3409855158),e(1501505948,4234509866),e(1607167915,987167468),e(1816402316,1246189591)],c=[],l=0;80>l;l++)c[l]=e();o=o.SHA512=n.extend({_doReset:function(){this._hash=new s.init([new r.init(1779033703,4089235720),new r.init(3144134277,2227873595),new r.init(1013904242,4271175723),new r.init(2773480762,1595750129),new r.init(1359893119,2917565137),new r.init(2600822924,725511199),new r.init(528734635,4215389547),new r.init(1541459225,327033209)])},_doProcessBlock:function(e,t){for(var n=(h=this._hash.words)[0],r=h[1],i=h[2],s=h[3],o=h[4],l=h[5],u=h[6],h=h[7],d=n.high,f=n.low,p=r.high,m=r.low,g=i.high,v=i.low,y=s.high,b=s.low,S=o.high,w=o.low,C=l.high,x=l.low,E=u.high,T=u.low,k=h.high,N=h.low,F=d,I=f,A=p,D=m,O=g,P=v,R=y,M=b,B=S,L=w,q=C,_=x,j=E,z=T,U=k,H=N,V=0;80>V;V++){var K=c[V];if(16>V)var G=K.high=0|e[t+2*V],W=K.low=0|e[t+2*V+1];else{G=((W=(G=c[V-15]).high)>>>1|(J=G.low)<<31)^(W>>>8|J<<24)^W>>>7;var J=(J>>>1|W<<31)^(J>>>8|W<<24)^(J>>>7|W<<25),Z=((W=(Z=c[V-2]).high)>>>19|($=Z.low)<<13)^(W<<3|$>>>29)^W>>>6,$=($>>>19|W<<13)^($<<3|W>>>29)^($>>>6|W<<26),Q=(W=c[V-7]).high,X=(Y=c[V-16]).high,Y=Y.low;G=(G=(G=G+Q+((W=J+W.low)>>>0<J>>>0?1:0))+Z+((W=W+$)>>>0<$>>>0?1:0))+X+((W=W+Y)>>>0<Y>>>0?1:0);K.high=G,K.low=W}Q=B&q^~B&j,Y=L&_^~L&z,K=F&A^F&O^A&O;var ee=I&D^I&P^D&P,te=(J=(F>>>28|I<<4)^(F<<30|I>>>2)^(F<<25|I>>>7),Z=(I>>>28|F<<4)^(I<<30|F>>>2)^(I<<25|F>>>7),($=a[V]).high),ne=$.low;X=U+((B>>>14|L<<18)^(B>>>18|L<<14)^(B<<23|L>>>9))+(($=H+((L>>>14|B<<18)^(L>>>18|B<<14)^(L<<23|B>>>9)))>>>0<H>>>0?1:0),U=j,H=z,j=q,z=_,q=B,_=L,B=R+(X=(X=(X=X+Q+(($=$+Y)>>>0<Y>>>0?1:0))+te+(($=$+ne)>>>0<ne>>>0?1:0))+G+(($=$+W)>>>0<W>>>0?1:0))+((L=M+$|0)>>>0<M>>>0?1:0)|0,R=O,M=P,O=A,P=D,A=F,D=I,F=X+(K=J+K+((W=Z+ee)>>>0<Z>>>0?1:0))+((I=$+W|0)>>>0<$>>>0?1:0)|0}f=n.low=f+I,n.high=d+F+(f>>>0<I>>>0?1:0),m=r.low=m+D,r.high=p+A+(m>>>0<D>>>0?1:0),v=i.low=v+P,i.high=g+O+(v>>>0<P>>>0?1:0),b=s.low=b+M,s.high=y+R+(b>>>0<M>>>0?1:0),w=o.low=w+L,o.high=S+B+(w>>>0<L>>>0?1:0),x=l.low=x+_,l.high=C+q+(x>>>0<_>>>0?1:0),T=u.low=T+z,u.high=E+j+(T>>>0<z>>>0?1:0),N=h.low=N+H,h.high=k+U+(N>>>0<H>>>0?1:0)},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;return t[r>>>5]|=128<<24-r%32,t[30+(r+128>>>10<<5)]=Math.floor(n/4294967296),t[31+(r+128>>>10<<5)]=n,e.sigBytes=4*t.length,this._process(),this._hash.toX32()},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:32}),t.SHA512=n._createHelper(o),t.HmacSHA512=n._createHmacHelper(o)}(),function(){var e=i,t=(s=e.x64).Word,n=s.WordArray,r=(s=e.algo).SHA512,s=s.SHA384=r.extend({_doReset:function(){this._hash=new n.init([new t.init(3418070365,3238371032),new t.init(1654270250,914150663),new t.init(2438529370,812702999),new t.init(355462360,4144912697),new t.init(1731405415,4290775857),new t.init(2394180231,1750603025),new t.init(3675008525,1694076839),new t.init(1203062813,3204075428)])},_doFinalize:function(){var e=r._doFinalize.call(this);return e.sigBytes-=16,e}});e.SHA384=r._createHelper(s),e.HmacSHA384=r._createHmacHelper(s)}(),function(){var e=i,t=(r=e.lib).WordArray,n=r.Hasher,r=e.algo,s=t.create([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]),o=t.create([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),a=t.create([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),c=t.create([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),l=t.create([0,1518500249,1859775393,2400959708,2840853838]),u=t.create([1352829926,1548603684,1836072691,2053994217,0]);r=r.RIPEMD160=n.extend({_doReset:function(){this._hash=t.create([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(e,t){for(var n=0;16>n;n++){var r=e[S=t+n];e[S]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8)}var i,h,d,f,p,m,g,v,y,b,S=this._hash.words,w=(r=l.words,u.words),C=s.words,x=o.words,E=a.words,T=c.words;m=i=S[0],g=h=S[1],v=d=S[2],y=f=S[3],b=p=S[4];var k;for(n=0;80>n;n+=1)k=i+e[t+C[n]]|0,k=16>n?k+((h^d^f)+r[0]):32>n?k+((h&d|~h&f)+r[1]):48>n?k+(((h|~d)^f)+r[2]):64>n?k+((h&f|d&~f)+r[3]):k+((h^(d|~f))+r[4]),k=(k=(k|=0)<<E[n]|k>>>32-E[n])+p|0,i=p,p=f,f=d<<10|d>>>22,d=h,h=k,k=m+e[t+x[n]]|0,k=16>n?k+((g^(v|~y))+w[0]):32>n?k+((g&y|v&~y)+w[1]):48>n?k+(((g|~v)^y)+w[2]):64>n?k+((g&v|~g&y)+w[3]):k+((g^v^y)+w[4]),k=(k=(k|=0)<<T[n]|k>>>32-T[n])+b|0,m=b,b=y,y=v<<10|v>>>22,v=g,g=k;k=S[1]+d+y|0,S[1]=S[2]+f+b|0,S[2]=S[3]+p+m|0,S[3]=S[4]+i+g|0,S[4]=S[0]+h+v|0,S[0]=k},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;for(t[r>>>5]|=128<<24-r%32,t[14+(r+64>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),e.sigBytes=4*(t.length+1),this._process(),t=(e=this._hash).words,n=0;5>n;n++)r=t[n],t[n]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8);return e},clone:function(){var e=n.clone.call(this);return e._hash=this._hash.clone(),e}});e.RIPEMD160=n._createHelper(r),e.HmacRIPEMD160=n._createHmacHelper(r)}(Math),function(){var e=i,t=e.enc.Utf8;e.algo.HMAC=e.lib.Base.extend({init:function(e,n){e=this._hasher=new e.init,"string"==typeof n&&(n=t.parse(n));var r=e.blockSize,i=4*r;n.sigBytes>i&&(n=e.finalize(n)),n.clamp();for(var s=this._oKey=n.clone(),o=this._iKey=n.clone(),a=s.words,c=o.words,l=0;l<r;l++)a[l]^=1549556828,c[l]^=909522486;s.sigBytes=o.sigBytes=i,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher;return e=t.finalize(e),t.reset(),t.finalize(this._oKey.clone().concat(e))}})}(),function(){var e,t=i,n=(e=t.lib).Base,r=e.WordArray,s=(e=t.algo).HMAC,o=e.PBKDF2=n.extend({cfg:n.extend({keySize:4,hasher:e.SHA1,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e)},compute:function(e,t){var n=this.cfg,i=s.create(n.hasher,e),o=r.create(),a=r.create([1]),c=o.words,l=a.words,u=n.keySize;for(n=n.iterations;c.length<u;){var h=i.update(t).finalize(a);i.reset();for(var d=h.words,f=d.length,p=h,m=1;m<n;m++){p=i.finalize(p),i.reset();for(var g=p.words,v=0;v<f;v++)d[v]^=g[v]}o.concat(h),l[0]++}return o.sigBytes=4*u,o}});t.PBKDF2=function(e,t,n){return o.create(n).compute(e,t)}}();var s,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a="=";function c(e){var t,n,r="";for(t=0;t+3<=e.length;t+=3)n=parseInt(e.substring(t,t+3),16),r+=o.charAt(n>>6)+o.charAt(63&n);if(t+1==e.length?(n=parseInt(e.substring(t,t+1),16),r+=o.charAt(n<<2)):t+2==e.length&&(n=parseInt(e.substring(t,t+2),16),r+=o.charAt(n>>2)+o.charAt((3&n)<<4)),a)for(;(3&r.length)>0;)r+=a;return r}function l(e){var t,n,r,i="",s=0;for(t=0;t<e.length&&e.charAt(t)!=a;++t)(r=o.indexOf(e.charAt(t)))<0||(0==s?(i+=v(r>>2),n=3&r,s=1):1==s?(i+=v(n<<2|r>>4),n=15&r,s=2):2==s?(i+=v(n),i+=v(r>>2),n=3&r,s=3):(i+=v(n<<2|r>>4),i+=v(15&r),s=0));return 1==s&&(i+=v(n<<2)),i}function u(e){var t,n=l(e),r=new Array;for(t=0;2*t<n.length;++t)r[t]=parseInt(n.substring(2*t,2*t+2),16);return r}function h(e,t,n){null!=e&&("number"==typeof e?this.fromNumber(e,t,n):null==t&&"string"!=typeof e?this.fromString(e,256):this.fromString(e,t))}function d(){return new h(null)}"Microsoft Internet Explorer"==n.appName?(h.prototype.am=function(e,t,n,r,i,s){for(var o=32767&t,a=t>>15;--s>=0;){var c=32767&this[e],l=this[e++]>>15,u=a*c+l*o;i=((c=o*c+((32767&u)<<15)+n[r]+(1073741823&i))>>>30)+(u>>>15)+a*l+(i>>>30),n[r++]=1073741823&c}return i},s=30):"Netscape"!=n.appName?(h.prototype.am=function(e,t,n,r,i,s){for(;--s>=0;){var o=t*this[e++]+n[r]+i;i=Math.floor(o/67108864),n[r++]=67108863&o}return i},s=26):(h.prototype.am=function(e,t,n,r,i,s){for(var o=16383&t,a=t>>14;--s>=0;){var c=16383&this[e],l=this[e++]>>14,u=a*c+l*o;i=((c=o*c+((16383&u)<<14)+n[r]+i)>>28)+(u>>14)+a*l,n[r++]=268435455&c}return i},s=28),h.prototype.DB=s,h.prototype.DM=(1<<s)-1,h.prototype.DV=1<<s;h.prototype.FV=Math.pow(2,52),h.prototype.F1=52-s,h.prototype.F2=2*s-52;var f,p,m="0123456789abcdefghijklmnopqrstuvwxyz",g=new Array;for(f="0".charCodeAt(0),p=0;p<=9;++p)g[f++]=p;for(f="a".charCodeAt(0),p=10;p<36;++p)g[f++]=p;for(f="A".charCodeAt(0),p=10;p<36;++p)g[f++]=p;function v(e){return m.charAt(e)}function y(e,t){var n=g[e.charCodeAt(t)];return null==n?-1:n}function b(e){var t=d();return t.fromInt(e),t}function S(e){var t,n=1;return 0!=(t=e>>>16)&&(e=t,n+=16),0!=(t=e>>8)&&(e=t,n+=8),0!=(t=e>>4)&&(e=t,n+=4),0!=(t=e>>2)&&(e=t,n+=2),0!=(t=e>>1)&&(e=t,n+=1),n}function w(e){this.m=e}function C(e){this.m=e,this.mp=e.invDigit(),this.mpl=32767&this.mp,this.mph=this.mp>>15,this.um=(1<<e.DB-15)-1,this.mt2=2*e.t}function x(e,t){return e&t}function E(e,t){return e|t}function T(e,t){return e^t}function k(e,t){return e&~t}function N(e){if(0==e)return-1;var t=0;return 0==(65535&e)&&(e>>=16,t+=16),0==(255&e)&&(e>>=8,t+=8),0==(15&e)&&(e>>=4,t+=4),0==(3&e)&&(e>>=2,t+=2),0==(1&e)&&++t,t}function F(e){for(var t=0;0!=e;)e&=e-1,++t;return t}function I(){}function A(e){return e}function D(e){this.r2=d(),this.q3=d(),h.ONE.dlShiftTo(2*e.t,this.r2),this.mu=this.r2.divide(e),this.m=e}w.prototype.convert=function(e){return e.s<0||e.compareTo(this.m)>=0?e.mod(this.m):e},w.prototype.revert=function(e){return e},w.prototype.reduce=function(e){e.divRemTo(this.m,null,e)},w.prototype.mulTo=function(e,t,n){e.multiplyTo(t,n),this.reduce(n)},w.prototype.sqrTo=function(e,t){e.squareTo(t),this.reduce(t)},C.prototype.convert=function(e){var t=d();return e.abs().dlShiftTo(this.m.t,t),t.divRemTo(this.m,null,t),e.s<0&&t.compareTo(h.ZERO)>0&&this.m.subTo(t,t),t},C.prototype.revert=function(e){var t=d();return e.copyTo(t),this.reduce(t),t},C.prototype.reduce=function(e){for(;e.t<=this.mt2;)e[e.t++]=0;for(var t=0;t<this.m.t;++t){var n=32767&e[t],r=n*this.mpl+((n*this.mph+(e[t]>>15)*this.mpl&this.um)<<15)&e.DM;for(e[n=t+this.m.t]+=this.m.am(0,r,e,t,0,this.m.t);e[n]>=e.DV;)e[n]-=e.DV,e[++n]++}e.clamp(),e.drShiftTo(this.m.t,e),e.compareTo(this.m)>=0&&e.subTo(this.m,e)},C.prototype.mulTo=function(e,t,n){e.multiplyTo(t,n),this.reduce(n)},C.prototype.sqrTo=function(e,t){e.squareTo(t),this.reduce(t)},h.prototype.copyTo=function(e){for(var t=this.t-1;t>=0;--t)e[t]=this[t];e.t=this.t,e.s=this.s},h.prototype.fromInt=function(e){this.t=1,this.s=e<0?-1:0,e>0?this[0]=e:e<-1?this[0]=e+this.DV:this.t=0},h.prototype.fromString=function(e,t){var n;if(16==t)n=4;else if(8==t)n=3;else if(256==t)n=8;else if(2==t)n=1;else if(32==t)n=5;else{if(4!=t)return void this.fromRadix(e,t);n=2}this.t=0,this.s=0;for(var r=e.length,i=!1,s=0;--r>=0;){var o=8==n?255&e[r]:y(e,r);o<0?"-"==e.charAt(r)&&(i=!0):(i=!1,0==s?this[this.t++]=o:s+n>this.DB?(this[this.t-1]|=(o&(1<<this.DB-s)-1)<<s,this[this.t++]=o>>this.DB-s):this[this.t-1]|=o<<s,(s+=n)>=this.DB&&(s-=this.DB))}8==n&&0!=(128&e[0])&&(this.s=-1,s>0&&(this[this.t-1]|=(1<<this.DB-s)-1<<s)),this.clamp(),i&&h.ZERO.subTo(this,this)},h.prototype.clamp=function(){for(var e=this.s&this.DM;this.t>0&&this[this.t-1]==e;)--this.t},h.prototype.dlShiftTo=function(e,t){var n;for(n=this.t-1;n>=0;--n)t[n+e]=this[n];for(n=e-1;n>=0;--n)t[n]=0;t.t=this.t+e,t.s=this.s},h.prototype.drShiftTo=function(e,t){for(var n=e;n<this.t;++n)t[n-e]=this[n];t.t=Math.max(this.t-e,0),t.s=this.s},h.prototype.lShiftTo=function(e,t){var n,r=e%this.DB,i=this.DB-r,s=(1<<i)-1,o=Math.floor(e/this.DB),a=this.s<<r&this.DM;for(n=this.t-1;n>=0;--n)t[n+o+1]=this[n]>>i|a,a=(this[n]&s)<<r;for(n=o-1;n>=0;--n)t[n]=0;t[o]=a,t.t=this.t+o+1,t.s=this.s,t.clamp()},h.prototype.rShiftTo=function(e,t){t.s=this.s;var n=Math.floor(e/this.DB);if(n>=this.t)t.t=0;else{var r=e%this.DB,i=this.DB-r,s=(1<<r)-1;t[0]=this[n]>>r;for(var o=n+1;o<this.t;++o)t[o-n-1]|=(this[o]&s)<<i,t[o-n]=this[o]>>r;r>0&&(t[this.t-n-1]|=(this.s&s)<<i),t.t=this.t-n,t.clamp()}},h.prototype.subTo=function(e,t){for(var n=0,r=0,i=Math.min(e.t,this.t);n<i;)r+=this[n]-e[n],t[n++]=r&this.DM,r>>=this.DB;if(e.t<this.t){for(r-=e.s;n<this.t;)r+=this[n],t[n++]=r&this.DM,r>>=this.DB;r+=this.s}else{for(r+=this.s;n<e.t;)r-=e[n],t[n++]=r&this.DM,r>>=this.DB;r-=e.s}t.s=r<0?-1:0,r<-1?t[n++]=this.DV+r:r>0&&(t[n++]=r),t.t=n,t.clamp()},h.prototype.multiplyTo=function(e,t){var n=this.abs(),r=e.abs(),i=n.t;for(t.t=i+r.t;--i>=0;)t[i]=0;for(i=0;i<r.t;++i)t[i+n.t]=n.am(0,r[i],t,i,0,n.t);t.s=0,t.clamp(),this.s!=e.s&&h.ZERO.subTo(t,t)},h.prototype.squareTo=function(e){for(var t=this.abs(),n=e.t=2*t.t;--n>=0;)e[n]=0;for(n=0;n<t.t-1;++n){var r=t.am(n,t[n],e,2*n,0,1);(e[n+t.t]+=t.am(n+1,2*t[n],e,2*n+1,r,t.t-n-1))>=t.DV&&(e[n+t.t]-=t.DV,e[n+t.t+1]=1)}e.t>0&&(e[e.t-1]+=t.am(n,t[n],e,2*n,0,1)),e.s=0,e.clamp()},h.prototype.divRemTo=function(e,t,n){var r=e.abs();if(!(r.t<=0)){var i=this.abs();if(i.t<r.t)return null!=t&&t.fromInt(0),void(null!=n&&this.copyTo(n));null==n&&(n=d());var s=d(),o=this.s,a=e.s,c=this.DB-S(r[r.t-1]);c>0?(r.lShiftTo(c,s),i.lShiftTo(c,n)):(r.copyTo(s),i.copyTo(n));var l=s.t,u=s[l-1];if(0!=u){var f=u*(1<<this.F1)+(l>1?s[l-2]>>this.F2:0),p=this.FV/f,m=(1<<this.F1)/f,g=1<<this.F2,v=n.t,y=v-l,b=null==t?d():t;for(s.dlShiftTo(y,b),n.compareTo(b)>=0&&(n[n.t++]=1,n.subTo(b,n)),h.ONE.dlShiftTo(l,b),b.subTo(s,s);s.t<l;)s[s.t++]=0;for(;--y>=0;){var w=n[--v]==u?this.DM:Math.floor(n[v]*p+(n[v-1]+g)*m);if((n[v]+=s.am(0,w,n,y,0,l))<w)for(s.dlShiftTo(y,b),n.subTo(b,n);n[v]<--w;)n.subTo(b,n)}null!=t&&(n.drShiftTo(l,t),o!=a&&h.ZERO.subTo(t,t)),n.t=l,n.clamp(),c>0&&n.rShiftTo(c,n),o<0&&h.ZERO.subTo(n,n)}}},h.prototype.invDigit=function(){if(this.t<1)return 0;var e=this[0];if(0==(1&e))return 0;var t=3&e;return(t=(t=(t=(t=t*(2-(15&e)*t)&15)*(2-(255&e)*t)&255)*(2-((65535&e)*t&65535))&65535)*(2-e*t%this.DV)%this.DV)>0?this.DV-t:-t},h.prototype.isEven=function(){return 0==(this.t>0?1&this[0]:this.s)},h.prototype.exp=function(e,t){if(e>4294967295||e<1)return h.ONE;var n=d(),r=d(),i=t.convert(this),s=S(e)-1;for(i.copyTo(n);--s>=0;)if(t.sqrTo(n,r),(e&1<<s)>0)t.mulTo(r,i,n);else{var o=n;n=r,r=o}return t.revert(n)},h.prototype.toString=function(e){if(this.s<0)return"-"+this.negate().toString(e);var t;if(16==e)t=4;else if(8==e)t=3;else if(2==e)t=1;else if(32==e)t=5;else{if(4!=e)return this.toRadix(e);t=2}var n,r=(1<<t)-1,i=!1,s="",o=this.t,a=this.DB-o*this.DB%t;if(o-- >0)for(a<this.DB&&(n=this[o]>>a)>0&&(i=!0,s=v(n));o>=0;)a<t?(n=(this[o]&(1<<a)-1)<<t-a,n|=this[--o]>>(a+=this.DB-t)):(n=this[o]>>(a-=t)&r,a<=0&&(a+=this.DB,--o)),n>0&&(i=!0),i&&(s+=v(n));return i?s:"0"},h.prototype.negate=function(){var e=d();return h.ZERO.subTo(this,e),e},h.prototype.abs=function(){return this.s<0?this.negate():this},h.prototype.compareTo=function(e){var t=this.s-e.s;if(0!=t)return t;var n=this.t;if(0!=(t=n-e.t))return this.s<0?-t:t;for(;--n>=0;)if(0!=(t=this[n]-e[n]))return t;return 0},h.prototype.bitLength=function(){return this.t<=0?0:this.DB*(this.t-1)+S(this[this.t-1]^this.s&this.DM)},h.prototype.mod=function(e){var t=d();return this.abs().divRemTo(e,null,t),this.s<0&&t.compareTo(h.ZERO)>0&&e.subTo(t,t),t},h.prototype.modPowInt=function(e,t){var n;return n=e<256||t.isEven()?new w(t):new C(t),this.exp(e,n)},h.ZERO=b(0),h.ONE=b(1),I.prototype.convert=A,I.prototype.revert=A,I.prototype.mulTo=function(e,t,n){e.multiplyTo(t,n)},I.prototype.sqrTo=function(e,t){e.squareTo(t)},D.prototype.convert=function(e){if(e.s<0||e.t>2*this.m.t)return e.mod(this.m);if(e.compareTo(this.m)<0)return e;var t=d();return e.copyTo(t),this.reduce(t),t},D.prototype.revert=function(e){return e},D.prototype.reduce=function(e){for(e.drShiftTo(this.m.t-1,this.r2),e.t>this.m.t+1&&(e.t=this.m.t+1,e.clamp()),this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3),this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);e.compareTo(this.r2)<0;)e.dAddOffset(1,this.m.t+1);for(e.subTo(this.r2,e);e.compareTo(this.m)>=0;)e.subTo(this.m,e)},D.prototype.mulTo=function(e,t,n){e.multiplyTo(t,n),this.reduce(n)},D.prototype.sqrTo=function(e,t){e.squareTo(t),this.reduce(t)};var O=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],P=(1<<26)/O[O.length-1];function R(){this.i=0,this.j=0,this.S=new Array}h.prototype.chunkSize=function(e){return Math.floor(Math.LN2*this.DB/Math.log(e))},h.prototype.toRadix=function(e){if(null==e&&(e=10),0==this.signum()||e<2||e>36)return"0";var t=this.chunkSize(e),n=Math.pow(e,t),r=b(n),i=d(),s=d(),o="";for(this.divRemTo(r,i,s);i.signum()>0;)o=(n+s.intValue()).toString(e).substr(1)+o,i.divRemTo(r,i,s);return s.intValue().toString(e)+o},h.prototype.fromRadix=function(e,t){this.fromInt(0),null==t&&(t=10);for(var n=this.chunkSize(t),r=Math.pow(t,n),i=!1,s=0,o=0,a=0;a<e.length;++a){var c=y(e,a);c<0?"-"==e.charAt(a)&&0==this.signum()&&(i=!0):(o=t*o+c,++s>=n&&(this.dMultiply(r),this.dAddOffset(o,0),s=0,o=0))}s>0&&(this.dMultiply(Math.pow(t,s)),this.dAddOffset(o,0)),i&&h.ZERO.subTo(this,this)},h.prototype.fromNumber=function(e,t,n){if("number"==typeof t)if(e<2)this.fromInt(1);else for(this.fromNumber(e,n),this.testBit(e-1)||this.bitwiseTo(h.ONE.shiftLeft(e-1),E,this),this.isEven()&&this.dAddOffset(1,0);!this.isProbablePrime(t);)this.dAddOffset(2,0),this.bitLength()>e&&this.subTo(h.ONE.shiftLeft(e-1),this);else{var r=new Array,i=7&e;r.length=1+(e>>3),t.nextBytes(r),i>0?r[0]&=(1<<i)-1:r[0]=0,this.fromString(r,256)}},h.prototype.bitwiseTo=function(e,t,n){var r,i,s=Math.min(e.t,this.t);for(r=0;r<s;++r)n[r]=t(this[r],e[r]);if(e.t<this.t){for(i=e.s&this.DM,r=s;r<this.t;++r)n[r]=t(this[r],i);n.t=this.t}else{for(i=this.s&this.DM,r=s;r<e.t;++r)n[r]=t(i,e[r]);n.t=e.t}n.s=t(this.s,e.s),n.clamp()},h.prototype.changeBit=function(e,t){var n=h.ONE.shiftLeft(e);return this.bitwiseTo(n,t,n),n},h.prototype.addTo=function(e,t){for(var n=0,r=0,i=Math.min(e.t,this.t);n<i;)r+=this[n]+e[n],t[n++]=r&this.DM,r>>=this.DB;if(e.t<this.t){for(r+=e.s;n<this.t;)r+=this[n],t[n++]=r&this.DM,r>>=this.DB;r+=this.s}else{for(r+=this.s;n<e.t;)r+=e[n],t[n++]=r&this.DM,r>>=this.DB;r+=e.s}t.s=r<0?-1:0,r>0?t[n++]=r:r<-1&&(t[n++]=this.DV+r),t.t=n,t.clamp()},h.prototype.dMultiply=function(e){this[this.t]=this.am(0,e-1,this,0,0,this.t),++this.t,this.clamp()},h.prototype.dAddOffset=function(e,t){if(0!=e){for(;this.t<=t;)this[this.t++]=0;for(this[t]+=e;this[t]>=this.DV;)this[t]-=this.DV,++t>=this.t&&(this[this.t++]=0),++this[t]}},h.prototype.multiplyLowerTo=function(e,t,n){var r,i=Math.min(this.t+e.t,t);for(n.s=0,n.t=i;i>0;)n[--i]=0;for(r=n.t-this.t;i<r;++i)n[i+this.t]=this.am(0,e[i],n,i,0,this.t);for(r=Math.min(e.t,t);i<r;++i)this.am(0,e[i],n,i,0,t-i);n.clamp()},h.prototype.multiplyUpperTo=function(e,t,n){--t;var r=n.t=this.t+e.t-t;for(n.s=0;--r>=0;)n[r]=0;for(r=Math.max(t-this.t,0);r<e.t;++r)n[this.t+r-t]=this.am(t-r,e[r],n,0,0,this.t+r-t);n.clamp(),n.drShiftTo(1,n)},h.prototype.modInt=function(e){if(e<=0)return 0;var t=this.DV%e,n=this.s<0?e-1:0;if(this.t>0)if(0==t)n=this[0]%e;else for(var r=this.t-1;r>=0;--r)n=(t*n+this[r])%e;return n},h.prototype.millerRabin=function(e){var t=this.subtract(h.ONE),n=t.getLowestSetBit();if(n<=0)return!1;var r=t.shiftRight(n);(e=e+1>>1)>O.length&&(e=O.length);for(var i=d(),s=0;s<e;++s){i.fromInt(O[Math.floor(Math.random()*O.length)]);var o=i.modPow(r,this);if(0!=o.compareTo(h.ONE)&&0!=o.compareTo(t)){for(var a=1;a++<n&&0!=o.compareTo(t);)if(0==(o=o.modPowInt(2,this)).compareTo(h.ONE))return!1;if(0!=o.compareTo(t))return!1}}return!0},h.prototype.clone=function(){var e=d();return this.copyTo(e),e},h.prototype.intValue=function(){if(this.s<0){if(1==this.t)return this[0]-this.DV;if(0==this.t)return-1}else{if(1==this.t)return this[0];if(0==this.t)return 0}return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]},h.prototype.byteValue=function(){return 0==this.t?this.s:this[0]<<24>>24},h.prototype.shortValue=function(){return 0==this.t?this.s:this[0]<<16>>16},h.prototype.signum=function(){return this.s<0?-1:this.t<=0||1==this.t&&this[0]<=0?0:1},h.prototype.toByteArray=function(){var e=this.t,t=new Array;t[0]=this.s;var n,r=this.DB-e*this.DB%8,i=0;if(e-- >0)for(r<this.DB&&(n=this[e]>>r)!=(this.s&this.DM)>>r&&(t[i++]=n|this.s<<this.DB-r);e>=0;)r<8?(n=(this[e]&(1<<r)-1)<<8-r,n|=this[--e]>>(r+=this.DB-8)):(n=this[e]>>(r-=8)&255,r<=0&&(r+=this.DB,--e)),0!=(128&n)&&(n|=-256),0==i&&(128&this.s)!=(128&n)&&++i,(i>0||n!=this.s)&&(t[i++]=n);return t},h.prototype.equals=function(e){return 0==this.compareTo(e)},h.prototype.min=function(e){return this.compareTo(e)<0?this:e},h.prototype.max=function(e){return this.compareTo(e)>0?this:e},h.prototype.and=function(e){var t=d();return this.bitwiseTo(e,x,t),t},h.prototype.or=function(e){var t=d();return this.bitwiseTo(e,E,t),t},h.prototype.xor=function(e){var t=d();return this.bitwiseTo(e,T,t),t},h.prototype.andNot=function(e){var t=d();return this.bitwiseTo(e,k,t),t},h.prototype.not=function(){for(var e=d(),t=0;t<this.t;++t)e[t]=this.DM&~this[t];return e.t=this.t,e.s=~this.s,e},h.prototype.shiftLeft=function(e){var t=d();return e<0?this.rShiftTo(-e,t):this.lShiftTo(e,t),t},h.prototype.shiftRight=function(e){var t=d();return e<0?this.lShiftTo(-e,t):this.rShiftTo(e,t),t},h.prototype.getLowestSetBit=function(){for(var e=0;e<this.t;++e)if(0!=this[e])return e*this.DB+N(this[e]);return this.s<0?this.t*this.DB:-1},h.prototype.bitCount=function(){for(var e=0,t=this.s&this.DM,n=0;n<this.t;++n)e+=F(this[n]^t);return e},h.prototype.testBit=function(e){var t=Math.floor(e/this.DB);return t>=this.t?0!=this.s:0!=(this[t]&1<<e%this.DB)},h.prototype.setBit=function(e){return this.changeBit(e,E)},h.prototype.clearBit=function(e){return this.changeBit(e,k)},h.prototype.flipBit=function(e){return this.changeBit(e,T)},h.prototype.add=function(e){var t=d();return this.addTo(e,t),t},h.prototype.subtract=function(e){var t=d();return this.subTo(e,t),t},h.prototype.multiply=function(e){var t=d();return this.multiplyTo(e,t),t},h.prototype.divide=function(e){var t=d();return this.divRemTo(e,t,null),t},h.prototype.remainder=function(e){var t=d();return this.divRemTo(e,null,t),t},h.prototype.divideAndRemainder=function(e){var t=d(),n=d();return this.divRemTo(e,t,n),new Array(t,n)},h.prototype.modPow=function(e,t){var n,r,i=e.bitLength(),s=b(1);if(i<=0)return s;n=i<18?1:i<48?3:i<144?4:i<768?5:6,r=i<8?new w(t):t.isEven()?new D(t):new C(t);var o=new Array,a=3,c=n-1,l=(1<<n)-1;if(o[1]=r.convert(this),n>1){var u=d();for(r.sqrTo(o[1],u);a<=l;)o[a]=d(),r.mulTo(u,o[a-2],o[a]),a+=2}var h,f,p=e.t-1,m=!0,g=d();for(i=S(e[p])-1;p>=0;){for(i>=c?h=e[p]>>i-c&l:(h=(e[p]&(1<<i+1)-1)<<c-i,p>0&&(h|=e[p-1]>>this.DB+i-c)),a=n;0==(1&h);)h>>=1,--a;if((i-=a)<0&&(i+=this.DB,--p),m)o[h].copyTo(s),m=!1;else{for(;a>1;)r.sqrTo(s,g),r.sqrTo(g,s),a-=2;a>0?r.sqrTo(s,g):(f=s,s=g,g=f),r.mulTo(g,o[h],s)}for(;p>=0&&0==(e[p]&1<<i);)r.sqrTo(s,g),f=s,s=g,g=f,--i<0&&(i=this.DB-1,--p)}return r.revert(s)},h.prototype.modInverse=function(e){var t=e.isEven();if(this.isEven()&&t||0==e.signum())return h.ZERO;for(var n=e.clone(),r=this.clone(),i=b(1),s=b(0),o=b(0),a=b(1);0!=n.signum();){for(;n.isEven();)n.rShiftTo(1,n),t?(i.isEven()&&s.isEven()||(i.addTo(this,i),s.subTo(e,s)),i.rShiftTo(1,i)):s.isEven()||s.subTo(e,s),s.rShiftTo(1,s);for(;r.isEven();)r.rShiftTo(1,r),t?(o.isEven()&&a.isEven()||(o.addTo(this,o),a.subTo(e,a)),o.rShiftTo(1,o)):a.isEven()||a.subTo(e,a),a.rShiftTo(1,a);n.compareTo(r)>=0?(n.subTo(r,n),t&&i.subTo(o,i),s.subTo(a,s)):(r.subTo(n,r),t&&o.subTo(i,o),a.subTo(s,a))}return 0!=r.compareTo(h.ONE)?h.ZERO:a.compareTo(e)>=0?a.subtract(e):a.signum()<0?(a.addTo(e,a),a.signum()<0?a.add(e):a):a},h.prototype.pow=function(e){return this.exp(e,new I)},h.prototype.gcd=function(e){var t=this.s<0?this.negate():this.clone(),n=e.s<0?e.negate():e.clone();if(t.compareTo(n)<0){var r=t;t=n,n=r}var i=t.getLowestSetBit(),s=n.getLowestSetBit();if(s<0)return t;for(i<s&&(s=i),s>0&&(t.rShiftTo(s,t),n.rShiftTo(s,n));t.signum()>0;)(i=t.getLowestSetBit())>0&&t.rShiftTo(i,t),(i=n.getLowestSetBit())>0&&n.rShiftTo(i,n),t.compareTo(n)>=0?(t.subTo(n,t),t.rShiftTo(1,t)):(n.subTo(t,n),n.rShiftTo(1,n));return s>0&&n.lShiftTo(s,n),n},h.prototype.isProbablePrime=function(e){var t,n=this.abs();if(1==n.t&&n[0]<=O[O.length-1]){for(t=0;t<O.length;++t)if(n[0]==O[t])return!0;return!1}if(n.isEven())return!1;for(t=1;t<O.length;){for(var r=O[t],i=t+1;i<O.length&&r<P;)r*=O[i++];for(r=n.modInt(r);t<i;)if(r%O[t++]==0)return!1}return n.millerRabin(e)},h.prototype.square=function(){var e=d();return this.squareTo(e),e},R.prototype.init=function(e){var t,n,r;for(t=0;t<256;++t)this.S[t]=t;for(n=0,t=0;t<256;++t)n=n+this.S[t]+e[t%e.length]&255,r=this.S[t],this.S[t]=this.S[n],this.S[n]=r;this.i=0,this.j=0},R.prototype.next=function(){var e;return this.i=this.i+1&255,this.j=this.j+this.S[this.i]&255,e=this.S[this.i],this.S[this.i]=this.S[this.j],this.S[this.j]=e,this.S[e+this.S[this.i]&255]};var M,B,L,q=256;function _(){var e;e=(new Date).getTime(),B[L++]^=255&e,B[L++]^=e>>8&255,B[L++]^=e>>16&255,B[L++]^=e>>24&255,L>=q&&(L-=q)}if(null==B){var j;if(B=new Array,L=0,void 0!==r&&(void 0!==r.crypto||void 0!==r.msCrypto)){var z=r.crypto||r.msCrypto;if(z.getRandomValues){var U=new Uint8Array(32);for(z.getRandomValues(U),j=0;j<32;++j)B[L++]=U[j]}else if("Netscape"==n.appName&&n.appVersion<"5"){var H=r.crypto.random(32);for(j=0;j<H.length;++j)B[L++]=255&H.charCodeAt(j)}}for(;L<q;)j=Math.floor(65536*Math.random()),B[L++]=j>>>8,B[L++]=255&j;L=0,_()}function V(){if(null==M){for(_(),(M=new R).init(B),L=0;L<B.length;++L)B[L]=0;L=0}return M.next()}function K(){}function G(e,t){return new h(e,t)}function W(e,t,n){for(var r="",i=0;r.length<t;)r+=n(String.fromCharCode.apply(String,e.concat([(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i]))),i+=1;return r}function J(){this.n=null,this.e=0,this.d=null,this.p=null,this.q=null,this.dmp1=null,this.dmq1=null,this.coeff=null}function Z(e,t,n){for(var r="",i=0;r.length<t;)r+=n(e+String.fromCharCode.apply(String,[(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i])),i+=1;return r}function $(e,t){this.x=t,this.q=e}function Q(e,t,n,r){this.curve=e,this.x=t,this.y=n,this.z=null==r?h.ONE:r,this.zinv=null}function X(e,t,n){this.q=e,this.a=this.fromBigInteger(t),this.b=this.fromBigInteger(n),this.infinity=new Q(this,null,null)}K.prototype.nextBytes=function(e){var t;for(t=0;t<e.length;++t)e[t]=V()},J.prototype.doPublic=function(e){return e.modPowInt(this.e,this.n)},J.prototype.setPublic=function(e,t){if(this.isPublic=!0,this.isPrivate=!1,"string"!==typeof e)this.n=e,this.e=t;else{if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA public key";this.n=G(e,16),this.e=parseInt(t,16)}},J.prototype.encrypt=function(e){var t=function(e,t){if(t<e.length+11)throw"Message too long for RSA";for(var n=new Array,r=e.length-1;r>=0&&t>0;){var i=e.charCodeAt(r--);i<128?n[--t]=i:i>127&&i<2048?(n[--t]=63&i|128,n[--t]=i>>6|192):(n[--t]=63&i|128,n[--t]=i>>6&63|128,n[--t]=i>>12|224)}n[--t]=0;for(var s=new K,o=new Array;t>2;){for(o[0]=0;0==o[0];)s.nextBytes(o);n[--t]=o[0]}return n[--t]=2,n[--t]=0,new h(n)}(e,this.n.bitLength()+7>>3);if(null==t)return null;var n=this.doPublic(t);if(null==n)return null;var r=n.toString(16);return 0==(1&r.length)?r:"0"+r},J.prototype.encryptOAEP=function(e,t,n){var r=this.n.bitLength()+7>>3,i=function(e,t,n,r){var i=ee.crypto.MessageDigest,s=ee.crypto.Util,o=null;if(n||(n="sha1"),"string"===typeof n&&(o=i.getCanonicalAlgName(n),r=i.getHashLength(o),n=function(e){return me(s.hashHex(ge(e),o))}),e.length+2*r+2>t)throw"Message too long for RSA";var a,c="";for(a=0;a<t-e.length-2*r-2;a+=1)c+="\0";var l=n("")+c+"\x01"+e,u=new Array(r);(new K).nextBytes(u);var d=W(u,l.length,n),f=[];for(a=0;a<l.length;a+=1)f[a]=l.charCodeAt(a)^d.charCodeAt(a);var p=W(f,u.length,n),m=[0];for(a=0;a<u.length;a+=1)m[a+1]=u[a]^p.charCodeAt(a);return new h(m.concat(f))}(e,r,t,n);if(null==i)return null;var s=this.doPublic(i);if(null==s)return null;for(var o=s.toString(16);o.length<2*r;)o="0"+o;return o},J.prototype.type="RSA",J.prototype.doPrivate=function(e){if(null==this.p||null==this.q)return e.modPow(this.d,this.n);for(var t=e.mod(this.p).modPow(this.dmp1,this.p),n=e.mod(this.q).modPow(this.dmq1,this.q);t.compareTo(n)<0;)t=t.add(this.p);return t.subtract(n).multiply(this.coeff).mod(this.p).multiply(this.q).add(n)},J.prototype.setPrivate=function(e,t,n){if(this.isPrivate=!0,"string"!==typeof e)this.n=e,this.e=t,this.d=n;else{if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA private key";this.n=G(e,16),this.e=parseInt(t,16),this.d=G(n,16)}},J.prototype.setPrivateEx=function(e,t,n,r,i,s,o,a){if(this.isPrivate=!0,this.isPublic=!1,null==e)throw"RSASetPrivateEx N == null";if(null==t)throw"RSASetPrivateEx E == null";if(0==e.length)throw"RSASetPrivateEx N.length == 0";if(0==t.length)throw"RSASetPrivateEx E.length == 0";if(!(null!=e&&null!=t&&e.length>0&&t.length>0))throw"Invalid RSA private key in RSASetPrivateEx";this.n=G(e,16),this.e=parseInt(t,16),this.d=G(n,16),this.p=G(r,16),this.q=G(i,16),this.dmp1=G(s,16),this.dmq1=G(o,16),this.coeff=G(a,16)},J.prototype.generate=function(e,t){var n=new K,r=e>>1;this.e=parseInt(t,16);for(var i=new h(t,16),s=e/2-100,o=h.ONE.shiftLeft(s);;){for(;this.p=new h(e-r,1,n),0!=this.p.subtract(h.ONE).gcd(i).compareTo(h.ONE)||!this.p.isProbablePrime(10););for(;this.q=new h(r,1,n),0!=this.q.subtract(h.ONE).gcd(i).compareTo(h.ONE)||!this.q.isProbablePrime(10););if(this.p.compareTo(this.q)<=0){var a=this.p;this.p=this.q,this.q=a}var c=this.q.subtract(this.p).abs();if(!(c.bitLength()<s||c.compareTo(o)<=0)){var l=this.p.subtract(h.ONE),u=this.q.subtract(h.ONE),d=l.multiply(u);if(0==d.gcd(i).compareTo(h.ONE)&&(this.n=this.p.multiply(this.q),this.n.bitLength()==e)){this.d=i.modInverse(d),this.dmp1=this.d.mod(l),this.dmq1=this.d.mod(u),this.coeff=this.q.modInverse(this.p);break}}}this.isPrivate=!0},J.prototype.decrypt=function(e){if(e.length!=Math.ceil(this.n.bitLength()/4))throw new Error("wrong ctext length");var t=G(e,16),n=this.doPrivate(t);return null==n?null:function(e,t){for(var n=e.toByteArray(),r=0;r<n.length&&0==n[r];)++r;if(n.length-r!=t-1||2!=n[r])return null;for(++r;0!=n[r];)if(++r>=n.length)return null;for(var i="";++r<n.length;){var s=255&n[r];s<128?i+=String.fromCharCode(s):s>191&&s<224?(i+=String.fromCharCode((31&s)<<6|63&n[r+1]),++r):(i+=String.fromCharCode((15&s)<<12|(63&n[r+1])<<6|63&n[r+2]),r+=2)}return i}(n,this.n.bitLength()+7>>3)},J.prototype.decryptOAEP=function(e,t,n){if(e.length!=Math.ceil(this.n.bitLength()/4))throw new Error("wrong ctext length");var r=G(e,16),i=this.doPrivate(r);return null==i?null:function(e,t,n,r){var i=ee.crypto.MessageDigest,s=ee.crypto.Util,o=null;for(n||(n="sha1"),"string"===typeof n&&(o=i.getCanonicalAlgName(n),r=i.getHashLength(o),n=function(e){return me(s.hashHex(ge(e),o))}),e=e.toByteArray(),a=0;a<e.length;a+=1)e[a]&=255;for(;e.length<t;)e.unshift(0);if((e=String.fromCharCode.apply(String,e)).length<2*r+2)throw"Cipher too short";var a,c=e.substr(1,r),l=e.substr(r+1),u=Z(l,r,n),h=[];for(a=0;a<c.length;a+=1)h[a]=c.charCodeAt(a)^u.charCodeAt(a);var d=Z(String.fromCharCode.apply(String,h),e.length-r,n),f=[];for(a=0;a<l.length;a+=1)f[a]=l.charCodeAt(a)^d.charCodeAt(a);if((f=String.fromCharCode.apply(String,f)).substr(0,r)!==n(""))throw"Hash mismatch";var p=(f=f.substr(r)).indexOf("\x01");if((-1!=p?f.substr(0,p).lastIndexOf("\0"):-1)+1!=p)throw"Malformed data";return f.substr(p+1)}(i,this.n.bitLength()+7>>3,t,n)},$.prototype.equals=function(e){return e==this||this.q.equals(e.q)&&this.x.equals(e.x)},$.prototype.toBigInteger=function(){return this.x},$.prototype.negate=function(){return new $(this.q,this.x.negate().mod(this.q))},$.prototype.add=function(e){return new $(this.q,this.x.add(e.toBigInteger()).mod(this.q))},$.prototype.subtract=function(e){return new $(this.q,this.x.subtract(e.toBigInteger()).mod(this.q))},$.prototype.multiply=function(e){return new $(this.q,this.x.multiply(e.toBigInteger()).mod(this.q))},$.prototype.square=function(){return new $(this.q,this.x.square().mod(this.q))},$.prototype.divide=function(e){return new $(this.q,this.x.multiply(e.toBigInteger().modInverse(this.q)).mod(this.q))},$.prototype.sqrt=function(){return new $(this.q,this.x.sqrt().mod(this.q))},Q.prototype.getX=function(){return null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.x.toBigInteger().multiply(this.zinv).mod(this.curve.q))},Q.prototype.getY=function(){return null==this.zinv&&(this.zinv=this.z.modInverse(this.curve.q)),this.curve.fromBigInteger(this.y.toBigInteger().multiply(this.zinv).mod(this.curve.q))},Q.prototype.equals=function(e){return e==this||(this.isInfinity()?e.isInfinity():e.isInfinity()?this.isInfinity():!!e.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(e.z)).mod(this.curve.q).equals(h.ZERO)&&e.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(e.z)).mod(this.curve.q).equals(h.ZERO))},Q.prototype.isInfinity=function(){return null==this.x&&null==this.y||this.z.equals(h.ZERO)&&!this.y.toBigInteger().equals(h.ZERO)},Q.prototype.negate=function(){return new Q(this.curve,this.x,this.y.negate(),this.z)},Q.prototype.add=function(e){if(this.isInfinity())return e;if(e.isInfinity())return this;var t=e.y.toBigInteger().multiply(this.z).subtract(this.y.toBigInteger().multiply(e.z)).mod(this.curve.q),n=e.x.toBigInteger().multiply(this.z).subtract(this.x.toBigInteger().multiply(e.z)).mod(this.curve.q);if(h.ZERO.equals(n))return h.ZERO.equals(t)?this.twice():this.curve.getInfinity();var r=new h("3"),i=this.x.toBigInteger(),s=this.y.toBigInteger(),o=(e.x.toBigInteger(),e.y.toBigInteger(),n.square()),a=o.multiply(n),c=i.multiply(o),l=t.square().multiply(this.z),u=l.subtract(c.shiftLeft(1)).multiply(e.z).subtract(a).multiply(n).mod(this.curve.q),d=c.multiply(r).multiply(t).subtract(s.multiply(a)).subtract(l.multiply(t)).multiply(e.z).add(t.multiply(a)).mod(this.curve.q),f=a.multiply(this.z).multiply(e.z).mod(this.curve.q);return new Q(this.curve,this.curve.fromBigInteger(u),this.curve.fromBigInteger(d),f)},Q.prototype.twice=function(){if(this.isInfinity())return this;if(0==this.y.toBigInteger().signum())return this.curve.getInfinity();var e=new h("3"),t=this.x.toBigInteger(),n=this.y.toBigInteger(),r=n.multiply(this.z),i=r.multiply(n).mod(this.curve.q),s=this.curve.a.toBigInteger(),o=t.square().multiply(e);h.ZERO.equals(s)||(o=o.add(this.z.square().multiply(s)));var a=(o=o.mod(this.curve.q)).square().subtract(t.shiftLeft(3).multiply(i)).shiftLeft(1).multiply(r).mod(this.curve.q),c=o.multiply(e).multiply(t).subtract(i.shiftLeft(1)).shiftLeft(2).multiply(i).subtract(o.square().multiply(o)).mod(this.curve.q),l=r.square().multiply(r).shiftLeft(3).mod(this.curve.q);return new Q(this.curve,this.curve.fromBigInteger(a),this.curve.fromBigInteger(c),l)},Q.prototype.multiply=function(e){if(this.isInfinity())return this;if(0==e.signum())return this.curve.getInfinity();var t,n=e,r=n.multiply(new h("3")),i=this.negate(),s=this,o=this.curve.q.subtract(e),a=o.multiply(new h("3")),c=new Q(this.curve,this.x,this.y),l=c.negate();for(t=r.bitLength()-2;t>0;--t){s=s.twice();var u=r.testBit(t);u!=n.testBit(t)&&(s=s.add(u?this:i))}for(t=a.bitLength()-2;t>0;--t){c=c.twice();var d=a.testBit(t);d!=o.testBit(t)&&(c=c.add(d?c:l))}return s},Q.prototype.multiplyTwo=function(e,t,n){var r;r=e.bitLength()>n.bitLength()?e.bitLength()-1:n.bitLength()-1;for(var i=this.curve.getInfinity(),s=this.add(t);r>=0;)i=i.twice(),e.testBit(r)?i=n.testBit(r)?i.add(s):i.add(this):n.testBit(r)&&(i=i.add(t)),--r;return i},X.prototype.getQ=function(){return this.q},X.prototype.getA=function(){return this.a},X.prototype.getB=function(){return this.b},X.prototype.equals=function(e){return e==this||this.q.equals(e.q)&&this.a.equals(e.a)&&this.b.equals(e.b)},X.prototype.getInfinity=function(){return this.infinity},X.prototype.fromBigInteger=function(e){return new $(this.q,e)},X.prototype.decodePointHex=function(e){switch(parseInt(e.substr(0,2),16)){case 0:return this.infinity;case 2:case 3:var t=e.substr(0,2),n=(e.substr(2),this.fromBigInteger(new h(a,16))),r=this.getA(),i=this.getB(),s=n.square().add(r).multiply(n).add(i).sqrt();return"03"==t&&(s=s.negate()),new Q(this,n,s);case 4:case 6:case 7:var o=(e.length-2)/2,a=e.substr(2,o),c=e.substr(o+2,o);return new Q(this,this.fromBigInteger(new h(a,16)),this.fromBigInteger(new h(c,16)));default:return null}},$.prototype.getByteLength=function(){return Math.floor((this.toBigInteger().bitLength()+7)/8)},Q.prototype.getEncoded=function(e){var t=function(e,t){var n=e.toByteArrayUnsigned();if(t<n.length)n=n.slice(n.length-t);else for(;t>n.length;)n.unshift(0);return n},n=this.getX().toBigInteger(),r=this.getY().toBigInteger(),i=t(n,32);return e?r.isEven()?i.unshift(2):i.unshift(3):(i.unshift(4),i=i.concat(t(r,32))),i},Q.decodeFrom=function(e,t){t[0];var n=t.length-1,r=t.slice(1,1+n/2),i=t.slice(1+n/2,1+n);r.unshift(0),i.unshift(0);var s=new h(r),o=new h(i);return new Q(e,e.fromBigInteger(s),e.fromBigInteger(o))},Q.decodeFromHex=function(e,t){t.substr(0,2);var n=t.length-2,r=t.substr(2,n/2),i=t.substr(2+n/2,n/2),s=new h(r,16),o=new h(i,16);return new Q(e,e.fromBigInteger(s),e.fromBigInteger(o))},Q.prototype.add2D=function(e){if(this.isInfinity())return e;if(e.isInfinity())return this;if(this.x.equals(e.x))return this.y.equals(e.y)?this.twice():this.curve.getInfinity();var t=e.x.subtract(this.x),n=e.y.subtract(this.y).divide(t),r=n.square().subtract(this.x).subtract(e.x),i=n.multiply(this.x.subtract(r)).subtract(this.y);return new Q(this.curve,r,i)},Q.prototype.twice2D=function(){if(this.isInfinity())return this;if(0==this.y.toBigInteger().signum())return this.curve.getInfinity();var e=this.curve.fromBigInteger(h.valueOf(2)),t=this.curve.fromBigInteger(h.valueOf(3)),n=this.x.square().multiply(t).add(this.curve.a).divide(this.y.multiply(e)),r=n.square().subtract(this.x.multiply(e)),i=n.multiply(this.x.subtract(r)).subtract(this.y);return new Q(this.curve,r,i)},Q.prototype.multiply2D=function(e){if(this.isInfinity())return this;if(0==e.signum())return this.curve.getInfinity();var t,n=e,r=n.multiply(new h("3")),i=this.negate(),s=this;for(t=r.bitLength()-2;t>0;--t){s=s.twice();var o=r.testBit(t);o!=n.testBit(t)&&(s=s.add2D(o?this:i))}return s},Q.prototype.isOnCurve=function(){var e=this.getX().toBigInteger(),t=this.getY().toBigInteger(),n=this.curve.getA().toBigInteger(),r=this.curve.getB().toBigInteger(),i=this.curve.getQ(),s=t.multiply(t).mod(i),o=e.multiply(e).multiply(e).add(n.multiply(e)).add(r).mod(i);return s.equals(o)},Q.prototype.toString=function(){return"("+this.getX().toBigInteger().toString()+","+this.getY().toBigInteger().toString()+")"},Q.prototype.validate=function(){var e=this.curve.getQ();if(this.isInfinity())throw new Error("Point is at infinity.");var t=this.getX().toBigInteger(),n=this.getY().toBigInteger();if(t.compareTo(h.ONE)<0||t.compareTo(e.subtract(h.ONE))>0)throw new Error("x coordinate out of bounds");if(n.compareTo(h.ONE)<0||n.compareTo(e.subtract(h.ONE))>0)throw new Error("y coordinate out of bounds");if(!this.isOnCurve())throw new Error("Point is not on the curve.");if(this.multiply(e).isInfinity())throw new Error("Point is not a scalar multiple of G.");return!0};var Y=function(){var e=new RegExp('(?:false|true|null|[\\{\\}\\[\\]]|(?:-?\\b(?:0|[1-9][0-9]*)(?:\\.[0-9]+)?(?:[eE][+-]?[0-9]+)?\\b)|(?:"(?:[^\\0-\\x08\\x0a-\\x1f"\\\\]|\\\\(?:["/\\\\bfnrt]|u[0-9A-Fa-f]{4}))*"))',"g"),t=new RegExp("\\\\(?:([^u])|u(.{4}))","g"),n={'"':'"',"/":"/","\\":"\\",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"};function r(e,t,r){return t?n[t]:String.fromCharCode(parseInt(r,16))}var i=new String(""),s=Object.hasOwnProperty;return function(n,o){var a,c,l=n.match(e),u=l[0],h=!1;"{"===u?a={}:"["===u?a=[]:(a=[],h=!0);for(var d=[a],f=1-h,p=l.length;f<p;++f){var m;switch((u=l[f]).charCodeAt(0)){default:(m=d[0])[c||m.length]=+u,c=void 0;break;case 34:if(-1!==(u=u.substring(1,u.length-1)).indexOf("\\")&&(u=u.replace(t,r)),m=d[0],!c){if(!(m instanceof Array)){c=u||i;break}c=m.length}m[c]=u,c=void 0;break;case 91:m=d[0],d.unshift(m[c||m.length]=[]),c=void 0;break;case 93:case 125:d.shift();break;case 102:(m=d[0])[c||m.length]=!1,c=void 0;break;case 110:(m=d[0])[c||m.length]=null,c=void 0;break;case 116:(m=d[0])[c||m.length]=!0,c=void 0;break;case 123:m=d[0],d.unshift(m[c||m.length]={}),c=void 0}}if(h){if(1!==d.length)throw new Error;a=a[0]}else if(d.length)throw new Error;if(o){var g=function(e,t){var n=e[t];if(n&&"object"===typeof n){var r=null;for(var i in n)if(s.call(n,i)&&n!==e){var a=g(n,i);void 0!==a?n[i]=a:(r||(r=[]),r.push(i))}if(r)for(var c=r.length;--c>=0;)delete n[r[c]]}return o.call(e,t,n)};a=g({"":a},"")}return a}}();"undefined"!=typeof ee&&ee||(ee={}),"undefined"!=typeof ee.asn1&&ee.asn1||(ee.asn1={}),ee.asn1.ASN1Util=new function(){this.integerToByteHex=function(e){var t=e.toString(16);return t.length%2==1&&(t="0"+t),t},this.bigIntToMinTwosComplementsHex=function(e){return ze(e)},this.getPEMStringFromHex=function(e,t){return Se(e,t)},this.newObject=function(e){var t=ee.asn1,n=t.ASN1Object,r=t.DERBoolean,i=t.DERInteger,s=t.DERBitString,o=t.DEROctetString,a=t.DERNull,c=t.DERObjectIdentifier,l=t.DEREnumerated,u=t.DERUTF8String,h=t.DERNumericString,d=t.DERPrintableString,f=t.DERTeletexString,p=t.DERIA5String,m=t.DERUTCTime,g=t.DERGeneralizedTime,v=t.DERVisibleString,y=t.DERBMPString,b=t.DERSequence,S=t.DERSet,w=t.DERTaggedObject,C=t.ASN1Util.newObject;if(e instanceof t.ASN1Object)return e;var x=Object.keys(e);if(1!=x.length)throw new Error("key of param shall be only one.");var E=x[0];if(-1==":asn1:bool:int:bitstr:octstr:null:oid:enum:utf8str:numstr:prnstr:telstr:ia5str:utctime:gentime:visstr:bmpstr:seq:set:tag:".indexOf(":"+E+":"))throw new Error("undefined key: "+E);if("bool"==E)return new r(e[E]);if("int"==E)return new i(e[E]);if("bitstr"==E)return new s(e[E]);if("octstr"==E)return new o(e[E]);if("null"==E)return new a(e[E]);if("oid"==E)return new c(e[E]);if("enum"==E)return new l(e[E]);if("utf8str"==E)return new u(e[E]);if("numstr"==E)return new h(e[E]);if("prnstr"==E)return new d(e[E]);if("telstr"==E)return new f(e[E]);if("ia5str"==E)return new p(e[E]);if("utctime"==E)return new m(e[E]);if("gentime"==E)return new g(e[E]);if("visstr"==E)return new v(e[E]);if("bmpstr"==E)return new y(e[E]);if("asn1"==E)return new n(e[E]);if("seq"==E){for(var T=e[E],k=[],N=0;N<T.length;N++){var F=C(T[N]);k.push(F)}return new b({array:k})}if("set"==E){for(T=e[E],k=[],N=0;N<T.length;N++){F=C(T[N]);k.push(F)}return new S({array:k})}if("tag"==E){var I=e[E];if("[object Array]"===Object.prototype.toString.call(I)&&3==I.length){var A=C(I[2]);return new w({tag:I[0],explicit:I[1],obj:A})}return new w(I)}},this.jsonToASN1HEX=function(e){return this.newObject(e).tohex()}},ee.asn1.ASN1Util.oidHexToInt=function(e){for(var t="",n=parseInt(e.substr(0,2),16),r=(t=Math.floor(n/40)+"."+n%40,""),i=2;i<e.length;i+=2){var s=("00000000"+parseInt(e.substr(i,2),16).toString(2)).slice(-8);if(r+=s.substr(1,7),"0"==s.substr(0,1))t=t+"."+new h(r,2).toString(10),r=""}return t},ee.asn1.ASN1Util.oidIntToHex=function(e){var t=function(e){var t=e.toString(16);return 1==t.length&&(t="0"+t),t},n=function(e){var n="",r=new h(e,10).toString(2),i=7-r.length%7;7==i&&(i=0);for(var s="",o=0;o<i;o++)s+="0";r=s+r;for(o=0;o<r.length-1;o+=7){var a=r.substr(o,7);o!=r.length-7&&(a="1"+a),n+=t(parseInt(a,2))}return n};if(!e.match(/^[0-9.]+$/))throw"malformed oid string: "+e;var r="",i=e.split("."),s=40*parseInt(i[0])+parseInt(i[1]);r+=t(s),i.splice(0,2);for(var o=0;o<i.length;o++)r+=n(i[o]);return r},ee.asn1.ASN1Object=function(e){this.params=null,this.getLengthHexFromValue=function(){if("undefined"==typeof this.hV||null==this.hV)throw new Error("this.hV is null or undefined");if(this.hV.length%2==1)throw new Error("value hex must be even length: n=0,v="+this.hV);var e=this.hV.length/2,t=e.toString(16);if(t.length%2==1&&(t="0"+t),e<128)return t;var n=t.length/2;if(n>15)throw new Error("ASN.1 length too long to represent by 8x: n = "+e.toString(16));return(128+n).toString(16)+t},this.tohex=function(){return(null==this.hTLV||this.isModified)&&(this.hV=this.getFreshValueHex(),this.hL=this.getLengthHexFromValue(),this.hTLV=this.hT+this.hL+this.hV,this.isModified=!1),this.hTLV},this.getEncodedHex=function(){return this.tohex()},this.getValueHex=function(){return this.tohex(),this.hV},this.getFreshValueHex=function(){return""},this.setByParam=function(e){this.params=e},void 0!=e&&void 0!=e.tlv&&(this.hTLV=e.tlv,this.isModified=!1)},ee.asn1.DERAbstractString=function(e){ee.asn1.DERAbstractString.superclass.constructor.call(this);this.getString=function(){return this.s},this.setString=function(e){this.hTLV=null,this.isModified=!0,this.s=e,this.hV=de(this.s).toLowerCase()},this.setStringHex=function(e){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=e},this.getFreshValueHex=function(){return this.hV},"undefined"!=typeof e&&("string"==typeof e?this.setString(e):"undefined"!=typeof e.str?this.setString(e.str):"undefined"!=typeof e.hex&&this.setStringHex(e.hex))},Je(ee.asn1.DERAbstractString,ee.asn1.ASN1Object),ee.asn1.DERAbstractTime=function(e){ee.asn1.DERAbstractTime.superclass.constructor.call(this);this.localDateToUTC=function(e){var t=e.getTime()+6e4*e.getTimezoneOffset();return new Date(t)},this.formatDate=function(e,t,n){var r=this.zeroPadding,i=this.localDateToUTC(e),s=String(i.getFullYear());"utc"==t&&(s=s.substr(2,2));var o=s+r(String(i.getMonth()+1),2)+r(String(i.getDate()),2)+r(String(i.getHours()),2)+r(String(i.getMinutes()),2)+r(String(i.getSeconds()),2);if(!0===n){var a=i.getMilliseconds();if(0!=a){var c=r(String(a),3);o=o+"."+(c=c.replace(/[0]+$/,""))}}return o+"Z"},this.zeroPadding=function(e,t){return e.length>=t?e:new Array(t-e.length+1).join("0")+e},this.setByParam=function(e){this.hV=null,this.hTLV=null,this.params=e},this.getString=function(){},this.setString=function(e){this.hTLV=null,this.isModified=!0,void 0==this.params&&(this.params={}),this.params.str=e},this.setByDate=function(e){this.hTLV=null,this.isModified=!0,void 0==this.params&&(this.params={}),this.params.date=e},this.setByDateValue=function(e,t,n,r,i,s){var o=new Date(Date.UTC(e,t-1,n,r,i,s,0));this.setByDate(o)},this.getFreshValueHex=function(){return this.hV}},Je(ee.asn1.DERAbstractTime,ee.asn1.ASN1Object),ee.asn1.DERAbstractStructured=function(e){ee.asn1.DERAbstractString.superclass.constructor.call(this);this.setByASN1ObjectArray=function(e){this.hTLV=null,this.isModified=!0,this.asn1Array=e},this.appendASN1Object=function(e){this.hTLV=null,this.isModified=!0,this.asn1Array.push(e)},this.asn1Array=new Array,"undefined"!=typeof e&&"undefined"!=typeof e.array&&(this.asn1Array=e.array)},Je(ee.asn1.DERAbstractStructured,ee.asn1.ASN1Object),ee.asn1.DERBoolean=function(e){ee.asn1.DERBoolean.superclass.constructor.call(this),this.hT="01",this.hTLV=0==e?"010100":"0101ff"},Je(ee.asn1.DERBoolean,ee.asn1.ASN1Object),ee.asn1.DERInteger=function(e){ee.asn1.DERInteger.superclass.constructor.call(this),this.hT="02",this.params=null;var t=ze;this.setByBigInteger=function(e){this.isModified=!0,this.params={bigint:e}},this.setByInteger=function(e){this.isModified=!0,this.params=e},this.setValueHex=function(e){this.isModified=!0,this.params={hex:e}},this.getFreshValueHex=function(){var e=this.params,n=null;if(null==e)throw new Error("value not set");if("object"==typeof e&&void 0!=e.hex)return this.hV=e.hex,this.hV;if("number"==typeof e)n=new h(String(e),10);else if(void 0!=e.int)n=new h(String(e.int),10);else{if(void 0==e.bigint)throw new Error("wrong parameter");n=e.bigint}return this.hV=t(n),this.hV},void 0!=e&&(this.params=e)},Je(ee.asn1.DERInteger,ee.asn1.ASN1Object),ee.asn1.DERBitString=function(e){if(void 0!==e&&"undefined"!==typeof e.obj){var t=ee.asn1.ASN1Util.newObject(e.obj);e.hex="00"+t.tohex()}ee.asn1.DERBitString.superclass.constructor.call(this),this.hT="03",this.setHexValueIncludingUnusedBits=function(e){this.hTLV=null,this.isModified=!0,this.hV=e},this.setUnusedBitsAndHexValue=function(e,t){if(e<0||7<e)throw"unused bits shall be from 0 to 7: u = "+e;var n="0"+e;this.hTLV=null,this.isModified=!0,this.hV=n+t},this.setByBinaryString=function(e){var t=8-(e=e.replace(/0+$/,"")).length%8;8==t&&(t=0),e+="0000000".substr(0,t);for(var n="",r=0;r<e.length-1;r+=8){var i=e.substr(r,8),s=parseInt(i,2).toString(16);1==s.length&&(s="0"+s),n+=s}this.hTLV=null,this.isModified=!0,this.hV="0"+t+n},this.setByBooleanArray=function(e){for(var t="",n=0;n<e.length;n++)1==e[n]?t+="1":t+="0";this.setByBinaryString(t)},this.newFalseArray=function(e){for(var t=new Array(e),n=0;n<e;n++)t[n]=!1;return t},this.getFreshValueHex=function(){return this.hV},"undefined"!=typeof e&&("string"==typeof e&&e.toLowerCase().match(/^[0-9a-f]+$/)?this.setHexValueIncludingUnusedBits(e):"undefined"!=typeof e.hex?this.setHexValueIncludingUnusedBits(e.hex):"undefined"!=typeof e.bin?this.setByBinaryString(e.bin):"undefined"!=typeof e.array&&this.setByBooleanArray(e.array))},Je(ee.asn1.DERBitString,ee.asn1.ASN1Object),ee.asn1.DEROctetString=function(e){if(void 0!==e&&"undefined"!==typeof e.obj){var t=ee.asn1.ASN1Util.newObject(e.obj);e.hex=t.tohex()}ee.asn1.DEROctetString.superclass.constructor.call(this,e),this.hT="04"},Je(ee.asn1.DEROctetString,ee.asn1.DERAbstractString),ee.asn1.DERNull=function(){ee.asn1.DERNull.superclass.constructor.call(this),this.hT="05",this.hTLV="0500"},Je(ee.asn1.DERNull,ee.asn1.ASN1Object),ee.asn1.DERObjectIdentifier=function(e){ee.asn1.DERObjectIdentifier.superclass.constructor.call(this),this.hT="06",this.setValueHex=function(e){this.hTLV=null,this.isModified=!0,this.s=null,this.hV=e},this.setValueOidString=function(e){var t=qe(e);if(null==t)throw new Error("malformed oid string: "+e);this.hTLV=null,this.isModified=!0,this.s=null,this.hV=t},this.setValueName=function(e){var t=ee.asn1.x509.OID.name2oid(e);if(""===t)throw new Error("DERObjectIdentifier oidName undefined: "+e);this.setValueOidString(t)},this.setValueNameOrOid=function(e){e.match(/^[0-2].[0-9.]+$/)?this.setValueOidString(e):this.setValueName(e)},this.getFreshValueHex=function(){return this.hV},this.setByParam=function(e){"string"===typeof e?this.setValueNameOrOid(e):void 0!==e.oid?this.setValueNameOrOid(e.oid):void 0!==e.name?this.setValueNameOrOid(e.name):void 0!==e.hex&&this.setValueHex(e.hex)},void 0!==e&&this.setByParam(e)},Je(ee.asn1.DERObjectIdentifier,ee.asn1.ASN1Object),ee.asn1.DEREnumerated=function(e){ee.asn1.DEREnumerated.superclass.constructor.call(this),this.hT="0a",this.setByBigInteger=function(e){this.hTLV=null,this.isModified=!0,this.hV=ze(e)},this.setByInteger=function(e){var t=new h(String(e),10);this.setByBigInteger(t)},this.setValueHex=function(e){this.hV=e},this.getFreshValueHex=function(){return this.hV},"undefined"!=typeof e&&("undefined"!=typeof e.int?this.setByInteger(e.int):"number"==typeof e?this.setByInteger(e):"undefined"!=typeof e.hex&&this.setValueHex(e.hex))},Je(ee.asn1.DEREnumerated,ee.asn1.ASN1Object),ee.asn1.DERUTF8String=function(e){ee.asn1.DERUTF8String.superclass.constructor.call(this,e),this.hT="0c"},Je(ee.asn1.DERUTF8String,ee.asn1.DERAbstractString),ee.asn1.DERNumericString=function(e){ee.asn1.DERNumericString.superclass.constructor.call(this,e),this.hT="12"},Je(ee.asn1.DERNumericString,ee.asn1.DERAbstractString),ee.asn1.DERPrintableString=function(e){ee.asn1.DERPrintableString.superclass.constructor.call(this,e),this.hT="13"},Je(ee.asn1.DERPrintableString,ee.asn1.DERAbstractString),ee.asn1.DERTeletexString=function(e){ee.asn1.DERTeletexString.superclass.constructor.call(this,e),this.hT="14"},Je(ee.asn1.DERTeletexString,ee.asn1.DERAbstractString),ee.asn1.DERIA5String=function(e){ee.asn1.DERIA5String.superclass.constructor.call(this,e),this.hT="16"},Je(ee.asn1.DERIA5String,ee.asn1.DERAbstractString),ee.asn1.DERVisibleString=function(e){ee.asn1.DERIA5String.superclass.constructor.call(this,e),this.hT="1a"},Je(ee.asn1.DERVisibleString,ee.asn1.DERAbstractString),ee.asn1.DERBMPString=function(e){ee.asn1.DERBMPString.superclass.constructor.call(this,e),this.hT="1e"},Je(ee.asn1.DERBMPString,ee.asn1.DERAbstractString),ee.asn1.DERUTCTime=function(e){ee.asn1.DERUTCTime.superclass.constructor.call(this,e),this.hT="17",this.params=void 0,this.getFreshValueHex=function(){var e=this.params;if(void 0==this.params&&(e={date:new Date}),"string"==typeof e){if(!e.match(/^[0-9]{12}Z$/)&&!e.match(/^[0-9]{12}\.[0-9]+Z$/))throw new Error("malformed string for UTCTime: "+e);this.hV=ae(e)}else if(void 0!=e.str)this.hV=ae(e.str);else if(void 0==e.date&&1==e.millis){var t=new Date;this.hV=ae(this.formatDate(t,"utc",!0))}else if(void 0!=e.date&&e.date instanceof Date){var n=!0===e.millis;this.hV=ae(this.formatDate(e.date,"utc",n))}else e instanceof Date&&(this.hV=ae(this.formatDate(e,"utc")));if(void 0==this.hV)throw new Error("parameter not specified properly for UTCTime");return this.hV},void 0!=e&&this.setByParam(e)},Je(ee.asn1.DERUTCTime,ee.asn1.DERAbstractTime),ee.asn1.DERGeneralizedTime=function(e){ee.asn1.DERGeneralizedTime.superclass.constructor.call(this,e),this.hT="18",this.params=e,this.getFreshValueHex=function(){var e=this.params;if(void 0==this.params&&(e={date:new Date}),"string"==typeof e){if(!e.match(/^[0-9]{14}Z$/)&&!e.match(/^[0-9]{14}\.[0-9]+Z$/))throw new Error("malformed string for GeneralizedTime: "+e);this.hV=ae(e)}else if(void 0!=e.str)this.hV=ae(e.str);else if(void 0==e.date&&1==e.millis){var t=new Date;this.hV=ae(this.formatDate(t,"gen",!0))}else if(void 0!=e.date&&e.date instanceof Date){var n=!0===e.millis;this.hV=ae(this.formatDate(e.date,"gen",n))}else e instanceof Date&&(this.hV=ae(this.formatDate(e,"gen")));if(void 0==this.hV)throw new Error("parameter not specified properly for GeneralizedTime");return this.hV},void 0!=e&&this.setByParam(e)},Je(ee.asn1.DERGeneralizedTime,ee.asn1.DERAbstractTime),ee.asn1.DERSequence=function(e){ee.asn1.DERSequence.superclass.constructor.call(this,e),this.hT="30",this.getFreshValueHex=function(){for(var e="",t=0;t<this.asn1Array.length;t++){e+=this.asn1Array[t].tohex()}return this.hV=e,this.hV}},Je(ee.asn1.DERSequence,ee.asn1.DERAbstractStructured),ee.asn1.DERSet=function(e){ee.asn1.DERSet.superclass.constructor.call(this,e),this.hT="31",this.sortFlag=!0,this.getFreshValueHex=function(){for(var e=new Array,t=0;t<this.asn1Array.length;t++){var n=this.asn1Array[t];e.push(n.tohex())}return 1==this.sortFlag&&e.sort(),this.hV=e.join(""),this.hV},"undefined"!=typeof e&&"undefined"!=typeof e.sortflag&&0==e.sortflag&&(this.sortFlag=!1)},Je(ee.asn1.DERSet,ee.asn1.DERAbstractStructured),ee.asn1.DERTaggedObject=function(e){ee.asn1.DERTaggedObject.superclass.constructor.call(this);var t=ee.asn1,n=re,r=n.getV,i=(n.isASN1HEX,t.ASN1Util.newObject);this.hT="a0",this.hV="",this.isExplicit=!0,this.asn1Object=null,this.params={tag:"a0",explicit:!0},this.setASN1Object=function(e,t,n){this.params={tag:t,explicit:e,obj:n}},this.getFreshValueHex=function(){var e=this.params;if(void 0==e.explicit&&(e.explicit=!0),void 0!=e.tage&&(e.tag=e.tage,e.explicit=!0),void 0!=e.tagi&&(e.tag=e.tagi,e.explicit=!1),void 0!=e.str)this.hV=de(e.str);else if(void 0!=e.hex)this.hV=e.hex;else{if(void 0==e.obj)throw new Error("str, hex nor obj not specified");var n;e.obj instanceof t.ASN1Object?n=e.obj.tohex():"object"==typeof e.obj&&(n=i(e.obj).tohex()),e.explicit?this.hV=n:this.hV=r(n,0)}return void 0==e.tag&&(e.tag="a0"),this.hT=e.tag,this.hTLV=null,this.isModified=!0,this.hV},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},Je(ee.asn1.DERTaggedObject,ee.asn1.ASN1Object);var ee,te,ne,re=new function(){};function ie(e){for(var t=new Array,n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}function se(e){for(var t="",n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}function oe(e){for(var t="",n=0;n<e.length;n++){var r=e[n].toString(16);1==r.length&&(r="0"+r),t+=r}return t}function ae(e){return oe(ie(e))}function ce(e){return e=(e=(e=e.replace(/\=/g,"")).replace(/\+/g,"-")).replace(/\//g,"_")}function le(e){return e.length%4==2?e+="==":e.length%4==3&&(e+="="),e=(e=e.replace(/-/g,"+")).replace(/_/g,"/")}function ue(e){return e.length%2==1&&(e="0"+e),ce(c(e))}function he(e){return l(le(e))}function de(e){return Te(Re(e)).toLowerCase()}function fe(e){try{return decodeURIComponent(ke(e))}catch(t){return null}}function pe(e){return fe(function(e){for(var t=e.match(/.{1,2}/g),n=[],r=0;r<t.length;r++){var i=parseInt(t[r],16);161<=i&&i<=191?(n.push("c2"),n.push(t[r])):192<=i&&i<=255?(n.push("c3"),n.push((i-64).toString(16))):n.push(t[r])}return n.join("")}(e))}function me(e){for(var t="",n=0;n<e.length-1;n+=2)t+=String.fromCharCode(parseInt(e.substr(n,2),16));return t}function ge(e){for(var t="",n=0;n<e.length;n++)t+=("0"+e.charCodeAt(n).toString(16)).slice(-2);return t}function ve(e){return c(e)}function ye(e,t){return e=(e=e.replace(new RegExp("(.{"+t+"})","g"),"$1\r\n")).replace(/\s+$/,"")}function be(e){return l(e.replace(/[^0-9A-Za-z\/+=]*/g,""))}function Se(e,t){return"-----BEGIN "+t+"-----\r\n"+ye(ve(e),64)+"\r\n-----END "+t+"-----\r\n"}function we(e,t){if(-1==e.indexOf("-----BEGIN "))throw new Error("can't find PEM header");return be(e=void 0!==t?(e=e.replace(new RegExp("^[^]*-----BEGIN "+t+"-----"),"")).replace(new RegExp("-----END "+t+"-----[^]*$"),""):(e=e.replace(/^[^]*-----BEGIN [^-]+-----/,"")).replace(/-----END [^-]+-----[^]*$/,""))}function Ce(e){var t,n,r,i,s,o,a,c,l,u;if(u=(e=Ee(e)).match(/^(\d{4})(\d\d)(\d\d)(\d\d)(\d\d)(\d\d)(|\.\d+)Z$/))return t=parseInt(u[1]),n=parseInt(u[2])-1,r=parseInt(u[3]),i=parseInt(u[4]),s=parseInt(u[5]),o=parseInt(u[6]),a=0,""!==(c=u[7])&&(l=(c.substr(1)+"00").substr(0,3),a=parseInt(l)),Date.UTC(t,n,r,i,s,o,a);throw new Error("unsupported zulu format: "+e)}function xe(e){return Math.round(Ce(e)/1e3)}function Ee(e){return e.match(/^[0-9]{12}Z$/)||e.match(/^[0-9]{12}[.][0-9]*Z$/)?e.match(/^[0-4]/)?"20"+e:"19"+e:e}function Te(e){return e.replace(/%/g,"")}function ke(e){return e.replace(/(..)/g,"%$1")}function Ne(e){var t="malformed IPv6 address";if(!e.match(/^[0-9A-Fa-f:]+$/))throw t;var n=(e=e.toLowerCase()).split(":").length-1;if(n<2)throw t;var r=":".repeat(7-n+2),i=(e=e.replace("::",r)).split(":");if(8!=i.length)throw t;for(var s=0;s<8;s++)i[s]=("0000"+i[s]).slice(-4);return i.join("")}function Fe(e){if(!e.match(/^[0-9A-Fa-f]{32}$/))throw new Error("malformed IPv6 address: "+e);var t=(e=e.toLowerCase()).match(/.{1,4}/g),n=(e=":"+(t=(t=t.map((function(e){return e.replace(/^0+/,"")}))).map((function(e){return""==e?"0":e}))).join(":")+":").match(/:(0:){2,}/g);if(null==n)return e.slice(1,-1);var r=n.sort().slice(-1)[0];return"::"!=(e=e.replace(r.substr(0,r.length-1),":")).substr(0,2)&&(e=e.substr(1)),"::"!=e.substr(-2,2)&&(e=e.substr(0,e.length-1)),e}function Ie(e){var t=new Error("malformed hex value");if(!e.match(/^([0-9A-Fa-f][0-9A-Fa-f]){1,}$/))throw t;if(8==e.length){try{return parseInt(e.substr(0,2),16)+"."+parseInt(e.substr(2,2),16)+"."+parseInt(e.substr(4,2),16)+"."+parseInt(e.substr(6,2),16)}catch(n){throw t}}else{if(16!=e.length){if(32==e.length)return Fe(e);if(64==e.length){try{return Fe(e.substr(0,32))+"/"+Ae(e.substr(32))}catch(n){throw t}return}return e}try{return Ie(e.substr(0,8))+"/"+Ae(e.substr(8))}catch(n){throw t}}}function Ae(e){var t,n=new Error("malformed mask");try{t=new h(e,16).toString(2)}catch(r){throw n}if(!t.match(/^1*0*$/))throw n;return t.replace(/0+$/,"").length}function De(e){var t=new Error("malformed IP address");if(!(e=e.toLowerCase(e)).match(/^[0-9a-f.:/]+$/))throw t;if(!e.match(/^[0-9.]+$/)){var n;if(e.match(/^[0-9.]+\/[0-9]+$/))return De((n=e.split("/"))[0])+Oe(parseInt(n[1]),32);if(e.match(/^[0-9a-f:]+$/)&&-1!==e.indexOf(":"))return Ne(e);if(e.match(/^[0-9a-f:]+\/[0-9]+$/)&&-1!==e.indexOf(":"))return Ne((n=e.split("/"))[0])+Oe(parseInt(n[1]),128);throw t}var r=e.split(".");if(4!==r.length)throw t;var i="";try{for(var s=0;s<4;s++){i+=("0"+parseInt(r[s]).toString(16)).slice(-2)}return i}catch(o){throw t}}function Oe(e,t){return 32==t&&0==e?"00000000":128==t&&0==e?"00000000000000000000000000000000":new h(Array(e+1).join("1")+Array(t-e+1).join("0"),2).toString(16)}function Pe(e){return e.match(/.{4}/g).map((function(e){var t=parseInt(e.substr(0,2),16),n=parseInt(e.substr(2),16);if(0==t&n<128)return String.fromCharCode(n);if(t<8){var r=128|63&n;return fe((192|(7&t)<<3|(192&n)>>6).toString(16)+r.toString(16))}r=128|(15&t)<<2|(192&n)>>6;var i=128|63&n;return fe((224|(240&t)>>4).toString(16)+r.toString(16)+i.toString(16))})).join("")}function Re(e){for(var t=encodeURIComponent(e),n="",r=0;r<t.length;r++)"%"==t[r]?(n+=t.substr(r,3),r+=2):n=n+"%"+ae(t[r]);return n}function Me(e){return!(e.length%2!=0||!e.match(/^[0-9a-f]+$/)&&!e.match(/^[0-9A-F]+$/))}function Be(e){return!!e.match(/^[0-9A-Za-z-_.]+$/)}function Le(e){return e.length%2==1?"0"+e:e.substr(0,1)>"7"?"00"+e:e}re.getLblen=function(e,t){if("8"!=e.substr(t+2,1))return 1;var n=parseInt(e.substr(t+3,1));return 0==n?-1:0<n&&n<10?n+1:-2},re.getL=function(e,t){var n=re.getLblen(e,t);return n<1?"":e.substr(t+2,2*n)},re.getVblen=function(e,t){var n;return""==(n=re.getL(e,t))?-1:("8"===n.substr(0,1)?new h(n.substr(2),16):new h(n,16)).intValue()},re.getVidx=function(e,t){var n=re.getLblen(e,t);return n<0?n:t+2*(n+1)},re.getV=function(e,t){var n=re.getVidx(e,t),r=re.getVblen(e,t);return e.substr(n,2*r)},re.getTLV=function(e,t){return e.substr(t,2)+re.getL(e,t)+re.getV(e,t)},re.getTLVblen=function(e,t){return 2+2*re.getLblen(e,t)+2*re.getVblen(e,t)},re.getNextSiblingIdx=function(e,t){return re.getVidx(e,t)+2*re.getVblen(e,t)},re.getChildIdx=function(e,t){var n,r,i,s=re,o=[];n=s.getVidx(e,t),r=2*s.getVblen(e,t),"03"==e.substr(t,2)&&(n+=2,r-=2),i=0;for(var a=n;i<=r;){var c=s.getTLVblen(e,a);if((i+=c)<=r&&o.push(a),a+=c,i>=r)break}return o},re.getNthChildIdx=function(e,t,n){return re.getChildIdx(e,t)[n]},re.getIdxbyList=function(e,t,n,r){var i,s,o=re;return 0==n.length?void 0!==r&&e.substr(t,2)!==r?-1:t:(i=n.shift())>=(s=o.getChildIdx(e,t)).length?-1:o.getIdxbyList(e,s[i],n,r)},re.getIdxbyListEx=function(e,t,n,r){var i,s,o=re;if(0==n.length)return void 0!==r&&e.substr(t,2)!==r?-1:t;i=n.shift(),s=o.getChildIdx(e,t);for(var a=0,c=0;c<s.length;c++){var l=e.substr(s[c],2);if("number"==typeof i&&!o.isContextTag(l)&&a==i||"string"==typeof i&&o.isContextTag(l,i))return o.getIdxbyListEx(e,s[c],n,r);o.isContextTag(l)||a++}return-1},re.getTLVbyList=function(e,t,n,r){var i=re,s=i.getIdxbyList(e,t,n,r);return-1==s||s>=e.length?null:i.getTLV(e,s)},re.getTLVbyListEx=function(e,t,n,r){var i=re,s=i.getIdxbyListEx(e,t,n,r);return-1==s?null:i.getTLV(e,s)},re.getVbyList=function(e,t,n,r,i){var s,o,a=re;return-1==(s=a.getIdxbyList(e,t,n,r))||s>=e.length?null:(o=a.getV(e,s),!0===i&&(o=o.substr(2)),o)},re.getVbyListEx=function(e,t,n,r,i){var s,o,a=re;return-1==(s=a.getIdxbyListEx(e,t,n,r))?null:(o=a.getV(e,s),"03"==e.substr(s,2)&&!1!==i&&(o=o.substr(2)),o)},re.getInt=function(e,t,n){void 0==n&&(n=-1);try{var r=e.substr(t,2);if("02"!=r&&"03"!=r)return n;var i=re.getV(e,t);return"02"==r?parseInt(i,16):He(i)}catch(s){return n}},re.getOID=function(e,t,n){void 0==n&&(n=null);try{return"06"!=e.substr(t,2)?n:_e(re.getV(e,t))}catch(r){return n}},re.getOIDName=function(e,t,n){void 0==n&&(n=null);try{var r=re.getOID(e,t,n);if(r==n)return n;var i=ee.asn1.x509.OID.oid2name(r);return""==i?r:i}catch(s){return n}},re.getString=function(e,t,n){void 0==n&&(n=null);try{return me(re.getV(e,t))}catch(r){return n}},re.hextooidstr=function(e){var t=function(e,t){return e.length>=t?e:new Array(t-e.length+1).join("0")+e},n=[],r=e.substr(0,2),i=parseInt(r,16);n[0]=new String(Math.floor(i/40)),n[1]=new String(i%40);for(var s=e.substr(2),o=[],a=0;a<s.length/2;a++)o.push(parseInt(s.substr(2*a,2),16));var c=[],l="";for(a=0;a<o.length;a++)128&o[a]?l+=t((127&o[a]).toString(2),7):(l+=t((127&o[a]).toString(2),7),c.push(new String(parseInt(l,2))),l="");var u=n.join(".");return c.length>0&&(u=u+"."+c.join(".")),u},re.dump=function(e,t,n,r){var i=re,s=i.getV,o=i.dump,a=i.getChildIdx,c=e;e instanceof ee.asn1.ASN1Object&&(c=e.tohex());var l=function(e,t){return e.length<=2*t?e:e.substr(0,t)+"..(total "+e.length/2+"bytes).."+e.substr(e.length-t,t)};void 0===t&&(t={ommit_long_octet:32}),void 0===n&&(n=0),void 0===r&&(r="");var u,h=t.ommit_long_octet;if("01"==(u=c.substr(n,2)))return"00"==(d=s(c,n))?r+"BOOLEAN FALSE\n":r+"BOOLEAN TRUE\n";if("02"==u)return r+"INTEGER "+l(d=s(c,n),h)+"\n";if("03"==u){var d=s(c,n);if(i.isASN1HEX(d.substr(2))){var f=r+"BITSTRING, encapsulates\n";return f+=o(d.substr(2),t,0,r+"  ")}return r+"BITSTRING "+l(d,h)+"\n"}if("04"==u){d=s(c,n);if(i.isASN1HEX(d)){f=r+"OCTETSTRING, encapsulates\n";return f+=o(d,t,0,r+"  ")}return r+"OCTETSTRING "+l(d,h)+"\n"}if("05"==u)return r+"NULL\n";if("06"==u){var p=s(c,n),m=ee.asn1.ASN1Util.oidHexToInt(p),g=ee.asn1.x509.OID.oid2name(m),v=m.replace(/\./g," ");return""!=g?r+"ObjectIdentifier "+g+" ("+v+")\n":r+"ObjectIdentifier ("+v+")\n"}if("0a"==u)return r+"ENUMERATED "+parseInt(s(c,n))+"\n";if("0c"==u)return r+"UTF8String '"+fe(s(c,n))+"'\n";if("13"==u)return r+"PrintableString '"+fe(s(c,n))+"'\n";if("14"==u)return r+"TeletexString '"+fe(s(c,n))+"'\n";if("16"==u)return r+"IA5String '"+fe(s(c,n))+"'\n";if("17"==u)return r+"UTCTime "+fe(s(c,n))+"\n";if("18"==u)return r+"GeneralizedTime "+fe(s(c,n))+"\n";if("1a"==u)return r+"VisualString '"+fe(s(c,n))+"'\n";if("1e"==u)return r+"BMPString '"+Pe(s(c,n))+"'\n";if("30"==u){if("3000"==c.substr(n,4))return r+"SEQUENCE {}\n";f=r+"SEQUENCE\n";var y=t;if((2==(w=a(c,n)).length||3==w.length)&&"06"==c.substr(w[0],2)&&"04"==c.substr(w[w.length-1],2)){g=i.oidname(s(c,w[0]));var b=JSON.parse(JSON.stringify(t));b.x509ExtName=g,y=b}for(var S=0;S<w.length;S++)f+=o(c,y,w[S],r+"  ");return f}if("31"==u){f=r+"SET\n";var w=a(c,n);for(S=0;S<w.length;S++)f+=o(c,t,w[S],r+"  ");return f}if(0!=(128&(u=parseInt(u,16)))){var C=31&u;if(0!=(32&u)){for(f=r+"["+C+"]\n",w=a(c,n),S=0;S<w.length;S++)f+=o(c,t,w[S],r+"  ");return f}d=s(c,n);if(re.isASN1HEX(d)){var f=r+"["+C+"]\n";return f+=o(d,t,0,r+"  ")}return("68747470"==d.substr(0,8)||"subjectAltName"===t.x509ExtName&&2==C)&&(d=fe(d)),f=r+"["+C+"] "+d+"\n"}return r+"UNKNOWN("+u+") "+s(c,n)+"\n"},re.parse=function(e){var t=re,n=t.parse,r=t.isASN1HEX,i=t.getV,s=t.getTLV,o=t.getChildIdx,a=ee.asn1,c=a.ASN1Util.oidHexToInt,l=a.x509.OID.oid2name,u=fe,h=Pe,d=pe,f={"0c":"utf8str",12:"numstr",13:"prnstr",14:"telstr",16:"ia5str",17:"utctime",18:"gentime","1a":"visstr","1e":"bmpstr",30:"seq",31:"set"},p=e.substr(0,2),m={},g=i(e,0);if("01"==p)return"0101ff"==e?{bool:!0}:{bool:!1};if("02"==p)return{int:{hex:g}};if("03"==p)try{if("00"!=g.substr(0,2))throw"not encap";var v=g.substr(2);if(!r(v))throw"not encap";return{bitstr:{obj:n(v)}}}catch(H){var y=null;return g.length<=10&&(y=Ke(g)),null==y?{bitstr:{hex:g}}:{bitstr:{bin:y}}}else if("04"==p)try{if(!r(g))throw"not encap";return{octstr:{obj:n(g)}}}catch(H){return{octstr:{hex:g}}}else{if("05"==p)return{null:""};if("06"==p){var b=c(g),S=l(b);return""==S?{oid:b}:{oid:S}}if("0a"==p)return g.length>4?{enum:{hex:g}}:{enum:parseInt(g,16)};if("30"==p||"31"==p)return m[f[p]]=function(e){for(var t=[],r=o(e,0),i=0;i<r.length;i++){var a=r[i],c=s(e,a),l=n(c);t.push(l)}return t}(e),m;if("14"==p){var w=d(g);return m[f[p]]={str:w},m}if("1e"==p){w=h(g);return m[f[p]]={str:w},m}if(-1!=":0c:12:13:16:17:18:1a:".indexOf(p)){w=u(g);return m[f[p]]={str:w},m}if(p.match(/^8[0-9]$/))return null==(w=u(g))|""==w||null!=w.match(/[\x00-\x1F\x7F-\x9F]/)||null!=w.match(/[\u0000-\u001F\u0080\u2013\u009F]/)?{tag:{tag:p,explicit:!1,hex:g}}:{tag:{tag:p,explicit:!1,str:w}};if(!p.match(/^a[0-9]$/)){var C=new ee.asn1.ASN1Object;return C.hV=g,{asn1:{tlv:p+C.getLengthHexFromValue()+g}}}try{if(!r(g))throw new Error("not encap");return{tag:{tag:p,explicit:!0,obj:n(g)}}}catch(H){return{tag:{tag:p,explicit:!0,hex:g}}}}},re.isContextTag=function(e,t){var n,r;e=e.toLowerCase();try{n=parseInt(e,16)}catch(i){return-1}if(void 0===t)return 128==(192&n);try{return null!=t.match(/^\[[0-9]+\]$/)&&(!((r=parseInt(t.substr(1,t.length-1),10))>31)&&(128==(192&n)&&(31&n)==r))}catch(i){return!1}},re.isASN1HEX=function(e){var t=re;if(e.length%2==1)return!1;var n=t.getVblen(e,0),r=e.substr(0,2),i=t.getL(e,0);return e.length-r.length-i.length==2*n},re.checkStrictDER=function(e,t,n,r,i){var s=re;if(void 0===n){if("string"!=typeof e)throw new Error("not hex string");if(e=e.toLowerCase(),!ee.lang.String.isHex(e))throw new Error("not hex string");n=e.length,i=(r=e.length/2)<128?1:Math.ceil(r.toString(16))+1}if(s.getL(e,t).length>2*i)throw new Error("L of TLV too long: idx="+t);var o=s.getVblen(e,t);if(o>r)throw new Error("value of L too long than hex: idx="+t);var a=s.getTLV(e,t),c=a.length-2-s.getL(e,t).length;if(c!==2*o)throw new Error("V string length and L's value not the same:"+c+"/"+2*o);if(0===t&&e.length!=a.length)throw new Error("total length and TLV length unmatch:"+e.length+"!="+a.length);var l=e.substr(t,2);if("02"===l){var u=s.getVidx(e,t);if("00"==e.substr(u,2)&&e.charCodeAt(u+2)<56)throw new Error("not least zeros for DER INTEGER")}if(32&parseInt(l,16)){for(var h=s.getVblen(e,t),d=0,f=s.getChildIdx(e,t),p=0;p<f.length;p++){d+=s.getTLV(e,f[p]).length,s.checkStrictDER(e,f[p],n,r,i)}if(2*h!=d)throw new Error("sum of children's TLV length and L unmatch: "+2*h+"!="+d)}},re.oidname=function(e){var t=ee.asn1;ee.lang.String.isHex(e)&&(e=t.ASN1Util.oidHexToInt(e));var n=t.x509.OID.oid2name(e);return""===n&&(n=e),n},"undefined"!=typeof ee&&ee||(ee={}),"undefined"!=typeof ee.asn1&&ee.asn1||(ee.asn1={}),"undefined"!=typeof ee.asn1.x509&&ee.asn1.x509||(ee.asn1.x509={}),ee.asn1.x509.Certificate=function(e){ee.asn1.x509.Certificate.superclass.constructor.call(this);var t=ee.asn1,n=t.DERBitString,r=t.DERSequence,i=t.x509,s=i.TBSCertificate,o=i.AlgorithmIdentifier;this.params=void 0,this.setByParam=function(e){this.params=e},this.sign=function(){var e=this.params,t=e.sigalg;void 0!=e.sigalg.name&&(t=e.sigalg.name);var n=e.tbsobj.tohex(),r=new ee.crypto.Signature({alg:t});r.init(e.cakey),r.updateHex(n),e.sighex=r.sign()},this.getPEM=function(){return Se(this.tohex(),"CERTIFICATE")},this.tohex=function(){var e=this.params;if(void 0!=e.tbsobj&&null!=e.tbsobj||(e.tbsobj=new s(e)),void 0==e.sighex&&void 0!=e.cakey&&this.sign(),void 0==e.sighex)throw new Error("sighex or cakey parameter not defined");var t=[];return t.push(e.tbsobj),t.push(new o({name:e.sigalg})),t.push(new n({hex:"00"+e.sighex})),new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&(this.params=e)},Je(ee.asn1.x509.Certificate,ee.asn1.ASN1Object),ee.asn1.x509.TBSCertificate=function(e){ee.asn1.x509.TBSCertificate.superclass.constructor.call(this);var t=ee.asn1,n=t.x509,r=t.DERTaggedObject,i=t.DERInteger,s=t.DERSequence,o=n.AlgorithmIdentifier,a=n.Time,c=n.X500Name,l=n.Extensions,u=n.SubjectPublicKeyInfo;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=[],t=this.params;if(void 0!=t.version||1!=t.version){var n=2;void 0!=t.version&&(n=t.version-1);var h=new r({obj:new i({int:n})});e.push(h)}return e.push(new i(t.serial)),e.push(new o({name:t.sigalg})),e.push(new c(t.issuer)),e.push(new s({array:[new a(t.notbefore),new a(t.notafter)]})),e.push(new c(t.subject)),e.push(new u(Ze.getKey(t.sbjpubkey))),void 0!==t.ext&&t.ext.length>0&&e.push(new r({tag:"a3",obj:new l(t.ext)})),new ee.asn1.DERSequence({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Je(ee.asn1.x509.TBSCertificate,ee.asn1.ASN1Object),ee.asn1.x509.Extensions=function(e){ee.asn1.x509.Extensions.superclass.constructor.call(this);var t=ee.asn1,n=t.DERSequence,r=t.x509;this.aParam=[],this.setByParam=function(e){this.aParam=e},this.tohex=function(){for(var e=[],t=0;t<this.aParam.length;t++){var i=this.aParam[t],s=i.extname,o=null;if(void 0!=i.extn)o=new r.PrivateExtension(i);else if("subjectKeyIdentifier"==s)o=new r.SubjectKeyIdentifier(i);else if("keyUsage"==s)o=new r.KeyUsage(i);else if("subjectAltName"==s)o=new r.SubjectAltName(i);else if("issuerAltName"==s)o=new r.IssuerAltName(i);else if("basicConstraints"==s)o=new r.BasicConstraints(i);else if("nameConstraints"==s)o=new r.NameConstraints(i);else if("cRLDistributionPoints"==s)o=new r.CRLDistributionPoints(i);else if("certificatePolicies"==s)o=new r.CertificatePolicies(i);else if("policyMappings"==s)o=new r.PolicyMappings(i);else if("policyConstraints"==s)o=new r.PolicyConstraints(i);else if("inhibitAnyPolicy"==s)o=new r.InhibitAnyPolicy(i);else if("authorityKeyIdentifier"==s)o=new r.AuthorityKeyIdentifier(i);else if("extKeyUsage"==s)o=new r.ExtKeyUsage(i);else if("authorityInfoAccess"==s)o=new r.AuthorityInfoAccess(i);else if("cRLNumber"==s)o=new r.CRLNumber(i);else if("cRLReason"==s)o=new r.CRLReason(i);else if("ocspNonce"==s)o=new r.OCSPNonce(i);else if("ocspNoCheck"==s)o=new r.OCSPNoCheck(i);else if("adobeTimeStamp"==s)o=new r.AdobeTimeStamp(i);else{if("subjectDirectoryAttributes"!=s)throw new Error("extension not supported:"+JSON.stringify(i));o=new r.SubjectDirectoryAttributes(i)}null!=o&&e.push(o)}return new n({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.x509.Extensions,ee.asn1.ASN1Object),ee.asn1.x509.Extension=function(e){ee.asn1.x509.Extension.superclass.constructor.call(this);var t=ee.asn1,n=t.DERObjectIdentifier,r=t.DEROctetString,i=(t.DERBitString,t.DERBoolean),s=t.DERSequence;this.tohex=function(){var e=new n({oid:this.oid}),t=new r({hex:this.getExtnValueHex()}),o=new Array;return o.push(e),this.critical&&o.push(new i),o.push(t),new s({array:o}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.critical=!1,void 0!==e&&void 0!==e.critical&&(this.critical=e.critical)},Je(ee.asn1.x509.Extension,ee.asn1.ASN1Object),ee.asn1.x509.KeyUsage=function(e){ee.asn1.x509.KeyUsage.superclass.constructor.call(this,e);var t=Error,n={digitalSignature:0,nonRepudiation:1,keyEncipherment:2,dataEncipherment:3,keyAgreement:4,keyCertSign:5,cRLSign:6,encipherOnly:7,decipherOnly:8};this.getExtnValueHex=function(){var e=this.getBinValue();return this.asn1ExtnValue=new ee.asn1.DERBitString({bin:e}),this.asn1ExtnValue.tohex()},this.getBinValue=function(){var e=this.params;if("object"!=typeof e||"object"!=typeof e.names&&"string"!=typeof e.bin)throw new t("parameter not yet set");if(void 0!=e.names)return Ge(e.names,n);if(void 0!=e.bin)return e.bin;throw new t("parameter not set properly")},this.oid="2.5.29.15",void 0!==e&&(this.params=e)},Je(ee.asn1.x509.KeyUsage,ee.asn1.x509.Extension),ee.asn1.x509.BasicConstraints=function(e){ee.asn1.x509.BasicConstraints.superclass.constructor.call(this,e);var t=ee.asn1,n=t.DERBoolean,r=t.DERInteger,i=t.DERSequence;this.getExtnValueHex=function(){var e=new Array;this.cA&&e.push(new n),this.pathLen>-1&&e.push(new r({int:this.pathLen}));var t=new i({array:e});return this.asn1ExtnValue=t,this.asn1ExtnValue.tohex()},this.oid="2.5.29.19",this.cA=!1,this.pathLen=-1,void 0!==e&&(void 0!==e.cA&&(this.cA=e.cA),void 0!==e.pathLen&&(this.pathLen=e.pathLen))},Je(ee.asn1.x509.BasicConstraints,ee.asn1.x509.Extension),ee.asn1.x509.CRLDistributionPoints=function(e){ee.asn1.x509.CRLDistributionPoints.superclass.constructor.call(this,e);var t=ee.asn1,n=t.x509;this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.setByDPArray=function(e){for(var r=[],i=0;i<e.length;i++)if(e[i]instanceof ee.asn1.ASN1Object)r.push(e[i]);else{var s=new n.DistributionPoint(e[i]);r.push(s)}this.asn1ExtnValue=new t.DERSequence({array:r})},this.setByOneURI=function(e){var t=new n.DistributionPoint({fulluri:e});this.setByDPArray([t])},this.oid="2.5.29.31",void 0!==e&&(void 0!==e.array?this.setByDPArray(e.array):void 0!==e.uri&&this.setByOneURI(e.uri))},Je(ee.asn1.x509.CRLDistributionPoints,ee.asn1.x509.Extension),ee.asn1.x509.DistributionPoint=function(e){ee.asn1.x509.DistributionPoint.superclass.constructor.call(this);var t=ee.asn1,n=t.x509.DistributionPointName;this.tohex=function(){var e=new t.DERSequence;if(null!=this.asn1DP){var n=new t.DERTaggedObject({explicit:!0,tag:"a0",obj:this.asn1DP});e.appendASN1Object(n)}return this.hTLV=e.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.dpobj?this.asn1DP=e.dpobj:void 0!==e.dpname?this.asn1DP=new n(e.dpname):void 0!==e.fulluri&&(this.asn1DP=new n({full:[{uri:e.fulluri}]})))},Je(ee.asn1.x509.DistributionPoint,ee.asn1.ASN1Object),ee.asn1.x509.DistributionPointName=function(e){ee.asn1.x509.DistributionPointName.superclass.constructor.call(this);var t=ee.asn1,n=t.DERTaggedObject;if(this.tohex=function(){if("full"!=this.type)throw new Error("currently type shall be 'full': "+this.type);return this.asn1Obj=new n({explicit:!1,tag:this.tag,obj:this.asn1V}),this.hTLV=this.asn1Obj.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e)if(t.x509.GeneralNames.prototype.isPrototypeOf(e))this.type="full",this.tag="a0",this.asn1V=e;else{if(void 0===e.full)throw new Error("This class supports GeneralNames only as argument");this.type="full",this.tag="a0",this.asn1V=new t.x509.GeneralNames(e.full)}},Je(ee.asn1.x509.DistributionPointName,ee.asn1.ASN1Object),ee.asn1.x509.CertificatePolicies=function(e){ee.asn1.x509.CertificatePolicies.superclass.constructor.call(this,e);var t=ee.asn1,n=t.x509,r=t.DERSequence,i=n.PolicyInformation;this.params=null,this.getExtnValueHex=function(){for(var e=[],t=0;t<this.params.array.length;t++)e.push(new i(this.params.array[t]));var n=new r({array:e});return this.asn1ExtnValue=n,this.asn1ExtnValue.tohex()},this.oid="2.5.29.32",void 0!==e&&(this.params=e)},Je(ee.asn1.x509.CertificatePolicies,ee.asn1.x509.Extension),ee.asn1.x509.PolicyInformation=function(e){ee.asn1.x509.PolicyInformation.superclass.constructor.call(this,e);var t=ee.asn1,n=t.DERSequence,r=t.DERObjectIdentifier,i=t.x509.PolicyQualifierInfo;this.params=null,this.tohex=function(){if(void 0===this.params.policyoid&&void 0===this.params.array)throw new Error("parameter oid and array missing");var e=[new r(this.params.policyoid)];if(void 0!==this.params.array){for(var t=[],s=0;s<this.params.array.length;s++)t.push(new i(this.params.array[s]));t.length>0&&e.push(new n({array:t}))}return new n({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},Je(ee.asn1.x509.PolicyInformation,ee.asn1.ASN1Object),ee.asn1.x509.PolicyQualifierInfo=function(e){ee.asn1.x509.PolicyQualifierInfo.superclass.constructor.call(this,e);var t=ee.asn1,n=t.DERSequence,r=t.DERIA5String,i=t.DERObjectIdentifier,s=t.x509.UserNotice;this.params=null,this.tohex=function(){return void 0!==this.params.cps?new n({array:[new i({oid:"1.3.6.1.5.5.7.2.1"}),new r({str:this.params.cps})]}).tohex():void 0!=this.params.unotice?new n({array:[new i({oid:"1.3.6.1.5.5.7.2.2"}),new s(this.params.unotice)]}).tohex():void 0},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},Je(ee.asn1.x509.PolicyQualifierInfo,ee.asn1.ASN1Object),ee.asn1.x509.UserNotice=function(e){ee.asn1.x509.UserNotice.superclass.constructor.call(this,e);var t=ee.asn1.DERSequence,n=(ee.asn1.DERInteger,ee.asn1.x509.DisplayText),r=ee.asn1.x509.NoticeReference;this.params=null,this.tohex=function(){var e=[];return void 0!==this.params.noticeref&&e.push(new r(this.params.noticeref)),void 0!==this.params.exptext&&e.push(new n(this.params.exptext)),new t({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},Je(ee.asn1.x509.UserNotice,ee.asn1.ASN1Object),ee.asn1.x509.NoticeReference=function(e){ee.asn1.x509.NoticeReference.superclass.constructor.call(this,e);var t=ee.asn1.DERSequence,n=ee.asn1.DERInteger,r=ee.asn1.x509.DisplayText;this.params=null,this.tohex=function(){var e=[];if(void 0!==this.params.org&&e.push(new r(this.params.org)),void 0!==this.params.noticenum){for(var i=[],s=this.params.noticenum,o=0;o<s.length;o++)i.push(new n(s[o]));e.push(new t({array:i}))}if(0==e.length)throw new Error("parameter is empty");return new t({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(this.params=e)},Je(ee.asn1.x509.NoticeReference,ee.asn1.ASN1Object),ee.asn1.x509.DisplayText=function(e){ee.asn1.x509.DisplayText.superclass.constructor.call(this,e),this.hT="0c",void 0!==e&&("ia5"===e.type?this.hT="16":"vis"===e.type?this.hT="1a":"bmp"===e.type&&(this.hT="1e"))},Je(ee.asn1.x509.DisplayText,ee.asn1.DERAbstractString),ee.asn1.x509.PolicyMappings=function(e){ee.asn1.x509.PolicyMappings.superclass.constructor.call(this,e);var t=ee.asn1,n=(t.x509,t.ASN1Util.newObject);this.params=null,this.getExtnValueHex=function(){for(var e=this.params,t=[],r=0;r<e.array.length;r++){var i=e.array[r];t.push({seq:[{oid:i[0]},{oid:i[1]}]})}return this.asn1ExtnValue=n({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.33",void 0!==e&&(this.params=e)},Je(ee.asn1.x509.PolicyMappings,ee.asn1.x509.Extension),ee.asn1.x509.PolicyConstraints=function(e){ee.asn1.x509.PolicyConstraints.superclass.constructor.call(this,e);var t=ee.asn1,n=(t.x509,t.ASN1Util.newObject);this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[];return void 0!=e.reqexp&&t.push({tag:{tagi:"80",obj:{int:e.reqexp}}}),void 0!=e.inhibit&&t.push({tag:{tagi:"81",obj:{int:e.inhibit}}}),this.asn1ExtnValue=n({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.36",void 0!==e&&(this.params=e)},Je(ee.asn1.x509.PolicyConstraints,ee.asn1.x509.Extension),ee.asn1.x509.InhibitAnyPolicy=function(e){ee.asn1.x509.InhibitAnyPolicy.superclass.constructor.call(this,e);var t=ee.asn1,n=(t.x509,t.ASN1Util.newObject);this.params=null,this.getExtnValueHex=function(){return this.asn1ExtnValue=n({int:this.params.skip}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.54",void 0!==e&&(this.params=e)},Je(ee.asn1.x509.InhibitAnyPolicy,ee.asn1.x509.Extension),ee.asn1.x509.NameConstraints=function(e){ee.asn1.x509.NameConstraints.superclass.constructor.call(this,e);var t=ee.asn1,n=t.x509,r=t.ASN1Util.newObject,i=n.GeneralSubtree;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[];if(void 0!=e.permit&&void 0!=e.permit.length){for(var n=[],s=0;s<e.permit.length;s++)n.push(new i(e.permit[s]));t.push({tag:{tagi:"a0",obj:{seq:n}}})}if(void 0!=e.exclude&&void 0!=e.exclude.length){var o=[];for(s=0;s<e.exclude.length;s++)o.push(new i(e.exclude[s]));t.push({tag:{tagi:"a1",obj:{seq:o}}})}return this.asn1ExtnValue=r({seq:t}),this.asn1ExtnValue.tohex()},this.oid="2.5.29.30",void 0!==e&&(this.params=e)},Je(ee.asn1.x509.NameConstraints,ee.asn1.x509.Extension),ee.asn1.x509.GeneralSubtree=function(e){ee.asn1.x509.GeneralSubtree.superclass.constructor.call(this);var t=ee.asn1,n=t.x509.GeneralName,r=t.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params,t=[new n(e)];return void 0!=e.min&&t.push({tag:{tagi:"80",obj:{int:e.min}}}),void 0!=e.max&&t.push({tag:{tagi:"81",obj:{int:e.max}}}),r({seq:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Je(ee.asn1.x509.GeneralSubtree,ee.asn1.ASN1Object),ee.asn1.x509.ExtKeyUsage=function(e){ee.asn1.x509.ExtKeyUsage.superclass.constructor.call(this,e);var t=ee.asn1;this.setPurposeArray=function(e){this.asn1ExtnValue=new t.DERSequence;for(var n=0;n<e.length;n++){var r=new t.DERObjectIdentifier(e[n]);this.asn1ExtnValue.appendASN1Object(r)}},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.37",void 0!==e&&void 0!==e.array&&this.setPurposeArray(e.array)},Je(ee.asn1.x509.ExtKeyUsage,ee.asn1.x509.Extension),ee.asn1.x509.AuthorityKeyIdentifier=function(e){ee.asn1.x509.AuthorityKeyIdentifier.superclass.constructor.call(this,e);var t=ee,n=t.asn1,r=n.DERTaggedObject,i=n.x509.GeneralNames;t.crypto.Util.isKey;this.asn1KID=null,this.asn1CertIssuer=null,this.asn1CertSN=null,this.getExtnValueHex=function(){var e=new Array;this.asn1KID&&e.push(new r({explicit:!1,tag:"80",obj:this.asn1KID})),this.asn1CertIssuer&&e.push(new r({explicit:!1,tag:"a1",obj:new i([{dn:this.asn1CertIssuer}])})),this.asn1CertSN&&e.push(new r({explicit:!1,tag:"82",obj:this.asn1CertSN}));var t=new n.DERSequence({array:e});return this.asn1ExtnValue=t,this.asn1ExtnValue.tohex()},this.setKIDByParam=function(e){if(void 0!==e.str||void 0!==e.hex)this.asn1KID=new ee.asn1.DEROctetString(e);else if("object"===typeof e&&ee.crypto.Util.isKey(e)||"string"===typeof e&&-1!=e.indexOf("BEGIN ")){var t=e;"string"===typeof e&&(t=Ze.getKey(e));var n=Ze.getKeyID(t);this.asn1KID=new ee.asn1.DEROctetString({hex:n})}},this.setCertIssuerByParam=function(e){void 0!==e.str||void 0!==e.ldapstr||void 0!==e.hex||void 0!==e.certsubject||void 0!==e.certissuer?this.asn1CertIssuer=new ee.asn1.x509.X500Name(e):"string"===typeof e&&-1!=e.indexOf("BEGIN ")&&-1!=e.indexOf("CERTIFICATE")&&(this.asn1CertIssuer=new ee.asn1.x509.X500Name({certissuer:e}))},this.setCertSNByParam=function(e){if(void 0!==e.str||void 0!==e.bigint||void 0!==e.hex)this.asn1CertSN=new ee.asn1.DERInteger(e);else if("string"===typeof e&&-1!=e.indexOf("BEGIN ")&&e.indexOf("CERTIFICATE")){var t=new Ye;t.readCertPEM(e);var n=t.getSerialNumberHex();this.asn1CertSN=new ee.asn1.DERInteger({hex:n})}},this.oid="2.5.29.35",void 0!==e&&(void 0!==e.kid&&this.setKIDByParam(e.kid),void 0!==e.issuer&&this.setCertIssuerByParam(e.issuer),void 0!==e.sn&&this.setCertSNByParam(e.sn),void 0!==e.issuersn&&"string"===typeof e.issuersn&&-1!=e.issuersn.indexOf("BEGIN ")&&e.issuersn.indexOf("CERTIFICATE")&&(this.setCertSNByParam(e.issuersn),this.setCertIssuerByParam(e.issuersn)))},Je(ee.asn1.x509.AuthorityKeyIdentifier,ee.asn1.x509.Extension),ee.asn1.x509.SubjectKeyIdentifier=function(e){ee.asn1.x509.SubjectKeyIdentifier.superclass.constructor.call(this,e);var t=ee.asn1.DEROctetString;this.asn1KID=null,this.getExtnValueHex=function(){return this.asn1ExtnValue=this.asn1KID,this.asn1ExtnValue.tohex()},this.setKIDByParam=function(e){if(void 0!==e.str||void 0!==e.hex)this.asn1KID=new t(e);else if("object"===typeof e&&ee.crypto.Util.isKey(e)||"string"===typeof e&&-1!=e.indexOf("BEGIN")){var n=e;"string"===typeof e&&(n=Ze.getKey(e));var r=Ze.getKeyID(n);this.asn1KID=new ee.asn1.DEROctetString({hex:r})}},this.oid="2.5.29.14",void 0!==e&&void 0!==e.kid&&this.setKIDByParam(e.kid)},Je(ee.asn1.x509.SubjectKeyIdentifier,ee.asn1.x509.Extension),ee.asn1.x509.AuthorityInfoAccess=function(e){ee.asn1.x509.AuthorityInfoAccess.superclass.constructor.call(this,e),this.setAccessDescriptionArray=function(e){for(var t=new Array,n=ee.asn1,r=n.DERSequence,i=n.DERObjectIdentifier,s=n.x509.GeneralName,o=0;o<e.length;o++){var a,c=e[o];if(void 0!==c.ocsp)a=new r({array:[new i({oid:"1.3.6.1.5.5.7.48.1"}),new s({uri:c.ocsp})]});else{if(void 0===c.caissuer)throw new Error("unknown AccessMethod parameter: "+JSON.stringify(c));a=new r({array:[new i({oid:"1.3.6.1.5.5.7.48.2"}),new s({uri:c.caissuer})]})}t.push(a)}this.asn1ExtnValue=new r({array:t})},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.1.1",void 0!==e&&void 0!==e.array&&this.setAccessDescriptionArray(e.array)},Je(ee.asn1.x509.AuthorityInfoAccess,ee.asn1.x509.Extension),ee.asn1.x509.SubjectAltName=function(e){ee.asn1.x509.SubjectAltName.superclass.constructor.call(this,e),this.setNameArray=function(e){this.asn1ExtnValue=new ee.asn1.x509.GeneralNames(e)},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.17",void 0!==e&&void 0!==e.array&&this.setNameArray(e.array)},Je(ee.asn1.x509.SubjectAltName,ee.asn1.x509.Extension),ee.asn1.x509.IssuerAltName=function(e){ee.asn1.x509.IssuerAltName.superclass.constructor.call(this,e),this.setNameArray=function(e){this.asn1ExtnValue=new ee.asn1.x509.GeneralNames(e)},this.getExtnValueHex=function(){return this.asn1ExtnValue.tohex()},this.oid="2.5.29.18",void 0!==e&&void 0!==e.array&&this.setNameArray(e.array)},Je(ee.asn1.x509.IssuerAltName,ee.asn1.x509.Extension),ee.asn1.x509.SubjectDirectoryAttributes=function(e){ee.asn1.x509.SubjectDirectoryAttributes.superclass.constructor.call(this,e);var t=ee.asn1,n=t.DERSequence,r=t.ASN1Util.newObject,i=t.x509.OID.name2oid;this.params=null,this.getExtnValueHex=function(){for(var e=[],t=0;t<this.params.array.length;t++){var s=this.params.array[t];if(void 0==s.attr||void 0==s.array){var o={seq:[{oid:"1.2.3.4"},{set:[{utf8str:"DE"}]}]};if("dateOfBirth"==s.attr)o.seq[0].oid=i(s.attr),o.seq[1].set[0]={gentime:s.str};else if("placeOfBirth"==s.attr)o.seq[0].oid=i(s.attr),o.seq[1].set[0]={utf8str:s.str};else if("gender"==s.attr)o.seq[0].oid=i(s.attr),o.seq[1].set[0]={prnstr:s.str};else if("countryOfCitizenship"==s.attr)o.seq[0].oid=i(s.attr),o.seq[1].set[0]={prnstr:s.str};else{if("countryOfResidence"!=s.attr)throw new Error("unsupported attribute: "+s.attr);o.seq[0].oid=i(s.attr),o.seq[1].set[0]={prnstr:s.str}}e.push(new r(o))}else{var a={seq:[{oid:s.attr},{set:s.array}]};e.push(r(a))}}var c=new n({array:e});return this.asn1ExtnValue=c,this.asn1ExtnValue.tohex()},this.oid="2.5.29.9",void 0!==e&&(this.params=e)},Je(ee.asn1.x509.SubjectDirectoryAttributes,ee.asn1.x509.Extension),ee.asn1.x509.PrivateExtension=function(e){ee.asn1.x509.PrivateExtension.superclass.constructor.call(this,e);var t=ee,n=t.lang.String.isHex,r=t.asn1,i=r.x509.OID.name2oid,s=r.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.oid=i(e.extname),this.params=e},this.getExtnValueHex=function(){if(void 0==this.params.extname||void 0==this.params.extn)throw new Error("extname or extnhex not specified");var e=this.params.extn;if("string"==typeof e&&n(e))return e;if("object"==typeof e)try{return s(e).tohex()}catch(t){}throw new Error("unsupported extn value")},void 0!=e&&this.setByParam(e)},Je(ee.asn1.x509.PrivateExtension,ee.asn1.x509.Extension),ee.asn1.x509.CRL=function(e){ee.asn1.x509.CRL.superclass.constructor.call(this);var t=ee.asn1,n=t.DERSequence,r=t.DERBitString,i=t.x509,s=i.AlgorithmIdentifier,o=i.TBSCertList;this.params=void 0,this.setByParam=function(e){this.params=e},this.sign=function(){var e=new o(this.params).tohex(),t=new ee.crypto.Signature({alg:this.params.sigalg});t.init(this.params.cakey),t.updateHex(e);var n=t.sign();this.params.sighex=n},this.getPEM=function(){return Se(this.tohex(),"X509 CRL")},this.tohex=function(){var e=this.params;if(void 0==e.tbsobj&&(e.tbsobj=new o(e)),void 0==e.sighex&&void 0!=e.cakey&&this.sign(),void 0==e.sighex)throw new Error("sighex or cakey parameter not defined");var t=[];return t.push(e.tbsobj),t.push(new s({name:e.sigalg})),t.push(new r({hex:"00"+e.sighex})),new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&(this.params=e)},Je(ee.asn1.x509.CRL,ee.asn1.ASN1Object),ee.asn1.x509.TBSCertList=function(e){ee.asn1.x509.TBSCertList.superclass.constructor.call(this);var t=ee.asn1,n=t.DERInteger,r=t.DERSequence,i=t.DERTaggedObject,s=(t.DERObjectIdentifier,t.x509),o=s.AlgorithmIdentifier,a=s.Time,c=s.Extensions,l=s.X500Name;this.params=null,this.setByParam=function(e){this.params=e},this.getRevCertSequence=function(){for(var e=[],t=this.params.revcert,i=0;i<t.length;i++){var s=[new n(t[i].sn),new a(t[i].date)];void 0!=t[i].ext&&s.push(new c(t[i].ext)),e.push(new r({array:s}))}return new r({array:e})},this.tohex=function(){var e=[],t=this.params;if(void 0!=t.version){var s=t.version-1,u=new n({int:s});e.push(u)}if(e.push(new o({name:t.sigalg})),e.push(new l(t.issuer)),e.push(new a(t.thisupdate)),void 0!=t.nextupdate&&e.push(new a(t.nextupdate)),void 0!=t.revcert&&e.push(this.getRevCertSequence()),void 0!=t.ext){var h=new c(t.ext);e.push(new i({tag:"a0",explicit:!0,obj:h}))}return new r({array:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Je(ee.asn1.x509.TBSCertList,ee.asn1.ASN1Object),ee.asn1.x509.CRLEntry=function(e){ee.asn1.x509.CRLEntry.superclass.constructor.call(this);var t=ee.asn1;this.setCertSerial=function(e){this.sn=new t.DERInteger(e)},this.setRevocationDate=function(e){this.time=new t.x509.Time(e)},this.tohex=function(){var e=new t.DERSequence({array:[this.sn,this.time]});return this.TLV=e.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.time&&this.setRevocationDate(e.time),void 0!==e.sn&&this.setCertSerial(e.sn))},Je(ee.asn1.x509.CRLEntry,ee.asn1.ASN1Object),ee.asn1.x509.CRLNumber=function(e){ee.asn1.x509.CRLNumber.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new ee.asn1.DERInteger(this.params.num),this.asn1ExtnValue.tohex()},this.oid="2.5.29.20",void 0!=e&&(this.params=e)},Je(ee.asn1.x509.CRLNumber,ee.asn1.x509.Extension),ee.asn1.x509.CRLReason=function(e){ee.asn1.x509.CRLReason.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new ee.asn1.DEREnumerated(this.params.code),this.asn1ExtnValue.tohex()},this.oid="2.5.29.21",void 0!=e&&(this.params=e)},Je(ee.asn1.x509.CRLReason,ee.asn1.x509.Extension),ee.asn1.x509.OCSPNonce=function(e){ee.asn1.x509.OCSPNonce.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new ee.asn1.DEROctetString(this.params),this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.48.1.2",void 0!=e&&(this.params=e)},Je(ee.asn1.x509.OCSPNonce,ee.asn1.x509.Extension),ee.asn1.x509.OCSPNoCheck=function(e){ee.asn1.x509.OCSPNoCheck.superclass.constructor.call(this,e),this.params=void 0,this.getExtnValueHex=function(){return this.asn1ExtnValue=new ee.asn1.DERNull,this.asn1ExtnValue.tohex()},this.oid="1.3.6.1.5.5.7.48.1.5",void 0!=e&&(this.params=e)},Je(ee.asn1.x509.OCSPNoCheck,ee.asn1.x509.Extension),ee.asn1.x509.AdobeTimeStamp=function(e){ee.asn1.x509.AdobeTimeStamp.superclass.constructor.call(this,e);var t=ee.asn1,n=t.DERInteger,r=t.DERBoolean,i=t.DERSequence,s=t.x509.GeneralName;this.params=null,this.getExtnValueHex=function(){var e=this.params,t=[new n(1)];return t.push(new s({uri:e.uri})),void 0!=e.reqauth&&t.push(new r(e.reqauth)),this.asn1ExtnValue=new i({array:t}),this.asn1ExtnValue.tohex()},this.oid="1.2.840.113583.1.1.9.1",void 0!==e&&this.setByParam(e)},Je(ee.asn1.x509.AdobeTimeStamp,ee.asn1.x509.Extension),ee.asn1.x509.X500Name=function(e){ee.asn1.x509.X500Name.superclass.constructor.call(this),this.asn1Array=[],this.paramArray=[],this.sRule="utf8";var t=ee.asn1,n=t.x509,r=n.RDN;this.setByString=function(e,t){void 0!==t&&(this.sRule=t);var n=e.split("/");n.shift();for(var i=[],s=0;s<n.length;s++)if(n[s].match(/^[^=]+=.+$/))i.push(n[s]);else{var o=i.length-1;i[o]=i[o]+"/"+n[s]}for(s=0;s<i.length;s++)this.asn1Array.push(new r({str:i[s],rule:this.sRule}))},this.setByLdapString=function(e,t){void 0!==t&&(this.sRule=t);var r=n.X500Name.ldapToCompat(e);this.setByString(r,t)},this.setByObject=function(e,t){for(var n in void 0!==t&&(this.sRule=t),e)if(e.hasOwnProperty(n)){var i=new r({str:n+"="+e[n],rule:this.sRule});this.asn1Array?this.asn1Array.push(i):this.asn1Array=[i]}},this.setByParam=function(e){var t;(void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.array)?this.paramArray=e.array:void 0!==e.str?this.setByString(e.str):void 0!==e.ldapstr?this.setByLdapString(e.ldapstr):void 0!==e.hex?this.hTLV=e.hex:void 0!==e.certissuer?((t=new Ye).readCertPEM(e.certissuer),this.hTLV=t.getIssuerHex()):void 0!==e.certsubject?((t=new Ye).readCertPEM(e.certsubject),this.hTLV=t.getSubjectHex()):"object"===typeof e&&void 0===e.certsubject&&void 0===e.certissuer&&this.setByObject(e)},this.tohex=function(){if("string"==typeof this.hTLV)return this.hTLV;if(0==this.asn1Array.length&&this.paramArray.length>0)for(var e=0;e<this.paramArray.length;e++){var n={array:this.paramArray[e]};"utf8"!=this.sRule&&(n.rule=this.sRule);var i=new r(n);this.asn1Array.push(i)}var s=new t.DERSequence({array:this.asn1Array});return this.hTLV=s.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Je(ee.asn1.x509.X500Name,ee.asn1.ASN1Object),ee.asn1.x509.X500Name.compatToLDAP=function(e){if("/"!==e.substr(0,1))throw"malformed input";var t=(e=e.substr(1)).split("/");return t.reverse(),(t=t.map((function(e){return e.replace(/,/,"\\,")}))).join(",")},ee.asn1.x509.X500Name.onelineToLDAP=function(e){return ee.asn1.x509.X500Name.compatToLDAP(e)},ee.asn1.x509.X500Name.ldapToCompat=function(e){for(var t=e.split(","),n=!1,r=[],i=0;t.length>0;i++){var s=t.shift();if(!0===n){var o=(r.pop()+","+s).replace(/\\,/g,",");r.push(o),n=!1}else r.push(s);"\\"===s.substr(-1,1)&&(n=!0)}return(r=r.map((function(e){return e.replace("/","\\/")}))).reverse(),"/"+r.join("/")},ee.asn1.x509.X500Name.ldapToOneline=function(e){return ee.asn1.x509.X500Name.ldapToCompat(e)},ee.asn1.x509.RDN=function(e){ee.asn1.x509.RDN.superclass.constructor.call(this),this.asn1Array=[],this.paramArray=[],this.sRule="utf8";var t=ee.asn1.x509.AttributeTypeAndValue;this.setByParam=function(e){void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.str&&this.addByMultiValuedString(e.str),void 0!==e.array&&(this.paramArray=e.array)},this.addByString=function(e){this.asn1Array.push(new ee.asn1.x509.AttributeTypeAndValue({str:e,rule:this.sRule}))},this.addByMultiValuedString=function(e){for(var t=ee.asn1.x509.RDN.parseString(e),n=0;n<t.length;n++)this.addByString(t[n])},this.tohex=function(){if(0==this.asn1Array.length&&this.paramArray.length>0)for(var e=0;e<this.paramArray.length;e++){var n=this.paramArray[e];void 0!==n.rule&&"utf8"!=this.sRule&&(n.rule=this.sRule);var r=new t(n);this.asn1Array.push(r)}var i=new ee.asn1.DERSet({array:this.asn1Array});return this.TLV=i.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Je(ee.asn1.x509.RDN,ee.asn1.ASN1Object),ee.asn1.x509.RDN.parseString=function(e){for(var t=e.split(/\+/),n=!1,r=[],i=0;t.length>0;i++){var s=t.shift();if(!0===n){var o=(r.pop()+"+"+s).replace(/\\\+/g,"+");r.push(o),n=!1}else r.push(s);"\\"===s.substr(-1,1)&&(n=!0)}var a=!1,c=[];for(i=0;r.length>0;i++){s=r.shift();if(!0===a){var l=c.pop();if(s.match(/"$/)){o=(l+"+"+s).replace(/^([^=]+)="(.*)"$/,"$1=$2");c.push(o),a=!1}else c.push(l+"+"+s)}else c.push(s);s.match(/^[^=]+="/)&&(a=!0)}return c},ee.asn1.x509.AttributeTypeAndValue=function(e){ee.asn1.x509.AttributeTypeAndValue.superclass.constructor.call(this),this.sRule="utf8",this.sType=null,this.sValue=null,this.dsType=null;var t=ee,n=t.asn1,r=n.DERSequence,i=n.DERUTF8String,s=n.DERPrintableString,o=n.DERTeletexString,a=n.DERIA5String,c=n.DERVisibleString,l=n.DERBMPString,u=t.lang.String.isMail,h=t.lang.String.isPrintable;this.setByParam=function(e){if(void 0!==e.rule&&(this.sRule=e.rule),void 0!==e.ds&&(this.dsType=e.ds),void 0===e.value&&void 0!==e.str){var t=e.str.match(/^([^=]+)=(.+)$/);if(!t)throw new Error("malformed attrTypeAndValueStr: "+attrTypeAndValueStr);this.sType=t[1],this.sValue=t[2]}else this.sType=e.type,this.sValue=e.value},this.setByString=function(e,t){void 0!==t&&(this.sRule=t);var n=e.match(/^([^=]+)=(.+)$/);if(!n)throw new Error("malformed attrTypeAndValueStr: "+attrTypeAndValueStr);this.setByAttrTypeAndValueStr(n[1],n[2])},this._getDsType=function(){var e=this.sType,t=this.sValue,n=this.sRule;return"prn"===n?"CN"==e&&u(t)?"ia5":h(t)?"prn":"utf8":"utf8"===n?"CN"==e&&u(t)?"ia5":"C"==e?"prn":"utf8":"utf8"},this.setByAttrTypeAndValueStr=function(e,t,n){void 0!==n&&(this.sRule=n),this.sType=e,this.sValue=t},this.getValueObj=function(e,t){if("utf8"==e)return new i({str:t});if("prn"==e)return new s({str:t});if("tel"==e)return new o({str:t});if("ia5"==e)return new a({str:t});if("vis"==e)return new c({str:t});if("bmp"==e)return new l({str:t});throw new Error("unsupported directory string type: type="+e+" value="+t)},this.tohex=function(){null==this.dsType&&(this.dsType=this._getDsType());var e=ee.asn1.x509.OID.atype2obj(this.sType),t=this.getValueObj(this.dsType,this.sValue),n=new r({array:[e,t]});return this.TLV=n.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Je(ee.asn1.x509.AttributeTypeAndValue,ee.asn1.ASN1Object),ee.asn1.x509.SubjectPublicKeyInfo=function(e){ee.asn1.x509.SubjectPublicKeyInfo.superclass.constructor.call(this);var t=ee,n=t.asn1,r=n.DERInteger,i=n.DERBitString,s=n.DERObjectIdentifier,o=n.DERSequence,a=n.ASN1Util.newObject,c=n.x509.AlgorithmIdentifier,l=t.crypto;l.ECDSA,l.DSA;this.getASN1Object=function(){if(null==this.asn1AlgId||null==this.asn1SubjPKey)throw"algId and/or subjPubKey not set";return new o({array:[this.asn1AlgId,this.asn1SubjPKey]})},this.tohex=function(){var e=this.getASN1Object();return this.hTLV=e.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},this.setPubKey=function(e){try{if(e instanceof J){var t=a({seq:[{int:{bigint:e.n}},{int:{int:e.e}}]}).tohex();this.asn1AlgId=new c({name:"rsaEncryption"}),this.asn1SubjPKey=new i({hex:"00"+t})}}catch(l){}try{if(e instanceof ee.crypto.ECDSA){var n=new s({name:e.curveName});this.asn1AlgId=new c({name:"ecPublicKey",asn1params:n}),this.asn1SubjPKey=new i({hex:"00"+e.pubKeyHex})}}catch(l){}try{if(e instanceof ee.crypto.DSA){n=new a({seq:[{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}}]});this.asn1AlgId=new c({name:"dsa",asn1params:n});var o=new r({bigint:e.y});this.asn1SubjPKey=new i({hex:"00"+o.tohex()})}}catch(l){}},void 0!==e&&this.setPubKey(e)},Je(ee.asn1.x509.SubjectPublicKeyInfo,ee.asn1.ASN1Object),ee.asn1.x509.Time=function(e){ee.asn1.x509.Time.superclass.constructor.call(this);var t=ee.asn1,n=t.DERUTCTime,r=t.DERGeneralizedTime;this.params=null,this.type=null,this.setTimeParams=function(e){this.timeParams=e},this.setByParam=function(e){this.params=e},this.getType=function(e){return e.match(/^[0-9]{12}Z$/)?"utc":e.match(/^[0-9]{14}Z$/)?"gen":e.match(/^[0-9]{12}\.[0-9]+Z$/)?"utc":e.match(/^[0-9]{14}\.[0-9]+Z$/)?"gen":null},this.tohex=function(){var e=this.params,t=null;if("string"==typeof e&&(e={str:e}),null==e||!e.str||null!=e.type&&void 0!=e.type||(e.type=this.getType(e.str)),null!=e&&e.str?("utc"==e.type&&(t=new n(e.str)),"gen"==e.type&&(t=new r(e.str))):t="gen"==this.type?new r:new n,null==t)throw new Error("wrong setting for Time");return this.TLV=t.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},ee.asn1.x509.Time_bak=function(e){ee.asn1.x509.Time_bak.superclass.constructor.call(this);var t=ee.asn1,n=t.DERUTCTime,r=t.DERGeneralizedTime;this.setTimeParams=function(e){this.timeParams=e},this.tohex=function(){var e=null;return e=null!=this.timeParams?"utc"==this.type?new n(this.timeParams):new r(this.timeParams):"utc"==this.type?new n:new r,this.TLV=e.tohex(),this.TLV},this.getEncodedHex=function(){return this.tohex()},this.type="utc",void 0!==e&&(void 0!==e.type?this.type=e.type:void 0!==e.str&&(e.str.match(/^[0-9]{12}Z$/)&&(this.type="utc"),e.str.match(/^[0-9]{14}Z$/)&&(this.type="gen")),this.timeParams=e)},Je(ee.asn1.x509.Time,ee.asn1.ASN1Object),ee.asn1.x509.AlgorithmIdentifier=function(e){ee.asn1.x509.AlgorithmIdentifier.superclass.constructor.call(this),this.nameAlg=null,this.asn1Alg=null,this.asn1Params=null,this.paramEmpty=!1;var t=ee.asn1,n=t.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV;if(this.tohex=function(){if(null===this.nameAlg&&null===this.asn1Alg)throw new Error("algorithm not specified");if(null!==this.nameAlg){var e=null;for(var r in n)r===this.nameAlg&&(e=n[r]);if(null!==e)return this.hTLV=e,this.hTLV}null!==this.nameAlg&&null===this.asn1Alg&&(this.asn1Alg=t.x509.OID.name2obj(this.nameAlg));var i=[this.asn1Alg];null!==this.asn1Params&&i.push(this.asn1Params);var s=new t.DERSequence({array:i});return this.hTLV=s.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&(void 0!==e.name&&(this.nameAlg=e.name),void 0!==e.asn1params&&(this.asn1Params=e.asn1params),void 0!==e.paramempty&&(this.paramEmpty=e.paramempty)),null===this.asn1Params&&!1===this.paramEmpty&&null!==this.nameAlg){void 0!==this.nameAlg.name&&(this.nameAlg=this.nameAlg.name);var r=this.nameAlg.toLowerCase();"withdsa"!==r.substr(-7,7)&&"withecdsa"!==r.substr(-9,9)&&(this.asn1Params=new t.DERNull)}},Je(ee.asn1.x509.AlgorithmIdentifier,ee.asn1.ASN1Object),ee.asn1.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV={SHAwithRSAandMGF1:"300d06092a864886f70d01010a3000",SHA256withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040201a11a301806092a864886f70d010108300b0609608648016503040201a203020120",SHA384withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040202a11a301806092a864886f70d010108300b0609608648016503040202a203020130",SHA512withRSAandMGF1:"303d06092a864886f70d01010a3030a00d300b0609608648016503040203a11a301806092a864886f70d010108300b0609608648016503040203a203020140"},ee.asn1.x509.GeneralName=function(e){ee.asn1.x509.GeneralName.superclass.constructor.call(this);var t=ee.asn1,n=t.x509,r=n.X500Name,i=n.OtherName,s=t.DERIA5String,o=(t.DERPrintableString,t.DEROctetString),a=t.DERTaggedObject,c=t.ASN1Object,l=Error;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e,t,n=this.params,u=!1;if(void 0!==n.other)e="a0",t=new i(n.other);else if(void 0!==n.rfc822)e="81",t=new s({str:n.rfc822});else if(void 0!==n.dns)e="82",t=new s({str:n.dns});else if(void 0!==n.dn)e="a4",u=!0,t="string"===typeof n.dn?new r({str:n.dn}):n.dn instanceof ee.asn1.x509.X500Name?n.dn:new r(n.dn);else if(void 0!==n.ldapdn)e="a4",u=!0,t=new r({ldapstr:n.ldapdn});else if(void 0!==n.certissuer||void 0!==n.certsubj){var h,d;e="a4",u=!0;var f=null;if(void 0!==n.certsubj?(h=!1,d=n.certsubj):(h=!0,d=n.certissuer),d.match(/^[0-9A-Fa-f]+$/),-1!=d.indexOf("-----BEGIN ")&&(f=we(d)),null==f)throw new Error("certsubj/certissuer not cert");var p,m=new Ye;m.hex=f,p=h?m.getIssuerHex():m.getSubjectHex(),(t=new c).hTLV=p}else if(void 0!==n.uri)e="86",t=new s({str:n.uri});else{if(void 0===n.ip)throw new l("improper params");var g;e="87";var v=n.ip;try{if(v.match(/^[0-9a-f]+$/)){var y=v.length;if(8!=y&&16!=y&&32!=y&&64!=y)throw"err";g=v}else g=De(v)}catch(b){throw new l("malformed IP address: "+n.ip+":"+b.message)}t=new o({hex:g})}return new a({tag:e,explicit:u,obj:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Je(ee.asn1.x509.GeneralName,ee.asn1.ASN1Object),ee.asn1.x509.GeneralNames=function(e){ee.asn1.x509.GeneralNames.superclass.constructor.call(this);var t=ee.asn1;this.setByParamArray=function(e){for(var n=0;n<e.length;n++){var r=new t.x509.GeneralName(e[n]);this.asn1Array.push(r)}},this.tohex=function(){return new t.DERSequence({array:this.asn1Array}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.asn1Array=new Array,"undefined"!=typeof e&&this.setByParamArray(e)},Je(ee.asn1.x509.GeneralNames,ee.asn1.ASN1Object),ee.asn1.x509.OtherName=function(e){ee.asn1.x509.OtherName.superclass.constructor.call(this);var t=ee.asn1,n=t.DERObjectIdentifier,r=t.DERSequence,i=t.ASN1Util.newObject;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if(void 0==e.oid||void 0==e.value)throw new Error("oid or value not specified");var t=new n({oid:e.oid}),s=i({tag:{tag:"a0",explicit:!0,obj:e.value}});return new r({array:[t,s]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Je(ee.asn1.x509.OtherName,ee.asn1.ASN1Object),ee.asn1.x509.OID=new function(){var e=ee.asn1.DERObjectIdentifier;this.name2oidList={"aes128-CBC":"2.16.840.1.101.3.4.1.2","aes256-CBC":"2.16.840.1.101.3.4.1.42",sha1:"1.3.14.3.2.26",sha256:"2.16.840.1.101.3.4.2.1",sha384:"2.16.840.1.101.3.4.2.2",sha512:"2.16.840.1.101.3.4.2.3",sha224:"2.16.840.1.101.3.4.2.4",md5:"1.2.840.113549.2.5",md2:"1.3.14.7.2.2.1",ripemd160:"1.3.36.3.2.1",hmacWithSHA1:"1.2.840.113549.2.7",hmacWithSHA224:"1.2.840.113549.2.8",hmacWithSHA256:"1.2.840.113549.2.9",hmacWithSHA384:"1.2.840.113549.2.10",hmacWithSHA512:"1.2.840.113549.2.11",MD2withRSA:"1.2.840.113549.1.1.2",MD4withRSA:"1.2.840.113549.1.1.3",MD5withRSA:"1.2.840.113549.1.1.4",SHA1withRSA:"1.2.840.113549.1.1.5","pkcs1-MGF":"1.2.840.113549.1.1.8",rsaPSS:"1.2.840.113549.1.1.10",SHA224withRSA:"1.2.840.113549.1.1.14",SHA256withRSA:"1.2.840.113549.1.1.11",SHA384withRSA:"1.2.840.113549.1.1.12",SHA512withRSA:"1.2.840.113549.1.1.13",SHA1withECDSA:"1.2.840.10045.4.1",SHA224withECDSA:"1.2.840.10045.4.3.1",SHA256withECDSA:"1.2.840.10045.4.3.2",SHA384withECDSA:"1.2.840.10045.4.3.3",SHA512withECDSA:"1.2.840.10045.4.3.4",dsa:"1.2.840.10040.4.1",SHA1withDSA:"1.2.840.10040.4.3",SHA224withDSA:"2.16.840.1.101.3.4.3.1",SHA256withDSA:"2.16.840.1.101.3.4.3.2",rsaEncryption:"1.2.840.113549.1.1.1",commonName:"2.5.4.3",countryName:"2.5.4.6",localityName:"2.5.4.7",stateOrProvinceName:"2.5.4.8",streetAddress:"2.5.4.9",organizationName:"2.5.4.10",organizationalUnitName:"2.5.4.11",domainComponent:"0.9.2342.19200300.100.1.25",userId:"0.9.2342.19200300.100.1.1",surname:"2.5.4.4",givenName:"2.5.4.42",title:"2.5.4.12",distinguishedName:"2.5.4.49",emailAddress:"1.2.840.113549.1.9.1",description:"2.5.4.13",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",uniqueIdentifier:"2.5.4.45",organizationIdentifier:"2.5.4.97",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3",subjectDirectoryAttributes:"2.5.29.9",subjectKeyIdentifier:"2.5.29.14",keyUsage:"2.5.29.15",subjectAltName:"2.5.29.17",issuerAltName:"2.5.29.18",basicConstraints:"2.5.29.19",cRLNumber:"2.5.29.20",cRLReason:"2.5.29.21",nameConstraints:"2.5.29.30",cRLDistributionPoints:"2.5.29.31",certificatePolicies:"2.5.29.32",anyPolicy:"2.5.29.32.0",policyMappings:"2.5.29.33",authorityKeyIdentifier:"2.5.29.35",policyConstraints:"2.5.29.36",extKeyUsage:"2.5.29.37",inhibitAnyPolicy:"2.5.29.54",authorityInfoAccess:"1.3.6.1.5.5.7.1.1",ocsp:"1.3.6.1.5.5.7.48.1",ocspBasic:"1.3.6.1.5.5.7.48.1.1",ocspNonce:"1.3.6.1.5.5.7.48.1.2",ocspNoCheck:"1.3.6.1.5.5.7.48.1.5",caIssuers:"1.3.6.1.5.5.7.48.2",anyExtendedKeyUsage:"2.5.29.37.0",serverAuth:"1.3.6.1.5.5.7.3.1",clientAuth:"1.3.6.1.5.5.7.3.2",codeSigning:"1.3.6.1.5.5.7.3.3",emailProtection:"1.3.6.1.5.5.7.3.4",timeStamping:"1.3.6.1.5.5.7.3.8",ocspSigning:"1.3.6.1.5.5.7.3.9",smtpUTF8Mailbox:"1.3.6.1.5.5.7.8.9",dateOfBirth:"1.3.6.1.5.5.7.9.1",placeOfBirth:"1.3.6.1.5.5.7.9.2",gender:"1.3.6.1.5.5.7.9.3",countryOfCitizenship:"1.3.6.1.5.5.7.9.4",countryOfResidence:"1.3.6.1.5.5.7.9.5",ecPublicKey:"1.2.840.10045.2.1","P-256":"1.2.840.10045.3.1.7",secp256r1:"1.2.840.10045.3.1.7",secp256k1:"1.3.132.0.10",secp384r1:"1.3.132.0.34",secp521r1:"1.3.132.0.35",pkcs5PBES2:"1.2.840.113549.1.5.13",pkcs5PBKDF2:"1.2.840.113549.1.5.12","des-EDE3-CBC":"1.2.840.113549.3.7",data:"1.2.840.113549.1.7.1","signed-data":"1.2.840.113549.1.7.2","enveloped-data":"1.2.840.113549.1.7.3","digested-data":"1.2.840.113549.1.7.5","encrypted-data":"1.2.840.113549.1.7.6","authenticated-data":"1.2.840.113549.1.9.16.1.2",tstinfo:"1.2.840.113549.1.9.16.1.4",signingCertificate:"1.2.840.113549.1.9.16.2.12",timeStampToken:"1.2.840.113549.1.9.16.2.14",signaturePolicyIdentifier:"1.2.840.113549.1.9.16.2.15",etsArchiveTimeStamp:"1.2.840.113549.1.9.16.2.27",signingCertificateV2:"1.2.840.113549.1.9.16.2.47",etsArchiveTimeStampV2:"1.2.840.113549.1.9.16.2.48",extensionRequest:"1.2.840.113549.1.9.14",contentType:"1.2.840.113549.1.9.3",messageDigest:"1.2.840.113549.1.9.4",signingTime:"1.2.840.113549.1.9.5",counterSignature:"1.2.840.113549.1.9.6",archiveTimeStampV3:"0.4.0.1733.2.4",pdfRevocationInfoArchival:"1.2.840.113583.1.1.8",adobeTimeStamp:"1.2.840.113583.1.1.9.1",smimeMailboxLegacy:"2.23.140.1.5.1.1",smimeMailboxMulti:"2.23.140.1.5.1.2",smimeMailboxStrict:"2.23.140.1.5.1.3",smimeOrganizationLegacy:"2.23.140.1.5.2.1",smimeOrganizationMulti:"2.23.140.1.5.2.2",smimeOrganizationStrict:"2.23.140.1.5.2.3",smimeSponsorLegacy:"2.23.140.1.5.3.1",smimeSponsorMulti:"2.23.140.1.5.3.2",smimeSponsorStrict:"2.23.140.1.5.3.3",smimeIndividualLegacy:"2.23.140.1.5.4.1",smimeIndividualMulti:"2.23.140.1.5.4.2",smimeIndividualStrict:"2.23.140.1.5.4.3"},this.atype2oidList={CN:"2.5.4.3",L:"2.5.4.7",ST:"2.5.4.8",O:"2.5.4.10",OU:"2.5.4.11",C:"2.5.4.6",STREET:"2.5.4.9",DC:"0.9.2342.19200300.100.1.25",UID:"0.9.2342.19200300.100.1.1",SN:"2.5.4.4",T:"2.5.4.12",GN:"2.5.4.42",DN:"2.5.4.49",E:"1.2.840.113549.1.9.1",description:"2.5.4.13",businessCategory:"2.5.4.15",postalCode:"2.5.4.17",serialNumber:"2.5.4.5",uniqueIdentifier:"2.5.4.45",organizationIdentifier:"2.5.4.97",jurisdictionOfIncorporationL:"1.3.6.1.4.1.311.60.2.1.1",jurisdictionOfIncorporationSP:"1.3.6.1.4.1.311.60.2.1.2",jurisdictionOfIncorporationC:"1.3.6.1.4.1.311.60.2.1.3"},this.objCache={},this.name2obj=function(t){if("undefined"!=typeof this.objCache[t])return this.objCache[t];if("undefined"==typeof this.name2oidList[t])throw"Name of ObjectIdentifier not defined: "+t;var n=this.name2oidList[t],r=new e({oid:n});return this.objCache[t]=r,r},this.atype2obj=function(t){if(void 0!==this.objCache[t])return this.objCache[t];var n;if(t.match(/^\d+\.\d+\.[0-9.]+$/))n=t;else if(void 0!==this.atype2oidList[t])n=this.atype2oidList[t];else{if(void 0===this.name2oidList[t])throw new Error("AttributeType name undefined: "+t);n=this.name2oidList[t]}var r=new e({oid:n});return this.objCache[t]=r,r},this.registerOIDs=function(e){if(this.checkOIDs(e))for(var t in e)this.name2oidList[t]=e[t]},this.checkOIDs=function(e){try{var t=Object.keys(e);return 0!=t.length&&(t.map((function(e,t,n){if(!this[e].match(/^[0-2]\.[0-9.]+$/))throw new Error("value is not OID")}),e),!0)}catch(n){return!1}}},ee.asn1.x509.OID.oid2name=function(e){var t=ee.asn1.x509.OID.name2oidList;for(var n in t)if(t[n]==e)return n;return""},ee.asn1.x509.OID.oid2atype=function(e){var t=ee.asn1.x509.OID.atype2oidList;for(var n in t)if(t[n]==e)return n;return e},ee.asn1.x509.OID.name2oid=function(e){if(e.match(/^[0-9.]+$/))return e;var t=ee.asn1.x509.OID.name2oidList;return void 0===t[e]?"":t[e]},ee.asn1.x509.X509Util={},ee.asn1.x509.X509Util.newCertPEM=function(e){var t=ee.asn1.x509;t.TBSCertificate;return new(0,t.Certificate)(e).getPEM()},"undefined"!=typeof ee&&ee||(ee={}),"undefined"!=typeof ee.asn1&&ee.asn1||(ee.asn1={}),"undefined"!=typeof ee.asn1.cms&&ee.asn1.cms||(ee.asn1.cms={}),ee.asn1.cms.Attribute=function(e){var t=Error,n=ee.asn1,r=n.DERSequence,i=n.DERSet,s=n.DERObjectIdentifier;this.params=null,this.typeOid=null,this.setByParam=function(e){this.params=e},this.getValueArray=function(){throw new t("not yet implemented abstract")},this.tohex=function(){var e=new s({oid:this.typeOid}),t=new i({array:this.getValueArray()});return new r({array:[e,t]}).tohex()},this.getEncodedHex=function(){return this.tohex()}},Je(ee.asn1.cms.Attribute,ee.asn1.ASN1Object),ee.asn1.cms.ContentType=function(e){var t=ee.asn1;t.cms.ContentType.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.3",this.getValueArray=function(){return[new t.DERObjectIdentifier(this.params.type)]},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.ContentType,ee.asn1.cms.Attribute),ee.asn1.cms.MessageDigest=function(e){var t=ee.asn1,n=t.DEROctetString;t.cms.MessageDigest.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.4",this.getValueArray=function(){return[new n(this.params)]},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.MessageDigest,ee.asn1.cms.Attribute),ee.asn1.cms.SigningTime=function(e){var t=ee.asn1;t.cms.SigningTime.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.5",this.getValueArray=function(){return[new t.x509.Time(this.params)]},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.SigningTime,ee.asn1.cms.Attribute),ee.asn1.cms.SigningCertificate=function(e){var t=Error,n=ee,r=n.asn1,i=r.DERSequence,s=r.cms,o=s.ESSCertID;n.crypto;s.SigningCertificate.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.12",this.getValueArray=function(){if(null==this.params||void 0==this.params||void 0==this.params.array)throw new t("parameter 'array' not specified");for(var n=this.params.array,r=[],s=0;s<n.length;s++){var a=n[s];0!=e.hasis||"string"!=typeof a||-1==a.indexOf("-----BEGIN")&&!re.isASN1HEX(a)||(a={cert:a}),0!=a.hasis&&0==e.hasis&&(a.hasis=!1),r.push(new o(a))}var c=new i({array:r});return[new i({array:[c]})]},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.SigningCertificate,ee.asn1.cms.Attribute),ee.asn1.cms.ESSCertID=function(e){ee.asn1.cms.ESSCertID.superclass.constructor.call(this);var t=Error,n=ee,r=n.asn1,i=r.DEROctetString,s=r.DERSequence,o=r.cms.IssuerSerial;this.params=null,this.getCertHash=function(e,r){if(void 0!=e.hash)return e.hash;if("string"==typeof e&&-1==e.indexOf("-----BEGIN")&&!re.isASN1HEX(e))return e;var i,s,o;if("string"==typeof e)i=e;else{if(void 0==e.cert)throw new t("hash nor cert unspecified");i=e.cert}if(s=-1!=i.indexOf("-----BEGIN")?we(i):i,"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?s=we(e):re.isASN1HEX(e)&&(s=e)),void 0!=e.alg)o=e.alg;else{if(void 0==r)throw new t("hash alg unspecified");o=r}return n.crypto.Util.hashHex(s,o)},this.tohex=function(){var e=this.params,t=this.getCertHash(e,"sha1"),n=[];return n.push(new i({hex:t})),("string"==typeof e&&-1!=e.indexOf("-----BEGIN")||void 0!=e.cert&&0!=e.hasis||void 0!=e.issuer&&void 0!=e.serial)&&n.push(new o(e)),new s({array:n}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.ESSCertID,ee.asn1.ASN1Object),ee.asn1.cms.SigningCertificateV2=function(e){var t=Error,n=ee,r=n.asn1,i=r.DERSequence,s=(r.x509,r.cms),o=s.ESSCertIDv2;n.crypto;s.SigningCertificateV2.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.47",this.getValueArray=function(){if(null==this.params||void 0==this.params||void 0==this.params.array)throw new t("parameter 'array' not specified");for(var n=this.params.array,r=[],s=0;s<n.length;s++){var a=n[s];void 0==e.alg&&0!=e.hasis||"string"!=typeof a||-1==a.indexOf("-----BEGIN")&&!re.isASN1HEX(a)||(a={cert:a}),void 0==a.alg&&void 0!=e.alg&&(a.alg=e.alg),0!=a.hasis&&0==e.hasis&&(a.hasis=!1),r.push(new o(a))}var c=new i({array:r});return[new i({array:[c]})]},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.SigningCertificateV2,ee.asn1.cms.Attribute),ee.asn1.cms.ESSCertIDv2=function(e){ee.asn1.cms.ESSCertIDv2.superclass.constructor.call(this);Error;var t=ee.asn1,n=t.DEROctetString,r=t.DERSequence,i=t.cms.IssuerSerial,s=t.x509.AlgorithmIdentifier;this.params=null,this.tohex=function(){var e=this.params,t=this.getCertHash(e,"sha256"),o=[];return void 0!=e.alg&&"sha256"!=e.alg&&o.push(new s({name:e.alg})),o.push(new n({hex:t})),("string"==typeof e&&-1!=e.indexOf("-----BEGIN")||void 0!=e.cert&&0!=e.hasis||void 0!=e.issuer&&void 0!=e.serial)&&o.push(new i(e)),new r({array:o}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.ESSCertIDv2,ee.asn1.cms.ESSCertID),ee.asn1.cms.IssuerSerial=function(e){var t=Error,n=ee.asn1,r=n.DERInteger,i=n.DERSequence,s=n.cms,o=n.x509.GeneralNames,a=Ye;s.IssuerSerial.superclass.constructor.call(this),this.setByParam=function(e){this.params=e},this.tohex=function(){var e,n,s=this.params;if("string"==typeof s&&-1!=s.indexOf("-----BEGIN")||void 0!=s.cert){var c;c=void 0!=s.cert?s.cert:s;var l=new a;l.readCertPEM(c),e=l.getIssuer(),n={hex:l.getSerialNumberHex()}}else{if(void 0==s.issuer||!s.serial)throw new t("cert or issuer and serial parameter not specified");e=s.issuer,n=s.serial}var u=new o([{dn:e}]),h=new r(n);return new i({array:[u,h]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.IssuerSerial,ee.asn1.ASN1Object),ee.asn1.cms.SignerIdentifier=function(e){var t=ee.asn1,n=(t.DERInteger,t.DERSequence,t.cms),r=n.IssuerAndSerialNumber,i=n.SubjectKeyIdentifier;t.x509.X500Name,Error;n.SignerIdentifier.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if("isssn"==e.type)return new r(e).tohex();if("skid"==e.type)return new i(e).tohex();throw new Error("wrong property for isssn or skid")},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.SignerIdentifier,ee.asn1.ASN1Object),ee.asn1.cms.IssuerAndSerialNumber=function(e){var t=ee.asn1,n=t.DERInteger,r=t.DERSequence,i=t.cms,s=t.x509.X500Name,o=Ye,a=Error;i.IssuerAndSerialNumber.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e,t,i=this.params;if("string"==typeof i&&-1!=i.indexOf("-----BEGIN")||void 0!=i.cert){var c;c=void 0!=i.cert?i.cert:i;var l=new o;l.readCertPEM(c),e=l.getIssuer(),t={hex:l.getSerialNumberHex()}}else{if(void 0==i.issuer||!i.serial)throw new a("cert or issuer and serial parameter not specified");e=i.issuer,t=i.serial}var u=new s(e),h=new n(t);return new r({array:[u,h]}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.IssuerAndSerialNumber,ee.asn1.ASN1Object),ee.asn1.cms.SubjectKeyIdentifier=function(e){var t=ee.asn1,n=(t.DERInteger,t.DERSequence,t.ASN1Util.newObject),r=t.cms,i=(r.IssuerAndSerialName,r.SubjectKeyIdentifier,t.x509.X500Name,Ye),s=Error;r.SubjectKeyIdentifier.superclass.constructor.call(this),this.tohex=function(){var e,t=this.params;if(void 0==t.cert&&void 0==t.skid)throw new s("property cert nor skid undefined");void 0!=t.cert?e=new i(t.cert).getExtSubjectKeyIdentifier().kid.hex:void 0!=t.skid&&(e=t.skid);return n({tag:{tage:"a0",obj:{octstr:{hex:e}}}}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.SubjectKeyIdentifier,ee.asn1.ASN1Object),ee.asn1.cms.AttributeList=function(e){var t=Error,n=ee.asn1,r=n.DERSet,i=n.cms;i.AttributeList.superclass.constructor.call(this),this.params=null,this.hTLV=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if(null!=this.hTLV)return this.hTLV;var n=!0;void 0!=e.sortflag&&(n=e.sortflag);for(var s=e.array,o=[],a=0;a<s.length;a++){var c=s[a],l=c.attr;if("contentType"==l)o.push(new i.ContentType(c));else if("messageDigest"==l)o.push(new i.MessageDigest(c));else if("signingTime"==l)o.push(new i.SigningTime(c));else if("signingCertificate"==l)o.push(new i.SigningCertificate(c));else if("signingCertificateV2"==l)o.push(new i.SigningCertificateV2(c));else if("signaturePolicyIdentifier"==l)o.push(new ee.asn1.cades.SignaturePolicyIdentifier(c));else{if("signatureTimeStamp"!=l&&"timeStampToken"!=l)throw new t("unknown attr: "+l);o.push(new ee.asn1.cades.SignatureTimeStamp(c))}}var u=new r({array:o,sortflag:n});return this.hTLV=u.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.AttributeList,ee.asn1.ASN1Object),ee.asn1.cms.SignerInfo=function(e){var t=Error,n=ee,r=n.asn1,i=r.DERInteger,s=r.DEROctetString,o=r.DERSequence,a=r.DERTaggedObject,c=r.cms,l=c.SignerIdentifier,u=c.AttributeList,h=(c.ContentType,c.EncapsulatedContentInfo,c.MessageDigest,c.SignedData,r.x509.AlgorithmIdentifier),d=n.crypto,f=Ze;c.SignerInfo.superclass.constructor.call(this),this.params=null,this.sign=function(){var e=this.params,t=e.sigalg,n=new u(e.sattrs).tohex(),r=f.getKey(e.signkey),i=new d.Signature({alg:t});i.init(r),i.updateHex(n);var s=i.sign();e.sighex=s},this.tohex=function(){var e=this.params,n=[];if(n.push(new i({int:e.version})),n.push(new l(e.id)),n.push(new h({name:e.hashalg})),void 0!=e.sattrs){var r=new u(e.sattrs);try{n.push(new a({tag:"a0",explicit:!1,obj:r}))}catch(c){throw new t("si sattr error: "+c)}}if(void 0!=e.sigalgfield?n.push(new h({name:e.sigalgfield})):n.push(new h({name:e.sigalg})),void 0==e.sighex&&void 0!=e.signkey&&this.sign(),n.push(new s({hex:e.sighex})),void 0!=e.uattrs){r=new u(e.uattrs);try{n.push(new a({tag:"a1",explicit:!1,obj:r}))}catch(c){throw new t("si uattr error: "+c)}}return new o({array:n}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.SignerInfo,ee.asn1.ASN1Object),ee.asn1.cms.EncapsulatedContentInfo=function(e){var t=ee.asn1,n=t.DERTaggedObject,r=t.DERSequence,i=t.DERObjectIdentifier,s=t.DEROctetString;t.cms.EncapsulatedContentInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];if(t.push(new i(e.type)),void 0!=e.content&&(void 0!=e.content.hex||void 0!=e.content.str)&&1!=e.isDetached){var o=new s(e.content),a=new n({tag:"a0",explicit:!0,obj:o});t.push(a)}return new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.EncapsulatedContentInfo,ee.asn1.ASN1Object),ee.asn1.cms.ContentInfo=function(e){var t=ee.asn1,n=t.DERTaggedObject,r=t.DERSequence,i=t.DERObjectIdentifier;t.x509.OID.name2obj;ee.asn1.cms.ContentInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];t.push(new i(e.type));var s=new n({tag:"a0",explicit:!0,obj:e.obj});return t.push(s),new r({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.ContentInfo,ee.asn1.ASN1Object),ee.asn1.cms.SignedData=function(e){Error;var t=ee.asn1,n=(t.ASN1Object,t.DERInteger),r=t.DERSet,i=t.DERSequence,s=(t.DERTaggedObject,t.cms),o=s.EncapsulatedContentInfo,a=s.SignerInfo,c=s.ContentInfo,l=s.CertificateSet,u=s.RevocationInfoChoices,h=t.x509.AlgorithmIdentifier;ee.asn1.cms.SignedData.superclass.constructor.call(this),this.params=null,this.checkAndFixParam=function(){var e=this.params;this._setDigestAlgs(e),this._setContentTypeByEContent(e),this._setMessageDigestByEContent(e),this._setSignerInfoVersion(e),this._setSignedDataVersion(e)},this._setDigestAlgs=function(e){for(var t={},n=e.sinfos,r=0;r<n.length;r++){t[n[r].hashalg]=1}e.hashalgs=Object.keys(t).sort()},this._setContentTypeByEContent=function(e){for(var t=e.econtent.type,n=e.sinfos,r=0;r<n.length;r++){var i=n[r];this._getAttrParamByName(i,"contentType").type=t}},this._setMessageDigestByEContent=function(e){var t=e.econtent,n=(e.econtent.type,t.content.hex);void 0==n&&"data"==t.type&&void 0!=t.content.str&&(n=ge(t.content.str));for(var r=e.sinfos,i=0;i<r.length;i++){var s=r[i],o=s.hashalg,a=this._getAttrParamByName(s,"messageDigest"),c=ee.crypto.Util.hashHex(n,o);a.hex=c}},this._getAttrParamByName=function(e,t){for(var n=e.sattrs.array,r=0;r<n.length;r++)if(n[r].attr==t)return n[r]},this._setSignerInfoVersion=function(e){for(var t=e.sinfos,n=0;n<t.length;n++){var r=t[n],i=1;"skid"==r.id.type&&(i=3),r.version=i}},this._setSignedDataVersion=function(e){var t=this._getSignedDataVersion(e);e.version=t},this._getSignedDataVersion=function(e){if(void 0!=e.revinfos)for(var t=e.revinfos,n=0;n<t.length;n++){if(void 0!=t[n].ocsp)return 5}var r=e.sinfos;for(n=0;n<r.length;n++){if(3==e.sinfos[n].version)return 3}return"data"!=e.econtent.type?3:1},this.tohex=function(){var e=this.params;void 0!=this.getEncodedHexPrepare&&this.getEncodedHexPrepare(),1!=e.fixed&&this.checkAndFixParam();var t=[];t.push(new n({int:e.version}));for(var s=[],c=0;c<e.hashalgs.length;c++){var d=e.hashalgs[c];s.push(new h({name:d}))}t.push(new r({array:s})),t.push(new o(e.econtent)),void 0!=e.certs&&t.push(new l(e.certs)),void 0!=e.revinfos&&t.push(new u(e.revinfos));var f=[];for(c=0;c<e.sinfos.length;c++){var p=e.sinfos[c];f.push(new a(p))}return t.push(new r({array:f})),new i({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.getContentInfo=function(){return new c({type:"signed-data",obj:this})},this.getContentInfoEncodedHex=function(){return this.getContentInfo().tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.SignedData,ee.asn1.ASN1Object),ee.asn1.cms.CertificateSet=function(e){ee.asn1.cms.CertificateSet.superclass.constructor.call(this);var t=Error,n=ee.asn1,r=n.DERTaggedObject,i=n.DERSet,s=n.ASN1Object;this.params=null,this.tohex=function(){var e,n=this.params,o=[];if(n instanceof Array)e=n;else{if(void 0==n.array)throw new t("cert array not specified");e=n.array}for(var a=0;a<e.length;a++){var c=we(e[a]),l=new s;l.hTLV=c,o.push(l)}var u={array:o};0==n.sortflag&&(u.sortflag=!1);var h=new i(u);return new r({tag:"a0",explicit:!1,obj:h}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.CertificateSet,ee.asn1.ASN1Object),ee.asn1.cms.RevocationInfoChoices=function(e){ee.asn1.cms.RevocationInfoChoices.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(!e instanceof Array)throw new Error("params is not array");for(var t=[],n=0;n<e.length;n++)t.push(new ee.asn1.cms.RevocationInfoChoice(e[n]));return ee.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:{set:t}}}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.RevocationInfoChoices,ee.asn1.ASN1Object),ee.asn1.cms.RevocationInfoChoice=function(e){ee.asn1.cms.RevocationInfoChoice.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(void 0!=e.crl&&"string"==typeof e.crl){var t=e.crl;return-1!=e.crl.indexOf("-----BEGIN")&&(t=we(e.crl)),t}if(void 0!=e.ocsp)return ee.asn1.ASN1Util.newObject({tag:{tagi:"a1",obj:new ee.asn1.cms.OtherRevocationFormat(e)}}).tohex();throw new Error("property crl or ocsp undefined")},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.RevocationInfoChoice,ee.asn1.ASN1Object),ee.asn1.cms.OtherRevocationFormat=function(e){ee.asn1.cms.OtherRevocationFormat.superclass.constructor.call(this);var t=Error,n=ee,r=n.asn1.ASN1Util.newObject,i=n.lang.String.isHex;this.params=null,this.tohex=function(){var e=this.params;if(void 0==e.ocsp)throw new t("property ocsp not specified");if(!i(e.ocsp)||!re.isASN1HEX(e.ocsp))throw new t("ocsp value not ASN.1 hex string");return r({seq:[{oid:"1.3.6.1.5.5.7.16.2"},{asn1:{tlv:e.ocsp}}]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cms.OtherRevocationFormat,ee.asn1.ASN1Object),ee.asn1.cms.CMSUtil=new function(){},ee.asn1.cms.CMSUtil.newSignedData=function(e){return new ee.asn1.cms.SignedData(e)},ee.asn1.cms.CMSUtil.verifySignedData=function(e){var t=ee,n=t.asn1,r=n.cms,i=(r.SignerInfo,r.SignedData,r.SigningTime,r.SigningCertificate,r.SigningCertificateV2,n.cades.SignaturePolicyIdentifier,t.lang.String.isHex),s=re,o=s.getVbyList,a=s.getTLVbyList,c=s.getIdxbyList,l=s.getChildIdx,u=s.getTLV,h=s.oidname,d=t.crypto.Util.hashHex;void 0===e.cms&&i(e.cms);var f=e.cms,p=function(e,t){var n=t.idx;t.signerid_issuer1=a(e,n,[1,0],"30"),t.signerid_serial1=o(e,n,[1,1],"02"),t.hashalg=h(o(e,n,[2,0],"06"));var r=c(e,n,[3],"a0");t.idxSignedAttrs=r,m(e,t,r);var i=l(e,n).length;if(i<6)throw"malformed SignerInfo";t.sigalg=h(o(e,n,[i-2,0],"06")),t.sigval=o(e,n,[i-1],"04")},m=function(e,t,n){var r=l(e,n);t.signedAttrIdxList=r;for(var i=0;i<r.length;i++){var s,a=r[i],c=o(e,a,[0],"06");"2a864886f70d010905"===c?(s=fe(o(e,a,[1,0])),t.saSigningTime=s):"2a864886f70d010904"===c&&(s=o(e,a,[1,0],"04"),t.saMessageDigest=s)}},g=function(e,t,n,r){n.verifyDetail={};var i=n.verifyDetail,s=t.parse.econtent,o=n.hashalg,a=n.saMessageDigest;i.validMessageDigest=!1,d(s,o)===a&&(i.validMessageDigest=!0),function(e,t,n,r){var i,s=t.parse.certsIdx;if(void 0===t.certs){i=[],t.certkeys=[];for(var o=l(e,s),a=0;a<o.length;a++){var c=u(e,o[a]),h=new Ye;h.readCertHex(c),i[a]=h,t.certkeys[a]=h.getPublicKey()}t.certs=i}else i=t.certs;for(t.cccc=i.length,t.cccci=o.length,a=0;a<i.length;a++){var d=h.getIssuerHex(),f=h.getSerialNumberHex();n.signerid_issuer1===d&&n.signerid_serial1===f&&(n.certkey_idx=a)}}(e,t,n),i.validSignatureValue=!1;var c=n.sigalg,h="31"+u(e,n.idxSignedAttrs).substr(2);n.signedattrshex=h;var f=t.certs[n.certkey_idx].getPublicKey(),p=new ee.crypto.Signature({alg:c});p.init(f),p.updateHex(h);var m=p.verify(n.sigval);i.validSignatureValue_isValid=m,!0===m&&(i.validSignatureValue=!0),n.isValid=!1,i.validMessageDigest&&i.validSignatureValue&&(n.isValid=!0)},v={isValid:!1,parse:{}};return function(e,t){if("2a864886f70d010702"!==o(e,0,[0],"06"))return t;t.cmsType="signedData",t.econtent=o(e,0,[1,0,2,1,0]),function(e,t){for(var n,r=3;r<6;r++)if(void 0!==(n=c(e,0,[1,0,r]))){var i=e.substr(n,2);"a0"===i&&(t.certsIdx=n),"a1"===i&&(t.revinfosIdx=n),"31"===i&&(t.signerinfosIdx=n)}}(e,t),t.signerInfos=[],function(e,t){var n=t.signerinfosIdx;if(void 0!==n){var r=l(e,n);t.signerInfoIdxList=r;for(var i=0;i<r.length;i++){var s={idx:r[i]};p(e,s),t.signerInfos.push(s)}}}(e,t)}(f,v.parse),function(e,t){for(var n=t.parse.signerInfos,r=n.length,i=!0,s=0;s<r;s++){var o=n[s];g(e,t,o,s),o.isValid||(i=!1)}t.isValid=i}(f,v),v},ee.asn1.cms.CMSParser=function(){var e=Error,t=Ye,n=new t,r=re,i=r.getV,s=r.getTLV,o=(r.getIdxbyList,r.getTLVbyList),a=r.getTLVbyListEx,c=r.getVbyList,l=r.getVbyListEx,u=r.getChildIdx;this.getCMSSignedData=function(e){var t=o(e,0,[1,0]);return this.getSignedData(t)},this.getSignedData=function(e){var t=u(e,0),n={},r=i(e,t[0]),o=parseInt(r,16);n.version=o;var c=s(e,t[1]);n.hashalgs=this.getHashAlgArray(c);var l=s(e,t[2]);n.econtent=this.getEContent(l);var h=a(e,0,["[0]"]);null!=h&&(n.certs=this.getCertificateSet(h));a(e,0,["[1]"]);var d=a(e,0,[3]);return n.sinfos=this.getSignerInfos(d),n},this.getHashAlgArray=function(e){for(var n=u(e,0),r=new t,i=[],o=0;o<n.length;o++){var a=s(e,n[o]),c=r.getAlgorithmIdentifierName(a);i.push(c)}return i},this.getEContent=function(e){var t={},n=c(e,0,[0]),r=c(e,0,[1,0]);return t.type=ee.asn1.x509.OID.oid2name(re.hextooidstr(n)),t.content={hex:r},t},this.getSignerInfos=function(e){for(var t=[],n=u(e,0),r=0;r<n.length;r++){var i=s(e,n[r]),o=this.getSignerInfo(i);t.push(o)}return t},this.getSignerInfo=function(e){var t={},i=u(e,0),o=r.getInt(e,i[0],-1);-1!=o&&(t.version=o);var c=s(e,i[1]),h=this.getIssuerAndSerialNumber(c);t.id=h;var d=s(e,i[2]),f=n.getAlgorithmIdentifierName(d);t.hashalg=f;var p=a(e,0,["[0]"]);if(null!=p){var m=this.getAttributeList(p);t.sattrs=m}var g=a(e,0,[3]),v=n.getAlgorithmIdentifierName(g);t.sigalg=v;var y=l(e,0,[4]);t.sighex=y;var b=a(e,0,["[1]"]);if(null!=b){var S=this.getAttributeList(b);t.uattrs=S}return t},this.getSignerIdentifier=function(e){if("30"==e.substr(0,2))return this.getIssuerAndSerialNumber(e);throw new Error("SKID of signerIdentifier not supported")},this.getIssuerAndSerialNumber=function(e){var t={type:"isssn"},r=u(e,0),o=s(e,r[0]);t.issuer=n.getX500Name(o);var a=i(e,r[1]);return t.serial={hex:a},t},this.getAttributeList=function(e){for(var t=[],n=u(e,0),r=0;r<n.length;r++){var i=s(e,n[r]),o=this.getAttribute(i);t.push(o)}return{array:t}},this.getAttribute=function(e){var t={},n=u(e,0),i=r.getOID(e,n[0]),o=ee.asn1.x509.OID.oid2name(i);t.attr=o;var a=s(e,n[1]),c=u(a,0);if(1==c.length)t.valhex=s(a,c[0]);else{for(var l=[],h=0;h<c.length;h++)l.push(s(a,c[h]));t.valhex=l}return"contentType"==o?this.setContentType(t):"messageDigest"==o?this.setMessageDigest(t):"signingTime"==o?this.setSigningTime(t):"signingCertificate"==o?this.setSigningCertificate(t):"signingCertificateV2"==o?this.setSigningCertificateV2(t):"signaturePolicyIdentifier"==o&&this.setSignaturePolicyIdentifier(t),t},this.setContentType=function(e){var t=r.getOIDName(e.valhex,0,null);null!=t&&(e.type=t,delete e.valhex)},this.setSigningTime=function(e){var t=fe(i(e.valhex,0));e.str=t,delete e.valhex},this.setMessageDigest=function(e){var t=i(e.valhex,0);e.hex=t,delete e.valhex},this.setSigningCertificate=function(e){var t=u(e.valhex,0);if(t.length>0){for(var n=s(e.valhex,t[0]),r=u(n,0),i=[],o=0;o<r.length;o++){var a=s(n,r[o]),c=this.getESSCertID(a);i.push(c)}e.array=i}if(t.length>1){var l=s(e.valhex,t[1]);e.polhex=l}delete e.valhex},this.setSignaturePolicyIdentifier=function(e){var n=u(e.valhex,0);if(n.length>0){var o=r.getOID(e.valhex,n[0]);e.oid=o}if(n.length>1){var a=new t,c=u(e.valhex,n[1]),l=s(e.valhex,c[0]),h=a.getAlgorithmIdentifierName(l);e.alg=h;var d=i(e.valhex,c[1]);e.hash=d}delete e.valhex},this.setSigningCertificateV2=function(e){var t=u(e.valhex,0);if(t.length>0){for(var n=s(e.valhex,t[0]),r=u(n,0),i=[],o=0;o<r.length;o++){var a=s(n,r[o]),c=this.getESSCertIDv2(a);i.push(c)}e.array=i}if(t.length>1){var l=s(e.valhex,t[1]);e.polhex=l}delete e.valhex},this.getESSCertID=function(e){var t={},n=u(e,0);if(n.length>0){var r=i(e,n[0]);t.hash=r}if(n.length>1){var o=s(e,n[1]),a=this.getIssuerSerial(o);void 0!=a.serial&&(t.serial=a.serial),void 0!=a.issuer&&(t.issuer=a.issuer)}return t},this.getESSCertIDv2=function(t){var r={},o=u(t,0);if(o.length<1||3<o.length)throw new e("wrong number of elements");var a=0;if("30"==t.substr(o[0],2)){var c=s(t,o[0]);r.alg=n.getAlgorithmIdentifierName(c),a++}else r.alg="sha256";var l=i(t,o[a]);if(r.hash=l,o.length>a+1){var h=s(t,o[a+1]),d=this.getIssuerSerial(h);r.issuer=d.issuer,r.serial=d.serial}return r},this.getIssuerSerial=function(e){var t={},r=u(e,0),o=s(e,r[0]),a=n.getGeneralNames(o)[0].dn;t.issuer=a;var c=i(e,r[1]);return t.serial={hex:c},t},this.getCertificateSet=function(e){for(var t=u(e,0),n=[],r=0;r<t.length;r++){var i=s(e,t[r]);if("30"==i.substr(0,2)){var o=Se(i,"CERTIFICATE");n.push(o)}}return{array:n,sortflag:!1}}},"undefined"!=typeof ee&&ee||(ee={}),"undefined"!=typeof ee.asn1&&ee.asn1||(ee.asn1={}),"undefined"!=typeof ee.asn1.tsp&&ee.asn1.tsp||(ee.asn1.tsp={}),ee.asn1.tsp.TimeStampToken=function(e){var t=ee.asn1.tsp;t.TimeStampToken.superclass.constructor.call(this),this.params=null,this.getEncodedHexPrepare=function(){var e=new t.TSTInfo(this.params.econtent.content);this.params.econtent.content.hex=e.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.tsp.TimeStampToken,ee.asn1.cms.SignedData),ee.asn1.tsp.TSTInfo=function(e){Error;var t=ee.asn1,n=t.DERSequence,r=t.DERInteger,i=t.DERBoolean,s=t.DERGeneralizedTime,o=t.DERObjectIdentifier,a=t.DERTaggedObject,c=t.tsp,l=c.MessageImprint,u=c.Accuracy,h=(t.x509.X500Name,t.x509.GeneralName);if(c.TSTInfo.superclass.constructor.call(this),this.dVersion=new r({int:1}),this.dPolicy=null,this.dMessageImprint=null,this.dSerial=null,this.dGenTime=null,this.dAccuracy=null,this.dOrdering=null,this.dNonce=null,this.dTsa=null,this.tohex=function(){var e=[this.dVersion];if(null==this.dPolicy)throw new Error("policy shall be specified.");if(e.push(this.dPolicy),null==this.dMessageImprint)throw new Error("messageImprint shall be specified.");if(e.push(this.dMessageImprint),null==this.dSerial)throw new Error("serialNumber shall be specified.");if(e.push(this.dSerial),null==this.dGenTime)throw new Error("genTime shall be specified.");e.push(this.dGenTime),null!=this.dAccuracy&&e.push(this.dAccuracy),null!=this.dOrdering&&e.push(this.dOrdering),null!=this.dNonce&&e.push(this.dNonce),null!=this.dTsa&&e.push(this.dTsa);var t=new n({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e){if("string"==typeof e.policy){if(!e.policy.match(/^[0-9.]+$/))throw"policy shall be oid like 0.1.4.134";this.dPolicy=new o({oid:e.policy})}void 0!==e.messageImprint&&(this.dMessageImprint=new l(e.messageImprint)),void 0!==e.serial&&(this.dSerial=new r(e.serial)),void 0!==e.genTime&&(this.dGenTime=new s(e.genTime)),void 0!==e.accuracy&&(this.dAccuracy=new u(e.accuracy)),void 0!==e.ordering&&1==e.ordering&&(this.dOrdering=new i),void 0!==e.nonce&&(this.dNonce=new r(e.nonce)),void 0!==e.tsa&&(this.dTsa=new a({tag:"a0",explicit:!0,obj:new h({dn:e.tsa})}))}},Je(ee.asn1.tsp.TSTInfo,ee.asn1.ASN1Object),ee.asn1.tsp.Accuracy=function(e){var t=ee.asn1,n=t.ASN1Util.newObject;t.tsp.Accuracy.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return void 0!=e.seconds&&"number"==typeof e.seconds&&t.push({int:e.seconds}),void 0!=e.millis&&"number"==typeof e.millis&&t.push({tag:{tagi:"80",obj:{int:e.millis}}}),void 0!=e.micros&&"number"==typeof e.micros&&t.push({tag:{tagi:"81",obj:{int:e.micros}}}),n({seq:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.tsp.Accuracy,ee.asn1.ASN1Object),ee.asn1.tsp.MessageImprint=function(e){var t=ee.asn1,n=t.DERSequence,r=t.DEROctetString,i=t.x509.AlgorithmIdentifier;t.tsp.MessageImprint.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=new i({name:e.alg}),s=new r({hex:e.hash});return new n({array:[t,s]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Je(ee.asn1.tsp.MessageImprint,ee.asn1.ASN1Object),ee.asn1.tsp.TimeStampReq=function(e){var t=ee.asn1,n=t.DERSequence,r=t.DERInteger,i=t.DERBoolean,s=(t.ASN1Object,t.DERObjectIdentifier),o=t.tsp,a=o.MessageImprint;o.TimeStampReq.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return t.push(new r({int:1})),e.messageImprint instanceof ee.asn1.ASN1Object?t.push(e.messageImprint):t.push(new a(e.messageImprint)),void 0!=e.policy&&t.push(new s(e.policy)),void 0!=e.nonce&&t.push(new r(e.nonce)),1==e.certreq&&t.push(new i),new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.tsp.TimeStampReq,ee.asn1.ASN1Object),ee.asn1.tsp.TimeStampResp=function(e){var t=ee.asn1,n=t.DERSequence,r=(t.ASN1Object,t.tsp),i=r.PKIStatusInfo;r.TimeStampResp.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,s=[];if(void 0!=e.econtent||void 0!=e.tst)if(void 0!=e.statusinfo?s.push(new i(e.statusinfo)):s.push(new i("granted")),void 0!=e.econtent)s.push(new r.TimeStampToken(e).getContentInfo());else{if(!(e.tst instanceof t.ASN1Object))throw new Error("improper member tst value");s.push(e.tst)}else{if(void 0==e.statusinfo)throw new Error("parameter for token nor statusinfo not specified");s.push(new i(e.statusinfo))}return new n({array:s}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.tsp.TimeStampResp,ee.asn1.ASN1Object),ee.asn1.tsp.PKIStatusInfo=function(e){var t=Error,n=ee.asn1,r=n.DERSequence,i=n.tsp,s=i.PKIStatus,o=i.PKIFreeText,a=i.PKIFailureInfo;i.PKIStatusInfo.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,n=[];if("string"==typeof e)n.push(new s(e));else{if(void 0==e.status)throw new t("property 'status' unspecified");n.push(new s(e.status)),void 0!=e.statusstr&&n.push(new o(e.statusstr)),void 0!=e.failinfo&&n.push(new a(e.failinfo))}return new r({array:n}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.tsp.PKIStatusInfo,ee.asn1.ASN1Object),ee.asn1.tsp.PKIStatus=function(e){var t=Error,n=ee.asn1,r=n.DERInteger;n.tsp.PKIStatus.superclass.constructor.call(this);var i={granted:0,grantedWithMods:1,rejection:2,waiting:3,revocationWarning:4,revocationNotification:5};this.params=null,this.tohex=function(){var e,n=this.params;if("string"==typeof n)try{e=i[n]}catch(s){throw new t("undefined name: "+n)}else{if("number"!=typeof n)throw new t("unsupported params");e=n}return new r({int:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.tsp.PKIStatus,ee.asn1.ASN1Object),ee.asn1.tsp.PKIFreeText=function(e){var t=Error,n=ee.asn1,r=n.DERSequence,i=n.DERUTF8String;n.tsp.PKIFreeText.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(!e instanceof Array)throw new t("wrong params: not array");for(var n=[],s=0;s<e.length;s++)n.push(new i({str:e[s]}));return new r({array:n}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.tsp.PKIFreeText,ee.asn1.ASN1Object),ee.asn1.tsp.PKIFailureInfo=function(e){var t=Error,n=ee.asn1,r=n.DERBitString,i=n.tsp.PKIFailureInfo,s={badAlg:0,badRequest:2,badDataFormat:5,timeNotAvailable:14,unacceptedPolicy:15,unacceptedExtension:16,addInfoNotAvailable:17,systemFailure:25};i.superclass.constructor.call(this),this.params=null,this.getBinValue=function(){var e=this.params,n=0;if("number"==typeof e&&0<=e&&e<=25){for(var r=(n|=1<<e).toString(2),i="",o=r.length-1;o>=0;o--)i+=r[o];return i}if("string"==typeof e&&void 0!=s[e])return Ge([e],s);if("object"==typeof e&&void 0!=e.length)return Ge(e,s);throw new t("wrong params")},this.tohex=function(){this.params;var e=this.getBinValue();return new r({bin:e}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.tsp.PKIFailureInfo,ee.asn1.ASN1Object),ee.asn1.tsp.AbstractTSAAdapter=function(e){this.getTSTHex=function(e,t){throw"not implemented yet"}},ee.asn1.tsp.SimpleTSAAdapter=function(e){var t=ee,n=t.asn1.tsp,r=t.crypto.Util.hashHex;n.SimpleTSAAdapter.superclass.constructor.call(this),this.params=null,this.serial=0,this.getTSTHex=function(e,t){var i=r(e,t);this.params.econtent.content.messageImprint={alg:t,hash:i},this.params.econtent.content.serial={int:this.serial++};var s=Math.floor(1e9*Math.random());return this.params.econtent.content.nonce={int:s},new n.TimeStampToken(this.params).getContentInfoEncodedHex()},void 0!==e&&(this.params=e)},Je(ee.asn1.tsp.SimpleTSAAdapter,ee.asn1.tsp.AbstractTSAAdapter),ee.asn1.tsp.FixedTSAAdapter=function(e){var t=ee,n=t.asn1.tsp,r=t.crypto.Util.hashHex;n.FixedTSAAdapter.superclass.constructor.call(this),this.params=null,this.getTSTHex=function(e,t){var i=r(e,t);return this.params.econtent.content.messageImprint={alg:t,hash:i},new n.TimeStampToken(this.params).getContentInfoEncodedHex()},void 0!==e&&(this.params=e)},Je(ee.asn1.tsp.FixedTSAAdapter,ee.asn1.tsp.AbstractTSAAdapter),ee.asn1.tsp.TSPUtil=new function(){},ee.asn1.tsp.TSPUtil.newTimeStampToken=function(e){return new ee.asn1.tsp.TimeStampToken(e)},ee.asn1.tsp.TSPUtil.parseTimeStampReq=function(e){return(new ee.asn1.tsp.TSPParser).getTimeStampReq(e)},ee.asn1.tsp.TSPUtil.parseMessageImprint=function(e){return(new ee.asn1.tsp.TSPParser).getMessageImprint(e)},ee.asn1.tsp.TSPParser=function(){Error;var e=new Ye,t=re,n=t.getV,r=t.getTLV,i=t.getIdxbyList,s=(t.getTLVbyListEx,t.getChildIdx),o=["granted","grantedWithMods","rejection","waiting","revocationWarning","revocationNotification"],a={0:"badAlg",2:"badRequest",5:"badDataFormat",14:"timeNotAvailable",15:"unacceptedPolicy",16:"unacceptedExtension",17:"addInfoNotAvailable",25:"systemFailure"};this.getResponse=function(e){var t=s(e,0);if(1==t.length)return this.getPKIStatusInfo(r(e,t[0]));if(t.length>1){var n=this.getPKIStatusInfo(r(e,t[0])),i=r(e,t[1]),o=this.getToken(i);return o.statusinfo=n,o}},this.getToken=function(e){var t=(new ee.asn1.cms.CMSParser).getCMSSignedData(e);return this.setTSTInfo(t),t},this.setTSTInfo=function(e){var t=e.econtent;if("tstinfo"==t.type){var n=t.content.hex,r=this.getTSTInfo(n);t.content=r}},this.getTSTInfo=function(t){var i={},o=s(t,0),a=n(t,o[1]);i.policy=_e(a);var c=r(t,o[2]);i.messageImprint=this.getMessageImprint(c);var l=n(t,o[3]);i.serial={hex:l};var u=n(t,o[4]);i.genTime={str:fe(u)};var h=0;if(o.length>5&&"30"==t.substr(o[5],2)){var d=r(t,o[5]);i.accuracy=this.getAccuracy(d),h++}o.length>5+h&&"01"==t.substr(o[5+h],2)&&("ff"==n(t,o[5+h])&&(i.ordering=!0),h++);if(o.length>5+h&&"02"==t.substr(o[5+h],2)){var f=n(t,o[5+h]);i.nonce={hex:f},h++}if(o.length>5+h&&"a0"==t.substr(o[5+h],2)){var p=r(t,o[5+h]);p="30"+p.substr(2),pGeneralNames=e.getGeneralNames(p);var m=pGeneralNames[0].dn;i.tsa=m,h++}if(o.length>5+h&&"a1"==t.substr(o[5+h],2)){var g=r(t,o[5+h]);g="30"+g.substr(2);var v=e.getExtParamArray(g);i.ext=v,h++}return i},this.getAccuracy=function(e){for(var t={},r=s(e,0),i=0;i<r.length;i++){var o=e.substr(r[i],2),a=n(e,r[i]),c=parseInt(a,16);"02"==o?t.seconds=c:"80"==o?t.millis=c:"81"==o&&(t.micros=c)}return t},this.getMessageImprint=function(e){if("30"!=e.substr(0,2))throw new Error("head of messageImprint hex shall be x30");var r={},o=(s(e,0),i(e,0,[0,0])),a=n(e,o),c=t.hextooidstr(a),l=ee.asn1.x509.OID.oid2name(c);if(""==l)throw new Error("hashAlg name undefined: "+c);var u=l,h=i(e,0,[1]);return r.alg=u,r.hash=n(e,h),r},this.getPKIStatusInfo=function(e){var t={},i=s(e,0),a=0;try{var c=n(e,i[0]),l=parseInt(c,16);t.status=o[l]}catch(d){}if(i.length>1&&"30"==e.substr(i[1],2)){var u=r(e,i[1]);t.statusstr=this.getPKIFreeText(u),a++}if(i.length>a&&"03"==e.substr(i[1+a],2)){var h=r(e,i[1+a]);t.failinfo=this.getPKIFailureInfo(h)}return t},this.getPKIFreeText=function(e){for(var n=[],r=s(e,0),i=0;i<r.length;i++)n.push(t.getString(e,r[i]));return n},this.getPKIFailureInfo=function(e){var n=t.getInt(e,0);return void 0!=a[n]?a[n]:n},this.getTimeStampReq=function(e){var i={certreq:!1},o=s(e,0);if(o.length<2)throw new Error("TimeStampReq must have at least 2 items");var a=r(e,o[1]);i.messageImprint=ee.asn1.tsp.TSPUtil.parseMessageImprint(a);for(var c=2;c<o.length;c++){var l=o[c],u=e.substr(l,2);if("06"==u){var h=n(e,l);i.policy=t.hextooidstr(h)}"02"==u&&(i.nonce=n(e,l)),"01"==u&&(i.certreq=!0)}return i}},"undefined"!=typeof ee&&ee||(ee={}),"undefined"!=typeof ee.asn1&&ee.asn1||(ee.asn1={}),"undefined"!=typeof ee.asn1.cades&&ee.asn1.cades||(ee.asn1.cades={}),ee.asn1.cades.SignaturePolicyIdentifier=function(e){var t=ee.asn1.cades,n=t.SignaturePolicyId;t.SignaturePolicyIdentifier.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.15",this.params=null,this.getValueArray=function(){return[new n(this.params)]},this.setByParam=function(e){this.params=e},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cades.SignaturePolicyIdentifier,ee.asn1.cms.Attribute),ee.asn1.cades.SignaturePolicyId=function(e){var t=ee.asn1,n=t.DERSequence,r=t.DERObjectIdentifier,i=(t.x509.AlgorithmIdentifier,t.cades),s=i.SignaturePolicyId,o=i.OtherHashAlgAndValue;s.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,t=[];return t.push(new r(e.oid)),t.push(new o(e)),new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cades.SignaturePolicyId,ee.asn1.ASN1Object),ee.asn1.cades.OtherHashAlgAndValue=function(e){var t=Error,n=ee.asn1,r=n.DERSequence,i=n.DEROctetString,s=n.x509.AlgorithmIdentifier;n.cades.OtherHashAlgAndValue.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if(void 0==e.alg)throw new t("property 'alg' not specified");if(void 0==e.hash&&void 0==e.cert)throw new t("property 'hash' nor 'cert' not specified");var n=null;if(void 0!=e.hash)n=e.hash;else if(void 0!=e.cert){if("string"!=typeof e.cert)throw new t("cert not string");var o=e.cert;-1!=e.cert.indexOf("-----BEGIN")&&(o=we(e.cert)),n=ee.crypto.Util.hashHex(o,e.alg)}var a=[];return a.push(new s({name:e.alg})),a.push(new i({hex:n})),new r({array:a}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cades.OtherHashAlgAndValue,ee.asn1.ASN1Object),ee.asn1.cades.OtherHashValue=function(e){ee.asn1.cades.OtherHashValue.superclass.constructor.call(this);var t=Error,n=ee,r=(n.lang.String.isHex,n.asn1.DEROctetString);n.crypto.Util.hashHex;this.params=null,this.tohex=function(){var e=this.params;if(void 0==e.hash&&void 0==e.cert)throw new t("hash or cert not specified");var n=null;if(void 0!=e.hash)n=e.hash;else if(void 0!=e.cert){if("string"!=typeof e.cert)throw new t("cert not string");var i=e.cert;-1!=e.cert.indexOf("-----BEGIN")&&(i=we(e.cert)),n=ee.crypto.Util.hashHex(i,"sha1")}return new r({hex:n}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cades.OtherHashValue,ee.asn1.ASN1Object),ee.asn1.cades.SignatureTimeStamp=function(e){var t=Error,n=ee,r=n.lang.String.isHex,i=n.asn1,s=i.ASN1Object;i.x509;i.cades.SignatureTimeStamp.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.14",this.params=null,this.getValueArray=function(){var e=this.params;if(void 0!=e.tst){if(r(e.tst))return(i=new s).hTLV=e.tst,[i];if(e.tst instanceof s)return[e.tst];throw new t("params.tst has wrong value")}if(void 0!=e.res){var n=e.res;if(n instanceof s&&(n=n.tohex()),"string"!=typeof n||!r(n))throw new t("params.res has wrong value");var i;re.getTLVbyList(n,0,[1]);return(i=new s).hTLV=e.tst,[i]}},null!=e&&this.setByParam(e)},Je(ee.asn1.cades.SignatureTimeStamp,ee.asn1.cms.Attribute),ee.asn1.cades.CompleteCertificateRefs=function(e){var t=Error,n=ee,r=n.asn1,i=r.DERSequence,s=r.cades,o=s.OtherCertID,a=n.lang.String.isHex;s.CompleteCertificateRefs.superclass.constructor.call(this),this.typeOid="1.2.840.113549.1.9.16.2.21",this.params=null,this.getValueArray=function(){for(var e=this.params,n=[],r=0;r<e.array.length;r++){var s=e.array[r];if("string"==typeof s)if(-1!=s.indexOf("-----BEGIN"))s={cert:s};else{if(!a(s))throw new t("unsupported value: "+s);s={hash:s}}void 0!=e.alg&&void 0==s.alg&&(s.alg=e.alg),void 0!=e.hasis&&void 0==s.hasis&&(s.hasis=e.hasis);var c=new o(s);n.push(c)}return[new i({array:n})]},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cades.CompleteCertificateRefs,ee.asn1.cms.Attribute),ee.asn1.cades.OtherCertID=function(e){var t=ee.asn1,n=t.DERSequence,r=t.cms.IssuerSerial,i=t.cades,s=i.OtherHashValue,o=i.OtherHashAlgAndValue;i.OtherCertID.superclass.constructor.call(this),this.params=e,this.tohex=function(){var e=this.params;"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?e={cert:e}:_isHex(e)&&(e={hash:e}));var t=[],i=null;if(i=void 0!=e.alg?new o(e):new s(e),t.push(i),void 0!=e.cert&&1==e.hasis||void 0!=e.issuer&&void 0!=e.serial){var a=new r(e);t.push(a)}return new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cades.OtherCertID,ee.asn1.ASN1Object),ee.asn1.cades.OtherHash=function(e){Error;var t=ee,n=t.asn1,r=(n.cms,n.cades),i=r.OtherHashAlgAndValue,s=r.OtherHashValue,o=(t.crypto.Util.hashHex,t.lang.String.isHex);r.OtherHash.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?e={cert:e}:o(e)&&(e={hash:e}));return(void 0!=e.alg?new i(e):new s(e)).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.cades.OtherHash,ee.asn1.ASN1Object),ee.asn1.cades.CAdESUtil=new function(){},ee.asn1.cades.CAdESUtil.parseSignedDataForAddingUnsigned=function(e){return(new ee.asn1.cms.CMSParser).getCMSSignedData(e)},ee.asn1.cades.CAdESUtil.parseSignerInfoForAddingUnsigned=function(e,t,n){var r=re,i=r.getChildIdx,s=r.getTLV,o=r.getV,a=ee.asn1,c=a.ASN1Object,l=a.cms,u=l.AttributeList,h=l.SignerInfo,d={},f=i(e,t);if(6!=f.length)throw"not supported items for SignerInfo (!=6)";var p=f.shift();d.version=s(e,p);var m=f.shift();d.si=s(e,m);var g=f.shift();d.digalg=s(e,g);var v=f.shift();d.sattrs=s(e,v);var y=f.shift();d.sigalg=s(e,y);var b=f.shift();d.sig=s(e,b),d.sigval=o(e,b);var S=null;return d.obj=new h,(S=new c).hTLV=d.version,d.obj.dCMSVersion=S,(S=new c).hTLV=d.si,d.obj.dSignerIdentifier=S,(S=new c).hTLV=d.digalg,d.obj.dDigestAlgorithm=S,(S=new c).hTLV=d.sattrs,d.obj.dSignedAttrs=S,(S=new c).hTLV=d.sigalg,d.obj.dSigAlg=S,(S=new c).hTLV=d.sig,d.obj.dSig=S,d.obj.dUnsignedAttrs=new u,d},"undefined"!=typeof ee.asn1.csr&&ee.asn1.csr||(ee.asn1.csr={}),ee.asn1.csr.CertificationRequest=function(e){var t=ee.asn1,n=t.DERBitString,r=t.DERSequence,i=t.csr,s=(t.x509,i.CertificationRequestInfo);i.CertificationRequest.superclass.constructor.call(this),this.setByParam=function(e){this.params=e},this.sign=function(){var e=new s(this.params).tohex(),t=new ee.crypto.Signature({alg:this.params.sigalg});t.init(this.params.sbjprvkey),t.updateHex(e);var n=t.sign();this.params.sighex=n},this.getPEM=function(){return Se(this.tohex(),"CERTIFICATE REQUEST")},this.tohex=function(){var e=this.params,t=new ee.asn1.csr.CertificationRequestInfo(this.params),i=new ee.asn1.x509.AlgorithmIdentifier({name:e.sigalg});if(void 0==e.sighex&&void 0!=e.sbjprvkey&&this.sign(),void 0==e.sighex)throw new Error("sighex or sbjprvkey parameter not defined");var s=new n({hex:"00"+e.sighex});return new r({array:[t,i,s]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Je(ee.asn1.csr.CertificationRequest,ee.asn1.ASN1Object),ee.asn1.csr.CertificationRequestInfo=function(e){var t=ee.asn1,n=(t.DERBitString,t.DERSequence),r=t.DERInteger,i=t.DERUTF8String,s=t.DERTaggedObject,o=t.ASN1Util.newObject,a=t.csr,c=t.x509,l=c.X500Name,u=c.Extensions,h=c.SubjectPublicKeyInfo;a.AttributeList;a.CertificationRequestInfo.superclass.constructor.call(this),this.params=null,this.setByParam=function(e){void 0!=e&&(this.params=e)},this.tohex=function(){var e=this.params,t=[];if(t.push(new r({int:0})),t.push(new l(e.subject)),t.push(new h(Ze.getKey(e.sbjpubkey))),void 0!=e.attrs){var a=function(e){for(var t=Error,n=ee.asn1.x509.Extensions,r=[],i=0;i<e.length;i++){var s=e[i],o=s.attr;if("extensionRequest"==o){var a={seq:[{oid:"1.2.840.113549.1.9.14"},{set:[new n(s.ext)]}]};r.push(a)}else if("unstructuredName"==o){a={seq:[{oid:"1.2.840.113549.1.9.2"},{set:s.names}]};r.push(a)}else{if("challengePassword"!=o)throw new t("unknown CSR attribute");a={seq:[{oid:"1.2.840.113549.1.9.7"},{set:[{utf8str:s.password}]}]};r.push(a)}}return{set:r}}(e.attrs),c=o({tag:{tage:"a0",obj:a}});t.push(c)}else if(void 0!=e.extreq){var d=new u(e.extreq);c=o({tag:{tage:"a0",obj:{seq:[{oid:"1.2.840.113549.1.9.14"},{set:[d]}]}}});t.push(c)}else t.push(new s({tag:"a0",explicit:!1,obj:new i({str:""})}));return new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!=e&&this.setByParam(e)},Je(ee.asn1.csr.CertificationRequestInfo,ee.asn1.ASN1Object),ee.asn1.csr.AttributeList=function(e){},Je(ee.asn1.csr.AttributeList,ee.asn1.ASN1Object),ee.asn1.csr.CSRUtil=new function(){},ee.asn1.csr.CSRUtil.newCSRPEM=function(e){return new ee.asn1.csr.CertificationRequest(e).getPEM()},ee.asn1.csr.CSRUtil.getParam=function(e,t){var n=re,r=n.getV,i=n.getIdxbyList,s=n.getTLVbyList,o=n.getTLVbyListEx,a=n.getVbyListEx,c={};if(-1==e.indexOf("-----BEGIN CERTIFICATE REQUEST"))throw new Error("argument is not PEM file");var l=we(e,"CERTIFICATE REQUEST");t&&(c.tbs=s(l,0,[0]));try{var u=o(l,0,[0,1]);if("3000"==u)c.subject={};else{var h=new Ye;c.subject=h.getX500Name(u)}}catch(v){}var d=o(l,0,[0,2]),f=Ze.getKey(d,null,"pkcs8pub");c.sbjpubkey=Ze.getPEM(f,"PKCS8PUB");var p=function(e){var t=i(e,0,[0,3,0,0],"06");return"2a864886f70d01090e"!=r(e,t)?null:s(e,0,[0,3,0,1,0],"30")}(l);h=new Ye;null!=p&&(c.extreq=h.getExtParamArray(p));try{var m=o(l,0,[1],"30");h=new Ye;c.sigalg=h.getAlgorithmIdentifierName(m)}catch(v){}try{var g=a(l,0,[2]);c.sighex=g}catch(v){}return c},ee.asn1.csr.CSRUtil.verifySignature=function(e){try{var t=null;if("string"==typeof e&&-1!=e.indexOf("-----BEGIN CERTIFICATE REQUEST")?t=ee.asn1.csr.CSRUtil.getParam(e,!0):"object"==typeof e&&void 0!=e.sbjpubkey&&void 0!=e.sigalg&&void 0!=e.sighex&&void 0!=e.tbs&&(t=e),null==t)return!1;var n=new ee.crypto.Signature({alg:t.sigalg});return n.init(t.sbjpubkey),n.updateHex(t.tbs),n.verify(t.sighex)}catch(r){return alert(r),!1}},"undefined"!=typeof ee&&ee||(ee={}),"undefined"!=typeof ee.asn1&&ee.asn1||(ee.asn1={}),"undefined"!=typeof ee.asn1.ocsp&&ee.asn1.ocsp||(ee.asn1.ocsp={}),ee.asn1.ocsp.DEFAULT_HASH="sha1",ee.asn1.ocsp.OCSPResponse=function(e){ee.asn1.ocsp.OCSPResponse.superclass.constructor.call(this);ee.asn1.DEREnumerated;var t=ee.asn1.ASN1Util.newObject,n=ee.asn1.ocsp.ResponseBytes,r=["successful","malformedRequest","internalError","tryLater","_not_used_","sigRequired","unauthorized"];this.params=null,this._getStatusCode=function(){var e=this.params.resstatus;return"number"==typeof e?e:"string"!=typeof e?-1:r.indexOf(e)},this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params,r=this._getStatusCode();if(-1==r)throw new Error("responseStatus not supported: "+e.resstatus);if(0!=r)return t({seq:[{enum:{int:r}}]}).tohex();var i=new n(e);return t({seq:[{enum:{int:0}},{tag:{tag:"a0",explicit:!0,obj:i}}]}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Je(ee.asn1.ocsp.OCSPResponse,ee.asn1.ASN1Object),ee.asn1.ocsp.ResponseBytes=function(e){ee.asn1.ocsp.ResponseBytes.superclass.constructor.call(this);var t=ee.asn1,n=t.DERSequence,r=t.DERObjectIdentifier,i=t.DEROctetString,s=t.ocsp.BasicOCSPResponse;this.params=null,this.setByParam=function(e){this.params=e},this.tohex=function(){var e=this.params;if("ocspBasic"!=e.restype)throw new Error("not supported responseType: "+e.restype);var t=new s(e),o=[];return o.push(new r({name:"ocspBasic"})),o.push(new i({hex:t.tohex()})),new n({array:o}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Je(ee.asn1.ocsp.ResponseBytes,ee.asn1.ASN1Object),ee.asn1.ocsp.BasicOCSPResponse=function(e){ee.asn1.ocsp.BasicOCSPResponse.superclass.constructor.call(this);var t=Error,n=ee.asn1,r=n.ASN1Object,i=n.DERSequence,s=(n.DERGeneralizedTime,n.DERTaggedObject),o=n.DERBitString,a=(n.x509.Extensions,n.x509.AlgorithmIdentifier),c=n.ocsp;c.ResponderID;_SingleResponseList=c.SingleResponseList,_ResponseData=c.ResponseData,this.params=null,this.setByParam=function(e){this.params=e},this.sign=function(){var e=this.params,t=e.tbsresp.tohex(),n=new ee.crypto.Signature({alg:e.sigalg});n.init(e.reskey),n.updateHex(t),e.sighex=n.sign()},this.tohex=function(){var e=this.params;void 0==e.tbsresp&&(e.tbsresp=new _ResponseData(e)),void 0==e.sighex&&void 0!=e.reskey&&this.sign();var n=[];if(n.push(e.tbsresp),n.push(new a({name:e.sigalg})),n.push(new o({hex:"00"+e.sighex})),void 0!=e.certs&&void 0!=e.certs.length){for(var c=[],l=0;l<e.certs.length;l++){var u=e.certs[l],h=null;if(re.isASN1HEX(u))h=u;else{if(!u.match(/-----BEGIN/))throw new t("certs["+l+"] not hex or PEM");h=we(u)}c.push(new r({tlv:h}))}var d=new i({array:c});n.push(new s({tag:"a0",explicit:!0,obj:d}))}return new i({array:n}).tohex()},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Je(ee.asn1.ocsp.BasicOCSPResponse,ee.asn1.ASN1Object),ee.asn1.ocsp.ResponseData=function(e){ee.asn1.ocsp.ResponseData.superclass.constructor.call(this);var t=Error,n=ee.asn1,r=n.DERSequence,i=n.DERGeneralizedTime,s=n.DERTaggedObject,o=n.x509.Extensions,a=n.ocsp,c=a.ResponderID;_SingleResponseList=a.SingleResponseList,this.params=null,this.tohex=function(){var e=this.params;void 0!=e.respid&&new t("respid not specified"),void 0!=e.prodat&&new t("prodat not specified"),void 0!=e.array&&new t("array not specified");var n=[];if(n.push(new c(e.respid)),n.push(new i(e.prodat)),n.push(new _SingleResponseList(e.array)),void 0!=e.ext){var a=new o(e.ext);n.push(new s({tag:"a1",explicit:!0,obj:a}))}return new r({array:n}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},Je(ee.asn1.ocsp.ResponseData,ee.asn1.ASN1Object),ee.asn1.ocsp.ResponderID=function(e){ee.asn1.ocsp.ResponderID.superclass.constructor.call(this);var t=ee,n=t.asn1,r=n.ASN1Util.newObject,i=n.x509.X500Name,s=t.lang.String.isHex,o=Error;this.params=null,this.tohex=function(){var e=this.params;if(void 0!=e.key){var t,n=null;if("string"==typeof e.key){if(s(e.key)&&(n=e.key),e.key.match(/-----BEGIN CERTIFICATE/))null!=(t=new Ye(e.key).getExtSubjectKeyIdentifier())&&(n=t.kid.hex)}else if(e.key instanceof Ye)null!=(t=e.key.getExtSubjectKeyIdentifier())&&(n=t.kid.hex);if(null==n)throw new o("wrong key member value");return r({tag:{tag:"a2",explicit:!0,obj:{octstr:{hex:n}}}}).tohex()}if(void 0!=e.name){var a=null;if("string"==typeof e.name&&e.name.match(/-----BEGIN CERTIFICATE/))a=new Ye(e.name).getSubject();else e.name instanceof Ye?a=e.name.getSubject():"object"!=typeof e.name||void 0==e.name.array&&void 0==e.name.str||(a=e.name);if(null==a)throw new o("wrong name member value");return r({tag:{tag:"a1",explicit:!0,obj:new i(a)}}).tohex()}throw new o("key or name not specified")},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},Je(ee.asn1.ocsp.ResponderID,ee.asn1.ASN1Object),ee.asn1.ocsp.SingleResponseList=function(e){ee.asn1.ocsp.SingleResponseList.superclass.constructor.call(this);var t=ee.asn1,n=t.DERSequence,r=t.ocsp.SingleResponse;this.params=null,this.tohex=function(){var e=this.params;if("object"!=typeof e||void 0==e.length)throw new Error("params not specified properly");for(var t=[],i=0;i<e.length;i++)t.push(new r(e[i]));return new n({array:t}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},Je(ee.asn1.ocsp.SingleResponseList,ee.asn1.ASN1Object),ee.asn1.ocsp.SingleResponse=function(e){var t=Error,n=ee.asn1,r=n.DERSequence,i=n.DERGeneralizedTime,s=n.DERTaggedObject,o=n.ocsp,a=o.CertID,c=o.CertStatus,l=n.x509.Extensions;o.SingleResponse.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params,n=[];if(void 0==e.certid)throw new t("certid unspecified");if(void 0==e.status)throw new t("status unspecified");if(void 0==e.thisupdate)throw new t("thisupdate unspecified");if(n.push(new a(e.certid)),n.push(new c(e.status)),n.push(new i(e.thisupdate)),void 0!=e.nextupdate){var o=new i(e.nextupdate);n.push(new s({tag:"a0",explicit:!0,obj:o}))}if(void 0!=e.ext){var u=new l(e.ext);n.push(new s({tag:"a1",explicit:!0,obj:u}))}return new r({array:n}).tohex()},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},Je(ee.asn1.ocsp.SingleResponse,ee.asn1.ASN1Object),ee.asn1.ocsp.CertID=function(e){var t=ee,n=t.asn1,r=n.DEROctetString,i=n.DERInteger,s=n.DERSequence,o=n.x509.AlgorithmIdentifier,a=n.ocsp,c=(a.DEFAULT_HASH,t.crypto.Util.hashHex),l=Ye,u=re.getVbyList;a.CertID.superclass.constructor.call(this),this.DEFAULT_HASH="sha1",this.params=null,this.setByValue=function(e,t,n,r){void 0==r&&(r=this.DEFAULT_HASH),this.params={alg:r,issname:e,isskey:t,sbjsn:n}},this.setByCert=function(e,t,n){void 0==n&&(n=this.DEFAULT_HASH),this.params={alg:n,issuerCert:e,subjectCert:t}},this.getParamByCerts=function(e,t,n){void 0==n&&(n=this.DEFAULT_HASH);var r=new l(e),i=new l(t),s=c(r.getSubjectHex(),n),o=r.getPublicKeyHex();return{alg:n,issname:s,isskey:c(u(o,0,[1],"03",!0),n),sbjsn:i.getSerialNumberHex()}},this.tohex=function(){if("object"!=typeof this.params)throw new Error("params not set");var e,t,n,a,c=this.params;if(a=void 0==c.alg?this.DEFAULT_HASH:c.alg,void 0!=c.issuerCert&&void 0!=c.subjectCert){var l=this.getParamByCerts(c.issuerCert,c.subjectCert,a);e=l.issname,t=l.isskey,n=l.sbjsn}else{if(void 0==c.issname||void 0==c.isskey||void 0==c.sbjsn)throw new Error("required param members not defined");e=c.issname,t=c.isskey,n=c.sbjsn}var u=new o({name:a}),h=new r({hex:e}),d=new r({hex:t}),f=new i({hex:n}),p=new s({array:[u,h,d,f]});return this.hTLV=p.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&this.setByParam(e)},Je(ee.asn1.ocsp.CertID,ee.asn1.ASN1Object),ee.asn1.ocsp.CertStatus=function(e){ee.asn1.ocsp.CertStatus.superclass.constructor.call(this),this.params=null,this.tohex=function(){var e=this.params;if("good"==e.status)return"8000";if("unknown"==e.status)return"8200";if("revoked"==e.status){var t=[{gentime:{str:e.time}}];void 0!=e.reason&&t.push({tag:{tag:"a0",explicit:!0,obj:{enum:{int:e.reason}}}});var n={tag:"a1",explicit:!1,obj:{seq:t}};return ee.asn1.ASN1Util.newObject({tag:n}).tohex()}throw new Error("bad status")},this.getEncodedHex=function(){return this.tohex()},this.setByParam=function(e){this.params=e},void 0!==e&&this.setByParam(e)},Je(ee.asn1.ocsp.CertStatus,ee.asn1.ASN1Object),ee.asn1.ocsp.Request=function(e){var t=ee.asn1,n=t.DERSequence,r=t.ocsp;if(r.Request.superclass.constructor.call(this),this.dReqCert=null,this.dExt=null,this.tohex=function(){var e=[];if(null===this.dReqCert)throw"reqCert not set";e.push(this.dReqCert);var t=new n({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},"undefined"!==typeof e){var i=new r.CertID(e);this.dReqCert=i}},Je(ee.asn1.ocsp.Request,ee.asn1.ASN1Object),ee.asn1.ocsp.TBSRequest=function(e){var t=ee.asn1,n=t.DERSequence,r=t.ocsp;r.TBSRequest.superclass.constructor.call(this),this.version=0,this.dRequestorName=null,this.dRequestList=[],this.dRequestExt=null,this.setRequestListByParam=function(e){for(var t=[],n=0;n<e.length;n++){var i=new r.Request(e[0]);t.push(i)}this.dRequestList=t},this.tohex=function(){var e=[];if(0!==this.version)throw"not supported version: "+this.version;if(null!==this.dRequestorName)throw"requestorName not supported";var t=new n({array:this.dRequestList});if(e.push(t),null!==this.dRequestExt)throw"requestExtensions not supported";var r=new n({array:e});return this.hTLV=r.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&void 0!==e.reqList&&this.setRequestListByParam(e.reqList)},Je(ee.asn1.ocsp.TBSRequest,ee.asn1.ASN1Object),ee.asn1.ocsp.OCSPRequest=function(e){var t=ee.asn1,n=t.DERSequence,r=t.ocsp;if(r.OCSPRequest.superclass.constructor.call(this),this.dTbsRequest=null,this.dOptionalSignature=null,this.tohex=function(){var e=[];if(null===this.dTbsRequest)throw"tbsRequest not set";if(e.push(this.dTbsRequest),null!==this.dOptionalSignature)throw"optionalSignature not supported";var t=new n({array:e});return this.hTLV=t.tohex(),this.hTLV},this.getEncodedHex=function(){return this.tohex()},void 0!==e&&void 0!==e.reqList){var i=new r.TBSRequest(e);this.dTbsRequest=i}},Je(ee.asn1.ocsp.OCSPRequest,ee.asn1.ASN1Object),ee.asn1.ocsp.OCSPUtil={},ee.asn1.ocsp.OCSPUtil.getRequestHex=function(e,t,n){var r=ee.asn1.ocsp;void 0===n&&(n=r.DEFAULT_HASH);var i={alg:n,issuerCert:e,subjectCert:t};return new r.OCSPRequest({reqList:[i]}).tohex()},ee.asn1.ocsp.OCSPUtil.getOCSPResponseInfo=function(e){var t=re,n=t.getVbyList,r=t.getVbyListEx,i=t.getIdxbyList,s=(t.getIdxbyListEx,t.getV),o={};try{var a=r(e,0,[0],"0a");o.responseStatus=parseInt(a,16)}catch(h){}if(0!==o.responseStatus)return o;try{var c=i(e,0,[1,0,1,0,0,2,0,1]);"80"===e.substr(c,2)?o.certStatus="good":"a1"===e.substr(c,2)?(o.certStatus="revoked",o.revocationTime=fe(n(e,c,[0]))):"82"===e.substr(c,2)&&(o.certStatus="unknown")}catch(h){}try{var l=i(e,0,[1,0,1,0,0,2,0,2]);o.thisUpdate=fe(s(e,l))}catch(h){}try{var u=i(e,0,[1,0,1,0,0,2,0,3]);"a0"===e.substr(u,2)&&(o.nextUpdate=fe(n(e,u,[0])))}catch(h){}return o},ee.asn1.ocsp.OCSPParser=function(){var e=Error,t=Ye,n=new t,r=re,i=r.getV,s=r.getTLV,o=r.getIdxbyList,a=r.getVbyList,c=r.getTLVbyList,l=r.getVbyListEx,u=r.getTLVbyListEx,h=r.getChildIdx;this.getOCSPRequest=function(t){var n=h(t,0);if(1!=n.length&&2!=n.length)throw new e("wrong number elements: "+n.length);return this.getTBSRequest(s(t,n[0]))},this.getTBSRequest=function(e){var t={},r=u(e,0,[0],"30");t.array=this.getRequestList(r);var i=u(e,0,["[2]",0],"30");return null!=i&&(t.ext=n.getExtParamArray(i)),t},this.getRequestList=function(e){for(var t=[],n=h(e,0),r=0;r<n.length;r++){e=s(e,n[r]);t.push(this.getRequest(e))}return t},this.getRequest=function(t){var r=h(t,0);if(1!=r.length&&2!=r.length)throw new e("wrong number elements: "+r.length);var i=this.getCertID(s(t,r[0]));if(2==r.length){var a=o(t,0,[1,0]);i.ext=n.getExtParamArray(s(t,a))}return i},this.getCertID=function(n){var r=h(n,0);if(4!=r.length)throw new e("wrong number elements: "+r.length);var o=new t,a={};return a.alg=o.getAlgorithmIdentifierName(s(n,r[0])),a.issname=i(n,r[1]),a.isskey=i(n,r[2]),a.sbjsn=i(n,r[3]),a},this.getOCSPResponse=function(e){var t,n=h(e,0),r=i(e,n[0]),s=parseInt(r);if(1==n.length)return{resstatus:s};var o=c(e,0,[1,0]);return(t=this.getResponseBytes(o)).resstatus=s,t},this.getResponseBytes=function(e){var t,n=h(e,0),r=c(e,0,[1,0]);t=this.getBasicOCSPResponse(r);var s=i(e,n[0]);return t.restype=ee.asn1.x509.OID.oid2name(_e(s)),t},this.getBasicOCSPResponse=function(e){var t,n=h(e,0);t=this.getResponseData(s(e,n[0]));var r=new Ye;t.alg=r.getAlgorithmIdentifierName(s(e,n[1]));var o=i(e,n[2]);t.sighex=o.substr(2);var a=l(e,0,["[0]"]);if(null!=a){for(var c=h(a,0),u=[],d=0;d<c.length;d++){var f=s(a,c[d]);u.push(f)}t.certs=u}return t},this.getResponseData=function(e){var t=h(e,0),n=t.length,r={},o=0;"a0"==e.substr(t[0],2)&&o++,r.respid=this.getResponderID(s(e,t[o++]));var a=i(e,t[o++]);if(r.prodat=fe(a),r.array=this.getSingleResponseList(s(e,t[o++])),"a1"==e.substr(t[n-1],2)){var l=c(e,t[n-1],[0]),u=new Ye;r.ext=u.getExtParamArray(l)}return r},this.getResponderID=function(e){var t={};if("a2"==e.substr(0,2)){var n=a(e,0,[0]);t.key=n}if("a1"==e.substr(0,2)){var r=c(e,0,[0]),i=new Ye;t.name=i.getX500Name(r)}return t},this.getSingleResponseList=function(e){for(var t=h(e,0),n=[],r=0;r<t.length;r++){var i=this.getSingleResponse(s(e,t[r]));n.push(i)}return n},this.getSingleResponse=function(e){var t=h(e,0),n={},r=this.getCertID(s(e,t[0]));n.certid=r;var o=this.getCertStatus(s(e,t[1]));if(n.status=o,"18"==e.substr(t[2],2)){var l=i(e,t[2]);n.thisupdate=fe(l)}for(var u=3;u<t.length;u++){if("a0"==e.substr(t[u],2)){var d=a(e,t[u],[0],"18");n.nextupdate=fe(d)}if("a1"==e.substr(t[u],2)){var f=new Ye,p=c(e,0,[u,0]);n.ext=f.getExtParamArray(p)}}return n},this.getCertStatus=function(e){var t={};if("8000"==e)return{status:"good"};if("8200"==e)return{status:"unknown"};if("a1"==e.substr(0,2)){t.status="revoked";var n=fe(a(e,0,[0]));t.time=n}return t}},"undefined"!=typeof ee&&ee||(ee={}),"undefined"!=typeof ee.lang&&ee.lang||(ee.lang={}),ee.lang.String=function(){},"function"===typeof Buffer?(te=function(e){return ce(Buffer.from(e,"utf8").toString("base64"))},ne=function(e){return Buffer.from(le(e),"base64").toString("utf8")}):(te=function(e){return ue(Te(Re(e)))},ne=function(e){return decodeURIComponent(ke(he(e)))}),ee.lang.String.isInteger=function(e){return!!e.match(/^[0-9]+$/)||!!e.match(/^-[0-9]+$/)},ee.lang.String.isHex=function(e){return Me(e)},ee.lang.String.isBase64=function(e){return!(!(e=e.replace(/\s+/g,"")).match(/^[0-9A-Za-z+\/]+={0,3}$/)||e.length%4!=0)},ee.lang.String.isBase64URL=function(e){return!e.match(/[+/=]/)&&(e=le(e),ee.lang.String.isBase64(e))},ee.lang.String.isIntegerArray=function(e){return!!(e=e.replace(/\s+/g,"")).match(/^\[[0-9,]+\]$/)},ee.lang.String.isPrintable=function(e){return null!==e.match(/^[0-9A-Za-z '()+,-./:=?]*$/)},ee.lang.String.isIA5=function(e){return null!==e.match(/^[\x20-\x21\x23-\x7f]*$/)},ee.lang.String.isMail=function(e){return null!==e.match(/^[A-Za-z0-9]{1}[A-Za-z0-9_.-]*@{1}[A-Za-z0-9_.-]{1,}\.[A-Za-z0-9]{1,}$/)};function qe(e){var t=function(e){var t=e.toString(16);return 1==t.length&&(t="0"+t),t},n=function(e){var n="",r=parseInt(e,10).toString(2),i=7-r.length%7;7==i&&(i=0);for(var s="",o=0;o<i;o++)s+="0";r=s+r;for(o=0;o<r.length-1;o+=7){var a=r.substr(o,7);o!=r.length-7&&(a="1"+a),n+=t(parseInt(a,2))}return n};try{if(!e.match(/^[0-9.]+$/))return null;var r="",i=e.split("."),s=40*parseInt(i[0],10)+parseInt(i[1],10);r+=t(s),i.splice(0,2);for(var o=0;o<i.length;o++)r+=n(i[o]);return r}catch(a){return null}}function _e(e){if(!Me(e))return null;try{var t=[],n=e.substr(0,2),r=parseInt(n,16);t[0]=new String(Math.floor(r/40)),t[1]=new String(r%40);for(var i=e.substr(2),s=[],o=0;o<i.length/2;o++)s.push(parseInt(i.substr(2*o,2),16));var a=[],c="";for(o=0;o<s.length;o++)128&s[o]?c+=Ue((127&s[o]).toString(2),7):(c+=Ue((127&s[o]).toString(2),7),a.push(new String(parseInt(c,2))),c="");var l=t.join(".");return a.length>0&&(l=l+"."+a.join(".")),l}catch(u){return null}}function je(e){return ze(new h(String(e),10))}function ze(e){var t=e.toString(16);if("-"!=t.substr(0,1))return t.length%2==1?t="0"+t:t.match(/^[0-7]/)||(t="00"+t),t;var n=t.substr(1).length;n%2==1?n+=1:t.match(/^[0-7]/)||(n+=2);for(var r="",i=0;i<n;i++)r+="f";return t=new h(r,16).xor(e).add(h.ONE).toString(16).replace(/^-/,"")}var Ue=function(e,t,n){return void 0==n&&(n="0"),e.length>=t?e:new Array(t-e.length+1).join(n)+e};function He(e){if(e.length%2!=0)return-1;if(null==(e=e.toLowerCase()).match(/^[0-9a-f]+$/))return-1;try{var t=e.substr(0,2);if("00"==t)return parseInt(e.substr(2),16);var n=parseInt(t,16);if(n>7)return-1;var r=e.substr(2),i=parseInt(r,16).toString(2);"0"==i&&(i="00000000"),i=i.slice(0,0-n);var s=parseInt(i,2);return NaN==s?-1:s}catch(o){return-1}}function Ve(e){if("number"!=typeof e)return null;if(e<0)return null;var t=Number(e).toString(2),n=8-t.length%8;8==n&&(n=0),t+=Ue("",n,"0");var r=parseInt(t,2).toString(16);return r.length%2==1&&(r="0"+r),"0"+n+r}function Ke(e){if("string"!=typeof e)return null;if(e.length%2!=0)return null;if(!e.match(/^[0-9a-f]+$/))return null;try{var t=parseInt(e.substr(0,2),16);if(t<0||7<t)return null;for(var n=e.substr(2),r="",i=0;i<n.length;i+=2){var s=n.substr(i,2),o=parseInt(s,16).toString(2);r+=o=("0000000"+o).slice(-8)}return r.substr(0,r.length-t)}catch(a){return null}}function Ge(e,t){for(var n=0,r=0;r<e.length;r++)n|=1<<t[e[r]];var i=n.toString(2),s="";for(r=i.length-1;r>=0;r--)s+=i[r];return s}function We(e,t,n){if("object"==typeof e){t=String(t).split(".");for(var r=0;r<t.length&&e;r++){var i=t[r];i.match(/^[0-9]+$/)&&(i=parseInt(i)),e=e[i]}return e||!1===e?e:n}}function Je(e,t){var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e,e.superclass=t.prototype,t.prototype.constructor==Object.prototype.constructor&&(t.prototype.constructor=t)}"undefined"!=typeof ee&&ee||(ee={}),"undefined"!=typeof ee.crypto&&ee.crypto||(ee.crypto={}),ee.crypto.Util=new function(){this.DIGESTINFOHEAD={sha1:"3021300906052b0e03021a05000414",sha224:"302d300d06096086480165030402040500041c",sha256:"3031300d060960864801650304020105000420",sha384:"3041300d060960864801650304020205000430",sha512:"3051300d060960864801650304020305000440",md2:"3020300c06082a864886f70d020205000410",md5:"3020300c06082a864886f70d020505000410",ripemd160:"3021300906052b2403020105000414"},this.DEFAULTPROVIDER={md5:"cryptojs",sha1:"cryptojs",sha224:"cryptojs",sha256:"cryptojs",sha384:"cryptojs",sha512:"cryptojs",ripemd160:"cryptojs",hmacmd5:"cryptojs",hmacsha1:"cryptojs",hmacsha224:"cryptojs",hmacsha256:"cryptojs",hmacsha384:"cryptojs",hmacsha512:"cryptojs",hmacripemd160:"cryptojs",MD5withRSA:"cryptojs/jsrsa",SHA1withRSA:"cryptojs/jsrsa",SHA224withRSA:"cryptojs/jsrsa",SHA256withRSA:"cryptojs/jsrsa",SHA384withRSA:"cryptojs/jsrsa",SHA512withRSA:"cryptojs/jsrsa",RIPEMD160withRSA:"cryptojs/jsrsa",MD5withECDSA:"cryptojs/jsrsa",SHA1withECDSA:"cryptojs/jsrsa",SHA224withECDSA:"cryptojs/jsrsa",SHA256withECDSA:"cryptojs/jsrsa",SHA384withECDSA:"cryptojs/jsrsa",SHA512withECDSA:"cryptojs/jsrsa",RIPEMD160withECDSA:"cryptojs/jsrsa",SHA1withDSA:"cryptojs/jsrsa",SHA224withDSA:"cryptojs/jsrsa",SHA256withDSA:"cryptojs/jsrsa",MD5withRSAandMGF1:"cryptojs/jsrsa",SHAwithRSAandMGF1:"cryptojs/jsrsa",SHA1withRSAandMGF1:"cryptojs/jsrsa",SHA224withRSAandMGF1:"cryptojs/jsrsa",SHA256withRSAandMGF1:"cryptojs/jsrsa",SHA384withRSAandMGF1:"cryptojs/jsrsa",SHA512withRSAandMGF1:"cryptojs/jsrsa",RIPEMD160withRSAandMGF1:"cryptojs/jsrsa"},this.CRYPTOJSMESSAGEDIGESTNAME={md5:i.algo.MD5,sha1:i.algo.SHA1,sha224:i.algo.SHA224,sha256:i.algo.SHA256,sha384:i.algo.SHA384,sha512:i.algo.SHA512,ripemd160:i.algo.RIPEMD160},this.getDigestInfoHex=function(e,t){if("undefined"==typeof this.DIGESTINFOHEAD[t])throw"alg not supported in Util.DIGESTINFOHEAD: "+t;return this.DIGESTINFOHEAD[t]+e},this.getPaddedDigestInfoHex=function(e,t,n){var r=this.getDigestInfoHex(e,t),i=n/4;if(r.length+22>i)throw"key is too short for SigAlg: keylen="+n+","+t;for(var s="0001",o="00"+r,a="",c=i-4-o.length,l=0;l<c;l+=2)a+="ff";return s+a+o},this.hashString=function(e,t){return new ee.crypto.MessageDigest({alg:t}).digestString(e)},this.hashHex=function(e,t){return new ee.crypto.MessageDigest({alg:t}).digestHex(e)},this.sha1=function(e){return this.hashString(e,"sha1")},this.sha256=function(e){return this.hashString(e,"sha256")},this.sha256Hex=function(e){return this.hashHex(e,"sha256")},this.sha512=function(e){return this.hashString(e,"sha512")},this.sha512Hex=function(e){return this.hashHex(e,"sha512")},this.isKey=function(e){return e instanceof J||e instanceof ee.crypto.DSA||e instanceof ee.crypto.ECDSA}},ee.crypto.Util.md5=function(e){return new ee.crypto.MessageDigest({alg:"md5",prov:"cryptojs"}).digestString(e)},ee.crypto.Util.ripemd160=function(e){return new ee.crypto.MessageDigest({alg:"ripemd160",prov:"cryptojs"}).digestString(e)},ee.crypto.Util.SECURERANDOMGEN=new K,ee.crypto.Util.getRandomHexOfNbytes=function(e){var t=new Array(e);return ee.crypto.Util.SECURERANDOMGEN.nextBytes(t),oe(t)},ee.crypto.Util.getRandomBigIntegerOfNbytes=function(e){return new h(ee.crypto.Util.getRandomHexOfNbytes(e),16)},ee.crypto.Util.getRandomHexOfNbits=function(e){var t=e%8,n=new Array((e-t)/8+1);return ee.crypto.Util.SECURERANDOMGEN.nextBytes(n),n[0]=(255<<t&255^255)&n[0],oe(n)},ee.crypto.Util.getRandomBigIntegerOfNbits=function(e){return new h(ee.crypto.Util.getRandomHexOfNbits(e),16)},ee.crypto.Util.getRandomBigIntegerZeroToMax=function(e){for(var t=e.bitLength();;){var n=ee.crypto.Util.getRandomBigIntegerOfNbits(t);if(-1!=e.compareTo(n))return n}},ee.crypto.Util.getRandomBigIntegerMinToMax=function(e,t){var n=e.compareTo(t);if(1==n)throw"biMin is greater than biMax";if(0==n)return e;var r=t.subtract(e);return ee.crypto.Util.getRandomBigIntegerZeroToMax(r).add(e)},ee.crypto.MessageDigest=function(e){this.setAlgAndProvider=function(e,t){if(null!==(e=ee.crypto.MessageDigest.getCanonicalAlgName(e))&&void 0===t&&(t=ee.crypto.Util.DEFAULTPROVIDER[e]),-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(e)&&"cryptojs"==t){try{this.md=ee.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[e].create()}catch(n){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+n}this.updateString=function(e){this.md.update(e)},this.updateHex=function(e){var t=i.enc.Hex.parse(e);this.md.update(t)},this.digest=function(){return this.md.finalize().toString(i.enc.Hex)},this.digestString=function(e){return this.updateString(e),this.digest()},this.digestHex=function(e){return this.updateHex(e),this.digest()}}if(-1!=":sha256:".indexOf(e)&&"sjcl"==t){try{this.md=new sjcl.hash.sha256}catch(n){throw"setAlgAndProvider hash alg set fail alg="+e+"/"+n}this.updateString=function(e){this.md.update(e)},this.updateHex=function(e){var t=sjcl.codec.hex.toBits(e);this.md.update(t)},this.digest=function(){var e=this.md.finalize();return sjcl.codec.hex.fromBits(e)},this.digestString=function(e){return this.updateString(e),this.digest()},this.digestHex=function(e){return this.updateHex(e),this.digest()}}},this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digest=function(){throw"digest() not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algName+"/"+this.provName},this.digestHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algName+"/"+this.provName},void 0!==e&&void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=ee.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName))},ee.crypto.MessageDigest.getCanonicalAlgName=function(e){return"string"===typeof e&&(e=(e=e.toLowerCase()).replace(/-/,"")),e},ee.crypto.MessageDigest.getHashLength=function(e){var t=ee.crypto.MessageDigest,n=t.getCanonicalAlgName(e);if(void 0===t.HASHLENGTH[n])throw"not supported algorithm: "+e;return t.HASHLENGTH[n]},ee.crypto.MessageDigest.HASHLENGTH={md5:16,sha1:20,sha224:28,sha256:32,sha384:48,sha512:64,ripemd160:20},ee.crypto.Mac=function(e){this.setAlgAndProvider=function(e,t){if(null==(e=e.toLowerCase())&&(e="hmacsha1"),"hmac"!=(e=e.toLowerCase()).substr(0,4))throw"setAlgAndProvider unsupported HMAC alg: "+e;void 0===t&&(t=ee.crypto.Util.DEFAULTPROVIDER[e]),this.algProv=e+"/"+t;var n=e.substr(4);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(n)&&"cryptojs"==t){try{var r=ee.crypto.Util.CRYPTOJSMESSAGEDIGESTNAME[n];this.mac=i.algo.HMAC.create(r,this.pass)}catch(s){throw"setAlgAndProvider hash alg set fail hashAlg="+n+"/"+s}this.updateString=function(e){this.mac.update(e)},this.updateHex=function(e){var t=i.enc.Hex.parse(e);this.mac.update(t)},this.doFinal=function(){return this.mac.finalize().toString(i.enc.Hex)},this.doFinalString=function(e){return this.updateString(e),this.doFinal()},this.doFinalHex=function(e){return this.updateHex(e),this.doFinal()}}},this.updateString=function(e){throw"updateString(str) not supported for this alg/prov: "+this.algProv},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg/prov: "+this.algProv},this.doFinal=function(){throw"digest() not supported for this alg/prov: "+this.algProv},this.doFinalString=function(e){throw"digestString(str) not supported for this alg/prov: "+this.algProv},this.doFinalHex=function(e){throw"digestHex(hex) not supported for this alg/prov: "+this.algProv},this.setPassword=function(e){if("string"==typeof e){var t=e;return e.length%2!=1&&e.match(/^[0-9A-Fa-f]+$/)||(t=ge(e)),void(this.pass=i.enc.Hex.parse(t))}if("object"!=typeof e)throw"KJUR.crypto.Mac unsupported password type: "+e;t=null;if(void 0!==e.hex){if(e.hex.length%2!=0||!e.hex.match(/^[0-9A-Fa-f]+$/))throw"Mac: wrong hex password: "+e.hex;t=e.hex}if(void 0!==e.utf8&&(t=de(e.utf8)),void 0!==e.rstr&&(t=ge(e.rstr)),void 0!==e.b64&&(t=l(e.b64)),void 0!==e.b64u&&(t=he(e.b64u)),null==t)throw"KJUR.crypto.Mac unsupported password type: "+e;this.pass=i.enc.Hex.parse(t)},void 0!==e&&(void 0!==e.pass&&this.setPassword(e.pass),void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov&&(this.provName=ee.crypto.Util.DEFAULTPROVIDER[this.algName]),this.setAlgAndProvider(this.algName,this.provName)))},ee.crypto.Signature=function(e){var t=null;if(this._setAlgNames=function(){var e=this.algName.match(/^(.+)with(.+)$/);e&&(this.mdAlgName=e[1].toLowerCase(),this.pubkeyAlgName=e[2].toLowerCase(),"rsaandmgf1"==this.pubkeyAlgName&&"sha"==this.mdAlgName&&(this.mdAlgName="sha1"))},this._zeroPaddingOfSignature=function(e,t){for(var n="",r=t/4-e.length,i=0;i<r;i++)n+="0";return n+e},this.setAlgAndProvider=function(e,t){if(this._setAlgNames(),"cryptojs/jsrsa"!=t)throw new Error("provider not supported: "+t);if(-1!=":md5:sha1:sha224:sha256:sha384:sha512:ripemd160:".indexOf(this.mdAlgName)){try{this.md=new ee.crypto.MessageDigest({alg:this.mdAlgName})}catch(n){throw new Error("setAlgAndProvider hash alg set fail alg="+this.mdAlgName+"/"+n)}this.init=function(e,t){var n=null;try{n=void 0===t?Ze.getKey(e):Ze.getKey(e,t)}catch(r){throw"init failed:"+r}if(!0===n.isPrivate)this.prvKey=n,this.state="SIGN";else{if(!0!==n.isPublic)throw"init failed.:"+n;this.pubKey=n,this.state="VERIFY"}},this.updateString=function(e){this.md.updateString(e)},this.updateHex=function(e){this.md.updateHex(e)},this.sign=function(){if(this.sHashHex=this.md.digest(),void 0===this.prvKey&&void 0!==this.ecprvhex&&void 0!==this.eccurvename&&void 0!==ee.crypto.ECDSA&&(this.prvKey=new ee.crypto.ECDSA({curve:this.eccurvename,prv:this.ecprvhex})),this.prvKey instanceof J&&"rsaandmgf1"===this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHashPSS(this.sHashHex,this.mdAlgName,this.pssSaltLen);else if(this.prvKey instanceof J&&"rsa"===this.pubkeyAlgName)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex,this.mdAlgName);else if(this.prvKey instanceof ee.crypto.ECDSA)this.hSign=this.prvKey.signWithMessageHash(this.sHashHex);else{if(!(this.prvKey instanceof ee.crypto.DSA))throw"Signature: unsupported private key alg: "+this.pubkeyAlgName;this.hSign=this.prvKey.signWithMessageHash(this.sHashHex)}return this.hSign},this.signString=function(e){return this.updateString(e),this.sign()},this.signHex=function(e){return this.updateHex(e),this.sign()},this.verify=function(e){if(this.sHashHex=this.md.digest(),void 0===this.pubKey&&void 0!==this.ecpubhex&&void 0!==this.eccurvename&&void 0!==ee.crypto.ECDSA&&(this.pubKey=new ee.crypto.ECDSA({curve:this.eccurvename,pub:this.ecpubhex})),this.pubKey instanceof J&&"rsaandmgf1"===this.pubkeyAlgName)return this.pubKey.verifyWithMessageHashPSS(this.sHashHex,e,this.mdAlgName,this.pssSaltLen);if(this.pubKey instanceof J&&"rsa"===this.pubkeyAlgName)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);if(void 0!==ee.crypto.ECDSA&&this.pubKey instanceof ee.crypto.ECDSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);if(void 0!==ee.crypto.DSA&&this.pubKey instanceof ee.crypto.DSA)return this.pubKey.verifyWithMessageHash(this.sHashHex,e);throw"Signature: unsupported public key alg: "+this.pubkeyAlgName}}},this.init=function(e,t){throw"init(key, pass) not supported for this alg:prov="+this.algProvName},this.updateString=function(e){throw"updateString(str) not supported for this alg:prov="+this.algProvName},this.updateHex=function(e){throw"updateHex(hex) not supported for this alg:prov="+this.algProvName},this.sign=function(){throw"sign() not supported for this alg:prov="+this.algProvName},this.signString=function(e){throw"digestString(str) not supported for this alg:prov="+this.algProvName},this.signHex=function(e){throw"digestHex(hex) not supported for this alg:prov="+this.algProvName},this.verify=function(e){throw"verify(hSigVal) not supported for this alg:prov="+this.algProvName},this.initParams=e,void 0!==e&&(void 0!==e.alg&&(this.algName=e.alg,void 0===e.prov?this.provName=ee.crypto.Util.DEFAULTPROVIDER[this.algName]:this.provName=e.prov,this.algProvName=this.algName+":"+this.provName,this.setAlgAndProvider(this.algName,this.provName),this._setAlgNames()),void 0!==e.psssaltlen&&(this.pssSaltLen=e.psssaltlen),void 0!==e.prvkeypem)){if(void 0!==e.prvkeypas)throw"both prvkeypem and prvkeypas parameters not supported";try{t=Ze.getKey(e.prvkeypem);this.init(t)}catch(n){throw"fatal error to load pem private key: "+n}}},ee.crypto.Cipher=function(e){},ee.crypto.Cipher.encrypt=function(e,t,n,r){if(void 0!=We(r,"enclag")&&(n=r.encalg),"string"==typeof n&&"-CBC"==n.substr(-4)){var s=t,o=e;void 0!=We(r,"key")&&(s=r.key),void 0!=We(r,"enc")&&(hEnc=r.enc);var a,c=i.enc.Hex.parse(s),l=i.enc.Hex.parse(o),u=i.enc.Hex.parse(r.iv);if("des-EDE3-CBC"==n)a=i.TripleDES.encrypt(l,c,{iv:u});else{if("aes128-CBC"!=n&&"aes256-CBC"!=n)throw new Error("unsupported algorithm: "+n);a=i.AES.encrypt(l,c,{iv:u})}return a+""}if(t instanceof J&&t.isPublic){var h=ee.crypto.Cipher.getAlgByKeyAndName(t,n);if("RSA"===h)return t.encrypt(e);if("RSAOAEP"===h)return t.encryptOAEP(e,"sha1");var d=h.match(/^RSAOAEP(\d+)$/);if(null!==d)return t.encryptOAEP(e,"sha"+d[1]);throw"Cipher.encrypt: unsupported algorithm for RSAKey: "+n}throw"Cipher.encrypt: unsupported key or algorithm"},ee.crypto.Cipher.decrypt=function(e,t,n,r){if(void 0!=We(r,"enclag")&&(n=r.encalg),"string"==typeof n&&"-CBC"==n.substr(-4)){var s=t,o=e;void 0!=We(r,"key")&&(s=r.key),void 0!=We(r,"enc")&&(o=r.enc);var a,c=i.enc.Hex.parse(s),l=i.enc.Hex.parse(o),u=i.enc.Hex.parse(r.iv);if("des-EDE3-CBC"==n)a=i.TripleDES.decrypt({ciphertext:l},c,{iv:u});else{if("aes128-CBC"!=n&&"aes256-CBC"!=n)throw new Error("unsupported algorithm: "+n);a=i.AES.decrypt({ciphertext:l},c,{iv:u})}return i.enc.Hex.stringify(a)}if(t instanceof J&&t.isPrivate){var h=ee.crypto.Cipher.getAlgByKeyAndName(t,n);if("RSA"===h)return t.decrypt(e);if("RSAOAEP"===h)return t.decryptOAEP(e,"sha1");var d=h.match(/^RSAOAEP(\d+)$/);if(null!==d)return t.decryptOAEP(e,"sha"+d[1]);throw"Cipher.decrypt: unsupported algorithm for RSAKey: "+n}throw"Cipher.decrypt: unsupported key or algorithm"},ee.crypto.Cipher.getAlgByKeyAndName=function(e,t){if(e instanceof J){if(-1!=":RSA:RSAOAEP:RSAOAEP224:RSAOAEP256:RSAOAEP384:RSAOAEP512:".indexOf(t))return t;if(null===t||void 0===t)return"RSA";throw"getAlgByKeyAndName: not supported algorithm name for RSAKey: "+t}throw"getAlgByKeyAndName: not supported algorithm name: "+t},ee.crypto.OID=new function(){this.oidhex2name={"2a864886f70d010101":"rsaEncryption","2a8648ce3d0201":"ecPublicKey","2a8648ce380401":"dsa","2a8648ce3d030107":"secp256r1","2b8104001f":"secp192k1","2b81040021":"secp224r1","2b8104000a":"secp256k1","2b81040022":"secp384r1","2b81040023":"secp521r1","2a8648ce380403":"SHA1withDSA","608648016503040301":"SHA224withDSA","608648016503040302":"SHA256withDSA"}},"undefined"!=typeof ee&&ee||(ee={}),"undefined"!=typeof ee.crypto&&ee.crypto||(ee.crypto={}),ee.crypto.ECDSA=function(e){var t=Error,n=h,r=Q,i=ee.crypto.ECDSA,s=ee.crypto.ECParameterDB,o=i.getName,a=re,c=a.getVbyListEx,l=a.isASN1HEX,u=new K;this.type="EC",this.isPrivate=!1,this.isPublic=!1,this.getBigRandom=function(e){return new n(e.bitLength(),u).mod(e.subtract(n.ONE)).add(n.ONE)},this.setNamedCurve=function(e){this.ecparams=s.getByName(e),this.prvKeyHex=null,this.pubKeyHex=null,this.curveName=e},this.setPrivateKeyHex=function(e){this.isPrivate=!0,this.prvKeyHex=e},this.setPublicKeyHex=function(e){this.isPublic=!0,this.pubKeyHex=e},this.getPublicKeyXYHex=function(){var e=this.pubKeyHex;if("04"!==e.substr(0,2))throw"this method supports uncompressed format(04) only";var t=this.ecparams.keycharlen;if(e.length!==2+2*t)throw"malformed public key hex length";var n={};return n.x=e.substr(2,t),n.y=e.substr(2+t),n},this.getShortNISTPCurveName=function(){var e=this.curveName;return"secp256r1"===e||"NIST P-256"===e||"P-256"===e||"prime256v1"===e?"P-256":"secp384r1"===e||"NIST P-384"===e||"P-384"===e?"P-384":"secp521r1"===e||"NIST P-521"===e||"P-521"===e?"P-521":null},this.generateKeyPairHex=function(){var e=this.ecparams.n,t=this.getBigRandom(e),n=this.ecparams.keycharlen,r=("0000000000"+t.toString(16)).slice(-n);return this.setPrivateKeyHex(r),{ecprvhex:r,ecpubhex:this.generatePublicKeyHex()}},this.generatePublicKeyHex=function(){var e=new n(this.prvKeyHex,16),t=this.ecparams.G.multiply(e),r=t.getX().toBigInteger(),i=t.getY().toBigInteger(),s=this.ecparams.keycharlen,o="04"+("0000000000"+r.toString(16)).slice(-s)+("0000000000"+i.toString(16)).slice(-s);return this.setPublicKeyHex(o),o},this.signWithMessageHash=function(e){return this.signHex(e,this.prvKeyHex)},this.signHex=function(e,t){var r=new n(t,16),s=this.ecparams.n,o=new n(e.substring(0,this.ecparams.keycharlen),16);do{var a=this.getBigRandom(s),c=this.ecparams.G.multiply(a).getX().toBigInteger().mod(s)}while(c.compareTo(n.ZERO)<=0);var l=a.modInverse(s).multiply(o.add(r.multiply(c))).mod(s);return i.biRSSigToASN1Sig(c,l)},this.sign=function(e,t){var r=t,i=this.ecparams.n,s=n.fromByteArrayUnsigned(e);do{var o=this.getBigRandom(i),a=this.ecparams.G.multiply(o).getX().toBigInteger().mod(i)}while(a.compareTo(h.ZERO)<=0);var c=o.modInverse(i).multiply(s.add(r.multiply(a))).mod(i);return this.serializeSig(a,c)},this.verifyWithMessageHash=function(e,t){return this.verifyHex(e,t,this.pubKeyHex)},this.verifyHex=function(e,t,s){try{var o,a,c=i.parseSigHex(t);o=c.r,a=c.s;var l=r.decodeFromHex(this.ecparams.curve,s),u=new n(e.substring(0,this.ecparams.keycharlen),16);return this.verifyRaw(u,o,a,l)}catch(h){return!1}},this.verify=function(e,t,i){var s,o,a;if(Bitcoin.Util.isArray(t)){var c=this.parseSig(t);s=c.r,o=c.s}else{if("object"!==typeof t||!t.r||!t.s)throw"Invalid value for signature";s=t.r,o=t.s}if(i instanceof Q)a=i;else{if(!Bitcoin.Util.isArray(i))throw"Invalid format for pubkey value, must be byte array or ECPointFp";a=r.decodeFrom(this.ecparams.curve,i)}var l=n.fromByteArrayUnsigned(e);return this.verifyRaw(l,s,o,a)},this.verifyRaw=function(e,t,r,i){var s=this.ecparams.n,o=this.ecparams.G;if(t.compareTo(n.ONE)<0||t.compareTo(s)>=0)return!1;if(r.compareTo(n.ONE)<0||r.compareTo(s)>=0)return!1;var a=r.modInverse(s),c=e.multiply(a).mod(s),l=t.multiply(a).mod(s);return o.multiply(c).add(i.multiply(l)).getX().toBigInteger().mod(s).equals(t)},this.serializeSig=function(e,t){var n=e.toByteArraySigned(),r=t.toByteArraySigned(),i=[];return i.push(2),i.push(n.length),(i=i.concat(n)).push(2),i.push(r.length),(i=i.concat(r)).unshift(i.length),i.unshift(48),i},this.parseSig=function(e){var t;if(48!=e[0])throw new Error("Signature not a valid DERSequence");if(2!=e[t=2])throw new Error("First element in signature must be a DERInteger");var r=e.slice(t+2,t+2+e[t+1]);if(2!=e[t+=2+e[t+1]])throw new Error("Second element in signature must be a DERInteger");var i=e.slice(t+2,t+2+e[t+1]);return t+=2+e[t+1],{r:n.fromByteArrayUnsigned(r),s:n.fromByteArrayUnsigned(i)}},this.parseSigCompact=function(e){if(65!==e.length)throw"Signature has the wrong length";var t=e[0]-27;if(t<0||t>7)throw"Invalid signature type";var r=this.ecparams.n;return{r:n.fromByteArrayUnsigned(e.slice(1,33)).mod(r),s:n.fromByteArrayUnsigned(e.slice(33,65)).mod(r),i:t}},this.readPKCS5PrvKeyHex=function(e){if(!1===l(e))throw new Error("not ASN.1 hex string");var t,n,r;try{t=c(e,0,["[0]",0],"06"),n=c(e,0,[1],"04");try{r=c(e,0,["[1]",0],"03")}catch(i){}}catch(i){throw new Error("malformed PKCS#1/5 plain ECC private key")}if(this.curveName=o(t),void 0===this.curveName)throw"unsupported curve name";this.setNamedCurve(this.curveName),this.setPublicKeyHex(r),this.setPrivateKeyHex(n),this.isPublic=!1},this.readPKCS8PrvKeyHex=function(e){if(!1===l(e))throw new t("not ASN.1 hex string");var n,r,i;try{c(e,0,[1,0],"06"),n=c(e,0,[1,1],"06"),r=c(e,0,[2,0,1],"04");try{i=c(e,0,[2,0,"[1]",0],"03")}catch(s){}}catch(s){throw new t("malformed PKCS#8 plain ECC private key")}if(this.curveName=o(n),void 0===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(i),this.setPrivateKeyHex(r),this.isPublic=!1},this.readPKCS8PubKeyHex=function(e){if(!1===l(e))throw new t("not ASN.1 hex string");var n,r;try{c(e,0,[0,0],"06"),n=c(e,0,[0,1],"06"),r=c(e,0,[1],"03")}catch(i){throw new t("malformed PKCS#8 ECC public key")}if(this.curveName=o(n),null===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(r)},this.readCertPubKeyHex=function(e,n){if(!1===l(e))throw new t("not ASN.1 hex string");var r,i;try{r=c(e,0,[0,5,0,1],"06"),i=c(e,0,[0,5,1],"03")}catch(s){throw new t("malformed X.509 certificate ECC public key")}if(this.curveName=o(r),null===this.curveName)throw new t("unsupported curve name");this.setNamedCurve(this.curveName),this.setPublicKeyHex(i)},void 0!==e&&void 0!==e.curve&&(this.curveName=e.curve),void 0===this.curveName&&(this.curveName="secp256r1"),this.setNamedCurve(this.curveName),void 0!==e&&(void 0!==e.prv&&this.setPrivateKeyHex(e.prv),void 0!==e.pub&&this.setPublicKeyHex(e.pub))},ee.crypto.ECDSA.parseSigHex=function(e){var t=ee.crypto.ECDSA.parseSigHexInHexRS(e);return{r:new h(t.r,16),s:new h(t.s,16)}},ee.crypto.ECDSA.parseSigHexInHexRS=function(e){var t=re,n=t.getChildIdx,r=t.getV;if(t.checkStrictDER(e,0),"30"!=e.substr(0,2))throw new Error("signature is not a ASN.1 sequence");var i=n(e,0);if(2!=i.length)throw new Error("signature shall have two elements");var s=i[0],o=i[1];if("02"!=e.substr(s,2))throw new Error("1st item not ASN.1 integer");if("02"!=e.substr(o,2))throw new Error("2nd item not ASN.1 integer");return{r:r(e,s),s:r(e,o)}},ee.crypto.ECDSA.asn1SigToConcatSig=function(e){var t=ee.crypto.ECDSA.parseSigHexInHexRS(e),n=t.r,r=t.s;if(n.length>=130&&n.length<=134){if(n.length%2!=0)throw Error("unknown ECDSA sig r length error");if(r.length%2!=0)throw Error("unknown ECDSA sig s length error");"00"==n.substr(0,2)&&(n=n.substr(2)),"00"==r.substr(0,2)&&(r=r.substr(2));var i=Math.max(n.length,r.length);return(n=("000000"+n).slice(-i))+(r=("000000"+r).slice(-i))}if("00"==n.substr(0,2)&&n.length%32==2&&(n=n.substr(2)),"00"==r.substr(0,2)&&r.length%32==2&&(r=r.substr(2)),n.length%32==30&&(n="00"+n),r.length%32==30&&(r="00"+r),n.length%32!=0)throw Error("unknown ECDSA sig r length error");if(r.length%32!=0)throw Error("unknown ECDSA sig s length error");return n+r},ee.crypto.ECDSA.concatSigToASN1Sig=function(e){if(e.length%4!=0)throw Error("unknown ECDSA concatinated r-s sig length error");var t=e.substr(0,e.length/2),n=e.substr(e.length/2);return ee.crypto.ECDSA.hexRSSigToASN1Sig(t,n)},ee.crypto.ECDSA.hexRSSigToASN1Sig=function(e,t){var n=new h(e,16),r=new h(t,16);return ee.crypto.ECDSA.biRSSigToASN1Sig(n,r)},ee.crypto.ECDSA.biRSSigToASN1Sig=function(e,t){var n=ee.asn1,r=new n.DERInteger({bigint:e}),i=new n.DERInteger({bigint:t});return new n.DERSequence({array:[r,i]}).tohex()},ee.crypto.ECDSA.getName=function(e){return"2b8104001f"===e?"secp192k1":"2a8648ce3d030107"===e?"secp256r1":"2b8104000a"===e?"secp256k1":"2b81040021"===e?"secp224r1":"2b81040022"===e?"secp384r1":"2b81040023"===e?"secp521r1":-1!=="|secp256r1|NIST P-256|P-256|prime256v1|".indexOf(e)?"secp256r1":-1!=="|secp256k1|".indexOf(e)?"secp256k1":-1!=="|secp224r1|NIST P-224|P-224|".indexOf(e)?"secp224r1":-1!=="|secp384r1|NIST P-384|P-384|".indexOf(e)?"secp384r1":-1!=="|secp521r1|NIST P-521|P-521|".indexOf(e)?"secp521r1":null},"undefined"!=typeof ee&&ee||(ee={}),"undefined"!=typeof ee.crypto&&ee.crypto||(ee.crypto={}),ee.crypto.ECParameterDB=new function(){var e={},t={};function n(e){return new h(e,16)}this.getByName=function(n){var r=n;if("undefined"!=typeof t[r]&&(r=t[n]),"undefined"!=typeof e[r])return e[r];throw"unregistered EC curve name: "+r},this.regist=function(r,i,s,o,a,c,l,u,h,d,f,p){e[r]={};var m=n(s),g=n(o),v=n(a),y=n(c),b=n(l),S=new X(m,g,v),w=S.decodePointHex("04"+u+h);e[r].name=r,e[r].keylen=i,e[r].keycharlen=2*Math.ceil(i/8),e[r].curve=S,e[r].G=w,e[r].n=y,e[r].h=b,e[r].oid=f,e[r].info=p;for(var C=0;C<d.length;C++)t[d[C]]=r}},ee.crypto.ECParameterDB.regist("secp128r1",128,"FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFDFFFFFFFFFFFFFFFFFFFFFFFC","E87579C11079F43DD824993C2CEE5ED3","FFFFFFFE0000000075A30D1B9038A115","1","161FF7528B899B2D0C28607CA52C5B86","CF5AC8395BAFEB13C02DA292DDED7A83",[],"","secp128r1 : SECG curve over a 128 bit prime field"),ee.crypto.ECParameterDB.regist("secp160k1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFAC73","0","7","0100000000000000000001B8FA16DFAB9ACA16B6B3","1","3B4C382CE37AA192A4019E763036F4F5DD4D7EBB","938CF935318FDCED6BC28286531733C3F03C4FEE",[],"","secp160k1 : SECG curve over a 160 bit prime field"),ee.crypto.ECParameterDB.regist("secp160r1",160,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF7FFFFFFC","1C97BEFC54BD7A8B65ACF89F81D4D4ADC565FA45","0100000000000000000001F4C8F927AED3CA752257","1","4A96B5688EF573284664698968C38BB913CBFC82","23A628553168947D59DCC912042351377AC5FB32",[],"","secp160r1 : SECG curve over a 160 bit prime field"),ee.crypto.ECParameterDB.regist("secp192k1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFEE37","0","3","FFFFFFFFFFFFFFFFFFFFFFFE26F2FC170F69466A74DEFD8D","1","DB4FF10EC057E9AE26B07D0280B7F4341DA5D1B1EAE06C7D","9B2F2F6D9C5628A7844163D015BE86344082AA88D95E2F9D",[]),ee.crypto.ECParameterDB.regist("secp192r1",192,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFC","64210519E59C80E70FA7E9AB72243049FEB8DEECC146B9B1","FFFFFFFFFFFFFFFFFFFFFFFF99DEF836146BC9B1B4D22831","1","188DA80EB03090F67CBF20EB43A18800F4FF0AFD82FF1012","07192B95FFC8DA78631011ED6B24CDD573F977A11E794811",[]),ee.crypto.ECParameterDB.regist("secp224r1",224,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000001","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFFFFFFFFFFFFFFFFFE","B4050A850C04B3ABF54132565044B0B7D7BFD8BA270B39432355FFB4","FFFFFFFFFFFFFFFFFFFFFFFFFFFF16A2E0B8F03E13DD29455C5C2A3D","1","B70E0CBD6BB4BF7F321390B94A03C1D356C21122343280D6115C1D21","BD376388B5F723FB4C22DFE6CD4375A05A07476444D5819985007E34",[]),ee.crypto.ECParameterDB.regist("secp256k1",256,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFC2F","0","7","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEBAAEDCE6AF48A03BBFD25E8CD0364141","1","79BE667EF9DCBBAC55A06295CE870B07029BFCDB2DCE28D959F2815B16F81798","483ADA7726A3C4655DA4FBFC0E1108A8FD17B448A68554199C47D08FFB10D4B8",[]),ee.crypto.ECParameterDB.regist("secp256r1",256,"FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF","FFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFC","5AC635D8AA3A93E7B3EBBD55769886BC651D06B0CC53B0F63BCE3C3E27D2604B","FFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC632551","1","6B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C296","4FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5",["NIST P-256","P-256","prime256v1"]),ee.crypto.ECParameterDB.regist("secp384r1",384,"FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFFF0000000000000000FFFFFFFC","B3312FA7E23EE7E4988E056BE3F82D19181D9C6EFE8141120314088F5013875AC656398D8A2ED19D2A85C8EDD3EC2AEF","FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC7634D81F4372DDF581A0DB248B0A77AECEC196ACCC52973","1","AA87CA22BE8B05378EB1C71EF320AD746E1D3B628BA79B9859F741E082542A385502F25DBF55296C3A545E3872760AB7","3617de4a96262c6f5d9e98bf9292dc29f8f41dbd289a147ce9da3113b5f0b8c00a60b1ce1d7e819d7a431d7c90ea0e5f",["NIST P-384","P-384"]),ee.crypto.ECParameterDB.regist("secp521r1",521,"1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFC","051953EB9618E1C9A1F929A21A0B68540EEA2DA725B99B315F3B8B489918EF109E156193951EC7E937B1652C0BD3BB1BF073573DF883D2C34F1EF451FD46B503F00","1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA51868783BF2F966B7FCC0148F709A5D03BB5C9B8899C47AEBB6FB71E91386409","1","00C6858E06B70404E9CD9E3ECB662395B4429C648139053FB521F828AF606B4D3DBAA14B5E77EFE75928FE1DC127A2FFA8DE3348B3C1856A429BF97E7E31C2E5BD66","011839296a789a3bc0045c8a5fb42c7d1bd998f54449579b446817afbd17273e662c97ee72995ef42640c550b9013fad0761353c7086a272c24088be94769fd16650",["NIST P-521","P-521"]),"undefined"!=typeof ee&&ee||(ee={}),"undefined"!=typeof ee.crypto&&ee.crypto||(ee.crypto={}),ee.crypto.DSA=function(){var e=re,t=(e.getVbyList,e.getVbyListEx),n=e.isASN1HEX,r=h;this.p=null,this.q=null,this.g=null,this.y=null,this.x=null,this.type="DSA",this.isPrivate=!1,this.isPublic=!1,this.setPrivate=function(e,t,n,r,i){this.isPrivate=!0,this.p=e,this.q=t,this.g=n,this.y=r,this.x=i},this.setPrivateHex=function(e,t,n,r,i){var s,o,a,c,l;s=new h(e,16),o=new h(t,16),a=new h(n,16),c="string"===typeof r&&r.length>1?new h(r,16):null,l=new h(i,16),this.setPrivate(s,o,a,c,l)},this.setPublic=function(e,t,n,r){this.isPublic=!0,this.p=e,this.q=t,this.g=n,this.y=r,this.x=null},this.setPublicHex=function(e,t,n,r){var i,s,o,a;i=new h(e,16),s=new h(t,16),o=new h(n,16),a=new h(r,16),this.setPublic(i,s,o,a)},this.signWithMessageHash=function(e){var t=this.p,n=this.q,r=this.g,i=(this.y,this.x),s=ee.crypto.Util.getRandomBigIntegerMinToMax(h.ONE.add(h.ONE),n.subtract(h.ONE)),o=new h(e.substr(0,n.bitLength()/4),16),a=r.modPow(s,t).mod(n),c=s.modInverse(n).multiply(o.add(i.multiply(a))).mod(n);return ee.asn1.ASN1Util.jsonToASN1HEX({seq:[{int:{bigint:a}},{int:{bigint:c}}]})},this.verifyWithMessageHash=function(e,t){var n=this.p,r=this.q,i=this.g,s=this.y,o=this.parseASN1Signature(t),a=o[0],c=o[1],l=new h(e.substr(0,r.bitLength()/4),16);if(h.ZERO.compareTo(a)>0||a.compareTo(r)>0)throw"invalid DSA signature";if(h.ZERO.compareTo(c)>=0||c.compareTo(r)>0)throw"invalid DSA signature";var u=c.modInverse(r),d=l.multiply(u).mod(r),f=a.multiply(u).mod(r);return 0==i.modPow(d,n).multiply(s.modPow(f,n)).mod(n).mod(r).compareTo(a)},this.parseASN1Signature=function(e){try{return[new r(t(e,0,[0],"02"),16),new r(t(e,0,[1],"02"),16)]}catch(n){throw new Error("malformed ASN.1 DSA signature")}},this.readPKCS5PrvKeyHex=function(e){var r,i,s,o,a;if(!1===n(e))throw new Error("not ASN.1 hex string");try{r=t(e,0,[1],"02"),i=t(e,0,[2],"02"),s=t(e,0,[3],"02"),o=t(e,0,[4],"02"),a=t(e,0,[5],"02")}catch(c){throw new Error("malformed PKCS#1/5 plain DSA private key")}this.setPrivateHex(r,i,s,o,a)},this.readPKCS8PrvKeyHex=function(e){var r,i,s,o;if(!1===n(e))throw new Error("not ASN.1 hex string");try{r=t(e,0,[1,1,0],"02"),i=t(e,0,[1,1,1],"02"),s=t(e,0,[1,1,2],"02"),o=t(e,0,[2,0],"02")}catch(a){throw new Error("malformed PKCS#8 plain DSA private key")}this.setPrivateHex(r,i,s,null,o)},this.readPKCS8PubKeyHex=function(e){var r,i,s,o;if(!1===n(e))throw new Error("not ASN.1 hex string");try{r=t(e,0,[0,1,0],"02"),i=t(e,0,[0,1,1],"02"),s=t(e,0,[0,1,2],"02"),o=t(e,0,[1,0],"02")}catch(a){throw new Error("malformed PKCS#8 DSA public key")}this.setPublicHex(r,i,s,o)},this.readCertPubKeyHex=function(e,r){var i,s,o,a;if(!1===n(e))throw new Error("not ASN.1 hex string");try{i=t(e,0,[0,5,0,1,0],"02"),s=t(e,0,[0,5,0,1,1],"02"),o=t(e,0,[0,5,0,1,2],"02"),a=t(e,0,[0,5,1,0],"02")}catch(c){throw new Error("malformed X.509 certificate DSA public key")}this.setPublicHex(i,s,o,a)}};var Ze=function(){var e=function(e,n,r){return t(i.AES,e,n,r)},t=function(e,t,n,r){var s=i.enc.Hex.parse(t),o=i.enc.Hex.parse(n),a=i.enc.Hex.parse(r),c={};c.key=o,c.iv=a,c.ciphertext=s;var l=e.decrypt(c,o,{iv:a});return i.enc.Hex.stringify(l)},n=function(e,t,n){return r(i.AES,e,t,n)},r=function(e,t,n,r){var s=i.enc.Hex.parse(t),o=i.enc.Hex.parse(n),a=i.enc.Hex.parse(r),c=e.encrypt(s,o,{iv:a}),l=i.enc.Hex.parse(c.toString());return i.enc.Base64.stringify(l)},s={"AES-256-CBC":{proc:e,eproc:n,keylen:32,ivlen:16},"AES-192-CBC":{proc:e,eproc:n,keylen:24,ivlen:16},"AES-128-CBC":{proc:e,eproc:n,keylen:16,ivlen:16},"DES-EDE3-CBC":{proc:function(e,n,r){return t(i.TripleDES,e,n,r)},eproc:function(e,t,n){return r(i.TripleDES,e,t,n)},keylen:24,ivlen:8},"DES-CBC":{proc:function(e,n,r){return t(i.DES,e,n,r)},eproc:function(e,t,n){return r(i.DES,e,t,n)},keylen:8,ivlen:8}},o=function(e){var t={},n=e.match(new RegExp("DEK-Info: ([^,]+),([0-9A-Fa-f]+)","m"));n&&(t.cipher=n[1],t.ivsalt=n[2]);var r=e.match(new RegExp("-----BEGIN ([A-Z]+) PRIVATE KEY-----"));r&&(t.type=r[1]);var i=-1,s=0;-1!=e.indexOf("\r\n\r\n")&&(i=e.indexOf("\r\n\r\n"),s=2),-1!=e.indexOf("\n\n")&&(i=e.indexOf("\n\n"),s=1);var o=e.indexOf("-----END");if(-1!=i&&-1!=o){var a=e.substring(i+2*s,o-s);a=a.replace(/\s+/g,""),t.data=a}return t},a=function(e,t,n){for(var r=n.substring(0,16),o=i.enc.Hex.parse(r),a=i.enc.Utf8.parse(t),c=s[e].keylen+s[e].ivlen,l="",u=null;;){var h=i.algo.MD5.create();if(null!=u&&h.update(u),h.update(a),h.update(o),u=h.finalize(),(l+=i.enc.Hex.stringify(u)).length>=2*c)break}var d={};return d.keyhex=l.substr(0,2*s[e].keylen),d.ivhex=l.substr(2*s[e].keylen,2*s[e].ivlen),d},c=function(e,t,n,r){var o=i.enc.Base64.parse(e),a=i.enc.Hex.stringify(o);return(0,s[t].proc)(a,n,r)};return{version:"1.0.0",parsePKCS5PEM:function(e){return o(e)},getKeyAndUnusedIvByPasscodeAndIvsalt:function(e,t,n){return a(e,t,n)},decryptKeyB64:function(e,t,n,r){return c(e,t,n,r)},getDecryptedKeyHex:function(e,t){var n=o(e),r=(n.type,n.cipher),i=n.ivsalt,s=n.data,l=a(r,t,i).keyhex;return c(s,r,l,i)},getEncryptedPKCS5PEMFromPrvKeyHex:function(e,t,n,r,o){var c="";if("undefined"!=typeof r&&null!=r||(r="AES-256-CBC"),"undefined"==typeof s[r])throw new Error("KEYUTIL unsupported algorithm: "+r);if("undefined"==typeof o||null==o){var l=function(e){var t=i.lib.WordArray.random(e);return i.enc.Hex.stringify(t)}(s[r].ivlen);o=l.toUpperCase()}var u=function(e,t,n,r){return(0,s[t].eproc)(e,n,r)}(t,r,a(r,n,o).keyhex,o);c="-----BEGIN "+e+" PRIVATE KEY-----\r\n";return c+="Proc-Type: 4,ENCRYPTED\r\n",c+="DEK-Info: "+r+","+o+"\r\n",c+="\r\n",c+=u.replace(/(.{64})/g,"$1\r\n"),c+="\r\n-----END "+e+" PRIVATE KEY-----\r\n"},getEncryptedPKCS8PEM:function(e,t,n){return Se(this.getEncryptedPKCS8Hex(e,t,n),"ENCRYPTED PRIVATE KEY")},getEncryptedPKCS8Hex:function(e,t,n){var r;(r=void 0==n||null==n?{}:JSON.parse(JSON.stringify(n))).plain=e,this.initPBES2Param(r),this.encryptPBES2Param(r,t);var i=this.generatePBES2ASN1Param(r);return ee.asn1.ASN1Util.newObject(i).tohex()},initPBES2Param:function(e){var t;(void 0==We(e,"encalg")&&(e.encalg="aes256-CBC"),void 0==We(e,"iter")&&(e.iter=2048),void 0==We(e,"prf")&&(e.prf="hmacWithSHA256"),void 0==We(e,"salt")&&(e.salt=i.enc.Hex.stringify(i.lib.WordArray.random(8))),void 0==We(e,"enciv"))&&("des-EDE3-CBC"==e.encalg&&(t=8),"aes128-CBC"==e.encalg&&(t=16),"aes256-CBC"==e.encalg&&(t=16),e.enciv=i.enc.Hex.stringify(i.lib.WordArray.random(t)))},encryptPBES2Param:function(e,t){var n=Ze.getDKFromPBES2Param(e,t);try{var r=ee.crypto.Cipher.encrypt(e.plain,n,e.encalg,{iv:e.enciv})}catch(i){throw new Error("encrypt error: "+e.plain+" "+n+" "+e.encalg+" "+e.enciv)}e.enc=r},generatePBES2ASN1Param:function(e){var t={seq:[{seq:[{oid:"pkcs5PBES2"},{seq:[{seq:[{oid:"pkcs5PBKDF2"},{seq:[{octstr:{hex:e.salt}},{int:{hex:je(e.iter)}}]}]},{seq:[{oid:e.encalg},{octstr:{hex:e.enciv}}]}]}]},{octstr:{hex:e.enc}}]};return"hmacWithSHA1"!=e.prf&&t.seq[0].seq[1].seq[0].seq[1].seq.push({seq:[{oid:e.prf},{null:""}]}),t},parseHexOfEncryptedPKCS8:function(e){var t=re,n=t.getChildIdx,r=t.getV,i={},s=n(e,0);if(2!=s.length)throw new Error("malformed format: SEQUENCE(0).items != 2: "+s.length);i.ciphertext=r(e,s[1]);var o=n(e,s[0]);if(2!=o.length)throw new Error("malformed format: SEQUENCE(0.0).items != 2: "+o.length);if("2a864886f70d01050d"!=r(e,o[0]))throw new Error("this only supports pkcs5PBES2");var a=n(e,o[1]);if(2!=o.length)throw new Error("malformed format: SEQUENCE(0.0.1).items != 2: "+a.length);var c=n(e,a[1]);if(2!=c.length)throw new Error("malformed format: SEQUENCE(0.0.1.1).items != 2: "+c.length);if("2a864886f70d0307"!=r(e,c[0]))throw"this only supports TripleDES";i.encryptionSchemeAlg="TripleDES",i.encryptionSchemeIV=r(e,c[1]);var l=n(e,a[0]);if(2!=l.length)throw new Error("malformed format: SEQUENCE(0.0.1.0).items != 2: "+l.length);if("2a864886f70d01050c"!=r(e,l[0]))throw new Error("this only supports pkcs5PBKDF2");var u=n(e,l[1]);if(u.length<2)throw new Error("malformed format: SEQUENCE(0.0.1.0.1).items < 2: "+u.length);i.pbkdf2Salt=r(e,u[0]);var h=r(e,u[1]);try{i.pbkdf2Iter=parseInt(h,16)}catch(d){throw new Error("malformed format pbkdf2Iter: "+h)}return i},getPBKDF2KeyHexFromParam:function(e,t){var n=i.enc.Hex.parse(e.pbkdf2Salt),r=e.pbkdf2Iter,s=i.PBKDF2(t,n,{keySize:6,iterations:r});return i.enc.Hex.stringify(s)},_getPlainPKCS8HexFromEncryptedPKCS8PEM:function(e,t){var n=we(e,"ENCRYPTED PRIVATE KEY"),r=this.parseHexOfEncryptedPKCS8(n),s=Ze.getPBKDF2KeyHexFromParam(r,t),o={};o.ciphertext=i.enc.Hex.parse(r.ciphertext);var a=i.enc.Hex.parse(s),c=i.enc.Hex.parse(r.encryptionSchemeIV),l=i.TripleDES.decrypt(o,a,{iv:c});return i.enc.Hex.stringify(l)},parsePBES2:function(e){var t=re.parse(e);if("pkcs5PBES2"!=We(t,"seq.0.seq.0.oid")||"pkcs5PBKDF2"!=We(t,"seq.0.seq.1.seq.0.seq.0.oid"))throw new Error("not pkcs5PBES2 and pkcs5PBKDF2 used");var n=We(t,"seq.0.seq.1.seq.0.seq.1.seq");if(void 0==n)throw new Error("PBKDF2 parameter not found");var r=We(n,"0.octstr.hex"),i=We(n,"1.int.hex"),s=We(n,"2.seq.0.oid","hmacWithSHA1"),o=-1;try{o=parseInt(i,16)}catch(u){throw new Error("iter not proper value")}var a=We(t,"seq.0.seq.1.seq.1.seq.0.oid"),c=We(t,"seq.0.seq.1.seq.1.seq.1.octstr.hex"),l=We(t,"seq.1.octstr.hex");if(void 0==a||void 0==c||void 0==l)throw new Error("encalg, enciv or enc is undefined");return{salt:r,iter:o,prf:s,encalg:a,enciv:c,enc:l}},getDKFromPBES2Param:function(e,t){var n={hmacWithSHA1:i.algo.SHA1,hmacWithSHA224:i.algo.SHA224,hmacWithSHA256:i.algo.SHA256,hmacWithSHA384:i.algo.SHA384,hmacWithSHA512:i.algo.SHA512}[e.prf];if(void 0==n)throw new Error("unsupported prf");var r={"des-EDE3-CBC":6,"aes128-CBC":4,"aes256-CBC":8}[e.encalg];if(void 0==r)throw new Error("unsupported encalg");var s=i.enc.Hex.parse(e.salt),o=e.iter;try{var a=i.PBKDF2(t,s,{keySize:r,iterations:o,hasher:n});return i.enc.Hex.stringify(a)}catch(j){throw new Error("PBKDF2 error: "+j+" "+JSON.stringify(e)+" "+t)}},getPlainHexFromEncryptedPKCS8PEM:function(e,t){if(-1==e.indexOf("BEGIN ENCRYPTED PRIVATE KEY"))throw new Error("not Encrypted PKCS#8 PEM string");var n,r=we(e);try{n=Ze.parsePBES2(r)}catch(s){throw new Error("malformed PBES2 format: "+s.message)}var i=Ze.getDKFromPBES2Param(n,t);return ee.crypto.Cipher.decrypt(n.enc,i,n.encalg,{iv:n.enciv})},getKeyFromEncryptedPKCS8PEM:function(e,t){var n=this.getPlainHexFromEncryptedPKCS8PEM(e,t);return this.getKeyFromPlainPrivatePKCS8Hex(n)},parsePlainPrivatePKCS8Hex:function(e){var t=re,n=t.getChildIdx,r=t.getV,i={algparam:null};if("30"!=e.substr(0,2))throw new Error("malformed plain PKCS8 private key(code:001)");var s=n(e,0);if(s.length<3)throw new Error("malformed plain PKCS8 private key(code:002)");if("30"!=e.substr(s[1],2))throw new Error("malformed PKCS8 private key(code:003)");var o=n(e,s[1]);if(2!=o.length)throw new Error("malformed PKCS8 private key(code:004)");if("06"!=e.substr(o[0],2))throw new Error("malformed PKCS8 private key(code:005)");if(i.algoid=r(e,o[0]),"06"==e.substr(o[1],2)&&(i.algparam=r(e,o[1])),"04"!=e.substr(s[2],2))throw new Error("malformed PKCS8 private key(code:006)");return i.keyidx=t.getVidx(e,s[2]),i},getKeyFromPlainPrivatePKCS8PEM:function(e){var t=we(e,"PRIVATE KEY");return this.getKeyFromPlainPrivatePKCS8Hex(t)},getKeyFromPlainPrivatePKCS8Hex:function(e){var t,n=this.parsePlainPrivatePKCS8Hex(e);if("2a864886f70d010101"==n.algoid)t=new J;else if("2a8648ce380401"==n.algoid)t=new ee.crypto.DSA;else{if("2a8648ce3d0201"!=n.algoid)throw new Error("unsupported private key algorithm");t=new ee.crypto.ECDSA}return t.readPKCS8PrvKeyHex(e),t},_getKeyFromPublicPKCS8Hex:function(e){var t,n=re.getVbyList(e,0,[0,0],"06");if("2a864886f70d010101"===n)t=new J;else if("2a8648ce380401"===n)t=new ee.crypto.DSA;else{if("2a8648ce3d0201"!==n)throw new Error("unsupported PKCS#8 public key hex");t=new ee.crypto.ECDSA}return t.readPKCS8PubKeyHex(e),t},parsePublicRawRSAKeyHex:function(e){var t=re,n=t.getChildIdx,r=t.getV,i={};if("30"!=e.substr(0,2))throw new Error("malformed RSA key(code:001)");var s=n(e,0);if(2!=s.length)throw new Error("malformed RSA key(code:002)");if("02"!=e.substr(s[0],2))throw new Error("malformed RSA key(code:003)");if(i.n=r(e,s[0]),"02"!=e.substr(s[1],2))throw new Error("malformed RSA key(code:004)");return i.e=r(e,s[1]),i},parsePublicPKCS8Hex:function(e){var t=re,n=t.getChildIdx,r=t.getV,i={algparam:null},s=n(e,0);if(2!=s.length)throw new Error("outer DERSequence shall have 2 elements: "+s.length);var o=s[0];if("30"!=e.substr(o,2))throw new Error("malformed PKCS8 public key(code:001)");var a=n(e,o);if(2!=a.length)throw new Error("malformed PKCS8 public key(code:002)");if("06"!=e.substr(a[0],2))throw new Error("malformed PKCS8 public key(code:003)");if(i.algoid=r(e,a[0]),"06"==e.substr(a[1],2)?i.algparam=r(e,a[1]):"30"==e.substr(a[1],2)&&(i.algparam={},i.algparam.p=t.getVbyList(e,a[1],[0],"02"),i.algparam.q=t.getVbyList(e,a[1],[1],"02"),i.algparam.g=t.getVbyList(e,a[1],[2],"02")),"03"!=e.substr(s[1],2))throw new Error("malformed PKCS8 public key(code:004)");return i.key=r(e,s[1]).substr(2),i}}}();Ze.getKey=function(e,t,n){var r=(v=re).getChildIdx,i=(v.getV,v.getVbyList),s=ee.crypto,o=s.ECDSA,a=s.DSA,c=J,l=we,u=Ze;if("undefined"!=typeof c&&e instanceof c)return e;if("undefined"!=typeof o&&e instanceof o)return e;if("undefined"!=typeof a&&e instanceof a)return e;if(void 0!==e.curve&&void 0!==e.xy&&void 0===e.d)return new o({pub:e.xy,curve:e.curve});if(void 0!==e.curve&&void 0!==e.d)return new o({prv:e.d,curve:e.curve});if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0===e.d)return(F=new c).setPublic(e.n,e.e),F;if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0!==e.p&&void 0!==e.q&&void 0!==e.dp&&void 0!==e.dq&&void 0!==e.co&&void 0===e.qi)return(F=new c).setPrivateEx(e.n,e.e,e.d,e.p,e.q,e.dp,e.dq,e.co),F;if(void 0===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0===e.p)return(F=new c).setPrivate(e.n,e.e,e.d),F;if(void 0!==e.p&&void 0!==e.q&&void 0!==e.g&&void 0!==e.y&&void 0===e.x)return(F=new a).setPublic(e.p,e.q,e.g,e.y),F;if(void 0!==e.p&&void 0!==e.q&&void 0!==e.g&&void 0!==e.y&&void 0!==e.x)return(F=new a).setPrivate(e.p,e.q,e.g,e.y,e.x),F;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0===e.d)return(F=new c).setPublic(he(e.n),he(e.e)),F;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d&&void 0!==e.p&&void 0!==e.q&&void 0!==e.dp&&void 0!==e.dq&&void 0!==e.qi)return(F=new c).setPrivateEx(he(e.n),he(e.e),he(e.d),he(e.p),he(e.q),he(e.dp),he(e.dq),he(e.qi)),F;if("RSA"===e.kty&&void 0!==e.n&&void 0!==e.e&&void 0!==e.d)return(F=new c).setPrivate(he(e.n),he(e.e),he(e.d)),F;if("EC"===e.kty&&void 0!==e.crv&&void 0!==e.x&&void 0!==e.y&&void 0===e.d){var d=(N=new o({curve:e.crv})).ecparams.keycharlen,f="04"+("0000000000"+he(e.x)).slice(-d)+("0000000000"+he(e.y)).slice(-d);return N.setPublicKeyHex(f),N}if("EC"===e.kty&&void 0!==e.crv&&void 0!==e.x&&void 0!==e.y&&void 0!==e.d){d=(N=new o({curve:e.crv})).ecparams.keycharlen,f="04"+("0000000000"+he(e.x)).slice(-d)+("0000000000"+he(e.y)).slice(-d);var p=("0000000000"+he(e.d)).slice(-d);return N.setPublicKeyHex(f),N.setPrivateKeyHex(p),N}if("pkcs5prv"===n){var m,g=e,v=re;if(9===(m=r(g,0)).length)(F=new c).readPKCS5PrvKeyHex(g);else if(6===m.length)(F=new a).readPKCS5PrvKeyHex(g);else{if(!(m.length>2&&"04"===g.substr(m[1],2)))throw new Error("unsupported PKCS#1/5 hexadecimal key");(F=new o).readPKCS5PrvKeyHex(g)}return F}if("pkcs8prv"===n)return F=u.getKeyFromPlainPrivatePKCS8Hex(e);if("pkcs8pub"===n)return u._getKeyFromPublicPKCS8Hex(e);if("x509pub"===n)return Ye.getPublicKeyFromCertHex(e);if(-1!=e.indexOf("-END CERTIFICATE-",0)||-1!=e.indexOf("-END X509 CERTIFICATE-",0)||-1!=e.indexOf("-END TRUSTED CERTIFICATE-",0))return Ye.getPublicKeyFromCertPEM(e);if(-1!=e.indexOf("-END PUBLIC KEY-")){var y=we(e,"PUBLIC KEY");return u._getKeyFromPublicPKCS8Hex(y)}if(-1!=e.indexOf("-END RSA PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){var b=l(e,"RSA PRIVATE KEY");return u.getKey(b,null,"pkcs5prv")}if(-1!=e.indexOf("-END DSA PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){var S=i(D=l(e,"DSA PRIVATE KEY"),0,[1],"02"),w=i(D,0,[2],"02"),C=i(D,0,[3],"02"),x=i(D,0,[4],"02"),E=i(D,0,[5],"02");return(F=new a).setPrivate(new h(S,16),new h(w,16),new h(C,16),new h(x,16),new h(E,16)),F}if(-1!=e.indexOf("-END EC PRIVATE KEY-")&&-1==e.indexOf("4,ENCRYPTED")){b=l(e,"EC PRIVATE KEY");return u.getKey(b,null,"pkcs5prv")}if(-1!=e.indexOf("-END PRIVATE KEY-"))return u.getKeyFromPlainPrivatePKCS8PEM(e);if(-1!=e.indexOf("-END RSA PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var T=u.getDecryptedKeyHex(e,t),k=new J;return k.readPKCS5PrvKeyHex(T),k}if(-1!=e.indexOf("-END EC PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var N,F=i(D=u.getDecryptedKeyHex(e,t),0,[1],"04"),I=i(D,0,[2,0],"06"),A=i(D,0,[3,0],"03").substr(2);if(void 0===ee.crypto.OID.oidhex2name[I])throw new Error("undefined OID(hex) in KJUR.crypto.OID: "+I);return(N=new o({curve:ee.crypto.OID.oidhex2name[I]})).setPublicKeyHex(A),N.setPrivateKeyHex(F),N.isPublic=!1,N}if(-1!=e.indexOf("-END DSA PRIVATE KEY-")&&-1!=e.indexOf("4,ENCRYPTED")){var D;S=i(D=u.getDecryptedKeyHex(e,t),0,[1],"02"),w=i(D,0,[2],"02"),C=i(D,0,[3],"02"),x=i(D,0,[4],"02"),E=i(D,0,[5],"02");return(F=new a).setPrivate(new h(S,16),new h(w,16),new h(C,16),new h(x,16),new h(E,16)),F}if(-1!=e.indexOf("-END ENCRYPTED PRIVATE KEY-"))return u.getKeyFromEncryptedPKCS8PEM(e,t);throw new Error("not supported argument")},Ze.generateKeypair=function(e,t){if("RSA"==e){var n=t;(o=new J).generate(n,"10001"),o.isPrivate=!0,o.isPublic=!0;var r=new J,i=o.n.toString(16),s=o.e.toString(16);return r.setPublic(i,s),r.isPrivate=!1,r.isPublic=!0,(a={}).prvKeyObj=o,a.pubKeyObj=r,a}if("EC"==e){var o,a,c=t,l=new ee.crypto.ECDSA({curve:c}).generateKeyPairHex();return(o=new ee.crypto.ECDSA({curve:c})).setPublicKeyHex(l.ecpubhex),o.setPrivateKeyHex(l.ecprvhex),o.isPrivate=!0,o.isPublic=!1,(r=new ee.crypto.ECDSA({curve:c})).setPublicKeyHex(l.ecpubhex),r.isPrivate=!1,r.isPublic=!0,(a={}).prvKeyObj=o,a.pubKeyObj=r,a}throw new Error("unknown algorithm: "+e)},Ze.getPEM=function(e,t,n,r,i,s){var o=ee,a=o.asn1,c=a.DERObjectIdentifier,l=a.DERInteger,u=a.ASN1Util.newObject,h=a.x509.SubjectPublicKeyInfo,d=o.crypto,f=d.DSA,p=d.ECDSA,m=J;function g(e){return u({seq:[{int:0},{int:{bigint:e.n}},{int:e.e},{int:{bigint:e.d}},{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.dmp1}},{int:{bigint:e.dmq1}},{int:{bigint:e.coeff}}]})}function v(e){return u({seq:[{int:1},{octstr:{hex:e.prvKeyHex}},{tag:["a0",!0,{oid:{name:e.curveName}}]},{tag:["a1",!0,{bitstr:{hex:"00"+e.pubKeyHex}}]}]})}function y(e){return u({seq:[{int:0},{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}},{int:{bigint:e.y}},{int:{bigint:e.x}}]})}if((void 0!==m&&e instanceof m||void 0!==f&&e instanceof f||void 0!==p&&e instanceof p)&&1==e.isPublic&&(void 0===t||"PKCS8PUB"==t))return Se(C=new h(e).tohex(),"PUBLIC KEY");if("PKCS1PRV"==t&&void 0!==m&&e instanceof m&&(void 0===n||null==n)&&1==e.isPrivate)return Se(C=g(e).tohex(),"RSA PRIVATE KEY");if("PKCS1PRV"==t&&void 0!==p&&e instanceof p&&(void 0===n||null==n)&&1==e.isPrivate){var b=new c({name:e.curveName}).tohex(),S=v(e).tohex(),w="";return w+=Se(b,"EC PARAMETERS"),w+=Se(S,"EC PRIVATE KEY")}if("PKCS1PRV"==t&&void 0!==f&&e instanceof f&&(void 0===n||null==n)&&1==e.isPrivate)return Se(C=y(e).tohex(),"DSA PRIVATE KEY");if("PKCS5PRV"==t&&void 0!==m&&e instanceof m&&void 0!==n&&null!=n&&1==e.isPrivate){var C=g(e).tohex();return void 0===r&&(r="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("RSA",C,n,r,s)}if("PKCS5PRV"==t&&void 0!==p&&e instanceof p&&void 0!==n&&null!=n&&1==e.isPrivate){C=v(e).tohex();return void 0===r&&(r="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("EC",C,n,r,s)}if("PKCS5PRV"==t&&void 0!==f&&e instanceof f&&void 0!==n&&null!=n&&1==e.isPrivate){C=y(e).tohex();return void 0===r&&(r="DES-EDE3-CBC"),this.getEncryptedPKCS5PEMFromPrvKeyHex("DSA",C,n,r,s)}var x=function(e,t){if("string"==typeof t)return Ze.getEncryptedPKCS8PEM(e,t);if("object"==typeof t&&void 0!=We(t,"passcode")){var n=JSON.parse(JSON.stringify(t)),r=n.passcode;return delete n.passcode,Ze.getEncryptedPKCS8PEM(e,r,n)}};if("PKCS8PRV"==t&&void 0!=m&&e instanceof m&&1==e.isPrivate){var E=g(e).tohex();C=u({seq:[{int:0},{seq:[{oid:{name:"rsaEncryption"}},{null:!0}]},{octstr:{hex:E}}]}).tohex();return void 0===n||null==n?Se(C,"PRIVATE KEY"):x(C,n)}if("PKCS8PRV"==t&&void 0!==p&&e instanceof p&&1==e.isPrivate){var T={seq:[{int:1},{octstr:{hex:e.prvKeyHex}}]};"string"==typeof e.pubKeyHex&&T.seq.push({tag:["a1",!0,{bitstr:{hex:"00"+e.pubKeyHex}}]});E=new u(T).tohex(),C=u({seq:[{int:0},{seq:[{oid:{name:"ecPublicKey"}},{oid:{name:e.curveName}}]},{octstr:{hex:E}}]}).tohex();return void 0===n||null==n?Se(C,"PRIVATE KEY"):x(C,n)}if("PKCS8PRV"==t&&void 0!==f&&e instanceof f&&1==e.isPrivate){E=new l({bigint:e.x}).tohex(),C=u({seq:[{int:0},{seq:[{oid:{name:"dsa"}},{seq:[{int:{bigint:e.p}},{int:{bigint:e.q}},{int:{bigint:e.g}}]}]},{octstr:{hex:E}}]}).tohex();return void 0===n||null==n?Se(C,"PRIVATE KEY"):x(C,n)}throw new Error("unsupported object nor format")},Ze.getKeyFromCSRPEM=function(e){var t=we(e,"CERTIFICATE REQUEST");return Ze.getKeyFromCSRHex(t)},Ze.getKeyFromCSRHex=function(e){var t=Ze.parseCSRHex(e);return Ze.getKey(t.p8pubkeyhex,null,"pkcs8pub")},Ze.parseCSRHex=function(e){var t=re,n=t.getChildIdx,r=t.getTLV,i={},s=e;if("30"!=s.substr(0,2))throw new Error("malformed CSR(code:001)");var o=n(s,0);if(o.length<1)throw new Error("malformed CSR(code:002)");if("30"!=s.substr(o[0],2))throw new Error("malformed CSR(code:003)");var a=n(s,o[0]);if(a.length<3)throw new Error("malformed CSR(code:004)");return i.p8pubkeyhex=r(s,a[2]),i},Ze.getKeyID=function(e){var t=Ze,n=re;"string"===typeof e&&-1!=e.indexOf("BEGIN ")&&(e=t.getKey(e));var r=we(t.getPEM(e)),i=n.getIdxbyList(r,0,[1]),s=n.getV(r,i).substring(2);return ee.crypto.Util.hashHex(s,"sha1")},Ze.getJWK=function(e,t,n,r,i){var s,o,a={},l=ee.crypto.Util.hashHex;if("string"==typeof e)s=Ze.getKey(e),-1!=e.indexOf("CERTIFICATE")&&(o=we(e));else{if("object"!=typeof e)throw new Error("unsupported keyinfo type");e instanceof Ye?(s=e.getPublicKey(),o=e.hex):s=e}if(s instanceof J&&s.isPrivate)a.kty="RSA",a.n=ue(s.n.toString(16)),a.e=ue(s.e.toString(16)),a.d=ue(s.d.toString(16)),a.p=ue(s.p.toString(16)),a.q=ue(s.q.toString(16)),a.dp=ue(s.dmp1.toString(16)),a.dq=ue(s.dmq1.toString(16)),a.qi=ue(s.coeff.toString(16));else if(s instanceof J&&s.isPublic)a.kty="RSA",a.n=ue(s.n.toString(16)),a.e=ue(s.e.toString(16));else if(s instanceof ee.crypto.ECDSA&&s.isPrivate){if("P-256"!==(h=s.getShortNISTPCurveName())&&"P-384"!==h&&"P-521"!==h)throw new Error("unsupported curve name for JWT: "+h);var u=s.getPublicKeyXYHex();a.kty="EC",a.crv=h,a.x=ue(u.x),a.y=ue(u.y),a.d=ue(s.prvKeyHex)}else if(s instanceof ee.crypto.ECDSA&&s.isPublic){var h;if("P-256"!==(h=s.getShortNISTPCurveName())&&"P-384"!==h&&"P-521"!==h)throw new Error("unsupported curve name for JWT: "+h);u=s.getPublicKeyXYHex();a.kty="EC",a.crv=h,a.x=ue(u.x),a.y=ue(u.y)}if(void 0==a.kty)throw new Error("unsupported keyinfo");return s.isPrivate||1==t||(a.kid=ee.jws.JWS.getJWKthumbprint(a)),void 0!=o&&1!=n&&(a.x5c=[c(o)]),void 0!=o&&1!=r&&(a.x5t=ce(c(l(o,"sha1")))),void 0!=o&&1!=i&&(a["x5t#S256"]=ce(c(l(o,"sha256")))),a},Ze.getJWKFromKey=function(e){return Ze.getJWK(e,!0,!0,!0,!0)},J.getPosArrayOfChildrenFromHex=function(e){return re.getChildIdx(e,0)},J.getHexValueArrayOfChildrenFromHex=function(e){var t,n=re.getV,r=n(e,(t=J.getPosArrayOfChildrenFromHex(e))[0]),i=n(e,t[1]),s=n(e,t[2]),o=n(e,t[3]),a=n(e,t[4]),c=n(e,t[5]),l=n(e,t[6]),u=n(e,t[7]),h=n(e,t[8]);return(t=new Array).push(r,i,s,o,a,c,l,u,h),t},J.prototype.readPrivateKeyFromPEMString=function(e){var t=we(e),n=J.getHexValueArrayOfChildrenFromHex(t);this.setPrivateEx(n[1],n[2],n[3],n[4],n[5],n[6],n[7],n[8])},J.prototype.readPKCS5PrvKeyHex=function(e){var t=J.getHexValueArrayOfChildrenFromHex(e);this.setPrivateEx(t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])},J.prototype.readPKCS8PrvKeyHex=function(e){var t,n,r,i,s,o,a,c,l=re,u=l.getVbyListEx;if(!1===l.isASN1HEX(e))throw new Error("not ASN.1 hex string");try{t=u(e,0,[2,0,1],"02"),n=u(e,0,[2,0,2],"02"),r=u(e,0,[2,0,3],"02"),i=u(e,0,[2,0,4],"02"),s=u(e,0,[2,0,5],"02"),o=u(e,0,[2,0,6],"02"),a=u(e,0,[2,0,7],"02"),c=u(e,0,[2,0,8],"02")}catch(h){throw new Error("malformed PKCS#8 plain RSA private key")}this.setPrivateEx(t,n,r,i,s,o,a,c)},J.prototype.readPKCS5PubKeyHex=function(e){var t=re,n=t.getV;if(!1===t.isASN1HEX(e))throw new Error("keyHex is not ASN.1 hex string");var r=t.getChildIdx(e,0);if(2!==r.length||"02"!==e.substr(r[0],2)||"02"!==e.substr(r[1],2))throw new Error("wrong hex for PKCS#5 public key");var i=n(e,r[0]),s=n(e,r[1]);this.setPublic(i,s)},J.prototype.readPKCS8PubKeyHex=function(e){var t=re;if(!1===t.isASN1HEX(e))throw new Error("not ASN.1 hex string");if("06092a864886f70d010101"!==t.getTLVbyListEx(e,0,[0,0]))throw new Error("not PKCS8 RSA public key");var n=t.getTLVbyListEx(e,0,[1,0]);this.readPKCS5PubKeyHex(n)},J.prototype.readCertPubKeyHex=function(e,t){var n,r;(n=new Ye).readCertHex(e),r=n.getPublicKeyHex(),this.readPKCS8PubKeyHex(r)};function $e(e,t){for(var n="",r=t/4-e.length,i=0;i<r;i++)n+="0";return n+e}function Qe(e,t,n){for(var r="",i=0;r.length<t;)r+=me(n(ge(e+String.fromCharCode.apply(String,[(4278190080&i)>>24,(16711680&i)>>16,(65280&i)>>8,255&i])))),i+=1;return r}function Xe(e){for(var t in ee.crypto.Util.DIGESTINFOHEAD){var n=ee.crypto.Util.DIGESTINFOHEAD[t],r=n.length;if(e.substring(0,r)==n)return[t,e.substring(r)]}return[]}function Ye(e){var t,n=re,r=n.getChildIdx,i=n.getV,s=(n.dump,n.parse),o=n.getTLV,a=n.getVbyList,c=n.getVbyListEx,l=n.getTLVbyList,u=n.getTLVbyListEx,h=n.getIdxbyList,d=n.getIdxbyListEx,f=n.getVidx,p=n.getInt,m=n.oidname,g=n.hextooidstr,v=we,y=Error;try{t=ee.asn1.x509.AlgorithmIdentifier.PSSNAME2ASN1TLV}catch(j){}this.HEX2STAG={"0c":"utf8",13:"prn",16:"ia5","1a":"vis","1e":"bmp"},this.hex=null,this.version=0,this.foffset=0,this.aExtInfo=null,this.getVersion=function(){if(null===this.hex||0!==this.version)return this.version;var e=l(this.hex,0,[0,0]);if("a0"==e.substr(0,2)){var t=l(e,0,[0]),n=p(t,0);if(n<0||2<n)throw new Error("malformed version field");return this.version=n+1,this.version}return this.version=1,this.foffset=-1,1},this.getSerialNumberHex=function(){return c(this.hex,0,[0,0],"02")},this.getSignatureAlgorithmField=function(){var e=u(this.hex,0,[0,1]);return this.getAlgorithmIdentifierName(e)},this.getAlgorithmIdentifierName=function(e){for(var n in t)if(e===t[n])return n;return m(c(e,0,[0],"06"))},this.getIssuer=function(e,t){return this.getX500Name(this.getIssuerHex(),e,t)},this.getIssuerHex=function(){return l(this.hex,0,[0,3+this.foffset],"30")},this.getIssuerString=function(){return this.getIssuer().str},this.getSubject=function(e,t){return this.getX500Name(this.getSubjectHex(),e,t)},this.getSubjectHex=function(){return l(this.hex,0,[0,5+this.foffset],"30")},this.getSubjectString=function(){return this.getSubject().str},this.getNotBefore=function(){var e=a(this.hex,0,[0,4+this.foffset,0]);return e=e.replace(/(..)/g,"%$1"),e=decodeURIComponent(e)},this.getNotAfter=function(){var e=a(this.hex,0,[0,4+this.foffset,1]);return e=e.replace(/(..)/g,"%$1"),e=decodeURIComponent(e)},this.getPublicKeyHex=function(){return this.getSPKI()},this.getSPKI=function(){return l(this.hex,0,[0,6+this.foffset],"30")},this.getSPKIValue=function(){var e=this.getSPKI();return null==e?null:a(e,0,[1],"03",!0)},this.getPublicKeyIdx=function(){return h(this.hex,0,[0,6+this.foffset],"30")},this.getPublicKeyContentIdx=function(){var e=this.getPublicKeyIdx();return h(this.hex,e,[1,0],"30")},this.getPublicKey=function(){return Ze.getKey(this.getPublicKeyHex(),null,"pkcs8pub")},this.getSignatureAlgorithmName=function(){var e=l(this.hex,0,[1],"30");return this.getAlgorithmIdentifierName(e)},this.getSignatureValueHex=function(){return a(this.hex,0,[2],"03",!0)},this.verifySignature=function(e){var t=this.getSignatureAlgorithmField(),n=this.getSignatureValueHex(),r=l(this.hex,0,[0],"30"),i=new ee.crypto.Signature({alg:t});return i.init(e),i.updateHex(r),i.verify(n)},this.parseExt=function(e){var t,s,o;if(void 0===e){if(o=this.hex,3!==this.version)return-1;t=h(o,0,[0,7,0],"30"),s=r(o,t)}else{o=we(e);var c=h(o,0,[0,3,0,0],"06");if("2a864886f70d01090e"!=i(o,c))return void(this.aExtInfo=new Array);t=h(o,0,[0,3,0,1,0],"30"),s=r(o,t),this.hex=o}this.aExtInfo=new Array;for(var l=0;l<s.length;l++){var u={critical:!1},d=0;3===r(o,s[l]).length&&(u.critical=!0,d=1),u.oid=n.hextooidstr(a(o,s[l],[0],"06"));var p=h(o,s[l],[1+d]);u.vidx=f(o,p),this.aExtInfo.push(u)}},this.getExtInfo=function(e){var t=this.aExtInfo,n=e;if(e.match(/^[0-9.]+$/)||(n=ee.asn1.x509.OID.name2oid(e)),""!==n)for(var r=0;r<t.length;r++)if(t[r].oid===n)return t[r]},this.getCriticalExtV=function(e,t,n){if(void 0!=t)return[t,n];var r=this.getExtInfo(e);return void 0==r?[null,null]:[o(this.hex,r.vidx),r.critical]},this.getExtBasicConstraints=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("basicConstraints");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var r={extname:"basicConstraints"};if(t&&(r.critical=!0),"3000"===e)return r;if("30030101ff"===e)return r.cA=!0,r;if("30060101ff02"===e.substr(0,12)){var s=i(e,10),a=parseInt(s,16);return r.cA=!0,r.pathLen=a,r}throw new Error("hExtV parse error: "+e)},this.getExtNameConstraints=function(e,t){var n=this.getCriticalExtV("nameConstraints",e,t);if(e=n[0],t=n[1],null!=e){var i={extname:"nameConstraints"};t&&(i.critical=!0);for(var s=r(e,0),a=0;a<s.length;a++){for(var c=[],l=r(e,s[a]),u=0;u<l.length;u++){var h=o(e,l[u]),d=this.getGeneralSubtree(h);c.push(d)}var f=e.substr(s[a],2);"a0"==f?i.permit=c:"a1"==f&&(i.exclude=c)}return i}},this.getGeneralSubtree=function(e){var t=r(e,0),n=t.length;if(n<1||2<n)throw new Error("wrong num elements");for(var s=this.getGeneralName(o(e,t[0])),a=1;a<n;a++){var c=e.substr(t[a],2),l=i(e,t[a]),u=parseInt(l,16);"80"==c&&(s.min=u),"81"==c&&(s.max=u)}return s},this.getExtKeyUsage=function(e,t){var n=this.getCriticalExtV("keyUsage",e,t);if(e=n[0],t=n[1],null!=e){var r={extname:"keyUsage"};return t&&(r.critical=!0),r.names=this.getExtKeyUsageString(e).split(","),r}},this.getExtKeyUsageBin=function(e){if(void 0===e){var t=this.getExtInfo("keyUsage");if(void 0===t)return"";e=o(this.hex,t.vidx)}if(8!=e.length&&10!=e.length)throw new Error("malformed key usage value: "+e);var n="000000000000000"+parseInt(e.substr(6),16).toString(2);return 8==e.length&&(n=n.slice(-8)),10==e.length&&(n=n.slice(-16)),""==(n=n.replace(/0+$/,""))&&(n="0"),n},this.getExtKeyUsageString=function(e){for(var t=this.getExtKeyUsageBin(e),n=new Array,r=0;r<t.length;r++)"1"==t.substr(r,1)&&n.push(Ye.KEYUSAGE_NAME[r]);return n.join(",")},this.getExtSubjectKeyIdentifier=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("subjectKeyIdentifier");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var r={extname:"subjectKeyIdentifier"};t&&(r.critical=!0);var s=i(e,0);return r.kid={hex:s},r},this.getExtAuthorityKeyIdentifier=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("authorityKeyIdentifier");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var s={extname:"authorityKeyIdentifier"};t&&(s.critical=!0);for(var a=r(e,0),c=0;c<a.length;c++){var l=e.substr(a[c],2);if("80"===l&&(s.kid={hex:i(e,a[c])}),"a1"===l){var u=o(e,a[c]),h=this.getGeneralNames(u);s.issuer=h[0].dn}"82"===l&&(s.sn={hex:i(e,a[c])})}return s},this.getExtExtKeyUsage=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("extKeyUsage");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var s={extname:"extKeyUsage",array:[]};t&&(s.critical=!0);for(var a=r(e,0),c=0;c<a.length;c++)s.array.push(m(i(e,a[c])));return s},this.getExtExtKeyUsageName=function(){var e=this.getExtInfo("extKeyUsage");if(void 0===e)return e;var t=new Array,n=o(this.hex,e.vidx);if(""===n)return t;for(var s=r(n,0),a=0;a<s.length;a++)t.push(m(i(n,s[a])));return t},this.getExtSubjectAltName=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("subjectAltName");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var r={extname:"subjectAltName",array:[]};return t&&(r.critical=!0),r.array=this.getGeneralNames(e),r},this.getExtIssuerAltName=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("issuerAltName");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var r={extname:"issuerAltName",array:[]};return t&&(r.critical=!0),r.array=this.getGeneralNames(e),r},this.getGeneralNames=function(e){for(var t=r(e,0),n=[],i=0;i<t.length;i++){var s=this.getGeneralName(o(e,t[i]));void 0!==s&&n.push(s)}return n},this.getGeneralName=function(e){var t=e.substr(0,2),n=i(e,0),r=me(n);return"81"==t?{rfc822:r}:"82"==t?{dns:r}:"86"==t?{uri:r}:"87"==t?{ip:Ie(n)}:"a4"==t?{dn:this.getX500Name(n)}:"a0"==t?{other:this.getOtherName(e)}:void 0},this.getExtSubjectAltName2=function(){var e,t,n,s=this.getExtInfo("subjectAltName");if(void 0===s)return s;for(var a=new Array,c=o(this.hex,s.vidx),l=r(c,0),u=0;u<l.length;u++)n=c.substr(l[u],2),e=i(c,l[u]),"81"===n&&(t=fe(e),a.push(["MAIL",t])),"82"===n&&(t=fe(e),a.push(["DNS",t])),"84"===n&&(t=Ye.hex2dn(e,0),a.push(["DN",t])),"86"===n&&(t=fe(e),a.push(["URI",t])),"87"===n&&(t=Ie(e),a.push(["IP",t]));return a},this.getExtCRLDistributionPoints=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("cRLDistributionPoints");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var i={extname:"cRLDistributionPoints",array:[]};t&&(i.critical=!0);for(var s=r(e,0),a=0;a<s.length;a++){var c=o(e,s[a]);i.array.push(this.getDistributionPoint(c))}return i},this.getDistributionPoint=function(e){for(var t={},n=r(e,0),i=0;i<n.length;i++){var s=e.substr(n[i],2),a=o(e,n[i]);"a0"==s&&(t.dpname=this.getDistributionPointName(a))}return t},this.getDistributionPointName=function(e){for(var t={},n=r(e,0),i=0;i<n.length;i++){var s=e.substr(n[i],2),a=o(e,n[i]);"a0"==s&&(t.full=this.getGeneralNames(a))}return t},this.getExtCRLDistributionPointsURI=function(){var e=this.getExtCRLDistributionPoints();if(void 0==e)return e;for(var t=e.array,n=[],r=0;r<t.length;r++)try{void 0!=t[r].dpname.full[0].uri&&n.push(t[r].dpname.full[0].uri)}catch(i){}return n},this.getExtAIAInfo=function(){var e=this.getExtInfo("authorityInfoAccess");if(void 0===e)return e;for(var t={ocsp:[],caissuer:[]},n=r(this.hex,e.vidx),i=0;i<n.length;i++){var s=a(this.hex,n[i],[0],"06"),o=a(this.hex,n[i],[1],"86");"2b06010505073001"===s&&t.ocsp.push(fe(o)),"2b06010505073002"===s&&t.caissuer.push(fe(o))}return t},this.getExtAuthorityInfoAccess=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("authorityInfoAccess");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var i={extname:"authorityInfoAccess",array:[]};t&&(i.critical=!0);for(var s=r(e,0),l=0;l<s.length;l++){var u=c(e,s[l],[0],"06"),h=fe(a(e,s[l],[1],"86"));if("2b06010505073001"==u)i.array.push({ocsp:h});else{if("2b06010505073002"!=u)throw new Error("unknown method: "+u);i.array.push({caissuer:h})}}return i},this.getExtCertificatePolicies=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("certificatePolicies");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var i={extname:"certificatePolicies",array:[]};t&&(i.critical=!0);for(var s=r(e,0),a=0;a<s.length;a++){var c=o(e,s[a]),l=this.getPolicyInformation(c);i.array.push(l)}return i},this.getPolicyInformation=function(e){var t={},n=a(e,0,[0],"06");t.policyoid=m(n);var i=d(e,0,[1],"30");if(-1!=i){t.array=[];for(var s=r(e,i),c=0;c<s.length;c++){var l=o(e,s[c]),u=this.getPolicyQualifierInfo(l);t.array.push(u)}}return t},this.getOtherName=function(e){var t={},n=r(e,0),i=a(e,n[0],[],"06"),o=a(e,n[1],[]);return t.oid=m(i),t.value=s(o),t},this.getPolicyQualifierInfo=function(e){var t={},n=a(e,0,[0],"06");if("2b06010505070201"===n){var r=c(e,0,[1],"16");t.cps=me(r)}else if("2b06010505070202"===n){var i=l(e,0,[1],"30");t.unotice=this.getUserNotice(i)}return t},this.getUserNotice=function(e){var t=null;try{return t=n.parse(e),this._asn1ToUnotice(t)}catch(r){return}},this._asn1ToUnotice=function(e){try{for(var t={},n=We(e,"seq"),r=0;r<n.length;r++){var i=this._asn1ToNoticeRef(n[r]);void 0!=i&&(t.noticeref=i);var s=this.asn1ToDisplayText(n[r]);void 0!=s&&(t.exptext=s)}return Object.keys(t).length>0?t:void 0}catch(o){return}},this._asn1ToNoticeRef=function(e){try{for(var t={},n=We(e,"seq"),r=0;r<n.length;r++){var i=this._asn1ToNoticeNum(n[r]);void 0!=i&&(t.noticenum=i);var s=this.asn1ToDisplayText(n[r]);void 0!=s&&(t.org=s)}return Object.keys(t).length>0?t:void 0}catch(o){return}},this._asn1ToNoticeNum=function(e){try{for(var t=We(e,"seq"),n=[],r=0;r<t.length;r++){var i=t[r];n.push(parseInt(We(i,"int.hex"),16))}return n}catch(s){return}},this.getDisplayText=function(e){var t={};return t.type={"0c":"utf8",16:"ia5","1a":"vis","1e":"bmp"}[e.substr(0,2)],t.str=me(i(e,0)),t},this.asn1ToDisplayText=function(e){return void 0!=e.utf8str?{type:"utf8",str:e.utf8str.str}:void 0!=e.ia5str?{type:"ia5",str:e.ia5str.str}:void 0!=e.visstr?{type:"vis",str:e.visstr.str}:void 0!=e.bmpstr?{type:"bmp",str:e.bmpstr.str}:void 0!=e.prnstr?{type:"prn",str:e.prnstr.str}:void 0},this.getExtPolicyMappings=function(e,t){var n=this.getCriticalExtV("policyMappings",e,t);if(e=n[0],t=n[1],null!=e){var r={extname:"policyMappings"};t&&(r.critical=!0);try{for(var i=s(e).seq,o=[],a=0;a<i.length;a++){var c=i[a].seq;o.push([c[0].oid,c[1].oid])}r.array=o}catch(l){throw new y("malformed policyMappings")}return r}},this.getExtPolicyConstraints=function(e,t){var n=this.getCriticalExtV("policyConstraints",e,t);if(e=n[0],t=n[1],null!=e){var r={extname:"policyConstraints"};t&&(r.critical=!0);var i=s(e);try{for(var o=i.seq,a=0;a<o.length;a++){var c=o[a].tag;0==c.explicit&&("80"==c.tag&&(r.reqexp=parseInt(c.hex,16)),"81"==c.tag&&(r.inhibit=parseInt(c.hex,16)))}}catch(l){return new y("malformed policyConstraints value")}return r}},this.getExtInhibitAnyPolicy=function(e,t){var n=this.getCriticalExtV("inhibitAnyPolicy",e,t);if(e=n[0],t=n[1],null!=e){var r={extname:"inhibitAnyPolicy"};t&&(r.critical=!0);var i=p(e,0);return-1==i?new y("wrong value"):(r.skip=i,r)}},this.getExtCRLNumber=function(e,t){var n={extname:"cRLNumber"};if(t&&(n.critical=!0),"02"==e.substr(0,2))return n.num={hex:i(e,0)},n;throw new y("hExtV parse error: "+e)},this.getExtCRLReason=function(e,t){var n={extname:"cRLReason"};if(t&&(n.critical=!0),"0a"==e.substr(0,2))return n.code=parseInt(i(e,0),16),n;throw new Error("hExtV parse error: "+e)},this.getExtOcspNonce=function(e,t){var n={extname:"ocspNonce"};t&&(n.critical=!0);var r=i(e,0);return n.hex=r,n},this.getExtOcspNoCheck=function(e,t){var n={extname:"ocspNoCheck"};return t&&(n.critical=!0),n},this.getExtAdobeTimeStamp=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("adobeTimeStamp");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var i={extname:"adobeTimeStamp"};t&&(i.critical=!0);var s=r(e,0);if(s.length>1){var a=o(e,s[1]),c=this.getGeneralName(a);void 0!=c.uri&&(i.uri=c.uri)}if(s.length>2){var l=o(e,s[2]);"0101ff"==l&&(i.reqauth=!0),"010100"==l&&(i.reqauth=!1)}return i},this.getExtSubjectDirectoryAttributes=function(e,t){if(void 0===e&&void 0===t){var n=this.getExtInfo("subjectDirectoryAttributes");if(void 0===n)return;e=o(this.hex,n.vidx),t=n.critical}var r={extname:"subjectDirectoryAttributes"};t&&(r.critical=!0);try{for(var i=s(e),a=[],c=0;c<i.seq.length;c++){var l=i.seq[c],u=We(l,"seq.0.oid"),h=We(l,"seq.1.set");if(void 0==u||void 0==h)throw"error";a.push({attr:u,array:h})}return r.array=a,r}catch(d){throw new Error("malformed subjectDirectoryAttributes extension value")}};var b=function(e){var t={};try{var n=e.seq[0].oid,r=ee.asn1.x509.OID.name2oid(n);t.type=ee.asn1.x509.OID.oid2atype(r);var i=e.seq[1];if(void 0!=i.utf8str)t.ds="utf8",t.value=i.utf8str.str;else if(void 0!=i.numstr)t.ds="num",t.value=i.numstr.str;else if(void 0!=i.telstr)t.ds="tel",t.value=i.telstr.str;else if(void 0!=i.prnstr)t.ds="prn",t.value=i.prnstr.str;else if(void 0!=i.ia5str)t.ds="ia5",t.value=i.ia5str.str;else if(void 0!=i.visstr)t.ds="vis",t.value=i.visstr.str;else{if(void 0==i.bmpstr)throw"error";t.ds="bmp",t.value=i.bmpstr.str}return t}catch(s){throw new Erorr("improper ASN.1 parsed AttrTypeAndValue")}},S=function(e){try{return e.set.map((function(e){return b(e)}))}catch(H){throw new Error("improper ASN.1 parsed RDN: "+H)}};this.getX500NameRule=function(e){for(var t=null,n=[],r=0;r<e.length;r++)for(var i=e[r],s=0;s<i.length;s++)n.push(i[s]);for(r=0;r<n.length;r++){var o=n[r],a=o.ds,c=o.value,l=o.type;if(":"+a,"prn"!=a&&"utf8"!=a&&"ia5"!=a)return"mixed";if("ia5"==a){if("CN"!=l)return"mixed";if(ee.lang.String.isMail(c))continue;return"mixed"}if("C"==l){if("prn"==a)continue;return"mixed"}if(":"+a,null==t)t=a;else if(t!==a)return"mixed"}return null==t?"prn":t},this.getAttrTypeAndValue=function(e){var t=s(e);return b(t)},this.getRDN=function(e){var t=s(e);return S(t)},this.getX500NameArray=function(e){return function(t){try{return t.seq.map((function(e){return S(e)}))}catch(e){throw new Error("improper ASN.1 parsed X500Name: "+e)}}(s(e))},this.getX500Name=function(e,t,n){var r=this.getX500NameArray(e),i={str:this.dnarraytostr(r)};return i.array=r,1==n&&(i.hex=e),1==t&&(i.canon=this.c14nRDNArray(r)),i},this.readCertPEM=function(e){this.readCertHex(v(e))},this.readCertHex=function(e){this.hex=e,this.getVersion();try{h(this.hex,0,[0,7],"a3"),this.parseExt()}catch(t){}},this.getParam=function(e){var t={};return void 0==e&&(e={}),t.version=this.getVersion(),t.serial={hex:this.getSerialNumberHex()},t.sigalg=this.getSignatureAlgorithmField(),t.issuer=this.getIssuer(e.dncanon,e.dnhex),t.notbefore=this.getNotBefore(),t.notafter=this.getNotAfter(),t.subject=this.getSubject(e.dncanon,e.dnhex),t.sbjpubkey=Se(this.getPublicKeyHex(),"PUBLIC KEY"),void 0!=this.aExtInfo&&this.aExtInfo.length>0&&(t.ext=this.getExtParamArray()),t.sighex=this.getSignatureValueHex(),1==e.tbshex&&(t.tbshex=l(this.hex,0,[0])),1==e.nodnarray&&(delete t.issuer.array,delete t.subject.array),t},this.getExtParamArray=function(e){void 0==e&&(-1!=d(this.hex,0,[0,"[3]"])&&(e=u(this.hex,0,[0,"[3]",0],"30")));for(var t=[],n=r(e,0),i=0;i<n.length;i++){var s=o(e,n[i]),a=this.getExtParam(s);null!=a&&t.push(a)}return t},this.getExtParam=function(e){var t=r(e,0).length;if(2!=t&&3!=t)throw new Error("wrong number elements in Extension: "+t+" "+e);var n=g(a(e,0,[0],"06")),i=!1;3==t&&"0101ff"==l(e,0,[1])&&(i=!0);var o=l(e,0,[t-1,0]),c=void 0;if("2.5.29.14"==n?c=this.getExtSubjectKeyIdentifier(o,i):"2.5.29.15"==n?c=this.getExtKeyUsage(o,i):"2.5.29.17"==n?c=this.getExtSubjectAltName(o,i):"2.5.29.18"==n?c=this.getExtIssuerAltName(o,i):"2.5.29.19"==n?c=this.getExtBasicConstraints(o,i):"2.5.29.30"==n?c=this.getExtNameConstraints(o,i):"2.5.29.31"==n?c=this.getExtCRLDistributionPoints(o,i):"2.5.29.32"==n?c=this.getExtCertificatePolicies(o,i):"2.5.29.33"==n?c=this.getExtPolicyMappings(o,i):"2.5.29.35"==n?c=this.getExtAuthorityKeyIdentifier(o,i):"2.5.29.36"==n?c=this.getExtPolicyConstraints(o,i):"2.5.29.37"==n?c=this.getExtExtKeyUsage(o,i):"2.5.29.54"==n?c=this.getExtInhibitAnyPolicy(o,i):"1.3.6.1.5.5.7.1.1"==n?c=this.getExtAuthorityInfoAccess(o,i):"2.5.29.20"==n?c=this.getExtCRLNumber(o,i):"2.5.29.21"==n?c=this.getExtCRLReason(o,i):"2.5.29.9"==n?c=this.getExtSubjectDirectoryAttributes(o,i):"1.3.6.1.5.5.7.48.1.2"==n?c=this.getExtOcspNonce(o,i):"1.3.6.1.5.5.7.48.1.5"==n?c=this.getExtOcspNoCheck(o,i):"1.2.840.113583.1.1.9.1"==n?c=this.getExtAdobeTimeStamp(o,i):void 0!=Ye.EXT_PARSER[n]&&(c=Ye.EXT_PARSER[n](n,i,o)),void 0!=c)return c;var u={extname:n,extn:o};try{u.extn=s(o)}catch(h){}return i&&(u.critical=!0),u},this.findExt=function(e,t){for(var n=0;n<e.length;n++)if(e[n].extname==t)return e[n];return null},this.updateExtCDPFullURI=function(e,t){var n=this.findExt(e,"cRLDistributionPoints");if(null!=n&&void 0!=n.array)for(var r=n.array,i=0;i<r.length;i++)if(void 0!=r[i].dpname&&void 0!=r[i].dpname.full)for(var s=r[i].dpname.full,o=0;o<s.length;o++){var a=s[i];void 0!=a.uri&&(a.uri=t)}},this.updateExtAIAOCSP=function(e,t){var n=this.findExt(e,"authorityInfoAccess");if(null!=n&&void 0!=n.array)for(var r=n.array,i=0;i<r.length;i++)void 0!=r[i].ocsp&&(r[i].ocsp=t)},this.updateExtAIACAIssuer=function(e,t){var n=this.findExt(e,"authorityInfoAccess");if(null!=n&&void 0!=n.array)for(var r=n.array,i=0;i<r.length;i++)void 0!=r[i].caissuer&&(r[i].caissuer=t)},this.dnarraytostr=function(e){return"/"+e.map((function(e){return function(e){return e.map((function(e){return function(e){return e.type+"="+e.value}(e).replace(/\+/,"\\+")})).join("+")}(e).replace(/\//,"\\/")})).join("/")},this.setCanonicalizedDN=function(e){var t;if(void 0!=e.str&&void 0==e.array){var n=new ee.asn1.x509.X500Name({str:e.str}).tohex();t=this.getX500NameArray(n)}else t=e.array;void 0==e.canon&&(e.canon=this.c14nRDNArray(t))},this.c14nRDNArray=function(e){for(var t=[],n=0;n<e.length;n++){for(var r=e[n],i=[],s=0;s<r.length;s++){var o=r[s],a=o.value;a=(a=(a=(a=a.replace(/^\s*/,"")).replace(/\s*$/,"")).replace(/\s+/g," ")).toLowerCase(),i.push(o.type.toLowerCase()+"="+a)}t.push(i.join("+"))}return"/"+t.join("/")},this.getInfo=function(){var e,t,n,r=function(e){for(var t="",n="    ",r="\n",i=e.array,s=0;s<i.length;s++){var o=i[s];if(void 0!=o.dn&&(t+=n+"dn: "+o.dn.str+r),void 0!=o.ip&&(t+=n+"ip: "+o.ip+r),void 0!=o.rfc822&&(t+=n+"rfc822: "+o.rfc822+r),void 0!=o.dns&&(t+=n+"dns: "+o.dns+r),void 0!=o.uri&&(t+=n+"uri: "+o.uri+r),void 0!=o.other)t+=n+"other: "+o.other.oid+"="+JSON.stringify(o.other.value).replace(/\"/g,"")+r}return t=t.replace(/\n$/,"")},i=function(e){for(var t="",n=e.array,r=0;r<n.length;r++){var i=n[r];if(t+="    policy oid: "+i.policyoid+"\n",void 0!==i.array)for(var s=0;s<i.array.length;s++){var o=i.array[s];void 0!==o.cps&&(t+="    cps: "+o.cps+"\n")}}return t},s=function(e){for(var t="",n=e.array,r=0;r<n.length;r++){var i=n[r];try{void 0!==i.dpname.full[0].uri&&(t+="    "+i.dpname.full[0].uri+"\n")}catch(s){}try{void 0!==i.dname.full[0].dn.hex&&(t+="    "+Ye.hex2dn(i.dpname.full[0].dn.hex)+"\n")}catch(s){}}return t},o=function(e){for(var t="",n=e.array,r=0;r<n.length;r++){var i=n[r];void 0!==i.caissuer&&(t+="    caissuer: "+i.caissuer+"\n"),void 0!==i.ocsp&&(t+="    ocsp: "+i.ocsp+"\n")}return t};if(e="Basic Fields\n",e+="  serial number: "+this.getSerialNumberHex()+"\n",e+="  signature algorithm: "+this.getSignatureAlgorithmField()+"\n",e+="  issuer: "+this.getIssuerString()+"\n",e+="  notBefore: "+this.getNotBefore()+"\n",e+="  notAfter: "+this.getNotAfter()+"\n",e+="  subject: "+this.getSubjectString()+"\n",e+="  subject public key info: \n",e+="    key algorithm: "+(t=this.getPublicKey()).type+"\n","RSA"===t.type&&(e+="    n="+Le(t.n.toString(16)).substr(0,16)+"...\n",e+="    e="+Le(t.e.toString(16))+"\n"),void 0!==(n=this.aExtInfo)&&null!==n){e+="X509v3 Extensions:\n";for(var a=0;a<n.length;a++){var c=n[a],l=ee.asn1.x509.OID.oid2name(c.oid);""===l&&(l=c.oid);var u="";if(!0===c.critical&&(u="CRITICAL"),e+="  "+l+" "+u+":\n","basicConstraints"===l){var h=this.getExtBasicConstraints();void 0===h.cA?e+="    {}\n":(e+="    cA=true",void 0!==h.pathLen&&(e+=", pathLen="+h.pathLen),e+="\n")}else{var d;if("policyMappings"==l)e+="    "+this.getExtPolicyMappings().array.map((function(e){var t=e;return t[0]+":"+t[1]})).join(", ")+"\n";else if("policyConstraints"==l)e+="    ",void 0!=(d=this.getExtPolicyConstraints()).reqexp&&(e+=" reqexp="+d.reqexp),void 0!=d.inhibit&&(e+=" inhibit="+d.inhibit),e+="\n";else if("inhibitAnyPolicy"==l)e+="    skip="+(d=this.getExtInhibitAnyPolicy()).skip+"\n";else if("keyUsage"==l)e+="    "+this.getExtKeyUsageString()+"\n";else if("subjectKeyIdentifier"==l)e+="    "+this.getExtSubjectKeyIdentifier().kid.hex+"\n";else if("authorityKeyIdentifier"==l){var f=this.getExtAuthorityKeyIdentifier();void 0!==f.kid&&(e+="    kid="+f.kid.hex+"\n")}else{if("extKeyUsage"==l)e+="    "+this.getExtExtKeyUsage().array.join(", ")+"\n";else if("subjectAltName"==l)e+=r(this.getExtSubjectAltName())+"\n";else if("cRLDistributionPoints"==l)e+=s(this.getExtCRLDistributionPoints());else if("authorityInfoAccess"==l)e+=o(this.getExtAuthorityInfoAccess());else"certificatePolicies"==l&&(e+=i(this.getExtCertificatePolicies()))}}}}return e+="signature algorithm: "+this.getSignatureAlgorithmName()+"\n",e+="signature: "+this.getSignatureValueHex().substr(0,16)+"...\n"},"string"==typeof e&&(-1!=e.indexOf("-----BEGIN")?this.readCertPEM(e):ee.lang.String.isHex(e)&&this.readCertHex(e))}J.prototype.sign=function(e,t){var n,r=(n=e,ee.crypto.Util.hashString(n,t));return this.signWithMessageHash(r,t)},J.prototype.signWithMessageHash=function(e,t){var n=G(ee.crypto.Util.getPaddedDigestInfoHex(e,t,this.n.bitLength()),16);return $e(this.doPrivate(n).toString(16),this.n.bitLength())},J.prototype.signPSS=function(e,t,n){var r,i=(r=ge(e),ee.crypto.Util.hashHex(r,t));return void 0===n&&(n=-1),this.signWithMessageHashPSS(i,t,n)},J.prototype.signWithMessageHashPSS=function(e,t,n){var r,i=me(e),s=i.length,o=this.n.bitLength()-1,a=Math.ceil(o/8),c=function(e){return ee.crypto.Util.hashHex(e,t)};if(-1===n||void 0===n)n=s;else if(-2===n)n=a-s-2;else if(n<-2)throw new Error("invalid salt length");if(a<s+n+2)throw new Error("data too long");var l="";n>0&&(l=new Array(n),(new K).nextBytes(l),l=String.fromCharCode.apply(String,l));var u=me(c(ge("\0\0\0\0\0\0\0\0"+i+l))),d=[];for(r=0;r<a-n-s-2;r+=1)d[r]=0;var f=String.fromCharCode.apply(String,d)+"\x01"+l,p=Qe(u,f.length,c),m=[];for(r=0;r<f.length;r+=1)m[r]=f.charCodeAt(r)^p.charCodeAt(r);var g=65280>>8*a-o&255;for(m[0]&=~g,r=0;r<s;r++)m.push(u.charCodeAt(r));return m.push(188),$e(this.doPrivate(new h(m)).toString(16),this.n.bitLength())},J.prototype.verify=function(e,t){if(null==(t=t.toLowerCase()).match(/^[0-9a-f]+$/))return!1;var n=G(t,16),r=this.n.bitLength();if(n.bitLength()>r)return!1;var i=this.doPublic(n).toString(16);if(i.length+3!=r/4)return!1;var s=Xe(i.replace(/^1f+00/,""));if(0==s.length)return!1;var o,a=s[0];return s[1]==(o=e,ee.crypto.Util.hashString(o,a))},J.prototype.verifyWithMessageHash=function(e,t){if(t.length!=Math.ceil(this.n.bitLength()/4))return!1;var n=G(t,16);if(n.bitLength()>this.n.bitLength())return 0;var r=Xe(this.doPublic(n).toString(16).replace(/^1f+00/,""));if(0==r.length)return!1;r[0];return r[1]==e},J.prototype.verifyPSS=function(e,t,n,r){var i,s=(i=ge(e),ee.crypto.Util.hashHex(i,n));return void 0===r&&(r=-1),this.verifyWithMessageHashPSS(s,t,n,r)},J.prototype.verifyWithMessageHashPSS=function(e,t,n,r){if(t.length!=Math.ceil(this.n.bitLength()/4))return!1;var i,s=new h(t,16),o=function(e){return ee.crypto.Util.hashHex(e,n)},a=me(e),c=a.length,l=this.n.bitLength()-1,u=Math.ceil(l/8);if(-1===r||void 0===r)r=c;else if(-2===r)r=u-c-2;else if(r<-2)throw new Error("invalid salt length");if(u<c+r+2)throw new Error("data too long");var d=this.doPublic(s).toByteArray();for(i=0;i<d.length;i+=1)d[i]&=255;for(;d.length<u;)d.unshift(0);if(188!==d[u-1])throw new Error("encoded message does not end in 0xbc");var f=(d=String.fromCharCode.apply(String,d)).substr(0,u-c-1),p=d.substr(f.length,c),m=65280>>8*u-l&255;if(0!==(f.charCodeAt(0)&m))throw new Error("bits beyond keysize not zero");var g=Qe(p,f.length,o),v=[];for(i=0;i<f.length;i+=1)v[i]=f.charCodeAt(i)^g.charCodeAt(i);v[0]&=~m;var y=u-c-r-2;for(i=0;i<y;i+=1)if(0!==v[i])throw new Error("leftmost octets not zero");if(1!==v[y])throw new Error("0x01 marker not found");return p===me(o(ge("\0\0\0\0\0\0\0\0"+a+String.fromCharCode.apply(String,v.slice(-r)))))},J.SALT_LEN_HLEN=-1,J.SALT_LEN_MAX=-2,J.SALT_LEN_RECOVER=-2,Ye.EXT_PARSER={},Ye.registExtParser=function(e,t){Ye.EXT_PARSER[e]=t},Ye.hex2dn=function(e,t){void 0===t&&(t=0);var n=new Ye;re.getTLV(e,t);return n.getX500Name(e).str},Ye.hex2rdn=function(e,t){if(void 0===t&&(t=0),"31"!==e.substr(t,2))throw new Error("malformed RDN");for(var n=new Array,r=re.getChildIdx(e,t),i=0;i<r.length;i++)n.push(Ye.hex2attrTypeValue(e,r[i]));return(n=n.map((function(e){return e.replace("+","\\+")}))).join("+")},Ye.hex2attrTypeValue=function(e,t){var n=re,r=n.getV;if(void 0===t&&(t=0),"30"!==e.substr(t,2))throw new Error("malformed attribute type and value");var i=n.getChildIdx(e,t);2!==i.length||e.substr(i[0],2);var s=r(e,i[0]),o=ee.asn1.ASN1Util.oidHexToInt(s);return ee.asn1.x509.OID.oid2atype(o)+"="+me(r(e,i[1]))},Ye.getPublicKeyFromCertHex=function(e){var t=new Ye;return t.readCertHex(e),t.getPublicKey()},Ye.getPublicKeyFromCertPEM=function(e){var t=new Ye;return t.readCertPEM(e),t.getPublicKey()},Ye.getPublicKeyInfoPropOfCertPEM=function(e){var t,n,r=re.getVbyList,i={};return i.algparam=null,(t=new Ye).readCertPEM(e),n=t.getPublicKeyHex(),i.keyhex=r(n,0,[1],"03").substr(2),i.algoid=r(n,0,[0,0],"06"),"2a8648ce3d0201"===i.algoid&&(i.algparam=r(n,0,[0,1],"06")),i},Ye.KEYUSAGE_NAME=["digitalSignature","nonRepudiation","keyEncipherment","dataEncipherment","keyAgreement","keyCertSign","cRLSign","encipherOnly","decipherOnly"];"undefined"!=typeof ee&&ee||(ee={}),"undefined"!=typeof ee.jws&&ee.jws||(ee.jws={}),ee.jws.JWS=function(){var e=ee.jws.JWS.isSafeJSONString;this.parseJWS=function(t,n){if(void 0===this.parsedJWS||!n&&void 0===this.parsedJWS.sigvalH){var r=t.match(/^([^.]+)\.([^.]+)\.([^.]+)$/);if(null==r)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";var i=r[1],s=r[2],o=r[3],a=i+"."+s;if(this.parsedJWS={},this.parsedJWS.headB64U=i,this.parsedJWS.payloadB64U=s,this.parsedJWS.sigvalB64U=o,this.parsedJWS.si=a,!n){var c=he(o),l=G(c,16);this.parsedJWS.sigvalH=c,this.parsedJWS.sigvalBI=l}var u=ne(i),h=ne(s);if(this.parsedJWS.headS=u,this.parsedJWS.payloadS=h,!e(u,this.parsedJWS,"headP"))throw"malformed JSON string for JWS Head: "+u}}},ee.jws.JWS.sign=function(e,t,n,r,i){var s,o,a,c=ee,l=c.jws.JWS,u=l.readSafeJSONString,h=l.isSafeJSONString,d=c.crypto,f=(d.ECDSA,d.Mac),p=d.Signature,m=JSON;if("string"!=typeof t&&"object"!=typeof t)throw"spHeader must be JSON string or object: "+t;if("object"==typeof t&&(o=t,s=m.stringify(o)),"string"==typeof t){if(!h(s=t))throw"JWS Head is not safe JSON string: "+s;o=u(s)}if(a=n,"object"==typeof n&&(a=m.stringify(n)),""!=e&&null!=e||void 0===o.alg||(e=o.alg),""!=e&&null!=e&&void 0===o.alg&&(o.alg=e,s=m.stringify(o)),e!==o.alg)throw"alg and sHeader.alg doesn't match: "+e+"!="+o.alg;var g=null;if(void 0===l.jwsalg2sigalg[e])throw"unsupported alg name: "+e;g=l.jwsalg2sigalg[e];var v=te(s)+"."+te(a),y="";if("Hmac"==g.substr(0,4)){if(void 0===r)throw"mac key shall be specified for HS* alg";var b=new f({alg:g,prov:"cryptojs",pass:r});b.updateString(v),y=b.doFinal()}else if(-1!=g.indexOf("withECDSA")){(w=new p({alg:g})).init(r,i),w.updateString(v);var S=w.sign();y=ee.crypto.ECDSA.asn1SigToConcatSig(S)}else{var w;if("none"!=g)(w=new p({alg:g})).init(r,i),w.updateString(v),y=w.sign()}return v+"."+ue(y)},ee.jws.JWS.verify=function(e,t,n){var r,i=ee,s=i.jws.JWS,o=s.readSafeJSONString,a=i.crypto,c=a.ECDSA,l=a.Mac,u=a.Signature;if(r=J,!Be(e))return!1;var h=e.split(".");if(3!==h.length)return!1;var d=h[0]+"."+h[1],f=he(h[2]),p=o(ne(h[0])),m=null,g=null;if(void 0===p.alg)throw"algorithm not specified in header";if((g=(m=p.alg).substr(0,2),null!=n&&"[object Array]"===Object.prototype.toString.call(n)&&n.length>0)&&-1==(":"+n.join(":")+":").indexOf(":"+m+":"))throw"algorithm '"+m+"' not accepted in the list";if("none"!=m&&null===t)throw"key shall be specified to verify.";if("string"==typeof t&&-1!=t.indexOf("-----BEGIN ")&&(t=Ze.getKey(t)),("RS"==g||"PS"==g)&&!(t instanceof r))throw"key shall be a RSAKey obj for RS* and PS* algs";if("ES"==g&&!(t instanceof c))throw"key shall be a ECDSA obj for ES* algs";var v=null;if(void 0===s.jwsalg2sigalg[p.alg])throw"unsupported alg name: "+m;if("none"==(v=s.jwsalg2sigalg[m]))throw"not supported";if("Hmac"==v.substr(0,4)){if(void 0===t)throw"hexadecimal key shall be specified for HMAC";var y=new l({alg:v,pass:t});return y.updateString(d),f==y.doFinal()}if(-1!=v.indexOf("withECDSA")){var b,S=null;try{S=c.concatSigToASN1Sig(f)}catch(w){return!1}return(b=new u({alg:v})).init(t),b.updateString(d),b.verify(S)}return(b=new u({alg:v})).init(t),b.updateString(d),b.verify(f)},ee.jws.JWS.parse=function(e){var t,n,r,i=e.split("."),s={};if(2!=i.length&&3!=i.length)throw"malformed sJWS: wrong number of '.' splitted elements";return t=i[0],n=i[1],3==i.length&&(r=i[2]),s.headerObj=ee.jws.JWS.readSafeJSONString(ne(t)),s.payloadObj=ee.jws.JWS.readSafeJSONString(ne(n)),s.headerPP=JSON.stringify(s.headerObj,null,"  "),null==s.payloadObj?s.payloadPP=ne(n):s.payloadPP=JSON.stringify(s.payloadObj,null,"  "),void 0!==r&&(s.sigHex=he(r)),s},ee.jws.JWS.verifyJWT=function(e,t,n){var r=ee.jws,i=r.JWS,s=i.readSafeJSONString,o=i.inArray,a=i.includedArray;if(!Be(e))return!1;var c=e.split(".");if(3!=c.length)return!1;var l=c[0],u=c[1],h=(he(c[2]),s(ne(l))),d=s(ne(u));if(void 0===h.alg)return!1;if(void 0===n.alg)throw"acceptField.alg shall be specified";if(!o(h.alg,n.alg))return!1;if(void 0!==d.iss&&"object"===typeof n.iss&&!o(d.iss,n.iss))return!1;if(void 0!==d.sub&&"object"===typeof n.sub&&!o(d.sub,n.sub))return!1;if(void 0!==d.aud&&"object"===typeof n.aud)if("string"==typeof d.aud){if(!o(d.aud,n.aud))return!1}else if("object"==typeof d.aud&&!a(d.aud,n.aud))return!1;var f=r.IntDate.getNow();return void 0!==n.verifyAt&&"number"===typeof n.verifyAt&&(f=n.verifyAt),void 0!==n.gracePeriod&&"number"===typeof n.gracePeriod||(n.gracePeriod=0),!(void 0!==d.exp&&"number"==typeof d.exp&&d.exp+n.gracePeriod<f)&&(!(void 0!==d.nbf&&"number"==typeof d.nbf&&f<d.nbf-n.gracePeriod)&&(!(void 0!==d.iat&&"number"==typeof d.iat&&f<d.iat-n.gracePeriod)&&((void 0===d.jti||void 0===n.jti||d.jti===n.jti)&&!!i.verify(e,t,n.alg))))},ee.jws.JWS.includedArray=function(e,t){var n=ee.jws.JWS.inArray;if(null===e)return!1;if("object"!==typeof e)return!1;if("number"!==typeof e.length)return!1;for(var r=0;r<e.length;r++)if(!n(e[r],t))return!1;return!0},ee.jws.JWS.inArray=function(e,t){if(null===t)return!1;if("object"!==typeof t)return!1;if("number"!==typeof t.length)return!1;for(var n=0;n<t.length;n++)if(t[n]==e)return!0;return!1},ee.jws.JWS.jwsalg2sigalg={HS256:"HmacSHA256",HS384:"HmacSHA384",HS512:"HmacSHA512",RS256:"SHA256withRSA",RS384:"SHA384withRSA",RS512:"SHA512withRSA",ES256:"SHA256withECDSA",ES384:"SHA384withECDSA",ES512:"SHA512withECDSA",PS256:"SHA256withRSAandMGF1",PS384:"SHA384withRSAandMGF1",PS512:"SHA512withRSAandMGF1",none:"none"},ee.jws.JWS.isSafeJSONString=function(e,t,n){var r=null;try{return"object"!=typeof(r=Y(e))||r.constructor===Array?0:(t&&(t[n]=r),1)}catch(i){return 0}},ee.jws.JWS.readSafeJSONString=function(e){var t=null;try{return"object"!=typeof(t=Y(e))||t.constructor===Array?null:t}catch(n){return null}},ee.jws.JWS.getEncodedSignatureValueFromJWS=function(e){var t=e.match(/^[^.]+\.[^.]+\.([^.]+)$/);if(null==t)throw"JWS signature is not a form of 'Head.Payload.SigValue'.";return t[1]},ee.jws.JWS.getJWKthumbprint=function(e){if("RSA"!==e.kty&&"EC"!==e.kty&&"oct"!==e.kty)throw"unsupported algorithm for JWK Thumprint";var t="{";if("RSA"===e.kty){if("string"!=typeof e.n||"string"!=typeof e.e)throw"wrong n and e value for RSA key";t+='"e":"'+e.e+'",',t+='"kty":"'+e.kty+'",',t+='"n":"'+e.n+'"}'}else if("EC"===e.kty){if("string"!=typeof e.crv||"string"!=typeof e.x||"string"!=typeof e.y)throw"wrong crv, x and y value for EC key";t+='"crv":"'+e.crv+'",',t+='"kty":"'+e.kty+'",',t+='"x":"'+e.x+'",',t+='"y":"'+e.y+'"}'}else if("oct"===e.kty){if("string"!=typeof e.k)throw"wrong k value for oct(symmetric) key";t+='"kty":"'+e.kty+'",',t+='"k":"'+e.k+'"}'}var n=ge(t);return ue(ee.crypto.Util.hashHex(n,"sha256"))},ee.jws.IntDate={},ee.jws.IntDate.get=function(e){var t=ee.jws.IntDate,n=t.getNow,r=t.getZulu;if("now"==e)return n();if("now + 1hour"==e)return n()+3600;if("now + 1day"==e)return n()+86400;if("now + 1month"==e)return n()+2592e3;if("now + 1year"==e)return n()+31536e3;if(e.match(/Z$/))return r(e);if(e.match(/^[0-9]+$/))return parseInt(e);throw"unsupported format: "+e},ee.jws.IntDate.getZulu=function(e){return xe(e)},ee.jws.IntDate.getNow=function(){return~~(new Date/1e3)},ee.jws.IntDate.intDate2UTCString=function(e){return new Date(1e3*e).toUTCString()},ee.jws.IntDate.intDate2Zulu=function(e){var t=new Date(1e3*e);return("0000"+t.getUTCFullYear()).slice(-4)+("00"+(t.getUTCMonth()+1)).slice(-2)+("00"+t.getUTCDate()).slice(-2)+("00"+t.getUTCHours()).slice(-2)+("00"+t.getUTCMinutes()).slice(-2)+("00"+t.getUTCSeconds()).slice(-2)+"Z"},"undefined"!=typeof ee&&ee||(ee={}),"undefined"!=typeof ee.jws&&ee.jws||(ee.jws={}),ee.jws.JWSJS=function(){var e=ee.jws.JWS,t=e.readSafeJSONString;this.aHeader=[],this.sPayload="",this.aSignature=[],this.init=function(){this.aHeader=[],this.sPayload=void 0,this.aSignature=[]},this.initWithJWS=function(e){this.init();var t=e.split(".");if(3!=t.length)throw"malformed input JWS";this.aHeader.push(t[0]),this.sPayload=t[1],this.aSignature.push(t[2])},this.addSignature=function(e,t,n,r){if(void 0===this.sPayload||null===this.sPayload)throw"there's no JSON-JS signature to add.";var i=this.aHeader.length;if(this.aHeader.length!=this.aSignature.length)throw"aHeader.length != aSignature.length";try{var s=ee.jws.JWS.sign(e,t,this.sPayload,n,r).split(".");s[0],s[2];this.aHeader.push(s[0]),this.aSignature.push(s[2])}catch(o){throw this.aHeader.length>i&&this.aHeader.pop(),this.aSignature.length>i&&this.aSignature.pop(),"addSignature failed: "+o}},this.verifyAll=function(e){if(this.aHeader.length!==e.length||this.aSignature.length!==e.length)return!1;for(var t=0;t<e.length;t++){var n=e[t];if(2!==n.length)return!1;if(!1===this.verifyNth(t,n[0],n[1]))return!1}return!0},this.verifyNth=function(t,n,r){if(this.aHeader.length<=t||this.aSignature.length<=t)return!1;var i=this.aHeader[t],s=this.aSignature[t],o=i+"."+this.sPayload+"."+s,a=!1;try{a=e.verify(o,n,r)}catch(c){return!1}return a},this.readJWSJS=function(e){if("string"===typeof e){var n=t(e);if(null==n)throw"argument is not safe JSON object string";this.aHeader=n.headers,this.sPayload=n.payload,this.aSignature=n.signatures}else try{if(!(e.headers.length>0))throw"malformed header";if(this.aHeader=e.headers,"string"!==typeof e.payload)throw"malformed signatures";if(this.sPayload=e.payload,!(e.signatures.length>0))throw"malformed signatures";this.aSignature=e.signatures}catch(r){throw"malformed JWS-JS JSON object: "+r}},this.getJSON=function(){return{headers:this.aHeader,payload:this.sPayload,signatures:this.aSignature}},this.isEmpty=function(){return 0==this.aHeader.length?1:0}},ee.crypto.ECDSA,ee.crypto.DSA,ee.crypto.Signature,ee.crypto.MessageDigest,ee.crypto.Mac,ee.crypto.Cipher,t.pj=ee,ee.crypto,ee.asn1,ee.jws,ee.lang},31:(e,t)=>{"use strict";var n,r,i,s,o,a,c,l,u,h,d,f,p,m,g,v,y,b;t.ZU=t.RF=t.pX=t.Mb=t.Cy=t.ZP=t.b8=t.Ck=t.e6=void 0,t.e6=Symbol.for("TypeBox.Modifier"),t.Ck=Symbol.for("TypeBox.Hint"),t.b8=Symbol.for("TypeBox.Kind"),t.ZP="(true|false)",t.Cy="(0|[1-9][0-9]*)",t.Mb="(.*)","^".concat(t.ZP,"$"),t.pX="^".concat(t.Cy,"$"),t.RF="^".concat(t.Mb,"$"),function(e){const t=new Map;e.Entries=function(){return new Map(t)},e.Clear=function(){return t.clear()},e.Has=function(e){return t.has(e)},e.Set=function(e,n){t.set(e,n)},e.Get=function(e){return t.get(e)}}(n||(n={})),function(e){const t=new Map;e.Entries=function(){return new Map(t)},e.Clear=function(){return t.clear()},e.Has=function(e){return t.has(e)},e.Set=function(e,n){t.set(e,n)},e.Get=function(e){return t.get(e)}}(r||(r={}));class S extends Error{constructor(e){super("TypeGuard: Unknown type"),this.schema=e}}(function(e){function r(e){return"object"===typeof e&&null!==e&&!Array.isArray(e)}function i(e){return"object"===typeof e&&null!==e&&Array.isArray(e)}function s(e){try{return new RegExp(e),!0}catch{return!1}}function o(e){if("string"!==typeof e)return!1;for(let t=0;t<e.length;t++){const n=e.charCodeAt(t);if(n>=7&&n<=13||27===n||127===n)return!1}return!0}function a(e){return d(e)||W(e)}function c(e){return"string"===typeof e}function l(e){return"number"===typeof e&&globalThis.Number.isFinite(e)}function u(e){return void 0===e||void 0!==e&&function(e){return"bigint"===typeof e}(e)}function h(e){return void 0===e||void 0!==e&&l(e)}function d(e){return void 0===e||void 0!==e&&function(e){return"boolean"===typeof e}(e)}function f(e){return void 0===e||void 0!==e&&c(e)}function p(e){return x(e)&&"Any"===e[t.b8]&&f(e.$id)}function m(e){return x(e)&&"Array"===e[t.b8]&&"array"===e.type&&f(e.$id)&&W(e.items)&&h(e.minItems)&&h(e.maxItems)&&d(e.uniqueItems)}function g(e){return x(e)&&"BigInt"===e[t.b8]&&"null"===e.type&&"BigInt"===e.typeOf&&f(e.$id)&&u(e.multipleOf)&&u(e.minimum)&&u(e.maximum)&&u(e.exclusiveMinimum)&&u(e.exclusiveMaximum)}function v(e){return x(e)&&"Boolean"===e[t.b8]&&"boolean"===e.type&&f(e.$id)}function y(e){if(!(x(e)&&"Constructor"===e[t.b8]&&"object"===e.type&&"Constructor"===e.instanceOf&&f(e.$id)&&i(e.parameters)&&W(e.returns)))return!1;for(const t of e.parameters)if(!W(t))return!1;return!0}function b(e){return x(e)&&"Date"===e[t.b8]&&"object"===e.type&&"Date"===e.instanceOf&&f(e.$id)&&h(e.minimumTimestamp)&&h(e.maximumTimestamp)&&h(e.exclusiveMinimumTimestamp)&&h(e.exclusiveMaximumTimestamp)}function S(e){if(!(x(e)&&"Function"===e[t.b8]&&"object"===e.type&&"Function"===e.instanceOf&&f(e.$id)&&i(e.parameters)&&W(e.returns)))return!1;for(const t of e.parameters)if(!W(t))return!1;return!0}function w(e){return x(e)&&"Integer"===e[t.b8]&&"integer"===e.type&&f(e.$id)&&h(e.multipleOf)&&h(e.minimum)&&h(e.maximum)&&h(e.exclusiveMinimum)&&h(e.exclusiveMaximum)}function C(e){if(!(x(e)&&"Intersect"===e[t.b8]&&i(e.allOf)&&f(e.type)&&(d(e.unevaluatedProperties)||(n=e.unevaluatedProperties,void 0===n||W(n)))&&f(e.$id)))return!1;var n;if("type"in e&&"object"!==e.type)return!1;for(const t of e.allOf)if(!W(t))return!1;return!0}function x(e){return r(e)&&t.b8 in e&&"string"===typeof e[t.b8]}function E(e){return x(e)&&"Literal"===e[t.b8]&&f(e.$id)&&"string"===typeof e.const}function T(e){return x(e)&&"Literal"===e[t.b8]&&f(e.$id)&&"number"===typeof e.const}function k(e){return x(e)&&"Literal"===e[t.b8]&&f(e.$id)&&"boolean"===typeof e.const}function N(e){return E(e)||T(e)||k(e)}function F(e){return x(e)&&"Never"===e[t.b8]&&r(e.not)&&0===globalThis.Object.getOwnPropertyNames(e.not).length}function I(e){return x(e)&&"Not"===e[t.b8]&&W(e.not)}function A(e){return x(e)&&"Null"===e[t.b8]&&"null"===e.type&&f(e.$id)}function D(e){return x(e)&&"Number"===e[t.b8]&&"number"===e.type&&f(e.$id)&&h(e.multipleOf)&&h(e.minimum)&&h(e.maximum)&&h(e.exclusiveMinimum)&&h(e.exclusiveMaximum)}function O(e){if(!(x(e)&&"Object"===e[t.b8]&&"object"===e.type&&f(e.$id)&&r(e.properties)&&a(e.additionalProperties)&&h(e.minProperties)&&h(e.maxProperties)))return!1;for(const[t,n]of Object.entries(e.properties)){if(!o(t))return!1;if(!W(n))return!1}return!0}function P(e){return x(e)&&"Promise"===e[t.b8]&&"object"===e.type&&"Promise"===e.instanceOf&&f(e.$id)&&W(e.item)}function R(e){if(!(x(e)&&"Record"===e[t.b8]&&"object"===e.type&&f(e.$id)&&a(e.additionalProperties)&&r(e.patternProperties)))return!1;const n=Object.keys(e.patternProperties);return 1===n.length&&(!!s(n[0])&&!!W(e.patternProperties[n[0]]))}function M(e){return x(e)&&"Ref"===e[t.b8]&&f(e.$id)&&c(e.$ref)}function B(e){return x(e)&&"String"===e[t.b8]&&"string"===e.type&&f(e.$id)&&h(e.minLength)&&h(e.maxLength)&&(void 0===(n=e.pattern)||void 0!==n&&c(n)&&o(n)&&s(n))&&function(e){return void 0===e||void 0!==e&&c(e)&&o(e)}(e.format);var n}function L(e){return x(e)&&"Symbol"===e[t.b8]&&"null"===e.type&&"Symbol"===e.typeOf&&f(e.$id)}function q(e){return x(e)&&"TemplateLiteral"===e[t.b8]&&"string"===e.type&&c(e.pattern)&&"^"===e.pattern[0]&&"$"===e.pattern[e.pattern.length-1]}function _(e){return x(e)&&"This"===e[t.b8]&&f(e.$id)&&c(e.$ref)}function j(e){if(!(x(e)&&"Tuple"===e[t.b8]&&"array"===e.type&&f(e.$id)&&l(e.minItems)&&l(e.maxItems)&&e.minItems===e.maxItems))return!1;if(void 0===e.items&&void 0===e.additionalItems&&0===e.minItems)return!0;if(!i(e.items))return!1;for(const t of e.items)if(!W(t))return!1;return!0}function z(e){return x(e)&&"Undefined"===e[t.b8]&&"null"===e.type&&"Undefined"===e.typeOf&&f(e.$id)}function U(e){if(!(x(e)&&"Union"===e[t.b8]&&i(e.anyOf)&&f(e.$id)))return!1;for(const t of e.anyOf)if(!W(t))return!1;return!0}function H(e){return x(e)&&"Uint8Array"===e[t.b8]&&"object"===e.type&&f(e.$id)&&"Uint8Array"===e.instanceOf&&h(e.minByteLength)&&h(e.maxByteLength)}function V(e){return x(e)&&"Unknown"===e[t.b8]&&f(e.$id)}function K(e){return x(e)&&"Unsafe"===e[t.b8]}function G(e){return x(e)&&"Void"===e[t.b8]&&"null"===e.type&&"Void"===e.typeOf&&f(e.$id)}function W(e){return"object"===typeof e&&(p(e)||m(e)||v(e)||g(e)||y(e)||b(e)||S(e)||w(e)||C(e)||N(e)||F(e)||I(e)||A(e)||D(e)||O(e)||P(e)||R(e)||M(e)||B(e)||L(e)||q(e)||_(e)||j(e)||z(e)||U(e)||H(e)||V(e)||K(e)||G(e)||x(e)&&n.Has(e[t.b8]))}e.TAny=p,e.TArray=m,e.TBigInt=g,e.TBoolean=v,e.TConstructor=y,e.TDate=b,e.TFunction=S,e.TInteger=w,e.TIntersect=C,e.TKind=x,e.TLiteralString=E,e.TLiteralNumber=T,e.TLiteralBoolean=k,e.TLiteral=N,e.TNever=F,e.TNot=I,e.TNull=A,e.TNumber=D,e.TObject=O,e.TPromise=P,e.TRecord=R,e.TRef=M,e.TString=B,e.TSymbol=L,e.TTemplateLiteral=q,e.TThis=_,e.TTuple=j,e.TUndefined=z,e.TUnionLiteral=function(e){return U(e)&&e.anyOf.every((e=>E(e)||T(e)))},e.TUnion=U,e.TUint8Array=H,e.TUnknown=V,e.TUnsafe=K,e.TVoid=G,e.TReadonlyOptional=function(e){return r(e)&&"ReadonlyOptional"===e[t.e6]},e.TReadonly=function(e){return r(e)&&"Readonly"===e[t.e6]},e.TOptional=function(e){return r(e)&&"Optional"===e[t.e6]},e.TSchema=W})(i||(i={})),function(e){e.Check=function e(n){if("Undefined"===n[t.b8])return!0;if("Not"===n[t.b8])return!e(n.not);if("Intersect"===n[t.b8]){return n.allOf.every((t=>e(t)))}if("Union"===n[t.b8]){return n.anyOf.some((t=>e(t)))}return!1}}(s||(s={})),function(e){e[e.Union=0]="Union",e[e.True=1]="True",e[e.False=2]="False"}(o||(o={})),function(e){function n(e){return e===o.False?o.False:o.True}function r(e,t){return o.True}function s(e,t){return i.TLiteral(e)&&"boolean"===typeof e.const||i.TBoolean(e)?o.True:o.False}function a(e,t){return i.TLiteral(e)&&"number"===typeof e.const||i.TNumber(e)||i.TInteger(e)?o.True:o.False}function c(e,t){return t.allOf.every((t=>P(e,t)===o.True))?o.True:o.False}function l(e){return"string"===typeof e.const}function u(e){return"number"===typeof e.const}function h(e,t){return o.False}function d(e){let[n,r]=[e,0];for(;i.TNot(n);)n=n.not,r+=1;return r%2===0?n:t.ZU.Unknown()}function f(e,t){return i.TLiteral(e)&&u(e)||i.TNumber(e)||i.TInteger(e)?o.True:o.False}function p(e,t){return globalThis.Object.keys(e.properties).length===t}function g(e){return S(e)}function v(e){return p(e,0)||p(e,1)&&"description"in e.properties&&i.TUnion(e.properties.description)&&2===e.properties.description.anyOf.length&&(i.TString(e.properties.description.anyOf[0])&&i.TUndefined(e.properties.description.anyOf[1])||i.TString(e.properties.description.anyOf[1])&&i.TUndefined(e.properties.description.anyOf[0]))}function y(e){return p(e,0)}function b(e){return p(e,0)}function S(e){const r=t.ZU.Number();return p(e,0)||p(e,1)&&"length"in e.properties&&n(P(e.properties.length,r))===o.True}function w(e,t){return P(e,t)===o.False||i.TOptional(e)&&!i.TOptional(t)?o.False:o.True}function C(e,r){return i.TUnknown(e)?o.False:i.TAny(e)?o.Union:i.TNever(e)||i.TLiteral(e)&&l(e)&&g(r)||i.TLiteral(e)&&u(e)&&y(r)||i.TLiteral(e)&&"boolean"===typeof e.const&&b(r)||i.TSymbol(e)&&v(r)||i.TBigInt(e)&&function(e){return p(e,0)}(r)||i.TString(e)&&g(r)||i.TSymbol(e)&&v(r)||i.TNumber(e)&&y(r)||i.TInteger(e)&&y(r)||i.TBoolean(e)&&b(r)||i.TUint8Array(e)&&function(e){return S(e)}(r)||i.TDate(e)&&function(e){return p(e,0)}(r)||i.TConstructor(e)&&function(e){return p(e,0)}(r)||i.TFunction(e)&&function(e){const r=t.ZU.Number();return p(e,0)||p(e,1)&&"length"in e.properties&&n(P(e.properties.length,r))===o.True}(r)?o.True:i.TRecord(e)&&i.TString(E(e))?"Record"===r[t.Ck]?o.True:o.False:i.TRecord(e)&&i.TNumber(E(e))&&p(r,0)?o.True:o.False}function x(e,s){return i.TIntersect(s)?c(e,s):i.TUnion(s)?A(e,s):i.TUnknown(s)?D(e,s):i.TAny(s)?r():i.TObject(s)&&function(e){const r=t.ZU.Function([t.ZU.Any()],t.ZU.Any());return p(e,0)||p(e,1)&&"then"in e.properties&&n(P(e.properties.then,r))===o.True}(s)?o.True:i.TPromise(s)?n(P(e.item,s.item)):o.False}function E(e){if(t.pX in e.patternProperties)return t.ZU.Number();if(t.RF in e.patternProperties)return t.ZU.String();throw Error("TypeExtends: Cannot get record key")}function T(e){if(t.pX in e.patternProperties)return e.patternProperties[t.pX];if(t.RF in e.patternProperties)return e.patternProperties[t.RF];throw Error("TypeExtends: Cannot get record value")}function k(e,t){const r=E(t),s=T(t);if(i.TLiteral(e)&&l(e)&&i.TNumber(r)&&n(P(e,s))===o.True)return o.True;if(i.TUint8Array(e)&&i.TNumber(r))return P(e,s);if(i.TString(e)&&i.TNumber(r))return P(e,s);if(i.TArray(e)&&i.TNumber(r))return P(e,s);if(i.TObject(e)){for(const t of globalThis.Object.keys(e.properties))if(w(s,e.properties[t])===o.False)return o.False;return o.True}return o.False}function N(e,t){return i.TLiteral(e)&&"string"===typeof e.const||i.TString(e)?o.True:o.False}function F(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TUnknown(t)?D(e,t):i.TAny(t)?r():i.TObject(t)&&S(t)||i.TArray(t)&&function(e,t){return i.TArray(t)&&void 0!==e.items&&e.items.every((e=>P(e,t.items)===o.True))}(e,t)?o.True:i.TTuple(t)?void 0===e.items&&void 0!==t.items||void 0!==e.items&&void 0===t.items?o.False:void 0===e.items&&void 0===t.items||e.items.every(((e,n)=>P(e,t.items[n])===o.True))?o.True:o.False:o.False}function I(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TNever(t)?h():i.TUnknown(t)?D(e,t):i.TAny(t)?r():i.TObject(t)?C(e,t):i.TRecord(t)?k(e,t):i.TVoid(t)?function(e,t){return i.TUndefined(e)||i.TUndefined(e)?o.True:o.False}(e):i.TUndefined(t)?o.True:o.False}function A(e,t){return t.anyOf.some((t=>P(e,t)===o.True))?o.True:o.False}function D(e,t){return o.True}function O(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TAny(t)?r():i.TString(t)?N(e):i.TNumber(t)?f(e):i.TInteger(t)?a(e):i.TBoolean(t)?s(e):i.TArray(t)||i.TTuple(t)?function(e,t){return i.TUnknown(e)?o.False:i.TAny(e)?o.Union:i.TNever(e)?o.True:o.False}(e):i.TObject(t)?C(e,t):i.TUnknown(t)?o.True:o.False}function P(e,l){if(i.TTemplateLiteral(e)||i.TTemplateLiteral(l))return function(e,t){if(i.TTemplateLiteral(e))return P(m.Resolve(e),t);if(i.TTemplateLiteral(t))return P(e,m.Resolve(t));throw new Error("TypeExtends: Invalid fallthrough for TemplateLiteral")}(e,l);if(i.TNot(e)||i.TNot(l))return function(e,t){if(i.TNot(e))return P(d(e),t);if(i.TNot(t))return P(e,d(t));throw new Error("TypeExtends: Invalid fallthrough for Not")}(e,l);if(i.TAny(e))return function(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)&&t.anyOf.some((e=>i.TAny(e)||i.TUnknown(e)))?o.True:i.TUnion(t)?o.Union:i.TUnknown(t)||i.TAny(t)?o.True:o.Union}(e,l);if(i.TArray(e))return function(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TUnknown(t)?D():i.TAny(t)?r():i.TObject(t)&&S(t)?o.True:i.TArray(t)?n(P(e.items,t.items)):o.False}(e,l);if(i.TBigInt(e))return function(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TNever(t)?h():i.TUnknown(t)?D():i.TAny(t)?r():i.TObject(t)?C(e,t):i.TRecord(t)?k(e,t):i.TBigInt(t)?o.True:o.False}(e,l);if(i.TBoolean(e))return function(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TNever(t)?h():i.TUnknown(t)?D():i.TAny(t)?r():i.TObject(t)?C(e,t):i.TRecord(t)?k(e,t):i.TBoolean(t)?o.True:o.False}(e,l);if(i.TConstructor(e))return function(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TUnknown(t)?D():i.TAny(t)?r():i.TObject(t)?C(e,t):i.TConstructor(t)?e.parameters.length>t.parameters.length?o.False:e.parameters.every(((e,r)=>n(P(t.parameters[r],e))===o.True))?n(P(e.returns,t.returns)):o.False:o.False}(e,l);if(i.TDate(e))return function(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TUnknown(t)?D():i.TAny(t)?r():i.TObject(t)?C(e,t):i.TRecord(t)?k(e,t):i.TDate(t)?o.True:o.False}(e,l);if(i.TFunction(e))return function(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TUnknown(t)?D():i.TAny(t)?r():i.TObject(t)?C(e,t):i.TFunction(t)?e.parameters.length>t.parameters.length?o.False:e.parameters.every(((e,r)=>n(P(t.parameters[r],e))===o.True))?n(P(e.returns,t.returns)):o.False:o.False}(e,l);if(i.TInteger(e))return function(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TNever(t)?h():i.TUnknown(t)?D():i.TAny(t)?r():i.TObject(t)?C(e,t):i.TRecord(t)?k(e,t):i.TInteger(t)||i.TNumber(t)?o.True:o.False}(e,l);if(i.TIntersect(e))return function(e,t){return e.allOf.some((e=>P(e,t)===o.True))?o.True:o.False}(e,l);if(i.TLiteral(e))return function(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TNever(t)?h():i.TUnknown(t)?D():i.TAny(t)?r():i.TObject(t)?C(e,t):i.TRecord(t)?k(e,t):i.TString(t)?N(e):i.TNumber(t)?f(e):i.TInteger(t)?a(e):i.TBoolean(t)?s(e):i.TLiteral(t)&&t.const===e.const?o.True:o.False}(e,l);if(i.TNever(e))return o.True;if(i.TNull(e))return function(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TNever(t)?h():i.TUnknown(t)?D():i.TAny(t)?r():i.TObject(t)?C(e,t):i.TRecord(t)?k(e,t):i.TNull(t)?o.True:o.False}(e,l);if(i.TNumber(e))return function(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TNever(t)?h():i.TUnknown(t)?D():i.TAny(t)?r():i.TObject(t)?C(e,t):i.TRecord(t)?k(e,t):i.TInteger(t)||i.TNumber(t)?o.True:o.False}(e,l);if(i.TObject(e))return function(e,t){if(i.TIntersect(t))return c(e,t);if(i.TUnion(t))return A(e,t);if(i.TUnknown(t))return D();if(i.TAny(t))return r();if(i.TRecord(t))return k(e,t);if(!i.TObject(t))return o.False;for(const n of globalThis.Object.keys(t.properties)){if(!(n in e.properties))return o.False;if(w(e.properties[n],t.properties[n])===o.False)return o.False}return o.True}(e,l);if(i.TRecord(e))return function(e,t){const n=T(e);return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TUnknown(t)?D():i.TAny(t)?r():i.TObject(t)?C(e,t):i.TRecord(t)?P(n,T(t)):o.False}(e,l);if(i.TString(e))return function(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TNever(t)?h():i.TUnknown(t)?D():i.TAny(t)?r():i.TObject(t)?C(e,t):i.TRecord(t)?k(e,t):i.TString(t)?o.True:o.False}(e,l);if(i.TSymbol(e))return function(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TNever(t)?h():i.TUnknown(t)?D():i.TAny(t)?r():i.TObject(t)?C(e,t):i.TRecord(t)?k(e,t):i.TSymbol(t)?o.True:o.False}(e,l);if(i.TTuple(e))return F(e,l);if(i.TPromise(e))return x(e,l);if(i.TUint8Array(e))return function(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TUnknown(t)?D():i.TAny(t)?r():i.TObject(t)?C(e,t):i.TRecord(t)?k(e,t):i.TUint8Array(t)?o.True:o.False}(e,l);if(i.TUndefined(e))return I(e,l);if(i.TUnion(e))return function(e,t){return e.anyOf.every((e=>P(e,t)===o.True))?o.True:o.False}(e,l);if(i.TUnknown(e))return O(e,l);if(i.TVoid(e))return function(e,t){return i.TIntersect(t)?c(e,t):i.TUnion(t)?A(e,t):i.TUnknown(t)?D():i.TAny(t)?r():i.TObject(t)?C(e,t):i.TVoid(t)?o.True:o.False}(e,l);throw Error("TypeExtends: Unknown left type operand '".concat(e[t.b8],"'"))}e.Extends=function(e,t){return P(e,t)}}(a||(a={})),function(e){function t(e){return function(e){return globalThis.Array.isArray(e)}(e)?function(e){return e.map((e=>t(e)))}(e):function(e){return"object"===typeof e&&null!==e}(e)?function(e){return{...globalThis.Object.getOwnPropertyNames(e).reduce(((n,r)=>({...n,[r]:t(e[r])})),{}),...globalThis.Object.getOwnPropertySymbols(e).reduce(((n,r)=>({...n,[r]:t(e[r])})),{})}}(e):e}e.Clone=function(e,n){return{...t(e),...n}}}(c||(c={})),function(e){function n(e){return e.map((e=>{const{[t.e6]:n,...r}=c.Clone(e,{});return r}))}function r(e){const r=function(e){return e.every((e=>i.TOptional(e)))}(e.allOf);return r?t.ZU.Optional(t.ZU.Intersect(n(e.allOf))):e}function s(e){const r=function(e){return e.some((e=>i.TOptional(e)))}(e.anyOf);return r?t.ZU.Optional(t.ZU.Union(n(e.anyOf))):e}function o(e){return"Intersect"===e[t.b8]?r(e):"Union"===e[t.b8]?s(e):e}function a(e,n){return"Intersect"===e[t.b8]?function(e,n){const r=e.allOf.reduce(((e,r)=>{const i=a(r,n);return"Never"===i[t.b8]?e:[...e,i]}),[]);return o(t.ZU.Intersect(r))}(e,n):"Union"===e[t.b8]?function(e,n){const r=e.anyOf.map((e=>a(e,n)));return o(t.ZU.Union(r))}(e,n):"Object"===e[t.b8]?function(e,n){const r=e.properties[n];return void 0===r?t.ZU.Never():t.ZU.Union([r])}(e,n):"Tuple"===e[t.b8]?function(e,n){const r=e.items;if(void 0===r)return t.ZU.Never();const i=r[n];return void 0===i?t.ZU.Never():i}(e,n):t.ZU.Never()}e.Resolve=function(e,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const i=n.map((t=>a(e,t.toString())));return o(t.ZU.Union(i,r))}}(l||(l={})),function(e){function n(e,r){return"Intersect"===e[t.b8]?function(e,r){return t.ZU.Intersect(e.allOf.map((e=>n(e,r))),{...e})}(e,r):"Union"===e[t.b8]?function(e,r){return t.ZU.Union(e.anyOf.map((e=>n(e,r))),{...e})}(e,r):"Object"===e[t.b8]?function(e,t){return t(e)}(e,r):e}e.Map=function(e,t,r){return{...n(c.Clone(e,{}),t),...r}}}(u||(u={})),function(e){function t(e,n){return i.TIntersect(e)?function(e,n){return e.allOf.reduce(((e,r)=>[...e,...t(r,n)]),[])}(e,n):i.TUnion(e)?function(e,n){const r=e.anyOf.map((e=>t(e,n)));return[...r.reduce(((e,t)=>t.map((t=>r.every((e=>e.includes(t)))?e.add(t):e))[0]),new Set)]}(e,n):i.TObject(e)?function(e,t){return globalThis.Object.keys(e.properties)}(e):i.TRecord(e)?function(e,t){return t.includePatterns?globalThis.Object.keys(e.patternProperties):[]}(e,n):[]}function n(e,n){return[...new Set(t(e,n))]}e.ResolveKeys=n,e.ResolvePattern=function(e){const t=n(e,{includePatterns:!0}).map((e=>"(".concat(function(e){return"^"===e[0]&&"$"===e[e.length-1]?e.slice(1,e.length-1):e}(e),")")));return"^(".concat(t.join("|"),")$")}}(h||(h={})),function(e){e.Resolve=function(e){if(globalThis.Array.isArray(e))return e;if(i.TUnionLiteral(e))return e.anyOf.map((e=>e.const.toString()));if(i.TLiteral(e))return[e.const];if(i.TTemplateLiteral(e)){const t=g.ParseExact(e.pattern);if(!v.Check(t))throw Error("KeyArrayResolver: Cannot resolve keys from infinite template expression");return[...y.Generate(t)]}return[]}}(d||(d={})),function(e){function*n(e){for(const r of e.anyOf)"Union"===r[t.b8]?yield*n(r):yield r}e.Resolve=function(e){return t.ZU.Union([...n(e)],{...e})}}(f||(f={})),function(e){function n(e,r){if(i.TTemplateLiteral(e)){return e.pattern.slice(1,e.pattern.length-1)}if(i.TUnion(e)){const t=e.anyOf.map((e=>n(e,r))).join("|");return"(".concat(t,")")}if(i.TNumber(e))return"".concat(r).concat(t.Cy);if(i.TInteger(e))return"".concat(r).concat(t.Cy);if(i.TBigInt(e))return"".concat(r).concat(t.Cy);if(i.TString(e))return"".concat(r).concat(t.Mb);if(i.TLiteral(e))return"".concat(r).concat(e.const.toString().replace(/[.*+?^${}()|[\]\\]/g,"\\$&"));if(i.TBoolean(e))return"".concat(r).concat(t.ZP);throw i.TNever(e)?Error("TemplateLiteralPattern: TemplateLiteral cannot operate on types of TNever"):Error("TemplateLiteralPattern: Unexpected Kind '".concat(e[t.b8],"'"))}e.Create=function(e){return"^".concat(e.map((e=>n(e,""))).join(""),"$")}}(p||(p={})),function(e){e.Resolve=function(e){const n=g.ParseExact(e.pattern);if(!v.Check(n))return t.ZU.String();const r=[...y.Generate(n)].map((e=>t.ZU.Literal(e)));return t.ZU.Union(r)}}(m||(m={}));class w extends Error{constructor(e){super(e)}}(function(e){function t(e,t,n){return e[t]===n&&92!==e.charCodeAt(t-1)}function n(e,n){return t(e,n,"(")}function r(e,n){return t(e,n,")")}function i(e,n){return t(e,n,"|")}function s(e){return function(e){if(!n(e,0)||!r(e,e.length-1))return!1;let t=0;for(let i=0;i<e.length;i++)if(n(e,i)&&(t+=1),r(e,i)&&(t-=1),0===t&&i!==e.length-1)return!1;return!0}(e)?s(function(e){return e.slice(1,e.length-1)}(e)):function(e){let t=0;for(let s=0;s<e.length;s++)if(n(e,s)&&(t+=1),r(e,s)&&(t-=1),i(e,s)&&0===t)return!0;return!1}(e)?function(e){let[t,o]=[0,0];const a=[];for(let l=0;l<e.length;l++)if(n(e,l)&&(t+=1),r(e,l)&&(t-=1),i(e,l)&&0===t){const t=e.slice(o,l);t.length>0&&a.push(s(t)),o=l+1}const c=e.slice(o);return c.length>0&&a.push(s(c)),0===a.length?{type:"const",const:""}:1===a.length?a[0]:{type:"or",expr:a}}(e):function(e){for(let t=0;t<e.length;t++)if(n(e,t))return!0;return!1}(e)?function(e){function t(e,t){if(!n(e,t))throw new w("TemplateLiteralParser: Index must point to open parens");let i=0;for(let s=t;s<e.length;s++)if(n(e,s)&&(i+=1),r(e,s)&&(i-=1),0===i)return[t,s];throw new w("TemplateLiteralParser: Unclosed group parens in expression")}function i(e,t){for(let r=t;r<e.length;r++)if(n(e,r))return[t,r];return[t,e.length]}const o=[];for(let r=0;r<e.length;r++)if(n(e,r)){const[n,i]=t(e,r),a=e.slice(n,i+1);o.push(s(a)),r=i}else{const[t,n]=i(e,r),a=e.slice(t,n);a.length>0&&o.push(s(a)),r=n-1}return 0===o.length?{type:"const",const:""}:1===o.length?o[0]:{type:"and",expr:o}}(e):{type:"const",const:e}}e.Parse=s,e.ParseExact=function(e){return s(e.slice(1,e.length-1))}})(g||(g={})),function(e){e.Check=function e(t){if(function(e){return"or"===e.type&&2===e.expr.length&&"const"===e.expr[0].type&&"true"===e.expr[0].const&&"const"===e.expr[1].type&&"false"===e.expr[1].const}(t))return!0;if(function(e){return"or"===e.type&&2===e.expr.length&&"const"===e.expr[0].type&&"0"===e.expr[0].const&&"const"===e.expr[1].type&&"[1-9][0-9]*"===e.expr[1].const}(t)||function(e){return"const"===e.type&&".*"===e.const}(t))return!1;if("and"===t.type)return t.expr.every((t=>e(t)));if("or"===t.type)return t.expr.every((t=>e(t)));if("const"===t.type)return!0;throw Error("TemplateLiteralFinite: Unknown expression type")}}(v||(v={})),function(e){function*t(e){if(1===e.length)return yield*e[0];for(const n of e[0])for(const r of t(e.slice(1)))yield"".concat(n).concat(r)}function*n(e){return yield*t(e.expr.map((e=>[...r(e)])))}function*r(e){if("and"===e.type)return yield*n(e);if("or"===e.type)return yield*function*(e){for(const t of e.expr)yield*r(t)}(e);if("const"===e.type)return yield*function*(e){return yield e.const}(e);throw Error("TemplateLiteralGenerator: Unknown expression")}e.Generate=r}(y||(y={})),function(e){function*n(e){const n=e.trim().replace(/"|'/g,"");if("boolean"===n)return yield t.ZU.Boolean();if("number"===n)return yield t.ZU.Number();if("bigint"===n)return yield t.ZU.BigInt();if("string"===n)return yield t.ZU.String();const r=n.split("|").map((e=>t.ZU.Literal(e.trim())));return yield 0===r.length?t.ZU.Never():1===r.length?r[0]:t.ZU.Union(r)}function*r(e){if("{"!==e[1]){const n=t.ZU.Literal("$"),r=i(e.slice(1));return yield*[n,...r]}for(let t=2;t<e.length;t++)if("}"===e[t]){const r=n(e.slice(2,t)),s=i(e.slice(t+1));return yield*[...r,...s]}yield t.ZU.Literal(e)}function*i(e){for(let n=0;n<e.length;n++)if("$"===e[n]){const i=t.ZU.Literal(e.slice(0,n)),s=r(e.slice(n));return yield*[i,...s]}yield t.ZU.Literal(e)}e.Parse=function(e){return[...i(e)]}}(b||(b={}));let C=0;class x{Create(e){return e}Strict(e){return JSON.parse(JSON.stringify(e))}}class E extends x{Optional(e){return{[t.e6]:"Optional",...c.Clone(e,{})}}ReadonlyOptional(e){return{[t.e6]:"ReadonlyOptional",...c.Clone(e,{})}}Readonly(e){return{[t.e6]:"Readonly",...e}}Any(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.Create({...e,[t.b8]:"Any"})}Array(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.Create({...n,[t.b8]:"Array",type:"array",items:c.Clone(e,{})})}Boolean(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.Create({...e,[t.b8]:"Boolean",type:"boolean"})}Composite(e,n){const r=t.ZU.Intersect(e,{}),i=h.ResolveKeys(r,{includePatterns:!1}).reduce(((e,n)=>({...e,[n]:t.ZU.Index(r,[n])})),{});return t.ZU.Object(i,n)}Enum(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=globalThis.Object.keys(e).filter((e=>isNaN(e))).map((t=>e[t])).map((e=>"string"===typeof e?{[t.b8]:"Literal",type:"string",const:e}:{[t.b8]:"Literal",type:"number",const:e}));return this.Create({...n,[t.b8]:"Union",anyOf:r})}Extends(e,t,n,r){let i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};switch(a.Extends(e,t)){case o.Union:return this.Union([c.Clone(n,i),c.Clone(r,i)]);case o.True:return c.Clone(n,i);case o.False:return c.Clone(r,i)}}Exclude(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(i.TTemplateLiteral(e))return this.Exclude(m.Resolve(e),t,n);if(i.TTemplateLiteral(t))return this.Exclude(e,m.Resolve(t),n);if(i.TUnion(e)){const r=e.anyOf.filter((e=>a.Extends(e,t)===o.False));return 1===r.length?c.Clone(r[0],n):this.Union(r,n)}return a.Extends(e,t)!==o.False?this.Never(n):c.Clone(e,n)}Extract(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(i.TTemplateLiteral(e))return this.Extract(m.Resolve(e),t,n);if(i.TTemplateLiteral(t))return this.Extract(e,m.Resolve(t),n);if(i.TUnion(e)){const r=e.anyOf.filter((e=>a.Extends(e,t)!==o.False));return 1===r.length?c.Clone(r[0],n):this.Union(r,n)}return a.Extends(e,t)!==o.False?c.Clone(e,n):this.Never(n)}Index(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(i.TArray(e)&&i.TNumber(t))return c.Clone(e.items,n);if(i.TTuple(e)&&i.TNumber(t)){const t=(void 0===e.items?[]:e.items).map((e=>c.Clone(e,{})));return this.Union(t,n)}{const r=d.Resolve(t),i=c.Clone(e,{});return l.Resolve(i,r,n)}}Integer(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.Create({...e,[t.b8]:"Integer",type:"integer"})}Intersect(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(0===e.length)return t.ZU.Never();if(1===e.length)return c.Clone(e[0],n);const r=e.every((e=>i.TObject(e))),s=e.map((e=>c.Clone(e,{}))),o=i.TSchema(n.unevaluatedProperties)?{unevaluatedProperties:c.Clone(n.unevaluatedProperties,{})}:{};return!1===n.unevaluatedProperties||i.TSchema(n.unevaluatedProperties)||r?this.Create({...n,...o,[t.b8]:"Intersect",type:"object",allOf:s}):this.Create({...n,...o,[t.b8]:"Intersect",allOf:s})}KeyOf(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(i.TRecord(e)){const r=Object.getOwnPropertyNames(e.patternProperties)[0];if(r===t.pX)return this.Number(n);if(r===t.RF)return this.String(n);throw Error("StandardTypeBuilder: Unable to resolve key type from Record key pattern")}if(i.TTuple(e)){const r=(void 0===e.items?[]:e.items).map(((e,n)=>t.ZU.Literal(n)));return this.Union(r,n)}if(i.TArray(e))return this.Number(n);{const t=h.ResolveKeys(e,{includePatterns:!1});if(0===t.length)return this.Never(n);const r=t.map((e=>this.Literal(e)));return this.Union(r,n)}}Literal(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.Create({...n,[t.b8]:"Literal",const:e,type:typeof e})}Never(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.Create({...e,[t.b8]:"Never",not:{}})}Not(e,n){return this.Create({...n,[t.b8]:"Not",not:e})}Null(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.Create({...e,[t.b8]:"Null",type:"null"})}Number(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.Create({...e,[t.b8]:"Number",type:"number"})}Object(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=globalThis.Object.getOwnPropertyNames(e),s=r.filter((t=>i.TOptional(e[t])||i.TReadonlyOptional(e[t]))),o=r.filter((e=>!s.includes(e))),a=i.TSchema(n.additionalProperties)?{additionalProperties:c.Clone(n.additionalProperties,{})}:{},l=r.reduce(((t,n)=>({...t,[n]:c.Clone(e[n],{})})),{});return o.length>0?this.Create({...n,...a,[t.b8]:"Object",type:"object",properties:l,required:o}):this.Create({...n,...a,[t.b8]:"Object",type:"object",properties:l})}Omit(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const r=d.Resolve(t);return u.Map(c.Clone(e,{}),(e=>{e.required&&(e.required=e.required.filter((e=>!r.includes(e))),0===e.required.length&&delete e.required);for(const t of globalThis.Object.keys(e.properties))r.includes(t)&&delete e.properties[t];return this.Create(e)}),n)}Partial(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return u.Map(c.Clone(e,{}),(e=>(delete e.required,globalThis.Object.keys(e.properties).forEach((n=>function(e){switch(e[t.e6]){case"ReadonlyOptional":case"Readonly":e[t.e6]="ReadonlyOptional";break;default:e[t.e6]="Optional"}}(e.properties[n]))),e)),n)}Pick(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const r=d.Resolve(t);return u.Map(c.Clone(e,{}),(e=>{e.required&&(e.required=e.required.filter((e=>r.includes(e))),0===e.required.length&&delete e.required);for(const t of globalThis.Object.keys(e.properties))r.includes(t)||delete e.properties[t];return this.Create(e)}),n)}Record(e,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(i.TTemplateLiteral(e)){const i=g.ParseExact(e.pattern);return v.Check(i)?this.Object([...y.Generate(i)].reduce(((e,t)=>({...e,[t]:c.Clone(n,{})})),{}),r):this.Create({...r,[t.b8]:"Record",type:"object",patternProperties:{[e.pattern]:c.Clone(n,{})}})}if(i.TUnion(e)){const s=f.Resolve(e);if(i.TUnionLiteral(s)){const e=s.anyOf.reduce(((e,t)=>({...e,[t.const]:c.Clone(n,{})})),{});return this.Object(e,{...r,[t.Ck]:"Record"})}throw Error("TypeBuilder: Record key of type union contains non-literal types")}if(i.TLiteral(e)){if("string"===typeof e.const||"number"===typeof e.const)return this.Object({[e.const]:c.Clone(n,{})},r);throw Error("TypeBuilder: Record key of type literal is not of type string or number")}if(i.TInteger(e)||i.TNumber(e)){const e=t.pX;return this.Create({...r,[t.b8]:"Record",type:"object",patternProperties:{[e]:c.Clone(n,{})}})}if(i.TString(e)){const i=void 0===e.pattern?t.RF:e.pattern;return this.Create({...r,[t.b8]:"Record",type:"object",patternProperties:{[i]:c.Clone(n,{})}})}throw Error("StandardTypeBuilder: Record key is an invalid type")}Recursive(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};void 0===n.$id&&(n.$id="T".concat(C++));const r=e({[t.b8]:"This",$ref:"".concat(n.$id)});return r.$id=n.$id,this.Create({...n,[t.Ck]:"Recursive",...r})}Ref(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(void 0===e.$id)throw Error("StandardTypeBuilder.Ref: Target type must specify an $id");return this.Create({...n,[t.b8]:"Ref",$ref:e.$id})}Required(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return u.Map(c.Clone(e,{}),(e=>(e.required=globalThis.Object.keys(e.properties),globalThis.Object.keys(e.properties).forEach((n=>function(e){switch(e[t.e6]){case"ReadonlyOptional":case"Readonly":e[t.e6]="Readonly";break;default:delete e[t.e6]}}(e.properties[n]))),e)),n)}Rest(e){return i.TTuple(e)?void 0===e.items?[]:e.items.map((e=>c.Clone(e,{}))):[c.Clone(e,{})]}String(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.Create({...e,[t.b8]:"String",type:"string"})}TemplateLiteral(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r="string"===typeof e?p.Create(b.Parse(e)):p.Create(e);return this.Create({...n,[t.b8]:"TemplateLiteral",type:"string",pattern:r})}Tuple(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const[r,i,s]=[!1,e.length,e.length],o=e.map((e=>c.Clone(e,{}))),a=e.length>0?{...n,[t.b8]:"Tuple",type:"array",items:o,additionalItems:r,minItems:i,maxItems:s}:{...n,[t.b8]:"Tuple",type:"array",minItems:i,maxItems:s};return this.Create(a)}Union(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(i.TTemplateLiteral(e))return m.Resolve(e);{const r=e;if(0===r.length)return this.Never(n);if(1===r.length)return this.Create(c.Clone(r[0],n));const i=r.map((e=>c.Clone(e,{})));return this.Create({...n,[t.b8]:"Union",anyOf:i})}}Unknown(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.Create({...e,[t.b8]:"Unknown"})}Unsafe(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.Create({...e,[t.b8]:e[t.b8]||"Unsafe"})}}class T extends E{BigInt(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.Create({...e,[t.b8]:"BigInt",type:"null",typeOf:"BigInt"})}ConstructorParameters(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.Tuple([...e.parameters],{...t})}Constructor(e,n,r){const i=c.Clone(n,{}),s=e.map((e=>c.Clone(e,{})));return this.Create({...r,[t.b8]:"Constructor",type:"object",instanceOf:"Constructor",parameters:s,returns:i})}Date(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.Create({...e,[t.b8]:"Date",type:"object",instanceOf:"Date"})}Function(e,n,r){const i=c.Clone(n,{}),s=e.map((e=>c.Clone(e,{})));return this.Create({...r,[t.b8]:"Function",type:"object",instanceOf:"Function",parameters:s,returns:i})}InstanceType(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return c.Clone(e.returns,t)}Parameters(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.Tuple(e.parameters,{...t})}Promise(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.Create({...n,[t.b8]:"Promise",type:"object",instanceOf:"Promise",item:c.Clone(e,{})})}RegEx(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.Create({...n,[t.b8]:"String",type:"string",pattern:e.source})}ReturnType(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return c.Clone(e.returns,t)}Symbol(e){return this.Create({...e,[t.b8]:"Symbol",type:"null",typeOf:"Symbol"})}Undefined(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.Create({...e,[t.b8]:"Undefined",type:"null",typeOf:"Undefined"})}Uint8Array(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.Create({...e,[t.b8]:"Uint8Array",type:"object",instanceOf:"Uint8Array"})}Void(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.Create({...e,[t.b8]:"Void",type:"null",typeOf:"Void"})}}new E,t.ZU=new T},4445:(e,t)=>{"use strict";t.byteLength=function(e){var t=a(e),n=t[0],r=t[1];return 3*(n+r)/4-r},t.toByteArray=function(e){var t,n,s=a(e),o=s[0],c=s[1],l=new i(function(e,t,n){return 3*(t+n)/4-n}(0,o,c)),u=0,h=c>0?o-4:o;for(n=0;n<h;n+=4)t=r[e.charCodeAt(n)]<<18|r[e.charCodeAt(n+1)]<<12|r[e.charCodeAt(n+2)]<<6|r[e.charCodeAt(n+3)],l[u++]=t>>16&255,l[u++]=t>>8&255,l[u++]=255&t;2===c&&(t=r[e.charCodeAt(n)]<<2|r[e.charCodeAt(n+1)]>>4,l[u++]=255&t);1===c&&(t=r[e.charCodeAt(n)]<<10|r[e.charCodeAt(n+1)]<<4|r[e.charCodeAt(n+2)]>>2,l[u++]=t>>8&255,l[u++]=255&t);return l},t.fromByteArray=function(e){for(var t,r=e.length,i=r%3,s=[],o=16383,a=0,l=r-i;a<l;a+=o)s.push(c(e,a,a+o>l?l:a+o));1===i?(t=e[r-1],s.push(n[t>>2]+n[t<<4&63]+"==")):2===i&&(t=(e[r-2]<<8)+e[r-1],s.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"="));return s.join("")};for(var n=[],r=[],i="undefined"!==typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0;o<64;++o)n[o]=s[o],r[s.charCodeAt(o)]=o;function a(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function c(e,t,r){for(var i,s,o=[],a=t;a<r;a+=3)i=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),o.push(n[(s=i)>>18&63]+n[s>>12&63]+n[s>>6&63]+n[63&s]);return o.join("")}r["-".charCodeAt(0)]=62,r["_".charCodeAt(0)]=63},2028:(e,t,n)=>{"use strict";var r=n(2),i=n(1712),s=i(r("String.prototype.indexOf"));e.exports=function(e,t){var n=r(e,!!t);return"function"===typeof n&&s(e,".prototype.")>-1?i(n):n}},1712:(e,t,n)=>{"use strict";var r=n(3864),i=n(2),s=n(5438),o=n(4902),a=i("%Function.prototype.apply%"),c=i("%Function.prototype.call%"),l=i("%Reflect.apply%",!0)||r.call(c,a),u=n(2090),h=i("%Math.max%");e.exports=function(e){if("function"!==typeof e)throw new o("a function is required");var t=l(r,c,arguments);return s(t,1+h(0,e.length-(arguments.length-1)),!0)};var d=function(){return l(r,a,arguments)};u?u(e.exports,"apply",{value:d}):e.exports.apply=d},9038:function(e,t){var n="undefined"!==typeof self?self:this,r=function(){function e(){this.fetch=!1,this.DOMException=n.DOMException}return e.prototype=n,new e}();!function(e){!function(t){var n="URLSearchParams"in e,r="Symbol"in e&&"iterator"in Symbol,i="FileReader"in e&&"Blob"in e&&function(){try{return new Blob,!0}catch(e){return!1}}(),s="FormData"in e,o="ArrayBuffer"in e;if(o)var a=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],c=ArrayBuffer.isView||function(e){return e&&a.indexOf(Object.prototype.toString.call(e))>-1};function l(e){if("string"!==typeof e&&(e=String(e)),/[^a-z0-9\-#$%&'*+.^_`|~]/i.test(e))throw new TypeError("Invalid character in header field name");return e.toLowerCase()}function u(e){return"string"!==typeof e&&(e=String(e)),e}function h(e){var t={next:function(){var t=e.shift();return{done:void 0===t,value:t}}};return r&&(t[Symbol.iterator]=function(){return t}),t}function d(e){this.map={},e instanceof d?e.forEach((function(e,t){this.append(t,e)}),this):Array.isArray(e)?e.forEach((function(e){this.append(e[0],e[1])}),this):e&&Object.getOwnPropertyNames(e).forEach((function(t){this.append(t,e[t])}),this)}function f(e){if(e.bodyUsed)return Promise.reject(new TypeError("Already read"));e.bodyUsed=!0}function p(e){return new Promise((function(t,n){e.onload=function(){t(e.result)},e.onerror=function(){n(e.error)}}))}function m(e){var t=new FileReader,n=p(t);return t.readAsArrayBuffer(e),n}function g(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function v(){return this.bodyUsed=!1,this._initBody=function(e){var t;this._bodyInit=e,e?"string"===typeof e?this._bodyText=e:i&&Blob.prototype.isPrototypeOf(e)?this._bodyBlob=e:s&&FormData.prototype.isPrototypeOf(e)?this._bodyFormData=e:n&&URLSearchParams.prototype.isPrototypeOf(e)?this._bodyText=e.toString():o&&i&&((t=e)&&DataView.prototype.isPrototypeOf(t))?(this._bodyArrayBuffer=g(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):o&&(ArrayBuffer.prototype.isPrototypeOf(e)||c(e))?this._bodyArrayBuffer=g(e):this._bodyText=e=Object.prototype.toString.call(e):this._bodyText="",this.headers.get("content-type")||("string"===typeof e?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):n&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},i&&(this.blob=function(){var e=f(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?f(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(m)}),this.text=function(){var e=f(this);if(e)return e;if(this._bodyBlob)return function(e){var t=new FileReader,n=p(t);return t.readAsText(e),n}(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(function(e){for(var t=new Uint8Array(e),n=new Array(t.length),r=0;r<t.length;r++)n[r]=String.fromCharCode(t[r]);return n.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},s&&(this.formData=function(){return this.text().then(S)}),this.json=function(){return this.text().then(JSON.parse)},this}d.prototype.append=function(e,t){e=l(e),t=u(t);var n=this.map[e];this.map[e]=n?n+", "+t:t},d.prototype.delete=function(e){delete this.map[l(e)]},d.prototype.get=function(e){return e=l(e),this.has(e)?this.map[e]:null},d.prototype.has=function(e){return this.map.hasOwnProperty(l(e))},d.prototype.set=function(e,t){this.map[l(e)]=u(t)},d.prototype.forEach=function(e,t){for(var n in this.map)this.map.hasOwnProperty(n)&&e.call(t,this.map[n],n,this)},d.prototype.keys=function(){var e=[];return this.forEach((function(t,n){e.push(n)})),h(e)},d.prototype.values=function(){var e=[];return this.forEach((function(t){e.push(t)})),h(e)},d.prototype.entries=function(){var e=[];return this.forEach((function(t,n){e.push([n,t])})),h(e)},r&&(d.prototype[Symbol.iterator]=d.prototype.entries);var y=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function b(e,t){var n=(t=t||{}).body;if(e instanceof b){if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new d(e.headers)),this.method=e.method,this.mode=e.mode,this.signal=e.signal,n||null==e._bodyInit||(n=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"same-origin",!t.headers&&this.headers||(this.headers=new d(t.headers)),this.method=function(e){var t=e.toUpperCase();return y.indexOf(t)>-1?t:e}(t.method||this.method||"GET"),this.mode=t.mode||this.mode||null,this.signal=t.signal||this.signal,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&n)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(n)}function S(e){var t=new FormData;return e.trim().split("&").forEach((function(e){if(e){var n=e.split("="),r=n.shift().replace(/\+/g," "),i=n.join("=").replace(/\+/g," ");t.append(decodeURIComponent(r),decodeURIComponent(i))}})),t}function w(e){var t=new d;return e.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach((function(e){var n=e.split(":"),r=n.shift().trim();if(r){var i=n.join(":").trim();t.append(r,i)}})),t}function C(e,t){t||(t={}),this.type="default",this.status=void 0===t.status?200:t.status,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in t?t.statusText:"OK",this.headers=new d(t.headers),this.url=t.url||"",this._initBody(e)}b.prototype.clone=function(){return new b(this,{body:this._bodyInit})},v.call(b.prototype),v.call(C.prototype),C.prototype.clone=function(){return new C(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new d(this.headers),url:this.url})},C.error=function(){var e=new C(null,{status:0,statusText:""});return e.type="error",e};var x=[301,302,303,307,308];C.redirect=function(e,t){if(-1===x.indexOf(t))throw new RangeError("Invalid status code");return new C(null,{status:t,headers:{location:e}})},t.DOMException=e.DOMException;try{new t.DOMException}catch(T){t.DOMException=function(e,t){this.message=e,this.name=t;var n=Error(e);this.stack=n.stack},t.DOMException.prototype=Object.create(Error.prototype),t.DOMException.prototype.constructor=t.DOMException}function E(e,n){return new Promise((function(r,s){var o=new b(e,n);if(o.signal&&o.signal.aborted)return s(new t.DOMException("Aborted","AbortError"));var a=new XMLHttpRequest;function c(){a.abort()}a.onload=function(){var e={status:a.status,statusText:a.statusText,headers:w(a.getAllResponseHeaders()||"")};e.url="responseURL"in a?a.responseURL:e.headers.get("X-Request-URL");var t="response"in a?a.response:a.responseText;r(new C(t,e))},a.onerror=function(){s(new TypeError("Network request failed"))},a.ontimeout=function(){s(new TypeError("Network request failed"))},a.onabort=function(){s(new t.DOMException("Aborted","AbortError"))},a.open(o.method,o.url,!0),"include"===o.credentials?a.withCredentials=!0:"omit"===o.credentials&&(a.withCredentials=!1),"responseType"in a&&i&&(a.responseType="blob"),o.headers.forEach((function(e,t){a.setRequestHeader(t,e)})),o.signal&&(o.signal.addEventListener("abort",c),a.onreadystatechange=function(){4===a.readyState&&o.signal.removeEventListener("abort",c)}),a.send("undefined"===typeof o._bodyInit?null:o._bodyInit)}))}E.polyfill=!0,e.fetch||(e.fetch=E,e.Headers=d,e.Request=b,e.Response=C),t.Headers=d,t.Request=b,t.Response=C,t.fetch=E,Object.defineProperty(t,"__esModule",{value:!0})}({})}(r),r.fetch.ponyfill=!0,delete r.fetch.polyfill;var i=r;(t=i.fetch).default=i.fetch,t.fetch=i.fetch,t.Headers=i.Headers,t.Request=i.Request,t.Response=i.Response,e.exports=t},6522:(e,t,n)=>{t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;t.splice(1,0,n,"color: inherit");let r=0,i=0;t[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(r++,"%c"===e&&(i=r))})),t.splice(i,0,n)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(n){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(n){}!e&&"undefined"!==typeof process&&"env"in process&&(e={NODE_ENV:"production",PUBLIC_URL:"",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.DEBUG);return e},t.useColors=function(){if("undefined"!==typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!==typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!==typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!==typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!==typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!==typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=n(5237)(t);const{formatters:r}=e.exports;r.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}},5237:(e,t,n)=>{e.exports=function(e){function t(e){let n,i,s,o=null;function a(){for(var e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];if(!a.enabled)return;const s=a,o=Number(new Date),c=o-(n||o);s.diff=c,s.prev=n,s.curr=o,n=o,r[0]=t.coerce(r[0]),"string"!==typeof r[0]&&r.unshift("%O");let l=0;r[0]=r[0].replace(/%([a-zA-Z%])/g,((e,n)=>{if("%%"===e)return"%";l++;const i=t.formatters[n];if("function"===typeof i){const t=r[l];e=i.call(s,t),r.splice(l,1),l--}return e})),t.formatArgs.call(s,r);(s.log||t.log).apply(s,r)}return a.namespace=e,a.useColors=t.useColors(),a.color=t.selectColor(e),a.extend=r,a.destroy=t.destroy,Object.defineProperty(a,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==o?o:(i!==t.namespaces&&(i=t.namespaces,s=t.enabled(e)),s),set:e=>{o=e}}),"function"===typeof t.init&&t.init(a),a}function r(e,n){const r=t(this.namespace+("undefined"===typeof n?":":n)+e);return r.log=this.log,r}function i(e){return e.toString().substring(2,e.toString().length-2).replace(/\.\*\?$/,"*")}return t.debug=t,t.default=t,t.coerce=function(e){if(e instanceof Error)return e.stack||e.message;return e},t.disable=function(){const e=[...t.names.map(i),...t.skips.map(i).map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){let n;t.save(e),t.namespaces=e,t.names=[],t.skips=[];const r=("string"===typeof e?e:"").split(/[\s,]+/),i=r.length;for(n=0;n<i;n++)r[n]&&("-"===(e=r[n].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.slice(1)+"$")):t.names.push(new RegExp("^"+e+"$")))},t.enabled=function(e){if("*"===e[e.length-1])return!0;let n,r;for(n=0,r=t.skips.length;n<r;n++)if(t.skips[n].test(e))return!1;for(n=0,r=t.names.length;n<r;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=n(7340),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((n=>{t[n]=e[n]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let n=0;for(let t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return t.colors[Math.abs(n)%t.colors.length]},t.enable(t.load()),t}},4992:(e,t,n)=>{"use strict";var r=n(2090),i=n(2557),s=n(4902),o=n(5558);e.exports=function(e,t,n){if(!e||"object"!==typeof e&&"function"!==typeof e)throw new s("`obj` must be an object or a function`");if("string"!==typeof t&&"symbol"!==typeof t)throw new s("`property` must be a string or a symbol`");if(arguments.length>3&&"boolean"!==typeof arguments[3]&&null!==arguments[3])throw new s("`nonEnumerable`, if provided, must be a boolean or null");if(arguments.length>4&&"boolean"!==typeof arguments[4]&&null!==arguments[4])throw new s("`nonWritable`, if provided, must be a boolean or null");if(arguments.length>5&&"boolean"!==typeof arguments[5]&&null!==arguments[5])throw new s("`nonConfigurable`, if provided, must be a boolean or null");if(arguments.length>6&&"boolean"!==typeof arguments[6])throw new s("`loose`, if provided, must be a boolean");var a=arguments.length>3?arguments[3]:null,c=arguments.length>4?arguments[4]:null,l=arguments.length>5?arguments[5]:null,u=arguments.length>6&&arguments[6],h=!!o&&o(e,t);if(r)r(e,t,{configurable:null===l&&h?h.configurable:!l,enumerable:null===a&&h?h.enumerable:!a,value:n,writable:null===c&&h?h.writable:!c});else{if(!u&&(a||c||l))throw new i("This environment does not support defining a property as non-configurable, non-writable, or non-enumerable.");e[t]=n}}},1724:e=>{"use strict";function t(e){if(this._capacity=r(e),this._length=0,this._front=0,n(e)){for(var t=e.length,i=0;i<t;++i)this[i]=e[i];this._length=t}}t.prototype.toArray=function(){for(var e=this._length,t=new Array(e),n=this._front,r=this._capacity,i=0;i<e;++i)t[i]=this[n+i&r-1];return t},t.prototype.push=function(e){var t=arguments.length,n=this._length;if(t>1){var r=this._capacity;if(n+t>r){for(var i=0;i<t;++i){this._checkCapacity(n+1),this[s=this._front+n&this._capacity-1]=arguments[i],n++,this._length=n}return n}for(var s=this._front,i=0;i<t;++i)this[s+n&r-1]=arguments[i],s++;return this._length=n+t,n+t}return 0===t?n:(this._checkCapacity(n+1),this[i=this._front+n&this._capacity-1]=e,this._length=n+1,n+1)},t.prototype.pop=function(){var e=this._length;if(0!==e){var t=this._front+e-1&this._capacity-1,n=this[t];return this[t]=void 0,this._length=e-1,n}},t.prototype.shift=function(){var e=this._length;if(0!==e){var t=this._front,n=this[t];return this[t]=void 0,this._front=t+1&this._capacity-1,this._length=e-1,n}},t.prototype.unshift=function(e){var t=this._length,n=arguments.length;if(n>1){if(t+n>(i=this._capacity)){for(var r=n-1;r>=0;r--){this._checkCapacity(t+1);var i=this._capacity;this[o=(this._front-1&i-1^i)-i]=arguments[r],t++,this._length=t,this._front=o}return t}var s=this._front;for(r=n-1;r>=0;r--){var o;this[o=(s-1&i-1^i)-i]=arguments[r],s=o}return this._front=s,this._length=t+n,t+n}if(0===n)return t;this._checkCapacity(t+1);i=this._capacity;return this[r=(this._front-1&i-1^i)-i]=e,this._length=t+1,this._front=r,t+1},t.prototype.peekBack=function(){var e=this._length;if(0!==e)return this[this._front+e-1&this._capacity-1]},t.prototype.peekFront=function(){if(0!==this._length)return this[this._front]},t.prototype.get=function(e){var t=e;if(t===(0|t)){var n=this._length;if(t<0&&(t+=n),!(t<0||t>=n))return this[this._front+t&this._capacity-1]}},t.prototype.isEmpty=function(){return 0===this._length},t.prototype.clear=function(){for(var e=this._length,t=this._front,n=this._capacity,r=0;r<e;++r)this[t+r&n-1]=void 0;this._length=0,this._front=0},t.prototype.toString=function(){return this.toArray().toString()},t.prototype.valueOf=t.prototype.toString,t.prototype.removeFront=t.prototype.shift,t.prototype.removeBack=t.prototype.pop,t.prototype.insertFront=t.prototype.unshift,t.prototype.insertBack=t.prototype.push,t.prototype.enqueue=t.prototype.push,t.prototype.dequeue=t.prototype.shift,t.prototype.toJSON=t.prototype.toArray,Object.defineProperty(t.prototype,"length",{get:function(){return this._length},set:function(){throw new RangeError("")}}),t.prototype._checkCapacity=function(e){this._capacity<e&&this._resizeTo(r(1.5*this._capacity+16))},t.prototype._resizeTo=function(e){var t=this._capacity;this._capacity=e;var n=this._front,r=this._length;n+r>t&&function(e,t,n,r,i){for(var s=0;s<i;++s)n[s+r]=e[s+t],e[s+t]=void 0}(this,0,this,t,n+r&t-1)};var n=Array.isArray;function r(e){if("number"!==typeof e){if(!n(e))return 16;e=e.length}return t=Math.min(Math.max(16,e),1073741824),t>>>=0,t-=1,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,1+(t|=t>>16);var t}e.exports=t},2090:(e,t,n)=>{"use strict";var r=n(2)("%Object.defineProperty%",!0)||!1;if(r)try{r({},"a",{value:1})}catch(i){r=!1}e.exports=r},9820:e=>{"use strict";e.exports=EvalError},9304:e=>{"use strict";e.exports=Error},1725:e=>{"use strict";e.exports=RangeError},5077:e=>{"use strict";e.exports=ReferenceError},2557:e=>{"use strict";e.exports=SyntaxError},4902:e=>{"use strict";e.exports=TypeError},3094:e=>{"use strict";e.exports=URIError},7284:e=>{"use strict";var t,n="object"===typeof Reflect?Reflect:null,r=n&&"function"===typeof n.apply?n.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};t=n&&"function"===typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var i=Number.isNaN||function(e){return e!==e};function s(){s.init.call(this)}e.exports=s,e.exports.once=function(e,t){return new Promise((function(n,r){function i(n){e.removeListener(t,s),r(n)}function s(){"function"===typeof e.removeListener&&e.removeListener("error",i),n([].slice.call(arguments))}m(e,t,s,{once:!0}),"error"!==t&&function(e,t,n){"function"===typeof e.on&&m(e,"error",t,n)}(e,i,{once:!0})}))},s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var o=10;function a(e){if("function"!==typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function c(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function l(e,t,n,r){var i,s,o,l;if(a(n),void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),o=s[t]),void 0===o)o=s[t]=n,++e._eventsCount;else if("function"===typeof o?o=s[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),(i=c(e))>0&&o.length>i&&!o.warned){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=o.length,l=u,console&&console.warn&&console.warn(l)}return e}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function h(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=u.bind(r);return i.listener=n,r.wrapFn=i,i}function d(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"===typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):p(i,i.length)}function f(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"===typeof n)return 1;if(void 0!==n)return n.length}return 0}function p(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function m(e,t,n,r){if("function"===typeof e.on)r.once?e.once(t,n):e.on(t,n);else{if("function"!==typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function i(s){r.once&&e.removeEventListener(t,i),n(s)}))}}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return o},set:function(e){if("number"!==typeof e||e<0||i(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");o=e}}),s.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(e){if("number"!==typeof e||e<0||i(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return c(this)},s.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i="error"===e,s=this._events;if(void 0!==s)i=i&&void 0===s.error;else if(!i)return!1;if(i){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=s[e];if(void 0===c)return!1;if("function"===typeof c)r(c,this,t);else{var l=c.length,u=p(c,l);for(n=0;n<l;++n)r(u[n],this,t)}return!0},s.prototype.addListener=function(e,t){return l(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return l(this,e,t,!0)},s.prototype.once=function(e,t){return a(t),this.on(e,h(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,h(this,e,t)),this},s.prototype.removeListener=function(e,t){var n,r,i,s,o;if(a(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0===--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!==typeof n){for(i=-1,s=n.length-1;s>=0;s--)if(n[s]===t||n[s].listener===t){o=n[s].listener,i=s;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,o||t)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0===--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,s=Object.keys(n);for(r=0;r<s.length;++r)"removeListener"!==(i=s[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"===typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},s.prototype.listeners=function(e){return d(this,e,!0)},s.prototype.rawListeners=function(e){return d(this,e,!1)},s.listenerCount=function(e,t){return"function"===typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},s.prototype.listenerCount=f,s.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},7724:e=>{"use strict";var t=Object.prototype.toString,n=Math.max,r=function(e,t){for(var n=[],r=0;r<e.length;r+=1)n[r]=e[r];for(var i=0;i<t.length;i+=1)n[i+e.length]=t[i];return n};e.exports=function(e){var i=this;if("function"!==typeof i||"[object Function]"!==t.apply(i))throw new TypeError("Function.prototype.bind called on incompatible "+i);for(var s,o=function(e,t){for(var n=[],r=t||0,i=0;r<e.length;r+=1,i+=1)n[i]=e[r];return n}(arguments,1),a=n(0,i.length-o.length),c=[],l=0;l<a;l++)c[l]="$"+l;if(s=Function("binder","return function ("+function(e,t){for(var n="",r=0;r<e.length;r+=1)n+=e[r],r+1<e.length&&(n+=t);return n}(c,",")+"){ return binder.apply(this,arguments); }")((function(){if(this instanceof s){var t=i.apply(this,r(o,arguments));return Object(t)===t?t:this}return i.apply(e,r(o,arguments))})),i.prototype){var u=function(){};u.prototype=i.prototype,s.prototype=new u,u.prototype=null}return s}},3864:(e,t,n)=>{"use strict";var r=n(7724);e.exports=Function.prototype.bind||r},2:(e,t,n)=>{"use strict";var r,i=n(9304),s=n(9820),o=n(1725),a=n(5077),c=n(2557),l=n(4902),u=n(3094),h=Function,d=function(e){try{return h('"use strict"; return ('+e+").constructor;")()}catch(t){}},f=Object.getOwnPropertyDescriptor;if(f)try{f({},"")}catch(M){f=null}var p=function(){throw new l},m=f?function(){try{return p}catch(e){try{return f(arguments,"callee").get}catch(t){return p}}}():p,g=n(2108)(),v=n(951)(),y=Object.getPrototypeOf||(v?function(e){return e.__proto__}:null),b={},S="undefined"!==typeof Uint8Array&&y?y(Uint8Array):r,w={__proto__:null,"%AggregateError%":"undefined"===typeof AggregateError?r:AggregateError,"%Array%":Array,"%ArrayBuffer%":"undefined"===typeof ArrayBuffer?r:ArrayBuffer,"%ArrayIteratorPrototype%":g&&y?y([][Symbol.iterator]()):r,"%AsyncFromSyncIteratorPrototype%":r,"%AsyncFunction%":b,"%AsyncGenerator%":b,"%AsyncGeneratorFunction%":b,"%AsyncIteratorPrototype%":b,"%Atomics%":"undefined"===typeof Atomics?r:Atomics,"%BigInt%":"undefined"===typeof BigInt?r:BigInt,"%BigInt64Array%":"undefined"===typeof BigInt64Array?r:BigInt64Array,"%BigUint64Array%":"undefined"===typeof BigUint64Array?r:BigUint64Array,"%Boolean%":Boolean,"%DataView%":"undefined"===typeof DataView?r:DataView,"%Date%":Date,"%decodeURI%":decodeURI,"%decodeURIComponent%":decodeURIComponent,"%encodeURI%":encodeURI,"%encodeURIComponent%":encodeURIComponent,"%Error%":i,"%eval%":eval,"%EvalError%":s,"%Float32Array%":"undefined"===typeof Float32Array?r:Float32Array,"%Float64Array%":"undefined"===typeof Float64Array?r:Float64Array,"%FinalizationRegistry%":"undefined"===typeof FinalizationRegistry?r:FinalizationRegistry,"%Function%":h,"%GeneratorFunction%":b,"%Int8Array%":"undefined"===typeof Int8Array?r:Int8Array,"%Int16Array%":"undefined"===typeof Int16Array?r:Int16Array,"%Int32Array%":"undefined"===typeof Int32Array?r:Int32Array,"%isFinite%":isFinite,"%isNaN%":isNaN,"%IteratorPrototype%":g&&y?y(y([][Symbol.iterator]())):r,"%JSON%":"object"===typeof JSON?JSON:r,"%Map%":"undefined"===typeof Map?r:Map,"%MapIteratorPrototype%":"undefined"!==typeof Map&&g&&y?y((new Map)[Symbol.iterator]()):r,"%Math%":Math,"%Number%":Number,"%Object%":Object,"%parseFloat%":parseFloat,"%parseInt%":parseInt,"%Promise%":"undefined"===typeof Promise?r:Promise,"%Proxy%":"undefined"===typeof Proxy?r:Proxy,"%RangeError%":o,"%ReferenceError%":a,"%Reflect%":"undefined"===typeof Reflect?r:Reflect,"%RegExp%":RegExp,"%Set%":"undefined"===typeof Set?r:Set,"%SetIteratorPrototype%":"undefined"!==typeof Set&&g&&y?y((new Set)[Symbol.iterator]()):r,"%SharedArrayBuffer%":"undefined"===typeof SharedArrayBuffer?r:SharedArrayBuffer,"%String%":String,"%StringIteratorPrototype%":g&&y?y(""[Symbol.iterator]()):r,"%Symbol%":g?Symbol:r,"%SyntaxError%":c,"%ThrowTypeError%":m,"%TypedArray%":S,"%TypeError%":l,"%Uint8Array%":"undefined"===typeof Uint8Array?r:Uint8Array,"%Uint8ClampedArray%":"undefined"===typeof Uint8ClampedArray?r:Uint8ClampedArray,"%Uint16Array%":"undefined"===typeof Uint16Array?r:Uint16Array,"%Uint32Array%":"undefined"===typeof Uint32Array?r:Uint32Array,"%URIError%":u,"%WeakMap%":"undefined"===typeof WeakMap?r:WeakMap,"%WeakRef%":"undefined"===typeof WeakRef?r:WeakRef,"%WeakSet%":"undefined"===typeof WeakSet?r:WeakSet};if(y)try{null.error}catch(M){var C=y(y(M));w["%Error.prototype%"]=C}var x=function e(t){var n;if("%AsyncFunction%"===t)n=d("async function () {}");else if("%GeneratorFunction%"===t)n=d("function* () {}");else if("%AsyncGeneratorFunction%"===t)n=d("async function* () {}");else if("%AsyncGenerator%"===t){var r=e("%AsyncGeneratorFunction%");r&&(n=r.prototype)}else if("%AsyncIteratorPrototype%"===t){var i=e("%AsyncGenerator%");i&&y&&(n=y(i.prototype))}return w[t]=n,n},E={__proto__:null,"%ArrayBufferPrototype%":["ArrayBuffer","prototype"],"%ArrayPrototype%":["Array","prototype"],"%ArrayProto_entries%":["Array","prototype","entries"],"%ArrayProto_forEach%":["Array","prototype","forEach"],"%ArrayProto_keys%":["Array","prototype","keys"],"%ArrayProto_values%":["Array","prototype","values"],"%AsyncFunctionPrototype%":["AsyncFunction","prototype"],"%AsyncGenerator%":["AsyncGeneratorFunction","prototype"],"%AsyncGeneratorPrototype%":["AsyncGeneratorFunction","prototype","prototype"],"%BooleanPrototype%":["Boolean","prototype"],"%DataViewPrototype%":["DataView","prototype"],"%DatePrototype%":["Date","prototype"],"%ErrorPrototype%":["Error","prototype"],"%EvalErrorPrototype%":["EvalError","prototype"],"%Float32ArrayPrototype%":["Float32Array","prototype"],"%Float64ArrayPrototype%":["Float64Array","prototype"],"%FunctionPrototype%":["Function","prototype"],"%Generator%":["GeneratorFunction","prototype"],"%GeneratorPrototype%":["GeneratorFunction","prototype","prototype"],"%Int8ArrayPrototype%":["Int8Array","prototype"],"%Int16ArrayPrototype%":["Int16Array","prototype"],"%Int32ArrayPrototype%":["Int32Array","prototype"],"%JSONParse%":["JSON","parse"],"%JSONStringify%":["JSON","stringify"],"%MapPrototype%":["Map","prototype"],"%NumberPrototype%":["Number","prototype"],"%ObjectPrototype%":["Object","prototype"],"%ObjProto_toString%":["Object","prototype","toString"],"%ObjProto_valueOf%":["Object","prototype","valueOf"],"%PromisePrototype%":["Promise","prototype"],"%PromiseProto_then%":["Promise","prototype","then"],"%Promise_all%":["Promise","all"],"%Promise_reject%":["Promise","reject"],"%Promise_resolve%":["Promise","resolve"],"%RangeErrorPrototype%":["RangeError","prototype"],"%ReferenceErrorPrototype%":["ReferenceError","prototype"],"%RegExpPrototype%":["RegExp","prototype"],"%SetPrototype%":["Set","prototype"],"%SharedArrayBufferPrototype%":["SharedArrayBuffer","prototype"],"%StringPrototype%":["String","prototype"],"%SymbolPrototype%":["Symbol","prototype"],"%SyntaxErrorPrototype%":["SyntaxError","prototype"],"%TypedArrayPrototype%":["TypedArray","prototype"],"%TypeErrorPrototype%":["TypeError","prototype"],"%Uint8ArrayPrototype%":["Uint8Array","prototype"],"%Uint8ClampedArrayPrototype%":["Uint8ClampedArray","prototype"],"%Uint16ArrayPrototype%":["Uint16Array","prototype"],"%Uint32ArrayPrototype%":["Uint32Array","prototype"],"%URIErrorPrototype%":["URIError","prototype"],"%WeakMapPrototype%":["WeakMap","prototype"],"%WeakSetPrototype%":["WeakSet","prototype"]},T=n(3864),k=n(4384),N=T.call(Function.call,Array.prototype.concat),F=T.call(Function.apply,Array.prototype.splice),I=T.call(Function.call,String.prototype.replace),A=T.call(Function.call,String.prototype.slice),D=T.call(Function.call,RegExp.prototype.exec),O=/[^%.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|%$))/g,P=/\\(\\)?/g,R=function(e,t){var n,r=e;if(k(E,r)&&(r="%"+(n=E[r])[0]+"%"),k(w,r)){var i=w[r];if(i===b&&(i=x(r)),"undefined"===typeof i&&!t)throw new l("intrinsic "+e+" exists, but is not available. Please file an issue!");return{alias:n,name:r,value:i}}throw new c("intrinsic "+e+" does not exist!")};e.exports=function(e,t){if("string"!==typeof e||0===e.length)throw new l("intrinsic name must be a non-empty string");if(arguments.length>1&&"boolean"!==typeof t)throw new l('"allowMissing" argument must be a boolean');if(null===D(/^%?[^%]*%?$/,e))throw new c("`%` may not be present anywhere but at the beginning and end of the intrinsic name");var n=function(e){var t=A(e,0,1),n=A(e,-1);if("%"===t&&"%"!==n)throw new c("invalid intrinsic syntax, expected closing `%`");if("%"===n&&"%"!==t)throw new c("invalid intrinsic syntax, expected opening `%`");var r=[];return I(e,O,(function(e,t,n,i){r[r.length]=n?I(i,P,"$1"):t||e})),r}(e),r=n.length>0?n[0]:"",i=R("%"+r+"%",t),s=i.name,o=i.value,a=!1,u=i.alias;u&&(r=u[0],F(n,N([0,1],u)));for(var h=1,d=!0;h<n.length;h+=1){var p=n[h],m=A(p,0,1),g=A(p,-1);if(('"'===m||"'"===m||"`"===m||'"'===g||"'"===g||"`"===g)&&m!==g)throw new c("property names with quotes must have matching quotes");if("constructor"!==p&&d||(a=!0),k(w,s="%"+(r+="."+p)+"%"))o=w[s];else if(null!=o){if(!(p in o)){if(!t)throw new l("base intrinsic for "+e+" exists, but the property is not available.");return}if(f&&h+1>=n.length){var v=f(o,p);o=(d=!!v)&&"get"in v&&!("originalValue"in v.get)?v.get:o[p]}else d=k(o,p),o=o[p];d&&!a&&(w[s]=o)}}return o}},5558:(e,t,n)=>{"use strict";var r=n(2)("%Object.getOwnPropertyDescriptor%",!0);if(r)try{r([],"length")}catch(i){r=null}e.exports=r},2101:(e,t,n)=>{"use strict";var r=n(2090),i=function(){return!!r};i.hasArrayLengthDefineBug=function(){if(!r)return null;try{return 1!==r([],"length",{value:1}).length}catch(e){return!0}},e.exports=i},951:e=>{"use strict";var t={__proto__:null,foo:{}},n=Object;e.exports=function(){return{__proto__:t}.foo===t.foo&&!(t instanceof n)}},2108:(e,t,n)=>{"use strict";var r="undefined"!==typeof Symbol&&Symbol,i=n(9534);e.exports=function(){return"function"===typeof r&&("function"===typeof Symbol&&("symbol"===typeof r("foo")&&("symbol"===typeof Symbol("bar")&&i())))}},9534:e=>{"use strict";e.exports=function(){if("function"!==typeof Symbol||"function"!==typeof Object.getOwnPropertySymbols)return!1;if("symbol"===typeof Symbol.iterator)return!0;var e={},t=Symbol("test"),n=Object(t);if("string"===typeof t)return!1;if("[object Symbol]"!==Object.prototype.toString.call(t))return!1;if("[object Symbol]"!==Object.prototype.toString.call(n))return!1;for(t in e[t]=42,e)return!1;if("function"===typeof Object.keys&&0!==Object.keys(e).length)return!1;if("function"===typeof Object.getOwnPropertyNames&&0!==Object.getOwnPropertyNames(e).length)return!1;var r=Object.getOwnPropertySymbols(e);if(1!==r.length||r[0]!==t)return!1;if(!Object.prototype.propertyIsEnumerable.call(e,t))return!1;if("function"===typeof Object.getOwnPropertyDescriptor){var i=Object.getOwnPropertyDescriptor(e,t);if(42!==i.value||!0!==i.enumerable)return!1}return!0}},4384:(e,t,n)=>{"use strict";var r=Function.prototype.call,i=Object.prototype.hasOwnProperty,s=n(3864);e.exports=s.call(r,i)},5437:(e,t)=>{function n(e,t){var n=[],r=[];return null==t&&(t=function(e,t){return n[0]===t?"[Circular ~]":"[Circular ~."+r.slice(0,n.indexOf(t)).join(".")+"]"}),function(i,s){if(n.length>0){var o=n.indexOf(this);~o?n.splice(o+1):n.push(this),~o?r.splice(o,1/0,i):r.push(i),~n.indexOf(s)&&(s=t.call(this,i,s))}else n.push(s);return null==e?s:e.call(this,i,s)}}(e.exports=function(e,t,r,i){return JSON.stringify(e,n(t,i),r)}).getSerialize=n},5531:(e,t,n)=>{var r=n(3028),i=n(8105),s=65536,o=15,a=d(5<<20),c=function(){try{return new Uint32Array(s)}catch(n){for(var e=new Array(s),t=0;t<s;t++)e[t]=0;return e}}(),l=407708164,u=2147483648,h={4:65536,5:262144,6:1048576,7:4194304};function d(e){try{return new Uint8Array(e)}catch(r){for(var t=new Array(e),n=0;n<e;n++)t[n]=0;return t}}function f(e,t,n){if(void 0!==typeof e.buffer){if(Uint8Array.prototype.slice)return e.slice(t,n);var r=e.length;t=(t|=0)<0?Math.max(r+t,0):Math.min(t,r),n=(n=void 0===n?r:0|n)<0?Math.max(r+n,0):Math.min(n,r);for(var i=new Uint8Array(n-t),s=t,o=0;s<n;)i[o++]=e[s++];return i}return e.slice(t,n)}t.compressBound=function(e){return e+e/255+16|0},t.decompressBound=function(e){var t=0;if(i.readU32(e,t)!==l)throw new Error("invalid magic number");t+=4;var n=e[t++];if(64!==(192&n))throw new Error("incompatible descriptor version "+(192&n));var r=0!==(16&n),s=0!==(8&n),o=e[t++]>>4&7;if(void 0===h[o])throw new Error("invalid block size "+o);var a=h[o];if(s)return i.readU64(e,t);t++;for(var c=0;;){var d=i.readU32(e,t);if(t+=4,c+=d&u?d&=2147483647:a,0===d)return c;r&&(t+=4),t+=d}},t.makeBuffer=d,t.decompressBlock=function(e,t,n,r,i){var s,o,a,c,l;for(a=n+r;n<a;){var u=e[n++],h=u>>4;if(h>0){if(15===h)for(;h+=e[n],255===e[n++];);for(c=n+h;n<c;)t[i++]=e[n++]}if(n>=a)break;if(s=15&u,o=e[n++]|e[n++]<<8,15===s)for(;s+=e[n],255===e[n++];);for(c=(l=i-o)+(s+=4);l<c;)t[i++]=0|t[l++]}return i},t.compressBlock=function(e,t,n,r,s){var a,c,l,u,h,d,f,p;if(d=0,f=r+n,c=n,r>=13)for(var m=67;n+4<f-5;){var g=i.readU32(e,n),v=i.hashU32(g)>>>0;if(a=s[v=(v>>16^v)>>>0&65535]-1,s[v]=n+1,a<0||n-a>>>16>0||i.readU32(e,a)!==g)n+=m++>>6;else{for(m=67,h=n-c,u=n-a,a+=4,l=n+=4;n<f-5&&e[n]===e[a];)n++,a++;var y=(l=n-l)<15?l:15;if(h>=o){for(t[d++]=240+y,p=h-o;p>=255;p-=255)t[d++]=255;t[d++]=p}else t[d++]=(h<<4)+y;for(var b=0;b<h;b++)t[d++]=e[c+b];if(t[d++]=u,t[d++]=u>>8,l>=15){for(p=l-15;p>=255;p-=255)t[d++]=255;t[d++]=p}c=n}}if(0===c)return 0;if((h=f-c)>=o){for(t[d++]=240,p=h-o;p>=255;p-=255)t[d++]=255;t[d++]=p}else t[d++]=h<<4;for(n=c;n<f;)t[d++]=e[n++];return d},t.decompressFrame=function(e,n){var r,s,o,a,c=0,d=0;if(i.readU32(e,c)!==l)throw new Error("invalid magic number");if(c+=4,64!==(192&(a=e[c++])))throw new Error("incompatible descriptor version");r=0!==(16&a),s=0!==(4&a),o=0!==(8&a);var f=e[c++]>>4&7;if(void 0===h[f])throw new Error("invalid block size");for(o&&(c+=8),c++;;){var p;if(p=i.readU32(e,c),c+=4,0===p)break;if(r&&(c+=4),0!==(p&u)){p&=2147483647;for(var m=0;m<p;m++)n[d++]=e[c++]}else d=t.decompressBlock(e,n,c,p,d),c+=p}return s&&(c+=4),d},t.compressFrame=function(e,n){var o=0;i.writeU32(n,o,l),o+=4,n[o++]=64,n[o++]=112,n[o]=r.hash(0,n,4,o-4)>>8,o++;var u=h[7],d=e.length,f=0;for(!function(e){for(var t=0;t<s;t++)c[t]=0}();d>0;){var p,m=d>u?u:d;if((p=t.compressBlock(e,a,f,m,c))>m||0===p){i.writeU32(n,o,2147483648|m),o+=4;for(var g=f+m;f<g;)n[o++]=e[f++];d-=m}else{i.writeU32(n,o,p),o+=4;for(var v=0;v<p;)n[o++]=a[v++];f+=m,d-=m}}return i.writeU32(n,o,0),o+=4},t.decompress=function(e,n){var r,i;return void 0===n&&(n=t.decompressBound(e)),r=t.makeBuffer(n),(i=t.decompressFrame(e,r))!==n&&(r=f(r,0,i)),r},t.compress=function(e,n){var r,i;return void 0===n&&(n=t.compressBound(e.length)),r=t.makeBuffer(n),(i=t.compressFrame(e,r))!==n&&(r=f(r,0,i)),r}},8105:(e,t)=>{t.hashU32=function(e){return-1252372727^(e=(e=(e=(e=-949894596^(e=(e|=0)+2127912214+(e<<12)|0)^e>>>19)+374761393+(e<<5)|0)+-744332180^e<<9)+-42973499+(e<<3)|0)^e>>>16},t.readU64=function(e,t){var n=0;return n|=e[t++]|0,n|=e[t++]<<8,n|=e[t++]<<16,n|=e[t++]<<24,n|=e[t++]<<32,n|=e[t++]<<40,n|=e[t++]<<48,n|=e[t++]<<56},t.readU32=function(e,t){var n=0;return n|=e[t++]|0,n|=e[t++]<<8,n|=e[t++]<<16,n|=e[t++]<<24},t.writeU32=function(e,t,n){e[t++]=255&n,e[t++]=n>>8&255,e[t++]=n>>16&255,e[t++]=n>>24&255},t.imul=function(e,t){var n=65535&e,r=65535&t;return n*r+((e>>>16)*r+n*(t>>>16)<<16)|0}},3028:(e,t,n)=>{var r=n(8105),i=2654435761,s=2246822519,o=3266489917,a=668265263,c=374761393;function l(e,t){return(e|=0)>>>(32-(t|=0)|0)|e<<t}function u(e,t,n){return e|=0,t|=0,n|=0,0|r.imul(e>>>(32-t|0)|e<<t,n)}function h(e,t){return(e|=0)>>>(t|=0)^e}function d(e,t,n,i,s){return u(r.imul(t,n)+e,i,s)}function f(e,t,n){return u(e+r.imul(t[n],c),11,i)}function p(e,t,n){return d(e,r.readU32(t,n),o,17,a)}function m(e,t,n){return[d(e[0],r.readU32(t,n+0),s,13,i),d(e[1],r.readU32(t,n+4),s,13,i),d(e[2],r.readU32(t,n+8),s,13,i),d(e[3],r.readU32(t,n+12),s,13,i)]}t.hash=function(e,t,n,a){var u,d;if(d=a,a>=16){for(u=[e+i+s,e+s,e,e-i];a>=16;)u=m(u,t,n),n+=16,a-=16;u=l(u[0],1)+l(u[1],7)+l(u[2],12)+l(u[3],18)+d}else u=e+c+a>>>0;for(;a>=4;)u=p(u,t,n),n+=4,a-=4;for(;a>0;)u=f(u,t,n),n++,a--;return(u=h(r.imul(h(r.imul(h(u,15),s),13),o),16))>>>0}},7340:e=>{var t=1e3,n=60*t,r=60*n,i=24*r,s=7*i,o=365.25*i;function a(e,t,n,r){var i=t>=1.5*n;return Math.round(e/n)+" "+r+(i?"s":"")}e.exports=function(e,c){c=c||{};var l=typeof e;if("string"===l&&e.length>0)return function(e){if((e=String(e)).length>100)return;var a=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!a)return;var c=parseFloat(a[1]);switch((a[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return c*o;case"weeks":case"week":case"w":return c*s;case"days":case"day":case"d":return c*i;case"hours":case"hour":case"hrs":case"hr":case"h":return c*r;case"minutes":case"minute":case"mins":case"min":case"m":return c*n;case"seconds":case"second":case"secs":case"sec":case"s":return c*t;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return c;default:return}}(e);if("number"===l&&isFinite(e))return c.long?function(e){var s=Math.abs(e);if(s>=i)return a(e,s,i,"day");if(s>=r)return a(e,s,r,"hour");if(s>=n)return a(e,s,n,"minute");if(s>=t)return a(e,s,t,"second");return e+" ms"}(e):function(e){var s=Math.abs(e);if(s>=i)return Math.round(e/i)+"d";if(s>=r)return Math.round(e/r)+"h";if(s>=n)return Math.round(e/n)+"m";if(s>=t)return Math.round(e/t)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},8206:(e,t,n)=>{var r="function"===typeof Map&&Map.prototype,i=Object.getOwnPropertyDescriptor&&r?Object.getOwnPropertyDescriptor(Map.prototype,"size"):null,s=r&&i&&"function"===typeof i.get?i.get:null,o=r&&Map.prototype.forEach,a="function"===typeof Set&&Set.prototype,c=Object.getOwnPropertyDescriptor&&a?Object.getOwnPropertyDescriptor(Set.prototype,"size"):null,l=a&&c&&"function"===typeof c.get?c.get:null,u=a&&Set.prototype.forEach,h="function"===typeof WeakMap&&WeakMap.prototype?WeakMap.prototype.has:null,d="function"===typeof WeakSet&&WeakSet.prototype?WeakSet.prototype.has:null,f="function"===typeof WeakRef&&WeakRef.prototype?WeakRef.prototype.deref:null,p=Boolean.prototype.valueOf,m=Object.prototype.toString,g=Function.prototype.toString,v=String.prototype.match,y=String.prototype.slice,b=String.prototype.replace,S=String.prototype.toUpperCase,w=String.prototype.toLowerCase,C=RegExp.prototype.test,x=Array.prototype.concat,E=Array.prototype.join,T=Array.prototype.slice,k=Math.floor,N="function"===typeof BigInt?BigInt.prototype.valueOf:null,F=Object.getOwnPropertySymbols,I="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?Symbol.prototype.toString:null,A="function"===typeof Symbol&&"object"===typeof Symbol.iterator,D="function"===typeof Symbol&&Symbol.toStringTag&&(typeof Symbol.toStringTag===A||"symbol")?Symbol.toStringTag:null,O=Object.prototype.propertyIsEnumerable,P=("function"===typeof Reflect?Reflect.getPrototypeOf:Object.getPrototypeOf)||([].__proto__===Array.prototype?function(e){return e.__proto__}:null);function R(e,t){if(e===1/0||e===-1/0||e!==e||e&&e>-1e3&&e<1e3||C.call(/e/,t))return t;var n=/[0-9](?=(?:[0-9]{3})+(?![0-9]))/g;if("number"===typeof e){var r=e<0?-k(-e):k(e);if(r!==e){var i=String(r),s=y.call(t,i.length+1);return b.call(i,n,"$&_")+"."+b.call(b.call(s,/([0-9]{3})/g,"$&_"),/_$/,"")}}return b.call(t,n,"$&_")}var M=n(2634),B=M.custom,L=U(B)?B:null;function q(e,t,n){var r="double"===(n.quoteStyle||t)?'"':"'";return r+e+r}function _(e){return b.call(String(e),/"/g,"&quot;")}function j(e){return"[object Array]"===K(e)&&(!D||!("object"===typeof e&&D in e))}function z(e){return"[object RegExp]"===K(e)&&(!D||!("object"===typeof e&&D in e))}function U(e){if(A)return e&&"object"===typeof e&&e instanceof Symbol;if("symbol"===typeof e)return!0;if(!e||"object"!==typeof e||!I)return!1;try{return I.call(e),!0}catch(t){}return!1}e.exports=function e(t,r,i,a){var c=r||{};if(V(c,"quoteStyle")&&"single"!==c.quoteStyle&&"double"!==c.quoteStyle)throw new TypeError('option "quoteStyle" must be "single" or "double"');if(V(c,"maxStringLength")&&("number"===typeof c.maxStringLength?c.maxStringLength<0&&c.maxStringLength!==1/0:null!==c.maxStringLength))throw new TypeError('option "maxStringLength", if provided, must be a positive integer, Infinity, or `null`');var m=!V(c,"customInspect")||c.customInspect;if("boolean"!==typeof m&&"symbol"!==m)throw new TypeError("option \"customInspect\", if provided, must be `true`, `false`, or `'symbol'`");if(V(c,"indent")&&null!==c.indent&&"\t"!==c.indent&&!(parseInt(c.indent,10)===c.indent&&c.indent>0))throw new TypeError('option "indent" must be "\\t", an integer > 0, or `null`');if(V(c,"numericSeparator")&&"boolean"!==typeof c.numericSeparator)throw new TypeError('option "numericSeparator", if provided, must be `true` or `false`');var S=c.numericSeparator;if("undefined"===typeof t)return"undefined";if(null===t)return"null";if("boolean"===typeof t)return t?"true":"false";if("string"===typeof t)return W(t,c);if("number"===typeof t){if(0===t)return 1/0/t>0?"0":"-0";var C=String(t);return S?R(t,C):C}if("bigint"===typeof t){var k=String(t)+"n";return S?R(t,k):k}var F="undefined"===typeof c.depth?5:c.depth;if("undefined"===typeof i&&(i=0),i>=F&&F>0&&"object"===typeof t)return j(t)?"[Array]":"[Object]";var B=function(e,t){var n;if("\t"===e.indent)n="\t";else{if(!("number"===typeof e.indent&&e.indent>0))return null;n=E.call(Array(e.indent+1)," ")}return{base:n,prev:E.call(Array(t+1),n)}}(c,i);if("undefined"===typeof a)a=[];else if(G(a,t)>=0)return"[Circular]";function H(t,n,r){if(n&&(a=T.call(a)).push(n),r){var s={depth:c.depth};return V(c,"quoteStyle")&&(s.quoteStyle=c.quoteStyle),e(t,s,i+1,a)}return e(t,c,i+1,a)}if("function"===typeof t&&!z(t)){var J=function(e){if(e.name)return e.name;var t=v.call(g.call(e),/^function\s*([\w$]+)/);if(t)return t[1];return null}(t),ee=Y(t,H);return"[Function"+(J?": "+J:" (anonymous)")+"]"+(ee.length>0?" { "+E.call(ee,", ")+" }":"")}if(U(t)){var te=A?b.call(String(t),/^(Symbol\(.*\))_[^)]*$/,"$1"):I.call(t);return"object"!==typeof t||A?te:Z(te)}if(function(e){if(!e||"object"!==typeof e)return!1;if("undefined"!==typeof HTMLElement&&e instanceof HTMLElement)return!0;return"string"===typeof e.nodeName&&"function"===typeof e.getAttribute}(t)){for(var ne="<"+w.call(String(t.nodeName)),re=t.attributes||[],ie=0;ie<re.length;ie++)ne+=" "+re[ie].name+"="+q(_(re[ie].value),"double",c);return ne+=">",t.childNodes&&t.childNodes.length&&(ne+="..."),ne+="</"+w.call(String(t.nodeName))+">"}if(j(t)){if(0===t.length)return"[]";var se=Y(t,H);return B&&!function(e){for(var t=0;t<e.length;t++)if(G(e[t],"\n")>=0)return!1;return!0}(se)?"["+X(se,B)+"]":"[ "+E.call(se,", ")+" ]"}if(function(e){return"[object Error]"===K(e)&&(!D||!("object"===typeof e&&D in e))}(t)){var oe=Y(t,H);return"cause"in Error.prototype||!("cause"in t)||O.call(t,"cause")?0===oe.length?"["+String(t)+"]":"{ ["+String(t)+"] "+E.call(oe,", ")+" }":"{ ["+String(t)+"] "+E.call(x.call("[cause]: "+H(t.cause),oe),", ")+" }"}if("object"===typeof t&&m){if(L&&"function"===typeof t[L]&&M)return M(t,{depth:F-i});if("symbol"!==m&&"function"===typeof t.inspect)return t.inspect()}if(function(e){if(!s||!e||"object"!==typeof e)return!1;try{s.call(e);try{l.call(e)}catch(ne){return!0}return e instanceof Map}catch(t){}return!1}(t)){var ae=[];return o&&o.call(t,(function(e,n){ae.push(H(n,t,!0)+" => "+H(e,t))})),Q("Map",s.call(t),ae,B)}if(function(e){if(!l||!e||"object"!==typeof e)return!1;try{l.call(e);try{s.call(e)}catch(t){return!0}return e instanceof Set}catch(n){}return!1}(t)){var ce=[];return u&&u.call(t,(function(e){ce.push(H(e,t))})),Q("Set",l.call(t),ce,B)}if(function(e){if(!h||!e||"object"!==typeof e)return!1;try{h.call(e,h);try{d.call(e,d)}catch(ne){return!0}return e instanceof WeakMap}catch(t){}return!1}(t))return $("WeakMap");if(function(e){if(!d||!e||"object"!==typeof e)return!1;try{d.call(e,d);try{h.call(e,h)}catch(ne){return!0}return e instanceof WeakSet}catch(t){}return!1}(t))return $("WeakSet");if(function(e){if(!f||!e||"object"!==typeof e)return!1;try{return f.call(e),!0}catch(t){}return!1}(t))return $("WeakRef");if(function(e){return"[object Number]"===K(e)&&(!D||!("object"===typeof e&&D in e))}(t))return Z(H(Number(t)));if(function(e){if(!e||"object"!==typeof e||!N)return!1;try{return N.call(e),!0}catch(t){}return!1}(t))return Z(H(N.call(t)));if(function(e){return"[object Boolean]"===K(e)&&(!D||!("object"===typeof e&&D in e))}(t))return Z(p.call(t));if(function(e){return"[object String]"===K(e)&&(!D||!("object"===typeof e&&D in e))}(t))return Z(H(String(t)));if("undefined"!==typeof window&&t===window)return"{ [object Window] }";if(t===n.g)return"{ [object globalThis] }";if(!function(e){return"[object Date]"===K(e)&&(!D||!("object"===typeof e&&D in e))}(t)&&!z(t)){var le=Y(t,H),ue=P?P(t)===Object.prototype:t instanceof Object||t.constructor===Object,he=t instanceof Object?"":"null prototype",de=!ue&&D&&Object(t)===t&&D in t?y.call(K(t),8,-1):he?"Object":"",fe=(ue||"function"!==typeof t.constructor?"":t.constructor.name?t.constructor.name+" ":"")+(de||he?"["+E.call(x.call([],de||[],he||[]),": ")+"] ":"");return 0===le.length?fe+"{}":B?fe+"{"+X(le,B)+"}":fe+"{ "+E.call(le,", ")+" }"}return String(t)};var H=Object.prototype.hasOwnProperty||function(e){return e in this};function V(e,t){return H.call(e,t)}function K(e){return m.call(e)}function G(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1}function W(e,t){if(e.length>t.maxStringLength){var n=e.length-t.maxStringLength,r="... "+n+" more character"+(n>1?"s":"");return W(y.call(e,0,t.maxStringLength),t)+r}return q(b.call(b.call(e,/(['\\])/g,"\\$1"),/[\x00-\x1f]/g,J),"single",t)}function J(e){var t=e.charCodeAt(0),n={8:"b",9:"t",10:"n",12:"f",13:"r"}[t];return n?"\\"+n:"\\x"+(t<16?"0":"")+S.call(t.toString(16))}function Z(e){return"Object("+e+")"}function $(e){return e+" { ? }"}function Q(e,t,n,r){return e+" ("+t+") {"+(r?X(n,r):E.call(n,", "))+"}"}function X(e,t){if(0===e.length)return"";var n="\n"+t.prev+t.base;return n+E.call(e,","+n)+"\n"+t.prev}function Y(e,t){var n=j(e),r=[];if(n){r.length=e.length;for(var i=0;i<e.length;i++)r[i]=V(e,i)?t(e[i],e):""}var s,o="function"===typeof F?F(e):[];if(A){s={};for(var a=0;a<o.length;a++)s["$"+o[a]]=o[a]}for(var c in e)V(e,c)&&(n&&String(Number(c))===c&&c<e.length||A&&s["$"+c]instanceof Symbol||(C.call(/[^\w$]/,c)?r.push(t(c,e)+": "+t(e[c],e)):r.push(c+": "+t(e[c],e))));if("function"===typeof F)for(var l=0;l<o.length;l++)O.call(e,o[l])&&r.push("["+t(o[l])+"]: "+t(e[o[l]],e));return r}},3316:e=>{"use strict";function t(e){if("string"!==typeof e)throw new TypeError("Path must be a string. Received "+JSON.stringify(e))}function n(e,t){for(var n,r="",i=0,s=-1,o=0,a=0;a<=e.length;++a){if(a<e.length)n=e.charCodeAt(a);else{if(47===n)break;n=47}if(47===n){if(s===a-1||1===o);else if(s!==a-1&&2===o){if(r.length<2||2!==i||46!==r.charCodeAt(r.length-1)||46!==r.charCodeAt(r.length-2))if(r.length>2){var c=r.lastIndexOf("/");if(c!==r.length-1){-1===c?(r="",i=0):i=(r=r.slice(0,c)).length-1-r.lastIndexOf("/"),s=a,o=0;continue}}else if(2===r.length||1===r.length){r="",i=0,s=a,o=0;continue}t&&(r.length>0?r+="/..":r="..",i=2)}else r.length>0?r+="/"+e.slice(s+1,a):r=e.slice(s+1,a),i=a-s-1;s=a,o=0}else 46===n&&-1!==o?++o:o=-1}return r}var r={resolve:function(){for(var e,r="",i=!1,s=arguments.length-1;s>=-1&&!i;s--){var o;s>=0?o=arguments[s]:(void 0===e&&(e=process.cwd()),o=e),t(o),0!==o.length&&(r=o+"/"+r,i=47===o.charCodeAt(0))}return r=n(r,!i),i?r.length>0?"/"+r:"/":r.length>0?r:"."},normalize:function(e){if(t(e),0===e.length)return".";var r=47===e.charCodeAt(0),i=47===e.charCodeAt(e.length-1);return 0!==(e=n(e,!r)).length||r||(e="."),e.length>0&&i&&(e+="/"),r?"/"+e:e},isAbsolute:function(e){return t(e),e.length>0&&47===e.charCodeAt(0)},join:function(){if(0===arguments.length)return".";for(var e,n=0;n<arguments.length;++n){var i=arguments[n];t(i),i.length>0&&(void 0===e?e=i:e+="/"+i)}return void 0===e?".":r.normalize(e)},relative:function(e,n){if(t(e),t(n),e===n)return"";if((e=r.resolve(e))===(n=r.resolve(n)))return"";for(var i=1;i<e.length&&47===e.charCodeAt(i);++i);for(var s=e.length,o=s-i,a=1;a<n.length&&47===n.charCodeAt(a);++a);for(var c=n.length-a,l=o<c?o:c,u=-1,h=0;h<=l;++h){if(h===l){if(c>l){if(47===n.charCodeAt(a+h))return n.slice(a+h+1);if(0===h)return n.slice(a+h)}else o>l&&(47===e.charCodeAt(i+h)?u=h:0===h&&(u=0));break}var d=e.charCodeAt(i+h);if(d!==n.charCodeAt(a+h))break;47===d&&(u=h)}var f="";for(h=i+u+1;h<=s;++h)h!==s&&47!==e.charCodeAt(h)||(0===f.length?f+="..":f+="/..");return f.length>0?f+n.slice(a+u):(a+=u,47===n.charCodeAt(a)&&++a,n.slice(a))},_makeLong:function(e){return e},dirname:function(e){if(t(e),0===e.length)return".";for(var n=e.charCodeAt(0),r=47===n,i=-1,s=!0,o=e.length-1;o>=1;--o)if(47===(n=e.charCodeAt(o))){if(!s){i=o;break}}else s=!1;return-1===i?r?"/":".":r&&1===i?"//":e.slice(0,i)},basename:function(e,n){if(void 0!==n&&"string"!==typeof n)throw new TypeError('"ext" argument must be a string');t(e);var r,i=0,s=-1,o=!0;if(void 0!==n&&n.length>0&&n.length<=e.length){if(n.length===e.length&&n===e)return"";var a=n.length-1,c=-1;for(r=e.length-1;r>=0;--r){var l=e.charCodeAt(r);if(47===l){if(!o){i=r+1;break}}else-1===c&&(o=!1,c=r+1),a>=0&&(l===n.charCodeAt(a)?-1===--a&&(s=r):(a=-1,s=c))}return i===s?s=c:-1===s&&(s=e.length),e.slice(i,s)}for(r=e.length-1;r>=0;--r)if(47===e.charCodeAt(r)){if(!o){i=r+1;break}}else-1===s&&(o=!1,s=r+1);return-1===s?"":e.slice(i,s)},extname:function(e){t(e);for(var n=-1,r=0,i=-1,s=!0,o=0,a=e.length-1;a>=0;--a){var c=e.charCodeAt(a);if(47!==c)-1===i&&(s=!1,i=a+1),46===c?-1===n?n=a:1!==o&&(o=1):-1!==n&&(o=-1);else if(!s){r=a+1;break}}return-1===n||-1===i||0===o||1===o&&n===i-1&&n===r+1?"":e.slice(n,i)},format:function(e){if(null===e||"object"!==typeof e)throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return function(e,t){var n=t.dir||t.root,r=t.base||(t.name||"")+(t.ext||"");return n?n===t.root?n+r:n+e+r:r}("/",e)},parse:function(e){t(e);var n={root:"",dir:"",base:"",ext:"",name:""};if(0===e.length)return n;var r,i=e.charCodeAt(0),s=47===i;s?(n.root="/",r=1):r=0;for(var o=-1,a=0,c=-1,l=!0,u=e.length-1,h=0;u>=r;--u)if(47!==(i=e.charCodeAt(u)))-1===c&&(l=!1,c=u+1),46===i?-1===o?o=u:1!==h&&(h=1):-1!==o&&(h=-1);else if(!l){a=u+1;break}return-1===o||-1===c||0===h||1===h&&o===c-1&&o===a+1?-1!==c&&(n.base=n.name=0===a&&s?e.slice(1,c):e.slice(a,c)):(0===a&&s?(n.name=e.slice(1,o),n.base=e.slice(1,c)):(n.name=e.slice(a,o),n.base=e.slice(a,c)),n.ext=e.slice(o,c)),a>0?n.dir=e.slice(0,a-1):s&&(n.dir="/"),n},sep:"/",delimiter:":",win32:null,posix:null};r.posix=r,e.exports=r},7237:(e,t)=>{"use strict";var n=Object.prototype.hasOwnProperty;function r(e){try{return decodeURIComponent(e.replace(/\+/g," "))}catch(t){return null}}function i(e){try{return encodeURIComponent(e)}catch(t){return null}}t.stringify=function(e,t){t=t||"";var r,s,o=[];for(s in"string"!==typeof t&&(t="?"),e)if(n.call(e,s)){if((r=e[s])||null!==r&&undefined!==r&&!isNaN(r)||(r=""),s=i(s),r=i(r),null===s||null===r)continue;o.push(s+"="+r)}return o.length?t+o.join("&"):""},t.parse=function(e){for(var t,n=/([^=?#&]+)=?([^&]*)/g,i={};t=n.exec(e);){var s=r(t[1]),o=r(t[2]);null===s||null===o||s in i||(i[s]=o)}return i}},2730:(e,t,n)=>{"use strict";var r=n(5043),i=n(8853);function s(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=1;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var o=new Set,a={};function c(e,t){l(e,t),l(e+"Capture",t)}function l(e,t){for(a[e]=t,e=0;e<t.length;e++)o.add(t[e])}var u=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),h=Object.prototype.hasOwnProperty,d=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,f={},p={};function m(e,t,n,r,i,s,o){this.acceptsBooleans=2===t||3===t||4===t,this.attributeName=r,this.attributeNamespace=i,this.mustUseProperty=n,this.propertyName=e,this.type=t,this.sanitizeURL=s,this.removeEmptyString=o}var g={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach((function(e){g[e]=new m(e,0,!1,e,null,!1,!1)})),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach((function(e){var t=e[0];g[t]=new m(t,1,!1,e[1],null,!1,!1)})),["contentEditable","draggable","spellCheck","value"].forEach((function(e){g[e]=new m(e,2,!1,e.toLowerCase(),null,!1,!1)})),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach((function(e){g[e]=new m(e,2,!1,e,null,!1,!1)})),"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach((function(e){g[e]=new m(e,3,!1,e.toLowerCase(),null,!1,!1)})),["checked","multiple","muted","selected"].forEach((function(e){g[e]=new m(e,3,!0,e,null,!1,!1)})),["capture","download"].forEach((function(e){g[e]=new m(e,4,!1,e,null,!1,!1)})),["cols","rows","size","span"].forEach((function(e){g[e]=new m(e,6,!1,e,null,!1,!1)})),["rowSpan","start"].forEach((function(e){g[e]=new m(e,5,!1,e.toLowerCase(),null,!1,!1)}));var v=/[\-:]([a-z])/g;function y(e){return e[1].toUpperCase()}function b(e,t,n,r){var i=g.hasOwnProperty(t)?g[t]:null;(null!==i?0!==i.type:r||!(2<t.length)||"o"!==t[0]&&"O"!==t[0]||"n"!==t[1]&&"N"!==t[1])&&(function(e,t,n,r){if(null===t||"undefined"===typeof t||function(e,t,n,r){if(null!==n&&0===n.type)return!1;switch(typeof t){case"function":case"symbol":return!0;case"boolean":return!r&&(null!==n?!n.acceptsBooleans:"data-"!==(e=e.toLowerCase().slice(0,5))&&"aria-"!==e);default:return!1}}(e,t,n,r))return!0;if(r)return!1;if(null!==n)switch(n.type){case 3:return!t;case 4:return!1===t;case 5:return isNaN(t);case 6:return isNaN(t)||1>t}return!1}(t,n,i,r)&&(n=null),r||null===i?function(e){return!!h.call(p,e)||!h.call(f,e)&&(d.test(e)?p[e]=!0:(f[e]=!0,!1))}(t)&&(null===n?e.removeAttribute(t):e.setAttribute(t,""+n)):i.mustUseProperty?e[i.propertyName]=null===n?3!==i.type&&"":n:(t=i.attributeName,r=i.attributeNamespace,null===n?e.removeAttribute(t):(n=3===(i=i.type)||4===i&&!0===n?"":""+n,r?e.setAttributeNS(r,t,n):e.setAttribute(t,n))))}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach((function(e){var t=e.replace(v,y);g[t]=new m(t,1,!1,e,null,!1,!1)})),"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach((function(e){var t=e.replace(v,y);g[t]=new m(t,1,!1,e,"http://www.w3.org/1999/xlink",!1,!1)})),["xml:base","xml:lang","xml:space"].forEach((function(e){var t=e.replace(v,y);g[t]=new m(t,1,!1,e,"http://www.w3.org/XML/1998/namespace",!1,!1)})),["tabIndex","crossOrigin"].forEach((function(e){g[e]=new m(e,1,!1,e.toLowerCase(),null,!1,!1)})),g.xlinkHref=new m("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1),["src","href","action","formAction"].forEach((function(e){g[e]=new m(e,1,!1,e.toLowerCase(),null,!0,!0)}));var S=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,w=Symbol.for("react.element"),C=Symbol.for("react.portal"),x=Symbol.for("react.fragment"),E=Symbol.for("react.strict_mode"),T=Symbol.for("react.profiler"),k=Symbol.for("react.provider"),N=Symbol.for("react.context"),F=Symbol.for("react.forward_ref"),I=Symbol.for("react.suspense"),A=Symbol.for("react.suspense_list"),D=Symbol.for("react.memo"),O=Symbol.for("react.lazy");Symbol.for("react.scope"),Symbol.for("react.debug_trace_mode");var P=Symbol.for("react.offscreen");Symbol.for("react.legacy_hidden"),Symbol.for("react.cache"),Symbol.for("react.tracing_marker");var R=Symbol.iterator;function M(e){return null===e||"object"!==typeof e?null:"function"===typeof(e=R&&e[R]||e["@@iterator"])?e:null}var B,L=Object.assign;function q(e){if(void 0===B)try{throw Error()}catch(n){var t=n.stack.trim().match(/\n( *(at )?)/);B=t&&t[1]||""}return"\n"+B+e}var _=!1;function j(e,t){if(!e||_)return"";_=!0;var n=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(t)if(t=function(){throw Error()},Object.defineProperty(t.prototype,"props",{set:function(){throw Error()}}),"object"===typeof Reflect&&Reflect.construct){try{Reflect.construct(t,[])}catch(l){var r=l}Reflect.construct(e,[],t)}else{try{t.call()}catch(l){r=l}e.call(t.prototype)}else{try{throw Error()}catch(l){r=l}e()}}catch(l){if(l&&r&&"string"===typeof l.stack){for(var i=l.stack.split("\n"),s=r.stack.split("\n"),o=i.length-1,a=s.length-1;1<=o&&0<=a&&i[o]!==s[a];)a--;for(;1<=o&&0<=a;o--,a--)if(i[o]!==s[a]){if(1!==o||1!==a)do{if(o--,0>--a||i[o]!==s[a]){var c="\n"+i[o].replace(" at new "," at ");return e.displayName&&c.includes("<anonymous>")&&(c=c.replace("<anonymous>",e.displayName)),c}}while(1<=o&&0<=a);break}}}finally{_=!1,Error.prepareStackTrace=n}return(e=e?e.displayName||e.name:"")?q(e):""}function z(e){switch(e.tag){case 5:return q(e.type);case 16:return q("Lazy");case 13:return q("Suspense");case 19:return q("SuspenseList");case 0:case 2:case 15:return e=j(e.type,!1);case 11:return e=j(e.type.render,!1);case 1:return e=j(e.type,!0);default:return""}}function U(e){if(null==e)return null;if("function"===typeof e)return e.displayName||e.name||null;if("string"===typeof e)return e;switch(e){case x:return"Fragment";case C:return"Portal";case T:return"Profiler";case E:return"StrictMode";case I:return"Suspense";case A:return"SuspenseList"}if("object"===typeof e)switch(e.$$typeof){case N:return(e.displayName||"Context")+".Consumer";case k:return(e._context.displayName||"Context")+".Provider";case F:var t=e.render;return(e=e.displayName)||(e=""!==(e=t.displayName||t.name||"")?"ForwardRef("+e+")":"ForwardRef"),e;case D:return null!==(t=e.displayName||null)?t:U(e.type)||"Memo";case O:t=e._payload,e=e._init;try{return U(e(t))}catch(n){}}return null}function H(e){var t=e.type;switch(e.tag){case 24:return"Cache";case 9:return(t.displayName||"Context")+".Consumer";case 10:return(t._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return e=(e=t.render).displayName||e.name||"",t.displayName||(""!==e?"ForwardRef("+e+")":"ForwardRef");case 7:return"Fragment";case 5:return t;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return U(t);case 8:return t===E?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if("function"===typeof t)return t.displayName||t.name||null;if("string"===typeof t)return t}return null}function V(e){switch(typeof e){case"boolean":case"number":case"string":case"undefined":case"object":return e;default:return""}}function K(e){var t=e.type;return(e=e.nodeName)&&"input"===e.toLowerCase()&&("checkbox"===t||"radio"===t)}function G(e){e._valueTracker||(e._valueTracker=function(e){var t=K(e)?"checked":"value",n=Object.getOwnPropertyDescriptor(e.constructor.prototype,t),r=""+e[t];if(!e.hasOwnProperty(t)&&"undefined"!==typeof n&&"function"===typeof n.get&&"function"===typeof n.set){var i=n.get,s=n.set;return Object.defineProperty(e,t,{configurable:!0,get:function(){return i.call(this)},set:function(e){r=""+e,s.call(this,e)}}),Object.defineProperty(e,t,{enumerable:n.enumerable}),{getValue:function(){return r},setValue:function(e){r=""+e},stopTracking:function(){e._valueTracker=null,delete e[t]}}}}(e))}function W(e){if(!e)return!1;var t=e._valueTracker;if(!t)return!0;var n=t.getValue(),r="";return e&&(r=K(e)?e.checked?"true":"false":e.value),(e=r)!==n&&(t.setValue(e),!0)}function J(e){if("undefined"===typeof(e=e||("undefined"!==typeof document?document:void 0)))return null;try{return e.activeElement||e.body}catch(t){return e.body}}function Z(e,t){var n=t.checked;return L({},t,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=n?n:e._wrapperState.initialChecked})}function $(e,t){var n=null==t.defaultValue?"":t.defaultValue,r=null!=t.checked?t.checked:t.defaultChecked;n=V(null!=t.value?t.value:n),e._wrapperState={initialChecked:r,initialValue:n,controlled:"checkbox"===t.type||"radio"===t.type?null!=t.checked:null!=t.value}}function Q(e,t){null!=(t=t.checked)&&b(e,"checked",t,!1)}function X(e,t){Q(e,t);var n=V(t.value),r=t.type;if(null!=n)"number"===r?(0===n&&""===e.value||e.value!=n)&&(e.value=""+n):e.value!==""+n&&(e.value=""+n);else if("submit"===r||"reset"===r)return void e.removeAttribute("value");t.hasOwnProperty("value")?ee(e,t.type,n):t.hasOwnProperty("defaultValue")&&ee(e,t.type,V(t.defaultValue)),null==t.checked&&null!=t.defaultChecked&&(e.defaultChecked=!!t.defaultChecked)}function Y(e,t,n){if(t.hasOwnProperty("value")||t.hasOwnProperty("defaultValue")){var r=t.type;if(!("submit"!==r&&"reset"!==r||void 0!==t.value&&null!==t.value))return;t=""+e._wrapperState.initialValue,n||t===e.value||(e.value=t),e.defaultValue=t}""!==(n=e.name)&&(e.name=""),e.defaultChecked=!!e._wrapperState.initialChecked,""!==n&&(e.name=n)}function ee(e,t,n){"number"===t&&J(e.ownerDocument)===e||(null==n?e.defaultValue=""+e._wrapperState.initialValue:e.defaultValue!==""+n&&(e.defaultValue=""+n))}var te=Array.isArray;function ne(e,t,n,r){if(e=e.options,t){t={};for(var i=0;i<n.length;i++)t["$"+n[i]]=!0;for(n=0;n<e.length;n++)i=t.hasOwnProperty("$"+e[n].value),e[n].selected!==i&&(e[n].selected=i),i&&r&&(e[n].defaultSelected=!0)}else{for(n=""+V(n),t=null,i=0;i<e.length;i++){if(e[i].value===n)return e[i].selected=!0,void(r&&(e[i].defaultSelected=!0));null!==t||e[i].disabled||(t=e[i])}null!==t&&(t.selected=!0)}}function re(e,t){if(null!=t.dangerouslySetInnerHTML)throw Error(s(91));return L({},t,{value:void 0,defaultValue:void 0,children:""+e._wrapperState.initialValue})}function ie(e,t){var n=t.value;if(null==n){if(n=t.children,t=t.defaultValue,null!=n){if(null!=t)throw Error(s(92));if(te(n)){if(1<n.length)throw Error(s(93));n=n[0]}t=n}null==t&&(t=""),n=t}e._wrapperState={initialValue:V(n)}}function se(e,t){var n=V(t.value),r=V(t.defaultValue);null!=n&&((n=""+n)!==e.value&&(e.value=n),null==t.defaultValue&&e.defaultValue!==n&&(e.defaultValue=n)),null!=r&&(e.defaultValue=""+r)}function oe(e){var t=e.textContent;t===e._wrapperState.initialValue&&""!==t&&null!==t&&(e.value=t)}function ae(e){switch(e){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function ce(e,t){return null==e||"http://www.w3.org/1999/xhtml"===e?ae(t):"http://www.w3.org/2000/svg"===e&&"foreignObject"===t?"http://www.w3.org/1999/xhtml":e}var le,ue,he=(ue=function(e,t){if("http://www.w3.org/2000/svg"!==e.namespaceURI||"innerHTML"in e)e.innerHTML=t;else{for((le=le||document.createElement("div")).innerHTML="<svg>"+t.valueOf().toString()+"</svg>",t=le.firstChild;e.firstChild;)e.removeChild(e.firstChild);for(;t.firstChild;)e.appendChild(t.firstChild)}},"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(e,t,n,r){MSApp.execUnsafeLocalFunction((function(){return ue(e,t)}))}:ue);function de(e,t){if(t){var n=e.firstChild;if(n&&n===e.lastChild&&3===n.nodeType)return void(n.nodeValue=t)}e.textContent=t}var fe={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},pe=["Webkit","ms","Moz","O"];function me(e,t,n){return null==t||"boolean"===typeof t||""===t?"":n||"number"!==typeof t||0===t||fe.hasOwnProperty(e)&&fe[e]?(""+t).trim():t+"px"}function ge(e,t){for(var n in e=e.style,t)if(t.hasOwnProperty(n)){var r=0===n.indexOf("--"),i=me(n,t[n],r);"float"===n&&(n="cssFloat"),r?e.setProperty(n,i):e[n]=i}}Object.keys(fe).forEach((function(e){pe.forEach((function(t){t=t+e.charAt(0).toUpperCase()+e.substring(1),fe[t]=fe[e]}))}));var ve=L({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function ye(e,t){if(t){if(ve[e]&&(null!=t.children||null!=t.dangerouslySetInnerHTML))throw Error(s(137,e));if(null!=t.dangerouslySetInnerHTML){if(null!=t.children)throw Error(s(60));if("object"!==typeof t.dangerouslySetInnerHTML||!("__html"in t.dangerouslySetInnerHTML))throw Error(s(61))}if(null!=t.style&&"object"!==typeof t.style)throw Error(s(62))}}function be(e,t){if(-1===e.indexOf("-"))return"string"===typeof t.is;switch(e){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var Se=null;function we(e){return(e=e.target||e.srcElement||window).correspondingUseElement&&(e=e.correspondingUseElement),3===e.nodeType?e.parentNode:e}var Ce=null,xe=null,Ee=null;function Te(e){if(e=bi(e)){if("function"!==typeof Ce)throw Error(s(280));var t=e.stateNode;t&&(t=wi(t),Ce(e.stateNode,e.type,t))}}function ke(e){xe?Ee?Ee.push(e):Ee=[e]:xe=e}function Ne(){if(xe){var e=xe,t=Ee;if(Ee=xe=null,Te(e),t)for(e=0;e<t.length;e++)Te(t[e])}}function Fe(e,t){return e(t)}function Ie(){}var Ae=!1;function De(e,t,n){if(Ae)return e(t,n);Ae=!0;try{return Fe(e,t,n)}finally{Ae=!1,(null!==xe||null!==Ee)&&(Ie(),Ne())}}function Oe(e,t){var n=e.stateNode;if(null===n)return null;var r=wi(n);if(null===r)return null;n=r[t];e:switch(t){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(r=!r.disabled)||(r=!("button"===(e=e.type)||"input"===e||"select"===e||"textarea"===e)),e=!r;break e;default:e=!1}if(e)return null;if(n&&"function"!==typeof n)throw Error(s(231,t,typeof n));return n}var Pe=!1;if(u)try{var Re={};Object.defineProperty(Re,"passive",{get:function(){Pe=!0}}),window.addEventListener("test",Re,Re),window.removeEventListener("test",Re,Re)}catch(ue){Pe=!1}function Me(e,t,n,r,i,s,o,a,c){var l=Array.prototype.slice.call(arguments,3);try{t.apply(n,l)}catch(u){this.onError(u)}}var Be=!1,Le=null,qe=!1,_e=null,je={onError:function(e){Be=!0,Le=e}};function ze(e,t,n,r,i,s,o,a,c){Be=!1,Le=null,Me.apply(je,arguments)}function Ue(e){var t=e,n=e;if(e.alternate)for(;t.return;)t=t.return;else{e=t;do{0!==(4098&(t=e).flags)&&(n=t.return),e=t.return}while(e)}return 3===t.tag?n:null}function He(e){if(13===e.tag){var t=e.memoizedState;if(null===t&&(null!==(e=e.alternate)&&(t=e.memoizedState)),null!==t)return t.dehydrated}return null}function Ve(e){if(Ue(e)!==e)throw Error(s(188))}function Ke(e){return null!==(e=function(e){var t=e.alternate;if(!t){if(null===(t=Ue(e)))throw Error(s(188));return t!==e?null:e}for(var n=e,r=t;;){var i=n.return;if(null===i)break;var o=i.alternate;if(null===o){if(null!==(r=i.return)){n=r;continue}break}if(i.child===o.child){for(o=i.child;o;){if(o===n)return Ve(i),e;if(o===r)return Ve(i),t;o=o.sibling}throw Error(s(188))}if(n.return!==r.return)n=i,r=o;else{for(var a=!1,c=i.child;c;){if(c===n){a=!0,n=i,r=o;break}if(c===r){a=!0,r=i,n=o;break}c=c.sibling}if(!a){for(c=o.child;c;){if(c===n){a=!0,n=o,r=i;break}if(c===r){a=!0,r=o,n=i;break}c=c.sibling}if(!a)throw Error(s(189))}}if(n.alternate!==r)throw Error(s(190))}if(3!==n.tag)throw Error(s(188));return n.stateNode.current===n?e:t}(e))?Ge(e):null}function Ge(e){if(5===e.tag||6===e.tag)return e;for(e=e.child;null!==e;){var t=Ge(e);if(null!==t)return t;e=e.sibling}return null}var We=i.unstable_scheduleCallback,Je=i.unstable_cancelCallback,Ze=i.unstable_shouldYield,$e=i.unstable_requestPaint,Qe=i.unstable_now,Xe=i.unstable_getCurrentPriorityLevel,Ye=i.unstable_ImmediatePriority,et=i.unstable_UserBlockingPriority,tt=i.unstable_NormalPriority,nt=i.unstable_LowPriority,rt=i.unstable_IdlePriority,it=null,st=null;var ot=Math.clz32?Math.clz32:function(e){return e>>>=0,0===e?32:31-(at(e)/ct|0)|0},at=Math.log,ct=Math.LN2;var lt=64,ut=4194304;function ht(e){switch(e&-e){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return 4194240&e;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return 130023424&e;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return e}}function dt(e,t){var n=e.pendingLanes;if(0===n)return 0;var r=0,i=e.suspendedLanes,s=e.pingedLanes,o=268435455&n;if(0!==o){var a=o&~i;0!==a?r=ht(a):0!==(s&=o)&&(r=ht(s))}else 0!==(o=n&~i)?r=ht(o):0!==s&&(r=ht(s));if(0===r)return 0;if(0!==t&&t!==r&&0===(t&i)&&((i=r&-r)>=(s=t&-t)||16===i&&0!==(4194240&s)))return t;if(0!==(4&r)&&(r|=16&n),0!==(t=e.entangledLanes))for(e=e.entanglements,t&=r;0<t;)i=1<<(n=31-ot(t)),r|=e[n],t&=~i;return r}function ft(e,t){switch(e){case 1:case 2:case 4:return t+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return t+5e3;default:return-1}}function pt(e){return 0!==(e=-1073741825&e.pendingLanes)?e:1073741824&e?1073741824:0}function mt(){var e=lt;return 0===(4194240&(lt<<=1))&&(lt=64),e}function gt(e){for(var t=[],n=0;31>n;n++)t.push(e);return t}function vt(e,t,n){e.pendingLanes|=t,536870912!==t&&(e.suspendedLanes=0,e.pingedLanes=0),(e=e.eventTimes)[t=31-ot(t)]=n}function yt(e,t){var n=e.entangledLanes|=t;for(e=e.entanglements;n;){var r=31-ot(n),i=1<<r;i&t|e[r]&t&&(e[r]|=t),n&=~i}}var bt=0;function St(e){return 1<(e&=-e)?4<e?0!==(268435455&e)?16:536870912:4:1}var wt,Ct,xt,Et,Tt,kt=!1,Nt=[],Ft=null,It=null,At=null,Dt=new Map,Ot=new Map,Pt=[],Rt="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function Mt(e,t){switch(e){case"focusin":case"focusout":Ft=null;break;case"dragenter":case"dragleave":It=null;break;case"mouseover":case"mouseout":At=null;break;case"pointerover":case"pointerout":Dt.delete(t.pointerId);break;case"gotpointercapture":case"lostpointercapture":Ot.delete(t.pointerId)}}function Bt(e,t,n,r,i,s){return null===e||e.nativeEvent!==s?(e={blockedOn:t,domEventName:n,eventSystemFlags:r,nativeEvent:s,targetContainers:[i]},null!==t&&(null!==(t=bi(t))&&Ct(t)),e):(e.eventSystemFlags|=r,t=e.targetContainers,null!==i&&-1===t.indexOf(i)&&t.push(i),e)}function Lt(e){var t=yi(e.target);if(null!==t){var n=Ue(t);if(null!==n)if(13===(t=n.tag)){if(null!==(t=He(n)))return e.blockedOn=t,void Tt(e.priority,(function(){xt(n)}))}else if(3===t&&n.stateNode.current.memoizedState.isDehydrated)return void(e.blockedOn=3===n.tag?n.stateNode.containerInfo:null)}e.blockedOn=null}function qt(e){if(null!==e.blockedOn)return!1;for(var t=e.targetContainers;0<t.length;){var n=Zt(e.domEventName,e.eventSystemFlags,t[0],e.nativeEvent);if(null!==n)return null!==(t=bi(n))&&Ct(t),e.blockedOn=n,!1;var r=new(n=e.nativeEvent).constructor(n.type,n);Se=r,n.target.dispatchEvent(r),Se=null,t.shift()}return!0}function _t(e,t,n){qt(e)&&n.delete(t)}function jt(){kt=!1,null!==Ft&&qt(Ft)&&(Ft=null),null!==It&&qt(It)&&(It=null),null!==At&&qt(At)&&(At=null),Dt.forEach(_t),Ot.forEach(_t)}function zt(e,t){e.blockedOn===t&&(e.blockedOn=null,kt||(kt=!0,i.unstable_scheduleCallback(i.unstable_NormalPriority,jt)))}function Ut(e){function t(t){return zt(t,e)}if(0<Nt.length){zt(Nt[0],e);for(var n=1;n<Nt.length;n++){var r=Nt[n];r.blockedOn===e&&(r.blockedOn=null)}}for(null!==Ft&&zt(Ft,e),null!==It&&zt(It,e),null!==At&&zt(At,e),Dt.forEach(t),Ot.forEach(t),n=0;n<Pt.length;n++)(r=Pt[n]).blockedOn===e&&(r.blockedOn=null);for(;0<Pt.length&&null===(n=Pt[0]).blockedOn;)Lt(n),null===n.blockedOn&&Pt.shift()}var Ht=S.ReactCurrentBatchConfig,Vt=!0;function Kt(e,t,n,r){var i=bt,s=Ht.transition;Ht.transition=null;try{bt=1,Wt(e,t,n,r)}finally{bt=i,Ht.transition=s}}function Gt(e,t,n,r){var i=bt,s=Ht.transition;Ht.transition=null;try{bt=4,Wt(e,t,n,r)}finally{bt=i,Ht.transition=s}}function Wt(e,t,n,r){if(Vt){var i=Zt(e,t,n,r);if(null===i)Vr(e,t,r,Jt,n),Mt(e,r);else if(function(e,t,n,r,i){switch(t){case"focusin":return Ft=Bt(Ft,e,t,n,r,i),!0;case"dragenter":return It=Bt(It,e,t,n,r,i),!0;case"mouseover":return At=Bt(At,e,t,n,r,i),!0;case"pointerover":var s=i.pointerId;return Dt.set(s,Bt(Dt.get(s)||null,e,t,n,r,i)),!0;case"gotpointercapture":return s=i.pointerId,Ot.set(s,Bt(Ot.get(s)||null,e,t,n,r,i)),!0}return!1}(i,e,t,n,r))r.stopPropagation();else if(Mt(e,r),4&t&&-1<Rt.indexOf(e)){for(;null!==i;){var s=bi(i);if(null!==s&&wt(s),null===(s=Zt(e,t,n,r))&&Vr(e,t,r,Jt,n),s===i)break;i=s}null!==i&&r.stopPropagation()}else Vr(e,t,r,null,n)}}var Jt=null;function Zt(e,t,n,r){if(Jt=null,null!==(e=yi(e=we(r))))if(null===(t=Ue(e)))e=null;else if(13===(n=t.tag)){if(null!==(e=He(t)))return e;e=null}else if(3===n){if(t.stateNode.current.memoizedState.isDehydrated)return 3===t.tag?t.stateNode.containerInfo:null;e=null}else t!==e&&(e=null);return Jt=e,null}function $t(e){switch(e){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(Xe()){case Ye:return 1;case et:return 4;case tt:case nt:return 16;case rt:return 536870912;default:return 16}default:return 16}}var Qt=null,Xt=null,Yt=null;function en(){if(Yt)return Yt;var e,t,n=Xt,r=n.length,i="value"in Qt?Qt.value:Qt.textContent,s=i.length;for(e=0;e<r&&n[e]===i[e];e++);var o=r-e;for(t=1;t<=o&&n[r-t]===i[s-t];t++);return Yt=i.slice(e,1<t?1-t:void 0)}function tn(e){var t=e.keyCode;return"charCode"in e?0===(e=e.charCode)&&13===t&&(e=13):e=t,10===e&&(e=13),32<=e||13===e?e:0}function nn(){return!0}function rn(){return!1}function sn(e){function t(t,n,r,i,s){for(var o in this._reactName=t,this._targetInst=r,this.type=n,this.nativeEvent=i,this.target=s,this.currentTarget=null,e)e.hasOwnProperty(o)&&(t=e[o],this[o]=t?t(i):i[o]);return this.isDefaultPrevented=(null!=i.defaultPrevented?i.defaultPrevented:!1===i.returnValue)?nn:rn,this.isPropagationStopped=rn,this}return L(t.prototype,{preventDefault:function(){this.defaultPrevented=!0;var e=this.nativeEvent;e&&(e.preventDefault?e.preventDefault():"unknown"!==typeof e.returnValue&&(e.returnValue=!1),this.isDefaultPrevented=nn)},stopPropagation:function(){var e=this.nativeEvent;e&&(e.stopPropagation?e.stopPropagation():"unknown"!==typeof e.cancelBubble&&(e.cancelBubble=!0),this.isPropagationStopped=nn)},persist:function(){},isPersistent:nn}),t}var on,an,cn,ln={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(e){return e.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},un=sn(ln),hn=L({},ln,{view:0,detail:0}),dn=sn(hn),fn=L({},hn,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:Tn,button:0,buttons:0,relatedTarget:function(e){return void 0===e.relatedTarget?e.fromElement===e.srcElement?e.toElement:e.fromElement:e.relatedTarget},movementX:function(e){return"movementX"in e?e.movementX:(e!==cn&&(cn&&"mousemove"===e.type?(on=e.screenX-cn.screenX,an=e.screenY-cn.screenY):an=on=0,cn=e),on)},movementY:function(e){return"movementY"in e?e.movementY:an}}),pn=sn(fn),mn=sn(L({},fn,{dataTransfer:0})),gn=sn(L({},hn,{relatedTarget:0})),vn=sn(L({},ln,{animationName:0,elapsedTime:0,pseudoElement:0})),yn=L({},ln,{clipboardData:function(e){return"clipboardData"in e?e.clipboardData:window.clipboardData}}),bn=sn(yn),Sn=sn(L({},ln,{data:0})),wn={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},Cn={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},xn={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function En(e){var t=this.nativeEvent;return t.getModifierState?t.getModifierState(e):!!(e=xn[e])&&!!t[e]}function Tn(){return En}var kn=L({},hn,{key:function(e){if(e.key){var t=wn[e.key]||e.key;if("Unidentified"!==t)return t}return"keypress"===e.type?13===(e=tn(e))?"Enter":String.fromCharCode(e):"keydown"===e.type||"keyup"===e.type?Cn[e.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:Tn,charCode:function(e){return"keypress"===e.type?tn(e):0},keyCode:function(e){return"keydown"===e.type||"keyup"===e.type?e.keyCode:0},which:function(e){return"keypress"===e.type?tn(e):"keydown"===e.type||"keyup"===e.type?e.keyCode:0}}),Nn=sn(kn),Fn=sn(L({},fn,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0})),In=sn(L({},hn,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:Tn})),An=sn(L({},ln,{propertyName:0,elapsedTime:0,pseudoElement:0})),Dn=L({},fn,{deltaX:function(e){return"deltaX"in e?e.deltaX:"wheelDeltaX"in e?-e.wheelDeltaX:0},deltaY:function(e){return"deltaY"in e?e.deltaY:"wheelDeltaY"in e?-e.wheelDeltaY:"wheelDelta"in e?-e.wheelDelta:0},deltaZ:0,deltaMode:0}),On=sn(Dn),Pn=[9,13,27,32],Rn=u&&"CompositionEvent"in window,Mn=null;u&&"documentMode"in document&&(Mn=document.documentMode);var Bn=u&&"TextEvent"in window&&!Mn,Ln=u&&(!Rn||Mn&&8<Mn&&11>=Mn),qn=String.fromCharCode(32),_n=!1;function jn(e,t){switch(e){case"keyup":return-1!==Pn.indexOf(t.keyCode);case"keydown":return 229!==t.keyCode;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function zn(e){return"object"===typeof(e=e.detail)&&"data"in e?e.data:null}var Un=!1;var Hn={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Vn(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return"input"===t?!!Hn[e.type]:"textarea"===t}function Kn(e,t,n,r){ke(r),0<(t=Gr(t,"onChange")).length&&(n=new un("onChange","change",null,n,r),e.push({event:n,listeners:t}))}var Gn=null,Wn=null;function Jn(e){qr(e,0)}function Zn(e){if(W(Si(e)))return e}function $n(e,t){if("change"===e)return t}var Qn=!1;if(u){var Xn;if(u){var Yn="oninput"in document;if(!Yn){var er=document.createElement("div");er.setAttribute("oninput","return;"),Yn="function"===typeof er.oninput}Xn=Yn}else Xn=!1;Qn=Xn&&(!document.documentMode||9<document.documentMode)}function tr(){Gn&&(Gn.detachEvent("onpropertychange",nr),Wn=Gn=null)}function nr(e){if("value"===e.propertyName&&Zn(Wn)){var t=[];Kn(t,Wn,e,we(e)),De(Jn,t)}}function rr(e,t,n){"focusin"===e?(tr(),Wn=n,(Gn=t).attachEvent("onpropertychange",nr)):"focusout"===e&&tr()}function ir(e){if("selectionchange"===e||"keyup"===e||"keydown"===e)return Zn(Wn)}function sr(e,t){if("click"===e)return Zn(t)}function or(e,t){if("input"===e||"change"===e)return Zn(t)}var ar="function"===typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e===1/t)||e!==e&&t!==t};function cr(e,t){if(ar(e,t))return!0;if("object"!==typeof e||null===e||"object"!==typeof t||null===t)return!1;var n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(r=0;r<n.length;r++){var i=n[r];if(!h.call(t,i)||!ar(e[i],t[i]))return!1}return!0}function lr(e){for(;e&&e.firstChild;)e=e.firstChild;return e}function ur(e,t){var n,r=lr(e);for(e=0;r;){if(3===r.nodeType){if(n=e+r.textContent.length,e<=t&&n>=t)return{node:r,offset:t-e};e=n}e:{for(;r;){if(r.nextSibling){r=r.nextSibling;break e}r=r.parentNode}r=void 0}r=lr(r)}}function hr(e,t){return!(!e||!t)&&(e===t||(!e||3!==e.nodeType)&&(t&&3===t.nodeType?hr(e,t.parentNode):"contains"in e?e.contains(t):!!e.compareDocumentPosition&&!!(16&e.compareDocumentPosition(t))))}function dr(){for(var e=window,t=J();t instanceof e.HTMLIFrameElement;){try{var n="string"===typeof t.contentWindow.location.href}catch(r){n=!1}if(!n)break;t=J((e=t.contentWindow).document)}return t}function fr(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return t&&("input"===t&&("text"===e.type||"search"===e.type||"tel"===e.type||"url"===e.type||"password"===e.type)||"textarea"===t||"true"===e.contentEditable)}function pr(e){var t=dr(),n=e.focusedElem,r=e.selectionRange;if(t!==n&&n&&n.ownerDocument&&hr(n.ownerDocument.documentElement,n)){if(null!==r&&fr(n))if(t=r.start,void 0===(e=r.end)&&(e=t),"selectionStart"in n)n.selectionStart=t,n.selectionEnd=Math.min(e,n.value.length);else if((e=(t=n.ownerDocument||document)&&t.defaultView||window).getSelection){e=e.getSelection();var i=n.textContent.length,s=Math.min(r.start,i);r=void 0===r.end?s:Math.min(r.end,i),!e.extend&&s>r&&(i=r,r=s,s=i),i=ur(n,s);var o=ur(n,r);i&&o&&(1!==e.rangeCount||e.anchorNode!==i.node||e.anchorOffset!==i.offset||e.focusNode!==o.node||e.focusOffset!==o.offset)&&((t=t.createRange()).setStart(i.node,i.offset),e.removeAllRanges(),s>r?(e.addRange(t),e.extend(o.node,o.offset)):(t.setEnd(o.node,o.offset),e.addRange(t)))}for(t=[],e=n;e=e.parentNode;)1===e.nodeType&&t.push({element:e,left:e.scrollLeft,top:e.scrollTop});for("function"===typeof n.focus&&n.focus(),n=0;n<t.length;n++)(e=t[n]).element.scrollLeft=e.left,e.element.scrollTop=e.top}}var mr=u&&"documentMode"in document&&11>=document.documentMode,gr=null,vr=null,yr=null,br=!1;function Sr(e,t,n){var r=n.window===n?n.document:9===n.nodeType?n:n.ownerDocument;br||null==gr||gr!==J(r)||("selectionStart"in(r=gr)&&fr(r)?r={start:r.selectionStart,end:r.selectionEnd}:r={anchorNode:(r=(r.ownerDocument&&r.ownerDocument.defaultView||window).getSelection()).anchorNode,anchorOffset:r.anchorOffset,focusNode:r.focusNode,focusOffset:r.focusOffset},yr&&cr(yr,r)||(yr=r,0<(r=Gr(vr,"onSelect")).length&&(t=new un("onSelect","select",null,t,n),e.push({event:t,listeners:r}),t.target=gr)))}function wr(e,t){var n={};return n[e.toLowerCase()]=t.toLowerCase(),n["Webkit"+e]="webkit"+t,n["Moz"+e]="moz"+t,n}var Cr={animationend:wr("Animation","AnimationEnd"),animationiteration:wr("Animation","AnimationIteration"),animationstart:wr("Animation","AnimationStart"),transitionend:wr("Transition","TransitionEnd")},xr={},Er={};function Tr(e){if(xr[e])return xr[e];if(!Cr[e])return e;var t,n=Cr[e];for(t in n)if(n.hasOwnProperty(t)&&t in Er)return xr[e]=n[t];return e}u&&(Er=document.createElement("div").style,"AnimationEvent"in window||(delete Cr.animationend.animation,delete Cr.animationiteration.animation,delete Cr.animationstart.animation),"TransitionEvent"in window||delete Cr.transitionend.transition);var kr=Tr("animationend"),Nr=Tr("animationiteration"),Fr=Tr("animationstart"),Ir=Tr("transitionend"),Ar=new Map,Dr="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function Or(e,t){Ar.set(e,t),c(t,[e])}for(var Pr=0;Pr<Dr.length;Pr++){var Rr=Dr[Pr];Or(Rr.toLowerCase(),"on"+(Rr[0].toUpperCase()+Rr.slice(1)))}Or(kr,"onAnimationEnd"),Or(Nr,"onAnimationIteration"),Or(Fr,"onAnimationStart"),Or("dblclick","onDoubleClick"),Or("focusin","onFocus"),Or("focusout","onBlur"),Or(Ir,"onTransitionEnd"),l("onMouseEnter",["mouseout","mouseover"]),l("onMouseLeave",["mouseout","mouseover"]),l("onPointerEnter",["pointerout","pointerover"]),l("onPointerLeave",["pointerout","pointerover"]),c("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),c("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),c("onBeforeInput",["compositionend","keypress","textInput","paste"]),c("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),c("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),c("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Mr="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Br=new Set("cancel close invalid load scroll toggle".split(" ").concat(Mr));function Lr(e,t,n){var r=e.type||"unknown-event";e.currentTarget=n,function(e,t,n,r,i,o,a,c,l){if(ze.apply(this,arguments),Be){if(!Be)throw Error(s(198));var u=Le;Be=!1,Le=null,qe||(qe=!0,_e=u)}}(r,t,void 0,e),e.currentTarget=null}function qr(e,t){t=0!==(4&t);for(var n=0;n<e.length;n++){var r=e[n],i=r.event;r=r.listeners;e:{var s=void 0;if(t)for(var o=r.length-1;0<=o;o--){var a=r[o],c=a.instance,l=a.currentTarget;if(a=a.listener,c!==s&&i.isPropagationStopped())break e;Lr(i,a,l),s=c}else for(o=0;o<r.length;o++){if(c=(a=r[o]).instance,l=a.currentTarget,a=a.listener,c!==s&&i.isPropagationStopped())break e;Lr(i,a,l),s=c}}}if(qe)throw e=_e,qe=!1,_e=null,e}function _r(e,t){var n=t[mi];void 0===n&&(n=t[mi]=new Set);var r=e+"__bubble";n.has(r)||(Hr(t,e,2,!1),n.add(r))}function jr(e,t,n){var r=0;t&&(r|=4),Hr(n,e,r,t)}var zr="_reactListening"+Math.random().toString(36).slice(2);function Ur(e){if(!e[zr]){e[zr]=!0,o.forEach((function(t){"selectionchange"!==t&&(Br.has(t)||jr(t,!1,e),jr(t,!0,e))}));var t=9===e.nodeType?e:e.ownerDocument;null===t||t[zr]||(t[zr]=!0,jr("selectionchange",!1,t))}}function Hr(e,t,n,r){switch($t(t)){case 1:var i=Kt;break;case 4:i=Gt;break;default:i=Wt}n=i.bind(null,t,n,e),i=void 0,!Pe||"touchstart"!==t&&"touchmove"!==t&&"wheel"!==t||(i=!0),r?void 0!==i?e.addEventListener(t,n,{capture:!0,passive:i}):e.addEventListener(t,n,!0):void 0!==i?e.addEventListener(t,n,{passive:i}):e.addEventListener(t,n,!1)}function Vr(e,t,n,r,i){var s=r;if(0===(1&t)&&0===(2&t)&&null!==r)e:for(;;){if(null===r)return;var o=r.tag;if(3===o||4===o){var a=r.stateNode.containerInfo;if(a===i||8===a.nodeType&&a.parentNode===i)break;if(4===o)for(o=r.return;null!==o;){var c=o.tag;if((3===c||4===c)&&((c=o.stateNode.containerInfo)===i||8===c.nodeType&&c.parentNode===i))return;o=o.return}for(;null!==a;){if(null===(o=yi(a)))return;if(5===(c=o.tag)||6===c){r=s=o;continue e}a=a.parentNode}}r=r.return}De((function(){var r=s,i=we(n),o=[];e:{var a=Ar.get(e);if(void 0!==a){var c=un,l=e;switch(e){case"keypress":if(0===tn(n))break e;case"keydown":case"keyup":c=Nn;break;case"focusin":l="focus",c=gn;break;case"focusout":l="blur",c=gn;break;case"beforeblur":case"afterblur":c=gn;break;case"click":if(2===n.button)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":c=pn;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":c=mn;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":c=In;break;case kr:case Nr:case Fr:c=vn;break;case Ir:c=An;break;case"scroll":c=dn;break;case"wheel":c=On;break;case"copy":case"cut":case"paste":c=bn;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":c=Fn}var u=0!==(4&t),h=!u&&"scroll"===e,d=u?null!==a?a+"Capture":null:a;u=[];for(var f,p=r;null!==p;){var m=(f=p).stateNode;if(5===f.tag&&null!==m&&(f=m,null!==d&&(null!=(m=Oe(p,d))&&u.push(Kr(p,m,f)))),h)break;p=p.return}0<u.length&&(a=new c(a,l,null,n,i),o.push({event:a,listeners:u}))}}if(0===(7&t)){if(c="mouseout"===e||"pointerout"===e,(!(a="mouseover"===e||"pointerover"===e)||n===Se||!(l=n.relatedTarget||n.fromElement)||!yi(l)&&!l[pi])&&(c||a)&&(a=i.window===i?i:(a=i.ownerDocument)?a.defaultView||a.parentWindow:window,c?(c=r,null!==(l=(l=n.relatedTarget||n.toElement)?yi(l):null)&&(l!==(h=Ue(l))||5!==l.tag&&6!==l.tag)&&(l=null)):(c=null,l=r),c!==l)){if(u=pn,m="onMouseLeave",d="onMouseEnter",p="mouse","pointerout"!==e&&"pointerover"!==e||(u=Fn,m="onPointerLeave",d="onPointerEnter",p="pointer"),h=null==c?a:Si(c),f=null==l?a:Si(l),(a=new u(m,p+"leave",c,n,i)).target=h,a.relatedTarget=f,m=null,yi(i)===r&&((u=new u(d,p+"enter",l,n,i)).target=f,u.relatedTarget=h,m=u),h=m,c&&l)e:{for(d=l,p=0,f=u=c;f;f=Wr(f))p++;for(f=0,m=d;m;m=Wr(m))f++;for(;0<p-f;)u=Wr(u),p--;for(;0<f-p;)d=Wr(d),f--;for(;p--;){if(u===d||null!==d&&u===d.alternate)break e;u=Wr(u),d=Wr(d)}u=null}else u=null;null!==c&&Jr(o,a,c,u,!1),null!==l&&null!==h&&Jr(o,h,l,u,!0)}if("select"===(c=(a=r?Si(r):window).nodeName&&a.nodeName.toLowerCase())||"input"===c&&"file"===a.type)var g=$n;else if(Vn(a))if(Qn)g=or;else{g=ir;var v=rr}else(c=a.nodeName)&&"input"===c.toLowerCase()&&("checkbox"===a.type||"radio"===a.type)&&(g=sr);switch(g&&(g=g(e,r))?Kn(o,g,n,i):(v&&v(e,a,r),"focusout"===e&&(v=a._wrapperState)&&v.controlled&&"number"===a.type&&ee(a,"number",a.value)),v=r?Si(r):window,e){case"focusin":(Vn(v)||"true"===v.contentEditable)&&(gr=v,vr=r,yr=null);break;case"focusout":yr=vr=gr=null;break;case"mousedown":br=!0;break;case"contextmenu":case"mouseup":case"dragend":br=!1,Sr(o,n,i);break;case"selectionchange":if(mr)break;case"keydown":case"keyup":Sr(o,n,i)}var y;if(Rn)e:{switch(e){case"compositionstart":var b="onCompositionStart";break e;case"compositionend":b="onCompositionEnd";break e;case"compositionupdate":b="onCompositionUpdate";break e}b=void 0}else Un?jn(e,n)&&(b="onCompositionEnd"):"keydown"===e&&229===n.keyCode&&(b="onCompositionStart");b&&(Ln&&"ko"!==n.locale&&(Un||"onCompositionStart"!==b?"onCompositionEnd"===b&&Un&&(y=en()):(Xt="value"in(Qt=i)?Qt.value:Qt.textContent,Un=!0)),0<(v=Gr(r,b)).length&&(b=new Sn(b,e,null,n,i),o.push({event:b,listeners:v}),y?b.data=y:null!==(y=zn(n))&&(b.data=y))),(y=Bn?function(e,t){switch(e){case"compositionend":return zn(t);case"keypress":return 32!==t.which?null:(_n=!0,qn);case"textInput":return(e=t.data)===qn&&_n?null:e;default:return null}}(e,n):function(e,t){if(Un)return"compositionend"===e||!Rn&&jn(e,t)?(e=en(),Yt=Xt=Qt=null,Un=!1,e):null;switch(e){case"paste":default:return null;case"keypress":if(!(t.ctrlKey||t.altKey||t.metaKey)||t.ctrlKey&&t.altKey){if(t.char&&1<t.char.length)return t.char;if(t.which)return String.fromCharCode(t.which)}return null;case"compositionend":return Ln&&"ko"!==t.locale?null:t.data}}(e,n))&&(0<(r=Gr(r,"onBeforeInput")).length&&(i=new Sn("onBeforeInput","beforeinput",null,n,i),o.push({event:i,listeners:r}),i.data=y))}qr(o,t)}))}function Kr(e,t,n){return{instance:e,listener:t,currentTarget:n}}function Gr(e,t){for(var n=t+"Capture",r=[];null!==e;){var i=e,s=i.stateNode;5===i.tag&&null!==s&&(i=s,null!=(s=Oe(e,n))&&r.unshift(Kr(e,s,i)),null!=(s=Oe(e,t))&&r.push(Kr(e,s,i))),e=e.return}return r}function Wr(e){if(null===e)return null;do{e=e.return}while(e&&5!==e.tag);return e||null}function Jr(e,t,n,r,i){for(var s=t._reactName,o=[];null!==n&&n!==r;){var a=n,c=a.alternate,l=a.stateNode;if(null!==c&&c===r)break;5===a.tag&&null!==l&&(a=l,i?null!=(c=Oe(n,s))&&o.unshift(Kr(n,c,a)):i||null!=(c=Oe(n,s))&&o.push(Kr(n,c,a))),n=n.return}0!==o.length&&e.push({event:t,listeners:o})}var Zr=/\r\n?/g,$r=/\u0000|\uFFFD/g;function Qr(e){return("string"===typeof e?e:""+e).replace(Zr,"\n").replace($r,"")}function Xr(e,t,n){if(t=Qr(t),Qr(e)!==t&&n)throw Error(s(425))}function Yr(){}var ei=null,ti=null;function ni(e,t){return"textarea"===e||"noscript"===e||"string"===typeof t.children||"number"===typeof t.children||"object"===typeof t.dangerouslySetInnerHTML&&null!==t.dangerouslySetInnerHTML&&null!=t.dangerouslySetInnerHTML.__html}var ri="function"===typeof setTimeout?setTimeout:void 0,ii="function"===typeof clearTimeout?clearTimeout:void 0,si="function"===typeof Promise?Promise:void 0,oi="function"===typeof queueMicrotask?queueMicrotask:"undefined"!==typeof si?function(e){return si.resolve(null).then(e).catch(ai)}:ri;function ai(e){setTimeout((function(){throw e}))}function ci(e,t){var n=t,r=0;do{var i=n.nextSibling;if(e.removeChild(n),i&&8===i.nodeType)if("/$"===(n=i.data)){if(0===r)return e.removeChild(i),void Ut(t);r--}else"$"!==n&&"$?"!==n&&"$!"!==n||r++;n=i}while(n);Ut(t)}function li(e){for(;null!=e;e=e.nextSibling){var t=e.nodeType;if(1===t||3===t)break;if(8===t){if("$"===(t=e.data)||"$!"===t||"$?"===t)break;if("/$"===t)return null}}return e}function ui(e){e=e.previousSibling;for(var t=0;e;){if(8===e.nodeType){var n=e.data;if("$"===n||"$!"===n||"$?"===n){if(0===t)return e;t--}else"/$"===n&&t++}e=e.previousSibling}return null}var hi=Math.random().toString(36).slice(2),di="__reactFiber$"+hi,fi="__reactProps$"+hi,pi="__reactContainer$"+hi,mi="__reactEvents$"+hi,gi="__reactListeners$"+hi,vi="__reactHandles$"+hi;function yi(e){var t=e[di];if(t)return t;for(var n=e.parentNode;n;){if(t=n[pi]||n[di]){if(n=t.alternate,null!==t.child||null!==n&&null!==n.child)for(e=ui(e);null!==e;){if(n=e[di])return n;e=ui(e)}return t}n=(e=n).parentNode}return null}function bi(e){return!(e=e[di]||e[pi])||5!==e.tag&&6!==e.tag&&13!==e.tag&&3!==e.tag?null:e}function Si(e){if(5===e.tag||6===e.tag)return e.stateNode;throw Error(s(33))}function wi(e){return e[fi]||null}var Ci=[],xi=-1;function Ei(e){return{current:e}}function Ti(e){0>xi||(e.current=Ci[xi],Ci[xi]=null,xi--)}function ki(e,t){xi++,Ci[xi]=e.current,e.current=t}var Ni={},Fi=Ei(Ni),Ii=Ei(!1),Ai=Ni;function Di(e,t){var n=e.type.contextTypes;if(!n)return Ni;var r=e.stateNode;if(r&&r.__reactInternalMemoizedUnmaskedChildContext===t)return r.__reactInternalMemoizedMaskedChildContext;var i,s={};for(i in n)s[i]=t[i];return r&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=t,e.__reactInternalMemoizedMaskedChildContext=s),s}function Oi(e){return null!==(e=e.childContextTypes)&&void 0!==e}function Pi(){Ti(Ii),Ti(Fi)}function Ri(e,t,n){if(Fi.current!==Ni)throw Error(s(168));ki(Fi,t),ki(Ii,n)}function Mi(e,t,n){var r=e.stateNode;if(t=t.childContextTypes,"function"!==typeof r.getChildContext)return n;for(var i in r=r.getChildContext())if(!(i in t))throw Error(s(108,H(e)||"Unknown",i));return L({},n,r)}function Bi(e){return e=(e=e.stateNode)&&e.__reactInternalMemoizedMergedChildContext||Ni,Ai=Fi.current,ki(Fi,e),ki(Ii,Ii.current),!0}function Li(e,t,n){var r=e.stateNode;if(!r)throw Error(s(169));n?(e=Mi(e,t,Ai),r.__reactInternalMemoizedMergedChildContext=e,Ti(Ii),Ti(Fi),ki(Fi,e)):Ti(Ii),ki(Ii,n)}var qi=null,_i=!1,ji=!1;function zi(e){null===qi?qi=[e]:qi.push(e)}function Ui(){if(!ji&&null!==qi){ji=!0;var e=0,t=bt;try{var n=qi;for(bt=1;e<n.length;e++){var r=n[e];do{r=r(!0)}while(null!==r)}qi=null,_i=!1}catch(i){throw null!==qi&&(qi=qi.slice(e+1)),We(Ye,Ui),i}finally{bt=t,ji=!1}}return null}var Hi=[],Vi=0,Ki=null,Gi=0,Wi=[],Ji=0,Zi=null,$i=1,Qi="";function Xi(e,t){Hi[Vi++]=Gi,Hi[Vi++]=Ki,Ki=e,Gi=t}function Yi(e,t,n){Wi[Ji++]=$i,Wi[Ji++]=Qi,Wi[Ji++]=Zi,Zi=e;var r=$i;e=Qi;var i=32-ot(r)-1;r&=~(1<<i),n+=1;var s=32-ot(t)+i;if(30<s){var o=i-i%5;s=(r&(1<<o)-1).toString(32),r>>=o,i-=o,$i=1<<32-ot(t)+i|n<<i|r,Qi=s+e}else $i=1<<s|n<<i|r,Qi=e}function es(e){null!==e.return&&(Xi(e,1),Yi(e,1,0))}function ts(e){for(;e===Ki;)Ki=Hi[--Vi],Hi[Vi]=null,Gi=Hi[--Vi],Hi[Vi]=null;for(;e===Zi;)Zi=Wi[--Ji],Wi[Ji]=null,Qi=Wi[--Ji],Wi[Ji]=null,$i=Wi[--Ji],Wi[Ji]=null}var ns=null,rs=null,is=!1,ss=null;function os(e,t){var n=Ol(5,null,null,0);n.elementType="DELETED",n.stateNode=t,n.return=e,null===(t=e.deletions)?(e.deletions=[n],e.flags|=16):t.push(n)}function as(e,t){switch(e.tag){case 5:var n=e.type;return null!==(t=1!==t.nodeType||n.toLowerCase()!==t.nodeName.toLowerCase()?null:t)&&(e.stateNode=t,ns=e,rs=li(t.firstChild),!0);case 6:return null!==(t=""===e.pendingProps||3!==t.nodeType?null:t)&&(e.stateNode=t,ns=e,rs=null,!0);case 13:return null!==(t=8!==t.nodeType?null:t)&&(n=null!==Zi?{id:$i,overflow:Qi}:null,e.memoizedState={dehydrated:t,treeContext:n,retryLane:1073741824},(n=Ol(18,null,null,0)).stateNode=t,n.return=e,e.child=n,ns=e,rs=null,!0);default:return!1}}function cs(e){return 0!==(1&e.mode)&&0===(128&e.flags)}function ls(e){if(is){var t=rs;if(t){var n=t;if(!as(e,t)){if(cs(e))throw Error(s(418));t=li(n.nextSibling);var r=ns;t&&as(e,t)?os(r,n):(e.flags=-4097&e.flags|2,is=!1,ns=e)}}else{if(cs(e))throw Error(s(418));e.flags=-4097&e.flags|2,is=!1,ns=e}}}function us(e){for(e=e.return;null!==e&&5!==e.tag&&3!==e.tag&&13!==e.tag;)e=e.return;ns=e}function hs(e){if(e!==ns)return!1;if(!is)return us(e),is=!0,!1;var t;if((t=3!==e.tag)&&!(t=5!==e.tag)&&(t="head"!==(t=e.type)&&"body"!==t&&!ni(e.type,e.memoizedProps)),t&&(t=rs)){if(cs(e))throw ds(),Error(s(418));for(;t;)os(e,t),t=li(t.nextSibling)}if(us(e),13===e.tag){if(!(e=null!==(e=e.memoizedState)?e.dehydrated:null))throw Error(s(317));e:{for(e=e.nextSibling,t=0;e;){if(8===e.nodeType){var n=e.data;if("/$"===n){if(0===t){rs=li(e.nextSibling);break e}t--}else"$"!==n&&"$!"!==n&&"$?"!==n||t++}e=e.nextSibling}rs=null}}else rs=ns?li(e.stateNode.nextSibling):null;return!0}function ds(){for(var e=rs;e;)e=li(e.nextSibling)}function fs(){rs=ns=null,is=!1}function ps(e){null===ss?ss=[e]:ss.push(e)}var ms=S.ReactCurrentBatchConfig;function gs(e,t){if(e&&e.defaultProps){for(var n in t=L({},t),e=e.defaultProps)void 0===t[n]&&(t[n]=e[n]);return t}return t}var vs=Ei(null),ys=null,bs=null,Ss=null;function ws(){Ss=bs=ys=null}function Cs(e){var t=vs.current;Ti(vs),e._currentValue=t}function xs(e,t,n){for(;null!==e;){var r=e.alternate;if((e.childLanes&t)!==t?(e.childLanes|=t,null!==r&&(r.childLanes|=t)):null!==r&&(r.childLanes&t)!==t&&(r.childLanes|=t),e===n)break;e=e.return}}function Es(e,t){ys=e,Ss=bs=null,null!==(e=e.dependencies)&&null!==e.firstContext&&(0!==(e.lanes&t)&&(Sa=!0),e.firstContext=null)}function Ts(e){var t=e._currentValue;if(Ss!==e)if(e={context:e,memoizedValue:t,next:null},null===bs){if(null===ys)throw Error(s(308));bs=e,ys.dependencies={lanes:0,firstContext:e}}else bs=bs.next=e;return t}var ks=null;function Ns(e){null===ks?ks=[e]:ks.push(e)}function Fs(e,t,n,r){var i=t.interleaved;return null===i?(n.next=n,Ns(t)):(n.next=i.next,i.next=n),t.interleaved=n,Is(e,r)}function Is(e,t){e.lanes|=t;var n=e.alternate;for(null!==n&&(n.lanes|=t),n=e,e=e.return;null!==e;)e.childLanes|=t,null!==(n=e.alternate)&&(n.childLanes|=t),n=e,e=e.return;return 3===n.tag?n.stateNode:null}var As=!1;function Ds(e){e.updateQueue={baseState:e.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function Os(e,t){e=e.updateQueue,t.updateQueue===e&&(t.updateQueue={baseState:e.baseState,firstBaseUpdate:e.firstBaseUpdate,lastBaseUpdate:e.lastBaseUpdate,shared:e.shared,effects:e.effects})}function Ps(e,t){return{eventTime:e,lane:t,tag:0,payload:null,callback:null,next:null}}function Rs(e,t,n){var r=e.updateQueue;if(null===r)return null;if(r=r.shared,0!==(2&Ic)){var i=r.pending;return null===i?t.next=t:(t.next=i.next,i.next=t),r.pending=t,Is(e,n)}return null===(i=r.interleaved)?(t.next=t,Ns(r)):(t.next=i.next,i.next=t),r.interleaved=t,Is(e,n)}function Ms(e,t,n){if(null!==(t=t.updateQueue)&&(t=t.shared,0!==(4194240&n))){var r=t.lanes;n|=r&=e.pendingLanes,t.lanes=n,yt(e,n)}}function Bs(e,t){var n=e.updateQueue,r=e.alternate;if(null!==r&&n===(r=r.updateQueue)){var i=null,s=null;if(null!==(n=n.firstBaseUpdate)){do{var o={eventTime:n.eventTime,lane:n.lane,tag:n.tag,payload:n.payload,callback:n.callback,next:null};null===s?i=s=o:s=s.next=o,n=n.next}while(null!==n);null===s?i=s=t:s=s.next=t}else i=s=t;return n={baseState:r.baseState,firstBaseUpdate:i,lastBaseUpdate:s,shared:r.shared,effects:r.effects},void(e.updateQueue=n)}null===(e=n.lastBaseUpdate)?n.firstBaseUpdate=t:e.next=t,n.lastBaseUpdate=t}function Ls(e,t,n,r){var i=e.updateQueue;As=!1;var s=i.firstBaseUpdate,o=i.lastBaseUpdate,a=i.shared.pending;if(null!==a){i.shared.pending=null;var c=a,l=c.next;c.next=null,null===o?s=l:o.next=l,o=c;var u=e.alternate;null!==u&&((a=(u=u.updateQueue).lastBaseUpdate)!==o&&(null===a?u.firstBaseUpdate=l:a.next=l,u.lastBaseUpdate=c))}if(null!==s){var h=i.baseState;for(o=0,u=l=c=null,a=s;;){var d=a.lane,f=a.eventTime;if((r&d)===d){null!==u&&(u=u.next={eventTime:f,lane:0,tag:a.tag,payload:a.payload,callback:a.callback,next:null});e:{var p=e,m=a;switch(d=t,f=n,m.tag){case 1:if("function"===typeof(p=m.payload)){h=p.call(f,h,d);break e}h=p;break e;case 3:p.flags=-65537&p.flags|128;case 0:if(null===(d="function"===typeof(p=m.payload)?p.call(f,h,d):p)||void 0===d)break e;h=L({},h,d);break e;case 2:As=!0}}null!==a.callback&&0!==a.lane&&(e.flags|=64,null===(d=i.effects)?i.effects=[a]:d.push(a))}else f={eventTime:f,lane:d,tag:a.tag,payload:a.payload,callback:a.callback,next:null},null===u?(l=u=f,c=h):u=u.next=f,o|=d;if(null===(a=a.next)){if(null===(a=i.shared.pending))break;a=(d=a).next,d.next=null,i.lastBaseUpdate=d,i.shared.pending=null}}if(null===u&&(c=h),i.baseState=c,i.firstBaseUpdate=l,i.lastBaseUpdate=u,null!==(t=i.shared.interleaved)){i=t;do{o|=i.lane,i=i.next}while(i!==t)}else null===s&&(i.shared.lanes=0);Lc|=o,e.lanes=o,e.memoizedState=h}}function qs(e,t,n){if(e=t.effects,t.effects=null,null!==e)for(t=0;t<e.length;t++){var r=e[t],i=r.callback;if(null!==i){if(r.callback=null,r=n,"function"!==typeof i)throw Error(s(191,i));i.call(r)}}}var _s=(new r.Component).refs;function js(e,t,n,r){n=null===(n=n(r,t=e.memoizedState))||void 0===n?t:L({},t,n),e.memoizedState=n,0===e.lanes&&(e.updateQueue.baseState=n)}var zs={isMounted:function(e){return!!(e=e._reactInternals)&&Ue(e)===e},enqueueSetState:function(e,t,n){e=e._reactInternals;var r=tl(),i=nl(e),s=Ps(r,i);s.payload=t,void 0!==n&&null!==n&&(s.callback=n),null!==(t=Rs(e,s,i))&&(rl(t,e,i,r),Ms(t,e,i))},enqueueReplaceState:function(e,t,n){e=e._reactInternals;var r=tl(),i=nl(e),s=Ps(r,i);s.tag=1,s.payload=t,void 0!==n&&null!==n&&(s.callback=n),null!==(t=Rs(e,s,i))&&(rl(t,e,i,r),Ms(t,e,i))},enqueueForceUpdate:function(e,t){e=e._reactInternals;var n=tl(),r=nl(e),i=Ps(n,r);i.tag=2,void 0!==t&&null!==t&&(i.callback=t),null!==(t=Rs(e,i,r))&&(rl(t,e,r,n),Ms(t,e,r))}};function Us(e,t,n,r,i,s,o){return"function"===typeof(e=e.stateNode).shouldComponentUpdate?e.shouldComponentUpdate(r,s,o):!t.prototype||!t.prototype.isPureReactComponent||(!cr(n,r)||!cr(i,s))}function Hs(e,t,n){var r=!1,i=Ni,s=t.contextType;return"object"===typeof s&&null!==s?s=Ts(s):(i=Oi(t)?Ai:Fi.current,s=(r=null!==(r=t.contextTypes)&&void 0!==r)?Di(e,i):Ni),t=new t(n,s),e.memoizedState=null!==t.state&&void 0!==t.state?t.state:null,t.updater=zs,e.stateNode=t,t._reactInternals=e,r&&((e=e.stateNode).__reactInternalMemoizedUnmaskedChildContext=i,e.__reactInternalMemoizedMaskedChildContext=s),t}function Vs(e,t,n,r){e=t.state,"function"===typeof t.componentWillReceiveProps&&t.componentWillReceiveProps(n,r),"function"===typeof t.UNSAFE_componentWillReceiveProps&&t.UNSAFE_componentWillReceiveProps(n,r),t.state!==e&&zs.enqueueReplaceState(t,t.state,null)}function Ks(e,t,n,r){var i=e.stateNode;i.props=n,i.state=e.memoizedState,i.refs=_s,Ds(e);var s=t.contextType;"object"===typeof s&&null!==s?i.context=Ts(s):(s=Oi(t)?Ai:Fi.current,i.context=Di(e,s)),i.state=e.memoizedState,"function"===typeof(s=t.getDerivedStateFromProps)&&(js(e,t,s,n),i.state=e.memoizedState),"function"===typeof t.getDerivedStateFromProps||"function"===typeof i.getSnapshotBeforeUpdate||"function"!==typeof i.UNSAFE_componentWillMount&&"function"!==typeof i.componentWillMount||(t=i.state,"function"===typeof i.componentWillMount&&i.componentWillMount(),"function"===typeof i.UNSAFE_componentWillMount&&i.UNSAFE_componentWillMount(),t!==i.state&&zs.enqueueReplaceState(i,i.state,null),Ls(e,n,i,r),i.state=e.memoizedState),"function"===typeof i.componentDidMount&&(e.flags|=4194308)}function Gs(e,t,n){if(null!==(e=n.ref)&&"function"!==typeof e&&"object"!==typeof e){if(n._owner){if(n=n._owner){if(1!==n.tag)throw Error(s(309));var r=n.stateNode}if(!r)throw Error(s(147,e));var i=r,o=""+e;return null!==t&&null!==t.ref&&"function"===typeof t.ref&&t.ref._stringRef===o?t.ref:(t=function(e){var t=i.refs;t===_s&&(t=i.refs={}),null===e?delete t[o]:t[o]=e},t._stringRef=o,t)}if("string"!==typeof e)throw Error(s(284));if(!n._owner)throw Error(s(290,e))}return e}function Ws(e,t){throw e=Object.prototype.toString.call(t),Error(s(31,"[object Object]"===e?"object with keys {"+Object.keys(t).join(", ")+"}":e))}function Js(e){return(0,e._init)(e._payload)}function Zs(e){function t(t,n){if(e){var r=t.deletions;null===r?(t.deletions=[n],t.flags|=16):r.push(n)}}function n(n,r){if(!e)return null;for(;null!==r;)t(n,r),r=r.sibling;return null}function r(e,t){for(e=new Map;null!==t;)null!==t.key?e.set(t.key,t):e.set(t.index,t),t=t.sibling;return e}function i(e,t){return(e=Rl(e,t)).index=0,e.sibling=null,e}function o(t,n,r){return t.index=r,e?null!==(r=t.alternate)?(r=r.index)<n?(t.flags|=2,n):r:(t.flags|=2,n):(t.flags|=1048576,n)}function a(t){return e&&null===t.alternate&&(t.flags|=2),t}function c(e,t,n,r){return null===t||6!==t.tag?((t=ql(n,e.mode,r)).return=e,t):((t=i(t,n)).return=e,t)}function l(e,t,n,r){var s=n.type;return s===x?h(e,t,n.props.children,r,n.key):null!==t&&(t.elementType===s||"object"===typeof s&&null!==s&&s.$$typeof===O&&Js(s)===t.type)?((r=i(t,n.props)).ref=Gs(e,t,n),r.return=e,r):((r=Ml(n.type,n.key,n.props,null,e.mode,r)).ref=Gs(e,t,n),r.return=e,r)}function u(e,t,n,r){return null===t||4!==t.tag||t.stateNode.containerInfo!==n.containerInfo||t.stateNode.implementation!==n.implementation?((t=_l(n,e.mode,r)).return=e,t):((t=i(t,n.children||[])).return=e,t)}function h(e,t,n,r,s){return null===t||7!==t.tag?((t=Bl(n,e.mode,r,s)).return=e,t):((t=i(t,n)).return=e,t)}function d(e,t,n){if("string"===typeof t&&""!==t||"number"===typeof t)return(t=ql(""+t,e.mode,n)).return=e,t;if("object"===typeof t&&null!==t){switch(t.$$typeof){case w:return(n=Ml(t.type,t.key,t.props,null,e.mode,n)).ref=Gs(e,null,t),n.return=e,n;case C:return(t=_l(t,e.mode,n)).return=e,t;case O:return d(e,(0,t._init)(t._payload),n)}if(te(t)||M(t))return(t=Bl(t,e.mode,n,null)).return=e,t;Ws(e,t)}return null}function f(e,t,n,r){var i=null!==t?t.key:null;if("string"===typeof n&&""!==n||"number"===typeof n)return null!==i?null:c(e,t,""+n,r);if("object"===typeof n&&null!==n){switch(n.$$typeof){case w:return n.key===i?l(e,t,n,r):null;case C:return n.key===i?u(e,t,n,r):null;case O:return f(e,t,(i=n._init)(n._payload),r)}if(te(n)||M(n))return null!==i?null:h(e,t,n,r,null);Ws(e,n)}return null}function p(e,t,n,r,i){if("string"===typeof r&&""!==r||"number"===typeof r)return c(t,e=e.get(n)||null,""+r,i);if("object"===typeof r&&null!==r){switch(r.$$typeof){case w:return l(t,e=e.get(null===r.key?n:r.key)||null,r,i);case C:return u(t,e=e.get(null===r.key?n:r.key)||null,r,i);case O:return p(e,t,n,(0,r._init)(r._payload),i)}if(te(r)||M(r))return h(t,e=e.get(n)||null,r,i,null);Ws(t,r)}return null}function m(i,s,a,c){for(var l=null,u=null,h=s,m=s=0,g=null;null!==h&&m<a.length;m++){h.index>m?(g=h,h=null):g=h.sibling;var v=f(i,h,a[m],c);if(null===v){null===h&&(h=g);break}e&&h&&null===v.alternate&&t(i,h),s=o(v,s,m),null===u?l=v:u.sibling=v,u=v,h=g}if(m===a.length)return n(i,h),is&&Xi(i,m),l;if(null===h){for(;m<a.length;m++)null!==(h=d(i,a[m],c))&&(s=o(h,s,m),null===u?l=h:u.sibling=h,u=h);return is&&Xi(i,m),l}for(h=r(i,h);m<a.length;m++)null!==(g=p(h,i,m,a[m],c))&&(e&&null!==g.alternate&&h.delete(null===g.key?m:g.key),s=o(g,s,m),null===u?l=g:u.sibling=g,u=g);return e&&h.forEach((function(e){return t(i,e)})),is&&Xi(i,m),l}function g(i,a,c,l){var u=M(c);if("function"!==typeof u)throw Error(s(150));if(null==(c=u.call(c)))throw Error(s(151));for(var h=u=null,m=a,g=a=0,v=null,y=c.next();null!==m&&!y.done;g++,y=c.next()){m.index>g?(v=m,m=null):v=m.sibling;var b=f(i,m,y.value,l);if(null===b){null===m&&(m=v);break}e&&m&&null===b.alternate&&t(i,m),a=o(b,a,g),null===h?u=b:h.sibling=b,h=b,m=v}if(y.done)return n(i,m),is&&Xi(i,g),u;if(null===m){for(;!y.done;g++,y=c.next())null!==(y=d(i,y.value,l))&&(a=o(y,a,g),null===h?u=y:h.sibling=y,h=y);return is&&Xi(i,g),u}for(m=r(i,m);!y.done;g++,y=c.next())null!==(y=p(m,i,g,y.value,l))&&(e&&null!==y.alternate&&m.delete(null===y.key?g:y.key),a=o(y,a,g),null===h?u=y:h.sibling=y,h=y);return e&&m.forEach((function(e){return t(i,e)})),is&&Xi(i,g),u}return function e(r,s,o,c){if("object"===typeof o&&null!==o&&o.type===x&&null===o.key&&(o=o.props.children),"object"===typeof o&&null!==o){switch(o.$$typeof){case w:e:{for(var l=o.key,u=s;null!==u;){if(u.key===l){if((l=o.type)===x){if(7===u.tag){n(r,u.sibling),(s=i(u,o.props.children)).return=r,r=s;break e}}else if(u.elementType===l||"object"===typeof l&&null!==l&&l.$$typeof===O&&Js(l)===u.type){n(r,u.sibling),(s=i(u,o.props)).ref=Gs(r,u,o),s.return=r,r=s;break e}n(r,u);break}t(r,u),u=u.sibling}o.type===x?((s=Bl(o.props.children,r.mode,c,o.key)).return=r,r=s):((c=Ml(o.type,o.key,o.props,null,r.mode,c)).ref=Gs(r,s,o),c.return=r,r=c)}return a(r);case C:e:{for(u=o.key;null!==s;){if(s.key===u){if(4===s.tag&&s.stateNode.containerInfo===o.containerInfo&&s.stateNode.implementation===o.implementation){n(r,s.sibling),(s=i(s,o.children||[])).return=r,r=s;break e}n(r,s);break}t(r,s),s=s.sibling}(s=_l(o,r.mode,c)).return=r,r=s}return a(r);case O:return e(r,s,(u=o._init)(o._payload),c)}if(te(o))return m(r,s,o,c);if(M(o))return g(r,s,o,c);Ws(r,o)}return"string"===typeof o&&""!==o||"number"===typeof o?(o=""+o,null!==s&&6===s.tag?(n(r,s.sibling),(s=i(s,o)).return=r,r=s):(n(r,s),(s=ql(o,r.mode,c)).return=r,r=s),a(r)):n(r,s)}}var $s=Zs(!0),Qs=Zs(!1),Xs={},Ys=Ei(Xs),eo=Ei(Xs),to=Ei(Xs);function no(e){if(e===Xs)throw Error(s(174));return e}function ro(e,t){switch(ki(to,t),ki(eo,e),ki(Ys,Xs),e=t.nodeType){case 9:case 11:t=(t=t.documentElement)?t.namespaceURI:ce(null,"");break;default:t=ce(t=(e=8===e?t.parentNode:t).namespaceURI||null,e=e.tagName)}Ti(Ys),ki(Ys,t)}function io(){Ti(Ys),Ti(eo),Ti(to)}function so(e){no(to.current);var t=no(Ys.current),n=ce(t,e.type);t!==n&&(ki(eo,e),ki(Ys,n))}function oo(e){eo.current===e&&(Ti(Ys),Ti(eo))}var ao=Ei(0);function co(e){for(var t=e;null!==t;){if(13===t.tag){var n=t.memoizedState;if(null!==n&&(null===(n=n.dehydrated)||"$?"===n.data||"$!"===n.data))return t}else if(19===t.tag&&void 0!==t.memoizedProps.revealOrder){if(0!==(128&t.flags))return t}else if(null!==t.child){t.child.return=t,t=t.child;continue}if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return null;t=t.return}t.sibling.return=t.return,t=t.sibling}return null}var lo=[];function uo(){for(var e=0;e<lo.length;e++)lo[e]._workInProgressVersionPrimary=null;lo.length=0}var ho=S.ReactCurrentDispatcher,fo=S.ReactCurrentBatchConfig,po=0,mo=null,go=null,vo=null,yo=!1,bo=!1,So=0,wo=0;function Co(){throw Error(s(321))}function xo(e,t){if(null===t)return!1;for(var n=0;n<t.length&&n<e.length;n++)if(!ar(e[n],t[n]))return!1;return!0}function Eo(e,t,n,r,i,o){if(po=o,mo=t,t.memoizedState=null,t.updateQueue=null,t.lanes=0,ho.current=null===e||null===e.memoizedState?aa:ca,e=n(r,i),bo){o=0;do{if(bo=!1,So=0,25<=o)throw Error(s(301));o+=1,vo=go=null,t.updateQueue=null,ho.current=la,e=n(r,i)}while(bo)}if(ho.current=oa,t=null!==go&&null!==go.next,po=0,vo=go=mo=null,yo=!1,t)throw Error(s(300));return e}function To(){var e=0!==So;return So=0,e}function ko(){var e={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return null===vo?mo.memoizedState=vo=e:vo=vo.next=e,vo}function No(){if(null===go){var e=mo.alternate;e=null!==e?e.memoizedState:null}else e=go.next;var t=null===vo?mo.memoizedState:vo.next;if(null!==t)vo=t,go=e;else{if(null===e)throw Error(s(310));e={memoizedState:(go=e).memoizedState,baseState:go.baseState,baseQueue:go.baseQueue,queue:go.queue,next:null},null===vo?mo.memoizedState=vo=e:vo=vo.next=e}return vo}function Fo(e,t){return"function"===typeof t?t(e):t}function Io(e){var t=No(),n=t.queue;if(null===n)throw Error(s(311));n.lastRenderedReducer=e;var r=go,i=r.baseQueue,o=n.pending;if(null!==o){if(null!==i){var a=i.next;i.next=o.next,o.next=a}r.baseQueue=i=o,n.pending=null}if(null!==i){o=i.next,r=r.baseState;var c=a=null,l=null,u=o;do{var h=u.lane;if((po&h)===h)null!==l&&(l=l.next={lane:0,action:u.action,hasEagerState:u.hasEagerState,eagerState:u.eagerState,next:null}),r=u.hasEagerState?u.eagerState:e(r,u.action);else{var d={lane:h,action:u.action,hasEagerState:u.hasEagerState,eagerState:u.eagerState,next:null};null===l?(c=l=d,a=r):l=l.next=d,mo.lanes|=h,Lc|=h}u=u.next}while(null!==u&&u!==o);null===l?a=r:l.next=c,ar(r,t.memoizedState)||(Sa=!0),t.memoizedState=r,t.baseState=a,t.baseQueue=l,n.lastRenderedState=r}if(null!==(e=n.interleaved)){i=e;do{o=i.lane,mo.lanes|=o,Lc|=o,i=i.next}while(i!==e)}else null===i&&(n.lanes=0);return[t.memoizedState,n.dispatch]}function Ao(e){var t=No(),n=t.queue;if(null===n)throw Error(s(311));n.lastRenderedReducer=e;var r=n.dispatch,i=n.pending,o=t.memoizedState;if(null!==i){n.pending=null;var a=i=i.next;do{o=e(o,a.action),a=a.next}while(a!==i);ar(o,t.memoizedState)||(Sa=!0),t.memoizedState=o,null===t.baseQueue&&(t.baseState=o),n.lastRenderedState=o}return[o,r]}function Do(){}function Oo(e,t){var n=mo,r=No(),i=t(),o=!ar(r.memoizedState,i);if(o&&(r.memoizedState=i,Sa=!0),r=r.queue,Vo(Mo.bind(null,n,r,e),[e]),r.getSnapshot!==t||o||null!==vo&&1&vo.memoizedState.tag){if(n.flags|=2048,_o(9,Ro.bind(null,n,r,i,t),void 0,null),null===Ac)throw Error(s(349));0!==(30&po)||Po(n,t,i)}return i}function Po(e,t,n){e.flags|=16384,e={getSnapshot:t,value:n},null===(t=mo.updateQueue)?(t={lastEffect:null,stores:null},mo.updateQueue=t,t.stores=[e]):null===(n=t.stores)?t.stores=[e]:n.push(e)}function Ro(e,t,n,r){t.value=n,t.getSnapshot=r,Bo(t)&&Lo(e)}function Mo(e,t,n){return n((function(){Bo(t)&&Lo(e)}))}function Bo(e){var t=e.getSnapshot;e=e.value;try{var n=t();return!ar(e,n)}catch(r){return!0}}function Lo(e){var t=Is(e,1);null!==t&&rl(t,e,1,-1)}function qo(e){var t=ko();return"function"===typeof e&&(e=e()),t.memoizedState=t.baseState=e,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:Fo,lastRenderedState:e},t.queue=e,e=e.dispatch=na.bind(null,mo,e),[t.memoizedState,e]}function _o(e,t,n,r){return e={tag:e,create:t,destroy:n,deps:r,next:null},null===(t=mo.updateQueue)?(t={lastEffect:null,stores:null},mo.updateQueue=t,t.lastEffect=e.next=e):null===(n=t.lastEffect)?t.lastEffect=e.next=e:(r=n.next,n.next=e,e.next=r,t.lastEffect=e),e}function jo(){return No().memoizedState}function zo(e,t,n,r){var i=ko();mo.flags|=e,i.memoizedState=_o(1|t,n,void 0,void 0===r?null:r)}function Uo(e,t,n,r){var i=No();r=void 0===r?null:r;var s=void 0;if(null!==go){var o=go.memoizedState;if(s=o.destroy,null!==r&&xo(r,o.deps))return void(i.memoizedState=_o(t,n,s,r))}mo.flags|=e,i.memoizedState=_o(1|t,n,s,r)}function Ho(e,t){return zo(8390656,8,e,t)}function Vo(e,t){return Uo(2048,8,e,t)}function Ko(e,t){return Uo(4,2,e,t)}function Go(e,t){return Uo(4,4,e,t)}function Wo(e,t){return"function"===typeof t?(e=e(),t(e),function(){t(null)}):null!==t&&void 0!==t?(e=e(),t.current=e,function(){t.current=null}):void 0}function Jo(e,t,n){return n=null!==n&&void 0!==n?n.concat([e]):null,Uo(4,4,Wo.bind(null,t,e),n)}function Zo(){}function $o(e,t){var n=No();t=void 0===t?null:t;var r=n.memoizedState;return null!==r&&null!==t&&xo(t,r[1])?r[0]:(n.memoizedState=[e,t],e)}function Qo(e,t){var n=No();t=void 0===t?null:t;var r=n.memoizedState;return null!==r&&null!==t&&xo(t,r[1])?r[0]:(e=e(),n.memoizedState=[e,t],e)}function Xo(e,t,n){return 0===(21&po)?(e.baseState&&(e.baseState=!1,Sa=!0),e.memoizedState=n):(ar(n,t)||(n=mt(),mo.lanes|=n,Lc|=n,e.baseState=!0),t)}function Yo(e,t){var n=bt;bt=0!==n&&4>n?n:4,e(!0);var r=fo.transition;fo.transition={};try{e(!1),t()}finally{bt=n,fo.transition=r}}function ea(){return No().memoizedState}function ta(e,t,n){var r=nl(e);if(n={lane:r,action:n,hasEagerState:!1,eagerState:null,next:null},ra(e))ia(t,n);else if(null!==(n=Fs(e,t,n,r))){rl(n,e,r,tl()),sa(n,t,r)}}function na(e,t,n){var r=nl(e),i={lane:r,action:n,hasEagerState:!1,eagerState:null,next:null};if(ra(e))ia(t,i);else{var s=e.alternate;if(0===e.lanes&&(null===s||0===s.lanes)&&null!==(s=t.lastRenderedReducer))try{var o=t.lastRenderedState,a=s(o,n);if(i.hasEagerState=!0,i.eagerState=a,ar(a,o)){var c=t.interleaved;return null===c?(i.next=i,Ns(t)):(i.next=c.next,c.next=i),void(t.interleaved=i)}}catch(l){}null!==(n=Fs(e,t,i,r))&&(rl(n,e,r,i=tl()),sa(n,t,r))}}function ra(e){var t=e.alternate;return e===mo||null!==t&&t===mo}function ia(e,t){bo=yo=!0;var n=e.pending;null===n?t.next=t:(t.next=n.next,n.next=t),e.pending=t}function sa(e,t,n){if(0!==(4194240&n)){var r=t.lanes;n|=r&=e.pendingLanes,t.lanes=n,yt(e,n)}}var oa={readContext:Ts,useCallback:Co,useContext:Co,useEffect:Co,useImperativeHandle:Co,useInsertionEffect:Co,useLayoutEffect:Co,useMemo:Co,useReducer:Co,useRef:Co,useState:Co,useDebugValue:Co,useDeferredValue:Co,useTransition:Co,useMutableSource:Co,useSyncExternalStore:Co,useId:Co,unstable_isNewReconciler:!1},aa={readContext:Ts,useCallback:function(e,t){return ko().memoizedState=[e,void 0===t?null:t],e},useContext:Ts,useEffect:Ho,useImperativeHandle:function(e,t,n){return n=null!==n&&void 0!==n?n.concat([e]):null,zo(4194308,4,Wo.bind(null,t,e),n)},useLayoutEffect:function(e,t){return zo(4194308,4,e,t)},useInsertionEffect:function(e,t){return zo(4,2,e,t)},useMemo:function(e,t){var n=ko();return t=void 0===t?null:t,e=e(),n.memoizedState=[e,t],e},useReducer:function(e,t,n){var r=ko();return t=void 0!==n?n(t):t,r.memoizedState=r.baseState=t,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:e,lastRenderedState:t},r.queue=e,e=e.dispatch=ta.bind(null,mo,e),[r.memoizedState,e]},useRef:function(e){return e={current:e},ko().memoizedState=e},useState:qo,useDebugValue:Zo,useDeferredValue:function(e){return ko().memoizedState=e},useTransition:function(){var e=qo(!1),t=e[0];return e=Yo.bind(null,e[1]),ko().memoizedState=e,[t,e]},useMutableSource:function(){},useSyncExternalStore:function(e,t,n){var r=mo,i=ko();if(is){if(void 0===n)throw Error(s(407));n=n()}else{if(n=t(),null===Ac)throw Error(s(349));0!==(30&po)||Po(r,t,n)}i.memoizedState=n;var o={value:n,getSnapshot:t};return i.queue=o,Ho(Mo.bind(null,r,o,e),[e]),r.flags|=2048,_o(9,Ro.bind(null,r,o,n,t),void 0,null),n},useId:function(){var e=ko(),t=Ac.identifierPrefix;if(is){var n=Qi;t=":"+t+"R"+(n=($i&~(1<<32-ot($i)-1)).toString(32)+n),0<(n=So++)&&(t+="H"+n.toString(32)),t+=":"}else t=":"+t+"r"+(n=wo++).toString(32)+":";return e.memoizedState=t},unstable_isNewReconciler:!1},ca={readContext:Ts,useCallback:$o,useContext:Ts,useEffect:Vo,useImperativeHandle:Jo,useInsertionEffect:Ko,useLayoutEffect:Go,useMemo:Qo,useReducer:Io,useRef:jo,useState:function(){return Io(Fo)},useDebugValue:Zo,useDeferredValue:function(e){return Xo(No(),go.memoizedState,e)},useTransition:function(){return[Io(Fo)[0],No().memoizedState]},useMutableSource:Do,useSyncExternalStore:Oo,useId:ea,unstable_isNewReconciler:!1},la={readContext:Ts,useCallback:$o,useContext:Ts,useEffect:Vo,useImperativeHandle:Jo,useInsertionEffect:Ko,useLayoutEffect:Go,useMemo:Qo,useReducer:Ao,useRef:jo,useState:function(){return Ao(Fo)},useDebugValue:Zo,useDeferredValue:function(e){var t=No();return null===go?t.memoizedState=e:Xo(t,go.memoizedState,e)},useTransition:function(){return[Ao(Fo)[0],No().memoizedState]},useMutableSource:Do,useSyncExternalStore:Oo,useId:ea,unstable_isNewReconciler:!1};function ua(e,t){try{var n="",r=t;do{n+=z(r),r=r.return}while(r);var i=n}catch(s){i="\nError generating stack: "+s.message+"\n"+s.stack}return{value:e,source:t,stack:i,digest:null}}function ha(e,t,n){return{value:e,source:null,stack:null!=n?n:null,digest:null!=t?t:null}}function da(e,t){try{console.error(t.value)}catch(n){setTimeout((function(){throw n}))}}var fa="function"===typeof WeakMap?WeakMap:Map;function pa(e,t,n){(n=Ps(-1,n)).tag=3,n.payload={element:null};var r=t.value;return n.callback=function(){Kc||(Kc=!0,Gc=r),da(0,t)},n}function ma(e,t,n){(n=Ps(-1,n)).tag=3;var r=e.type.getDerivedStateFromError;if("function"===typeof r){var i=t.value;n.payload=function(){return r(i)},n.callback=function(){da(0,t)}}var s=e.stateNode;return null!==s&&"function"===typeof s.componentDidCatch&&(n.callback=function(){da(0,t),"function"!==typeof r&&(null===Wc?Wc=new Set([this]):Wc.add(this));var e=t.stack;this.componentDidCatch(t.value,{componentStack:null!==e?e:""})}),n}function ga(e,t,n){var r=e.pingCache;if(null===r){r=e.pingCache=new fa;var i=new Set;r.set(t,i)}else void 0===(i=r.get(t))&&(i=new Set,r.set(t,i));i.has(n)||(i.add(n),e=kl.bind(null,e,t,n),t.then(e,e))}function va(e){do{var t;if((t=13===e.tag)&&(t=null===(t=e.memoizedState)||null!==t.dehydrated),t)return e;e=e.return}while(null!==e);return null}function ya(e,t,n,r,i){return 0===(1&e.mode)?(e===t?e.flags|=65536:(e.flags|=128,n.flags|=131072,n.flags&=-52805,1===n.tag&&(null===n.alternate?n.tag=17:((t=Ps(-1,1)).tag=2,Rs(n,t,1))),n.lanes|=1),e):(e.flags|=65536,e.lanes=i,e)}var ba=S.ReactCurrentOwner,Sa=!1;function wa(e,t,n,r){t.child=null===e?Qs(t,null,n,r):$s(t,e.child,n,r)}function Ca(e,t,n,r,i){n=n.render;var s=t.ref;return Es(t,i),r=Eo(e,t,n,r,s,i),n=To(),null===e||Sa?(is&&n&&es(t),t.flags|=1,wa(e,t,r,i),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~i,Ka(e,t,i))}function xa(e,t,n,r,i){if(null===e){var s=n.type;return"function"!==typeof s||Pl(s)||void 0!==s.defaultProps||null!==n.compare||void 0!==n.defaultProps?((e=Ml(n.type,null,r,t,t.mode,i)).ref=t.ref,e.return=t,t.child=e):(t.tag=15,t.type=s,Ea(e,t,s,r,i))}if(s=e.child,0===(e.lanes&i)){var o=s.memoizedProps;if((n=null!==(n=n.compare)?n:cr)(o,r)&&e.ref===t.ref)return Ka(e,t,i)}return t.flags|=1,(e=Rl(s,r)).ref=t.ref,e.return=t,t.child=e}function Ea(e,t,n,r,i){if(null!==e){var s=e.memoizedProps;if(cr(s,r)&&e.ref===t.ref){if(Sa=!1,t.pendingProps=r=s,0===(e.lanes&i))return t.lanes=e.lanes,Ka(e,t,i);0!==(131072&e.flags)&&(Sa=!0)}}return Na(e,t,n,r,i)}function Ta(e,t,n){var r=t.pendingProps,i=r.children,s=null!==e?e.memoizedState:null;if("hidden"===r.mode)if(0===(1&t.mode))t.memoizedState={baseLanes:0,cachePool:null,transitions:null},ki(Rc,Pc),Pc|=n;else{if(0===(1073741824&n))return e=null!==s?s.baseLanes|n:n,t.lanes=t.childLanes=1073741824,t.memoizedState={baseLanes:e,cachePool:null,transitions:null},t.updateQueue=null,ki(Rc,Pc),Pc|=e,null;t.memoizedState={baseLanes:0,cachePool:null,transitions:null},r=null!==s?s.baseLanes:n,ki(Rc,Pc),Pc|=r}else null!==s?(r=s.baseLanes|n,t.memoizedState=null):r=n,ki(Rc,Pc),Pc|=r;return wa(e,t,i,n),t.child}function ka(e,t){var n=t.ref;(null===e&&null!==n||null!==e&&e.ref!==n)&&(t.flags|=512,t.flags|=2097152)}function Na(e,t,n,r,i){var s=Oi(n)?Ai:Fi.current;return s=Di(t,s),Es(t,i),n=Eo(e,t,n,r,s,i),r=To(),null===e||Sa?(is&&r&&es(t),t.flags|=1,wa(e,t,n,i),t.child):(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~i,Ka(e,t,i))}function Fa(e,t,n,r,i){if(Oi(n)){var s=!0;Bi(t)}else s=!1;if(Es(t,i),null===t.stateNode)Va(e,t),Hs(t,n,r),Ks(t,n,r,i),r=!0;else if(null===e){var o=t.stateNode,a=t.memoizedProps;o.props=a;var c=o.context,l=n.contextType;"object"===typeof l&&null!==l?l=Ts(l):l=Di(t,l=Oi(n)?Ai:Fi.current);var u=n.getDerivedStateFromProps,h="function"===typeof u||"function"===typeof o.getSnapshotBeforeUpdate;h||"function"!==typeof o.UNSAFE_componentWillReceiveProps&&"function"!==typeof o.componentWillReceiveProps||(a!==r||c!==l)&&Vs(t,o,r,l),As=!1;var d=t.memoizedState;o.state=d,Ls(t,r,o,i),c=t.memoizedState,a!==r||d!==c||Ii.current||As?("function"===typeof u&&(js(t,n,u,r),c=t.memoizedState),(a=As||Us(t,n,a,r,d,c,l))?(h||"function"!==typeof o.UNSAFE_componentWillMount&&"function"!==typeof o.componentWillMount||("function"===typeof o.componentWillMount&&o.componentWillMount(),"function"===typeof o.UNSAFE_componentWillMount&&o.UNSAFE_componentWillMount()),"function"===typeof o.componentDidMount&&(t.flags|=4194308)):("function"===typeof o.componentDidMount&&(t.flags|=4194308),t.memoizedProps=r,t.memoizedState=c),o.props=r,o.state=c,o.context=l,r=a):("function"===typeof o.componentDidMount&&(t.flags|=4194308),r=!1)}else{o=t.stateNode,Os(e,t),a=t.memoizedProps,l=t.type===t.elementType?a:gs(t.type,a),o.props=l,h=t.pendingProps,d=o.context,"object"===typeof(c=n.contextType)&&null!==c?c=Ts(c):c=Di(t,c=Oi(n)?Ai:Fi.current);var f=n.getDerivedStateFromProps;(u="function"===typeof f||"function"===typeof o.getSnapshotBeforeUpdate)||"function"!==typeof o.UNSAFE_componentWillReceiveProps&&"function"!==typeof o.componentWillReceiveProps||(a!==h||d!==c)&&Vs(t,o,r,c),As=!1,d=t.memoizedState,o.state=d,Ls(t,r,o,i);var p=t.memoizedState;a!==h||d!==p||Ii.current||As?("function"===typeof f&&(js(t,n,f,r),p=t.memoizedState),(l=As||Us(t,n,l,r,d,p,c)||!1)?(u||"function"!==typeof o.UNSAFE_componentWillUpdate&&"function"!==typeof o.componentWillUpdate||("function"===typeof o.componentWillUpdate&&o.componentWillUpdate(r,p,c),"function"===typeof o.UNSAFE_componentWillUpdate&&o.UNSAFE_componentWillUpdate(r,p,c)),"function"===typeof o.componentDidUpdate&&(t.flags|=4),"function"===typeof o.getSnapshotBeforeUpdate&&(t.flags|=1024)):("function"!==typeof o.componentDidUpdate||a===e.memoizedProps&&d===e.memoizedState||(t.flags|=4),"function"!==typeof o.getSnapshotBeforeUpdate||a===e.memoizedProps&&d===e.memoizedState||(t.flags|=1024),t.memoizedProps=r,t.memoizedState=p),o.props=r,o.state=p,o.context=c,r=l):("function"!==typeof o.componentDidUpdate||a===e.memoizedProps&&d===e.memoizedState||(t.flags|=4),"function"!==typeof o.getSnapshotBeforeUpdate||a===e.memoizedProps&&d===e.memoizedState||(t.flags|=1024),r=!1)}return Ia(e,t,n,r,s,i)}function Ia(e,t,n,r,i,s){ka(e,t);var o=0!==(128&t.flags);if(!r&&!o)return i&&Li(t,n,!1),Ka(e,t,s);r=t.stateNode,ba.current=t;var a=o&&"function"!==typeof n.getDerivedStateFromError?null:r.render();return t.flags|=1,null!==e&&o?(t.child=$s(t,e.child,null,s),t.child=$s(t,null,a,s)):wa(e,t,a,s),t.memoizedState=r.state,i&&Li(t,n,!0),t.child}function Aa(e){var t=e.stateNode;t.pendingContext?Ri(0,t.pendingContext,t.pendingContext!==t.context):t.context&&Ri(0,t.context,!1),ro(e,t.containerInfo)}function Da(e,t,n,r,i){return fs(),ps(i),t.flags|=256,wa(e,t,n,r),t.child}var Oa,Pa,Ra,Ma,Ba={dehydrated:null,treeContext:null,retryLane:0};function La(e){return{baseLanes:e,cachePool:null,transitions:null}}function qa(e,t,n){var r,i=t.pendingProps,o=ao.current,a=!1,c=0!==(128&t.flags);if((r=c)||(r=(null===e||null!==e.memoizedState)&&0!==(2&o)),r?(a=!0,t.flags&=-129):null!==e&&null===e.memoizedState||(o|=1),ki(ao,1&o),null===e)return ls(t),null!==(e=t.memoizedState)&&null!==(e=e.dehydrated)?(0===(1&t.mode)?t.lanes=1:"$!"===e.data?t.lanes=8:t.lanes=1073741824,null):(c=i.children,e=i.fallback,a?(i=t.mode,a=t.child,c={mode:"hidden",children:c},0===(1&i)&&null!==a?(a.childLanes=0,a.pendingProps=c):a=Ll(c,i,0,null),e=Bl(e,i,n,null),a.return=t,e.return=t,a.sibling=e,t.child=a,t.child.memoizedState=La(n),t.memoizedState=Ba,e):_a(t,c));if(null!==(o=e.memoizedState)&&null!==(r=o.dehydrated))return function(e,t,n,r,i,o,a){if(n)return 256&t.flags?(t.flags&=-257,ja(e,t,a,r=ha(Error(s(422))))):null!==t.memoizedState?(t.child=e.child,t.flags|=128,null):(o=r.fallback,i=t.mode,r=Ll({mode:"visible",children:r.children},i,0,null),(o=Bl(o,i,a,null)).flags|=2,r.return=t,o.return=t,r.sibling=o,t.child=r,0!==(1&t.mode)&&$s(t,e.child,null,a),t.child.memoizedState=La(a),t.memoizedState=Ba,o);if(0===(1&t.mode))return ja(e,t,a,null);if("$!"===i.data){if(r=i.nextSibling&&i.nextSibling.dataset)var c=r.dgst;return r=c,ja(e,t,a,r=ha(o=Error(s(419)),r,void 0))}if(c=0!==(a&e.childLanes),Sa||c){if(null!==(r=Ac)){switch(a&-a){case 4:i=2;break;case 16:i=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:i=32;break;case 536870912:i=268435456;break;default:i=0}0!==(i=0!==(i&(r.suspendedLanes|a))?0:i)&&i!==o.retryLane&&(o.retryLane=i,Is(e,i),rl(r,e,i,-1))}return gl(),ja(e,t,a,r=ha(Error(s(421))))}return"$?"===i.data?(t.flags|=128,t.child=e.child,t=Fl.bind(null,e),i._reactRetry=t,null):(e=o.treeContext,rs=li(i.nextSibling),ns=t,is=!0,ss=null,null!==e&&(Wi[Ji++]=$i,Wi[Ji++]=Qi,Wi[Ji++]=Zi,$i=e.id,Qi=e.overflow,Zi=t),t=_a(t,r.children),t.flags|=4096,t)}(e,t,c,i,r,o,n);if(a){a=i.fallback,c=t.mode,r=(o=e.child).sibling;var l={mode:"hidden",children:i.children};return 0===(1&c)&&t.child!==o?((i=t.child).childLanes=0,i.pendingProps=l,t.deletions=null):(i=Rl(o,l)).subtreeFlags=14680064&o.subtreeFlags,null!==r?a=Rl(r,a):(a=Bl(a,c,n,null)).flags|=2,a.return=t,i.return=t,i.sibling=a,t.child=i,i=a,a=t.child,c=null===(c=e.child.memoizedState)?La(n):{baseLanes:c.baseLanes|n,cachePool:null,transitions:c.transitions},a.memoizedState=c,a.childLanes=e.childLanes&~n,t.memoizedState=Ba,i}return e=(a=e.child).sibling,i=Rl(a,{mode:"visible",children:i.children}),0===(1&t.mode)&&(i.lanes=n),i.return=t,i.sibling=null,null!==e&&(null===(n=t.deletions)?(t.deletions=[e],t.flags|=16):n.push(e)),t.child=i,t.memoizedState=null,i}function _a(e,t){return(t=Ll({mode:"visible",children:t},e.mode,0,null)).return=e,e.child=t}function ja(e,t,n,r){return null!==r&&ps(r),$s(t,e.child,null,n),(e=_a(t,t.pendingProps.children)).flags|=2,t.memoizedState=null,e}function za(e,t,n){e.lanes|=t;var r=e.alternate;null!==r&&(r.lanes|=t),xs(e.return,t,n)}function Ua(e,t,n,r,i){var s=e.memoizedState;null===s?e.memoizedState={isBackwards:t,rendering:null,renderingStartTime:0,last:r,tail:n,tailMode:i}:(s.isBackwards=t,s.rendering=null,s.renderingStartTime=0,s.last=r,s.tail=n,s.tailMode=i)}function Ha(e,t,n){var r=t.pendingProps,i=r.revealOrder,s=r.tail;if(wa(e,t,r.children,n),0!==(2&(r=ao.current)))r=1&r|2,t.flags|=128;else{if(null!==e&&0!==(128&e.flags))e:for(e=t.child;null!==e;){if(13===e.tag)null!==e.memoizedState&&za(e,n,t);else if(19===e.tag)za(e,n,t);else if(null!==e.child){e.child.return=e,e=e.child;continue}if(e===t)break e;for(;null===e.sibling;){if(null===e.return||e.return===t)break e;e=e.return}e.sibling.return=e.return,e=e.sibling}r&=1}if(ki(ao,r),0===(1&t.mode))t.memoizedState=null;else switch(i){case"forwards":for(n=t.child,i=null;null!==n;)null!==(e=n.alternate)&&null===co(e)&&(i=n),n=n.sibling;null===(n=i)?(i=t.child,t.child=null):(i=n.sibling,n.sibling=null),Ua(t,!1,i,n,s);break;case"backwards":for(n=null,i=t.child,t.child=null;null!==i;){if(null!==(e=i.alternate)&&null===co(e)){t.child=i;break}e=i.sibling,i.sibling=n,n=i,i=e}Ua(t,!0,n,null,s);break;case"together":Ua(t,!1,null,null,void 0);break;default:t.memoizedState=null}return t.child}function Va(e,t){0===(1&t.mode)&&null!==e&&(e.alternate=null,t.alternate=null,t.flags|=2)}function Ka(e,t,n){if(null!==e&&(t.dependencies=e.dependencies),Lc|=t.lanes,0===(n&t.childLanes))return null;if(null!==e&&t.child!==e.child)throw Error(s(153));if(null!==t.child){for(n=Rl(e=t.child,e.pendingProps),t.child=n,n.return=t;null!==e.sibling;)e=e.sibling,(n=n.sibling=Rl(e,e.pendingProps)).return=t;n.sibling=null}return t.child}function Ga(e,t){if(!is)switch(e.tailMode){case"hidden":t=e.tail;for(var n=null;null!==t;)null!==t.alternate&&(n=t),t=t.sibling;null===n?e.tail=null:n.sibling=null;break;case"collapsed":n=e.tail;for(var r=null;null!==n;)null!==n.alternate&&(r=n),n=n.sibling;null===r?t||null===e.tail?e.tail=null:e.tail.sibling=null:r.sibling=null}}function Wa(e){var t=null!==e.alternate&&e.alternate.child===e.child,n=0,r=0;if(t)for(var i=e.child;null!==i;)n|=i.lanes|i.childLanes,r|=14680064&i.subtreeFlags,r|=14680064&i.flags,i.return=e,i=i.sibling;else for(i=e.child;null!==i;)n|=i.lanes|i.childLanes,r|=i.subtreeFlags,r|=i.flags,i.return=e,i=i.sibling;return e.subtreeFlags|=r,e.childLanes=n,t}function Ja(e,t,n){var r=t.pendingProps;switch(ts(t),t.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Wa(t),null;case 1:case 17:return Oi(t.type)&&Pi(),Wa(t),null;case 3:return r=t.stateNode,io(),Ti(Ii),Ti(Fi),uo(),r.pendingContext&&(r.context=r.pendingContext,r.pendingContext=null),null!==e&&null!==e.child||(hs(t)?t.flags|=4:null===e||e.memoizedState.isDehydrated&&0===(256&t.flags)||(t.flags|=1024,null!==ss&&(al(ss),ss=null))),Pa(e,t),Wa(t),null;case 5:oo(t);var i=no(to.current);if(n=t.type,null!==e&&null!=t.stateNode)Ra(e,t,n,r,i),e.ref!==t.ref&&(t.flags|=512,t.flags|=2097152);else{if(!r){if(null===t.stateNode)throw Error(s(166));return Wa(t),null}if(e=no(Ys.current),hs(t)){r=t.stateNode,n=t.type;var o=t.memoizedProps;switch(r[di]=t,r[fi]=o,e=0!==(1&t.mode),n){case"dialog":_r("cancel",r),_r("close",r);break;case"iframe":case"object":case"embed":_r("load",r);break;case"video":case"audio":for(i=0;i<Mr.length;i++)_r(Mr[i],r);break;case"source":_r("error",r);break;case"img":case"image":case"link":_r("error",r),_r("load",r);break;case"details":_r("toggle",r);break;case"input":$(r,o),_r("invalid",r);break;case"select":r._wrapperState={wasMultiple:!!o.multiple},_r("invalid",r);break;case"textarea":ie(r,o),_r("invalid",r)}for(var c in ye(n,o),i=null,o)if(o.hasOwnProperty(c)){var l=o[c];"children"===c?"string"===typeof l?r.textContent!==l&&(!0!==o.suppressHydrationWarning&&Xr(r.textContent,l,e),i=["children",l]):"number"===typeof l&&r.textContent!==""+l&&(!0!==o.suppressHydrationWarning&&Xr(r.textContent,l,e),i=["children",""+l]):a.hasOwnProperty(c)&&null!=l&&"onScroll"===c&&_r("scroll",r)}switch(n){case"input":G(r),Y(r,o,!0);break;case"textarea":G(r),oe(r);break;case"select":case"option":break;default:"function"===typeof o.onClick&&(r.onclick=Yr)}r=i,t.updateQueue=r,null!==r&&(t.flags|=4)}else{c=9===i.nodeType?i:i.ownerDocument,"http://www.w3.org/1999/xhtml"===e&&(e=ae(n)),"http://www.w3.org/1999/xhtml"===e?"script"===n?((e=c.createElement("div")).innerHTML="<script><\/script>",e=e.removeChild(e.firstChild)):"string"===typeof r.is?e=c.createElement(n,{is:r.is}):(e=c.createElement(n),"select"===n&&(c=e,r.multiple?c.multiple=!0:r.size&&(c.size=r.size))):e=c.createElementNS(e,n),e[di]=t,e[fi]=r,Oa(e,t,!1,!1),t.stateNode=e;e:{switch(c=be(n,r),n){case"dialog":_r("cancel",e),_r("close",e),i=r;break;case"iframe":case"object":case"embed":_r("load",e),i=r;break;case"video":case"audio":for(i=0;i<Mr.length;i++)_r(Mr[i],e);i=r;break;case"source":_r("error",e),i=r;break;case"img":case"image":case"link":_r("error",e),_r("load",e),i=r;break;case"details":_r("toggle",e),i=r;break;case"input":$(e,r),i=Z(e,r),_r("invalid",e);break;case"option":default:i=r;break;case"select":e._wrapperState={wasMultiple:!!r.multiple},i=L({},r,{value:void 0}),_r("invalid",e);break;case"textarea":ie(e,r),i=re(e,r),_r("invalid",e)}for(o in ye(n,i),l=i)if(l.hasOwnProperty(o)){var u=l[o];"style"===o?ge(e,u):"dangerouslySetInnerHTML"===o?null!=(u=u?u.__html:void 0)&&he(e,u):"children"===o?"string"===typeof u?("textarea"!==n||""!==u)&&de(e,u):"number"===typeof u&&de(e,""+u):"suppressContentEditableWarning"!==o&&"suppressHydrationWarning"!==o&&"autoFocus"!==o&&(a.hasOwnProperty(o)?null!=u&&"onScroll"===o&&_r("scroll",e):null!=u&&b(e,o,u,c))}switch(n){case"input":G(e),Y(e,r,!1);break;case"textarea":G(e),oe(e);break;case"option":null!=r.value&&e.setAttribute("value",""+V(r.value));break;case"select":e.multiple=!!r.multiple,null!=(o=r.value)?ne(e,!!r.multiple,o,!1):null!=r.defaultValue&&ne(e,!!r.multiple,r.defaultValue,!0);break;default:"function"===typeof i.onClick&&(e.onclick=Yr)}switch(n){case"button":case"input":case"select":case"textarea":r=!!r.autoFocus;break e;case"img":r=!0;break e;default:r=!1}}r&&(t.flags|=4)}null!==t.ref&&(t.flags|=512,t.flags|=2097152)}return Wa(t),null;case 6:if(e&&null!=t.stateNode)Ma(e,t,e.memoizedProps,r);else{if("string"!==typeof r&&null===t.stateNode)throw Error(s(166));if(n=no(to.current),no(Ys.current),hs(t)){if(r=t.stateNode,n=t.memoizedProps,r[di]=t,(o=r.nodeValue!==n)&&null!==(e=ns))switch(e.tag){case 3:Xr(r.nodeValue,n,0!==(1&e.mode));break;case 5:!0!==e.memoizedProps.suppressHydrationWarning&&Xr(r.nodeValue,n,0!==(1&e.mode))}o&&(t.flags|=4)}else(r=(9===n.nodeType?n:n.ownerDocument).createTextNode(r))[di]=t,t.stateNode=r}return Wa(t),null;case 13:if(Ti(ao),r=t.memoizedState,null===e||null!==e.memoizedState&&null!==e.memoizedState.dehydrated){if(is&&null!==rs&&0!==(1&t.mode)&&0===(128&t.flags))ds(),fs(),t.flags|=98560,o=!1;else if(o=hs(t),null!==r&&null!==r.dehydrated){if(null===e){if(!o)throw Error(s(318));if(!(o=null!==(o=t.memoizedState)?o.dehydrated:null))throw Error(s(317));o[di]=t}else fs(),0===(128&t.flags)&&(t.memoizedState=null),t.flags|=4;Wa(t),o=!1}else null!==ss&&(al(ss),ss=null),o=!0;if(!o)return 65536&t.flags?t:null}return 0!==(128&t.flags)?(t.lanes=n,t):((r=null!==r)!==(null!==e&&null!==e.memoizedState)&&r&&(t.child.flags|=8192,0!==(1&t.mode)&&(null===e||0!==(1&ao.current)?0===Mc&&(Mc=3):gl())),null!==t.updateQueue&&(t.flags|=4),Wa(t),null);case 4:return io(),Pa(e,t),null===e&&Ur(t.stateNode.containerInfo),Wa(t),null;case 10:return Cs(t.type._context),Wa(t),null;case 19:if(Ti(ao),null===(o=t.memoizedState))return Wa(t),null;if(r=0!==(128&t.flags),null===(c=o.rendering))if(r)Ga(o,!1);else{if(0!==Mc||null!==e&&0!==(128&e.flags))for(e=t.child;null!==e;){if(null!==(c=co(e))){for(t.flags|=128,Ga(o,!1),null!==(r=c.updateQueue)&&(t.updateQueue=r,t.flags|=4),t.subtreeFlags=0,r=n,n=t.child;null!==n;)e=r,(o=n).flags&=14680066,null===(c=o.alternate)?(o.childLanes=0,o.lanes=e,o.child=null,o.subtreeFlags=0,o.memoizedProps=null,o.memoizedState=null,o.updateQueue=null,o.dependencies=null,o.stateNode=null):(o.childLanes=c.childLanes,o.lanes=c.lanes,o.child=c.child,o.subtreeFlags=0,o.deletions=null,o.memoizedProps=c.memoizedProps,o.memoizedState=c.memoizedState,o.updateQueue=c.updateQueue,o.type=c.type,e=c.dependencies,o.dependencies=null===e?null:{lanes:e.lanes,firstContext:e.firstContext}),n=n.sibling;return ki(ao,1&ao.current|2),t.child}e=e.sibling}null!==o.tail&&Qe()>Hc&&(t.flags|=128,r=!0,Ga(o,!1),t.lanes=4194304)}else{if(!r)if(null!==(e=co(c))){if(t.flags|=128,r=!0,null!==(n=e.updateQueue)&&(t.updateQueue=n,t.flags|=4),Ga(o,!0),null===o.tail&&"hidden"===o.tailMode&&!c.alternate&&!is)return Wa(t),null}else 2*Qe()-o.renderingStartTime>Hc&&1073741824!==n&&(t.flags|=128,r=!0,Ga(o,!1),t.lanes=4194304);o.isBackwards?(c.sibling=t.child,t.child=c):(null!==(n=o.last)?n.sibling=c:t.child=c,o.last=c)}return null!==o.tail?(t=o.tail,o.rendering=t,o.tail=t.sibling,o.renderingStartTime=Qe(),t.sibling=null,n=ao.current,ki(ao,r?1&n|2:1&n),t):(Wa(t),null);case 22:case 23:return dl(),r=null!==t.memoizedState,null!==e&&null!==e.memoizedState!==r&&(t.flags|=8192),r&&0!==(1&t.mode)?0!==(1073741824&Pc)&&(Wa(t),6&t.subtreeFlags&&(t.flags|=8192)):Wa(t),null;case 24:case 25:return null}throw Error(s(156,t.tag))}function Za(e,t){switch(ts(t),t.tag){case 1:return Oi(t.type)&&Pi(),65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 3:return io(),Ti(Ii),Ti(Fi),uo(),0!==(65536&(e=t.flags))&&0===(128&e)?(t.flags=-65537&e|128,t):null;case 5:return oo(t),null;case 13:if(Ti(ao),null!==(e=t.memoizedState)&&null!==e.dehydrated){if(null===t.alternate)throw Error(s(340));fs()}return 65536&(e=t.flags)?(t.flags=-65537&e|128,t):null;case 19:return Ti(ao),null;case 4:return io(),null;case 10:return Cs(t.type._context),null;case 22:case 23:return dl(),null;default:return null}}Oa=function(e,t){for(var n=t.child;null!==n;){if(5===n.tag||6===n.tag)e.appendChild(n.stateNode);else if(4!==n.tag&&null!==n.child){n.child.return=n,n=n.child;continue}if(n===t)break;for(;null===n.sibling;){if(null===n.return||n.return===t)return;n=n.return}n.sibling.return=n.return,n=n.sibling}},Pa=function(){},Ra=function(e,t,n,r){var i=e.memoizedProps;if(i!==r){e=t.stateNode,no(Ys.current);var s,o=null;switch(n){case"input":i=Z(e,i),r=Z(e,r),o=[];break;case"select":i=L({},i,{value:void 0}),r=L({},r,{value:void 0}),o=[];break;case"textarea":i=re(e,i),r=re(e,r),o=[];break;default:"function"!==typeof i.onClick&&"function"===typeof r.onClick&&(e.onclick=Yr)}for(u in ye(n,r),n=null,i)if(!r.hasOwnProperty(u)&&i.hasOwnProperty(u)&&null!=i[u])if("style"===u){var c=i[u];for(s in c)c.hasOwnProperty(s)&&(n||(n={}),n[s]="")}else"dangerouslySetInnerHTML"!==u&&"children"!==u&&"suppressContentEditableWarning"!==u&&"suppressHydrationWarning"!==u&&"autoFocus"!==u&&(a.hasOwnProperty(u)?o||(o=[]):(o=o||[]).push(u,null));for(u in r){var l=r[u];if(c=null!=i?i[u]:void 0,r.hasOwnProperty(u)&&l!==c&&(null!=l||null!=c))if("style"===u)if(c){for(s in c)!c.hasOwnProperty(s)||l&&l.hasOwnProperty(s)||(n||(n={}),n[s]="");for(s in l)l.hasOwnProperty(s)&&c[s]!==l[s]&&(n||(n={}),n[s]=l[s])}else n||(o||(o=[]),o.push(u,n)),n=l;else"dangerouslySetInnerHTML"===u?(l=l?l.__html:void 0,c=c?c.__html:void 0,null!=l&&c!==l&&(o=o||[]).push(u,l)):"children"===u?"string"!==typeof l&&"number"!==typeof l||(o=o||[]).push(u,""+l):"suppressContentEditableWarning"!==u&&"suppressHydrationWarning"!==u&&(a.hasOwnProperty(u)?(null!=l&&"onScroll"===u&&_r("scroll",e),o||c===l||(o=[])):(o=o||[]).push(u,l))}n&&(o=o||[]).push("style",n);var u=o;(t.updateQueue=u)&&(t.flags|=4)}},Ma=function(e,t,n,r){n!==r&&(t.flags|=4)};var $a=!1,Qa=!1,Xa="function"===typeof WeakSet?WeakSet:Set,Ya=null;function ec(e,t){var n=e.ref;if(null!==n)if("function"===typeof n)try{n(null)}catch(r){Tl(e,t,r)}else n.current=null}function tc(e,t,n){try{n()}catch(r){Tl(e,t,r)}}var nc=!1;function rc(e,t,n){var r=t.updateQueue;if(null!==(r=null!==r?r.lastEffect:null)){var i=r=r.next;do{if((i.tag&e)===e){var s=i.destroy;i.destroy=void 0,void 0!==s&&tc(t,n,s)}i=i.next}while(i!==r)}}function ic(e,t){if(null!==(t=null!==(t=t.updateQueue)?t.lastEffect:null)){var n=t=t.next;do{if((n.tag&e)===e){var r=n.create;n.destroy=r()}n=n.next}while(n!==t)}}function sc(e){var t=e.ref;if(null!==t){var n=e.stateNode;e.tag,e=n,"function"===typeof t?t(e):t.current=e}}function oc(e){var t=e.alternate;null!==t&&(e.alternate=null,oc(t)),e.child=null,e.deletions=null,e.sibling=null,5===e.tag&&(null!==(t=e.stateNode)&&(delete t[di],delete t[fi],delete t[mi],delete t[gi],delete t[vi])),e.stateNode=null,e.return=null,e.dependencies=null,e.memoizedProps=null,e.memoizedState=null,e.pendingProps=null,e.stateNode=null,e.updateQueue=null}function ac(e){return 5===e.tag||3===e.tag||4===e.tag}function cc(e){e:for(;;){for(;null===e.sibling;){if(null===e.return||ac(e.return))return null;e=e.return}for(e.sibling.return=e.return,e=e.sibling;5!==e.tag&&6!==e.tag&&18!==e.tag;){if(2&e.flags)continue e;if(null===e.child||4===e.tag)continue e;e.child.return=e,e=e.child}if(!(2&e.flags))return e.stateNode}}function lc(e,t,n){var r=e.tag;if(5===r||6===r)e=e.stateNode,t?8===n.nodeType?n.parentNode.insertBefore(e,t):n.insertBefore(e,t):(8===n.nodeType?(t=n.parentNode).insertBefore(e,n):(t=n).appendChild(e),null!==(n=n._reactRootContainer)&&void 0!==n||null!==t.onclick||(t.onclick=Yr));else if(4!==r&&null!==(e=e.child))for(lc(e,t,n),e=e.sibling;null!==e;)lc(e,t,n),e=e.sibling}function uc(e,t,n){var r=e.tag;if(5===r||6===r)e=e.stateNode,t?n.insertBefore(e,t):n.appendChild(e);else if(4!==r&&null!==(e=e.child))for(uc(e,t,n),e=e.sibling;null!==e;)uc(e,t,n),e=e.sibling}var hc=null,dc=!1;function fc(e,t,n){for(n=n.child;null!==n;)pc(e,t,n),n=n.sibling}function pc(e,t,n){if(st&&"function"===typeof st.onCommitFiberUnmount)try{st.onCommitFiberUnmount(it,n)}catch(a){}switch(n.tag){case 5:Qa||ec(n,t);case 6:var r=hc,i=dc;hc=null,fc(e,t,n),dc=i,null!==(hc=r)&&(dc?(e=hc,n=n.stateNode,8===e.nodeType?e.parentNode.removeChild(n):e.removeChild(n)):hc.removeChild(n.stateNode));break;case 18:null!==hc&&(dc?(e=hc,n=n.stateNode,8===e.nodeType?ci(e.parentNode,n):1===e.nodeType&&ci(e,n),Ut(e)):ci(hc,n.stateNode));break;case 4:r=hc,i=dc,hc=n.stateNode.containerInfo,dc=!0,fc(e,t,n),hc=r,dc=i;break;case 0:case 11:case 14:case 15:if(!Qa&&(null!==(r=n.updateQueue)&&null!==(r=r.lastEffect))){i=r=r.next;do{var s=i,o=s.destroy;s=s.tag,void 0!==o&&(0!==(2&s)||0!==(4&s))&&tc(n,t,o),i=i.next}while(i!==r)}fc(e,t,n);break;case 1:if(!Qa&&(ec(n,t),"function"===typeof(r=n.stateNode).componentWillUnmount))try{r.props=n.memoizedProps,r.state=n.memoizedState,r.componentWillUnmount()}catch(a){Tl(n,t,a)}fc(e,t,n);break;case 21:fc(e,t,n);break;case 22:1&n.mode?(Qa=(r=Qa)||null!==n.memoizedState,fc(e,t,n),Qa=r):fc(e,t,n);break;default:fc(e,t,n)}}function mc(e){var t=e.updateQueue;if(null!==t){e.updateQueue=null;var n=e.stateNode;null===n&&(n=e.stateNode=new Xa),t.forEach((function(t){var r=Il.bind(null,e,t);n.has(t)||(n.add(t),t.then(r,r))}))}}function gc(e,t){var n=t.deletions;if(null!==n)for(var r=0;r<n.length;r++){var i=n[r];try{var o=e,a=t,c=a;e:for(;null!==c;){switch(c.tag){case 5:hc=c.stateNode,dc=!1;break e;case 3:case 4:hc=c.stateNode.containerInfo,dc=!0;break e}c=c.return}if(null===hc)throw Error(s(160));pc(o,a,i),hc=null,dc=!1;var l=i.alternate;null!==l&&(l.return=null),i.return=null}catch(u){Tl(i,t,u)}}if(12854&t.subtreeFlags)for(t=t.child;null!==t;)vc(t,e),t=t.sibling}function vc(e,t){var n=e.alternate,r=e.flags;switch(e.tag){case 0:case 11:case 14:case 15:if(gc(t,e),yc(e),4&r){try{rc(3,e,e.return),ic(3,e)}catch(g){Tl(e,e.return,g)}try{rc(5,e,e.return)}catch(g){Tl(e,e.return,g)}}break;case 1:gc(t,e),yc(e),512&r&&null!==n&&ec(n,n.return);break;case 5:if(gc(t,e),yc(e),512&r&&null!==n&&ec(n,n.return),32&e.flags){var i=e.stateNode;try{de(i,"")}catch(g){Tl(e,e.return,g)}}if(4&r&&null!=(i=e.stateNode)){var o=e.memoizedProps,a=null!==n?n.memoizedProps:o,c=e.type,l=e.updateQueue;if(e.updateQueue=null,null!==l)try{"input"===c&&"radio"===o.type&&null!=o.name&&Q(i,o),be(c,a);var u=be(c,o);for(a=0;a<l.length;a+=2){var h=l[a],d=l[a+1];"style"===h?ge(i,d):"dangerouslySetInnerHTML"===h?he(i,d):"children"===h?de(i,d):b(i,h,d,u)}switch(c){case"input":X(i,o);break;case"textarea":se(i,o);break;case"select":var f=i._wrapperState.wasMultiple;i._wrapperState.wasMultiple=!!o.multiple;var p=o.value;null!=p?ne(i,!!o.multiple,p,!1):f!==!!o.multiple&&(null!=o.defaultValue?ne(i,!!o.multiple,o.defaultValue,!0):ne(i,!!o.multiple,o.multiple?[]:"",!1))}i[fi]=o}catch(g){Tl(e,e.return,g)}}break;case 6:if(gc(t,e),yc(e),4&r){if(null===e.stateNode)throw Error(s(162));i=e.stateNode,o=e.memoizedProps;try{i.nodeValue=o}catch(g){Tl(e,e.return,g)}}break;case 3:if(gc(t,e),yc(e),4&r&&null!==n&&n.memoizedState.isDehydrated)try{Ut(t.containerInfo)}catch(g){Tl(e,e.return,g)}break;case 4:default:gc(t,e),yc(e);break;case 13:gc(t,e),yc(e),8192&(i=e.child).flags&&(o=null!==i.memoizedState,i.stateNode.isHidden=o,!o||null!==i.alternate&&null!==i.alternate.memoizedState||(Uc=Qe())),4&r&&mc(e);break;case 22:if(h=null!==n&&null!==n.memoizedState,1&e.mode?(Qa=(u=Qa)||h,gc(t,e),Qa=u):gc(t,e),yc(e),8192&r){if(u=null!==e.memoizedState,(e.stateNode.isHidden=u)&&!h&&0!==(1&e.mode))for(Ya=e,h=e.child;null!==h;){for(d=Ya=h;null!==Ya;){switch(p=(f=Ya).child,f.tag){case 0:case 11:case 14:case 15:rc(4,f,f.return);break;case 1:ec(f,f.return);var m=f.stateNode;if("function"===typeof m.componentWillUnmount){r=f,n=f.return;try{t=r,m.props=t.memoizedProps,m.state=t.memoizedState,m.componentWillUnmount()}catch(g){Tl(r,n,g)}}break;case 5:ec(f,f.return);break;case 22:if(null!==f.memoizedState){Cc(d);continue}}null!==p?(p.return=f,Ya=p):Cc(d)}h=h.sibling}e:for(h=null,d=e;;){if(5===d.tag){if(null===h){h=d;try{i=d.stateNode,u?"function"===typeof(o=i.style).setProperty?o.setProperty("display","none","important"):o.display="none":(c=d.stateNode,a=void 0!==(l=d.memoizedProps.style)&&null!==l&&l.hasOwnProperty("display")?l.display:null,c.style.display=me("display",a))}catch(g){Tl(e,e.return,g)}}}else if(6===d.tag){if(null===h)try{d.stateNode.nodeValue=u?"":d.memoizedProps}catch(g){Tl(e,e.return,g)}}else if((22!==d.tag&&23!==d.tag||null===d.memoizedState||d===e)&&null!==d.child){d.child.return=d,d=d.child;continue}if(d===e)break e;for(;null===d.sibling;){if(null===d.return||d.return===e)break e;h===d&&(h=null),d=d.return}h===d&&(h=null),d.sibling.return=d.return,d=d.sibling}}break;case 19:gc(t,e),yc(e),4&r&&mc(e);case 21:}}function yc(e){var t=e.flags;if(2&t){try{e:{for(var n=e.return;null!==n;){if(ac(n)){var r=n;break e}n=n.return}throw Error(s(160))}switch(r.tag){case 5:var i=r.stateNode;32&r.flags&&(de(i,""),r.flags&=-33),uc(e,cc(e),i);break;case 3:case 4:var o=r.stateNode.containerInfo;lc(e,cc(e),o);break;default:throw Error(s(161))}}catch(a){Tl(e,e.return,a)}e.flags&=-3}4096&t&&(e.flags&=-4097)}function bc(e,t,n){Ya=e,Sc(e,t,n)}function Sc(e,t,n){for(var r=0!==(1&e.mode);null!==Ya;){var i=Ya,s=i.child;if(22===i.tag&&r){var o=null!==i.memoizedState||$a;if(!o){var a=i.alternate,c=null!==a&&null!==a.memoizedState||Qa;a=$a;var l=Qa;if($a=o,(Qa=c)&&!l)for(Ya=i;null!==Ya;)c=(o=Ya).child,22===o.tag&&null!==o.memoizedState?xc(i):null!==c?(c.return=o,Ya=c):xc(i);for(;null!==s;)Ya=s,Sc(s,t,n),s=s.sibling;Ya=i,$a=a,Qa=l}wc(e)}else 0!==(8772&i.subtreeFlags)&&null!==s?(s.return=i,Ya=s):wc(e)}}function wc(e){for(;null!==Ya;){var t=Ya;if(0!==(8772&t.flags)){var n=t.alternate;try{if(0!==(8772&t.flags))switch(t.tag){case 0:case 11:case 15:Qa||ic(5,t);break;case 1:var r=t.stateNode;if(4&t.flags&&!Qa)if(null===n)r.componentDidMount();else{var i=t.elementType===t.type?n.memoizedProps:gs(t.type,n.memoizedProps);r.componentDidUpdate(i,n.memoizedState,r.__reactInternalSnapshotBeforeUpdate)}var o=t.updateQueue;null!==o&&qs(t,o,r);break;case 3:var a=t.updateQueue;if(null!==a){if(n=null,null!==t.child)switch(t.child.tag){case 5:case 1:n=t.child.stateNode}qs(t,a,n)}break;case 5:var c=t.stateNode;if(null===n&&4&t.flags){n=c;var l=t.memoizedProps;switch(t.type){case"button":case"input":case"select":case"textarea":l.autoFocus&&n.focus();break;case"img":l.src&&(n.src=l.src)}}break;case 6:case 4:case 12:case 19:case 17:case 21:case 22:case 23:case 25:break;case 13:if(null===t.memoizedState){var u=t.alternate;if(null!==u){var h=u.memoizedState;if(null!==h){var d=h.dehydrated;null!==d&&Ut(d)}}}break;default:throw Error(s(163))}Qa||512&t.flags&&sc(t)}catch(f){Tl(t,t.return,f)}}if(t===e){Ya=null;break}if(null!==(n=t.sibling)){n.return=t.return,Ya=n;break}Ya=t.return}}function Cc(e){for(;null!==Ya;){var t=Ya;if(t===e){Ya=null;break}var n=t.sibling;if(null!==n){n.return=t.return,Ya=n;break}Ya=t.return}}function xc(e){for(;null!==Ya;){var t=Ya;try{switch(t.tag){case 0:case 11:case 15:var n=t.return;try{ic(4,t)}catch(c){Tl(t,n,c)}break;case 1:var r=t.stateNode;if("function"===typeof r.componentDidMount){var i=t.return;try{r.componentDidMount()}catch(c){Tl(t,i,c)}}var s=t.return;try{sc(t)}catch(c){Tl(t,s,c)}break;case 5:var o=t.return;try{sc(t)}catch(c){Tl(t,o,c)}}}catch(c){Tl(t,t.return,c)}if(t===e){Ya=null;break}var a=t.sibling;if(null!==a){a.return=t.return,Ya=a;break}Ya=t.return}}var Ec,Tc=Math.ceil,kc=S.ReactCurrentDispatcher,Nc=S.ReactCurrentOwner,Fc=S.ReactCurrentBatchConfig,Ic=0,Ac=null,Dc=null,Oc=0,Pc=0,Rc=Ei(0),Mc=0,Bc=null,Lc=0,qc=0,_c=0,jc=null,zc=null,Uc=0,Hc=1/0,Vc=null,Kc=!1,Gc=null,Wc=null,Jc=!1,Zc=null,$c=0,Qc=0,Xc=null,Yc=-1,el=0;function tl(){return 0!==(6&Ic)?Qe():-1!==Yc?Yc:Yc=Qe()}function nl(e){return 0===(1&e.mode)?1:0!==(2&Ic)&&0!==Oc?Oc&-Oc:null!==ms.transition?(0===el&&(el=mt()),el):0!==(e=bt)?e:e=void 0===(e=window.event)?16:$t(e.type)}function rl(e,t,n,r){if(50<Qc)throw Qc=0,Xc=null,Error(s(185));vt(e,n,r),0!==(2&Ic)&&e===Ac||(e===Ac&&(0===(2&Ic)&&(qc|=n),4===Mc&&cl(e,Oc)),il(e,r),1===n&&0===Ic&&0===(1&t.mode)&&(Hc=Qe()+500,_i&&Ui()))}function il(e,t){var n=e.callbackNode;!function(e,t){for(var n=e.suspendedLanes,r=e.pingedLanes,i=e.expirationTimes,s=e.pendingLanes;0<s;){var o=31-ot(s),a=1<<o,c=i[o];-1===c?0!==(a&n)&&0===(a&r)||(i[o]=ft(a,t)):c<=t&&(e.expiredLanes|=a),s&=~a}}(e,t);var r=dt(e,e===Ac?Oc:0);if(0===r)null!==n&&Je(n),e.callbackNode=null,e.callbackPriority=0;else if(t=r&-r,e.callbackPriority!==t){if(null!=n&&Je(n),1===t)0===e.tag?function(e){_i=!0,zi(e)}(ll.bind(null,e)):zi(ll.bind(null,e)),oi((function(){0===(6&Ic)&&Ui()})),n=null;else{switch(St(r)){case 1:n=Ye;break;case 4:n=et;break;case 16:default:n=tt;break;case 536870912:n=rt}n=Al(n,sl.bind(null,e))}e.callbackPriority=t,e.callbackNode=n}}function sl(e,t){if(Yc=-1,el=0,0!==(6&Ic))throw Error(s(327));var n=e.callbackNode;if(xl()&&e.callbackNode!==n)return null;var r=dt(e,e===Ac?Oc:0);if(0===r)return null;if(0!==(30&r)||0!==(r&e.expiredLanes)||t)t=vl(e,r);else{t=r;var i=Ic;Ic|=2;var o=ml();for(Ac===e&&Oc===t||(Vc=null,Hc=Qe()+500,fl(e,t));;)try{bl();break}catch(c){pl(e,c)}ws(),kc.current=o,Ic=i,null!==Dc?t=0:(Ac=null,Oc=0,t=Mc)}if(0!==t){if(2===t&&(0!==(i=pt(e))&&(r=i,t=ol(e,i))),1===t)throw n=Bc,fl(e,0),cl(e,r),il(e,Qe()),n;if(6===t)cl(e,r);else{if(i=e.current.alternate,0===(30&r)&&!function(e){for(var t=e;;){if(16384&t.flags){var n=t.updateQueue;if(null!==n&&null!==(n=n.stores))for(var r=0;r<n.length;r++){var i=n[r],s=i.getSnapshot;i=i.value;try{if(!ar(s(),i))return!1}catch(a){return!1}}}if(n=t.child,16384&t.subtreeFlags&&null!==n)n.return=t,t=n;else{if(t===e)break;for(;null===t.sibling;){if(null===t.return||t.return===e)return!0;t=t.return}t.sibling.return=t.return,t=t.sibling}}return!0}(i)&&(2===(t=vl(e,r))&&(0!==(o=pt(e))&&(r=o,t=ol(e,o))),1===t))throw n=Bc,fl(e,0),cl(e,r),il(e,Qe()),n;switch(e.finishedWork=i,e.finishedLanes=r,t){case 0:case 1:throw Error(s(345));case 2:case 5:Cl(e,zc,Vc);break;case 3:if(cl(e,r),(130023424&r)===r&&10<(t=Uc+500-Qe())){if(0!==dt(e,0))break;if(((i=e.suspendedLanes)&r)!==r){tl(),e.pingedLanes|=e.suspendedLanes&i;break}e.timeoutHandle=ri(Cl.bind(null,e,zc,Vc),t);break}Cl(e,zc,Vc);break;case 4:if(cl(e,r),(4194240&r)===r)break;for(t=e.eventTimes,i=-1;0<r;){var a=31-ot(r);o=1<<a,(a=t[a])>i&&(i=a),r&=~o}if(r=i,10<(r=(120>(r=Qe()-r)?120:480>r?480:1080>r?1080:1920>r?1920:3e3>r?3e3:4320>r?4320:1960*Tc(r/1960))-r)){e.timeoutHandle=ri(Cl.bind(null,e,zc,Vc),r);break}Cl(e,zc,Vc);break;default:throw Error(s(329))}}}return il(e,Qe()),e.callbackNode===n?sl.bind(null,e):null}function ol(e,t){var n=jc;return e.current.memoizedState.isDehydrated&&(fl(e,t).flags|=256),2!==(e=vl(e,t))&&(t=zc,zc=n,null!==t&&al(t)),e}function al(e){null===zc?zc=e:zc.push.apply(zc,e)}function cl(e,t){for(t&=~_c,t&=~qc,e.suspendedLanes|=t,e.pingedLanes&=~t,e=e.expirationTimes;0<t;){var n=31-ot(t),r=1<<n;e[n]=-1,t&=~r}}function ll(e){if(0!==(6&Ic))throw Error(s(327));xl();var t=dt(e,0);if(0===(1&t))return il(e,Qe()),null;var n=vl(e,t);if(0!==e.tag&&2===n){var r=pt(e);0!==r&&(t=r,n=ol(e,r))}if(1===n)throw n=Bc,fl(e,0),cl(e,t),il(e,Qe()),n;if(6===n)throw Error(s(345));return e.finishedWork=e.current.alternate,e.finishedLanes=t,Cl(e,zc,Vc),il(e,Qe()),null}function ul(e,t){var n=Ic;Ic|=1;try{return e(t)}finally{0===(Ic=n)&&(Hc=Qe()+500,_i&&Ui())}}function hl(e){null!==Zc&&0===Zc.tag&&0===(6&Ic)&&xl();var t=Ic;Ic|=1;var n=Fc.transition,r=bt;try{if(Fc.transition=null,bt=1,e)return e()}finally{bt=r,Fc.transition=n,0===(6&(Ic=t))&&Ui()}}function dl(){Pc=Rc.current,Ti(Rc)}function fl(e,t){e.finishedWork=null,e.finishedLanes=0;var n=e.timeoutHandle;if(-1!==n&&(e.timeoutHandle=-1,ii(n)),null!==Dc)for(n=Dc.return;null!==n;){var r=n;switch(ts(r),r.tag){case 1:null!==(r=r.type.childContextTypes)&&void 0!==r&&Pi();break;case 3:io(),Ti(Ii),Ti(Fi),uo();break;case 5:oo(r);break;case 4:io();break;case 13:case 19:Ti(ao);break;case 10:Cs(r.type._context);break;case 22:case 23:dl()}n=n.return}if(Ac=e,Dc=e=Rl(e.current,null),Oc=Pc=t,Mc=0,Bc=null,_c=qc=Lc=0,zc=jc=null,null!==ks){for(t=0;t<ks.length;t++)if(null!==(r=(n=ks[t]).interleaved)){n.interleaved=null;var i=r.next,s=n.pending;if(null!==s){var o=s.next;s.next=i,r.next=o}n.pending=r}ks=null}return e}function pl(e,t){for(;;){var n=Dc;try{if(ws(),ho.current=oa,yo){for(var r=mo.memoizedState;null!==r;){var i=r.queue;null!==i&&(i.pending=null),r=r.next}yo=!1}if(po=0,vo=go=mo=null,bo=!1,So=0,Nc.current=null,null===n||null===n.return){Mc=1,Bc=t,Dc=null;break}e:{var o=e,a=n.return,c=n,l=t;if(t=Oc,c.flags|=32768,null!==l&&"object"===typeof l&&"function"===typeof l.then){var u=l,h=c,d=h.tag;if(0===(1&h.mode)&&(0===d||11===d||15===d)){var f=h.alternate;f?(h.updateQueue=f.updateQueue,h.memoizedState=f.memoizedState,h.lanes=f.lanes):(h.updateQueue=null,h.memoizedState=null)}var p=va(a);if(null!==p){p.flags&=-257,ya(p,a,c,0,t),1&p.mode&&ga(o,u,t),l=u;var m=(t=p).updateQueue;if(null===m){var g=new Set;g.add(l),t.updateQueue=g}else m.add(l);break e}if(0===(1&t)){ga(o,u,t),gl();break e}l=Error(s(426))}else if(is&&1&c.mode){var v=va(a);if(null!==v){0===(65536&v.flags)&&(v.flags|=256),ya(v,a,c,0,t),ps(ua(l,c));break e}}o=l=ua(l,c),4!==Mc&&(Mc=2),null===jc?jc=[o]:jc.push(o),o=a;do{switch(o.tag){case 3:o.flags|=65536,t&=-t,o.lanes|=t,Bs(o,pa(0,l,t));break e;case 1:c=l;var y=o.type,b=o.stateNode;if(0===(128&o.flags)&&("function"===typeof y.getDerivedStateFromError||null!==b&&"function"===typeof b.componentDidCatch&&(null===Wc||!Wc.has(b)))){o.flags|=65536,t&=-t,o.lanes|=t,Bs(o,ma(o,c,t));break e}}o=o.return}while(null!==o)}wl(n)}catch(S){t=S,Dc===n&&null!==n&&(Dc=n=n.return);continue}break}}function ml(){var e=kc.current;return kc.current=oa,null===e?oa:e}function gl(){0!==Mc&&3!==Mc&&2!==Mc||(Mc=4),null===Ac||0===(268435455&Lc)&&0===(268435455&qc)||cl(Ac,Oc)}function vl(e,t){var n=Ic;Ic|=2;var r=ml();for(Ac===e&&Oc===t||(Vc=null,fl(e,t));;)try{yl();break}catch(i){pl(e,i)}if(ws(),Ic=n,kc.current=r,null!==Dc)throw Error(s(261));return Ac=null,Oc=0,Mc}function yl(){for(;null!==Dc;)Sl(Dc)}function bl(){for(;null!==Dc&&!Ze();)Sl(Dc)}function Sl(e){var t=Ec(e.alternate,e,Pc);e.memoizedProps=e.pendingProps,null===t?wl(e):Dc=t,Nc.current=null}function wl(e){var t=e;do{var n=t.alternate;if(e=t.return,0===(32768&t.flags)){if(null!==(n=Ja(n,t,Pc)))return void(Dc=n)}else{if(null!==(n=Za(n,t)))return n.flags&=32767,void(Dc=n);if(null===e)return Mc=6,void(Dc=null);e.flags|=32768,e.subtreeFlags=0,e.deletions=null}if(null!==(t=t.sibling))return void(Dc=t);Dc=t=e}while(null!==t);0===Mc&&(Mc=5)}function Cl(e,t,n){var r=bt,i=Fc.transition;try{Fc.transition=null,bt=1,function(e,t,n,r){do{xl()}while(null!==Zc);if(0!==(6&Ic))throw Error(s(327));n=e.finishedWork;var i=e.finishedLanes;if(null===n)return null;if(e.finishedWork=null,e.finishedLanes=0,n===e.current)throw Error(s(177));e.callbackNode=null,e.callbackPriority=0;var o=n.lanes|n.childLanes;if(function(e,t){var n=e.pendingLanes&~t;e.pendingLanes=t,e.suspendedLanes=0,e.pingedLanes=0,e.expiredLanes&=t,e.mutableReadLanes&=t,e.entangledLanes&=t,t=e.entanglements;var r=e.eventTimes;for(e=e.expirationTimes;0<n;){var i=31-ot(n),s=1<<i;t[i]=0,r[i]=-1,e[i]=-1,n&=~s}}(e,o),e===Ac&&(Dc=Ac=null,Oc=0),0===(2064&n.subtreeFlags)&&0===(2064&n.flags)||Jc||(Jc=!0,Al(tt,(function(){return xl(),null}))),o=0!==(15990&n.flags),0!==(15990&n.subtreeFlags)||o){o=Fc.transition,Fc.transition=null;var a=bt;bt=1;var c=Ic;Ic|=4,Nc.current=null,function(e,t){if(ei=Vt,fr(e=dr())){if("selectionStart"in e)var n={start:e.selectionStart,end:e.selectionEnd};else e:{var r=(n=(n=e.ownerDocument)&&n.defaultView||window).getSelection&&n.getSelection();if(r&&0!==r.rangeCount){n=r.anchorNode;var i=r.anchorOffset,o=r.focusNode;r=r.focusOffset;try{n.nodeType,o.nodeType}catch(w){n=null;break e}var a=0,c=-1,l=-1,u=0,h=0,d=e,f=null;t:for(;;){for(var p;d!==n||0!==i&&3!==d.nodeType||(c=a+i),d!==o||0!==r&&3!==d.nodeType||(l=a+r),3===d.nodeType&&(a+=d.nodeValue.length),null!==(p=d.firstChild);)f=d,d=p;for(;;){if(d===e)break t;if(f===n&&++u===i&&(c=a),f===o&&++h===r&&(l=a),null!==(p=d.nextSibling))break;f=(d=f).parentNode}d=p}n=-1===c||-1===l?null:{start:c,end:l}}else n=null}n=n||{start:0,end:0}}else n=null;for(ti={focusedElem:e,selectionRange:n},Vt=!1,Ya=t;null!==Ya;)if(e=(t=Ya).child,0!==(1028&t.subtreeFlags)&&null!==e)e.return=t,Ya=e;else for(;null!==Ya;){t=Ya;try{var m=t.alternate;if(0!==(1024&t.flags))switch(t.tag){case 0:case 11:case 15:case 5:case 6:case 4:case 17:break;case 1:if(null!==m){var g=m.memoizedProps,v=m.memoizedState,y=t.stateNode,b=y.getSnapshotBeforeUpdate(t.elementType===t.type?g:gs(t.type,g),v);y.__reactInternalSnapshotBeforeUpdate=b}break;case 3:var S=t.stateNode.containerInfo;1===S.nodeType?S.textContent="":9===S.nodeType&&S.documentElement&&S.removeChild(S.documentElement);break;default:throw Error(s(163))}}catch(w){Tl(t,t.return,w)}if(null!==(e=t.sibling)){e.return=t.return,Ya=e;break}Ya=t.return}m=nc,nc=!1}(e,n),vc(n,e),pr(ti),Vt=!!ei,ti=ei=null,e.current=n,bc(n,e,i),$e(),Ic=c,bt=a,Fc.transition=o}else e.current=n;if(Jc&&(Jc=!1,Zc=e,$c=i),o=e.pendingLanes,0===o&&(Wc=null),function(e){if(st&&"function"===typeof st.onCommitFiberRoot)try{st.onCommitFiberRoot(it,e,void 0,128===(128&e.current.flags))}catch(t){}}(n.stateNode),il(e,Qe()),null!==t)for(r=e.onRecoverableError,n=0;n<t.length;n++)i=t[n],r(i.value,{componentStack:i.stack,digest:i.digest});if(Kc)throw Kc=!1,e=Gc,Gc=null,e;0!==(1&$c)&&0!==e.tag&&xl(),o=e.pendingLanes,0!==(1&o)?e===Xc?Qc++:(Qc=0,Xc=e):Qc=0,Ui()}(e,t,n,r)}finally{Fc.transition=i,bt=r}return null}function xl(){if(null!==Zc){var e=St($c),t=Fc.transition,n=bt;try{if(Fc.transition=null,bt=16>e?16:e,null===Zc)var r=!1;else{if(e=Zc,Zc=null,$c=0,0!==(6&Ic))throw Error(s(331));var i=Ic;for(Ic|=4,Ya=e.current;null!==Ya;){var o=Ya,a=o.child;if(0!==(16&Ya.flags)){var c=o.deletions;if(null!==c){for(var l=0;l<c.length;l++){var u=c[l];for(Ya=u;null!==Ya;){var h=Ya;switch(h.tag){case 0:case 11:case 15:rc(8,h,o)}var d=h.child;if(null!==d)d.return=h,Ya=d;else for(;null!==Ya;){var f=(h=Ya).sibling,p=h.return;if(oc(h),h===u){Ya=null;break}if(null!==f){f.return=p,Ya=f;break}Ya=p}}}var m=o.alternate;if(null!==m){var g=m.child;if(null!==g){m.child=null;do{var v=g.sibling;g.sibling=null,g=v}while(null!==g)}}Ya=o}}if(0!==(2064&o.subtreeFlags)&&null!==a)a.return=o,Ya=a;else e:for(;null!==Ya;){if(0!==(2048&(o=Ya).flags))switch(o.tag){case 0:case 11:case 15:rc(9,o,o.return)}var y=o.sibling;if(null!==y){y.return=o.return,Ya=y;break e}Ya=o.return}}var b=e.current;for(Ya=b;null!==Ya;){var S=(a=Ya).child;if(0!==(2064&a.subtreeFlags)&&null!==S)S.return=a,Ya=S;else e:for(a=b;null!==Ya;){if(0!==(2048&(c=Ya).flags))try{switch(c.tag){case 0:case 11:case 15:ic(9,c)}}catch(C){Tl(c,c.return,C)}if(c===a){Ya=null;break e}var w=c.sibling;if(null!==w){w.return=c.return,Ya=w;break e}Ya=c.return}}if(Ic=i,Ui(),st&&"function"===typeof st.onPostCommitFiberRoot)try{st.onPostCommitFiberRoot(it,e)}catch(C){}r=!0}return r}finally{bt=n,Fc.transition=t}}return!1}function El(e,t,n){e=Rs(e,t=pa(0,t=ua(n,t),1),1),t=tl(),null!==e&&(vt(e,1,t),il(e,t))}function Tl(e,t,n){if(3===e.tag)El(e,e,n);else for(;null!==t;){if(3===t.tag){El(t,e,n);break}if(1===t.tag){var r=t.stateNode;if("function"===typeof t.type.getDerivedStateFromError||"function"===typeof r.componentDidCatch&&(null===Wc||!Wc.has(r))){t=Rs(t,e=ma(t,e=ua(n,e),1),1),e=tl(),null!==t&&(vt(t,1,e),il(t,e));break}}t=t.return}}function kl(e,t,n){var r=e.pingCache;null!==r&&r.delete(t),t=tl(),e.pingedLanes|=e.suspendedLanes&n,Ac===e&&(Oc&n)===n&&(4===Mc||3===Mc&&(130023424&Oc)===Oc&&500>Qe()-Uc?fl(e,0):_c|=n),il(e,t)}function Nl(e,t){0===t&&(0===(1&e.mode)?t=1:(t=ut,0===(130023424&(ut<<=1))&&(ut=4194304)));var n=tl();null!==(e=Is(e,t))&&(vt(e,t,n),il(e,n))}function Fl(e){var t=e.memoizedState,n=0;null!==t&&(n=t.retryLane),Nl(e,n)}function Il(e,t){var n=0;switch(e.tag){case 13:var r=e.stateNode,i=e.memoizedState;null!==i&&(n=i.retryLane);break;case 19:r=e.stateNode;break;default:throw Error(s(314))}null!==r&&r.delete(t),Nl(e,n)}function Al(e,t){return We(e,t)}function Dl(e,t,n,r){this.tag=e,this.key=n,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=t,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=r,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Ol(e,t,n,r){return new Dl(e,t,n,r)}function Pl(e){return!(!(e=e.prototype)||!e.isReactComponent)}function Rl(e,t){var n=e.alternate;return null===n?((n=Ol(e.tag,t,e.key,e.mode)).elementType=e.elementType,n.type=e.type,n.stateNode=e.stateNode,n.alternate=e,e.alternate=n):(n.pendingProps=t,n.type=e.type,n.flags=0,n.subtreeFlags=0,n.deletions=null),n.flags=14680064&e.flags,n.childLanes=e.childLanes,n.lanes=e.lanes,n.child=e.child,n.memoizedProps=e.memoizedProps,n.memoizedState=e.memoizedState,n.updateQueue=e.updateQueue,t=e.dependencies,n.dependencies=null===t?null:{lanes:t.lanes,firstContext:t.firstContext},n.sibling=e.sibling,n.index=e.index,n.ref=e.ref,n}function Ml(e,t,n,r,i,o){var a=2;if(r=e,"function"===typeof e)Pl(e)&&(a=1);else if("string"===typeof e)a=5;else e:switch(e){case x:return Bl(n.children,i,o,t);case E:a=8,i|=8;break;case T:return(e=Ol(12,n,t,2|i)).elementType=T,e.lanes=o,e;case I:return(e=Ol(13,n,t,i)).elementType=I,e.lanes=o,e;case A:return(e=Ol(19,n,t,i)).elementType=A,e.lanes=o,e;case P:return Ll(n,i,o,t);default:if("object"===typeof e&&null!==e)switch(e.$$typeof){case k:a=10;break e;case N:a=9;break e;case F:a=11;break e;case D:a=14;break e;case O:a=16,r=null;break e}throw Error(s(130,null==e?e:typeof e,""))}return(t=Ol(a,n,t,i)).elementType=e,t.type=r,t.lanes=o,t}function Bl(e,t,n,r){return(e=Ol(7,e,r,t)).lanes=n,e}function Ll(e,t,n,r){return(e=Ol(22,e,r,t)).elementType=P,e.lanes=n,e.stateNode={isHidden:!1},e}function ql(e,t,n){return(e=Ol(6,e,null,t)).lanes=n,e}function _l(e,t,n){return(t=Ol(4,null!==e.children?e.children:[],e.key,t)).lanes=n,t.stateNode={containerInfo:e.containerInfo,pendingChildren:null,implementation:e.implementation},t}function jl(e,t,n,r,i){this.tag=t,this.containerInfo=e,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=gt(0),this.expirationTimes=gt(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=gt(0),this.identifierPrefix=r,this.onRecoverableError=i,this.mutableSourceEagerHydrationData=null}function zl(e,t,n,r,i,s,o,a,c){return e=new jl(e,t,n,a,c),1===t?(t=1,!0===s&&(t|=8)):t=0,s=Ol(3,null,null,t),e.current=s,s.stateNode=e,s.memoizedState={element:r,isDehydrated:n,cache:null,transitions:null,pendingSuspenseBoundaries:null},Ds(s),e}function Ul(e){if(!e)return Ni;e:{if(Ue(e=e._reactInternals)!==e||1!==e.tag)throw Error(s(170));var t=e;do{switch(t.tag){case 3:t=t.stateNode.context;break e;case 1:if(Oi(t.type)){t=t.stateNode.__reactInternalMemoizedMergedChildContext;break e}}t=t.return}while(null!==t);throw Error(s(171))}if(1===e.tag){var n=e.type;if(Oi(n))return Mi(e,n,t)}return t}function Hl(e,t,n,r,i,s,o,a,c){return(e=zl(n,r,!0,e,0,s,0,a,c)).context=Ul(null),n=e.current,(s=Ps(r=tl(),i=nl(n))).callback=void 0!==t&&null!==t?t:null,Rs(n,s,i),e.current.lanes=i,vt(e,i,r),il(e,r),e}function Vl(e,t,n,r){var i=t.current,s=tl(),o=nl(i);return n=Ul(n),null===t.context?t.context=n:t.pendingContext=n,(t=Ps(s,o)).payload={element:e},null!==(r=void 0===r?null:r)&&(t.callback=r),null!==(e=Rs(i,t,o))&&(rl(e,i,o,s),Ms(e,i,o)),o}function Kl(e){return(e=e.current).child?(e.child.tag,e.child.stateNode):null}function Gl(e,t){if(null!==(e=e.memoizedState)&&null!==e.dehydrated){var n=e.retryLane;e.retryLane=0!==n&&n<t?n:t}}function Wl(e,t){Gl(e,t),(e=e.alternate)&&Gl(e,t)}Ec=function(e,t,n){if(null!==e)if(e.memoizedProps!==t.pendingProps||Ii.current)Sa=!0;else{if(0===(e.lanes&n)&&0===(128&t.flags))return Sa=!1,function(e,t,n){switch(t.tag){case 3:Aa(t),fs();break;case 5:so(t);break;case 1:Oi(t.type)&&Bi(t);break;case 4:ro(t,t.stateNode.containerInfo);break;case 10:var r=t.type._context,i=t.memoizedProps.value;ki(vs,r._currentValue),r._currentValue=i;break;case 13:if(null!==(r=t.memoizedState))return null!==r.dehydrated?(ki(ao,1&ao.current),t.flags|=128,null):0!==(n&t.child.childLanes)?qa(e,t,n):(ki(ao,1&ao.current),null!==(e=Ka(e,t,n))?e.sibling:null);ki(ao,1&ao.current);break;case 19:if(r=0!==(n&t.childLanes),0!==(128&e.flags)){if(r)return Ha(e,t,n);t.flags|=128}if(null!==(i=t.memoizedState)&&(i.rendering=null,i.tail=null,i.lastEffect=null),ki(ao,ao.current),r)break;return null;case 22:case 23:return t.lanes=0,Ta(e,t,n)}return Ka(e,t,n)}(e,t,n);Sa=0!==(131072&e.flags)}else Sa=!1,is&&0!==(1048576&t.flags)&&Yi(t,Gi,t.index);switch(t.lanes=0,t.tag){case 2:var r=t.type;Va(e,t),e=t.pendingProps;var i=Di(t,Fi.current);Es(t,n),i=Eo(null,t,r,e,i,n);var o=To();return t.flags|=1,"object"===typeof i&&null!==i&&"function"===typeof i.render&&void 0===i.$$typeof?(t.tag=1,t.memoizedState=null,t.updateQueue=null,Oi(r)?(o=!0,Bi(t)):o=!1,t.memoizedState=null!==i.state&&void 0!==i.state?i.state:null,Ds(t),i.updater=zs,t.stateNode=i,i._reactInternals=t,Ks(t,r,e,n),t=Ia(null,t,r,!0,o,n)):(t.tag=0,is&&o&&es(t),wa(null,t,i,n),t=t.child),t;case 16:r=t.elementType;e:{switch(Va(e,t),e=t.pendingProps,r=(i=r._init)(r._payload),t.type=r,i=t.tag=function(e){if("function"===typeof e)return Pl(e)?1:0;if(void 0!==e&&null!==e){if((e=e.$$typeof)===F)return 11;if(e===D)return 14}return 2}(r),e=gs(r,e),i){case 0:t=Na(null,t,r,e,n);break e;case 1:t=Fa(null,t,r,e,n);break e;case 11:t=Ca(null,t,r,e,n);break e;case 14:t=xa(null,t,r,gs(r.type,e),n);break e}throw Error(s(306,r,""))}return t;case 0:return r=t.type,i=t.pendingProps,Na(e,t,r,i=t.elementType===r?i:gs(r,i),n);case 1:return r=t.type,i=t.pendingProps,Fa(e,t,r,i=t.elementType===r?i:gs(r,i),n);case 3:e:{if(Aa(t),null===e)throw Error(s(387));r=t.pendingProps,i=(o=t.memoizedState).element,Os(e,t),Ls(t,r,null,n);var a=t.memoizedState;if(r=a.element,o.isDehydrated){if(o={element:r,isDehydrated:!1,cache:a.cache,pendingSuspenseBoundaries:a.pendingSuspenseBoundaries,transitions:a.transitions},t.updateQueue.baseState=o,t.memoizedState=o,256&t.flags){t=Da(e,t,r,n,i=ua(Error(s(423)),t));break e}if(r!==i){t=Da(e,t,r,n,i=ua(Error(s(424)),t));break e}for(rs=li(t.stateNode.containerInfo.firstChild),ns=t,is=!0,ss=null,n=Qs(t,null,r,n),t.child=n;n;)n.flags=-3&n.flags|4096,n=n.sibling}else{if(fs(),r===i){t=Ka(e,t,n);break e}wa(e,t,r,n)}t=t.child}return t;case 5:return so(t),null===e&&ls(t),r=t.type,i=t.pendingProps,o=null!==e?e.memoizedProps:null,a=i.children,ni(r,i)?a=null:null!==o&&ni(r,o)&&(t.flags|=32),ka(e,t),wa(e,t,a,n),t.child;case 6:return null===e&&ls(t),null;case 13:return qa(e,t,n);case 4:return ro(t,t.stateNode.containerInfo),r=t.pendingProps,null===e?t.child=$s(t,null,r,n):wa(e,t,r,n),t.child;case 11:return r=t.type,i=t.pendingProps,Ca(e,t,r,i=t.elementType===r?i:gs(r,i),n);case 7:return wa(e,t,t.pendingProps,n),t.child;case 8:case 12:return wa(e,t,t.pendingProps.children,n),t.child;case 10:e:{if(r=t.type._context,i=t.pendingProps,o=t.memoizedProps,a=i.value,ki(vs,r._currentValue),r._currentValue=a,null!==o)if(ar(o.value,a)){if(o.children===i.children&&!Ii.current){t=Ka(e,t,n);break e}}else for(null!==(o=t.child)&&(o.return=t);null!==o;){var c=o.dependencies;if(null!==c){a=o.child;for(var l=c.firstContext;null!==l;){if(l.context===r){if(1===o.tag){(l=Ps(-1,n&-n)).tag=2;var u=o.updateQueue;if(null!==u){var h=(u=u.shared).pending;null===h?l.next=l:(l.next=h.next,h.next=l),u.pending=l}}o.lanes|=n,null!==(l=o.alternate)&&(l.lanes|=n),xs(o.return,n,t),c.lanes|=n;break}l=l.next}}else if(10===o.tag)a=o.type===t.type?null:o.child;else if(18===o.tag){if(null===(a=o.return))throw Error(s(341));a.lanes|=n,null!==(c=a.alternate)&&(c.lanes|=n),xs(a,n,t),a=o.sibling}else a=o.child;if(null!==a)a.return=o;else for(a=o;null!==a;){if(a===t){a=null;break}if(null!==(o=a.sibling)){o.return=a.return,a=o;break}a=a.return}o=a}wa(e,t,i.children,n),t=t.child}return t;case 9:return i=t.type,r=t.pendingProps.children,Es(t,n),r=r(i=Ts(i)),t.flags|=1,wa(e,t,r,n),t.child;case 14:return i=gs(r=t.type,t.pendingProps),xa(e,t,r,i=gs(r.type,i),n);case 15:return Ea(e,t,t.type,t.pendingProps,n);case 17:return r=t.type,i=t.pendingProps,i=t.elementType===r?i:gs(r,i),Va(e,t),t.tag=1,Oi(r)?(e=!0,Bi(t)):e=!1,Es(t,n),Hs(t,r,i),Ks(t,r,i,n),Ia(null,t,r,!0,e,n);case 19:return Ha(e,t,n);case 22:return Ta(e,t,n)}throw Error(s(156,t.tag))};var Jl="function"===typeof reportError?reportError:function(e){console.error(e)};function Zl(e){this._internalRoot=e}function $l(e){this._internalRoot=e}function Ql(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType)}function Xl(e){return!(!e||1!==e.nodeType&&9!==e.nodeType&&11!==e.nodeType&&(8!==e.nodeType||" react-mount-point-unstable "!==e.nodeValue))}function Yl(){}function eu(e,t,n,r,i){var s=n._reactRootContainer;if(s){var o=s;if("function"===typeof i){var a=i;i=function(){var e=Kl(o);a.call(e)}}Vl(t,o,e,i)}else o=function(e,t,n,r,i){if(i){if("function"===typeof r){var s=r;r=function(){var e=Kl(o);s.call(e)}}var o=Hl(t,r,e,0,null,!1,0,"",Yl);return e._reactRootContainer=o,e[pi]=o.current,Ur(8===e.nodeType?e.parentNode:e),hl(),o}for(;i=e.lastChild;)e.removeChild(i);if("function"===typeof r){var a=r;r=function(){var e=Kl(c);a.call(e)}}var c=zl(e,0,!1,null,0,!1,0,"",Yl);return e._reactRootContainer=c,e[pi]=c.current,Ur(8===e.nodeType?e.parentNode:e),hl((function(){Vl(t,c,n,r)})),c}(n,t,e,i,r);return Kl(o)}$l.prototype.render=Zl.prototype.render=function(e){var t=this._internalRoot;if(null===t)throw Error(s(409));Vl(e,t,null,null)},$l.prototype.unmount=Zl.prototype.unmount=function(){var e=this._internalRoot;if(null!==e){this._internalRoot=null;var t=e.containerInfo;hl((function(){Vl(null,e,null,null)})),t[pi]=null}},$l.prototype.unstable_scheduleHydration=function(e){if(e){var t=Et();e={blockedOn:null,target:e,priority:t};for(var n=0;n<Pt.length&&0!==t&&t<Pt[n].priority;n++);Pt.splice(n,0,e),0===n&&Lt(e)}},wt=function(e){switch(e.tag){case 3:var t=e.stateNode;if(t.current.memoizedState.isDehydrated){var n=ht(t.pendingLanes);0!==n&&(yt(t,1|n),il(t,Qe()),0===(6&Ic)&&(Hc=Qe()+500,Ui()))}break;case 13:hl((function(){var t=Is(e,1);if(null!==t){var n=tl();rl(t,e,1,n)}})),Wl(e,1)}},Ct=function(e){if(13===e.tag){var t=Is(e,134217728);if(null!==t)rl(t,e,134217728,tl());Wl(e,134217728)}},xt=function(e){if(13===e.tag){var t=nl(e),n=Is(e,t);if(null!==n)rl(n,e,t,tl());Wl(e,t)}},Et=function(){return bt},Tt=function(e,t){var n=bt;try{return bt=e,t()}finally{bt=n}},Ce=function(e,t,n){switch(t){case"input":if(X(e,n),t=n.name,"radio"===n.type&&null!=t){for(n=e;n.parentNode;)n=n.parentNode;for(n=n.querySelectorAll("input[name="+JSON.stringify(""+t)+'][type="radio"]'),t=0;t<n.length;t++){var r=n[t];if(r!==e&&r.form===e.form){var i=wi(r);if(!i)throw Error(s(90));W(r),X(r,i)}}}break;case"textarea":se(e,n);break;case"select":null!=(t=n.value)&&ne(e,!!n.multiple,t,!1)}},Fe=ul,Ie=hl;var tu={usingClientEntryPoint:!1,Events:[bi,Si,wi,ke,Ne,ul]},nu={findFiberByHostInstance:yi,bundleType:0,version:"18.2.0",rendererPackageName:"react-dom"},ru={bundleType:nu.bundleType,version:nu.version,rendererPackageName:nu.rendererPackageName,rendererConfig:nu.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:S.ReactCurrentDispatcher,findHostInstanceByFiber:function(e){return null===(e=Ke(e))?null:e.stateNode},findFiberByHostInstance:nu.findFiberByHostInstance||function(){return null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.2.0-next-9e3b772b8-20220608"};if("undefined"!==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__){var iu=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!iu.isDisabled&&iu.supportsFiber)try{it=iu.inject(ru),st=iu}catch(ue){}}t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=tu,t.createPortal=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(!Ql(t))throw Error(s(200));return function(e,t,n){var r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:C,key:null==r?null:""+r,children:e,containerInfo:t,implementation:n}}(e,t,null,n)},t.createRoot=function(e,t){if(!Ql(e))throw Error(s(299));var n=!1,r="",i=Jl;return null!==t&&void 0!==t&&(!0===t.unstable_strictMode&&(n=!0),void 0!==t.identifierPrefix&&(r=t.identifierPrefix),void 0!==t.onRecoverableError&&(i=t.onRecoverableError)),t=zl(e,1,!1,null,0,n,0,r,i),e[pi]=t.current,Ur(8===e.nodeType?e.parentNode:e),new Zl(t)},t.findDOMNode=function(e){if(null==e)return null;if(1===e.nodeType)return e;var t=e._reactInternals;if(void 0===t){if("function"===typeof e.render)throw Error(s(188));throw e=Object.keys(e).join(","),Error(s(268,e))}return e=null===(e=Ke(t))?null:e.stateNode},t.flushSync=function(e){return hl(e)},t.hydrate=function(e,t,n){if(!Xl(t))throw Error(s(200));return eu(null,e,t,!0,n)},t.hydrateRoot=function(e,t,n){if(!Ql(e))throw Error(s(405));var r=null!=n&&n.hydratedSources||null,i=!1,o="",a=Jl;if(null!==n&&void 0!==n&&(!0===n.unstable_strictMode&&(i=!0),void 0!==n.identifierPrefix&&(o=n.identifierPrefix),void 0!==n.onRecoverableError&&(a=n.onRecoverableError)),t=Hl(t,null,e,1,null!=n?n:null,i,0,o,a),e[pi]=t.current,Ur(e),r)for(e=0;e<r.length;e++)i=(i=(n=r[e])._getVersion)(n._source),null==t.mutableSourceEagerHydrationData?t.mutableSourceEagerHydrationData=[n,i]:t.mutableSourceEagerHydrationData.push(n,i);return new $l(t)},t.render=function(e,t,n){if(!Xl(t))throw Error(s(200));return eu(null,e,t,!1,n)},t.unmountComponentAtNode=function(e){if(!Xl(e))throw Error(s(40));return!!e._reactRootContainer&&(hl((function(){eu(null,null,e,!1,(function(){e._reactRootContainer=null,e[pi]=null}))})),!0)},t.unstable_batchedUpdates=ul,t.unstable_renderSubtreeIntoContainer=function(e,t,n,r){if(!Xl(n))throw Error(s(200));if(null==e||void 0===e._reactInternals)throw Error(s(38));return eu(e,t,n,!1,r)},t.version="18.2.0-next-9e3b772b8-20220608"},4391:(e,t,n)=>{"use strict";var r=n(7950);t.createRoot=r.createRoot,t.hydrateRoot=r.hydrateRoot},7950:(e,t,n)=>{"use strict";!function e(){if("undefined"!==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE)try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(e)}catch(t){console.error(t)}}(),e.exports=n(2730)},1153:(e,t,n)=>{"use strict";var r=n(5043),i=Symbol.for("react.element"),s=Symbol.for("react.fragment"),o=Object.prototype.hasOwnProperty,a=r.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function l(e,t,n){var r,s={},l=null,u=null;for(r in void 0!==n&&(l=""+n),void 0!==t.key&&(l=""+t.key),void 0!==t.ref&&(u=t.ref),t)o.call(t,r)&&!c.hasOwnProperty(r)&&(s[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps)void 0===s[r]&&(s[r]=t[r]);return{$$typeof:i,type:e,key:l,ref:u,props:s,_owner:a.current}}t.jsx=l,t.jsxs=l},4202:(e,t)=>{"use strict";var n=Symbol.for("react.element"),r=Symbol.for("react.portal"),i=Symbol.for("react.fragment"),s=Symbol.for("react.strict_mode"),o=Symbol.for("react.profiler"),a=Symbol.for("react.provider"),c=Symbol.for("react.context"),l=Symbol.for("react.forward_ref"),u=Symbol.for("react.suspense"),h=Symbol.for("react.memo"),d=Symbol.for("react.lazy"),f=Symbol.iterator;var p={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},m=Object.assign,g={};function v(e,t,n){this.props=e,this.context=t,this.refs=g,this.updater=n||p}function y(){}function b(e,t,n){this.props=e,this.context=t,this.refs=g,this.updater=n||p}v.prototype.isReactComponent={},v.prototype.setState=function(e,t){if("object"!==typeof e&&"function"!==typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},v.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},y.prototype=v.prototype;var S=b.prototype=new y;S.constructor=b,m(S,v.prototype),S.isPureReactComponent=!0;var w=Array.isArray,C=Object.prototype.hasOwnProperty,x={current:null},E={key:!0,ref:!0,__self:!0,__source:!0};function T(e,t,r){var i,s={},o=null,a=null;if(null!=t)for(i in void 0!==t.ref&&(a=t.ref),void 0!==t.key&&(o=""+t.key),t)C.call(t,i)&&!E.hasOwnProperty(i)&&(s[i]=t[i]);var c=arguments.length-2;if(1===c)s.children=r;else if(1<c){for(var l=Array(c),u=0;u<c;u++)l[u]=arguments[u+2];s.children=l}if(e&&e.defaultProps)for(i in c=e.defaultProps)void 0===s[i]&&(s[i]=c[i]);return{$$typeof:n,type:e,key:o,ref:a,props:s,_owner:x.current}}function k(e){return"object"===typeof e&&null!==e&&e.$$typeof===n}var N=/\/+/g;function F(e,t){return"object"===typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function I(e,t,i,s,o){var a=typeof e;"undefined"!==a&&"boolean"!==a||(e=null);var c=!1;if(null===e)c=!0;else switch(a){case"string":case"number":c=!0;break;case"object":switch(e.$$typeof){case n:case r:c=!0}}if(c)return o=o(c=e),e=""===s?"."+F(c,0):s,w(o)?(i="",null!=e&&(i=e.replace(N,"$&/")+"/"),I(o,t,i,"",(function(e){return e}))):null!=o&&(k(o)&&(o=function(e,t){return{$$typeof:n,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}(o,i+(!o.key||c&&c.key===o.key?"":(""+o.key).replace(N,"$&/")+"/")+e)),t.push(o)),1;if(c=0,s=""===s?".":s+":",w(e))for(var l=0;l<e.length;l++){var u=s+F(a=e[l],l);c+=I(a,t,i,u,o)}else if(u=function(e){return null===e||"object"!==typeof e?null:"function"===typeof(e=f&&e[f]||e["@@iterator"])?e:null}(e),"function"===typeof u)for(e=u.call(e),l=0;!(a=e.next()).done;)c+=I(a=a.value,t,i,u=s+F(a,l++),o);else if("object"===a)throw t=String(e),Error("Objects are not valid as a React child (found: "+("[object Object]"===t?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.");return c}function A(e,t,n){if(null==e)return e;var r=[],i=0;return I(e,r,"","",(function(e){return t.call(n,e,i++)})),r}function D(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var O={current:null},P={transition:null},R={ReactCurrentDispatcher:O,ReactCurrentBatchConfig:P,ReactCurrentOwner:x};t.Children={map:A,forEach:function(e,t,n){A(e,(function(){t.apply(this,arguments)}),n)},count:function(e){var t=0;return A(e,(function(){t++})),t},toArray:function(e){return A(e,(function(e){return e}))||[]},only:function(e){if(!k(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},t.Component=v,t.Fragment=i,t.Profiler=o,t.PureComponent=b,t.StrictMode=s,t.Suspense=u,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=R,t.cloneElement=function(e,t,r){if(null===e||void 0===e)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var i=m({},e.props),s=e.key,o=e.ref,a=e._owner;if(null!=t){if(void 0!==t.ref&&(o=t.ref,a=x.current),void 0!==t.key&&(s=""+t.key),e.type&&e.type.defaultProps)var c=e.type.defaultProps;for(l in t)C.call(t,l)&&!E.hasOwnProperty(l)&&(i[l]=void 0===t[l]&&void 0!==c?c[l]:t[l])}var l=arguments.length-2;if(1===l)i.children=r;else if(1<l){c=Array(l);for(var u=0;u<l;u++)c[u]=arguments[u+2];i.children=c}return{$$typeof:n,type:e.type,key:s,ref:o,props:i,_owner:a}},t.createContext=function(e){return(e={$$typeof:c,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:a,_context:e},e.Consumer=e},t.createElement=T,t.createFactory=function(e){var t=T.bind(null,e);return t.type=e,t},t.createRef=function(){return{current:null}},t.forwardRef=function(e){return{$$typeof:l,render:e}},t.isValidElement=k,t.lazy=function(e){return{$$typeof:d,_payload:{_status:-1,_result:e},_init:D}},t.memo=function(e,t){return{$$typeof:h,type:e,compare:void 0===t?null:t}},t.startTransition=function(e){var t=P.transition;P.transition={};try{e()}finally{P.transition=t}},t.unstable_act=function(){throw Error("act(...) is not supported in production builds of React.")},t.useCallback=function(e,t){return O.current.useCallback(e,t)},t.useContext=function(e){return O.current.useContext(e)},t.useDebugValue=function(){},t.useDeferredValue=function(e){return O.current.useDeferredValue(e)},t.useEffect=function(e,t){return O.current.useEffect(e,t)},t.useId=function(){return O.current.useId()},t.useImperativeHandle=function(e,t,n){return O.current.useImperativeHandle(e,t,n)},t.useInsertionEffect=function(e,t){return O.current.useInsertionEffect(e,t)},t.useLayoutEffect=function(e,t){return O.current.useLayoutEffect(e,t)},t.useMemo=function(e,t){return O.current.useMemo(e,t)},t.useReducer=function(e,t,n){return O.current.useReducer(e,t,n)},t.useRef=function(e){return O.current.useRef(e)},t.useState=function(e){return O.current.useState(e)},t.useSyncExternalStore=function(e,t,n){return O.current.useSyncExternalStore(e,t,n)},t.useTransition=function(){return O.current.useTransition()},t.version="18.2.0"},5043:(e,t,n)=>{"use strict";e.exports=n(4202)},579:(e,t,n)=>{"use strict";e.exports=n(1153)},1356:e=>{"use strict";e.exports=function(e,t){if(t=t.split(":")[0],!(e=+e))return!1;switch(t){case"http":case"ws":return 80!==e;case"https":case"wss":return 443!==e;case"ftp":return 21!==e;case"gopher":return 70!==e;case"file":return!1}return 0!==e}},7234:(e,t)=>{"use strict";function n(e,t){var n=e.length;e.push(t);e:for(;0<n;){var r=n-1>>>1,i=e[r];if(!(0<s(i,t)))break e;e[r]=t,e[n]=i,n=r}}function r(e){return 0===e.length?null:e[0]}function i(e){if(0===e.length)return null;var t=e[0],n=e.pop();if(n!==t){e[0]=n;e:for(var r=0,i=e.length,o=i>>>1;r<o;){var a=2*(r+1)-1,c=e[a],l=a+1,u=e[l];if(0>s(c,n))l<i&&0>s(u,c)?(e[r]=u,e[l]=n,r=l):(e[r]=c,e[a]=n,r=a);else{if(!(l<i&&0>s(u,n)))break e;e[r]=u,e[l]=n,r=l}}}return t}function s(e,t){var n=e.sortIndex-t.sortIndex;return 0!==n?n:e.id-t.id}if("object"===typeof performance&&"function"===typeof performance.now){var o=performance;t.unstable_now=function(){return o.now()}}else{var a=Date,c=a.now();t.unstable_now=function(){return a.now()-c}}var l=[],u=[],h=1,d=null,f=3,p=!1,m=!1,g=!1,v="function"===typeof setTimeout?setTimeout:null,y="function"===typeof clearTimeout?clearTimeout:null,b="undefined"!==typeof setImmediate?setImmediate:null;function S(e){for(var t=r(u);null!==t;){if(null===t.callback)i(u);else{if(!(t.startTime<=e))break;i(u),t.sortIndex=t.expirationTime,n(l,t)}t=r(u)}}function w(e){if(g=!1,S(e),!m)if(null!==r(l))m=!0,P(C);else{var t=r(u);null!==t&&R(w,t.startTime-e)}}function C(e,n){m=!1,g&&(g=!1,y(k),k=-1),p=!0;var s=f;try{for(S(n),d=r(l);null!==d&&(!(d.expirationTime>n)||e&&!I());){var o=d.callback;if("function"===typeof o){d.callback=null,f=d.priorityLevel;var a=o(d.expirationTime<=n);n=t.unstable_now(),"function"===typeof a?d.callback=a:d===r(l)&&i(l),S(n)}else i(l);d=r(l)}if(null!==d)var c=!0;else{var h=r(u);null!==h&&R(w,h.startTime-n),c=!1}return c}finally{d=null,f=s,p=!1}}"undefined"!==typeof navigator&&void 0!==navigator.scheduling&&void 0!==navigator.scheduling.isInputPending&&navigator.scheduling.isInputPending.bind(navigator.scheduling);var x,E=!1,T=null,k=-1,N=5,F=-1;function I(){return!(t.unstable_now()-F<N)}function A(){if(null!==T){var e=t.unstable_now();F=e;var n=!0;try{n=T(!0,e)}finally{n?x():(E=!1,T=null)}}else E=!1}if("function"===typeof b)x=function(){b(A)};else if("undefined"!==typeof MessageChannel){var D=new MessageChannel,O=D.port2;D.port1.onmessage=A,x=function(){O.postMessage(null)}}else x=function(){v(A,0)};function P(e){T=e,E||(E=!0,x())}function R(e,n){k=v((function(){e(t.unstable_now())}),n)}t.unstable_IdlePriority=5,t.unstable_ImmediatePriority=1,t.unstable_LowPriority=4,t.unstable_NormalPriority=3,t.unstable_Profiling=null,t.unstable_UserBlockingPriority=2,t.unstable_cancelCallback=function(e){e.callback=null},t.unstable_continueExecution=function(){m||p||(m=!0,P(C))},t.unstable_forceFrameRate=function(e){0>e||125<e?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):N=0<e?Math.floor(1e3/e):5},t.unstable_getCurrentPriorityLevel=function(){return f},t.unstable_getFirstCallbackNode=function(){return r(l)},t.unstable_next=function(e){switch(f){case 1:case 2:case 3:var t=3;break;default:t=f}var n=f;f=t;try{return e()}finally{f=n}},t.unstable_pauseExecution=function(){},t.unstable_requestPaint=function(){},t.unstable_runWithPriority=function(e,t){switch(e){case 1:case 2:case 3:case 4:case 5:break;default:e=3}var n=f;f=e;try{return t()}finally{f=n}},t.unstable_scheduleCallback=function(e,i,s){var o=t.unstable_now();switch("object"===typeof s&&null!==s?s="number"===typeof(s=s.delay)&&0<s?o+s:o:s=o,e){case 1:var a=-1;break;case 2:a=250;break;case 5:a=1073741823;break;case 4:a=1e4;break;default:a=5e3}return e={id:h++,callback:i,priorityLevel:e,startTime:s,expirationTime:a=s+a,sortIndex:-1},s>o?(e.sortIndex=s,n(u,e),null===r(l)&&e===r(u)&&(g?(y(k),k=-1):g=!0,R(w,s-o))):(e.sortIndex=a,n(l,e),m||p||(m=!0,P(C))),e},t.unstable_shouldYield=I,t.unstable_wrapCallback=function(e){var t=f;return function(){var n=f;f=t;try{return e.apply(this,arguments)}finally{f=n}}}},8853:(e,t,n)=>{"use strict";e.exports=n(7234)},5438:(e,t,n)=>{"use strict";var r=n(2),i=n(4992),s=n(2101)(),o=n(5558),a=n(4902),c=r("%Math.floor%");e.exports=function(e,t){if("function"!==typeof e)throw new a("`fn` is not a function");if("number"!==typeof t||t<0||t>4294967295||c(t)!==t)throw new a("`length` must be a positive 32-bit integer");var n=arguments.length>2&&!!arguments[2],r=!0,l=!0;if("length"in e&&o){var u=o(e,"length");u&&!u.configurable&&(r=!1),u&&!u.writable&&(l=!1)}return(r||l||!n)&&(s?i(e,"length",t,!0,!0):i(e,"length",t)),e}},9269:(e,t,n)=>{"use strict";var r=n(2),i=n(2028),s=n(8206),o=n(4902),a=r("%WeakMap%",!0),c=r("%Map%",!0),l=i("WeakMap.prototype.get",!0),u=i("WeakMap.prototype.set",!0),h=i("WeakMap.prototype.has",!0),d=i("Map.prototype.get",!0),f=i("Map.prototype.set",!0),p=i("Map.prototype.has",!0),m=function(e,t){for(var n,r=e;null!==(n=r.next);r=n)if(n.key===t)return r.next=n.next,n.next=e.next,e.next=n,n};e.exports=function(){var e,t,n,r={assert:function(e){if(!r.has(e))throw new o("Side channel does not contain "+s(e))},get:function(r){if(a&&r&&("object"===typeof r||"function"===typeof r)){if(e)return l(e,r)}else if(c){if(t)return d(t,r)}else if(n)return function(e,t){var n=m(e,t);return n&&n.value}(n,r)},has:function(r){if(a&&r&&("object"===typeof r||"function"===typeof r)){if(e)return h(e,r)}else if(c){if(t)return p(t,r)}else if(n)return function(e,t){return!!m(e,t)}(n,r);return!1},set:function(r,i){a&&r&&("object"===typeof r||"function"===typeof r)?(e||(e=new a),u(e,r,i)):c?(t||(t=new c),f(t,r,i)):(n||(n={key:{},next:null}),function(e,t,n){var r=m(e,t);r?r.value=n:e.next={key:t,next:e.next,value:n}}(n,r,i))}};return r}},3775:(e,t,n)=>{"use strict";var r=n(1356),i=n(7237),s=/^[\x00-\x20\u00a0\u1680\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]+/,o=/[\n\r\t]/g,a=/^[A-Za-z][A-Za-z0-9+-.]*:\/\//,c=/:\d+$/,l=/^([a-z][a-z0-9.+-]*:)?(\/\/)?([\\/]+)?([\S\s]*)/i,u=/^[a-zA-Z]:/;function h(e){return(e||"").toString().replace(s,"")}var d=[["#","hash"],["?","query"],function(e,t){return m(t.protocol)?e.replace(/\\/g,"/"):e},["/","pathname"],["@","auth",1],[NaN,"host",void 0,1,1],[/:(\d*)$/,"port",void 0,1],[NaN,"hostname",void 0,1,1]],f={hash:1,query:1};function p(e){var t,r=("undefined"!==typeof window?window:"undefined"!==typeof n.g?n.g:"undefined"!==typeof self?self:{}).location||{},i={},s=typeof(e=e||r);if("blob:"===e.protocol)i=new v(unescape(e.pathname),{});else if("string"===s)for(t in i=new v(e,{}),f)delete i[t];else if("object"===s){for(t in e)t in f||(i[t]=e[t]);void 0===i.slashes&&(i.slashes=a.test(e.href))}return i}function m(e){return"file:"===e||"ftp:"===e||"http:"===e||"https:"===e||"ws:"===e||"wss:"===e}function g(e,t){e=(e=h(e)).replace(o,""),t=t||{};var n,r=l.exec(e),i=r[1]?r[1].toLowerCase():"",s=!!r[2],a=!!r[3],c=0;return s?a?(n=r[2]+r[3]+r[4],c=r[2].length+r[3].length):(n=r[2]+r[4],c=r[2].length):a?(n=r[3]+r[4],c=r[3].length):n=r[4],"file:"===i?c>=2&&(n=n.slice(2)):m(i)?n=r[4]:i?s&&(n=n.slice(2)):c>=2&&m(t.protocol)&&(n=r[4]),{protocol:i,slashes:s||m(i),slashesCount:c,rest:n}}function v(e,t,n){if(e=(e=h(e)).replace(o,""),!(this instanceof v))return new v(e,t,n);var s,a,c,l,f,y,b=d.slice(),S=typeof t,w=this,C=0;for("object"!==S&&"string"!==S&&(n=t,t=null),n&&"function"!==typeof n&&(n=i.parse),s=!(a=g(e||"",t=p(t))).protocol&&!a.slashes,w.slashes=a.slashes||s&&t.slashes,w.protocol=a.protocol||t.protocol||"",e=a.rest,("file:"===a.protocol&&(2!==a.slashesCount||u.test(e))||!a.slashes&&(a.protocol||a.slashesCount<2||!m(w.protocol)))&&(b[3]=[/(.*)/,"pathname"]);C<b.length;C++)"function"!==typeof(l=b[C])?(c=l[0],y=l[1],c!==c?w[y]=e:"string"===typeof c?~(f="@"===c?e.lastIndexOf(c):e.indexOf(c))&&("number"===typeof l[2]?(w[y]=e.slice(0,f),e=e.slice(f+l[2])):(w[y]=e.slice(f),e=e.slice(0,f))):(f=c.exec(e))&&(w[y]=f[1],e=e.slice(0,f.index)),w[y]=w[y]||s&&l[3]&&t[y]||"",l[4]&&(w[y]=w[y].toLowerCase())):e=l(e,w);n&&(w.query=n(w.query)),s&&t.slashes&&"/"!==w.pathname.charAt(0)&&(""!==w.pathname||""!==t.pathname)&&(w.pathname=function(e,t){if(""===e)return t;for(var n=(t||"/").split("/").slice(0,-1).concat(e.split("/")),r=n.length,i=n[r-1],s=!1,o=0;r--;)"."===n[r]?n.splice(r,1):".."===n[r]?(n.splice(r,1),o++):o&&(0===r&&(s=!0),n.splice(r,1),o--);return s&&n.unshift(""),"."!==i&&".."!==i||n.push(""),n.join("/")}(w.pathname,t.pathname)),"/"!==w.pathname.charAt(0)&&m(w.protocol)&&(w.pathname="/"+w.pathname),r(w.port,w.protocol)||(w.host=w.hostname,w.port=""),w.username=w.password="",w.auth&&(~(f=w.auth.indexOf(":"))?(w.username=w.auth.slice(0,f),w.username=encodeURIComponent(decodeURIComponent(w.username)),w.password=w.auth.slice(f+1),w.password=encodeURIComponent(decodeURIComponent(w.password))):w.username=encodeURIComponent(decodeURIComponent(w.auth)),w.auth=w.password?w.username+":"+w.password:w.username),w.origin="file:"!==w.protocol&&m(w.protocol)&&w.host?w.protocol+"//"+w.host:"null",w.href=w.toString()}v.prototype={set:function(e,t,n){var s=this;switch(e){case"query":"string"===typeof t&&t.length&&(t=(n||i.parse)(t)),s[e]=t;break;case"port":s[e]=t,r(t,s.protocol)?t&&(s.host=s.hostname+":"+t):(s.host=s.hostname,s[e]="");break;case"hostname":s[e]=t,s.port&&(t+=":"+s.port),s.host=t;break;case"host":s[e]=t,c.test(t)?(t=t.split(":"),s.port=t.pop(),s.hostname=t.join(":")):(s.hostname=t,s.port="");break;case"protocol":s.protocol=t.toLowerCase(),s.slashes=!n;break;case"pathname":case"hash":if(t){var o="pathname"===e?"/":"#";s[e]=t.charAt(0)!==o?o+t:t}else s[e]=t;break;case"username":case"password":s[e]=encodeURIComponent(t);break;case"auth":var a=t.indexOf(":");~a?(s.username=t.slice(0,a),s.username=encodeURIComponent(decodeURIComponent(s.username)),s.password=t.slice(a+1),s.password=encodeURIComponent(decodeURIComponent(s.password))):s.username=encodeURIComponent(decodeURIComponent(t))}for(var l=0;l<d.length;l++){var u=d[l];u[4]&&(s[u[1]]=s[u[1]].toLowerCase())}return s.auth=s.password?s.username+":"+s.password:s.username,s.origin="file:"!==s.protocol&&m(s.protocol)&&s.host?s.protocol+"//"+s.host:"null",s.href=s.toString(),s},toString:function(e){e&&"function"===typeof e||(e=i.stringify);var t,n=this,r=n.host,s=n.protocol;s&&":"!==s.charAt(s.length-1)&&(s+=":");var o=s+(n.protocol&&n.slashes||m(n.protocol)?"//":"");return n.username?(o+=n.username,n.password&&(o+=":"+n.password),o+="@"):n.password?(o+=":"+n.password,o+="@"):"file:"!==n.protocol&&m(n.protocol)&&!r&&"/"!==n.pathname&&(o+="@"),(":"===r[r.length-1]||c.test(n.hostname)&&!n.port)&&(r+=":"),o+=r+n.pathname,(t="object"===typeof n.query?e(n.query):n.query)&&(o+="?"!==t.charAt(0)?"?"+t:t),n.hash&&(o+=n.hash),o}},v.extractProtocol=g,v.location=p,v.trimLeft=h,v.qs=i,e.exports=v},1907:function(e,t,n){var r;e=n.nmd(e),function(i){t&&t.nodeType,e&&e.nodeType;var s="object"==typeof n.g&&n.g;s.global!==s&&s.window!==s&&s.self;var o,a=2147483647,c=36,l=1,u=26,h=38,d=700,f=72,p=128,m="-",g=/^xn--/,v=/[^\x20-\x7E]/,y=/[\x2E\u3002\uFF0E\uFF61]/g,b={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},S=c-l,w=Math.floor,C=String.fromCharCode;function x(e){throw new RangeError(b[e])}function E(e,t){for(var n=e.length,r=[];n--;)r[n]=t(e[n]);return r}function T(e,t){var n=e.split("@"),r="";return n.length>1&&(r=n[0]+"@",e=n[1]),r+E((e=e.replace(y,".")).split("."),t).join(".")}function k(e){for(var t,n,r=[],i=0,s=e.length;i<s;)(t=e.charCodeAt(i++))>=55296&&t<=56319&&i<s?56320==(64512&(n=e.charCodeAt(i++)))?r.push(((1023&t)<<10)+(1023&n)+65536):(r.push(t),i--):r.push(t);return r}function N(e){return E(e,(function(e){var t="";return e>65535&&(t+=C((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+=C(e)})).join("")}function F(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function I(e,t,n){var r=0;for(e=n?w(e/d):e>>1,e+=w(e/t);e>S*u>>1;r+=c)e=w(e/S);return w(r+(S+1)*e/(e+h))}function A(e){var t,n,r,i,s,o,h,d,g,v,y,b=[],S=e.length,C=0,E=p,T=f;for((n=e.lastIndexOf(m))<0&&(n=0),r=0;r<n;++r)e.charCodeAt(r)>=128&&x("not-basic"),b.push(e.charCodeAt(r));for(i=n>0?n+1:0;i<S;){for(s=C,o=1,h=c;i>=S&&x("invalid-input"),((d=(y=e.charCodeAt(i++))-48<10?y-22:y-65<26?y-65:y-97<26?y-97:c)>=c||d>w((a-C)/o))&&x("overflow"),C+=d*o,!(d<(g=h<=T?l:h>=T+u?u:h-T));h+=c)o>w(a/(v=c-g))&&x("overflow"),o*=v;T=I(C-s,t=b.length+1,0==s),w(C/t)>a-E&&x("overflow"),E+=w(C/t),C%=t,b.splice(C++,0,E)}return N(b)}function D(e){var t,n,r,i,s,o,h,d,g,v,y,b,S,E,T,N=[];for(b=(e=k(e)).length,t=p,n=0,s=f,o=0;o<b;++o)(y=e[o])<128&&N.push(C(y));for(r=i=N.length,i&&N.push(m);r<b;){for(h=a,o=0;o<b;++o)(y=e[o])>=t&&y<h&&(h=y);for(h-t>w((a-n)/(S=r+1))&&x("overflow"),n+=(h-t)*S,t=h,o=0;o<b;++o)if((y=e[o])<t&&++n>a&&x("overflow"),y==t){for(d=n,g=c;!(d<(v=g<=s?l:g>=s+u?u:g-s));g+=c)T=d-v,E=c-v,N.push(C(F(v+T%E,0))),d=w(T/E);N.push(C(F(d,0))),s=I(n,S,r==i),n=0,++r}++n,++t}return N.join("")}o={version:"1.4.1",ucs2:{decode:k,encode:N},decode:A,encode:D,toASCII:function(e){return T(e,(function(e){return v.test(e)?"xn--"+D(e):e}))},toUnicode:function(e){return T(e,(function(e){return g.test(e)?A(e.slice(4).toLowerCase()):e}))}},void 0===(r=function(){return o}.call(t,n,t,e))||(e.exports=r)}()},4737:e=>{"use strict";var t=String.prototype.replace,n=/%20/g,r="RFC1738",i="RFC3986";e.exports={default:i,formatters:{RFC1738:function(e){return t.call(e,n,"+")},RFC3986:function(e){return String(e)}},RFC1738:r,RFC3986:i}},6857:(e,t,n)=>{"use strict";var r=n(5808),i=n(8638),s=n(4737);e.exports={formats:s,parse:i,stringify:r}},8638:(e,t,n)=>{"use strict";var r=n(3940),i=Object.prototype.hasOwnProperty,s=Array.isArray,o={allowDots:!1,allowEmptyArrays:!1,allowPrototypes:!1,allowSparse:!1,arrayLimit:20,charset:"utf-8",charsetSentinel:!1,comma:!1,decodeDotInKeys:!1,decoder:r.decode,delimiter:"&",depth:5,duplicates:"combine",ignoreQueryPrefix:!1,interpretNumericEntities:!1,parameterLimit:1e3,parseArrays:!0,plainObjects:!1,strictNullHandling:!1},a=function(e){return e.replace(/&#(\d+);/g,(function(e,t){return String.fromCharCode(parseInt(t,10))}))},c=function(e,t){return e&&"string"===typeof e&&t.comma&&e.indexOf(",")>-1?e.split(","):e},l=function(e,t,n,r){if(e){var s=n.allowDots?e.replace(/\.([^.[]+)/g,"[$1]"):e,o=/(\[[^[\]]*])/g,a=n.depth>0&&/(\[[^[\]]*])/.exec(s),l=a?s.slice(0,a.index):s,u=[];if(l){if(!n.plainObjects&&i.call(Object.prototype,l)&&!n.allowPrototypes)return;u.push(l)}for(var h=0;n.depth>0&&null!==(a=o.exec(s))&&h<n.depth;){if(h+=1,!n.plainObjects&&i.call(Object.prototype,a[1].slice(1,-1))&&!n.allowPrototypes)return;u.push(a[1])}return a&&u.push("["+s.slice(a.index)+"]"),function(e,t,n,r){for(var i=r?t:c(t,n),s=e.length-1;s>=0;--s){var o,a=e[s];if("[]"===a&&n.parseArrays)o=n.allowEmptyArrays&&""===i?[]:[].concat(i);else{o=n.plainObjects?Object.create(null):{};var l="["===a.charAt(0)&&"]"===a.charAt(a.length-1)?a.slice(1,-1):a,u=n.decodeDotInKeys?l.replace(/%2E/g,"."):l,h=parseInt(u,10);n.parseArrays||""!==u?!isNaN(h)&&a!==u&&String(h)===u&&h>=0&&n.parseArrays&&h<=n.arrayLimit?(o=[])[h]=i:"__proto__"!==u&&(o[u]=i):o={0:i}}i=o}return i}(u,t,n,r)}};e.exports=function(e,t){var n=function(e){if(!e)return o;if("undefined"!==typeof e.allowEmptyArrays&&"boolean"!==typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if("undefined"!==typeof e.decodeDotInKeys&&"boolean"!==typeof e.decodeDotInKeys)throw new TypeError("`decodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.decoder&&"undefined"!==typeof e.decoder&&"function"!==typeof e.decoder)throw new TypeError("Decoder has to be a function.");if("undefined"!==typeof e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var t="undefined"===typeof e.charset?o.charset:e.charset,n="undefined"===typeof e.duplicates?o.duplicates:e.duplicates;if("combine"!==n&&"first"!==n&&"last"!==n)throw new TypeError("The duplicates option must be either combine, first, or last");return{allowDots:"undefined"===typeof e.allowDots?!0===e.decodeDotInKeys||o.allowDots:!!e.allowDots,allowEmptyArrays:"boolean"===typeof e.allowEmptyArrays?!!e.allowEmptyArrays:o.allowEmptyArrays,allowPrototypes:"boolean"===typeof e.allowPrototypes?e.allowPrototypes:o.allowPrototypes,allowSparse:"boolean"===typeof e.allowSparse?e.allowSparse:o.allowSparse,arrayLimit:"number"===typeof e.arrayLimit?e.arrayLimit:o.arrayLimit,charset:t,charsetSentinel:"boolean"===typeof e.charsetSentinel?e.charsetSentinel:o.charsetSentinel,comma:"boolean"===typeof e.comma?e.comma:o.comma,decodeDotInKeys:"boolean"===typeof e.decodeDotInKeys?e.decodeDotInKeys:o.decodeDotInKeys,decoder:"function"===typeof e.decoder?e.decoder:o.decoder,delimiter:"string"===typeof e.delimiter||r.isRegExp(e.delimiter)?e.delimiter:o.delimiter,depth:"number"===typeof e.depth||!1===e.depth?+e.depth:o.depth,duplicates:n,ignoreQueryPrefix:!0===e.ignoreQueryPrefix,interpretNumericEntities:"boolean"===typeof e.interpretNumericEntities?e.interpretNumericEntities:o.interpretNumericEntities,parameterLimit:"number"===typeof e.parameterLimit?e.parameterLimit:o.parameterLimit,parseArrays:!1!==e.parseArrays,plainObjects:"boolean"===typeof e.plainObjects?e.plainObjects:o.plainObjects,strictNullHandling:"boolean"===typeof e.strictNullHandling?e.strictNullHandling:o.strictNullHandling}}(t);if(""===e||null===e||"undefined"===typeof e)return n.plainObjects?Object.create(null):{};for(var u="string"===typeof e?function(e,t){var n,l={__proto__:null},u=t.ignoreQueryPrefix?e.replace(/^\?/,""):e,h=t.parameterLimit===1/0?void 0:t.parameterLimit,d=u.split(t.delimiter,h),f=-1,p=t.charset;if(t.charsetSentinel)for(n=0;n<d.length;++n)0===d[n].indexOf("utf8=")&&("utf8=%E2%9C%93"===d[n]?p="utf-8":"utf8=%26%2310003%3B"===d[n]&&(p="iso-8859-1"),f=n,n=d.length);for(n=0;n<d.length;++n)if(n!==f){var m,g,v=d[n],y=v.indexOf("]="),b=-1===y?v.indexOf("="):y+1;-1===b?(m=t.decoder(v,o.decoder,p,"key"),g=t.strictNullHandling?null:""):(m=t.decoder(v.slice(0,b),o.decoder,p,"key"),g=r.maybeMap(c(v.slice(b+1),t),(function(e){return t.decoder(e,o.decoder,p,"value")}))),g&&t.interpretNumericEntities&&"iso-8859-1"===p&&(g=a(g)),v.indexOf("[]=")>-1&&(g=s(g)?[g]:g);var S=i.call(l,m);S&&"combine"===t.duplicates?l[m]=r.combine(l[m],g):S&&"last"!==t.duplicates||(l[m]=g)}return l}(e,n):e,h=n.plainObjects?Object.create(null):{},d=Object.keys(u),f=0;f<d.length;++f){var p=d[f],m=l(p,u[p],n,"string"===typeof e);h=r.merge(h,m,n)}return!0===n.allowSparse?h:r.compact(h)}},5808:(e,t,n)=>{"use strict";var r=n(9269),i=n(3940),s=n(4737),o=Object.prototype.hasOwnProperty,a={brackets:function(e){return e+"[]"},comma:"comma",indices:function(e,t){return e+"["+t+"]"},repeat:function(e){return e}},c=Array.isArray,l=Array.prototype.push,u=function(e,t){l.apply(e,c(t)?t:[t])},h=Date.prototype.toISOString,d=s.default,f={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:i.encode,encodeValuesOnly:!1,format:d,formatter:s.formatters[d],indices:!1,serializeDate:function(e){return h.call(e)},skipNulls:!1,strictNullHandling:!1},p={},m=function e(t,n,s,o,a,l,h,d,m,g,v,y,b,S,w,C,x,E){for(var T,k=t,N=E,F=0,I=!1;void 0!==(N=N.get(p))&&!I;){var A=N.get(t);if(F+=1,"undefined"!==typeof A){if(A===F)throw new RangeError("Cyclic object value");I=!0}"undefined"===typeof N.get(p)&&(F=0)}if("function"===typeof g?k=g(n,k):k instanceof Date?k=b(k):"comma"===s&&c(k)&&(k=i.maybeMap(k,(function(e){return e instanceof Date?b(e):e}))),null===k){if(l)return m&&!C?m(n,f.encoder,x,"key",S):n;k=""}if("string"===typeof(T=k)||"number"===typeof T||"boolean"===typeof T||"symbol"===typeof T||"bigint"===typeof T||i.isBuffer(k))return m?[w(C?n:m(n,f.encoder,x,"key",S))+"="+w(m(k,f.encoder,x,"value",S))]:[w(n)+"="+w(String(k))];var D,O=[];if("undefined"===typeof k)return O;if("comma"===s&&c(k))C&&m&&(k=i.maybeMap(k,m)),D=[{value:k.length>0?k.join(",")||null:void 0}];else if(c(g))D=g;else{var P=Object.keys(k);D=v?P.sort(v):P}var R=d?n.replace(/\./g,"%2E"):n,M=o&&c(k)&&1===k.length?R+"[]":R;if(a&&c(k)&&0===k.length)return M+"[]";for(var B=0;B<D.length;++B){var L=D[B],q="object"===typeof L&&"undefined"!==typeof L.value?L.value:k[L];if(!h||null!==q){var _=y&&d?L.replace(/\./g,"%2E"):L,j=c(k)?"function"===typeof s?s(M,_):M:M+(y?"."+_:"["+_+"]");E.set(t,F);var z=r();z.set(p,E),u(O,e(q,j,s,o,a,l,h,d,"comma"===s&&C&&c(k)?null:m,g,v,y,b,S,w,C,x,z))}}return O};e.exports=function(e,t){var n,i=e,l=function(e){if(!e)return f;if("undefined"!==typeof e.allowEmptyArrays&&"boolean"!==typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if("undefined"!==typeof e.encodeDotInKeys&&"boolean"!==typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&"undefined"!==typeof e.encoder&&"function"!==typeof e.encoder)throw new TypeError("Encoder has to be a function.");var t=e.charset||f.charset;if("undefined"!==typeof e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var n=s.default;if("undefined"!==typeof e.format){if(!o.call(s.formatters,e.format))throw new TypeError("Unknown format option provided.");n=e.format}var r,i=s.formatters[n],l=f.filter;if(("function"===typeof e.filter||c(e.filter))&&(l=e.filter),r=e.arrayFormat in a?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":f.arrayFormat,"commaRoundTrip"in e&&"boolean"!==typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");var u="undefined"===typeof e.allowDots?!0===e.encodeDotInKeys||f.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"===typeof e.addQueryPrefix?e.addQueryPrefix:f.addQueryPrefix,allowDots:u,allowEmptyArrays:"boolean"===typeof e.allowEmptyArrays?!!e.allowEmptyArrays:f.allowEmptyArrays,arrayFormat:r,charset:t,charsetSentinel:"boolean"===typeof e.charsetSentinel?e.charsetSentinel:f.charsetSentinel,commaRoundTrip:e.commaRoundTrip,delimiter:"undefined"===typeof e.delimiter?f.delimiter:e.delimiter,encode:"boolean"===typeof e.encode?e.encode:f.encode,encodeDotInKeys:"boolean"===typeof e.encodeDotInKeys?e.encodeDotInKeys:f.encodeDotInKeys,encoder:"function"===typeof e.encoder?e.encoder:f.encoder,encodeValuesOnly:"boolean"===typeof e.encodeValuesOnly?e.encodeValuesOnly:f.encodeValuesOnly,filter:l,format:n,formatter:i,serializeDate:"function"===typeof e.serializeDate?e.serializeDate:f.serializeDate,skipNulls:"boolean"===typeof e.skipNulls?e.skipNulls:f.skipNulls,sort:"function"===typeof e.sort?e.sort:null,strictNullHandling:"boolean"===typeof e.strictNullHandling?e.strictNullHandling:f.strictNullHandling}}(t);"function"===typeof l.filter?i=(0,l.filter)("",i):c(l.filter)&&(n=l.filter);var h=[];if("object"!==typeof i||null===i)return"";var d=a[l.arrayFormat],p="comma"===d&&l.commaRoundTrip;n||(n=Object.keys(i)),l.sort&&n.sort(l.sort);for(var g=r(),v=0;v<n.length;++v){var y=n[v];l.skipNulls&&null===i[y]||u(h,m(i[y],y,d,p,l.allowEmptyArrays,l.strictNullHandling,l.skipNulls,l.encodeDotInKeys,l.encode?l.encoder:null,l.filter,l.sort,l.allowDots,l.serializeDate,l.format,l.formatter,l.encodeValuesOnly,l.charset,g))}var b=h.join(l.delimiter),S=!0===l.addQueryPrefix?"?":"";return l.charsetSentinel&&("iso-8859-1"===l.charset?S+="utf8=%26%2310003%3B&":S+="utf8=%E2%9C%93&"),b.length>0?S+b:""}},3940:(e,t,n)=>{"use strict";var r=n(4737),i=Object.prototype.hasOwnProperty,s=Array.isArray,o=function(){for(var e=[],t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e}(),a=function(e,t){for(var n=t&&t.plainObjects?Object.create(null):{},r=0;r<e.length;++r)"undefined"!==typeof e[r]&&(n[r]=e[r]);return n},c=1024;e.exports={arrayToObject:a,assign:function(e,t){return Object.keys(t).reduce((function(e,n){return e[n]=t[n],e}),e)},combine:function(e,t){return[].concat(e,t)},compact:function(e){for(var t=[{obj:{o:e},prop:"o"}],n=[],r=0;r<t.length;++r)for(var i=t[r],o=i.obj[i.prop],a=Object.keys(o),c=0;c<a.length;++c){var l=a[c],u=o[l];"object"===typeof u&&null!==u&&-1===n.indexOf(u)&&(t.push({obj:o,prop:l}),n.push(u))}return function(e){for(;e.length>1;){var t=e.pop(),n=t.obj[t.prop];if(s(n)){for(var r=[],i=0;i<n.length;++i)"undefined"!==typeof n[i]&&r.push(n[i]);t.obj[t.prop]=r}}}(t),e},decode:function(e,t,n){var r=e.replace(/\+/g," ");if("iso-8859-1"===n)return r.replace(/%[0-9a-f]{2}/gi,unescape);try{return decodeURIComponent(r)}catch(i){return r}},encode:function(e,t,n,i,s){if(0===e.length)return e;var a=e;if("symbol"===typeof e?a=Symbol.prototype.toString.call(e):"string"!==typeof e&&(a=String(e)),"iso-8859-1"===n)return escape(a).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));for(var l="",u=0;u<a.length;u+=c){for(var h=a.length>=c?a.slice(u,u+c):a,d=[],f=0;f<h.length;++f){var p=h.charCodeAt(f);45===p||46===p||95===p||126===p||p>=48&&p<=57||p>=65&&p<=90||p>=97&&p<=122||s===r.RFC1738&&(40===p||41===p)?d[d.length]=h.charAt(f):p<128?d[d.length]=o[p]:p<2048?d[d.length]=o[192|p>>6]+o[128|63&p]:p<55296||p>=57344?d[d.length]=o[224|p>>12]+o[128|p>>6&63]+o[128|63&p]:(f+=1,p=65536+((1023&p)<<10|1023&h.charCodeAt(f)),d[d.length]=o[240|p>>18]+o[128|p>>12&63]+o[128|p>>6&63]+o[128|63&p])}l+=d.join("")}return l},isBuffer:function(e){return!(!e||"object"!==typeof e)&&!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))},isRegExp:function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},maybeMap:function(e,t){if(s(e)){for(var n=[],r=0;r<e.length;r+=1)n.push(t(e[r]));return n}return t(e)},merge:function e(t,n,r){if(!n)return t;if("object"!==typeof n){if(s(t))t.push(n);else{if(!t||"object"!==typeof t)return[t,n];(r&&(r.plainObjects||r.allowPrototypes)||!i.call(Object.prototype,n))&&(t[n]=!0)}return t}if(!t||"object"!==typeof t)return[t].concat(n);var o=t;return s(t)&&!s(n)&&(o=a(t,r)),s(t)&&s(n)?(n.forEach((function(n,s){if(i.call(t,s)){var o=t[s];o&&"object"===typeof o&&n&&"object"===typeof n?t[s]=e(o,n,r):t.push(n)}else t[s]=n})),t):Object.keys(n).reduce((function(t,s){var o=n[s];return i.call(t,s)?t[s]=e(t[s],o,r):t[s]=o,t}),o)}}},4080:(e,t,n)=>{"use strict";var r=n(1907);function i(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}var s=/^([a-z0-9.+-]+:)/i,o=/:[0-9]*$/,a=/^(\/\/?(?!\/)[^?\s]*)(\?[^\s]*)?$/,c=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),l=["'"].concat(c),u=["%","/","?",";","#"].concat(l),h=["/","?","#"],d=/^[+a-z0-9A-Z_-]{0,63}$/,f=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,p={javascript:!0,"javascript:":!0},m={javascript:!0,"javascript:":!0},g={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},v=n(6857);function y(e,t,n){if(e&&"object"===typeof e&&e instanceof i)return e;var r=new i;return r.parse(e,t,n),r}i.prototype.parse=function(e,t,n){if("string"!==typeof e)throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var i=e.indexOf("?"),o=-1!==i&&i<e.indexOf("#")?"?":"#",c=e.split(o);c[0]=c[0].replace(/\\/g,"/");var y=e=c.join(o);if(y=y.trim(),!n&&1===e.split("#").length){var b=a.exec(y);if(b)return this.path=y,this.href=y,this.pathname=b[1],b[2]?(this.search=b[2],this.query=t?v.parse(this.search.substr(1)):this.search.substr(1)):t&&(this.search="",this.query={}),this}var S=s.exec(y);if(S){var w=(S=S[0]).toLowerCase();this.protocol=w,y=y.substr(S.length)}if(n||S||y.match(/^\/\/[^@/]+@[^@/]+/)){var C="//"===y.substr(0,2);!C||S&&m[S]||(y=y.substr(2),this.slashes=!0)}if(!m[S]&&(C||S&&!g[S])){for(var x,E,T=-1,k=0;k<h.length;k++){-1!==(N=y.indexOf(h[k]))&&(-1===T||N<T)&&(T=N)}-1!==(E=-1===T?y.lastIndexOf("@"):y.lastIndexOf("@",T))&&(x=y.slice(0,E),y=y.slice(E+1),this.auth=decodeURIComponent(x)),T=-1;for(k=0;k<u.length;k++){var N;-1!==(N=y.indexOf(u[k]))&&(-1===T||N<T)&&(T=N)}-1===T&&(T=y.length),this.host=y.slice(0,T),y=y.slice(T),this.parseHost(),this.hostname=this.hostname||"";var F="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!F)for(var I=this.hostname.split(/\./),A=(k=0,I.length);k<A;k++){var D=I[k];if(D&&!D.match(d)){for(var O="",P=0,R=D.length;P<R;P++)D.charCodeAt(P)>127?O+="x":O+=D[P];if(!O.match(d)){var M=I.slice(0,k),B=I.slice(k+1),L=D.match(f);L&&(M.push(L[1]),B.unshift(L[2])),B.length&&(y="/"+B.join(".")+y),this.hostname=M.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),F||(this.hostname=r.toASCII(this.hostname));var q=this.port?":"+this.port:"",_=this.hostname||"";this.host=_+q,this.href+=this.host,F&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==y[0]&&(y="/"+y))}if(!p[w])for(k=0,A=l.length;k<A;k++){var j=l[k];if(-1!==y.indexOf(j)){var z=encodeURIComponent(j);z===j&&(z=escape(j)),y=y.split(j).join(z)}}var U=y.indexOf("#");-1!==U&&(this.hash=y.substr(U),y=y.slice(0,U));var H=y.indexOf("?");if(-1!==H?(this.search=y.substr(H),this.query=y.substr(H+1),t&&(this.query=v.parse(this.query)),y=y.slice(0,H)):t&&(this.search="",this.query={}),y&&(this.pathname=y),g[w]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){q=this.pathname||"";var V=this.search||"";this.path=q+V}return this.href=this.format(),this},i.prototype.format=function(){var e=this.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var t=this.protocol||"",n=this.pathname||"",r=this.hash||"",i=!1,s="";this.host?i=e+this.host:this.hostname&&(i=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(i+=":"+this.port)),this.query&&"object"===typeof this.query&&Object.keys(this.query).length&&(s=v.stringify(this.query,{arrayFormat:"repeat",addQueryPrefix:!1}));var o=this.search||s&&"?"+s||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||g[t])&&!1!==i?(i="//"+(i||""),n&&"/"!==n.charAt(0)&&(n="/"+n)):i||(i=""),r&&"#"!==r.charAt(0)&&(r="#"+r),o&&"?"!==o.charAt(0)&&(o="?"+o),t+i+(n=n.replace(/[?#]/g,(function(e){return encodeURIComponent(e)})))+(o=o.replace("#","%23"))+r},i.prototype.resolve=function(e){return this.resolveObject(y(e,!1,!0)).format()},i.prototype.resolveObject=function(e){if("string"===typeof e){var t=new i;t.parse(e,!1,!0),e=t}for(var n=new i,r=Object.keys(this),s=0;s<r.length;s++){var o=r[s];n[o]=this[o]}if(n.hash=e.hash,""===e.href)return n.href=n.format(),n;if(e.slashes&&!e.protocol){for(var a=Object.keys(e),c=0;c<a.length;c++){var l=a[c];"protocol"!==l&&(n[l]=e[l])}return g[n.protocol]&&n.hostname&&!n.pathname&&(n.pathname="/",n.path=n.pathname),n.href=n.format(),n}if(e.protocol&&e.protocol!==n.protocol){if(!g[e.protocol]){for(var u=Object.keys(e),h=0;h<u.length;h++){var d=u[h];n[d]=e[d]}return n.href=n.format(),n}if(n.protocol=e.protocol,e.host||m[e.protocol])n.pathname=e.pathname;else{for(var f=(e.pathname||"").split("/");f.length&&!(e.host=f.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==f[0]&&f.unshift(""),f.length<2&&f.unshift(""),n.pathname=f.join("/")}if(n.search=e.search,n.query=e.query,n.host=e.host||"",n.auth=e.auth,n.hostname=e.hostname||e.host,n.port=e.port,n.pathname||n.search){var p=n.pathname||"",v=n.search||"";n.path=p+v}return n.slashes=n.slashes||e.slashes,n.href=n.format(),n}var y=n.pathname&&"/"===n.pathname.charAt(0),b=e.host||e.pathname&&"/"===e.pathname.charAt(0),S=b||y||n.host&&e.pathname,w=S,C=n.pathname&&n.pathname.split("/")||[],x=(f=e.pathname&&e.pathname.split("/")||[],n.protocol&&!g[n.protocol]);if(x&&(n.hostname="",n.port=null,n.host&&(""===C[0]?C[0]=n.host:C.unshift(n.host)),n.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===f[0]?f[0]=e.host:f.unshift(e.host)),e.host=null),S=S&&(""===f[0]||""===C[0])),b)n.host=e.host||""===e.host?e.host:n.host,n.hostname=e.hostname||""===e.hostname?e.hostname:n.hostname,n.search=e.search,n.query=e.query,C=f;else if(f.length)C||(C=[]),C.pop(),C=C.concat(f),n.search=e.search,n.query=e.query;else if(null!=e.search){if(x)n.host=C.shift(),n.hostname=n.host,(F=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=F.shift(),n.hostname=F.shift(),n.host=n.hostname);return n.search=e.search,n.query=e.query,null===n.pathname&&null===n.search||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.href=n.format(),n}if(!C.length)return n.pathname=null,n.search?n.path="/"+n.search:n.path=null,n.href=n.format(),n;for(var E=C.slice(-1)[0],T=(n.host||e.host||C.length>1)&&("."===E||".."===E)||""===E,k=0,N=C.length;N>=0;N--)"."===(E=C[N])?C.splice(N,1):".."===E?(C.splice(N,1),k++):k&&(C.splice(N,1),k--);if(!S&&!w)for(;k--;k)C.unshift("..");!S||""===C[0]||C[0]&&"/"===C[0].charAt(0)||C.unshift(""),T&&"/"!==C.join("/").substr(-1)&&C.push("");var F,I=""===C[0]||C[0]&&"/"===C[0].charAt(0);x&&(n.hostname=I?"":C.length?C.shift():"",n.host=n.hostname,(F=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=F.shift(),n.hostname=F.shift(),n.host=n.hostname));return(S=S||n.host&&C.length)&&!I&&C.unshift(""),C.length>0?n.pathname=C.join("/"):(n.pathname=null,n.path=null),null===n.pathname&&null===n.search||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.auth=e.auth||n.auth,n.slashes=n.slashes||e.slashes,n.href=n.format(),n},i.prototype.parseHost=function(){var e=this.host,t=o.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)},t.qg=y},2634:()=>{},7948:(e,t)=>{"use strict";var n,r;Object.defineProperty(t,"__esModule",{value:!0}),t.VisibilityState=t.FlushModeExperimental=t.FlushMode=void 0,function(e){e[e.Immediate=0]="Immediate",e[e.TurnBased=1]="TurnBased"}(n||(t.FlushMode=n={})),function(e){e[e.Async=2]="Async"}(r||(t.FlushModeExperimental=r={})),t.VisibilityState={NotVisible:"NotVisible",LocallyVisible:"LocallyVisible",GloballyVisible:"GloballyVisible"}},3149:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFluidDataStoreFactory=void 0,t.IFluidDataStoreFactory="IFluidDataStoreFactory"},376:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.IFluidDataStoreRegistry=void 0,t.IFluidDataStoreRegistry="IFluidDataStoreRegistry"},8401:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.gcDataBlobKey=t.gcDeletedBlobKey=t.gcTombstoneBlobKey=t.gcBlobPrefix=t.gcTreeKey=void 0,t.gcTreeKey="gc",t.gcBlobPrefix="__gc",t.gcTombstoneBlobKey="__tombstones",t.gcDeletedBlobKey="__deletedNodes",t.gcDataBlobKey=".gcdata"},8698:(e,t,n)=>{"use strict";t.NM=t.nL=t._1=t.RN=t.aT=t.Yz=t.kc=t.xX=t.YV=t.cy=t.qS=t.WD=void 0;var r=n(7948);Object.defineProperty(t,"WD",{enumerable:!0,get:function(){return r.FlushMode}}),Object.defineProperty(t,"qS",{enumerable:!0,get:function(){return r.FlushModeExperimental}}),Object.defineProperty(t,"cy",{enumerable:!0,get:function(){return r.VisibilityState}});var i=n(3149);var s=n(376);var o=n(8401);Object.defineProperty(t,"YV",{enumerable:!0,get:function(){return o.gcBlobPrefix}}),Object.defineProperty(t,"xX",{enumerable:!0,get:function(){return o.gcDataBlobKey}}),Object.defineProperty(t,"kc",{enumerable:!0,get:function(){return o.gcDeletedBlobKey}}),Object.defineProperty(t,"Yz",{enumerable:!0,get:function(){return o.gcTombstoneBlobKey}}),Object.defineProperty(t,"aT",{enumerable:!0,get:function(){return o.gcTreeKey}});var a=n(2198);Object.defineProperty(t,"RN",{enumerable:!0,get:function(){return a.blobCountPropertyName}}),Object.defineProperty(t,"_1",{enumerable:!0,get:function(){return a.channelsTreeName}}),Object.defineProperty(t,"nL",{enumerable:!0,get:function(){return a.CreateSummarizerNodeSource}}),Object.defineProperty(t,"NM",{enumerable:!0,get:function(){return a.totalBlobSizePropertyName}});var c=n(5484)},2198:(e,t)=>{"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),t.totalBlobSizePropertyName=t.blobCountPropertyName=t.channelsTreeName=t.CreateSummarizerNodeSource=void 0,function(e){e[e.FromSummary=0]="FromSummary",e[e.FromAttach=1]="FromAttach",e[e.Local=2]="Local"}(n||(t.CreateSummarizerNodeSource=n={})),t.channelsTreeName=".channels",t.blobCountPropertyName="BlobCount",t.totalBlobSizePropertyName="TotalBlobSize"},645:(e,t)=>{"use strict";function n(e,t){if(Number.isFinite(e)&&Number.isFinite(t))return e-t;let n=typeof e,r=typeof t;if(n!==r)return n<r?-1:1;if("object"===n){if(null===e)return null===t?0:-1;if(null===t)return 1;if(n=typeof(e=e.valueOf()),r=typeof(t=t.valueOf()),n!==r)return n<r?-1:1}return e<t?-1:e>t?1:e===t?0:Number.isNaN(e)?Number.isNaN(t)?0:-1:Number.isNaN(t)?1:Array.isArray(e)?0:Number.NaN}t.Pb=void 0;class r{constructor(e,t,r){this._root=h,this._size=0,this._maxNodeSize=r>=4?Math.min(r,256):32,this._compare=t||n,e&&this.setPairs(e)}get size(){return this._size}get length(){return this._size}get isEmpty(){return 0===this._size}clear(){this._root=h,this._size=0}forEach(e,t){return void 0!==t&&(e=e.bind(t)),this.forEachPair(((t,n)=>e(n,t,this)))}forEachPair(e,t){var n=this.minKey(),r=this.maxKey();return this.forRange(n,r,!0,e,t)}get(e,t){return this._root.get(e,t,this)}set(e,t,n){this._root.isShared&&(this._root=this._root.clone());var r=this._root.set(e,t,n,this);return!0===r||!1===r?r:(this._root=new o([this._root,r]),!0)}has(e){return 0!==this.forRange(e,e,!0,void 0)}delete(e){return 0!==this.editRange(e,e,!0,l)}with(e,t,n){let r=this.clone();return r.set(e,t,n)||n?r:this}withPairs(e,t){let n=this.clone();return 0!==n.setPairs(e,t)||t?n:this}withKeys(e,t){let n=this.clone(),r=!1;for(var i=0;i<e.length;i++)r=n.set(e[i],void 0,!1)||r;return t&&!r?this:n}without(e,t){return this.withoutRange(e,e,!0,t)}withoutKeys(e,t){let n=this.clone();return n.deleteKeys(e)||!t?n:this}withoutRange(e,t,n,r){let i=this.clone();return 0===i.deleteRange(e,t,n)&&r?this:i}filter(e,t){var n,r=this.greedyClone();return r.editAll(((t,r,i)=>{if(!e(t,r,i))return n=c})),!n&&t?this:r}mapValues(e){var t={},n=this.greedyClone();return n.editAll(((n,r,i)=>(t.value=e(r,n,i),t))),n}reduce(e,t){let n=0,r=t;for(var i,s=this.entries(this.minKey(),f);!(i=s.next()).done;)r=e(r,i.value,n++,this);return r}entries(e,t){var n=this.findPath(e);if(void 0===n)return i();var{nodequeue:r,nodeindex:s,leaf:o}=n,a=void 0!==t?1:0,c=void 0===e?-1:o.indexOf(e,0,this._compare)-1;return i((()=>{e:for(;;)switch(a){case 0:if(++c<o.keys.length)return{done:!1,value:[o.keys[c],o.values[c]]};a=2;continue;case 1:if(++c<o.keys.length)return t[0]=o.keys[c],t[1]=o.values[c],{done:!1,value:t};a=2;case 2:for(var e=-1;;){if(++e>=r.length){a=3;continue e}if(++s[e]<r[e].length)break}for(;e>0;e--)r[e-1]=r[e][s[e]].children,s[e-1]=0;o=r[0][s[0]],c=-1,a=void 0!==t?1:0;continue;case 3:return{done:!0,value:void 0}}}))}entriesReversed(e,t,n){if(void 0===e&&(n=void 0,void 0===(e=this.maxKey())))return i();var{nodequeue:r,nodeindex:s,leaf:o}=this.findPath(e)||this.findPath(this.maxKey());p(!r[0]||o===r[0][s[0]],"wat!");var a=o.indexOf(e,0,this._compare);!n&&a<o.keys.length&&this._compare(o.keys[a],e)<=0&&a++;var c=void 0!==t?1:0;return i((()=>{e:for(;;)switch(c){case 0:if(--a>=0)return{done:!1,value:[o.keys[a],o.values[a]]};c=2;continue;case 1:if(--a>=0)return t[0]=o.keys[a],t[1]=o.values[a],{done:!1,value:t};c=2;case 2:for(var e=-1;;){if(++e>=r.length){c=3;continue e}if(--s[e]>=0)break}for(;e>0;e--)r[e-1]=r[e][s[e]].children,s[e-1]=r[e-1].length-1;o=r[0][s[0]],a=o.keys.length,c=void 0!==t?1:0;continue;case 3:return{done:!0,value:void 0}}}))}findPath(e){var t,n,r=this._root;if(r.isLeaf)t=d,n=d;else{t=[],n=[];for(var i=0;!r.isLeaf;i++){if(t[i]=r.children,n[i]=void 0===e?0:r.indexOf(e,0,this._compare),n[i]>=t[i].length)return;r=t[i][n[i]]}t.reverse(),n.reverse()}return{nodequeue:t,nodeindex:n,leaf:r}}diffAgainst(e,t,n,i){if(e._compare!==this._compare)throw new Error("Tree comparators are not the same.");if(this.isEmpty||e.isEmpty){if(this.isEmpty&&e.isEmpty)return;return this.isEmpty?void 0===n?void 0:r.stepToEnd(r.makeDiffCursor(e),n):void 0===t?void 0:r.stepToEnd(r.makeDiffCursor(this),t)}const{_compare:s}=this,o=r.makeDiffCursor(this),a=r.makeDiffCursor(e);let c=!0,l=!0,u=r.compare(o,a,s);for(;c&&l;){const e=r.compare(o,a,s),{leaf:h,internalSpine:d,levelIndices:f}=o,{leaf:p,internalSpine:m,levelIndices:g}=a;if(h||p){if(0!==u)if(0===e){if(h&&p&&i){const e=h.values[f[f.length-1]],t=p.values[g[g.length-1]];if(!Object.is(e,t)){const n=i(o.currentKey,e,t);if(n&&n.break)return n.break}}}else if(e>0){if(p&&n){const e=p.values[g[g.length-1]],t=n(a.currentKey,e);if(t&&t.break)return t.break}}else if(t&&h&&0!==u){const e=h.values[f[f.length-1]],n=t(o.currentKey,e);if(n&&n.break)return n.break}}else if(!h&&!p&&0===e){const e=d.length-1,t=m.length-1,n=d[e][f[e]];if(m[t][g[t]]===n){u=0,c=r.step(o,!0),l=r.step(a,!0);continue}}u=e,e<0?c=r.step(o):l=r.step(a)}return c&&t?r.finishCursorWalk(o,a,s,t):l&&n?r.finishCursorWalk(a,o,s,n):void 0}static finishCursorWalk(e,t,n,i){const s=r.compare(e,t,n);if(0===s){if(!r.step(e))return}else s<0&&p(!1,"cursor walk terminated early");return r.stepToEnd(e,i)}static stepToEnd(e,t){let n=!0;for(;n;){const{leaf:i,levelIndices:s,currentKey:o}=e;if(i){const e=t(o,i.values[s[s.length-1]]);if(e&&e.break)return e.break}n=r.step(e)}}static makeDiffCursor(e){const{_root:t,height:n}=e;return{height:n,internalSpine:[[t]],levelIndices:[0],leaf:void 0,currentKey:t.maxKey()}}static step(e,t){const{internalSpine:n,levelIndices:r,leaf:i}=e;if(!0===t||i){const s=r.length;if(!0===t||0===r[s-1]){const t=n.length;if(0===t)return!1;const i=t-1;let o=i;for(;o>=0;){if(r[o]>0)return o<s-1&&(e.leaf=void 0,r.pop()),o<i&&(e.internalSpine=n.slice(0,o+1)),e.currentKey=n[o][--r[o]].maxKey(),!0;o--}return!1}{const t=--r[s-1];return e.currentKey=i.keys[t],!0}}{const t=n.length,i=t-1,s=n[i][r[i]];if(s.isLeaf){e.leaf=s;const n=r[t]=s.values.length-1;e.currentKey=s.keys[n]}else{const i=s.children;n[t]=i;const o=i.length-1;r[t]=o,e.currentKey=i[o].maxKey()}return!0}}static compare(e,t,n){const{height:r,currentKey:i,levelIndices:s}=e,{height:o,currentKey:a,levelIndices:c}=t,l=n(a,i);if(0!==l)return l;const u=r<o?r:o;return s.length-(r-u)-(c.length-(o-u))}keys(e){var t=this.entries(e,f);return i((()=>{var e=t.next();return e.value&&(e.value=e.value[0]),e}))}values(e){var t=this.entries(e,f);return i((()=>{var e=t.next();return e.value&&(e.value=e.value[1]),e}))}get maxNodeSize(){return this._maxNodeSize}minKey(){return this._root.minKey()}maxKey(){return this._root.maxKey()}clone(){this._root.isShared=!0;var e=new r(void 0,this._compare,this._maxNodeSize);return e._root=this._root,e._size=this._size,e}greedyClone(e){var t=new r(void 0,this._compare,this._maxNodeSize);return t._root=this._root.greedyClone(e),t._size=this._size,t}toArray(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2147483647,t=this.minKey(),n=this.maxKey();return void 0!==t?this.getRange(t,n,!0,e):[]}keysArray(){var e=[];return this._root.forRange(this.minKey(),this.maxKey(),!0,!1,this,0,((t,n)=>{e.push(t)})),e}valuesArray(){var e=[];return this._root.forRange(this.minKey(),this.maxKey(),!0,!1,this,0,((t,n)=>{e.push(n)})),e}toString(){return this.toArray().toString()}setIfNotPresent(e,t){return this.set(e,t,!1)}nextHigherPair(e,t){return t=t||[],void 0===e?this._root.minPair(t):this._root.getPairOrNextHigher(e,this._compare,!1,t)}nextHigherKey(e){var t=this.nextHigherPair(e,f);return t&&t[0]}nextLowerPair(e,t){return t=t||[],void 0===e?this._root.maxPair(t):this._root.getPairOrNextLower(e,this._compare,!1,t)}nextLowerKey(e){var t=this.nextLowerPair(e,f);return t&&t[0]}getPairOrNextLower(e,t){return this._root.getPairOrNextLower(e,this._compare,!0,t||[])}getPairOrNextHigher(e,t){return this._root.getPairOrNextHigher(e,this._compare,!0,t||[])}changeIfPresent(e,t){return 0!==this.editRange(e,e,!0,((e,n)=>({value:t})))}getRange(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:67108863;var i=[];return this._root.forRange(e,t,n,!1,this,0,((e,t)=>(i.push([e,t]),i.length>r?u:void 0))),i}setPairs(e,t){for(var n=0,r=0;r<e.length;r++)this.set(e[r][0],e[r][1],t)&&n++;return n}forRange(e,t,n,r,i){var s=this._root.forRange(e,t,n,!1,this,i||0,r);return"number"===typeof s?s:s.break}editRange(e,t,n,r,i){var s=this._root;s.isShared&&(this._root=s=s.clone());try{var o=s.forRange(e,t,n,!0,this,i||0,r);return"number"===typeof o?o:o.break}finally{let e;for(;s.keys.length<=1&&!s.isLeaf;)e||(e=s.isShared),this._root=s=0===s.keys.length?h:s.children[0];e&&(s.isShared=!0)}}editAll(e,t){return this.editRange(this.minKey(),this.maxKey(),!0,e,t)}deleteRange(e,t,n){return this.editRange(e,t,n,l)}deleteKeys(e){for(var t=0,n=0;t<e.length;t++)this.delete(e[t])&&n++;return n}get height(){let e=this._root,t=-1;for(;e;)t++,e=e.isLeaf?void 0:e.children[0];return t}freeze(){var e=this;e.clear=e.set=e.editRange=function(){throw new Error("Attempted to modify a frozen BTree")}}unfreeze(){delete this.clear,delete this.set,delete this.editRange}get isFrozen(){return this.hasOwnProperty("editRange")}checkValid(){var e=this._root.checkValid(0,this,0);p(e===this.size,"size mismatch: counted ",e,"but stored",this.size)}}function i(){var e={next:arguments.length>0&&void 0!==arguments[0]?arguments[0]:()=>({done:!0,value:void 0})};return Symbol&&Symbol.iterator&&(e[Symbol.iterator]=function(){return this}),e}t.Pb=r,Symbol&&Symbol.iterator&&(r.prototype[Symbol.iterator]=r.prototype.entries),r.prototype.where=r.prototype.filter,r.prototype.setRange=r.prototype.setPairs,r.prototype.add=r.prototype.set;class s{get isLeaf(){return void 0===this.children}constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0;this.keys=e,this.values=t||a,this.isShared=void 0}maxKey(){return this.keys[this.keys.length-1]}indexOf(e,t,n){const r=this.keys;for(var i=0,s=r.length,o=s>>1;i<s;){var a=n(r[o],e);if(a<0)i=o+1;else{if(!(a>0)){if(0===a)return o;if(e===e)return r.length;throw new Error("BTree: NaN was used as a key")}s=o}o=i+s>>1}return o^t}minKey(){return this.keys[0]}minPair(e){if(0!==this.keys.length)return e[0]=this.keys[0],e[1]=this.values[0],e}maxPair(e){if(0===this.keys.length)return;const t=this.keys.length-1;return e[0]=this.keys[t],e[1]=this.values[t],e}clone(){var e=this.values;return new s(this.keys.slice(0),e===a?e:e.slice(0))}greedyClone(e){return this.isShared&&!e?this:this.clone()}get(e,t,n){var r=this.indexOf(e,-1,n._compare);return r<0?t:this.values[r]}getPairOrNextLower(e,t,n,r){var i=this.indexOf(e,-1,t);const s=i<0?~i-1:n?i:i-1;if(s>=0)return r[0]=this.keys[s],r[1]=this.values[s],r}getPairOrNextHigher(e,t,n,r){var i=this.indexOf(e,-1,t);const s=i<0?~i:n?i:i+1,o=this.keys;if(s<o.length)return r[0]=o[s],r[1]=this.values[s],r}checkValid(e,t,n){var r=this.keys.length,i=this.values.length;return p(this.values===a?r<=i:r===i,"keys/values length mismatch: depth",e,"with lengths",r,i,"and baseIndex",n),p(0==e||r>0,"empty leaf at depth",e,"and baseIndex",n),r}set(e,t,n,r){var i=this.indexOf(e,-1,r._compare);if(i<0){if(i=~i,r._size++,this.keys.length<r._maxNodeSize)return this.insertInLeaf(i,e,t,r);var s=this.splitOffRightSide(),o=this;return i>this.keys.length&&(i-=this.keys.length,o=s),o.insertInLeaf(i,e,t,r),s}return!1!==n&&(void 0!==t&&this.reifyValues(),this.keys[i]=e,this.values[i]=t),!1}reifyValues(){return this.values===a?this.values=this.values.slice(0,this.keys.length):this.values}insertInLeaf(e,t,n,r){if(this.keys.splice(e,0,t),this.values===a){for(;a.length<r._maxNodeSize;)a.push(void 0);if(void 0===n)return!0;this.values=a.slice(0,this.keys.length-1)}return this.values.splice(e,0,n),!0}takeFromRight(e){var t=this.values;e.values===a?t!==a&&t.push(void 0):(t=this.reifyValues()).push(e.values.shift()),this.keys.push(e.keys.shift())}takeFromLeft(e){var t=this.values;e.values===a?t!==a&&t.unshift(void 0):(t=this.reifyValues()).unshift(e.values.pop()),this.keys.unshift(e.keys.pop())}splitOffRightSide(){var e=this.keys.length>>1,t=this.keys.splice(e),n=this.values===a?a:this.values.splice(e);return new s(t,n)}forRange(e,t,n,r,i,s,o){var c,l,u=i._compare;if(t===e){if(!n)return s;if(l=(c=this.indexOf(e,-1,u))+1,c<0)return s}else c=this.indexOf(e,0,u),(l=this.indexOf(t,-1,u))<0?l=~l:!0===n&&l++;var h=this.keys,d=this.values;if(void 0!==o)for(var f=c;f<l;f++){var p=h[f],m=o(p,d[f],s++);if(void 0!==m){if(!0===r){if(p!==h[f]||!0===this.isShared)throw new Error("BTree illegally changed or cloned in editRange");m.delete?(this.keys.splice(f,1),this.values!==a&&this.values.splice(f,1),i._size--,f--,l--):m.hasOwnProperty("value")&&(d[f]=m.value)}if(void 0!==m.break)return m}}else s+=l-c;return s}mergeSibling(e,t){if(this.keys.push.apply(this.keys,e.keys),this.values===a){if(e.values===a)return;this.values=this.values.slice(0,this.keys.length)}this.values.push.apply(this.values,e.reifyValues())}}class o extends s{constructor(e,t){if(!t){t=[];for(var n=0;n<e.length;n++)t[n]=e[n].maxKey()}super(t),this.children=e}clone(){for(var e=this.children.slice(0),t=0;t<e.length;t++)e[t].isShared=!0;return new o(e,this.keys.slice(0))}greedyClone(e){if(this.isShared&&!e)return this;for(var t=new o(this.children.slice(0),this.keys.slice(0)),n=0;n<t.children.length;n++)t.children[n]=t.children[n].greedyClone(e);return t}minKey(){return this.children[0].minKey()}minPair(e){return this.children[0].minPair(e)}maxPair(e){return this.children[this.children.length-1].maxPair(e)}get(e,t,n){var r=this.indexOf(e,0,n._compare),i=this.children;return r<i.length?i[r].get(e,t,n):void 0}getPairOrNextLower(e,t,n,r){var i=this.indexOf(e,0,t),s=this.children;if(i>=s.length)return this.maxPair(r);const o=s[i].getPairOrNextLower(e,t,n,r);return void 0===o&&i>0?s[i-1].maxPair(r):o}getPairOrNextHigher(e,t,n,r){var i=this.indexOf(e,0,t),s=this.children,o=s.length;if(i>=o)return;const a=s[i].getPairOrNextHigher(e,t,n,r);return void 0===a&&i<o-1?s[i+1].minPair(r):a}checkValid(e,t,n){let r=this.keys.length,i=this.children.length;p(r===i,"keys/children length mismatch: depth",e,"lengths",r,i,"baseIndex",n),p(r>1||e>0,"internal node has length",r,"at depth",e,"baseIndex",n);let s=0,o=this.children,a=this.keys,c=0;for(var l=0;l<i;l++)s+=o[l].checkValid(e+1,t,n+s),c+=o[l].keys.length,p(s>=c,"wtf",n),p(0===l||o[l-1].constructor===o[l].constructor,"type mismatch, baseIndex:",n),o[l].maxKey()!=a[l]&&p(!1,"keys[",l,"] =",a[l],"is wrong, should be ",o[l].maxKey(),"at depth",e,"baseIndex",n),0===l||t._compare(a[l-1],a[l])<0||p(!1,"sort violation at depth",e,"index",l,"keys",a[l-1],a[l]);let u=0===c;return(u||c>t.maxNodeSize*i)&&p(!1,u?"too few":"too many","children (",c,s,") at depth",e,"maxNodeSize:",t.maxNodeSize,"children.length:",i,"baseIndex:",n),s}set(e,t,n,r){var i,s=this.children,o=r._maxNodeSize,a=r._compare,c=Math.min(this.indexOf(e,0,a),s.length-1),l=s[c];(l.isShared&&(s[c]=l=l.clone()),l.keys.length>=o)&&(c>0&&(i=s[c-1]).keys.length<o&&a(l.keys[0],e)<0?(i.isShared&&(s[c-1]=i=i.clone()),i.takeFromRight(l),this.keys[c-1]=i.maxKey()):void 0!==(i=s[c+1])&&i.keys.length<o&&a(l.maxKey(),e)<0&&(i.isShared&&(s[c+1]=i=i.clone()),i.takeFromLeft(l),this.keys[c]=s[c].maxKey()));var u=l.set(e,t,n,r);if(!1===u)return!1;if(this.keys[c]=l.maxKey(),!0===u)return!0;if(this.keys.length<o)return this.insert(c+1,u),!0;var h=this.splitOffRightSide(),d=this;return a(u.maxKey(),this.maxKey())>0&&(d=h,c-=this.keys.length),d.insert(c+1,u),h}insert(e,t){this.children.splice(e,0,t),this.keys.splice(e,0,t.maxKey())}splitOffRightSide(){var e=this.children.length>>1;return new o(this.children.splice(e),this.keys.splice(e))}takeFromRight(e){this.keys.push(e.keys.shift()),this.children.push(e.children.shift())}takeFromLeft(e){this.keys.unshift(e.keys.pop()),this.children.unshift(e.children.pop())}forRange(e,t,n,r,i,s,o){var a=i._compare,c=this.keys,l=this.children,u=this.indexOf(e,0,a),h=u,d=Math.min(t===e?u:this.indexOf(t,0,a),c.length-1);if(r){if(h<=d)try{for(;h<=d;h++){l[h].isShared&&(l[h]=l[h].clone());m=l[h].forRange(e,t,n,r,i,s,o);if(c[h]=l[h].maxKey(),"number"!==typeof m)return m;s=m}}finally{var f=i._maxNodeSize>>1;for(u>0&&u--,h=d;h>=u;h--)l[h].keys.length<=f&&(0!==l[h].keys.length?this.tryMerge(h,i._maxNodeSize):(c.splice(h,1),l.splice(h,1)));0!==l.length&&0===l[0].keys.length&&p(!1,"emptiness bug")}}else for(;h<=d;h++){var m;if("number"!==typeof(m=l[h].forRange(e,t,n,r,i,s,o)))return m;s=m}return s}tryMerge(e,t){var n=this.children;return e>=0&&e+1<n.length&&n[e].keys.length+n[e+1].keys.length<=t&&(n[e].isShared&&(n[e]=n[e].clone()),n[e].mergeSibling(n[e+1],t),n.splice(e+1,1),this.keys.splice(e+1,1),this.keys[e]=n[e].maxKey(),!0)}mergeSibling(e,t){var n=this.keys.length;this.keys.push.apply(this.keys,e.keys);const r=e.children;if(this.children.push.apply(this.children,r),e.isShared&&!this.isShared)for(var i=0;i<r.length;i++)r[i].isShared=!0;this.tryMerge(n-1,t)}}var a=[];const c={delete:!0},l=()=>c,u={break:!0},h=function(){var e=new s;return e.isShared=!0,e}(),d=[],f=[];function p(e){if(!e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];throw n.unshift("B+ tree"),new Error(n.join(" "))}}(()=>{let e=new r;e.freeze()})()},202:(e,t,n)=>{"use strict";n.d(t,{JR:()=>o,Km:()=>i,Ss:()=>c,Xg:()=>s});var r=n(4445);function i(e,t){switch(t){case"base64":return r.fromByteArray(e);case"utf8":case"utf-8":case void 0:return(new TextDecoder).decode(e);default:throw new Error("invalid/unsupported encoding")}}const s=(e,t)=>c.from(e,t).buffer,o=(e,t)=>c.from(e).toString(t);function a(e){const t=e;return e instanceof ArrayBuffer||"object"===typeof t&&null!==t&&"number"===typeof t.byteLength&&"function"===typeof t.slice&&void 0===t.byteOffset&&void 0===t.buffer}class c extends Uint8Array{toString(e){return i(this,e)}static from(e,t,n){if("string"===typeof e)return c.fromString(e,t);if(null!==e&&"object"===typeof e&&a(e.buffer))return c.fromArrayBuffer(e.buffer,e.byteOffset,e.byteLength);if(a(e))return c.fromArrayBuffer(e,t,n);throw new TypeError("Input value was neither a string nor an ArrayBuffer.")}static fromArrayBuffer(e,t,n){const r=null!==t&&void 0!==t?t:0,i=null!==n&&void 0!==n?n:e.byteLength-r;if(r<0||r>e.byteLength||i<0||i+r>e.byteLength)throw new RangeError("Invalid range specified.");return new c(e,r,i)}static fromString(e,t){switch(t){case"base64":{const t=this.sanitizeBase64(e),n=r.toByteArray(t);return new c(n.buffer)}case"utf8":case"utf-8":case void 0:{const t=(new TextEncoder).encode(e);return new c(t.buffer)}default:throw new Error("invalid/unsupported encoding")}}static isBuffer(e){throw new Error("unimplemented")}static sanitizeBase64(e){let t=e;if(t=t.split("=")[0],t=t.replace(/[^\w+-/]/g,""),t.length%4!==0){t+=["","===","==","="][t.length%4]}return t}}},1605:(e,t,n)=>{"use strict";n.d(t,{F:()=>r});const r=globalThis.performance},107:(e,t,n)=>{"use strict";n.d(t,{$:()=>r});const r={verbose:10,default:20,error:30}},2624:(e,t,n)=>{"use strict";function r(e,t){if(!e)throw new Error("number"===typeof t?"0x".concat(t.toString(16).padStart(3,"0")):t)}n.d(t,{v:()=>r})},8400:(e,t,n)=>{"use strict";n.d(t,{I:()=>i,d:()=>r});class r{constructor(e){this.valueGenerator=e,this._evaluated=!1}get evaluated(){return this._evaluated}get value(){return this._evaluated||(this._evaluated=!0,this._value=this.valueGenerator()),this._value}}class i{get[Symbol.toStringTag](){return this.getPromise()[Symbol.toStringTag]}constructor(e){this.execute=e}async then(e,t){return this.getPromise().then(...arguments)}async catch(e){return this.getPromise().catch(...arguments)}async finally(e){return this.getPromise().finally(...arguments)}async getPromise(){return void 0===this.result&&(this.result=this.execute()),this.result}}},5484:(e,t,n)=>{"use strict";n.r(t),n.d(t,{IdCompressor:()=>N,assertIsStableId:()=>a.XT,createIdCompressor:()=>F,createSessionId:()=>a.GH,deserializeIdCompressor:()=>I,generateStableId:()=>a.gN,isStableId:()=>a.tn});var r=n(2624),i=n(202),s=n(5994);function o(e){return e>=0}var a=n(4292);const c=BigInt("0xFFFFFFFFFFFFFFFF"),l=BigInt(64);function u(e,t,n){return e[t]=n,t+1}function h(e,t,n){return e[t]=n&c,e[t+1]=n>>l,t+2}function d(e){const t=e.bufferFloat[e.index];return e.index+=1,t}function f(e){const t=e.bufferUint[e.index],n=e.bufferUint[e.index+1]<<l|t;return e.index+=2,n}var p=n(645);class m{constructor(e){if(this.uuidSpace=new p.Pb(void 0,a.s5),this.sessionCache=new Map,void 0!==e){for(const[t,n]of e)this.sessionCache.set((0,a.ds)(t),n);if(this.uuidSpace=new p.Pb(e,a.s5),this.sessionCache.size!==e.length||e.length!==this.uuidSpace.size)throw new Error("Cannot resume existing session.")}}sessions(){return this.sessionCache.values()}getOrCreate(e){const t=this.sessionCache.get(e);if(void 0!==t)return t;const n=new g(e);return(0,r.v)(this.uuidSpace.set(n.sessionUuid,n),1888),this.sessionCache.set(e,n),n}get(e){return this.sessionCache.get(e)}getContainingCluster(e){const t=(0,a.hq)(e),n=this.uuidSpace.getPairOrNextLower(t);if(void 0===n)return;const[r,i]=n,s=(0,a.KO)(t,i.sessionUuid);if(s>Number.MAX_SAFE_INTEGER)return;const o=(0,a.kB)(Number(s)+1),c=i.getClusterByLocal(o,!0);return void 0!==c?[c,o]:void 0}clusterCollides(e){const{session:t,baseLocalId:n,capacity:i}=e,s=(0,a.Gr)(t.sessionUuid,(0,a.G9)(n)-1),o=(0,a.Gr)(s,i-1);let c=this.uuidSpace.getPairOrNextLower(o);for(;void 0!==c&&c[1]===t;)c=this.uuidSpace.nextLowerPair(c[0]);if(void 0===c)return!1;const[l,u]=c;(0,r.v)(u!==t,1889);const h=u.getLastCluster();if(void 0===h)return!1;return(0,a.Gr)(u.sessionUuid,(0,a.G9)(C(h))-1)>=s}equals(e,t){const n=(e,n)=>{const i=e.sessions().next(),s=i.done?void 0:i.value;for(const[o,a]of e.sessionCache.entries()){const e=n.sessionCache.get(o);if(void 0===e){if(!a.isEmpty()||t)return!1;(0,r.v)(a===s,1890)}else if(!a.equals(e))return!1}return!0};return n(this,e)&&n(e,this)}}class g{constructor(e){this.clusterChain=[],this.sessionUuid="string"===typeof e?(0,a.hq)(e):e}addNewCluster(e,t,n){const r=this.getLastCluster(),i={session:this,baseFinalId:e,baseLocalId:void 0===r?-1:C(r)-1,capacity:t,count:n};return this.clusterChain.push(i),i}isEmpty(){return 0===this.clusterChain.length}getLastCluster(){return this.clusterChain[this.clusterChain.length-1]}tryConvertToFinal(e,t){const n=this.getClusterByLocal(e,t);if(void 0!==n)return y(n,e)}getClusterByLocal(e,t){const n=t?C:x;return g.binarySearch(e,this.clusterChain,((e,t)=>e<n(t)?1:e>t.baseLocalId?-1:0))}getClusterByAllocatedFinal(e){return g.getContainingCluster(e,this.clusterChain)}static getContainingCluster(e,t){return g.binarySearch(e,t,((e,t)=>{const n=S(t);return e<t.baseFinalId?-1:e>n?1:0}))}static binarySearch(e,t,n){let r=0,i=t.length-1;for(;r<=i;){const s=Math.floor((r+i)/2),o=n(e,t[s]);if(0===o)return t[s];o>0?r=s+1:i=s-1}}equals(e){for(let t=0;t<this.clusterChain.length;t++)if(!v(this.clusterChain[t],e.clusterChain[t]))return!1;return this.sessionUuid===e.sessionUuid}}function v(e,t){return e.session.sessionUuid===t.session.sessionUuid&&e.baseFinalId===t.baseFinalId&&e.baseLocalId===t.baseLocalId&&e.capacity===t.capacity&&e.count===t.count}function y(e,t){const n=(0,a.G9)(t)-(0,a.G9)(e.baseLocalId);if(n<e.capacity)return e.baseFinalId+n}function b(e,t){(0,r.v)(t>=e.baseFinalId&&t<=S(e),1891);const n=t-e.baseFinalId;return e.baseLocalId-n}function S(e){return e.baseFinalId+(e.capacity-1)}function w(e){return e.baseFinalId+(e.count-1)}function C(e){return e.baseLocalId-(e.capacity-1)}function x(e){return e.baseLocalId-(e.count-1)}class E{constructor(e){this.comparator=e,this.elements=[]}get size(){return this.elements.length/2}minKey(){return this.elements[0]}maxKey(){return this.elements[this.elements.length-2]}minValue(){return this.elements[1]}maxValue(){return this.elements[this.elements.length-1]}first(){const{elements:e}=this,{length:t}=e;if(0!==t)return[e[0],e[1]]}last(){const{elements:e}=this,{length:t}=e;if(0===t)return;const n=t-2;return[e[n],e[n+1]]}getAtIndex(e){const t=2*e,{elements:n}=this;if(!(t<0||t>n.length-1))return[n[t],n[t+1]]}*entries(){const{elements:e}=this;for(let t=0;t<e.length;t+=2)yield[e[t],e[t+1]]}*keys(){const{elements:e}=this;for(let t=0;t<e.length;t+=2)yield e[t]}*values(){const{elements:e}=this;for(let t=0;t<e.length;t+=2)yield e[t+1]}*entriesReversed(){const{elements:e}=this;for(let t=e.length-2;t>=0;t-=2)yield[e[t],e[t+1]]}append(e,t){const{elements:n}=this,{length:r}=n;if(0!==r&&this.comparator(e,this.maxKey())<=0)throw new Error("Inserted key must be > all others in the map.");n.push(e),n.push(t)}replaceLast(e,t){const{elements:n,comparator:r}=this,{length:i}=n;if(0!==i&&(n.pop(),n.pop(),r(e,this.maxKey())<=0))throw new Error("Inserted key must be > all others in the map.");n.push(e),n.push(t)}get(e){const t=E.keyIndexOf(this.elements,e,this.comparator);if(!(t<0))return this.elements[t+1]}getPairOrNextLower(e){return this.getPairOrNextLowerBy(e,this.comparator)}getPairOrNextHigher(e){return this.getPairOrNextHigherBy(e,this.comparator)}equals(e,t){if(e===this)return!0;if(this.elements.length!==e.elements.length)return!1;for(let n=this.elements.length-2;n>=0;n-=2){const r=this.elements[n],i=this.elements[n+1],s=e.elements[n],o=e.elements[n+1];if(0!==this.comparator(r,s))return!1;if(!t(i,o))return!1}return!0}assertValid(){let e;for(const t of this.entries())void 0!==e&&(0,r.v)(this.comparator(t[0],e[0])>0,1874),e=t}*getRange(e,t){const n=this.getKeyIndexOfOrNextHigher(e,this.comparator);if(void 0===n)return;const r=this.getKeyIndexOfOrNextLower(t,this.comparator);if(void 0!==r)for(let i=n;i<=r;i+=2)yield[this.elements[i],this.elements[i+1]]}getPairOrNextLowerBy(e,t){const n=this.getKeyIndexOfOrNextLower(e,t);if(void 0!==n)return[this.elements[n],this.elements[n+1]]}getKeyIndexOfOrNextLower(e,t){const{elements:n}=this;if(0===n.length)return;let r=E.keyIndexOf(n,e,t);return r<0?(r^=E.failureXor,r>0?r-2:void 0):r}getPairOrNextHigherBy(e,t){const n=this.getKeyIndexOfOrNextHigher(e,t);if(void 0!==n)return[this.elements[n],this.elements[n+1]]}getKeyIndexOfOrNextHigher(e,t){const{elements:n}=this,{length:r}=n;if(0===r)return;let i=E.keyIndexOf(n,e,t);return i<0?(i^=E.failureXor,i<r?i:void 0):i}static keyIndexOf(e,t,n){let r=0,i=e.length/2,s=i>>1;for(;r<i;){const o=2*s,a=n(t,e[o],e[o+1]);if(a>0)r=s+1;else{if(!(a<0)){if(0===a)return o;throw new Error("Invalid comparator.")}i=s}s=r+i>>1}return 2*s^E.failureXor}}E.failureXor=-1;class T{constructor(){this.localIdRanges=new E(a.Tg)}get idRanges(){return this.localIdRanges}addLocalRange(e,t){const n=this.localIdRanges.last();if(void 0!==n){const[r,i]=n;if(r+i===e)return void this.localIdRanges.replaceLast(r,i+t)}this.localIdRanges.append(e,t)}contains(e){const t=(0,a.G9)(e),n=this.localIdRanges.getPairOrNextLower(t);if(void 0!==n){const[e,r]=n;if(t<=e+(r-1))return!0}return!1}equals(e){return this.localIdRanges.equals(e.localIdRanges,((e,t)=>e===t))}}class k{constructor(){this.clusterList=[]}get clusters(){return this.clusterList}getLastCluster(){return this.clusterList[this.clusterList.length-1]}addCluster(e){const t=this.getLastCluster();(0,r.v)(void 0===t||e.baseFinalId===t.baseFinalId+t.capacity,1875),this.clusterList.push(e)}getFinalizedIdLimit(){const e=this.getLastCluster();return void 0===e?0:w(e)+1}getAllocatedIdLimit(){const e=this.getLastCluster();return void 0===e?0:S(e)+1}equals(e){for(let t=0;t<this.clusterList.length;t++)if(!v(this.clusterList[t],e.clusterList[t]))return!1;return this.clusterList.length===e.clusterList.length}}class N{constructor(e,t){if(this.logger=t,this.normalizer=new T,this.localGenCount=0,this.nextRangeBaseGenCount=1,this.sessions=new m,this.finalSpace=new k,this.nextRequestedClusterSize=512,this.telemetryLocalIdCount=0,this.telemetryEagerFinalIdCount=0,"string"===typeof e)this.localSessionId=e,this.localSession=this.sessions.getOrCreate(e);else{this.sessions=e;const t=e.sessions().next();(0,r.v)(!t.done,1876),this.localSession=t.value,this.localSessionId=(0,a.ds)(this.localSession.sessionUuid)}}static create(e,t){let n,r;void 0===e?n=(0,a.GH)():"string"===typeof e?(n=e,r=t):(n=(0,a.GH)(),r=t);return new N(n,void 0===r?void 0:(0,s.pW)({logger:r}))}generateCompressedId(){if(this.ongoingGhostSession)return void 0===this.ongoingGhostSession.cluster?this.ongoingGhostSession.cluster=this.addEmptyCluster(this.sessions.getOrCreate(this.ongoingGhostSession.ghostSessionId),1):this.ongoingGhostSession.cluster.capacity++,this.ongoingGhostSession.cluster.count++,w(this.ongoingGhostSession.cluster);{this.localGenCount++;const e=this.localSession.getLastCluster();if(void 0===e)return this.telemetryLocalIdCount++,this.generateNextLocalId();const t=this.localGenCount-(0,a.G9)(e.baseLocalId);return e.capacity>t?(this.telemetryEagerFinalIdCount++,e.baseFinalId+t):(this.telemetryLocalIdCount++,this.generateNextLocalId())}}beginGhostSession(e,t){this.ongoingGhostSession={ghostSessionId:e};try{t()}finally{this.ongoingGhostSession=void 0}}generateNextLocalId(){return this.normalizer.addLocalRange(this.localGenCount,1),(0,a.kB)(this.localGenCount)}takeNextCreationRange(){(0,r.v)(!this.ongoingGhostSession,2214);const e=this.localGenCount-(this.nextRangeBaseGenCount-1);if(0===e)return{sessionId:this.localSessionId};const t={sessionId:this.localSessionId,ids:{firstGenCount:this.nextRangeBaseGenCount,count:e,requestedClusterSize:this.nextRequestedClusterSize}};return this.nextRangeBaseGenCount=this.localGenCount+1,N.assertValidRange(t),t}static assertValidRange(e){if(void 0===e.ids)return;const{count:t,requestedClusterSize:n}=e.ids;(0,r.v)(t>0,1877),(0,r.v)(n>0,2166),(0,r.v)(n<=N.maxClusterSize,2167)}finalizeCreationRange(e){if((0,r.v)(!this.ongoingGhostSession,2215),void 0===e.ids)return;N.assertValidRange(e);const{sessionId:t,ids:n}=e,{count:i,firstGenCount:s,requestedClusterSize:o}=n,c=this.sessions.getOrCreate(t),l=c===this.localSession,u=(0,a.kB)(s);let h=c.getLastCluster();if(void 0===h){if(-1!==u)throw new Error("Ranges finalized out of order.");var d;if(h=this.addEmptyCluster(c,o+i),l)null===(d=this.logger)||void 0===d||d.sendTelemetryEvent({eventName:"RuntimeIdCompressor:FirstCluster",sessionId:this.localSessionId})}const f=h.capacity-h.count;if(h.baseLocalId-h.count!==u)throw new Error("Ranges finalized out of order.");if(f>=i)h.count+=i;else{const e=i-f,t=e+o;if(h===this.finalSpace.getLastCluster()){var p;if(h.capacity+=t,h.count+=i,(0,r.v)(!this.sessions.clusterCollides(h),1878),l)null===(p=this.logger)||void 0===p||p.sendTelemetryEvent({eventName:"RuntimeIdCompressor:ClusterExpansion",sessionId:this.localSessionId,previousCapacity:h.capacity-t,newCapacity:h.capacity,overflow:e})}else{h.count=h.capacity;var m;if(this.addEmptyCluster(c,t).count+=e,l)null===(m=this.logger)||void 0===m||m.sendTelemetryEvent({eventName:"RuntimeIdCompressor:NewCluster",sessionId:this.localSessionId})}}var g;l&&(null===(g=this.logger)||void 0===g||g.sendTelemetryEvent({eventName:"RuntimeIdCompressor:IdCompressorStatus",eagerFinalIdCount:this.telemetryEagerFinalIdCount,localIdCount:this.telemetryLocalIdCount,sessionId:this.localSessionId}),this.telemetryEagerFinalIdCount=0,this.telemetryLocalIdCount=0);(0,r.v)(!c.isEmpty(),1879)}addEmptyCluster(e,t){var n;(0,r.v)(!(null!==(n=this.ongoingGhostSession)&&void 0!==n&&n.cluster),2216);const i=e.addNewCluster(this.finalSpace.getAllocatedIdLimit(),t,0);return(0,r.v)(!this.sessions.clusterCollides(i),1880),this.finalSpace.addCluster(i),i}normalizeToOpSpace(e){if(o(e))return e;{const t=e;if(!this.normalizer.contains(t))throw new Error("Invalid ID to normalize.");const n=this.localSession.tryConvertToFinal(t,!0);return void 0===n?t:n}}normalizeToSessionSpace(e,t){if(o(e)){const t=this.localSession.getClusterByAllocatedFinal(e);if(void 0===t){if(e>=this.finalSpace.getFinalizedIdLimit())throw new Error("Unknown op space ID.");return e}{const n=b(t,e);if(this.normalizer.contains(n))return n;if((0,a.G9)(n)>this.localGenCount)throw new Error("Unknown op space ID.");return e}}{const n=e;if(t===this.localSessionId){if(this.normalizer.contains(n))return n;throw new Error("Unknown op space ID.")}{const e=this.sessions.get(t);if(void 0===e)throw new Error("No IDs have ever been finalized by the supplied session.");const r=e.tryConvertToFinal(n,!1);if(void 0===r)throw new Error("Unknown op space ID.");return r}}}decompress(e){if(o(e)){const t=g.getContainingCluster(e,this.finalSpace.clusters);if(void 0===t)throw new Error("Unknown ID");const n=b(t,e),i=(0,a.G9)(n);if(i>(0,a.G9)(x(t))){if(t.session!==this.localSession)throw new Error("Unknown ID");(0,r.v)(!this.normalizer.contains(n),1881)}return(0,a.ds)((0,a.Gr)(t.session.sessionUuid,i-1))}{const t=e;if(!this.normalizer.contains(t))throw new Error("Unknown ID");return(0,a.ds)((0,a.Gr)(this.localSession.sessionUuid,(0,a.G9)(t)-1))}}recompress(e){const t=this.tryRecompress(e);if(void 0===t)throw new Error("Could not recompress.");return t}tryRecompress(e){const t=this.sessions.getContainingCluster(e);if(void 0!==t){const[e,n]=t;return e.session===this.localSession?this.normalizer.contains(n)?n:((0,r.v)((0,a.G9)(n)<=this.localGenCount,1882),y(e,n)):(0,a.G9)(n)>=x(e)?y(e,n):void 0}{const t=(0,a.hq)(e),n=(0,a.KO)(t,this.localSession.sessionUuid);if(n<Number.MAX_SAFE_INTEGER){const e=Number(n)+1,t=(0,a.kB)(e);if(this.normalizer.contains(t))return t}}}serialize(e){var t;(0,r.v)(!this.ongoingGhostSession,2217);const{normalizer:n,finalSpace:s,sessions:o}=this,a=new Map;let c=0;for(const r of o.sessions())r.isEmpty()&&!e||(a.set(r,c),c++);const l=e?3+2*this.normalizer.idRanges.size:0,d=4+2*a.size+3*s.clusters.length+l,f=new Float64Array(d),p=new BigUint64Array(f.buffer);let m=0;m=u(f,m,2),m=function(e,t,n){return u(e,t,n?1:0)}(f,m,e),m=u(f,m,a.size),m=u(f,m,s.clusters.length);for(const[r]of a.entries())m=h(p,m,r.sessionUuid);if(s.clusters.forEach((e=>{m=u(f,m,a.get(e.session)),m=u(f,m,e.capacity),m=u(f,m,e.count)})),e){m=u(f,m,this.localGenCount),m=u(f,m,this.nextRangeBaseGenCount),m=u(f,m,n.idRanges.size);for(const[e,t]of n.idRanges.entries())m=u(f,m,e),m=u(f,m,t)}return(0,r.v)(m===d,1883),null===(t=this.logger)||void 0===t||t.sendTelemetryEvent({eventName:"RuntimeIdCompressor:SerializedIdCompressorSize",size:f.byteLength,clusterCount:s.clusters.length,sessionCount:a.size}),(0,i.JR)(f.buffer,"base64")}static deserialize(e,t){const n=(0,i.Xg)(e,"base64"),r={index:0,bufferFloat:new Float64Array(n),bufferUint:new BigUint64Array(n)};switch(d(r)){case 1:throw new Error("IdCompressor version 1.0 is no longer supported.");case 2:return N.deserialize2_0(r,t);default:throw new Error("Unknown IdCompressor serialized version.")}}static deserialize2_0(e,t){const n=function(e){return 1===d(e)}(e),i=d(e),s=d(e);let o=0;const c=[];if(n)(0,r.v)(void 0===t,1886);else{(0,r.v)(void 0!==t,1885);const e=(0,a.hq)(t);c.push([e,new g(e)]),o=1}for(let r=0;r<i;r++){const t=f(e);c.push([t,new g(t)])}const l=new N(new m(c));let u=0;for(let r=0;r<s;r++){const t=c[d(e)+o][1],n=d(e),r=d(e),i=t.addNewCluster(u,n,r);l.finalSpace.addCluster(i),u+=n}if(n){l.localGenCount=d(e),l.nextRangeBaseGenCount=d(e);const t=d(e);for(let n=0;n<t;n++)l.normalizer.addLocalRange(d(e),d(e))}return(0,r.v)(e.index===e.bufferFloat.length,1887),l}equals(e,t){return!!(!t||this.localSessionId===e.localSessionId&&this.localSession.equals(e.localSession)&&this.normalizer.equals(e.normalizer)&&this.nextRangeBaseGenCount===e.nextRangeBaseGenCount&&this.localGenCount===e.localGenCount)&&(this.sessions.equals(e.sessions,t)&&this.finalSpace.equals(e.finalSpace))}}function F(e,t){return N.create(e,t)}function I(e,t){return void 0===t?N.deserialize(e):N.deserialize(e,t)}N.maxClusterSize=2**20},4292:(e,t,n)=>{"use strict";n.d(t,{XT:()=>f,s5:()=>v,Tg:()=>g,GH:()=>d,G9:()=>y,gN:()=>p,tn:()=>m,kB:()=>b,hq:()=>N,Gr:()=>I,ds:()=>F,KO:()=>A});var r=n(2624);const i={randomUUID:"undefined"!==typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let s;const o=new Uint8Array(16);function a(){if(!s&&(s="undefined"!==typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!s))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return s(o)}const c=[];for(let D=0;D<256;++D)c.push((D+256).toString(16).slice(1));function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return c[e[t+0]]+c[e[t+1]]+c[e[t+2]]+c[e[t+3]]+"-"+c[e[t+4]]+c[e[t+5]]+"-"+c[e[t+6]]+c[e[t+7]]+"-"+c[e[t+8]]+c[e[t+9]]+"-"+c[e[t+10]]+c[e[t+11]]+c[e[t+12]]+c[e[t+13]]+c[e[t+14]]+c[e[t+15]]}const u=function(e,t,n){if(i.randomUUID&&!t&&!e)return i.randomUUID();const r=(e=e||{}).random||(e.rng||a)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return l(r)},h=Array.from("09afAF").map((e=>e.charCodeAt(0)));function d(){return f(u())}function f(e){return(0,r.v)(m(e),1187),e}function p(){return f(u())}function m(e){if(36!==e.length)return!1;for(let n=0;n<e.length;n++)switch(n){case 8:case 13:case 18:case 23:if("-"!==e.charAt(n))return!1;break;case 14:if("4"!==e.charAt(n))return!1;break;case 19:{const t=e.charAt(n);if("8"!==t&&"9"!==t&&"a"!==t&&"b"!==t)return!1;break}default:if(!((t=e.charCodeAt(n))>=h[0]&&t<=h[1]||t>=h[2]&&t<=h[3]||t>=h[4]&&t<=h[5]))return!1}var t;return!0}function g(e,t){return e-t}function v(e,t){return e>t?1:e===t?0:-1}function y(e){return-e}function b(e){return-e}const S=0x4n<<76n,w=0x8n<<60n,C=0xffffffffffffn<<80n,x=C>>6n,E=0xfffn<<64n,T=E>>2n,k=0x3fffffffffffffffn;function N(e){const t=BigInt("0x".concat(e.replace(/-/g,"")));return(t&C)>>6n|(t&E)>>2n|t&k}function F(e){const t=((e&x)<<6n|S|(e&T)<<2n|w|e&k).toString(16).padStart(32,"0");return"".concat(t.substring(0,8),"-").concat(t.substring(8,12),"-").concat(t.substring(12,16),"-").concat(t.substring(16,20),"-").concat(t.substring(20,32))}function I(e,t){return e+BigInt(t)}function A(e,t){return e-t}}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var s=t[r]={id:r,loaded:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.loaded=!0,s.exports}n.m=e,n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.f={},n.e=e=>Promise.all(Object.keys(n.f).reduce(((t,r)=>(n.f[r](e,t),t)),[])),n.u=e=>"static/js/"+e+".bc971c8b.chunk.js",n.miniCssF=e=>{},n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={},t="fluid-app:";n.l=(r,i,s,o)=>{if(e[r])e[r].push(i);else{var a,c;if(void 0!==s)for(var l=document.getElementsByTagName("script"),u=0;u<l.length;u++){var h=l[u];if(h.getAttribute("src")==r||h.getAttribute("data-webpack")==t+s){a=h;break}}a||(c=!0,(a=document.createElement("script")).charset="utf-8",a.timeout=120,n.nc&&a.setAttribute("nonce",n.nc),a.setAttribute("data-webpack",t+s),a.src=r),e[r]=[i];var d=(t,n)=>{a.onerror=a.onload=null,clearTimeout(f);var i=e[r];if(delete e[r],a.parentNode&&a.parentNode.removeChild(a),i&&i.forEach((e=>e(n))),t)return t(n)},f=setTimeout(d.bind(null,void 0,{type:"timeout",target:a}),12e4);a.onerror=d.bind(null,a.onerror),a.onload=d.bind(null,a.onload),c&&document.head.appendChild(a)}}})(),n.r=e=>{"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),n.p="/",(()=>{var e={792:0};n.f.j=(t,r)=>{var i=n.o(e,t)?e[t]:void 0;if(0!==i)if(i)r.push(i[2]);else{var s=new Promise(((n,r)=>i=e[t]=[n,r]));r.push(i[2]=s);var o=n.p+n.u(t),a=new Error;n.l(o,(r=>{if(n.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var s=r&&("load"===r.type?"missing":r.type),o=r&&r.target&&r.target.src;a.message="Loading chunk "+t+" failed.\n("+s+": "+o+")",a.name="ChunkLoadError",a.type=s,a.request=o,i[1](a)}}),"chunk-"+t,t)}};var t=(t,r)=>{var i,s,o=r[0],a=r[1],c=r[2],l=0;if(o.some((t=>0!==e[t]))){for(i in a)n.o(a,i)&&(n.m[i]=a[i]);if(c)c(n)}for(t&&t(r);l<o.length;l++)s=o[l],n.o(e,s)&&e[s]&&e[s][0](),e[s]=0},r=self.webpackChunkfluid_app=self.webpackChunkfluid_app||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})(),(()=>{"use strict";var e={};n.r(e),n.d(e,{Decoder:()=>oS,Encoder:()=>iS,PacketType:()=>rS,protocol:()=>nS});var t=n(5043),r=n(4391),i=n(2624);const s={genericError:"genericError",throttlingError:"throttlingError",dataCorruptionError:"dataCorruptionError",dataProcessingError:"dataProcessingError",usageError:"usageError"};var o=n(56);function a(e,t,n){if(!e)throw new l(t,n)}class c extends o.iq{constructor(e,t,n){super(e,n,new Set(["error"])),this.error=t,this.errorType=s.genericError}}class l extends o.iq{constructor(e,t){super(e,{...t,usageError:!0}),this.errorType=s.usageError}}class u extends o.iq{constructor(e,t){super(e,{...t,dataProcessingError:1}),this.errorType=s.dataCorruptionError,this.canRetry=!1}}class h extends o.iq{constructor(e,t){super(e,t),this.errorType=s.dataProcessingError,this.canRetry=!1}static create(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const i=h.wrapIfUnrecognized(e,t,n);return i.addTelemetryProperties(r),i}static wrapIfUnrecognized(e,t,n){const r={dataProcessingError:1,dataProcessingCodepath:t,...void 0===n?void 0:d(n)},i=(0,o.cQ)(e,{props:r});if((0,o.vt)(i)||i.errorType===o.i5){const e=(0,o.J4)(i,(e=>new h(e)));return e.addTelemetryProperties(i.getTelemetryProperties()),e}return i}}const d=e=>({messageClientId:null===e.clientId?"null":e.clientId,messageSequenceNumber:e.sequenceNumber,messageClientSequenceNumber:e.clientSequenceNumber,messageReferenceSequenceNumber:e.referenceSequenceNumber,messageMinimumSequenceNumber:e.minimumSequenceNumber,messageTimestamp:e.timestamp}),f={compile:()=>({check:e=>!0})};var p=n(645),m=n(31);const g="object"===typeof self?self:globalThis,v=e=>((e,t)=>{const n=(t,n)=>(e.set(n,t),t),r=i=>{if(e.has(i))return e.get(i);const[s,o]=t[i];switch(s){case 0:case-1:return n(o,i);case 1:{const e=n([],i);for(const t of o)e.push(r(t));return e}case 2:{const e=n({},i);for(const[t,n]of o)e[r(t)]=r(n);return e}case 3:return n(new Date(o),i);case 4:{const{source:e,flags:t}=o;return n(new RegExp(e,t),i)}case 5:{const e=n(new Map,i);for(const[t,n]of o)e.set(r(t),r(n));return e}case 6:{const e=n(new Set,i);for(const t of o)e.add(r(t));return e}case 7:{const{name:e,message:t}=o;return n(new g[e](t),i)}case 8:return n(BigInt(o),i);case"BigInt":return n(Object(BigInt(o)),i)}return n(new g[s](o),i)};return r})(new Map,e)(0),y="",{toString:b}={},{keys:S}=Object,w=e=>{const t=typeof e;if("object"!==t||!e)return[0,t];const n=b.call(e).slice(8,-1);switch(n){case"Array":return[1,y];case"Object":return[2,y];case"Date":return[3,y];case"RegExp":return[4,y];case"Map":return[5,y];case"Set":return[6,y]}return n.includes("Array")?[1,n]:n.includes("Error")?[7,n]:[2,n]},C=e=>{let[t,n]=e;return 0===t&&("function"===n||"symbol"===n)},x=function(e){let{json:t,lossy:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=[];return((e,t,n,r)=>{const i=(e,t)=>{const i=r.push(e)-1;return n.set(t,i),i},s=r=>{if(n.has(r))return n.get(r);let[o,a]=w(r);switch(o){case 0:{let t=r;switch(a){case"bigint":o=8,t=r.toString();break;case"function":case"symbol":if(e)throw new TypeError("unable to serialize "+a);t=null;break;case"undefined":return i([-1],r)}return i([o,t],r)}case 1:{if(a)return i([a,[...r]],r);const e=[],t=i([o,e],r);for(const n of r)e.push(s(n));return t}case 2:{if(a)switch(a){case"BigInt":return i([a,r.toString()],r);case"Boolean":case"Number":case"String":return i([a,r.valueOf()],r)}if(t&&"toJSON"in r)return s(r.toJSON());const n=[],c=i([o,n],r);for(const t of S(r))!e&&C(w(r[t]))||n.push([s(t),s(r[t])]);return c}case 3:return i([o,r.toISOString()],r);case 4:{const{source:e,flags:t}=r;return i([o,{source:e,flags:t}],r)}case 5:{const t=[],n=i([o,t],r);for(const[i,o]of r)(e||!C(w(i))&&!C(w(o)))&&t.push([s(i),s(o)]);return n}case 6:{const t=[],n=i([o,t],r);for(const i of r)!e&&C(w(i))||t.push(s(i));return n}}const{message:c}=r;return i([o,{name:a,message:c}],r)};return s})(!(t||n),!!t,new Map,r)(e),r},E="function"===typeof structuredClone?(e,t)=>t&&("json"in t||"lossy"in t)?v(x(e,t)):structuredClone(e):(e,t)=>v(x(e,t));function T(e){throw new Error(e)}function k(e){return Array.isArray(e)}function N(e){let{a:t,b:n,aExtra:r,bExtra:i,same:s}=e;for(const o of t.keys())if(n.has(o)){if(s&&!s(o))return!1}else if(r&&!r(o))return!1;for(const o of n.keys())if(!t.has(o)&&i&&!i(o))return!1;return!0}function F(e,t,n){let r=e.get(t);return void 0===r&&(r=n(t),e.set(t,r)),r}function I(e,t){let n=e.get(t);return void 0===n&&(n=[],e.set(t,n)),n}function*A(e,t){for(const n of e)yield t(n)}const D=m.ZU.Any();function O(e,t,n){(0,i.v)(t>=e,1948),P(e,n,!1),P(t,n,!0)}function P(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];M(e),n?(0,i.v)(e<=t.length,888):(0,i.v)(e<t.length,889)}function R(e,t){let{start:n,end:r}=e;M(n),M(r),(0,i.v)(r<=t.length,1949),(0,i.v)(n<=r,1950)}function M(e){(0,i.v)(Number.isSafeInteger(e),886),(0,i.v)(e>=0,887)}function B(e){const t=new Map;for(const n of Object.keys(e)){const r=e[n];t.set(n,r)}return t}function L(e){if(void 0!==e&&1===e.size)for(const t of e)return t}const q=Symbol("Symbol.dispose placeholder");function _(e){const t=e[Symbol.iterator]().next();return!0===t.done?"":t.value.toUpperCase()+e.slice(t.value.length)}function j(e,t){return e>t?1:e===t?0:-1}function z(e){return new H(e)}class U{constructor(e){this.noListeners=e,this.listeners=new Map}emit(e){const t=this.listeners.get(e);if(void 0!==t){for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];const e=r;for(const n of t.values())n(...e)}}emitAndCollect(e){const t=this.listeners.get(e);if(void 0!==t){for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];const e=r,s=[];for(const n of t.values())s.push(n(...e));return s}return[]}on(e,t){return F(this.listeners,e,(()=>new Set)).add(t),()=>this.off(e,t)}off(e,t){var n;const r=null!==(n=this.listeners.get(e))&&void 0!==n?n:T("Event has no listeners. Event deregistration functions may only be invoked once.");var s;((0,i.v)(r.delete(t),1217),0===r.size)&&(this.listeners.delete(e),null===(s=this.noListeners)||void 0===s||s.call(this,e))}hasListeners(e){return void 0===e?0!==this.listeners.size:this.listeners.has(e)}}class H extends U{constructor(e){super(e)}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return super.emit(e,...n)}emitAndCollect(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return super.emitAndCollect(e,...n)}}const V={additionalProperties:!1,minProperties:1,maxProperties:1};class K{constructor(e){this.library=B(e)}dispatch(e){var t;const n=Reflect.ownKeys(e);(0,i.v)(1===n.length,1843);const r=n[0],s=e[r],o=null!==(t=this.library.get(r))&&void 0!==t?t:T("missing function for union member");for(var a=arguments.length,c=new Array(a>1?a-1:0),l=1;l<a;l++)c[l-1]=arguments[l];return o(s,...c)}}function G(){return m.ZU.String()}function W(e){return m.ZU.Number(e)}const J=1,Z=G(),$=G(),Q=G(),X=m.ZU.Object({kind:$,types:m.ZU.Optional(m.ZU.Array(Q))}),Y=m.ZU.Composite([X],{additionalProperties:!1});var ee;!function(e){e[e.Number=0]="Number",e[e.String=1]="String",e[e.Boolean=2]="Boolean",e[e.FluidHandle=3]="FluidHandle",e[e.Null=4]="Null"}(ee||(ee={}));const te=m.ZU.Object({object:m.ZU.Optional(m.ZU.Record(m.ZU.String(),Y)),map:m.ZU.Optional(Y),leaf:m.ZU.Optional(m.ZU.Enum(ee))},V);var ne;!function(e){e[e.Number=0]="Number",e[e.String=1]="String",e[e.Boolean=2]="Boolean",e[e.FluidHandle=3]="FluidHandle",e[e.Null=4]="Null"}(ne||(ne={}));const re="Forbidden",ie={kind:{identifier:re},types:new Set};class se{}class oe extends se{constructor(e){super(),this.objectNodeFields=e}encode(){const e=Object.create(null);for(const n of[...this.objectNodeFields.keys()].sort()){var t;Object.defineProperty(e,n,{enumerable:!0,configurable:!0,writable:!0,value:fe(null!==(t=this.objectNodeFields.get(n))&&void 0!==t?t:T("missing field"))})}return{object:e}}}class ae extends se{constructor(e){super(),this.mapFields=e}encode(){return{map:fe(this.mapFields)}}}class ce extends se{constructor(e){super(),this.leafValue=e}encode(){return{leaf:de(this.leafValue)}}}const le=new K({leaf:e=>new ce(function(e){var t;return null!==(t=he.get(e))&&void 0!==t?t:T("missing ValueSchema")}(e)),object:e=>{const t=new Map;for(const[n,r]of Object.entries(e))t.set(n,pe(r));return new oe(t)},map:e=>new ae(pe(e))}),ue=new Map([[ne.Number,ee.Number],[ne.String,ee.String],[ne.Boolean,ee.Boolean],[ne.FluidHandle,ee.FluidHandle],[ne.Null,ee.Null]]),he=function(e){const t=new Map(A(e,(e=>{let[t,n]=e;return[n,t]})));return(0,i.v)(t.size===e.size,2186),t}(ue);function de(e){var t;return null!==(t=ue.get(e))&&void 0!==t?t:T("missing PersistedValueSchema")}function fe(e){const t={kind:e.kind.identifier};return void 0!==e.types&&(t.types=[...e.types]),t}function pe(e){return{kind:{identifier:e.kind},types:void 0===e.types?void 0:new Set(e.types)}}class me{constructor(e){this.events=z(),void 0===e?(this.rootFieldSchemaData=ie,this.nodeSchemaData=new p.Pb([],j)):e instanceof me?(this.rootFieldSchemaData=e.rootFieldSchema,this.nodeSchemaData=e.nodeSchemaData.clone()):(this.rootFieldSchemaData=e.rootFieldSchema,this.nodeSchemaData=function(e){const t=[...e.entries()];return new p.Pb(t,j)}(e.nodeSchema))}on(e,t){return this.events.on(e,t)}get nodeSchema(){return this.nodeSchemaData}get rootFieldSchema(){return this.rootFieldSchemaData}apply(e){this.events.emit("beforeSchemaChange",e);const t=new me(e);this.rootFieldSchemaData=t.rootFieldSchemaData,this.nodeSchemaData=t.nodeSchemaData,this.events.emit("afterSchemaChange",e)}clone(){return new me(this)}}function ge(e){return 0===e.nodeSchema.size}function ve(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;return ye({maxId:null!==e&&void 0!==e?e:-1})}function ye(e){return{allocate:t=>{const n=null!==t&&void 0!==t?t:1;(0,i.v)(n>0,1487);const r=e.maxId+1;return e.maxId+=n,r},getNextId:()=>e.maxId}}const be={allocate:()=>T("Should not allocate IDs"),getNextId:()=>0};function Se(e,t,n,r){let i=e.get(t);if(void 0===i&&(i=new Map,e.set(t,i)),i.has(n))return i.get(n);i.set(n,r)}function we(e,t,n,r){Ce(e,t,new Map).set(n,r)}function Ce(e,t,n){const r=e.get(t);return void 0!==r?r:(e.set(t,n),n)}function xe(e,t,n){const r=e.get(t);if(void 0!==r)return r.get(n)}function Ee(e,t,n){const r=e.get(t);if(void 0===r)return!1;const i=r.delete(n);return 0===r.size&&e.delete(t),i}function Te(e,t){e.forEach(((e,n)=>{e.forEach(((e,r)=>{t(e,n,r)}))}))}class ke{constructor(){this.nestedMap=new Map,this.count=0}get size(){return this.count}tryGet(e,t){return xe(this.nestedMap,e,t)}getOrDefault(e,t,n){return function(e,t,n,r){const i=xe(e,t,n);return void 0!==i?i:r}(this.nestedMap,e,t,n)}tryAdd(e,t,n){const r=Se(this.nestedMap,e,t,n);return void 0===r&&this.count++,r}set(e,t,n){void 0!==this.tryAdd(e,t,n)&&we(this.nestedMap,e,t,n)}delete(e,t){const n=Ee(this.nestedMap,e,t);return n&&this.count--,n}forEach(e){Te(this.nestedMap,e)}clear(){this.count=0,this.nestedMap.clear()}values(){return Array.from(this.nestedMap.values()).flatMap((e=>e.values()))[0]}[Symbol.iterator](){return this.nestedMap[Symbol.iterator]()}}var Ne=n(202);function Fe(e){const t=new Map;for(const[n,r]of e)t.has(n)&&T("Duplicate codecs specified."),t.set(n,Ae(r));return{resolve(e){const n=t.get(e);return(0,i.v)(void 0!==n,1510),n},getSupportedFormats:()=>t.keys()}}class Ie{constructor(e){this.jsonCodec=e}encode(e,t){const n=this.jsonCodec.encode(e,t),r=JSON.stringify(n);return Ne.Ss.from(r)}decode(e,t){const n=(0,Ne.JR)(e,"utf8"),r=JSON.parse(n);return this.jsonCodec.decode(r,t)}}function Ae(e){return function(e){return"function"===typeof e.encode&&"function"===typeof e.decode}(e)?{json:t=e,binary:new Ie(t)}:e;var t}const De={json:{encode:()=>0,decode:()=>0},binary:{encode:()=>Ne.Ss.from(""),decode:()=>0}};function Oe(e,t,n){if(!n)return t;const r=n.compile(e);return{encode:(e,n)=>{const i=t.encode(e,n);return r.check(i)||T("Encoded schema should validate"),i},decode:(e,n)=>(r.check(e)||T("Encoded schema should validate"),t.decode(e,n))}}const Pe=m.ZU.Object({version:m.ZU.Number()});function Re(e,t,n,r){return function(e,t,n){let{jsonValidator:r}=t;return Oe(Pe,{encode:(t,r)=>{const s=n.encode(t,r);return(0,i.v)(e.has(s.version),2187),s},decode:(t,r)=>{const s=t;return(0,i.v)(e.has(s.version),2188),n.decode(t,r)}},r)}(t,e,Oe(n,r,e.jsonValidator))}class Me{constructor(e){this.idCompressor=e}encode(e){return"root"===e?e:this.idCompressor.normalizeToOpSpace(e)}decode(e,t){return"root"===e?e:((0,i.v)("number"===typeof e,2189),this.idCompressor.normalizeToSessionSpace(e,t))}}const Be=G(),Le=m.ZU.Union([m.ZU.Literal("root"),W()]);function qe(e,t){return e.localId===t.localId&&e.revision===t.revision}function _e(e,t){const{revision:n,change:r}=t;return{revision:n,change:r,parent:e}}const je=m.ZU.Number({multipleOf:1}),ze=W({minimum:-1,multipleOf:1}),Ue=m.ZU.Tuple([je,ze]),He=m.ZU.Array(Ue),Ve=m.ZU.Union([m.ZU.Tuple([Le,He]),m.ZU.Tuple([Le,je,ze])]),Ke=m.ZU.Object({version:m.ZU.Literal(1),data:m.ZU.Array(Ve),maxId:ze},{additionalProperties:!1});class Ge{constructor(e,t){this.idCompressor=e,this.options=t,this.revisionTagCodec=new Me(e)}encode(e){(0,i.v)(void 0!==e,2190);const t=this.revisionTagCodec.encode(e);return(0,i.v)("root"===t||t>=0,2191),t}decode(e){return(0,i.v)("root"===e||e>=0,2192),this.revisionTagCodec.decode(e,this.idCompressor.localSessionId)}}class We{constructor(e,t,n,r){this.name=e,this.rootIdAllocator=t,this.idCompressor=n,this.detachedNodeToField=new Map,this.options=null!==r&&void 0!==r?r:{jsonValidator:f},this.codec=function(e,t){const n=new Ge(e,t);return Re(t,new Set([1]),Ke,{encode:e=>{const t=[];for(const[r,i]of e.data){const e=n.encode(r),s=[...i];if(1===s.length){const n=[e,s[0][0],s[0][1]];t.push(n)}else{const n=[e,s];t.push(n)}}return{version:1,data:t,maxId:e.maxId}},decode:e=>{const t=new Map;for(const r of e.data){const e=new Map(2===r.length?r[1]:[[r[1],r[2]]]);t.set(n.decode(r[0]),e)}return{data:t,maxId:e.maxId}}})}(n,this.options)}clone(){const e=new We(this.name,ve(this.rootIdAllocator.getNextId()),this.idCompressor,this.options);return function(e,t){for(const[n,r]of e)t.set(n,new Map(r))}(this.detachedNodeToField,e.detachedNodeToField),e}*entries(){for(const[e,t]of this.detachedNodeToField)if(void 0!==e)for(const[n,r]of t)yield{id:{major:e,minor:n},root:r};else for(const[n,r]of t)yield{id:{minor:n},root:r}}updateMajor(e,t){const n=this.detachedNodeToField.get(e);if(void 0!==n){this.detachedNodeToField.delete(e);const r=this.detachedNodeToField.get(t);if(void 0===r)this.detachedNodeToField.set(t,n);else for(const[e,t]of n)(0,i.v)(void 0===r.get(e),1961),r.set(e,t)}}toFieldKey(e){return"".concat(this.name,"-").concat(e)}tryGetEntry(e){return xe(this.detachedNodeToField,e.major,e.minor)}getEntry(e){const t=this.tryGetEntry(e);return(0,i.v)(void 0!==t,1962),t}deleteEntry(e){const t=Ee(this.detachedNodeToField,e.major,e.minor);(0,i.v)(t,1963)}createEntry(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const n=this.rootIdAllocator.allocate(t);if(void 0!==e)for(let r=0;r<t;r++)(0,i.v)(void 0===xe(this.detachedNodeToField,e.major,e.minor+r),1998),we(this.detachedNodeToField,e.major,e.minor+r,n+r);return n}encode(){return this.codec.encode({data:this.detachedNodeToField,maxId:this.rootIdAllocator.getNextId()})}loadData(e){const t=this.codec.decode(e);this.rootIdAllocator=ve(t.maxId),this.detachedNodeToField=t.data}}const Je={};function Ze(e){return void 0!==e.attach&&void 0===e.detach}function $e(e){return void 0!==e.detach&&void 0===e.attach}function Qe(e){return void 0!==e.detach&&void 0!==e.attach}function Xe(e,t){const n={minor:t};return void 0!==e&&(n.major=e),n}function Ye(e,t){if(void 0!==e)return{...e,minor:e.minor+t}}function et(e,t,n){const r=new Map,s=new Map,o=[],a=[],c={func:it,detachedFieldIndex:n,detachPassRoots:r,attachPassRoots:s,rootTransfers:o,rootDestructions:a};st(e.build,c,t),nt(e.fields,t,c),tt(t,r,c),function(e,t,n,r){let s=e.flatMap((e=>{let{oldId:t,newId:n,count:r}=e;const i=[];if(o=n,(s=t).major!==o.major||s.minor!==o.minor)for(let a=0;a<r;a+=1)i.push({oldId:Ye(t,a),newId:Ye(n,a)});var s,o;return i}));for(;s.length>0;){const e=[],o=s.length;for(const{oldId:i,newId:a}of s){const s=n.tryGetEntry(i);if(void 0===s){e.push({oldId:i,newId:a});continue}let o=n.tryGetEntry(a);if(void 0!==o){e.push({oldId:i,newId:a});continue}o=n.createEntry(a);const c=t.get(s);void 0!==c&&(t.delete(s),t.set(o,c));const l=n.toFieldKey(s),u=n.toFieldKey(o);r.enterField(l),r.detach({start:0,end:1},u),r.exitField(l),n.deleteEntry(i)}(0,i.v)(e.length<o,1999),s=e}}(o,s,n,t);const l={func:at,detachedFieldIndex:n,detachPassRoots:r,attachPassRoots:s,rootTransfers:o,rootDestructions:a};nt(e.fields,t,l),tt(t,s,l),ot(e.destroy,l);for(const{id:i,count:u}of a)for(let e=0;e<u;e+=1){const r=Ye(i,e),s=n.getEntry(r),o=n.toFieldKey(s);t.destroy(o,1),n.deleteEntry(r)}}function tt(e,t,n){for(;t.size>0;)for(const[r,i]of t){t.delete(r);const s=n.detachedFieldIndex.toFieldKey(r);e.enterField(s),rt(0,i,e,n),e.exitField(s)}}function nt(e,t,n){if(void 0!==e)for(const[r,i]of e)t.enterField(r),n.func(i,t,n),t.exitField(r)}function rt(e,t,n,r){void 0!==t&&(n.enterNode(e),nt(t,n,r),n.exitNode(e))}function it(e,t,n){if(st(e.build,n,t),ot(e.destroy,n),void 0!==e.global)for(const{id:r,fields:i}of e.global){const e=n.detachedFieldIndex.getEntry(r);n.detachPassRoots.set(e,i),n.attachPassRoots.set(e,i)}if(void 0!==e.rename&&n.rootTransfers.push(...e.rename),void 0!==e.local){let r=0;for(const s of e.local)if(void 0!==s.fields&&((0,i.v)(void 0===s.attach||void 0!==s.detach,2e3),rt(r,s.fields,t,n)),$e(s))for(let e=0;e<s.count;e+=1){const i=n.detachedFieldIndex.createEntry(Ye(s.detach,e));void 0!==s.fields&&n.attachPassRoots.set(i,s.fields);const o=n.detachedFieldIndex.toFieldKey(i);t.detach({start:r,end:r+1},o)}else Ze(s)||(r+=s.count)}}function st(e,t,n){if(void 0!==e)for(const{id:r,trees:i}of e)for(let e=0;e<i.length;e+=1){const s=Ye(r,e);let o=t.detachedFieldIndex.tryGetEntry(s);if(void 0===o){o=t.detachedFieldIndex.createEntry(s);const r=t.detachedFieldIndex.toFieldKey(o);n.create([i[e]],r)}}}function ot(e,t){void 0!==e&&t.rootDestructions.push(...e)}function at(e,t,n){if(void 0!==e.local){let r=0;for(const i of e.local){if(Ze(i)||Qe(i))for(let e=0;e<i.count;e+=1){const s=Ye(i.attach,e),o=n.detachedFieldIndex.getEntry(s),a=n.detachedFieldIndex.toFieldKey(o);if(Qe(i)){const s=n.detachedFieldIndex.createEntry(Ye(i.detach,e)),o=n.detachedFieldIndex.toFieldKey(s);t.replace(a,{start:r,end:r+1},o),void 0!==i.fields&&n.attachPassRoots.set(s,i.fields)}else t.attach(a,1,r+e);n.detachedFieldIndex.deleteEntry(s);const c=n.attachPassRoots.get(o);void 0!==c&&(n.attachPassRoots.delete(o),rt(r,c,t,n))}else $e(i)||void 0===i.fields||rt(r,i.fields,t,n);$e(i)||(r+=i.count)}}}function ct(){let e=arguments.length>1?arguments[1]:void 0,t=arguments.length>2?arguments[2]:void 0;return new We(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Temp",ve(),e,t)}function lt(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return{free:()=>e.forEach((e=>e.free())),create:function(){for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];e.forEach((e=>e.create(...r))),t.forEach((e=>e.afterCreate(...r)))},destroy:function(){for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];t.forEach((e=>e.beforeDestroy(...r))),e.forEach((e=>e.destroy(...r)))},attach:(n,r,i)=>{t.forEach((e=>e.beforeAttach(n,r,i))),e.forEach((e=>e.attach(n,r,i))),t.forEach((e=>e.afterAttach(n,{start:i,end:i+r})))},detach:(n,r)=>{t.forEach((e=>e.beforeDetach(n,r))),e.forEach((e=>e.detach(n,r))),t.forEach((e=>e.afterDetach(n.start,n.end-n.start,r)))},replace:(n,r,i)=>{t.forEach((e=>e.beforeReplace(n,r,i))),e.forEach((e=>e.replace(n,r,i))),t.forEach((e=>e.afterReplace(n,r,i)))},enterNode:function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return e.forEach((e=>e.enterNode(...n)))},exitNode:function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return e.forEach((e=>e.exitNode(...n)))},enterField:function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return e.forEach((e=>e.enterField(...n)))},exitField:function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return e.forEach((e=>e.exitField(...n)))}}}var ut,ht;!function(e){e[e.Incompatible=0]="Incompatible",e[e.RequiresAdapters=1]="RequiresAdapters",e[e.Compatible=2]="Compatible"}(ut||(ut={})),function(e){e[e.None=0]="None",e[e.SchemaCompatible=1]="SchemaCompatible"}(ht||(ht={}));class dt{constructor(e,t){this.adapters=e,this.adaptedForViewSchema=t}}const ft="",pt="rootFieldKey",mt=gt(pt);function gt(e){return e}const vt="com.fluidframework.placeholder.aboveRoot";function yt(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:mt;const r=e.tryMoveCursorToField(function(){return{parent:void 0,fieldKey:arguments.length>0&&void 0!==arguments[0]?arguments[0]:mt}}(n),t);(0,i.v)(1===r,1069)}var bt,St;!function(e){e[e.Current=0]="Current",e[e.Cleared=1]="Cleared",e[e.Freed=2]="Freed"}(bt||(bt={})),function(e){e[e.NotFound=-1]="NotFound",e[e.Pending=0]="Pending",e[e.Ok=1]="Ok"}(St||(St={}));function wt(e){throw new Error(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Unreachable Case")}var Ct,xt,Et;!function(e){e.File="100644",e.Executable="100755",e.Directory="040000",e.Symlink="120000"}(Ct||(Ct={})),function(e){e.Blob="Blob",e.Tree="Tree",e.Attachment="Attachment"}(xt||(xt={}));class Tt{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"utf-8";this.path=e,this.mode=Ct.File,this.type=xt.Blob,this.value={contents:t,encoding:n}}}class kt{constructor(e,t){this.path=e,this.value=t,this.mode=Ct.Directory,this.type=xt.Tree}}class Nt{constructor(e,t){this.path=e,this.id=t,this.mode=Ct.File,this.type=xt.Attachment,this.value={id:t}}}function Ft(){const e={treeNodeCount:0,blobNodeCount:0,handleNodeCount:0,totalBlobSize:0,unreferencedBlobSize:0};for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(const i of n)e.treeNodeCount+=i.treeNodeCount,e.blobNodeCount+=i.blobNodeCount,e.handleNodeCount+=i.handleNodeCount,e.totalBlobSize+=i.totalBlobSize,e.unreferencedBlobSize+=i.unreferencedBlobSize;return e}function It(e){return"string"===typeof e?function(e){let t=e.length;for(let n=e.length-1;n>=0;n--){const r=e.charCodeAt(n);r>127&&r<=2047?t++:r>2047&&r<=65535&&(t+=2),r>=56320&&r<=57343&&n--}return t}(e):e.byteLength}function At(e,t){switch(e.type){case Et.Tree:t.treeNodeCount++;for(const n of Object.values(e.tree))At(n,t);return;case Et.Handle:return void t.handleNodeCount++;case Et.Blob:return t.blobNodeCount++,void(t.totalBlobSize+=It(e.content));default:return}}function Dt(e){const t=Ft();return At(e,t),t}function Ot(e,t,n){const r={type:Et.Blob,content:n};e.summary.tree[t]=r,e.stats.blobNodeCount++,e.stats.totalBlobSize+=It(n)}!function(e){e.Tree=1,e.Blob=2,e.Handle=3,e.Attachment=4}(Et||(Et={}));class Pt{get summary(){return{type:Et.Tree,tree:{...this.summaryTree}}}get stats(){return{...this.summaryStats}}constructor(){this.attachmentCounter=0,this.summaryTree={},this.summaryStats=Ft(),this.summaryStats.treeNodeCount++}addBlob(e,t){Ot({summary:{type:Et.Tree,tree:this.summaryTree},stats:this.summaryStats},e,t)}addHandle(e,t,n){this.summaryTree[e]={type:Et.Handle,handleType:t,handle:n},this.summaryStats.handleNodeCount++}addWithStats(e,t){this.summaryTree[e]=t.summary,this.summaryStats=Ft(this.summaryStats,t.stats)}addAttachment(e){this.summaryTree[this.attachmentCounter++]={id:e,type:Et.Attachment}}getSummaryTree(){return{summary:this.summary,stats:this.stats}}}function Rt(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e.id&&!t){const t=Ft();return t.handleNodeCount++,{summary:{handle:e.id,handleType:Et.Tree,type:Et.Handle},stats:t}}return function(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=new Pt;for(const i of e.entries)switch(i.type){case xt.Blob:{const e=i.value,t="base64"===e.encoding?Ne.Ss.from(e.contents,"base64"):e.contents;n.addBlob(i.path,t);break}case xt.Tree:{const e=Rt(i.value,t);n.addWithStats(i.path,e);break}case xt.Attachment:{const e=i.value.id;n.addAttachment(e);break}default:throw new Error("Unexpected TreeEntry type")}const r=n.getSummaryTree();return r.summary.unreferenced=e.unreferenced,r}(e,t)}function Mt(e){const t=new Pt;for(const[i,s]of Object.entries(e.blobs)){let r;if(void 0!==e.blobsContents){const t=e.blobsContents[s];void 0!==t&&(r=(0,Ne.JR)(t,"utf-8"))}else void 0!==e.blobs[s]&&(n=e.blobs[s],r=Ne.Ss.from(n,"base64").toString("utf8"));void 0!==r&&t.addBlob(i,r)}var n;for(const[i,s]of Object.entries(e.trees)){const e=Mt(s);t.addWithStats(i,e)}const r=t.getSummaryTree();return r.summary.unreferenced=e.unreferenced,r}function Bt(e){const t=[];for(const[n,r]of Object.entries(e.tree))switch(r.type){case Et.Blob:{let e,i="utf-8";"string"===typeof r.content?e=r.content:(e=(0,Ne.Km)(r.content,"base64"),i="base64"),t.push(new Tt(n,e,i));break}case Et.Tree:t.push(new kt(n,Bt(r)));break;case Et.Attachment:t.push(new Nt(n,r.id));break;case Et.Handle:throw new Error("Should not have Handle type in summary tree");default:wt(r,"Unexpected summary tree type")}return{entries:t,unreferenced:e.unreferenced}}function Lt(e,t){const n=null===e||void 0===e?void 0:e.entries.find((e=>".gcdata"===e.path));if(void 0===n)return!1;(0,i.v)(n.type===xt.Blob&&"utf-8"===n.value.encoding,"GC data should be a utf-8-encoded blob");const r=JSON.parse(n.value.contents);for(const[i,s]of Object.entries(r.gcNodes))s.forEach((e=>{t(i,e)}));return!0}class qt{constructor(){this.telemetry=new Map}set(e,t,n){this.telemetry.set("".concat(e).concat(t),n)}setMultiple(e,t,n){for(const r of Object.keys(n))this.set(e,"".concat(t,"_").concat(r),n[r])}get(e,t){return this.telemetry.get("".concat(e).concat(t))}serialize(){const e={};return this.telemetry.forEach(((t,n)=>{e[n]=t})),JSON.stringify(e)}}function _t(e){return e.replace(/\/+$/g,"")}class jt{constructor(){this.gcNodesSet={}}get gcNodes(){const e={};for(const[t,n]of Object.entries(this.gcNodesSet))e[t]=[...n];return e}addNode(e,t){this.gcNodesSet[e]=new Set(t)}prefixAndAddNodes(e,t){for(const[n,r]of Object.entries(t)){let t=n.replace(/^\/+/g,"");t="/".concat(e,"/").concat(t),t=_t(t),this.gcNodesSet[t]=new Set(r)}}addNodes(e){for(const[t,n]of Object.entries(e))this.gcNodesSet[t]=new Set(n)}addRouteToAllNodes(e){for(const t of Object.values(this.gcNodesSet))t.add(e)}getGCData(){return{gcNodes:this.gcNodes}}}const zt={randomUUID:"undefined"!==typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let Ut;const Ht=new Uint8Array(16);function Vt(){if(!Ut&&(Ut="undefined"!==typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Ut))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ut(Ht)}const Kt=[];for(let n=0;n<256;++n)Kt.push((n+256).toString(16).slice(1));function Gt(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return Kt[e[t+0]]+Kt[e[t+1]]+Kt[e[t+2]]+Kt[e[t+3]]+"-"+Kt[e[t+4]]+Kt[e[t+5]]+"-"+Kt[e[t+6]]+Kt[e[t+7]]+"-"+Kt[e[t+8]]+Kt[e[t+9]]+"-"+Kt[e[t+10]]+Kt[e[t+11]]+Kt[e[t+12]]+Kt[e[t+13]]+Kt[e[t+14]]+Kt[e[t+15]]}const Wt=function(e,t,n){if(zt.randomUUID&&!t&&!e)return zt.randomUUID();const r=(e=e||{}).random||(e.rng||Vt)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return Gt(r)};var Jt=n(7284);class Zt extends Jt.EventEmitter{constructor(){super(),this.addListener=super.addListener.bind(this),this.on=super.on.bind(this),this.once=super.once.bind(this),this.prependListener=super.prependListener.bind(this),this.prependOnceListener=super.prependOnceListener.bind(this),this.removeListener=super.removeListener.bind(this),this.off=super.off.bind(this)}}class $t extends Zt{constructor(e){super(),this.errorHandler=e}emit(e){try{for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return super.emit(e,...n)}catch(i){return this.errorHandler(e,i),!0}}}var Qt,Xt=n(5994),Yt=n(2264),en=n(1605);class tn{constructor(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new Map;this.eventBase=e,this.logger=t,this.sampleThreshold=n,this.includeAggregateMetrics=r,this.perBucketProperties=i,this.disposed=!1,this.measurementsMap=new Map}measure(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";const n=en.F.now(),r=e(),i=en.F.now()-n;let s=this.measurementsMap.get(t);var o,a,c;(void 0===s&&(s={count:0,duration:-1},this.measurementsMap.set(t,s)),s.count++,s.duration=i,this.includeAggregateMetrics)&&(s.totalDuration=(null!==(o=s.totalDuration)&&void 0!==o?o:0)+i,s.minDuration=Math.min(null!==(a=s.minDuration)&&void 0!==a?a:i,i),s.maxDuration=Math.max(null!==(c=s.maxDuration)&&void 0!==c?c:0,i));return s.count>=this.sampleThreshold&&this.flushBucket(t),r}flushBucket(e){const t=this.measurementsMap.get(e);if(void 0!==t&&0!==t.count){const n=this.perBucketProperties.get(e),r={...this.eventBase,...n,...t};this.logger.sendPerformanceEvent(r),this.measurementsMap.delete(e)}}dispose(e){for(const[t]of this.measurementsMap.entries())this.flushBucket(t)}}!function(e){e.Detached="Detached",e.Attaching="Attaching",e.Attached="Attached"}(Qt||(Qt={}));var nn=n(8698);const rn=e=>"__fluid_handle__"===(null===e||void 0===e?void 0:e.type);function sn(e,t){if(""===e)return void 0===t?"":t.absolutePath;{let n=e.startsWith("/")?e.slice(1):e;return n=n.endsWith("/")?n.slice(0,-1):n,void 0===t?"/".concat(n):"".concat("/"===t.absolutePath?"":t.absolutePath,"/").concat(n)}}var on;!function(e){e.cache="fluid-cache",e.clientDetails="fluid-client-details",e.loadMode="loadMode",e.reconnect="fluid-reconnect",e.sequenceNumber="fluid-sequence-number",e.version="version"}(on||(on={}));var an=n(8400);const cn=async e=>new Promise((t=>setTimeout((()=>t()),e)));class ln{static start(){const e=en.F.now();return new ln(e)}constructor(e){this.startTick=e,this.lastTick=e}trace(){const e=en.F.now(),t={totalTimeElapsed:e-this.startTick,duration:e-this.lastTick,tick:e};return this.lastTick=e,t}}function un(e,t,n,r,i){try{n?t.emit("connected",r):t.emit("disconnected",i)}catch(s){e.sendErrorEvent({eventName:"RaiseConnectedEventError"},s)}}var hn,dn,fn,pn,mn,gn;async function vn(e,t){const n=await e.readBlob(t),r=(0,Ne.JR)(n,"utf8");return JSON.parse(r)}function yn(e){if(null!==e&&"object"===typeof e&&!0===e.errorFromRequestFluidObject){const t=e;return{mimeType:"text/plain",status:t.code,value:t.message,get stack(){return t.stack},headers:t.underlyingResponseHeaders}}const t=(0,o.oD)();return{mimeType:"text/plain",status:500,value:"".concat(e),get stack(){var n;return null!==(n=null===e||void 0===e?void 0:e.stack)&&void 0!==n?n:t.stack}}}function bn(e,t){const n=e.value,r=(0,o.oD)();return{errorFromRequestFluidObject:!0,message:n,name:"Error",code:e.status,get stack(){var t;return null!==(t=e.stack)&&void 0!==t?t:r.stack},underlyingResponseHeaders:e.headers}}!function(e){e.summarizingClient="fluid-client-summarizer",e.createNew="createNew"}(hn||(hn={})),function(e){e[e.NoCaching=0]="NoCaching",e[e.Prefetch=1]="Prefetch"}(dn||(dn={})),function(e){e.default="default",e.noCache="noCache"}(fn||(fn={})),function(e){e.NoOp="noop",e.ClientJoin="join",e.ClientLeave="leave",e.Propose="propose",e.Reject="reject",e.Accept="accept",e.Summarize="summarize",e.SummaryAck="summaryAck",e.SummaryNack="summaryNack",e.Operation="op",e.NoClient="noClient",e.RoundTrip="tripComplete",e.Control="control"}(pn||(pn={})),function(e){e.ClientJoin="join",e.ClientLeave="leave"}(mn||(mn={})),function(e){e.ThrottlingError="ThrottlingError",e.InvalidScopeError="InvalidScopeError",e.BadRequestError="BadRequestError",e.LimitExceededError="LimitExceededError"}(gn||(gn={}));const Sn=e=>wn(404,"not found",e);function wn(e,t,n,r){var s;(0,i.v)(200!==e,411);const a=null===(s=n.url)||void 0===s?void 0:s.split("?")[0],c=(0,o.oD)();return{mimeType:"text/plain",status:e,value:void 0===a?t:"".concat(t,": ").concat(a),get stack(){return c.stack},headers:r}}class Cn{static getPathParts(e){const t=e.indexOf("?");return e.substring(0,t<0?e.length:t).split("/").reduce(((e,t)=>(void 0!==t&&t.length>0&&e.push(decodeURIComponent(t)),e)),[])}static create(e){return e instanceof Cn?e:new Cn(e)}constructor(e){this.request=e;const t=this.request.url.indexOf("?");this.query=t>=0?this.request.url.substring(t):""}get url(){return this.request.url}get headers(){return this.request.headers}get pathParts(){return void 0===this.requestPathParts&&(this.requestPathParts=Cn.getPathParts(this.url)),this.requestPathParts}isLeaf(e){return""===this.query&&this.pathParts.length===e}createSubRequest(e){const t=this.pathParts.length;if(e<0||e>t)throw new Error("incorrect sub-request");if(e===t&&this.url.includes("?"))return{url:"/".concat(this.query),headers:this.headers};const n="/".concat(this.pathParts.slice(e).join("/"));return{url:""===this.query?n:"".concat(n,"/").concat(this.query),headers:this.headers}}}const xn={randomUUID:"undefined"!==typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let En;const Tn=new Uint8Array(16);function kn(){if(!En&&(En="undefined"!==typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!En))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return En(Tn)}const Nn=[];for(let n=0;n<256;++n)Nn.push((n+256).toString(16).slice(1));function Fn(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return Nn[e[t+0]]+Nn[e[t+1]]+Nn[e[t+2]]+Nn[e[t+3]]+"-"+Nn[e[t+4]]+Nn[e[t+5]]+"-"+Nn[e[t+6]]+Nn[e[t+7]]+"-"+Nn[e[t+8]]+Nn[e[t+9]]+"-"+Nn[e[t+10]]+Nn[e[t+11]]+Nn[e[t+12]]+Nn[e[t+13]]+Nn[e[t+14]]+Nn[e[t+15]]}const In=function(e,t,n){if(xn.randomUUID&&!t&&!e)return xn.randomUUID();const r=(e=e||{}).random||(e.rng||kn)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return Fn(r)};class An{get IFluidHandleContext(){return this}constructor(e,t,n){this.path=e,this.runtime=t,this.routeContext=n,this.absolutePath=sn(e,this.routeContext)}attachGraph(){throw new Error("can't attach container runtime form within container!")}get isAttached(){return this.runtime.attachState!==Qt.Detached}async resolveHandle(e){return this.runtime.resolveHandle(e)}}class Dn{get IFluidDataStoreRegistry(){return this}constructor(e){this.map=new Map;for(const t of e){if(this.map.has(t[0]))throw new l("Duplicate entry names exist");this.map.set(t[0],t[1])}}async get(e){if(this.map.has(e))return this.map.get(e)}}function On(e,t){var n;const r=null!==(n=(0,Yt.Ln)(e).config.getBoolean("Fluid.Telemetry.DisableSampling"))&&void 0!==n&&n;return{send:n=>{(r||void 0===t||t.sample())&&e.send(n)},sendTelemetryEvent:n=>{(r||void 0===t||t.sample())&&e.sendTelemetryEvent(n)},sendErrorEvent:n=>{(r||void 0===t||t.sample())&&e.sendErrorEvent(n)},sendPerformanceEvent:n=>{(r||void 0===t||t.sample())&&e.sendPerformanceEvent(n)},isSamplingDisabled:r}}class Pn{constructor(e,t,n){this.clientId=e,this.deltaManager=t,this.msnTrackingTimestamp=0,this.latencyStatistics=new Map,this.firstConnection=!0,this.bootTime=en.F.now(),this.connectionStartTime=0,this.gap=0,this.logger=(0,Xt.pW)({logger:n,namespace:"OpPerf"});const r=(()=>{let e=-1;return{sample:()=>{e++;const t=e%Pn.DELTA_LATENCY_SAMPLE_RATE===0;return t&&(e=0),t}}})();this.deltaLatencyLogger=On(n,r),this.opLatencyLogger=On(n),this.deltaManager.on("pong",(e=>this.recordPingTime(e))),this.deltaManager.on("submitOp",(e=>this.beforeOpSubmit(e))),this.deltaManager.on("op",(e=>this.afterProcessingOp(e))),this.deltaManager.on("connect",((e,t)=>{this.clientId=e.clientId,void 0!==t&&(this.connectionOpSeqNumber=this.deltaManager.lastKnownSeqNumber,this.gap=t,this.connectionStartTime=en.F.now(),this.gap<=0&&this.reportGettingUpToDate())})),this.deltaManager.on("disconnect",(()=>{this.sequenceNumberForMsnTracking=void 0,this.clientSequenceNumberForLatencyStatistics=void 0,this.connectionOpSeqNumber=void 0,this.firstConnection=!1,this.latencyStatistics.clear()})),this.deltaManager.outbound.on("push",(e=>{for(const t of e)if(t.type===pn.Operation&&(this.opLatencyLogger.isSamplingDisabled||this.clientSequenceNumberForLatencyStatistics===t.clientSequenceNumber)){const e=this.latencyStatistics.get(t.clientSequenceNumber);(0,i.v)(void 0!==e,1986),(0,i.v)(void 0===e.opProcessingTimes.outboundPushEventTime,712),(0,i.v)(void 0===e.opPerfData.durationNetwork,713),e.opProcessingTimes.outboundPushEventTime=Date.now(),(0,i.v)(void 0===e.opPerfData.durationOutboundBatching,714),(0,i.v)(void 0!==e.opProcessingTimes.submitOpEventTime,715),e.opPerfData.durationOutboundBatching=e.opProcessingTimes.outboundPushEventTime-e.opProcessingTimes.submitOpEventTime}})),this.deltaManager.inbound.on("push",(e=>{if(this.clientId===e.clientId&&e.type===pn.Operation&&(this.opLatencyLogger.isSamplingDisabled||this.clientSequenceNumberForLatencyStatistics===e.clientSequenceNumber)){const t=this.latencyStatistics.get(e.clientSequenceNumber);(0,i.v)(void 0!==t,1987),void 0!==t.opProcessingTimes.outboundPushEventTime&&(t.opProcessingTimes.inboundPushEventTime=Date.now(),t.opPerfData.durationNetwork=t.opProcessingTimes.inboundPushEventTime-t.opProcessingTimes.outboundPushEventTime,t.opPerfData.lengthInboundQueue=this.deltaManager.inbound.length)}})),this.deltaManager.inbound.on("idle",((e,t)=>{"number"===typeof e&&e>=100&&this.logger.sendPerformanceEvent({eventName:"GetDeltas_OpProcessing",count:e,duration:t})}))}reportGettingUpToDate(){this.connectionOpSeqNumber=void 0,this.logger.sendPerformanceEvent({eventName:"ConnectionSpeed",duration:en.F.now()-this.connectionStartTime,ops:this.gap,timeToConnect:this.firstConnection?(0,Xt.T0)(this.connectionStartTime-this.bootTime):void 0,firstConnection:this.firstConnection})}recordPingTime(e){this.pingLatency=e,e>6e4&&this.logger.sendErrorEvent({eventName:"LatencyTooLong",duration:e}),this.deltaManager.active&&this.deltaLatencyLogger.sendPerformanceEvent({eventName:"DeltaLatency",duration:e})}beforeOpSubmit(e){(this.opLatencyLogger.isSamplingDisabled||void 0===this.clientSequenceNumberForLatencyStatistics&&e.clientSequenceNumber%Pn.OP_LATENCY_SAMPLE_RATE===1)&&((0,i.v)(void 0===this.latencyStatistics.get(e.clientSequenceNumber),1988),this.clientSequenceNumberForLatencyStatistics=e.clientSequenceNumber,this.latencyStatistics.set(e.clientSequenceNumber,{opProcessingTimes:{submitOpEventTime:Date.now()},opPerfData:{}}))}afterProcessingOp(e){const t=e.sequenceNumber;if(t===this.connectionOpSeqNumber&&this.reportGettingUpToDate(),void 0===this.sequenceNumberForMsnTracking&&t%1e3===0&&(this.sequenceNumberForMsnTracking=t,this.msnTrackingTimestamp=e.timestamp),void 0!==this.sequenceNumberForMsnTracking&&e.minimumSequenceNumber>=this.sequenceNumberForMsnTracking&&((0,i.v)(void 0!==this.msnTrackingTimestamp,718),this.logger.sendPerformanceEvent({eventName:"MsnStatistics",sequenceNumber:t,msnDistance:t-this.sequenceNumberForMsnTracking,duration:e.timestamp-this.msnTrackingTimestamp}),this.sequenceNumberForMsnTracking=void 0),this.clientId===e.clientId&&(this.opLatencyLogger.isSamplingDisabled||this.clientSequenceNumberForLatencyStatistics===e.clientSequenceNumber)){const n=this.latencyStatistics.get(e.clientSequenceNumber);(0,i.v)(void 0!==n,1989),(0,i.v)(void 0!==n.opProcessingTimes.submitOpEventTime,288);const r=Date.now();void 0!==n.opProcessingTimes.inboundPushEventTime&&(n.opPerfData.durationInboundToProcessing=r-n.opProcessingTimes.inboundPushEventTime);const s=r-n.opProcessingTimes.submitOpEventTime,o=s>5e3?"error":"performance";this.opLatencyLogger.sendPerformanceEvent({eventName:"OpRoundtripTime",sequenceNumber:t,referenceSequenceNumber:e.referenceSequenceNumber,duration:s,category:o,pingLatency:this.pingLatency,msnDistance:this.deltaManager.lastSequenceNumber-this.deltaManager.minimumSequenceNumber,...n.opPerfData}),this.clientSequenceNumberForLatencyStatistics=void 0,this.latencyStatistics.delete(e.clientSequenceNumber)}}}Pn.OP_LATENCY_SAMPLE_RATE=500,Pn.DELTA_LATENCY_SAMPLE_RATE=100;var Rn=n(1724);const Mn="2.0.0-rc.1.0.8";class Bn{get pendingMessagesCount(){return this.pendingMessages.length+this.initialMessages.length}hasPendingMessages(){return 0!==this.pendingMessagesCount}getLocalState(){if((0,i.v)(this.initialMessages.isEmpty(),745),!this.pendingMessages.isEmpty())return{pendingStates:[...this.savedOps,...this.pendingMessages.toArray()].map((e=>({...e,localOpMetadata:void 0})))}}constructor(e,t,n){this.stateHandler=e,this.logger=n,this.pendingMessages=new Rn,this.initialMessages=new Rn,this.savedOps=[],this.disposeOnce=new an.d((()=>{this.initialMessages.clear(),this.pendingMessages.clear()})),this.isProcessingBatch=!1,this.dispose=()=>this.disposeOnce.value,null!==t&&void 0!==t&&t.pendingStates&&this.initialMessages.push(...t.pendingStates)}get disposed(){return this.disposeOnce.evaluated}onSubmitMessage(e,t,n,r){const i={type:"message",referenceSequenceNumber:t,content:e,localOpMetadata:n,opMetadata:r};this.pendingMessages.push(i)}async applyStashedOpsAt(e){for(;!this.initialMessages.isEmpty();){const n=this.initialMessages.peekFront();if(void 0!==e){if(n.referenceSequenceNumber>e)break;if(n.referenceSequenceNumber<e)throw new Error("loaded from snapshot too recent to apply stashed ops")}try{const e=await this.stateHandler.applyStashedOp(n.content);n.localOpMetadata=e}catch(t){throw h.wrapIfUnrecognized(t,"applyStashedOp",n)}this.pendingMessages.push(this.initialMessages.shift())}}processPendingLocalMessage(e){this.maybeProcessBatchBegin(e);const t=this.pendingMessages.peekFront();(0,i.v)(void 0!==t,361),this.savedOps.push(t),this.pendingMessages.shift();const n=function(e){const{type:t,contents:n,compatDetails:r}=e;return JSON.stringify({type:t,contents:n,compatDetails:r})}(e);if(t.content===n)return this.maybeProcessBatchEnd(e),t.localOpMetadata;this.stateHandler.close(h.create("pending local message content mismatch","unexpectedAckReceived",e,{expectedMessageType:JSON.parse(t.content).type}))}maybeProcessBatchBegin(e){var t;null!==(t=e.metadata)&&void 0!==t&&t.batch&&((0,i.v)(!this.isProcessingBatch&&void 0===this.pendingBatchBeginMessage,363),this.pendingBatchBeginMessage=e,this.isProcessingBatch=!0)}maybeProcessBatchEnd(e){var t;if(!this.isProcessingBatch)return;(0,i.v)(void 0!==this.pendingBatchBeginMessage,365);const n=null===(t=e.metadata)||void 0===t?void 0:t.batch;if(this.pendingMessages.isEmpty()||!1===n){var r;const t=null===(r=this.pendingBatchBeginMessage.metadata)||void 0===r?void 0:r.batch;this.pendingBatchBeginMessage===e?(0,i.v)(void 0===t,366):!0===t&&!1===n||this.stateHandler.close(h.create("Pending batch inconsistency","processPendingLocalMessage",e,{runtimeVersion:Mn,batchClientId:null===this.pendingBatchBeginMessage.clientId?"null":this.pendingBatchBeginMessage.clientId,clientId:this.stateHandler.clientId(),hasBatchStart:!0===t,hasBatchEnd:!1===n,messageType:e.type,pendingMessagesCount:this.pendingMessagesCount})),this.pendingBatchBeginMessage=void 0,this.isProcessingBatch=!1}}replayPendingStates(){(0,i.v)(this.stateHandler.connected(),370),(0,i.v)(this.clientId!==this.stateHandler.clientId(),371),this.clientId=this.stateHandler.clientId(),(0,i.v)(this.initialMessages.isEmpty(),372);const e=this.pendingMessages.length;let t=this.pendingMessages.length;for(;t>0;){var n,r;let e=this.pendingMessages.shift();if(t--,(0,i.v)(!1!==(null===(n=e.opMetadata)||void 0===n?void 0:n.batch),1051),null!==(r=e.opMetadata)&&void 0!==r&&r.batch){(0,i.v)(t>0,1364);const n=[];for(;t>=0;){var s,o;if(n.push({content:e.content,localOpMetadata:e.localOpMetadata,opMetadata:e.opMetadata}),!1===(null===(s=e.opMetadata)||void 0===s?void 0:s.batch))break;(0,i.v)(t>0,1365),e=this.pendingMessages.shift(),t--,(0,i.v)(!0!==(null===(o=e.opMetadata)||void 0===o?void 0:o.batch),1366)}this.stateHandler.reSubmitBatch(n)}else this.stateHandler.reSubmit({content:e.content,localOpMetadata:e.localOpMetadata,opMetadata:e.opMetadata})}var a;(this.savedOps=[],this.stateHandler.isActiveConnection())&&(null===(a=this.logger)||void 0===a||a.sendTelemetryEvent({eventName:"PendingStatesReplayed",count:e,clientId:this.stateHandler.clientId()}))}}class Ln{constructor(){this.completed=!1,this.p=new Promise(((e,t)=>{this.res=e,this.rej=t}))}get isCompleted(){return this.completed}get promise(){return this.p}resolve(e){void 0!==this.res&&(this.completed=!0,this.res(e))}reject(e){void 0!==this.rej&&(this.completed=!0,this.rej(e))}}var qn=n(3941);const{dataCorruptionError:_n,dataProcessingError:jn,...zn}=s,Un={...zn,genericNetworkError:"genericNetworkError",authorizationError:"authorizationError",fileNotFoundOrAccessDeniedError:"fileNotFoundOrAccessDeniedError",offlineError:"offlineError",unsupportedClientProtocolVersion:"unsupportedClientProtocolVersion",writeError:"writeError",fetchFailure:"fetchFailure",fetchTokenError:"fetchTokenError",incorrectServerResponse:"incorrectServerResponse",fileOverwrittenInStorage:"fileOverwrittenInStorage",deltaStreamConnectionForbidden:"deltaStreamConnectionForbidden",locationRedirection:"locationRedirection",fluidInvalidSchema:"fluidInvalidSchema",fileIsLocked:"fileIsLocked",outOfStorageError:"outOfStorageError"};var Hn,Vn;function Kn(){return"object"===typeof navigator&&null!==navigator&&"boolean"===typeof navigator.onLine?navigator.onLine?Vn.Online:Vn.Offline:Vn.Unknown}!function(e){e.genericError="genericError",e.genericNetworkError="genericNetworkError",e.authorizationError="authorizationError",e.fileNotFoundOrAccessDeniedError="fileNotFoundOrAccessDeniedError",e.throttlingError="throttlingError",e.offlineError="offlineError",e.unsupportedClientProtocolVersion="unsupportedClientProtocolVersion",e.writeError="writeError",e.fetchFailure="fetchFailure",e.fetchTokenError="fetchTokenError",e.incorrectServerResponse="incorrectServerResponse",e.fileOverwrittenInStorage="fileOverwrittenInStorage",e.deltaStreamConnectionForbidden="deltaStreamConnectionForbidden",e.locationRedirection="locationRedirection",e.fluidInvalidSchema="fluidInvalidSchema",e.usageError="usageError",e.fileIsLocked="fileIsLocked",e.outOfStorageError="outOfStorageError"}(Hn||(Hn={})),function(e){e[e.Offline=0]="Offline",e[e.Online=1]="Online",e[e.Unknown=2]="Unknown"}(Vn||(Vn={}));class Gn extends o.iq{constructor(e,t,n){super(e,n),this.canRetry=t,this.errorType=Hn.genericNetworkError}}o.iq;class Wn extends o.iq{constructor(e,t,n){super(e,{...t,statusCode:400}),this.errorType=Wn.errorType,this.canRetry=!1,this.storageOnlyReason=n}}Wn.errorType=Hn.deltaStreamConnectionForbidden;class Jn extends o.iq{constructor(e,t,n,r){super(e,r,new Set(["claims","tenantId"])),this.claims=t,this.tenantId=n,this.errorType=Hn.authorizationError,this.canRetry=!1}}o.iq;class Zn extends o.iq{constructor(e,t,n,r){super(e,r),this.errorType=t,this.canRetry=n}}class $n extends Zn{constructor(e,t,n){super(e,t,!1,n),this.errorType=t}}class Qn extends o.iq{constructor(e,t,n){super(e,n),this.retryAfterSeconds=t,this.errorType=Hn.throttlingError,this.canRetry=!0}}function Xn(e,t,n){return void 0!==t.retryAfterMs&&t.canRetry?new Qn(e,t.retryAfterMs/1e3,n):new Gn(e,t.canRetry,n)}const Yn=e=>!0===(null===e||void 0===e?void 0:e.canRetry),er=e=>null===e||void 0===e?void 0:e.retryAfterSeconds,tr=e=>void 0!==(null===e||void 0===e?void 0:e.retryAfterSeconds)?1e3*e.retryAfterSeconds:void 0,nr="2.0.0-rc.1.0.8";async function rr(e,t,n,r){let i,s=!1,o=500,a=0;const c=en.F.now();let l;do{try{i=await e(r.cancel),s=!0}catch(h){var u;if(!Yn(h))throw n.sendTelemetryEvent({eventName:"".concat(t,"_cancel"),retry:a,duration:en.F.now()-c,fetchCallName:t},h),h;if(!0===(null===(u=r.cancel)||void 0===u?void 0:u.aborted))throw n.sendTelemetryEvent({eventName:"".concat(t,"_runWithRetryAborted"),retry:a,duration:en.F.now()-c,fetchCallName:t,reason:r.cancel.reason},h),new $n("runWithRetry was Aborted",Un.genericError,{driverVersion:nr,fetchCallName:t,reason:r.cancel.reason});0===a&&n.sendTelemetryEvent({eventName:"".concat(t,"_firstFailed"),duration:en.F.now()-c,fetchCallName:t},h),a++,l=h,o=or(o,h),r.onRetry&&r.onRetry(o,h),await cn(o)}}while(!s);return a>0&&n.sendTelemetryEvent({eventName:"".concat(t,"_lastError"),retry:a,duration:en.F.now()-c,fetchCallName:t},l),i}const ir=6e4,sr=8e3;function or(e,t){const n=tr(t);let r=Math.max(null!==n&&void 0!==n?n:0,2*e);return r=Math.min(r,(0,qn.Xy)(t)&&!0===t.getTelemetryProperties().endpointReached?ir:sr),r}class ar{get IFluidHandle(){return this}get isAttached(){return this.routeContext.isAttached&&this.attached}constructor(e,t,n,r){this.path=e,this.routeContext=t,this.get=n,this.onAttachGraph=r,this.attached=!1,this.absolutePath=sn(e,this.routeContext)}attachGraph(){var e;this.attached||(this.attached=!0,null===(e=this.onAttachGraph)||void 0===e||e.call(this))}bind(e){throw new Error("Cannot bind to blob handle")}}class cr extends Zt{constructor(e,t,n,r,s,o,a){let l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:{},u=arguments.length>8?arguments[8]:void 0;super(),this.routeContext=e,this.getStorage=n,this.blobRequested=s,this.isBlobDeleted=o,this.runtime=a,this.closeContainer=u,this.pendingBlobs=new Map,this.opsInFlight=new Map,this.tombstonedBlobs=new Set,this.stopAttaching=!1,this.mc=(0,Yt.CL)({logger:this.runtime.logger,namespace:"BlobManager"}),this.redirectTable=this.load(t),Object.entries(l).forEach((e=>{let[t,n]=e;const r=(0,Ne.Xg)(n.blob,"base64"),i=n.attached,s=n.acked,o=n.storageId;if(n.minTTLInSeconds&&n.uploadTime){const e=(Date.now()-n.uploadTime)/1e3;if(n.minTTLInSeconds-e>n.minTTLInSeconds/2)return void this.pendingBlobs.set(t,{blob:r,uploading:!1,opsent:!0,handleP:new Ln,storageId:o,uploadP:void 0,uploadTime:n.uploadTime,minTTLInSeconds:n.minTTLInSeconds,attached:i,acked:s})}this.pendingBlobs.set(t,{blob:r,uploading:!0,handleP:new Ln,uploadP:this.uploadBlob(t,r),attached:i,acked:s,opsent:!0,pendingStashed:!0})})),this.sendBlobAttachOp=(e,t)=>{const n=this.pendingBlobs.get(e);if((0,i.v)(void 0!==n,1829),null!==n&&void 0!==n&&n.uploadTime&&null!==n&&void 0!==n&&n.minTTLInSeconds){const r=(Date.now()-n.uploadTime)/1e3,i=n.minTTLInSeconds-r<0;this.mc.logger.sendTelemetryEvent({eventName:"sendBlobAttach",secondsSinceUpload:r,minTTLInSeconds:n.minTTLInSeconds,expired:i}),i&&this.closeContainer(new c("Trying to submit a BlobAttach for expired blob",void 0,{localId:e,blobId:t,secondsSinceUpload:r}))}return n.opsent=!0,r(e,t)}}get allBlobsAttached(){for(const[,e]of this.pendingBlobs)if(!1===e.attached)return!1;return!0}get hasPendingBlobs(){return this.runtime.attachState!==Qt.Attached&&this.redirectTable.size>0||this.pendingBlobs.size>0}createAbortError(e){return new o.iq("uploadBlob aborted",{acked:null===e||void 0===e?void 0:e.acked,uploadTime:null===e||void 0===e?void 0:e.uploadTime})}hasPendingStashedBlobs(){return Array.from(this.pendingBlobs.values()).some((e=>!0===e.pendingStashed))}async processStashedChanges(){const e=Array.from(this.pendingBlobs.values()).filter((e=>!0===e.pendingStashed)).map((async e=>e.uploadP));await Xt.Bt.timedExecAsync(this.mc.logger,{eventName:"BlobUploadProcessStashedChanges",count:e.length},(async()=>Promise.all(e)),{start:!0,end:!0})}get storageIds(){const e=new Set(this.redirectTable.values()),t=e.delete(void 0);return(0,i.v)(!t||this.runtime.attachState===Qt.Detached&&0===e.size,898),e}async getBlob(e){this.verifyBlobNotDeleted(e),this.blobRequested(lr(e));const t=this.pendingBlobs.get(e);if(t)return t.blob;let n;if(this.runtime.attachState===Qt.Detached)(0,i.v)(this.redirectTable.has(e),899),n=e;else{const t=this.redirectTable.get(e);(0,i.v)(!!t,287),n=t}return Xt.Bt.timedExecAsync(this.mc.logger,{eventName:"AttachmentReadBlob",id:n},(async()=>this.getStorage().readBlob(n)),{end:!0,cancel:"error"})}getBlobHandle(e){(0,i.v)(this.redirectTable.has(e)||this.pendingBlobs.has(e),900);const t=this.pendingBlobs.get(e),n=t?()=>{t.attached=!0,this.emit("blobAttached",t),this.deletePendingBlobMaybe(e)}:void 0;return new ar("".concat(cr.basePath,"/").concat(e),this.routeContext,(async()=>this.getBlob(e)),n)}async createBlobDetached(e){const t=await this.getStorage().createBlob(e);return this.setRedirection(t.id,void 0),this.getBlobHandle(t.id)}async createBlob(e,t){if(this.runtime.attachState===Qt.Detached)return this.createBlobDetached(e);if(this.runtime.attachState===Qt.Attaching&&(this.mc.logger.sendTelemetryEvent({eventName:"CreateBlobWhileAttaching"}),await new Promise((e=>this.runtime.once("attached",e)))),(0,i.v)(this.runtime.attachState===Qt.Attached,901),null!==t&&void 0!==t&&t.aborted)throw this.createAbortError();const n=In(),r={blob:e,uploading:!0,handleP:new Ln,uploadP:this.uploadBlob(n,e),attached:!1,acked:!1,abortSignal:t,opsent:!1};this.pendingBlobs.set(n,r);const s=()=>{r.acked||r.handleP.reject(this.createAbortError(r))};return null===t||void 0===t||t.addEventListener("abort",s,{once:!0}),r.handleP.promise.finally((()=>{null===t||void 0===t||t.removeEventListener("abort",s)}))}async uploadBlob(e,t){var n;return rr((async()=>{try{return await this.getStorage().createBlob(t)}catch(n){const t=this.pendingBlobs.get(e);if((0,i.v)(!!t,903),t.opsent&&!Yn(n))throw(0,o.J4)(n,(()=>new o.iq("uploadBlob error",{canRetry:!0})));throw n}}),"createBlob",this.mc.logger,{cancel:null===(n=this.pendingBlobs.get(e))||void 0===n?void 0:n.abortSignal}).then((t=>this.onUploadResolve(e,t)),(t=>{var n;null===(n=this.pendingBlobs.get(e))||void 0===n||n.handleP.reject(t),this.deletePendingBlob(e)}))}setRedirection(e,t){this.redirectTable.set(e,t)}deletePendingBlobMaybe(e){if(this.pendingBlobs.has(e)){const t=this.pendingBlobs.get(e);null!==t&&void 0!==t&&t.attached&&null!==t&&void 0!==t&&t.acked&&this.deletePendingBlob(e)}}deletePendingBlob(e){this.pendingBlobs.delete(e)&&!this.hasPendingBlobs&&this.emit("noPendingBlobs")}onUploadResolve(e,t){var n;const r=this.pendingBlobs.get(e);if((0,i.v)(void 0!==r,1736),(!0!==(null===(n=r.abortSignal)||void 0===n?void 0:n.aborted)||r.opsent)&&!this.stopAttaching){var s;if((0,i.v)(!0===r.uploading,902),r.storageId=t.id,r.uploadTime=Date.now(),r.minTTLInSeconds=t.minTTLInSeconds,r.opsent||this.sendBlobAttachOp(e,t.id),this.storageIds.has(t.id))this.setRedirection(e,t.id),r.handleP.resolve(this.getBlobHandle(e)),this.deletePendingBlobMaybe(e);else this.opsInFlight.set(t.id,(null!==(s=this.opsInFlight.get(t.id))&&void 0!==s?s:[]).concat(e));return t}this.deletePendingBlob(e)}reSubmit(e){(0,i.v)(!!e,907);const{localId:t,blobId:n}=e;(0,i.v)(void 0!==t,1293);const r=this.pendingBlobs.get(t);return n?this.sendBlobAttachOp(t,n):((0,i.v)(!0===(null===r||void 0===r?void 0:r.opsent)&&!(null===r||void 0===r||!r.storageId),909),this.sendBlobAttachOp(t,null===r||void 0===r?void 0:r.storageId))}processBlobAttachOp(e,t){var n,r;const s=null===(n=e.metadata)||void 0===n?void 0:n.localId,o=null===(r=e.metadata)||void 0===r?void 0:r.blobId;if(s){var a;const e=this.pendingBlobs.get(s);if(null!==e&&void 0!==e&&null!==(a=e.abortSignal)&&void 0!==a&&a.aborted)return void this.deletePendingBlob(s);null!==e&&void 0!==e&&e.pendingStashed&&(e.pendingStashed=!1)}if((0,i.v)(void 0!==o,298),void 0!==s&&this.setRedirection(s,o),this.setRedirection(o,o),t){(0,i.v)(void 0!==s,1294);const e=this.opsInFlight.get(o);void 0!==e&&(e.forEach((e=>{const t=this.pendingBlobs.get(e);(0,i.v)(void 0!==t,911),this.setRedirection(e,o),t.acked=!0,t.handleP.resolve(this.getBlobHandle(e)),this.deletePendingBlobMaybe(e)})),this.opsInFlight.delete(o));const t=this.pendingBlobs.get(s);t&&(t.acked=!0,t.handleP.resolve(this.getBlobHandle(s)),this.deletePendingBlobMaybe(s))}}static async load(e,t){if(!e)return{};let n;const r=e.blobs[this.redirectTableBlobName];r&&(n=await t(r));return{ids:Object.entries(e.blobs).filter((e=>{let[t,n]=e;return t!==this.redirectTableBlobName})).map((e=>{let[t,n]=e;return n})),redirectTable:n}}load(e){var t,n,r;this.mc.logger.sendTelemetryEvent({eventName:"AttachmentBlobsLoaded",count:null!==(t=null===(n=e.ids)||void 0===n?void 0:n.length)&&void 0!==t?t:0,redirectTable:null===(r=e.redirectTable)||void 0===r?void 0:r.length});const i=new Map(e.redirectTable);if(e.ids){const t=this.runtime.attachState===Qt.Detached;e.ids.forEach((e=>i.set(e,t?void 0:e)))}return i}summarize(e){const t=this.storageIds.size>0?Array.from(this.storageIds):Array.from(this.redirectTable.keys()),n=new Pt;return t.forEach((e=>{n.addAttachment(e)})),this.redirectTable.size>t.length&&n.addBlob(cr.redirectTableBlobName,JSON.stringify(Array.from(this.redirectTable.entries()).filter((e=>{let[t,n]=e;return t!==n})))),n.getSummaryTree()}getGCData(){const e={gcNodes:{}};for(const[t,n]of this.redirectTable)(0,i.v)(!!n,912),t!==n&&(e.gcNodes[lr(t)]=[]);return e}updateUnusedRoutes(e){this.deleteBlobsFromRedirectTable(e)}deleteSweepReadyNodes(e){return this.deleteBlobsFromRedirectTable(e),Array.from(e)}deleteBlobsFromRedirectTable(e){if(0===e.length)return;const t=new Set;for(const n of e){const e=ur(n),r=this.isBlobDeleted(n);if(!this.redirectTable.has(e)){this.mc.logger.sendTelemetryEvent({eventName:"DeletedAttachmentBlobNotFound",category:r?"generic":"error",blobId:e,details:{alreadyDeleted:r}});continue}const s=this.redirectTable.get(e);(0,i.v)(!!s,1467),t.add(s),this.redirectTable.delete(e)}for(const[n,r]of this.redirectTable.entries())(0,i.v)(!!r,1468),t.has(r)&&n!==r&&t.delete(r);for(const n of t)this.redirectTable.delete(n)}updateTombstonedRoutes(e){const t=new Set;for(const n of e){const e=ur(n);t.add(e)}for(const n of this.tombstonedBlobs)t.has(n)||this.tombstonedBlobs.delete(n);for(const n of t)this.tombstonedBlobs.add(n)}verifyBlobNotDeleted(e){if(!this.isBlobDeleted(lr(e)))return;const t={url:e},n=bn(wn(404,"Blob was deleted",t));throw this.mc.logger.sendErrorEvent({eventName:"GC_Deleted_Blob_Requested",pkg:cr.basePath},n),n}setRedirectTable(e){(0,i.v)(this.runtime.attachState===Qt.Detached,594),(0,i.v)(this.redirectTable.size===e.size,913);for(const[t,n]of e)(0,i.v)(this.redirectTable.has(t),596),this.setRedirection(t,n),this.setRedirection(n,n)}async attachAndGetPendingBlobs(e){return Xt.Bt.timedExecAsync(this.mc.logger,{eventName:"GetPendingBlobs"},(async()=>{if(0===this.pendingBlobs.size)return;const t={},n=new Set;for(;n.size<this.pendingBlobs.size;){const t=[];for(const[r,i]of this.pendingBlobs)n.has(i)||(n.add(i),i.handleP.resolve(this.getBlobHandle(r)),t.push(new Promise(((t,n)=>{null===e||void 0===e||e.addEventListener("abort",(()=>{this.stopAttaching=!0,n(new Error("Operation aborted"))}),{once:!0});const r=e=>{e===i&&(this.off("blobAttached",r),t())};i.attached?t():this.on("blobAttached",r)}))));await Promise.allSettled(t).catch((()=>{}))}for(const[r,s]of this.pendingBlobs)null===e||void 0===e||!e.aborted||s.attached?((0,i.v)(!0===s.attached,1936),s.opsent||this.sendBlobAttachOp(r,s.storageId),t[r]={blob:(0,Ne.JR)(s.blob,"base64"),storageId:s.storageId,attached:s.attached,acked:s.acked,minTTLInSeconds:s.minTTLInSeconds,uploadTime:s.uploadTime}):this.mc.logger.sendTelemetryEvent({eventName:"UnableToStashBlob",id:r});return Object.keys(t).length>0?t:void 0}))}}function lr(e){return"/".concat(cr.basePath,"/").concat(e)}function ur(e){const t=e.split("/");return(0,i.v)(3===t.length&&t[1]===cr.basePath,1469),t[2]}cr.basePath="_blobs",cr.redirectTableBlobName=".redirectTable";class hr{get IFluidHandle(){return this}get isAttached(){return this.routeContext.isAttached}get visible(){return this.isAttached||this.locallyVisible}constructor(e,t,n){this.value=e,this.path=t,this.routeContext=n,this.pendingHandlesToMakeVisible=new Set,this.locallyVisible=!1,this.absolutePath=sn(t,this.routeContext)}async get(){return this.value}attachGraph(){this.visible||(this.locallyVisible=!0,this.pendingHandlesToMakeVisible.forEach((e=>{e.attachGraph()})),this.pendingHandlesToMakeVisible.clear(),this.routeContext.attachGraph())}bind(e){this.visible?e.attachGraph():this.pendingHandlesToMakeVisible.add(e)}}function dr(e){const t=e.filter((e=>""!==e&&"/"!==e)),n=new Map;for(const r of t){(0,i.v)(r.startsWith("/"),1504);const e=r.split("/")[1],t=r.slice(e.length+1),s=n.get(e);void 0!==s?s.push(t):n.set(e,[t])}return n}function fr(e){throw new Error(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Unreachable Case")}function pr(e){const t=e.type===Et.Handle?e.handleType:e.type;switch(t){case Et.Blob:case Et.Attachment:return Ct.File;case Et.Tree:return Ct.Directory;default:fr(t,"Unknown type: ".concat(t))}}function mr(e){const t=e.type===Et.Handle?e.handleType:e.type;switch(t){case Et.Blob:case Et.Attachment:return"blob";case Et.Tree:return"tree";default:fr(t,"Unknown type: ".concat(t))}}function gr(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Map,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const r={},i={id:e.sha,blobs:{},trees:{}};r[""]=i;for(const s of e.tree){const e=n?s.path.replace(/^\.app\//,""):s.path,i=e.lastIndexOf("/"),o=e.slice(0,Math.max(0,i)),a=e.slice(i+1),c=r[o];if("tree"===s.type){const t={id:s.sha,blobs:{},commits:{},trees:{}};c.trees[decodeURIComponent(a)]=t,r[e]=t}else{if("blob"!==s.type)throw new Error("Unknown entry type!!");c.blobs[decodeURIComponent(a)]=s.sha,t.set(s.sha,"/".concat(e))}}return i}const vr={randomUUID:"undefined"!==typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let yr;const br=new Uint8Array(16);function Sr(){if(!yr&&(yr="undefined"!==typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!yr))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return yr(br)}const wr=[];for(let n=0;n<256;++n)wr.push((n+256).toString(16).slice(1));function Cr(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return wr[e[t+0]]+wr[e[t+1]]+wr[e[t+2]]+wr[e[t+3]]+"-"+wr[e[t+4]]+wr[e[t+5]]+"-"+wr[e[t+6]]+wr[e[t+7]]+"-"+wr[e[t+8]]+wr[e[t+9]]+"-"+wr[e[t+10]]+wr[e[t+11]]+wr[e[t+12]]+wr[e[t+13]]+wr[e[t+14]]+wr[e[t+15]]}const xr=function(e,t,n){if(vr.randomUUID&&!t&&!e)return vr.randomUUID();const r=(e=e||{}).random||(e.rng||Sr)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return Cr(r)};function Er(e,t,n){const r=[];for(const s of t){const t="".concat(e).concat(s.path);if(s.type===xt.Blob){const e=s.value,i=(0,Ne.Xg)(e.contents,e.encoding),o=xr();n.set(o,i);const a={mode:Ct[s.mode],path:t,sha:o,size:0,type:"blob",url:""};r.push(a)}else if(s.type===xt.Tree){(0,i.v)(s.type===xt.Tree,257);const e=s.value,o={mode:Ct[s.mode],path:t,sha:"",size:-1,type:"tree",url:""};r.push(o);const a=Er("".concat(t,"/"),e.entries,n);r.push(...a)}}return r}function Tr(e,t){return{sha:"",tree:Er("",e,t),url:""}}function kr(e,t){return gr(Tr(e,t))}class Nr{constructor(e){this.notBoundContexts=new Set,this._contexts=new Map,this.deferredContexts=new Map,this.disposeOnce=new an.d((()=>{for(const[e,t]of this.deferredContexts)t.promise.then((e=>{e.dispose()})).catch((t=>{this._logger.sendErrorEvent({eventName:"FluidDataStoreContextDisposeError",fluidDataStoreId:e},t)}))})),this.dispose=()=>this.disposeOnce.value,this._logger=(0,Xt.pW)({logger:e})}[Symbol.iterator](){return this._contexts.entries()}get size(){return this._contexts.size}get disposed(){return this.disposeOnce.evaluated}notBoundLength(){return this.notBoundContexts.size}isNotBound(e){return this.notBoundContexts.has(e)}has(e){return this._contexts.has(e)}get(e){return this._contexts.get(e)}delete(e){return this.deferredContexts.delete(e),this.notBoundContexts.delete(e),this._contexts.delete(e)}getUnbound(e){const t=this._contexts.get(e);if(void 0!==t&&this.notBoundContexts.has(e))return t}addUnbound(e){const t=e.id;(0,i.v)(!this._contexts.has(t),344),this._contexts.set(t,e),this.notBoundContexts.add(t),this.ensureDeferred(t)}async getBoundOrRemoted(e,t){const n=this.ensureDeferred(e);if(t||n.isCompleted)return n.promise}ensureDeferred(e){const t=this.deferredContexts.get(e);if(t)return t;const n=new Ln;return this.deferredContexts.set(e,n),n}bind(e){const t=this.notBoundContexts.delete(e);(0,i.v)(t,345),this.resolveDeferred(e)}resolveDeferred(e){const t=this._contexts.get(e);(0,i.v)(!!t,346),(0,i.v)(!this.notBoundContexts.has(e),347);const n=this.deferredContexts.get(e);(0,i.v)(!!n,348),n.resolve(t)}addBoundOrRemoted(e){const t=e.id;(0,i.v)(!this._contexts.has(t),349),this._contexts.set(t,e),this.ensureDeferred(t),this.resolveDeferred(t)}}class Fr{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e;this.threshold=e,this.logger=t,this.thresholdMultiple=n}send(e,t){t<this.threshold||this.logger.sendPerformanceEvent({eventName:e,value:t})}sendIfMultiple(e,t){t===this.thresholdMultiple&&(this.logger.sendPerformanceEvent({eventName:e,value:t}),this.thresholdMultiple=2*this.thresholdMultiple)}}function Ir(e){return e.summaryFormatVersion?e.summaryFormatVersion:"0.1"===e.snapshotFormatVersion?1:0}function Ar(e){return!!e.summaryFormatVersion&&!e.disableIsolatedChannels}const Dr=".aliases",Or=".metadata",Pr=".chunks",Rr=".electedSummarizer",Mr=".blobs",Br=".idCompressor";const Lr=[".protocol",".logTail",".serviceProtocol",Mr,nn.aT,Br],qr=".component";function _r(e){e.summary={type:Et.Tree,tree:{[nn._1]:e.summary}},e.stats.treeNodeCount++}const jr="summarizer";class zr extends Zt{get electedClientId(){var e;return null===(e=this.clientElection.electedClient)||void 0===e?void 0:e.clientId}get electedParentId(){var e;return null===(e=this.clientElection.electedParent)||void 0===e?void 0:e.clientId}constructor(e,t,n,r){super(),this.logger=e,this.summaryCollection=t,this.clientElection=n,this.maxOpsSinceLastSummary=r,this.lastReportedSeq=0,this.summaryCollection.on("default",(e=>{var t;let{sequenceNumber:n}=e;const r=this.electedClientId;if(void 0===r)return void(this.clientElection.eligibleCount>0&&this.clientElection.resetElectedClient(n));const i=this.clientElection.electionSequenceNumber;if(n-(null!==(t=this.lastSummaryAckSeqForClient)&&void 0!==t?t:i)>this.maxOpsSinceLastSummary){var s;if(n-this.lastReportedSeq>this.maxOpsSinceLastSummary)this.logger.sendTelemetryEvent({eventName:"ElectedClientNotSummarizing",electedClientId:r,lastSummaryAckSeqForClient:this.lastSummaryAckSeqForClient,electionSequenceNumber:i,nextElectedClientId:null===(s=this.clientElection.peekNextElectedClient())||void 0===s?void 0:s.clientId}),this.lastReportedSeq=n}})),this.summaryCollection.on(pn.SummaryAck,(e=>{this.lastSummaryAckSeqForClient=e.sequenceNumber})),this.clientElection.on("election",((e,t)=>{this.lastSummaryAckSeqForClient=void 0,void 0===e&&this.clientElection.eligibleCount>0&&this.clientElection.resetElectedClient(t),this.emit("electedSummarizerChanged")}))}serialize(){var e;const{electedClientId:t,electedParentId:n,electionSequenceNumber:r}=this.clientElection.serialize();return{electedClientId:t,electedParentId:n,electionSequenceNumber:null!==(e=this.lastSummaryAckSeqForClient)&&void 0!==e?e:r}}static isClientEligible(e){const t=e.client.details;return void 0===t||zr.clientDetailsPermitElection(t)}}zr.clientDetailsPermitElection=e=>e.capabilities.interactive||e.type===jr;const Ur="gcGeneration",Hr="Fluid.GarbageCollection.RunSweep",Vr="Fluid.GarbageCollection.DisableTombstone",Kr="Fluid.GarbageCollection.ThrowOnTombstoneLoadOverride",Gr="Fluid.GarbageCollection.ThrowOnTombstoneUsage",Wr="Fluid.GarbageCollection.DetectOutboundRoutesViaDDS",Jr="Fluid.GarbageCollection.DisableAutoRecovery",Zr=864e5,$r=5*Zr,Qr=7*Zr,Xr=30*Zr,Yr=1*Zr,ei={DataStore:"DataStore",SubDataStore:"SubDataStore",Blob:"Blob",Other:"Other"},ti="Sweep",ni="TombstoneLoaded",ri="Active",ii="Inactive",si="TombstoneReady",oi="SweepReady";class ai{constructor(e,t,n,r,i,s,o){this.mc=e,this.configs=t,this.isSummarizerClient=n,this.createContainerMetadata=r,this.getNodeType=i,this.getNodeStateTracker=s,this.getNodePackagePath=o,this.loggedUnreferencedEvents=new Set,this.pendingEventsQueue=[]}shouldLogNonActiveEvent(e,t,n,r){return n.state!==ri&&(e!==ei.Other&&((e!==ei.SubDataStore||"Changed"!==t)&&!this.loggedUnreferencedEvents.has(r)))}nodeUsed(e){var t;if(void 0===e.currentReferenceTimestampMs)return;const n=this.getNodeStateTracker(e.id),r=this.getNodeType(e.id),i=(()=>{switch(null===n||void 0===n?void 0:n.state){case ii:return this.configs.inactiveTimeoutMs;case si:return this.configs.tombstoneTimeoutMs;case oi:return this.configs.tombstoneTimeoutMs&&this.configs.tombstoneTimeoutMs+this.configs.sweepGracePeriodMs;default:return}})(),{usageType:s,currentReferenceTimestampMs:a,packagePath:c,id:l,fromId:u,...h}=e,{persistedGcFeatureMatrix:d,...f}=this.configs,p={type:r,unrefTime:null!==(t=null===n||void 0===n?void 0:n.unreferencedTimestampMs)&&void 0!==t?t:-1,age:void 0!==n?e.currentReferenceTimestampMs-n.unreferencedTimestampMs:-1,timeout:i,...(0,Xt.Df)({id:l,fromId:u}),...h,...this.createContainerMetadata,gcConfigs:{...f,...d}};if(e.isTombstoned&&this.logTombstoneUsageTelemetry(e,p,r,s),void 0===n)return;const m=n.state,g="".concat(m,"-").concat(e.id,"-").concat(e.usageType);if(this.shouldLogNonActiveEvent(r,e.usageType,n,g))if(this.loggedUnreferencedEvents.add(g),this.isSummarizerClient)this.pendingEventsQueue.push({...p,usageType:e.usageType,state:m});else if("Loaded"===e.usageType){var v;const{id:t,fromId:n,headers:r,gcConfigs:i,...s}=p,a={eventName:"".concat(m,"Object_").concat(e.usageType),...(0,Xt.Df)({pkg:null===(v=e.packagePath)||void 0===v?void 0:v.join("/")}),stack:(0,o.aX)(),id:t,fromId:n,headers:{...r},details:s,gcConfigs:i};this.mc.logger.sendTelemetryEvent(a)}}logTombstoneUsageTelemetry(e,t,n,r){var i;const{id:s,fromId:a,headers:c,gcConfigs:l,...u}=t,h="Loaded"===r?"Requested":r,d={eventName:"GC_Tombstone_".concat(n,"_").concat(h),pkg:(0,Xt.Df)({pkg:null===(i=e.packagePath)||void 0===i?void 0:i.join("/")}).pkg,stack:(0,o.aX)(),id:s,fromId:a,headers:{...c},details:u,gcConfigs:l,tombstoneFlags:{DisableTombstone:this.mc.config.getBoolean(Vr),ThrowOnTombstoneUsage:this.mc.config.getBoolean(Gr),ThrowOnTombstoneLoad:this.mc.config.getBoolean(Kr)},sweepFlags:{EnableSweepFlag:this.mc.config.getBoolean(Hr)}};"Loaded"===r&&this.configs.throwOnTombstoneLoad&&(null===c||void 0===c||!c.allowTombstone)||"Changed"===r&&this.configs.throwOnTombstoneUsage?this.mc.logger.sendErrorEvent(d):this.mc.logger.sendTelemetryEvent(d)}logIfMissingExplicitReferences(e,t,n,r){for(const[o,a]of Object.entries(e.gcNodes)){var i,s;const e=null!==(i=t.gcNodes[o])&&void 0!==i?i:[],c=null!==(s=n.get(o))&&void 0!==s?s:[],l=[];for(const t of a){const n=this.getNodeType(t);n!==ei.DataStore&&n!==ei.Blob||o.startsWith(t)||e.includes(t)||c.includes(t)||l.push(t)}l.length>0&&r.sendTelemetryEvent({eventName:"gcUnknownOutboundReferences",...(0,Xt.Df)({id:o,routes:JSON.stringify(l)})})}}async logPendingEvents(e){for(const t of this.pendingEventsQueue){const{usageType:n,state:r,id:i,fromId:s,headers:o,gcConfigs:a,...c}=t,l=this.getNodeStateTracker(t.id.value);if("Revived"===n===(void 0===l||l.state===ri)){const l=await this.getNodePackagePath(t.id.value),u=t.fromId?await this.getNodePackagePath(t.fromId.value):void 0,h={eventName:"".concat(r,"Object_").concat(n),id:i,fromId:s,headers:{...o},details:c,gcConfigs:a,...(0,Xt.Df)({pkg:null===l||void 0===l?void 0:l.join("/"),fromPkg:null===u||void 0===u?void 0:u.join("/")})};e.sendTelemetryEvent(h)}}this.pendingEventsQueue=[]}}function ci(e,t,n,r){var i;t.pkg=null===(i=(0,Xt.Df)({pkg:null===n||void 0===n?void 0:n.join("/")}))||void 0===i?void 0:i.pkg,t.tombstoneFlags=JSON.stringify({DisableTombstone:e.config.getBoolean(Vr),ThrowOnTombstoneUsage:e.config.getBoolean(Gr),ThrowOnTombstoneLoad:e.config.getBoolean(Kr)}),t.sweepFlags=JSON.stringify({EnableSweepFlag:e.config.getBoolean(Hr)}),e.logger.sendTelemetryEvent(t,r)}function li(e,t){return{pkg:JSON.stringify(e),summaryFormatVersion:2,isRootDataStore:t}}function ui(e,t){const n=li(e,t);return new Tt(qr,JSON.stringify(n))}class hi extends Zt{get packagePath(){return(0,i.v)(void 0!==this.pkg,313),this.pkg}get options(){return this._containerRuntime.options}get clientId(){return this._containerRuntime.clientId}get clientDetails(){return this._containerRuntime.clientDetails}get logger(){return this._containerRuntime.logger}get deltaManager(){return this._containerRuntime.deltaManager}get connected(){return this._containerRuntime.connected}get IFluidHandleContext(){return this._containerRuntime.IFluidHandleContext}get containerRuntime(){return this._containerRuntime}ensureNoDataModelChanges(e){return this._containerRuntime.ensureNoDataModelChanges(e)}get isLoaded(){return this.loaded}get baseSnapshot(){return this._baseSnapshot}get idCompressor(){return this._containerRuntime.idCompressor}get disposed(){return this._disposed}get tombstoned(){return this._tombstoned}get attachState(){return this._attachState}get IFluidDataStoreRegistry(){return this.registry}async isRoot(){return this.isInMemoryRoot()||(await this.getInitialSnapshotDetails()).isRootDataStore}isInMemoryRoot(){return this._isInMemoryRoot}constructor(e,t,n,r){var s;super(),this.existing=t,this.isLocalDataStore=n,this.makeLocallyVisibleFn=r,this._disposed=!1,this._tombstoned=!1,this.deleted=!1,this.detachedRuntimeCreation=!1,this.loaded=!1,this.pending=[],this._isInMemoryRoot=!1,this._containerRuntime=e.runtime,this.id=e.id,this.storage=e.storage,this.scope=e.scope,this.pkg=e.pkg,(0,i.v)(!this.id.includes("/"),314),this._attachState=this.containerRuntime.attachState!==Qt.Detached&&this.existing?this.containerRuntime.attachState:Qt.Detached;this.summarizerNode=e.createSummarizerNodeFn((async(e,t,n)=>this.summarizeInternal(e,t,n)),(async e=>this.getGCDataInternal(e))),this.mc=(0,Yt.CL)({logger:this.logger,namespace:"FluidDataStoreContext",properties:{all:(0,Xt.Df)({fluidDataStoreId:this.id,fullPackageName:()=>{var e;return null===(e=this.pkg)||void 0===e?void 0:e.join("/")}})}}),this.thresholdOpsCounter=new Fr(hi.pendingOpsCountThreshold,this.mc.logger),this.throwOnTombstoneUsage=this._containerRuntime.gcThrowOnTombstoneUsage,this.localChangesTelemetryCount=null!==(s=this.mc.config.getNumber("Fluid.Telemetry.LocalChangesTelemetryCount"))&&void 0!==s?s:10}dispose(){this._disposed||(this._disposed=!0,this.channelDeferred&&this.channelDeferred.promise.then((e=>{e.dispose()})).catch((e=>{})))}delete(){this.deleted=!0}setTombstone(e){this.tombstoned!==e&&(this._tombstoned=e)}rejectDeferredRealize(e,t,n){throw new o.iq(e,(0,Xt.Df)({failedPkgPath:t,packagePath:null===n||void 0===n?void 0:n.join("/")}))}async realize(){return(0,i.v)(!this.detachedRuntimeCreation,317),this.channelDeferred||(this.channelDeferred=new Ln,this.realizeCore(this.existing).catch((e=>{var t,n;const r=h.wrapIfUnrecognized(e,"realizeFluidDataStoreContext");r.addTelemetryProperties((0,Xt.Df)({fullPackageName:null===(t=this.pkg)||void 0===t?void 0:t.join("/"),fluidDataStoreId:this.id})),null===(n=this.channelDeferred)||void 0===n||n.reject(r),this.mc.logger.sendErrorEvent({eventName:"RealizeError"},r)}))),this.channelDeferred.promise}async factoryFromPackagePath(e){var t;let n;(0,i.v)(this.pkg===e,318),void 0===e&&this.rejectDeferredRealize("packages is undefined");let r,s=this._containerRuntime.IFluidDataStoreRegistry;for(const i of e)s||this.rejectDeferredRealize("No registry for package",r,e),r=i,n=await s.get(i),n||this.rejectDeferredRealize("Registry does not contain entry for the package",i,e),s=n.IFluidDataStoreRegistry;const o=null===(t=n)||void 0===t?void 0:t.IFluidDataStoreFactory;return void 0===o&&this.rejectDeferredRealize("Can't find factory for package",r,e),{factory:o,registry:s}}async realizeCore(e){const t=await this.getInitialSnapshotDetails();this._baseSnapshot=t.snapshot;const n=t.pkg,{factory:r,registry:s}=await this.factoryFromPackagePath(n);(0,i.v)(void 0===this.registry,319),this.registry=s;const o=await r.instantiateDataStore(this,e);(0,i.v)(void 0!==o,320),this.bindRuntime(o),this.disposed&&o.dispose()}setConnectionState(e,t){this.verifyNotClosed("setConnectionState",!1),this.loaded&&((0,i.v)(this.connected===e,321),this.channel.setConnectionState(e,t))}process(e,t,n){const r=d(e);if(this.verifyNotClosed("process",!1,r),this.tombstoned&&this.throwOnTombstoneUsage)throw new u("Context is tombstoned! Call site [process]",r);const s=e.contents,o={...e,type:s.type,contents:s.content};var a;if(this.summarizerNode.recordChange(o),this.loaded)return null===(a=this.channel)||void 0===a?void 0:a.process(o,t,n);(0,i.v)(!t,322),(0,i.v)(void 0!==this.pending,573),this.pending.push(o),this.thresholdOpsCounter.sendIfMultiple("StorePendingOps",this.pending.length)}processSignal(e,t){var n;this.verifyNotClosed("processSignal"),this.loaded&&(null===(n=this.channel)||void 0===n||n.processSignal(e,t))}getQuorum(){return this._containerRuntime.getQuorum()}getAudience(){return this._containerRuntime.getAudience()}async summarize(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0;return this.summarizerNode.summarize(e,t,n)}async summarizeInternal(e,t,n){await this.realize();const r=await this.channel.summarize(e,t,n);_r(r);const i=[nn._1],{pkg:s}=await this.getInitialSnapshotDetails(),o=li(s,await this.isRoot());return Ot(r,qr,JSON.stringify(o)),this.summarizerNode.isReferenced()||(r.summary.unreferenced=!0,r.stats.unreferencedBlobSize=r.stats.totalBlobSize),{...r,id:this.id,pathPartsForChildren:i}}async getGCData(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.summarizerNode.getGCData(e)}async getGCDataInternal(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return await this.realize(),(0,i.v)(void 0!==this.channel,323),this.channel.getGCData(e)}updateUsedRoutes(e){this.summarizerNode.updateUsedRoutes(e),this.lastUsedRoutes=e,this.loaded&&this.updateChannelUsedRoutes()}addedGCOutboundReference(e,t){!0===this.mc.config.getBoolean(Wr)&&this._containerRuntime.addedGCOutboundReference(e,t)}addedGCOutboundRoute(e,t){this._containerRuntime.addedGCOutboundReference({absolutePath:e},{absolutePath:t})}updateChannelUsedRoutes(){if((0,i.v)(this.loaded,324),(0,i.v)(void 0!==this.channel,325),void 0===this.lastUsedRoutes)return;const e=this.lastUsedRoutes.filter((e=>"/"!==e&&""!==e));this.channel.updateUsedRoutes(e)}async request(e){return(await this.realize()).request(e)}submitMessage(e,t,n){this.verifyNotClosed("submitMessage"),(0,i.v)(!!this.channel,326);const r={content:t,type:e};this.identifyLocalChangeInSummarizer("DataStoreMessageSubmittedInSummarizer",e),this._containerRuntime.submitDataStoreOp(this.id,r,n)}setChannelDirty(e){this.verifyNotClosed("setChannelDirty");const t=this.deltaManager.lastSequenceNumber;this.summarizerNode.invalidate(t);const n=this.summarizerNode.getChild(e);n&&n.invalidate(t)}submitSignal(e,t,n){return this.verifyNotClosed("submitSignal"),(0,i.v)(!!this.channel,327),this._containerRuntime.submitDataStoreSignal(this.id,e,t,n)}makeLocallyVisible(){(0,i.v)(void 0!==this.channel,719),(0,i.v)(this.channel.visibilityState===nn.cy.LocallyVisible,1424),this.makeLocallyVisibleFn()}bindRuntime(e){if(this.channel)throw new Error("Runtime already bound");try{(0,i.v)(!this.detachedRuntimeCreation,328),(0,i.v)(void 0!==this.channelDeferred,329),(0,i.v)(void 0!==this.pkg,330);const t=this.pending;for(const n of t)e.process(n,!1,void 0);this.thresholdOpsCounter.send("ProcessPendingOps",t.length),this.pending=void 0,this.loaded=!0,this.channel=e,Object.freeze(this.pkg),this.updateChannelUsedRoutes(),this.channelDeferred.resolve(this.channel)}catch(n){var t;null===(t=this.channelDeferred)||void 0===t||t.reject(n),this.mc.logger.sendErrorEvent({eventName:"BindRuntimeError"},n)}}async getAbsoluteUrl(e){if(this.attachState===Qt.Attached)return this._containerRuntime.getAbsoluteUrl(e)}setInMemoryRoot(){this._isInMemoryRoot=!0}async getBaseGCDetails(){return{}}reSubmit(e,t){(0,i.v)(!!this.channel,331);const n=e;this.channel.reSubmit(n.type,n.content,t)}rollback(e,t){if(!this.channel)throw new Error("Channel must exist when rolling back ops");if(!this.channel.rollback)throw new Error("Channel doesn't support rollback");const n=e;this.channel.rollback(n.type,n.content,t)}async applyStashedOp(e){return this.channel||await this.realize(),(0,i.v)(!!this.channel,332),this.channel.applyStashedOp(e)}verifyNotClosed(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(this.deleted){const t="Context is deleted! Call site [".concat(e,"]"),r=new u(t,n);throw this.mc.logger.sendErrorEvent({eventName:"GC_Deleted_DataStore_Changed",callSite:e},r),r}if(this._disposed)throw new Error("Context is closed! Call site [".concat(e,"]"));if(t&&this.tombstoned){const t="Context is tombstoned! Call site [".concat(e,"]"),r=new u(t,n);if(ci(this.mc,{eventName:"GC_Tombstone_DataStore_Changed",category:this.throwOnTombstoneUsage?"error":"generic",gcTombstoneEnforcementAllowed:this._containerRuntime.gcTombstoneEnforcementAllowed,callSite:e},this.pkg,r),this.throwOnTombstoneUsage)throw r}}identifyLocalChangeInSummarizer(e,t){var n,r;this.clientDetails.type!==jr||this.localChangesTelemetryCount<=0||(this.mc.logger.sendTelemetryEvent({eventName:e,type:t,isSummaryInProgress:null===(n=(r=this.summarizerNode).isSummaryInProgress)||void 0===n?void 0:n.call(r),stack:(0,o.aX)()}),this.localChangesTelemetryCount--)}getCreateChildSummarizerNodeFn(e,t){return(n,r)=>this.summarizerNode.createChild(n,e,t,{throwOnFailure:!0},r)}async uploadBlob(e,t){return this.containerRuntime.uploadBlob(e,t)}}hi.pendingOpsCountThreshold=1e3;class di extends hi{constructor(e){super(e,!0,!1,(()=>{throw new Error("Already attached")})),this.initialSnapshotDetailsP=new an.I((async()=>{let e=this.initSnapshotValue,t=!0;if(e&&void 0!==e.blobs[qr]){var n;const r=await vn(this.storage,e.blobs[qr]);let s;s=Ir(r)<1?r.pkg.startsWith('["')&&r.pkg.endsWith('"]')?JSON.parse(r.pkg):[r.pkg]:JSON.parse(r.pkg),this.pkg=s,t=null===(n=r.isRootDataStore)||void 0===n||n,Ar(r)&&(e=e.trees[nn._1],(0,i.v)(void 0!==e,510))}return{pkg:this.pkg,isRootDataStore:t,snapshot:e}})),this.initSnapshotValue=e.snapshotTree,void 0!==e.snapshotTree&&this.summarizerNode.updateBaseSummaryState(e.snapshotTree)}async getInitialSnapshotDetails(){return this.initialSnapshotDetailsP}getAttachData(e){throw new Error("Cannot attach remote store")}}class fi extends hi{constructor(e){super(e,void 0!==e.snapshotTree,!0,e.makeLocallyVisibleFn),this.initialSnapshotDetailsP=new an.I((async()=>{let e,t=this.snapshotTree,n=!1;var r;void 0!==t&&(e=await async function(e,t){const n=await vn(e,t.blobs[qr]),r=Ir(n);return(0,i.v)(r>0,469),n}(this.storage,t),Ar(e)&&(t=t.trees[nn._1],(0,i.v)(void 0!==t,511)),void 0===this.pkg&&(this.pkg=JSON.parse(e.pkg),(null===(r=e.isRootDataStore)||void 0===r||r)&&(n=!0,this.setInMemoryRoot())));return(0,i.v)(void 0!==this.pkg,338),{pkg:this.pkg,isRootDataStore:n,snapshot:t}})),this.identifyLocalChangeInSummarizer("DataStoreCreatedInSummarizer"),this.snapshotTree=e.snapshotTree,!0===e.isRootDataStore&&this.setInMemoryRoot(),this.createProps=e.createProps,this.attachListeners()}attachListeners(){this.once("attaching",(()=>{(0,i.v)(this.attachState===Qt.Detached,333),this._attachState=Qt.Attaching})),this.once("attached",(()=>{(0,i.v)(this.attachState===Qt.Attaching,334),this._attachState=Qt.Attached}))}getAttachData(e,t){var n,r;(0,i.v)(void 0!==this.channel,335),(0,i.v)(void 0!==this.pkg,336);const s=this.channel.getAttachSummary(t);_r(s);const o=li(this.pkg,this.isInMemoryRoot());return Ot(s,qr,JSON.stringify(o)),{attachSummary:s,type:this.pkg[this.pkg.length-1],gcData:e?null===(n=(r=this.channel).getAttachGCData)||void 0===n?void 0:n.call(r,t):void 0}}async getInitialSnapshotDetails(){return this.initialSnapshotDetailsP}delete(){ci(this.mc,{eventName:"GC_Deleted_DataStore_Unexpected_Delete",message:"Unexpected deletion of a local data store context",category:"error",gcTombstoneEnforcementAllowed:void 0},this.pkg),super.delete()}}class pi extends fi{constructor(e){super(e)}}class mi extends fi{constructor(e){super(e),this.detachedRuntimeCreation=!0}async attachRuntime(e,t){(0,i.v)(this.detachedRuntimeCreation,340),this.detachedRuntimeCreation=!1,(0,i.v)(void 0===this.channelDeferred,341),this.channelDeferred=new Ln;const n=e.IFluidDataStoreFactory,r=await this.factoryFromPackagePath(this.pkg);(0,i.v)(r.factory===n,342),(0,i.v)(void 0===this.registry,343),this.registry=r.registry,super.bindRuntime(t),await t.entryPoint.get(),await this.isRoot()&&t.makeVisibleAndAttachGraph()}async getInitialSnapshotDetails(){if(this.detachedRuntimeCreation)throw new Error("Detached Fluid Data Store context can't be realized! Please attach runtime first!");return super.getInitialSnapshotDetails()}}class gi{set policies(e){this._policies=e}get policies(){var e;return null!==(e=this._policies)&&void 0!==e?e:this.internalStorageService.policies}get repositoryUrl(){return this.internalStorageService.repositoryUrl}constructor(e){this.internalStorageService=e}async getSnapshotTree(e,t){return this.internalStorageService.getSnapshotTree(e,t)}async getVersions(e,t,n,r){return this.internalStorageService.getVersions(e,t,n,r)}async uploadSummaryWithContext(e,t){return this.internalStorageService.uploadSummaryWithContext(e,t)}async downloadSummary(e){return this.internalStorageService.downloadSummary(e)}async createBlob(e){return this.internalStorageService.createBlob(e)}async readBlob(e){return this.internalStorageService.readBlob(e)}}class vi extends gi{constructor(e,t){super(e),this.attachBlobs=t}get policies(){return this.internalStorageService.policies}async readBlob(e){const t=this.attachBlobs.get(e);return void 0!==t?t:this.internalStorageService.readBlob(e)}}const yi=e=>"string"===typeof(null===e||void 0===e?void 0:e.internalId)&&"string"===typeof(null===e||void 0===e?void 0:e.alias),bi=(e,t,n,r,i)=>new wi(e,t,n,r,i);var Si;!function(e){e.Aliased="Aliased",e.Aliasing="Aliasing",e.None="None"}(Si||(Si={}));class wi{async trySetAlias(e){if(e.includes("/"))throw new l("The alias cannot contain slashes: '".concat(e,"'"));switch(this.aliasState){case Si.Aliasing:return(0,i.v)(void 0!==this.aliasResult,790),await this.aliasResult,this.alias===e?"Success":"AlreadyAliased";case Si.Aliased:return this.alias===e?"Success":"AlreadyAliased";case Si.None:if(void 0!==this.pendingAliases.get(e))return"Conflict";break;default:wt(this.aliasState)}return this.aliasState=Si.Aliasing,this.aliasResult=this.trySetAliasInternal(e),this.pendingAliases.set(e,this.aliasResult),this.aliasResult}async trySetAliasInternal(e){const t={internalId:this.internalId,alias:e};if(this.fluidDataStoreChannel.makeVisibleAndAttachGraph(),this.runtime.attachState===Qt.Detached){const e=this.datastores.processAliasMessageCore(t);return this.aliasState=Si.Aliased,e?"Success":"Conflict"}return await this.ackBasedPromise((e=>{this.runtime.submitDataStoreAliasOp(t,e)})).catch((t=>(this.logger.sendErrorEvent({eventName:"AliasingException",alias:{value:e,tag:Xt.mc.UserData},internalId:{value:this.internalId,tag:Xt.mc.CodeArtifact}},t),!1))).finally((()=>{this.pendingAliases.delete(e)}))?(this.alias=e,this.aliasState=Si.Aliased,"Success"):(this.aliasState=Si.None,this.aliasResult=void 0,"Conflict")}get entryPoint(){return this.fluidDataStoreChannel.entryPoint}constructor(e,t,n,r,i){this.fluidDataStoreChannel=e,this.internalId=t,this.runtime=n,this.datastores=r,this.logger=i,this.aliasState=Si.None,this.pendingAliases=r.pendingAliases}async ackBasedPromise(e){let t;return new Promise(((n,r)=>{t=()=>r(new Error("ContainerRuntime disposed while this ack-based Promise was pending")),this.runtime.disposed?t():(this.runtime.on("dispose",t),e(n,r))})).finally((()=>{this.runtime.off("dispose",t)}))}}class Ci{constructor(e,t,n,r,i,s,a,c,l){let u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:new Nr(s);this.baseSnapshot=e,this.runtime=t,this.submitAttachFn=n,this.getCreateChildSummarizerNodeFn=r,this.deleteChildSummarizerNodeFn=i,this.gcNodeUpdated=a,this.isDataStoreDeleted=c,this.aliasMap=l,this.contexts=u,this.pendingAttach=new Map,this.attachOpFiredForDataStore=new Set,this.disposeOnce=new an.d((()=>this.contexts.dispose())),this.dataStoresSinceLastGC=[],this.pendingAliasMap=new Map,this.shouldSendAttachLog=!0,this.dispose=()=>this.disposeOnce.value,this.mc=(0,Yt.CL)({logger:s}),this.containerRuntimeHandle=new hr(this.runtime,"/",this.runtime.IFluidHandleContext);const h=new Map;if(e)for(const[o,f]of Object.entries(e.trees))h.set(o,f);let d=0;for(const[f,p]of h){let e;if(p.unreferenced&&d++,this.runtime.attachState!==Qt.Detached)e=new di({id:f,snapshotTree:p,runtime:this.runtime,storage:this.runtime.storage,scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(f,{type:nn.nL.FromSummary})});else{if("object"!==typeof p)throw new o.iq("Snapshot should be there to load from!!");const t=p;e=new pi({id:f,pkg:void 0,runtime:this.runtime,storage:this.runtime.storage,scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(f,{type:nn.nL.FromSummary}),makeLocallyVisibleFn:()=>this.makeDataStoreLocallyVisible(f),snapshotTree:t,isRootDataStore:void 0})}this.contexts.addBoundOrRemoted(e)}this.containerLoadStats={containerLoadDataStoreCount:h.size,referencedDataStoreCount:h.size-d}}get aliases(){return this.aliasMap}get pendingAliases(){return this.pendingAliasMap}async waitIfPendingAlias(e){const t=this.pendingAliases.get(e);return null!==t&&void 0!==t?t:"Success"}processAttachMessage(e,t){var n;const r=e.contents;this.dataStoresSinceLastGC.push(r.id);const s=Lt(r.snapshot,((e,t)=>{const n="/".concat(r.id).concat("/"===e?"":e);this.runtime.addedGCOutboundReference({absolutePath:n},{absolutePath:t})}));var o;if(this.shouldSendAttachLog&&(this.shouldSendAttachLog=!1,this.mc.logger.sendTelemetryEvent({eventName:"dataStoreAttachMessage_sampled",...(0,Xt.Df)({id:r.id,pkg:r.type}),details:{local:t,snapshot:!!r.snapshot,foundGCData:s},...d(e)})),t)return(0,i.v)(this.pendingAttach.has(r.id),350),null===(o=this.contexts.get(r.id))||void 0===o||o.emit("attached"),void this.pendingAttach.delete(r.id);if(this.alreadyProcessed(r.id)){throw new u("Duplicate DataStore created with existing id",{...d(e),...(0,Xt.Df)({dataStoreId:r.id})})}const a=new Map;let c;r.snapshot&&(c=kr(r.snapshot.entries,a));const l=[r.type],h=new di({id:r.id,snapshotTree:c,runtime:this.runtime,storage:new vi(this.runtime.storage,a),scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(r.id,{type:nn.nL.FromAttach,sequenceNumber:e.sequenceNumber,snapshot:null!==(n=r.snapshot)&&void 0!==n?n:{entries:[ui(l,!0)]}}),pkg:l});this.contexts.addBoundOrRemoted(h)}processAliasMessage(e,t,n){const r=e.contents;if(!yi(r))throw new u("malformedDataStoreAliasMessage",{...d(e)});const i=t,s=this.processAliasMessageCore(r);n&&i(s)}processAliasMessageCore(e){if(this.alreadyProcessed(e.alias))return!1;const t=this.contexts.get(e.internalId);if(this.checkAndLogIfDeleted(e.internalId,t,"Changed","processAliasMessageCore"))return!1;if(void 0===t)return this.mc.logger.sendErrorEvent({eventName:"AliasFluidDataStoreNotFound",fluidDataStoreId:e.internalId}),!1;const n=new hr(t,e.internalId,this.runtime.IFluidHandleContext);return this.runtime.addedGCOutboundReference(this.containerRuntimeHandle,n),this.aliasMap.set(e.alias,t.id),t.setInMemoryRoot(),!0}alreadyProcessed(e){return void 0!==this.aliasMap.get(e)||void 0!==this.contexts.get(e)}generateAttachMessage(e){const{attachSummary:t,type:n,gcData:r}=e.getAttachData(!0);void 0!==r&&Ot(t,nn.xX,JSON.stringify(r));const i=Bt(t.summary);return{id:e.id,snapshot:i,type:n}}makeDataStoreLocallyVisible(e){const t=this.contexts.getUnbound(e);if((0,i.v)(!!t,351),this.runtime.attachState!==Qt.Detached){t.emit("attaching");const n=this.generateAttachMessage(t);this.pendingAttach.set(e,n),this.submitAttachFn(n),this.attachOpFiredForDataStore.add(e)}this.contexts.bind(e)}createDetachedDataStoreCore(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:In();(0,i.v)(!n.includes("/"),780);const r=new mi({id:n,pkg:e,runtime:this.runtime,storage:this.runtime.storage,scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(n,{type:nn.nL.Local}),makeLocallyVisibleFn:()=>this.makeDataStoreLocallyVisible(n),snapshotTree:void 0,isRootDataStore:t});return this.contexts.addUnbound(r),r}_createFluidDataStoreContext(e,t,n){(0,i.v)(!t.includes("/"),781);const r=new pi({id:t,pkg:e,runtime:this.runtime,storage:this.runtime.storage,scope:this.runtime.scope,createSummarizerNodeFn:this.getCreateChildSummarizerNodeFn(t,{type:nn.nL.Local}),makeLocallyVisibleFn:()=>this.makeDataStoreLocallyVisible(t),snapshotTree:void 0,isRootDataStore:!1,createProps:n});return this.contexts.addUnbound(r),r}get disposed(){return this.disposeOnce.evaluated}resubmitDataStoreOp(e,t){const n=this.contexts.get(e.address);if(this.checkAndLogIfDeleted(e.address,n,"Changed","resubmitDataStoreOp"))throw new u("Context is deleted!",{callSite:"resubmitDataStoreOp",...(0,Xt.Df)({id:e.address})});(0,i.v)(!!n,352),n.reSubmit(e.contents,t)}rollbackDataStoreOp(e,t){const n=this.contexts.get(e.address);if(this.checkAndLogIfDeleted(e.address,n,"Changed","rollbackDataStoreOp"))throw new u("Context is deleted!",{callSite:"rollbackDataStoreOp",...(0,Xt.Df)({id:e.address})});(0,i.v)(!!n,744),n.rollback(e.contents,t)}async applyStashedOp(e){const t=this.contexts.get(e.address);if(!this.checkAndLogIfDeleted(e.address,t,"Changed","applyStashedOp"))return(0,i.v)(!!t,353),t.applyStashedOp(e.contents)}async applyStashedAttachOp(e){this.pendingAttach.set(e.id,e),this.processAttachMessage({contents:e},!1)}processFluidDataStoreOp(e,t,n,r){const i=e.contents,s={...e,contents:i.contents},o=this.contexts.get(i.address);if(!this.checkAndLogIfDeleted(i.address,o,"Changed","processFluidDataStoreOp")){if(void 0===o)throw h.create("No context for op","processFluidDataStoreOp",e,{local:t,messageDetails:JSON.stringify({type:e.type,contentType:typeof e.contents}),...(0,Xt.Df)({address:i.address})});o.process(s,t,n),!0!==this.mc.config.getBoolean(Wr)&&function(e,t){const n=[];let r;function i(e){if("object"===typeof e&&null!==e)for(const[t,s]of Object.entries(e))rn(s)&&n.push(s.url),"address"===t&&void 0===r&&(r=s),i(s)}i(e.contents);const s=["",e.address,r].join("/");n.forEach((e=>t(s,e)))}(i,r),this.gcNodeUpdated("/".concat(i.address),e.timestamp,o.isLoaded?o.packagePath:void 0)}}async getDataStore(e,t){const n={...Ys,...t};if(this.checkAndLogIfDeleted(e,this.contexts.get(e),"Requested","getDataStore",t)){const t={url:e};throw bn(wn(404,"DataStore was deleted",t))}const r=await this.contexts.getBoundOrRemoted(e,n.wait);if(void 0===r){const t={url:e};throw bn(Sn(t))}return r}async getDataStoreIfAvailable(e,t){if(this.checkAndLogIfDeleted(e,this.contexts.get(e),"Requested","getDataStoreIfAvailable",t))return;const n={...Ys,...t},r=await this.contexts.getBoundOrRemoted(e,n.wait);return void 0!==r?r:void 0}checkAndLogIfDeleted(e,t,n,r,i){const s="/".concat(e);return!!this.isDataStoreDeleted(s)&&(this.mc.logger.sendErrorEvent({eventName:"GC_Deleted_DataStore_".concat(n),...(0,Xt.Df)({id:e}),callSite:r,headers:JSON.stringify(i),exists:void 0!==t}),!0)}processSignal(e,t,n){const r=this.contexts.get(e);if(!this.checkAndLogIfDeleted(e,r,"Changed","processSignal"))return r?void r.processSignal(t,n):((0,i.v)(!n,355),void this.mc.logger.sendTelemetryEvent({eventName:"SignalFluidDataStoreNotFound",...(0,Xt.Df)({fluidDataStoreId:e})}))}setConnectionState(e,t){for(const[r,i]of this.contexts)try{i.setConnectionState(e,t)}catch(n){this.mc.logger.sendErrorEvent({eventName:"SetConnectionStateError",clientId:t,...(0,Xt.Df)({fluidDataStoreId:r}),details:JSON.stringify({runtimeConnected:this.runtime.connected,connected:e})},n)}}setAttachState(e){const t=e===Qt.Attaching?"attaching":"attached";for(const[,n]of this.contexts)this.contexts.isNotBound(n.id)||n.emit(t)}get size(){return this.contexts.size}async summarize(e,t,n){const r=new Pt;return await Promise.all(Array.from(this.contexts).filter((e=>{let[t,n]=e;if(n.attachState===Qt.Attaching){throw h.create("Local data store detected in attaching state during summarize","summarize")}return n.attachState===Qt.Attached})).map((async i=>{let[s,o]=i;const a=await o.summarize(e,t,n);r.addWithStats(s,a)}))),r.getSummaryTree()}createSummary(e){const t=new Pt;let n;do{const r=t.summary.tree;n=this.contexts.notBoundLength(),Array.from(this.contexts).filter((e=>{let[t,n]=e;return!(this.contexts.isNotBound(t)||r[t]||this.attachOpFiredForDataStore.has(t))})).map((n=>{let r,[s,o]=n;o.isLoaded?r=o.getAttachData(!1,e).attachSummary:((0,i.v)(!!this.baseSnapshot,358),r=Mt(this.baseSnapshot.trees[s])),t.addWithStats(s,r)}))}while(n!==this.contexts.notBoundLength());return t.getSummaryTree()}async updateStateBeforeGC(){for(const e of this.dataStoresSinceLastGC){const t=this.contexts.get(e);if((0,i.v)(void 0!==t,694),await t.isRoot()){const n=new hr(t,e,this.runtime.IFluidHandleContext);this.runtime.addedGCOutboundReference(this.containerRuntimeHandle,n)}}this.dataStoresSinceLastGC=[]}async getGCData(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=new jt;return await Promise.all(Array.from(this.contexts).filter((e=>{let[t,n]=e;if(n.attachState===Qt.Attaching){throw h.create("Local data store detected in attaching state while running GC","getGCData")}return n.attachState===Qt.Attached})).map((async n=>{let[r,i]=n;const s=await i.getGCData(e);t.prefixAndAddNodes(r,s.gcNodes)}))),t.addNode("/",await this.getOutboundRoutes()),t.getGCData()}updateUsedRoutes(e){const t=dr(e);for(const[r]of t)(0,i.v)(this.contexts.has(r),359);for(const[r,i]of this.contexts){var n;i.updateUsedRoutes(null!==(n=t.get(r))&&void 0!==n?n:[])}}updateUnusedRoutes(e){for(const t of e){const e=t.split("/");if(e.length>2)continue;const n=e[1];(0,i.v)(this.contexts.has(n),727),this.contexts.delete(n),this.deleteChildSummarizerNodeFn(n)}}deleteSweepReadyNodes(e){for(const t of e){const e=t.split("/"),n=e[1];if(e.length>2)continue;const r=this.contexts.get(n);if(void 0!==r)r.delete(),this.contexts.delete(n),this.deleteChildSummarizerNodeFn(n);else{const e=this.isDataStoreDeleted("/".concat(n));this.mc.logger.sendTelemetryEvent({eventName:"DeletedDataStoreNotFound",category:e?"generic":"error",...(0,Xt.Df)({id:n}),details:{alreadyDeleted:e}})}}return Array.from(e)}updateTombstonedRoutes(e){const t=new Set;for(const n of e){const e=n.split("/");if(e.length>2)continue;const r=e[1];(0,i.v)(this.contexts.has(r),1296),t.add(r)}for(const[n,r]of this.contexts)r.setTombstone(t.has(n))}async getOutboundRoutes(){const e=[];for(const[t,n]of this.contexts){await n.isRoot()&&e.push("/".concat(t))}return e}async getDataStorePackagePath(e){var t;const n=this.contexts.get(e.split("/")[1]);return null===(t=await(null===n||void 0===n?void 0:n.getInitialSnapshotDetails()))||void 0===t?void 0:t.pkg}getGCNodeType(e){const t=e.split("/");if(this.contexts.has(t[1]))return 2===t.length?ei.DataStore:ei.SubDataStore}}function xi(e){const t=Object.entries(e.gcNodes);t.sort(((e,t)=>{let[n]=e,[r]=t;return n.localeCompare(r)}));const n={gcNodes:{}};for(const[r,i]of t)i.outboundRoutes.sort(),n.gcNodes[r]=i;return n}function Ei(e,t){const n={};for(const[i,s]of Object.entries(e.gcNodes))n[i]={outboundRoutes:Array.from(s.outboundRoutes),unreferencedTimestampMs:s.unreferencedTimestampMs};for(const[s,o]of Object.entries(t.gcNodes)){let e=n[s];var r;if(void 0===e)e={outboundRoutes:Array.from(o.outboundRoutes),unreferencedTimestampMs:o.unreferencedTimestampMs};else void 0!==o.unreferencedTimestampMs&&void 0!==e.unreferencedTimestampMs&&(0,i.v)(o.unreferencedTimestampMs===e.unreferencedTimestampMs,1495),e={outboundRoutes:[...new Set([...o.outboundRoutes,...e.outboundRoutes])],unreferencedTimestampMs:null!==(r=o.unreferencedTimestampMs)&&void 0!==r?r:e.unreferencedTimestampMs};n[s]=e}return{gcNodes:n}}function Ti(e){const t={};for(const[n,r]of Object.entries(e.gcNodes))t[n]=Array.from(r);return{gcNodes:t}}class ki{constructor(e){this.path=e}static create(e){return new ki(encodeURIComponent(e))}static createAndConcat(e){var t;let n=ki.create(null!==(t=e[0])&&void 0!==t?t:"");for(let r=1;r<e.length;r++)n=n.concat(ki.create(e[r]));return n}toString(){return this.path}concat(e){return new ki("".concat(this.path,"/").concat(e.path))}}class Ni{static createForRoot(e){return new Ni({referenceSequenceNumber:e,basePath:void 0,localPath:ki.create("")})}get referenceSequenceNumber(){return this.summary.referenceSequenceNumber}get basePath(){return this.summary.basePath}get localPath(){return this.summary.localPath}get additionalPath(){return this.summary.additionalPath}set additionalPath(e){this.summary.additionalPath=e}constructor(e){this.summary=e}get fullPath(){var e,t;return null!==(e=null===(t=this.basePath)||void 0===t?void 0:t.concat(this.localPath))&&void 0!==e?e:this.localPath}get fullPathForChildren(){return void 0!==this.additionalPath?this.fullPath.concat(this.additionalPath):this.fullPath}createForChild(e){return new Ni({referenceSequenceNumber:this.referenceSequenceNumber,basePath:this.fullPathForChildren,localPath:ki.create(e)})}}class Fi{get referenceSequenceNumber(){var e,t;return null!==(e=null===(t=this._latestSummary)||void 0===t?void 0:t.referenceSequenceNumber)&&void 0!==e?e:0}constructor(e,t,n,r,i,s,o,a){var c;this.summarizeInternalFn=t,this._changeSequenceNumber=r,this._latestSummary=i,this.initialSummary=s,this.wipSummaryLogger=o,this.telemetryNodeId=a,this.children=new Map,this.pendingSummaries=new Map,this.wipSkipRecursion=!1,this.canReuseHandle=null===(c=n.canReuseHandle)||void 0===c||c,this.logger=(0,Xt.pW)({logger:e,properties:{all:(0,Xt.Df)({id:this.telemetryNodeId})}})}startSummary(e,t){(0,i.v)(void 0===this.wipSummaryLogger,415),(0,i.v)(void 0===this.wipReferenceSequenceNumber,416),this.wipSummaryLogger=t;for(const n of this.children.values())n.startSummary(e,this.wipSummaryLogger);this.wipReferenceSequenceNumber=e}async summarize(e){let t=arguments.length>2?arguments[2]:void 0;if((0,i.v)(this.isSummaryInProgress(),417),(0,i.v)(void 0!==this.wipSummaryLogger,418),this.canReuseHandle&&!e&&!this.hasChanged()){const e=this._latestSummary;if(void 0!==e){this.wipLocalPaths={localPath:e.localPath,additionalPath:e.additionalPath},this.wipSkipRecursion=!0;const t=Ft();return t.handleNodeCount++,{summary:{type:Et.Handle,handle:e.fullPath.path,handleType:Et.Tree},stats:t}}}(0,i.v)(void 0!==this.wipReferenceSequenceNumber,1503);const n=void 0!==this._latestSummary?{summarySequenceNumber:this.wipReferenceSequenceNumber,latestSummarySequenceNumber:this._latestSummary.referenceSequenceNumber,summaryPath:this._latestSummary.fullPath.path}:void 0,r=await this.summarizeInternalFn(e,!0,t,n);return this.wipLocalPaths={localPath:ki.create(r.id)},void 0!==r.pathPartsForChildren&&(this.wipLocalPaths.additionalPath=ki.createAndConcat(r.pathPartsForChildren)),{summary:r.summary,stats:r.stats}}validateSummary(){return this.validateSummaryCore(!1)}validateSummaryCore(e){if(this.wasSummarizeMissed(e))return{success:!1,reason:"NodeDidNotSummarize",id:{tag:Xt.mc.CodeArtifact,value:this.telemetryNodeId},retryAfterSeconds:1};if(e)return{success:!0};for(const t of this.children.values()){const n=t.validateSummaryCore(this.wipSkipRecursion||e);if(!n.success)return n}return{success:!0}}wasSummarizeMissed(e){return(0,i.v)(void 0!==this.wipSummaryLogger,1788),(0,i.v)(void 0!==this.wipReferenceSequenceNumber,1789),!e&&void 0===this.wipLocalPaths}completeSummary(e,t){this.completeSummaryCore(e,void 0,!1,t)}completeSummaryCore(e,t,n,r){r&&this.wasSummarizeMissed(n)&&this.throwUnexpectedError({eventName:"NodeDidNotSummarize",proposalHandle:e}),(0,i.v)(void 0!==this.wipReferenceSequenceNumber,420);let s=this.wipLocalPaths;if(n){const e=this._latestSummary;if(void 0===e)return void this.clearSummary();s={localPath:e.localPath,additionalPath:e.additionalPath}}(0,i.v)(void 0!==s,1790);const o=new Ni({...s,referenceSequenceNumber:this.wipReferenceSequenceNumber,basePath:t}),a=o.fullPathForChildren;for(const i of this.children.values())i.completeSummaryCore(e,a,this.wipSkipRecursion||n,r);this.pendingSummaries.set(e,o),this.clearSummary()}clearSummary(){this.wipReferenceSequenceNumber=void 0,this.wipLocalPaths=void 0,this.wipSkipRecursion=!1,this.wipSummaryLogger=void 0;for(const e of this.children.values())e.clearSummary()}async refreshLatestSummary(e,t){const n={proposalHandle:e,summaryRefSeq:t,referenceSequenceNumber:this.referenceSequenceNumber};return Xt.Bt.timedExecAsync(this.logger,{eventName:"refreshLatestSummary",...n},(async r=>{if(this.isSummaryInProgress())throw new o.iq("UnexpectedRefreshDuringSummarize",{inProgressSummaryRefSeq:this.wipReferenceSequenceNumber});let i=!1,s=!1;t>this.referenceSequenceNumber&&(s=!0);const a=this.pendingSummaries.get(e);return void 0!==a&&(this.refreshLatestSummaryFromPending(e,a.referenceSequenceNumber),i=!0),r.end({...n,isSummaryNewer:s,pendingSummaryFound:i}),{isSummaryTracked:i,isSummaryNewer:s}}),{start:!0,end:!0,cancel:"error"})}refreshLatestSummaryFromPending(e,t){const n=this.pendingSummaries.get(e);if(void 0!==n){(0,i.v)(t===n.referenceSequenceNumber,423),this.pendingSummaries.delete(e),this.refreshLatestSummaryCore(t),this._latestSummary=n;for(const n of this.children.values())n.refreshLatestSummaryFromPending(e,t)}else(0,i.v)(void 0===this._latestSummary,422)}refreshLatestSummaryCore(e){for(const[t,n]of this.pendingSummaries)n.referenceSequenceNumber<e&&this.pendingSummaries.delete(t)}updateBaseSummaryState(e){const{childrenPathPart:t}=function(e){const t=e.trees[nn._1];return void 0!==t?{childrenTree:t,childrenPathPart:nn._1}:{childrenTree:e,childrenPathPart:void 0}}(e);void 0!==t&&void 0!==this._latestSummary&&(this._latestSummary.additionalPath=ki.create(t))}recordChange(e){this.invalidate(e.sequenceNumber)}invalidate(e){e>this._changeSequenceNumber&&(this._changeSequenceNumber=e)}hasChanged(){return this._changeSequenceNumber>this.referenceSequenceNumber}get latestSummary(){return this._latestSummary}createChild(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};(0,i.v)(!this.children.has(t),427);const s=this.getCreateDetailsForChild(t,n),o=new Fi(this.logger,e,r,s.changeSequenceNumber,s.latestSummary,s.initialSummary,this.wipSummaryLogger,s.telemetryNodeId);return this.maybeUpdateChildState(o,t),this.children.set(t,o),o}getChild(e){return this.children.get(e)}getCreateDetailsForChild(e,t){var n;let r,s,o;const a=this._latestSummary;switch(t.type){case nn.nL.FromAttach:if(void 0!==a&&t.sequenceNumber<=a.referenceSequenceNumber)s=a.createForChild(e);else{const n=Rt(t.snapshot);r={sequenceNumber:t.sequenceNumber,id:e,summary:n}}o=t.sequenceNumber;break;case nn.nL.FromSummary:void 0===this.initialSummary&&(0,i.v)(!!a,428);case nn.nL.Local:{var c;const n=this.initialSummary;if(void 0!==n){let s,o;if(void 0!==n.summary){const{childrenTree:t}=function(e){const t=e.tree[nn._1];return void 0!==t?{childrenTree:t,childrenPathPart:nn._1}:{childrenTree:e,childrenPathPart:void 0}}(n.summary.summary);(0,i.v)(t.type===Et.Tree,470),s=t.tree[e]}t.type===nn.nL.FromSummary&&(0,i.v)(!!s,429),void 0!==s&&((0,i.v)(s.type===Et.Tree,430),o={summary:s,stats:Dt(s)}),r={sequenceNumber:n.sequenceNumber,id:e,summary:o}}s=null===a||void 0===a?void 0:a.createForChild(e),o=null!==(c=null===a||void 0===a?void 0:a.referenceSequenceNumber)&&void 0!==c?c:-1;break}default:{const e=t.type;wt(t,"Unexpected CreateSummarizerNodeSource: ".concat(e))}}return{initialSummary:r,latestSummary:s,changeSequenceNumber:o,telemetryNodeId:"".concat(null!==(n=this.telemetryNodeId)&&void 0!==n?n:"","/").concat(e)}}maybeUpdateChildState(e,t){if(this.isSummaryInProgress()&&(e.wipReferenceSequenceNumber=this.wipReferenceSequenceNumber),void 0!==e._latestSummary)for(const[n,r]of this.pendingSummaries.entries()){const t=new Ni({referenceSequenceNumber:r.referenceSequenceNumber,basePath:e._latestSummary.basePath,localPath:e._latestSummary.localPath});e.addPendingSummary(n,t)}}addPendingSummary(e,t){this.pendingSummaries.set(e,t)}isSummaryInProgress(){return void 0!==this.wipReferenceSequenceNumber}throwUnexpectedError(e){const t=new o.iq(e.eventName,{...e,referenceSequenceNumber:this.wipReferenceSequenceNumber,...(0,Xt.Df)({id:this.telemetryNodeId})});throw this.logger.sendErrorEvent(e,t),t}}class Ii extends Ni{constructor(e,t){super(t),this.serializedUsedRoutes=e}}class Ai extends Fi{constructor(e,t,n,r,s,o,a,c,l,u){super(e,(async(e,n,r,i)=>t(e,!0,r,i)),n,r,s,o,a,u),this.summarizeFn=t,this.getGCDataFn=c,this.baseGCDetailsLoaded=!1,this.usedRoutes=[""],this.gcDisabled=!0===n.gcDisabled,this.baseGCDetailsP=new an.I((async()=>{var e;return null!==(e=await(null===l||void 0===l?void 0:l()))&&void 0!==e?e:{usedRoutes:[]}})),this.childNodesBaseGCDetailsP=new an.I((async()=>(await this.loadBaseGCDetails(),function(e){const t=new Map;if(void 0===e.gcData)return t;const n=e.gcData.gcNodes;for(const[s,o]of Object.entries(n)){if("/"===s)continue;(0,i.v)(s.startsWith("/"),1497);const e=s.split("/")[1];let n=s.slice(e.length+1);""===n&&(n="/");let r=t.get(e);void 0===r&&(r={gcData:{gcNodes:{}},usedRoutes:[]}),(0,i.v)(void 0!==r.gcData,1498),r.gcData.gcNodes[n]=[...new Set(o)],t.set(e,r)}if(void 0===e.usedRoutes)return t;const r=e.usedRoutes.filter((e=>""!==e&&"/"!==e));for(const s of r){(0,i.v)(s.startsWith("/"),1499);const e=s.split("/")[1],n=s.slice(e.length+1),r=t.get(e);(0,i.v)(void 0!==(null===r||void 0===r?void 0:r.usedRoutes),1500),r.usedRoutes.push(n),t.set(e,r)}return t}({gcData:this.gcData,usedRoutes:this.usedRoutes}))))}async loadBaseGCDetails(){if(this.baseGCDetailsLoaded)return;const e=await this.baseGCDetailsP;this.baseGCDetailsLoaded||(this.baseGCDetailsLoaded=!0,void 0!==e.gcData&&(this.gcData=Ti(e.gcData)),void 0!==e.usedRoutes&&(this.usedRoutes=Array.from(e.usedRoutes).sort(),this.referenceUsedRoutes=Array.from(e.usedRoutes).sort()))}async summarize(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0;return!this.gcDisabled&&this.isSummaryInProgress()&&(0,i.v)(void 0!==this.wipSerializedUsedRoutes,433),t?super.summarize(e,!0,n):this.summarizeFn(e,t,n)}async getGCData(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if((0,i.v)(!this.gcDisabled,434),(0,i.v)(void 0!==this.getGCDataFn,435),await this.loadBaseGCDetails(),this.canReuseHandle&&!e&&!this.hasDataChanged()&&void 0!==this.gcData)return Ti(this.gcData);const t=await this.getGCDataFn(e);return this.gcData=Ti(t),t}startSummary(e,t){this.gcDisabled||(0,i.v)(void 0===this.wipSerializedUsedRoutes,436),super.startSummary(e,t)}validateSummaryCore(e){return this.wasGCMissed()?{success:!1,reason:"NodeDidNotRunGC",id:{tag:Xt.mc.CodeArtifact,value:this.telemetryNodeId},retryAfterSeconds:1}:super.validateSummaryCore(e)}wasGCMissed(){return!this.gcDisabled&&void 0===this.wipSerializedUsedRoutes}completeSummaryCore(e,t,n,r){let i;if(r&&this.wasGCMissed()&&this.throwUnexpectedError({eventName:"NodeDidNotRunGC",proposalHandle:e}),this.gcDisabled||(i=this.wipSerializedUsedRoutes),super.completeSummaryCore(e,t,n,r),!this.gcDisabled){const t=this.pendingSummaries.get(e);if(void 0!==t){const n=new Ii(i,t);this.pendingSummaries.set(e,n)}}}clearSummary(){this.wipSerializedUsedRoutes=void 0,super.clearSummary()}refreshLatestSummaryFromPending(e,t){if(!this.gcDisabled){const n=this.pendingSummaries.get(e);if(void 0!==n){const r=n;if(void 0===r.serializedUsedRoutes){const n=new o.iq("MissingGCStateInPendingSummary",{proposalHandle:e,referenceSequenceNumber:t,...(0,Xt.Df)({id:this.telemetryNodeId})});throw this.logger.sendErrorEvent({eventName:n.message},n),n}this.referenceUsedRoutes=JSON.parse(r.serializedUsedRoutes)}}return super.refreshLatestSummaryFromPending(e,t)}createChild(e,t,n){var r;let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=arguments.length>4?arguments[4]:void 0;(0,i.v)(!this.children.has(t),438);const a=this.getCreateDetailsForChild(t,n),c=new Ai(this.logger,e,{...s,gcDisabled:null!==(r=s.gcDisabled)&&void 0!==r?r:this.gcDisabled},a.changeSequenceNumber,a.latestSummary,a.initialSummary,this.wipSummaryLogger,o,(async()=>{var e;return null!==(e=(await this.childNodesBaseGCDetailsP).get(t))&&void 0!==e?e:{}}),a.telemetryNodeId);return this.maybeUpdateChildState(c,t),this.children.set(t,c),c}maybeUpdateChildState(e,t){if(super.maybeUpdateChildState(e,t),void 0!==e.latestSummary)for(const[r,i]of this.pendingSummaries.entries()){const s=i;if(void 0!==s.serializedUsedRoutes){var n;const o=null!==(n=dr(JSON.parse(s.serializedUsedRoutes)).get(t))&&void 0!==n?n:[""],a=new Ii(JSON.stringify(o),{referenceSequenceNumber:i.referenceSequenceNumber,basePath:e.latestSummary.basePath,localPath:e.latestSummary.localPath});e.addPendingSummary(r,a)}}}deleteChild(e){this.children.delete(e)}getChild(e){return this.children.get(e)}isReferenced(){return this.usedRoutes.includes("")||this.usedRoutes.includes("/")}updateUsedRoutes(e){this.usedRoutes=e.sort(),!this.gcDisabled&&this.isSummaryInProgress()&&(this.wipSerializedUsedRoutes=JSON.stringify(this.usedRoutes))}hasChanged(){return this.hasDataChanged()||this.hasUsedStateChanged()}hasDataChanged(){return super.hasChanged()}hasUsedStateChanged(){return!this.gcDisabled&&(void 0===this.referenceUsedRoutes||JSON.stringify(this.usedRoutes)!==JSON.stringify(this.referenceUsedRoutes))}}var Di;!function(e){e[e.Local=0]="Local",e[e.Broadcast=1]="Broadcast",e[e.Acked=2]="Acked",e[e.Nacked=-1]="Nacked"}(Di||(Di={}));class Oi{static createLocal(e,t){return new Oi(e,t)}static createFromOp(e){const t=new Oi(e.clientId,e.clientSequenceNumber);return t.broadcast(e),t}get summaryOp(){return this._summaryOp}get summaryAckNack(){return this._summaryAckNack}constructor(e,t){this.clientId=e,this.clientSequenceNumber=t,this.state=Di.Local,this.defSummaryOp=new Ln,this.defSummaryAck=new Ln}hasBeenAcked(){return this.state===Di.Acked}broadcast(e){return(0,i.v)(this.state===Di.Local,373),this._summaryOp=e,this.defSummaryOp.resolve(),this.state=Di.Broadcast,!0}ackNack(e){return(0,i.v)(this.state===Di.Broadcast,374),this._summaryAckNack=e,this.defSummaryAck.resolve(),this.state=e.type===pn.SummaryAck?Di.Acked:Di.Nacked,!0}async waitBroadcast(){return await this.defSummaryOp.promise,this._summaryOp}async waitAckNack(){return await this.defSummaryAck.promise,this._summaryAckNack}}class Pi{get disposed(){return this._disposed}constructor(e,t){this.clientId=e,this.summaryCollection=t,this.localSummaries=new Map,this._disposed=!1}watchSummary(e){let t=this.localSummaries.get(e);return t||(t=Oi.createLocal(this.clientId,e),this.localSummaries.set(t.clientSequenceNumber,t)),t}waitFlushed(){return this.summaryCollection.waitFlushed()}tryGetSummary(e){return this.localSummaries.get(e)}setSummary(e){this.localSummaries.set(e.clientSequenceNumber,e)}dispose(){this.summaryCollection.removeWatcher(this.clientId),this._disposed=!0}}class Ri extends Zt{get latestAck(){return this.lastAck}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return super.emit(e,...n)}get opsSinceLastAck(){var e,t;return this.deltaManager.lastSequenceNumber-(null!==(e=null===(t=this.lastAck)||void 0===t?void 0:t.summaryAck.sequenceNumber)&&void 0!==e?e:this.deltaManager.initialSequenceNumber)}addOpListener(e){this.deltaManager.on("op",e)}removeOpListener(e){this.deltaManager.off("op",e)}constructor(e,t){super(),this.deltaManager=e,this.logger=t,this.summaryWatchers=new Map,this.pendingSummaries=new Map,this.refreshWaitNextAck=new Ln,this.deltaManager.on("op",(e=>this.handleOp(e)))}createWatcher(e){const t=new Pi(e,this);return this.summaryWatchers.set(e,t),t}removeWatcher(e){this.summaryWatchers.delete(e)}setPendingAckTimerTimeoutCallback(e,t){this.maxAckWaitTime=e,this.pendingAckTimerTimeoutCallback=t}unsetPendingAckTimerTimeoutCallback(){this.maxAckWaitTime=void 0,this.pendingAckTimerTimeoutCallback=void 0}async waitFlushed(){for(;this.pendingSummaries.size>0;){const e=Array.from(this.pendingSummaries,(e=>{let[,t]=e;return t.waitAckNack()}));await Promise.all(e)}return this.lastAck}async waitSummaryAck(e){for(;!this.lastAck||this.lastAck.summaryOp.referenceSequenceNumber<e;)await this.refreshWaitNextAck.promise;return this.lastAck}parseContent(e){"string"===typeof e.contents&&(e.contents=JSON.parse(e.contents))}handleOp(e){const t={...e};switch(t.type){case pn.Summarize:return this.parseContent(t),this.handleSummaryOp(t);case pn.SummaryAck:case pn.SummaryNack:return void 0!==t.data?t.contents=JSON.parse(t.data):this.parseContent(t),t.type===pn.SummaryAck?this.handleSummaryAck(t):this.handleSummaryNack(t);default:{const e=t.timestamp;var n;if(void 0!==this.lastSummaryTimestamp&&void 0!==this.maxAckWaitTime&&e-this.lastSummaryTimestamp>=this.maxAckWaitTime)null===(n=this.pendingAckTimerTimeoutCallback)||void 0===n||n.call(this);return void this.emit("default",t)}}}handleSummaryOp(e){let t;const n=this.summaryWatchers.get(e.clientId);n&&(t=n.tryGetSummary(e.clientSequenceNumber),t&&t.broadcast(e)),t||(t=Oi.createFromOp(e),n&&n.setSummary(t)),this.pendingSummaries.set(e.sequenceNumber,t),this.lastSummaryTimestamp=e.timestamp,this.emit(pn.Summarize,e)}handleSummaryAck(e){const t=e.contents.summaryProposal.summarySequenceNumber,n=this.pendingSummaries.get(t);n&&void 0!==n.summaryOp?(n.ackNack(e),this.pendingSummaries.delete(t),(!this.lastAck||t>this.lastAck.summaryAck.contents.summaryProposal.summarySequenceNumber)&&(this.lastAck={summaryOp:n.summaryOp,summaryAck:e},this.refreshWaitNextAck.resolve(),this.refreshWaitNextAck=new Ln,this.emit(pn.SummaryAck,e))):t>this.deltaManager.initialSequenceNumber&&this.logger.sendTelemetryEvent({eventName:"SummaryAckWithoutOp",sequenceNumber:e.sequenceNumber,summarySequenceNumber:t,initialSequenceNumber:this.deltaManager.initialSequenceNumber})}handleSummaryNack(e){const t=e.contents.summaryProposal.summarySequenceNumber,n=this.pendingSummaries.get(t);n&&(n.ackNack(e),this.pendingSummaries.delete(t),this.emit(pn.SummaryNack,e))}}class Mi extends Zt{get count(){return this.clientMap.size}get oldestClient(){return this.rootNode.youngerClient}constructor(e,t,n){super(),this.clientMap=new Map,this.rootNode={sequenceNumber:-1,olderClient:void 0,youngerClient:void 0},this._youngestClient=this.rootNode,this.logger=(0,Xt.pW)({logger:e,namespace:"OrderedClientCollection"});const r=n.getMembers();for(const[i,s]of r)this.addClient(i,s);n.on("addMember",((e,n)=>{const r=this.addClient(e,n);this.emit("addClient",r,t.lastSequenceNumber)})),n.on("removeMember",(e=>{const n=t.lastSequenceNumber,r=this.removeClient(e);void 0===r?this.logger.sendErrorEvent({eventName:"ClientNotFound",clientId:e,sequenceNumber:n}):this.emit("removeClient",r,n)}))}addClient(e,t){(0,i.v)(t.sequenceNumber>-1,502);let n=this._youngestClient;for(;n.sequenceNumber>t.sequenceNumber;)(0,i.v)(void 0!==n.olderClient,503),n=n.olderClient;const r={clientId:e,sequenceNumber:t.sequenceNumber,client:{...t.client},olderClient:n,youngerClient:n.youngerClient};return r.olderClient.youngerClient=r,void 0===r.youngerClient?this._youngestClient=r:r.youngerClient.olderClient=r,this.clientMap.set(e,r),r}removeClient(e){const t=this.clientMap.get(e);if(void 0!==t)return t.olderClient.youngerClient=t.youngerClient,void 0===t.youngerClient?this._youngestClient=t.olderClient:t.youngerClient.olderClient=t.olderClient,this.clientMap.delete(e),t}getAllClients(){const e=[];let t=this.rootNode;for(;void 0!==t.youngerClient;)e.push(t.youngerClient),t=t.youngerClient;return e}}class Bi extends Zt{get eligibleCount(){return this._eligibleCount}get electionSequenceNumber(){return this._electionSequenceNumber}get electedClient(){return this._electedClient}get electedParent(){return this._electedParent}constructor(e,t,n,r){let i,s;super(),this.logger=e,this.orderedClientCollection=t,this.isEligibleFn=r,this._eligibleCount=0;for(const l of t.getAllClients())this.addClient(l,0),"number"!==typeof n&&(l.clientId===n.electedClientId&&(i=l,void 0===n.electedParentId&&l.client.details.type!==jr&&(s=l)),l.clientId===n.electedParentId&&(s=l));if(t.on("addClient",((e,t)=>this.addClient(e,t))),t.on("removeClient",((e,t)=>this.removeClient(e,t))),"number"===typeof n)this._electionSequenceNumber=n;else{var o,a;if((null===(o=i)||void 0===o?void 0:o.clientId)!==n.electedClientId)this.logger.sendErrorEvent({eventName:"InitialElectedClientNotFound",electionSequenceNumber:n.electionSequenceNumber,expectedClientId:n.electedClientId,electedClientId:null===(a=i)||void 0===a?void 0:a.clientId,clientCount:t.count});else if(void 0!==i&&!r(i)){var c;i=s=this.findFirstEligibleParent(s),this.logger.sendErrorEvent({eventName:"InitialElectedClientIneligible",electionSequenceNumber:n.electionSequenceNumber,expectedClientId:n.electedClientId,electedClientId:null===(c=i)||void 0===c?void 0:c.clientId})}this._electedParent=s,this._electedClient=i,this._electionSequenceNumber=n.electionSequenceNumber}}tryElectingClient(e,t){let n=!1;const r=(null===e||void 0===e?void 0:e.client.details.type)===jr,i=this._electedClient;this._electedClient!==e&&(this._electionSequenceNumber=t,this._electedClient=e,n=!0),this._electedParent===e||r||(this._electedParent=e,n=!0),n&&this.emit("election",e,t,i)}tryElectingParent(e,t){this._electedParent!==e&&(this._electedParent=e,this.emit("election",this._electedClient,t,this._electedClient))}findFirstEligibleParent(e){let t=e;for(;void 0!==t&&(!this.isEligibleFn(t)||t.client.details.type===jr);)t=t.youngerClient;return t}addClient(e,t){if(this.isEligibleFn(e)){var n;this._eligibleCount++;const r=e.client.details.type===jr,i=(null===(n=this._electedClient)||void 0===n?void 0:n.client.details.type)===jr;void 0===this._electedClient||!i&&r?this.tryElectingClient(e,t):void 0!==this._electedParent||r||this.tryElectingParent(e,t)}}removeClient(e,t){if(this.isEligibleFn(e))if(this._eligibleCount--,this._electedClient===e)if(this._electedParent!==e){if(this._electedClient.client.details.type!==jr)throw new l("Elected client should be a summarizer client 1");this.tryElectingClient(this._electedParent,t)}else{var n,r;const e=null!==(n=this.findFirstEligibleParent(null===(r=this._electedParent)||void 0===r?void 0:r.youngerClient))&&void 0!==n?n:this.findFirstEligibleParent(this.orderedClientCollection.oldestClient);this.tryElectingClient(e,t)}else if(this._electedParent===e){var i,s,o;if((null===(i=this._electedClient)||void 0===i?void 0:i.client.details.type)!==jr)throw new l("Elected client should be a summarizer client 2");const e=null!==(s=this.findFirstEligibleParent(null===(o=this._electedParent)||void 0===o?void 0:o.youngerClient))&&void 0!==s?s:this.findFirstEligibleParent(this.orderedClientCollection.oldestClient);this.tryElectingParent(e,t)}}getAllEligibleClients(){return this.orderedClientCollection.getAllClients().filter(this.isEligibleFn)}incrementElectedClient(e){var t,n;const r=null!==(t=this.findFirstEligibleParent(null===(n=this._electedParent)||void 0===n?void 0:n.youngerClient))&&void 0!==t?t:this.findFirstEligibleParent(this.orderedClientCollection.oldestClient);void 0===this._electedClient||this._electedClient===this._electedParent?this.tryElectingClient(r,e):this.tryElectingParent(r,e)}resetElectedClient(e){const t=this.findFirstEligibleParent(this.orderedClientCollection.oldestClient);void 0===this._electedClient||this._electedClient===this._electedParent?this.tryElectingClient(t,e):this.tryElectingParent(t,e)}peekNextElectedClient(){var e,t;return null!==(e=this.findFirstEligibleParent(null===(t=this._electedParent)||void 0===t?void 0:t.youngerClient))&&void 0!==e?e:this.findFirstEligibleParent(this.orderedClientCollection.oldestClient)}serialize(){var e,t;return{electionSequenceNumber:this.electionSequenceNumber,electedClientId:null===(e=this.electedClient)||void 0===e?void 0:e.clientId,electedParentId:null===(t=this.electedParent)||void 0===t?void 0:t.clientId}}}const Li=2147483647;function qi(e,t,n){let r;if(t>Li){const i=t-Li;r=setTimeout((()=>qi(e,i,n)),Li)}else r=setTimeout((()=>e()),Math.max(t,0));return null===n||void 0===n||n(r),r}class _i{get hasTimer(){return!!this.runningState}constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:()=>Date.now();this.defaultTimeout=e,this.defaultHandler=t,this.getCurrentTick=n}start(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.defaultTimeout,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.defaultHandler;this.startCore(e,t,e)}clear(){this.runningState&&(clearTimeout(this.runningState.timeout),this.runningState=void 0)}restart(e,t){if(this.runningState){var n,r;const i=null!==e&&void 0!==e?e:this.runningState.intendedDuration,s=null!==(n=null!==t&&void 0!==t?t:null===(r=this.runningState.restart)||void 0===r?void 0:r.handler)&&void 0!==n?n:this.runningState.handler,o=this.calculateRemainingTime(this.runningState);i<o?this.start(i,s):i===o?(this.runningState.handler=s,this.runningState.restart=void 0,this.runningState.intendedDuration=i):this.runningState.restart={startTick:this.getCurrentTick(),duration:i,handler:s}}else this.start(e,t)}startCore(e,t,n){this.clear(),this.runningState={startTick:this.getCurrentTick(),duration:e,intendedDuration:n,handler:t,timeout:qi((()=>this.handler()),e,(e=>{void 0!==this.runningState&&(this.runningState.timeout=e)}))}}handler(){(0,i.v)(!!this.runningState,1892);const e=this.runningState.restart;if(void 0===e){const e=this.runningState.handler;this.clear(),e()}else{const t=this.calculateRemainingTime(e);this.startCore(t,(()=>e.handler()),e.duration)}}calculateRemainingTime(e){const t=this.getCurrentTick()-e.startTick;return e.duration-t}}class ji{get hasTimer(){return this.timer.hasTimer}constructor(e,t){this.timer=new _i(e,(()=>this.wrapHandler(t)))}async start(e,t){return this.clear(),this.deferred=new Ln,this.timer.start(e,t?()=>this.wrapHandler(t):void 0),this.deferred.promise}clear(){this.timer.clear(),this.deferred&&(this.deferred.resolve({timerResult:"cancel"}),this.deferred=void 0)}wrapHandler(e){e(),(0,i.v)(!!this.deferred,1893),this.deferred.resolve({timerResult:"timeout"}),this.deferred=void 0}}const zi=e=>void 0!==e.data;class Ui{get lastAttempt(){return this._lastAttempt}get lastSuccessfulSummary(){return this._lastSuccessfulSummary}get opsSinceLastSummary(){return this.numNonRuntimeOpsBefore+this.numRuntimeOpsBefore}constructor(e,t){this.lastOpSequenceNumber=e,this.hasMissingOpData=!1,this.totalOpsSize=0,this.totalOpsSizeBefore=0,this.numNonRuntimeOps=0,this.numNonRuntimeOpsBefore=0,this.numRuntimeOps=0,this.numRuntimeOpsBefore=0,this._lastAttempt=t,this._lastSuccessfulSummary={...t}}updateWithLastSummaryAckInfo(e){this._lastAttempt=e,this._lastSuccessfulSummary={...e}}recordAttempt(e){this._lastAttempt={refSequenceNumber:null!==e&&void 0!==e?e:this.lastOpSequenceNumber,summaryTime:Date.now()},this.numNonRuntimeOpsBefore=this.numNonRuntimeOps,this.numRuntimeOpsBefore=this.numRuntimeOps,this.totalOpsSizeBefore=this.totalOpsSize}markLastAttemptAsSuccessful(){this._lastSuccessfulSummary={...this.lastAttempt},this.numNonRuntimeOps-=this.numNonRuntimeOpsBefore,this.numNonRuntimeOpsBefore=0,this.numRuntimeOps-=this.numRuntimeOpsBefore,this.numRuntimeOpsBefore=0,this.totalOpsSize-=this.totalOpsSizeBefore,this.totalOpsSizeBefore=0}}class Hi{constructor(e,t,n,r){let i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[new Vi,new Gi];this.heuristicData=e,this.configuration=t,this.logger=r,this.summarizeStrategies=i,this.idleTimer=new _i(this.idleTime,(()=>this.runSummarize("idle"))),this.runSummarize=e=>{var t;null===(t=this.idleTimer)||void 0===t||t.clear();this.opsSinceLastAck>0&&n(e)}}get idleTime(){const e=this.configuration.maxIdleTime,t=this.configuration.minIdleTime,n=1*Ki(this.heuristicData.numRuntimeOps,this.heuristicData.numNonRuntimeOps,this.configuration.runtimeOpWeight,this.configuration.nonRuntimeOpWeight)/this.configuration.maxOps;return n>=1?t:e-(e-t)*n}get opsSinceLastAck(){return this.heuristicData.lastOpSequenceNumber-this.heuristicData.lastSuccessfulSummary.refSequenceNumber}start(){var e;null===(e=this.idleTimer)||void 0===e||e.start(this.idleTime)}run(){var e;for(const t of this.summarizeStrategies)if(t.shouldRunSummary(this.configuration,this.heuristicData))return this.runSummarize(t.summarizeReason);null===(e=this.idleTimer)||void 0===e||e.restart(this.idleTime)}shouldRunLastSummary(){const e=Ki(this.heuristicData.numRuntimeOps,this.heuristicData.numNonRuntimeOps,this.configuration.runtimeOpWeight,this.configuration.nonRuntimeOpWeight),t=this.configuration.minOpsForLastSummaryAttempt;return this.logger.sendTelemetryEvent({eventName:"ShouldRunLastSummary",weightedOpsSinceLastAck:e,minOpsForLastSummaryAttempt:t}),e>=t}dispose(){var e;null===(e=this.idleTimer)||void 0===e||e.clear()}}class Vi{constructor(){this.summarizeReason="maxTime"}shouldRunSummary(e,t){return Date.now()-t.lastSuccessfulSummary.summaryTime>e.maxTime}}function Ki(e,t,n,r){return n*e+r*t}class Gi{constructor(){this.summarizeReason="maxOps"}shouldRunSummary(e,t){return Ki(t.numRuntimeOps,t.numNonRuntimeOps,e.runtimeOpWeight,e.nonRuntimeOpWeight)>e.maxOps}}async function Wi(e,t,n){const r=[e.then((e=>({result:"done",value:e}))),t.then((e=>{let{timerResult:t}=e;return{result:t}}))];return void 0!==n&&r.push(n.waitCancelled.then((()=>({result:"cancelled"})))),Promise.race(r)}const Ji={submitSummaryFailure:"Error while generating, uploading, or submitting summary",summaryOpWaitTimeout:"Timeout while waiting for summarize op broadcast",summaryAckWaitTimeout:"Timeout while waiting for summaryAck/summaryNack op",summaryNack:"Server rejected summary via summaryNack op",disconnect:"Summary cancelled due to summarizer or main client disconnect"};class Zi{constructor(){this.summarySubmitted=new Ln,this.summaryOpBroadcasted=new Ln,this.receivedSummaryAckOrNack=new Ln}fail(e,t,n,r){(0,i.v)(!this.receivedSummaryAckOrNack.isCompleted,606);const s={success:!1,message:e,data:void 0,error:t};this.summarySubmitted.resolve({...s,data:n}),this.summaryOpBroadcasted.resolve(s),this.receivedSummaryAckOrNack.resolve({...s,data:r})}build(){return{summarySubmitted:this.summarySubmitted.promise,summaryOpBroadcasted:this.summaryOpBroadcasted.promise,receivedSummaryAckOrNack:this.receivedSummaryAckOrNack.promise}}}class $i extends o.iq{constructor(e,t,n){super(e,n),this.retryAfterSeconds=t,this.canRetry=void 0!==this.retryAfterSeconds}}class Qi{constructor(e,t,n,r,i,s){this.pendingAckTimer=e,this.heuristicData=t,this.submitSummaryCallback=n,this.successfulSummaryCallback=r,this.summaryWatcher=i,this.logger=s,this.summarizeTimer=new _i(2e4,(()=>this.summarizeTimerHandler(2e4,1)))}summarize(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Zi;return this.summarizeCore(e,t).catch((n=>{const r="UnexpectedSummarizeError";e.summaryLogger.sendErrorEvent({eventName:r},n),t.fail(r,n)})),t.build()}async summarizeCore(e,t){var n;const{summaryLogger:r,cancellationToken:s,...a}=e,c=Date.now()-this.heuristicData.lastAttempt.summaryTime,l=Date.now()-this.heuristicData.lastSuccessfulSummary.summaryTime;let u={...a,fullTree:null!==(n=a.fullTree)&&void 0!==n&&n,timeSinceLastAttempt:c,timeSinceLastSummary:l};const h=Xt.Bt.start(r,{eventName:"Summarize",...u},{start:!0,end:!0,cancel:"generic"});let d;const f=(e,n,r,i,o)=>{var a;const c=s.cancelled||(null===n||void 0===n?void 0:n.errorType)===Un.offlineError?"generic":"error",l=(e=>"".concat(e,": ").concat(Ji[e]))(e);h.cancel({...r,reason:l,category:c,retryAfterSeconds:null!==(a=null===i||void 0===i?void 0:i.retryAfterSeconds)&&void 0!==a?a:null===o||void 0===o?void 0:o.retryAfterSeconds},null!==n&&void 0!==n?n:l),t.fail(l,n,i,o)};this.summarizeTimer.start();try{const n=this.heuristicData.lastAttempt.refSequenceNumber;d=await this.submitSummaryCallback(e);const i=d.referenceSequenceNumber;if(u={...u,referenceSequenceNumber:i,minimumSequenceNumber:d.minimumSequenceNumber,opsSinceLastAttempt:i-n,opsSinceLastSummary:i-this.heuristicData.lastSuccessfulSummary.refSequenceNumber,stage:d.stage},u=this.addSummaryDataToTelemetryProps(d,u),"submit"!==d.stage)return f("submitSummaryFailure",d.error,u,{stage:d.stage,retryAfterSeconds:er(d.error)});if(!e.fullTree&&!d.forcedFullTree){const{summarizedDataStoreCount:e,gcStateUpdatedDataStoreCount:t=0}=d.summaryStats;e>t+this.heuristicData.opsSinceLastSummary&&r.sendErrorEvent({eventName:"IncrementalSummaryViolation",summarizedDataStoreCount:e,gcStateUpdatedDataStoreCount:t,opsSinceLastSummary:this.heuristicData.opsSinceLastSummary})}h.reportEvent("generate",{...u}),t.summarySubmitted.resolve({success:!0,data:d})}catch(p){return f("submitSummaryFailure",p,void 0,{stage:"unknown",retryAfterSeconds:er(p)})}finally{void 0===d&&this.heuristicData.recordAttempt(),this.summarizeTimer.clear()}try{const e=this.pendingAckTimer.start(),n=this.summaryWatcher.watchSummary(d.clientSequenceNumber),a=await Wi(n.waitBroadcast(),e,s);if("cancelled"===a.result)return f("disconnect");if("done"!==a.result)return f("summaryOpWaitTimeout");const c=a.value,l=Date.now()-this.heuristicData.lastAttempt.summaryTime;t.summaryOpBroadcasted.resolve({success:!0,data:{summarizeOp:c,broadcastDuration:l}}),this.heuristicData.lastAttempt.summarySequenceNumber=c.sequenceNumber,r.sendTelemetryEvent({eventName:"Summarize_Op",duration:l,referenceSequenceNumber:c.referenceSequenceNumber,summarySequenceNumber:c.sequenceNumber,handle:c.contents.handle});const p=await Wi(n.waitAckNack(),e,s);if("cancelled"===p.result)return f("disconnect");if("done"!==p.result)return f("summaryAckWaitTimeout");const m=p.value;this.pendingAckTimer.clear();const g=Date.now()-this.heuristicData.lastAttempt.summaryTime;if(u={ackWaitDuration:g,ackNackSequenceNumber:m.sequenceNumber,summarySequenceNumber:m.contents.summaryProposal.summarySequenceNumber,...u},m.type!==pn.SummaryAck){(0,i.v)(m.type===pn.SummaryNack,628);const e=m.contents,t=null===e||void 0===e?void 0:e.message,n=null===e||void 0===e?void 0:e.retryAfter,r=new o.iq("Received summaryNack",{retryAfterSeconds:n,errorMessage:t});return(0,i.v)(er(r)===n,607),f("summaryNack",r,{...u,nackRetryAfter:n},void 0,{summaryNackOp:m,ackNackDuration:g,retryAfterSeconds:n})}this.heuristicData.markLastAttemptAsSuccessful(),this.successfulSummaryCallback(),h.end({...u,handle:m.contents.handle}),t.receivedSummaryAckOrNack.resolve({success:!0,data:{summaryAckOp:m,ackNackDuration:g}})}finally{this.pendingAckTimer.clear()}}addSummaryDataToTelemetryProps(e,t){switch(e.stage){case"base":return t;case"generate":return{...t,...e.summaryStats,generateDuration:e.generateDuration};case"upload":return{...t,...e.summaryStats,generateDuration:e.generateDuration,handle:e.handle,uploadDuration:e.uploadDuration};case"submit":return{...t,...e.summaryStats,generateDuration:e.generateDuration,handle:e.handle,uploadDuration:e.uploadDuration,clientSequenceNumber:e.clientSequenceNumber,hasMissingOpData:this.heuristicData.hasMissingOpData,opsSizesSinceLastSummary:this.heuristicData.totalOpsSize,nonRuntimeOpsSinceLastSummary:this.heuristicData.numNonRuntimeOps,runtimeOpsSinceLastSummary:this.heuristicData.numRuntimeOps};default:(0,i.v)(!0,919)}return t}summarizeTimerHandler(e,t){if(this.logger.sendPerformanceEvent({eventName:"SummarizeTimeout",timeoutTime:e,timeoutCount:t}),t<5){const n=2*e;this.summarizeTimer.start(n,(()=>this.summarizeTimerHandler(n,t+1)))}}dispose(){this.summarizeTimer.clear()}}class Xi extends Zt{static async start(e,t,n,r,i,s,o,a,c,l){var u,h;const d=new Xi(e,t,n,r,i,s,o,a,c,l),f=await d.handleSummaryAck();await d.waitStart(),d.processIncomingSummaryAcks(f).catch((t=>{(0,Xt.pW)({logger:e}).sendErrorEvent({eventName:"HandleSummaryAckFatalError"},t)}));const p=l.deltaManager.lastSequenceNumber-(s.lastSuccessfulSummary.refSequenceNumber+s.numNonRuntimeOps+s.numRuntimeOps);return s.hasMissingOpData=p>0,s.hasMissingOpData&&(s.numNonRuntimeOps+=Math.ceil(p/2),s.numRuntimeOps+=Math.floor(p/2)),s.lastOpSequenceNumber=l.deltaManager.lastSequenceNumber,null===(u=d.heuristicRunner)||void 0===u||u.start(),null===(h=d.heuristicRunner)||void 0===h||h.run(),d}get disposed(){return this._disposed}constructor(e,t,n,r,s,o,a,c,l,u){super(),this.summaryWatcher=t,this.configuration=n,this.submitSummaryCallback=r,this.refreshLatestSummaryAckCallback=s,this.heuristicData=o,this.summaryCollection=a,this.cancellationToken=c,this.stopSummarizerCallback=l,this.runtime=u,this.stopping=!1,this._disposed=!1,this.tryWhileSummarizing=!1,this.summarizeCount=0,this.totalSuccessfulAttempts=0,this.initialized=!1,this.tryGetCorrelatedLogger=e=>this.heuristicData.lastAttempt.refSequenceNumber===e?this.mc.logger:void 0,this.heuristicRunnerMicroTaskExists=!1;const h={summarizeCount:()=>this.summarizeCount,summarizerSuccessfulAttempts:()=>this.totalSuccessfulAttempts};this.mc=(0,Yt.CL)({logger:e,namespace:"Running",properties:{all:h}}),"disableHeuristics"!==n.state&&((0,i.v)("enabled"===this.configuration.state,746),this.heuristicRunner=new Hi(o,this.configuration,(e=>this.trySummarize(e)),this.mc.logger)),(0,i.v)("disabled"!==this.configuration.state,747);const d=Math.min(this.configuration.maxAckWaitTime,6e5);this.pendingAckTimer=new ji(d,(()=>{this.mc.logger.sendErrorEvent({eventName:"SummaryAckWaitTimeout",message:"Pending summary ack not received in time",maxAckWaitTime:d,referenceSequenceNumber:this.heuristicData.lastAttempt.refSequenceNumber,summarySequenceNumber:this.heuristicData.lastAttempt.summarySequenceNumber,timePending:Date.now()-this.heuristicData.lastAttempt.summaryTime})})),a.setPendingAckTimerTimeoutCallback(d,(()=>{this.pendingAckTimer.hasTimer&&(this.mc.logger.sendTelemetryEvent({eventName:"MissingSummaryAckFoundByOps",referenceSequenceNumber:this.heuristicData.lastAttempt.refSequenceNumber,summarySequenceNumber:this.heuristicData.lastAttempt.summarySequenceNumber}),this.pendingAckTimer.clear())})),this.generator=new Qi(this.pendingAckTimer,this.heuristicData,this.submitSummaryCallback,(()=>{this.totalSuccessfulAttempts++}),this.summaryWatcher,this.mc.logger),this.runtimeListener=(e,t)=>{this.handleOp(e,!0===t)},this.runtime.on("op",this.runtimeListener);const f=this.mc.config.getNumber("Fluid.Summarizer.AttemptsForSubmitFailures");this.maxAttemptsForSubmitFailures=f&&f<5?f:5}async handleSummaryAck(){const e=this.summaryCollection.latestAck;let t=-1;if(void 0!==e){var n;t=e.summaryOp.referenceSequenceNumber;const r=null!==(n=this.tryGetCorrelatedLogger(t))&&void 0!==n?n:this.mc.logger,i=e.summaryOp.contents.handle,s=e.summaryAck.contents.handle;for(;void 0!==this.summarizingLock;)r.sendTelemetryEvent({eventName:"RefreshAttemptWithSummarizerRunning",referenceSequenceNumber:t,proposalHandle:i,ackHandle:s}),await this.summarizingLock;await this.lockedSummaryAction((()=>{}),(async()=>this.refreshLatestSummaryAckCallback({proposalHandle:i,ackHandle:s,summaryRefSeq:t,summaryLogger:r}).catch((async e=>{const n=(0,qn.Xy)(e)&&e.errorType===Un.fileNotFoundOrAccessDeniedError;r.sendTelemetryEvent({eventName:n?"HandleSummaryAckErrorIgnored":"HandleLastSummaryAckError",referenceSequenceNumber:t,proposalHandle:i,ackHandle:s},e)}))),(()=>{})),t++}return t}async processIncomingSummaryAcks(e){let t=e>0?e:this.runtime.deltaManager.initialSequenceNumber;for(;!this.disposed;){var n;const r=null!==(n=this.tryGetCorrelatedLogger(t))&&void 0!==n?n:this.mc.logger;await this.summaryCollection.waitSummaryAck(t),r.sendTelemetryEvent({eventName:"processIncomingSummaryAcks",referenceSequenceNumber:t,lastAckRefSeq:e}),t=await this.handleSummaryAck(),(0,i.v)(t>=0,1423)}}dispose(){var e;this.runtime.off("op",this.runtimeListener),this.summaryWatcher.dispose(),null===(e=this.heuristicRunner)||void 0===e||e.dispose(),this.heuristicRunner=void 0,this.generator.dispose(),this.pendingAckTimer.clear(),this.disposeEnqueuedSummary(),this._disposed=!0,this.stopping=!0}handleOp(e,t){this.heuristicData.lastOpSequenceNumber=e.sequenceNumber,t?this.heuristicData.numRuntimeOps++:this.heuristicData.numNonRuntimeOps++,this.heuristicData.totalOpsSize+=(e=>{var t;const n="string"===typeof e.contents?e.contents:null!==(t=JSON.stringify(e.contents))&&void 0!==t?t:"",r=zi(e)?e.data:"";return n.length+r.length})(e),this.initialized&&this.opCanTriggerSummary(e,t)&&!this.tryRunEnqueuedSummary()&&!this.heuristicRunnerMicroTaskExists&&(this.heuristicRunnerMicroTaskExists=!0,Promise.resolve().then((()=>{var e;null===(e=this.heuristicRunner)||void 0===e||e.run()})).finally((()=>{this.heuristicRunnerMicroTaskExists=!1})))}opCanTriggerSummary(e,t){switch(e.type){case pn.Summarize:case pn.SummaryAck:case pn.SummaryNack:return!1;default:return t||this.nonRuntimeOpCanTriggerSummary()}}nonRuntimeOpCanTriggerSummary(){const e=this.heuristicData.lastOpSequenceNumber-this.heuristicData.lastSuccessfulSummary.refSequenceNumber;return"enabled"===this.configuration.state&&(void 0===this.configuration.nonRuntimeHeuristicThreshold||this.configuration.nonRuntimeHeuristicThreshold<=e)}async waitStop(e){var t;this.stopping||(this.stopping=!0,this.disposeEnqueuedSummary(),e&&null!==(t=this.heuristicRunner)&&void 0!==t&&t.shouldRunLastSummary()&&void 0===this.summarizingLock&&this.trySummarizeOnce({summarizeReason:"lastSummary"},{}),await this.summarizingLock)}async waitStart(){const e=await Wi(this.summaryWatcher.waitFlushed(),this.pendingAckTimer.start());this.pendingAckTimer.clear(),this.summaryCollection.unsetPendingAckTimerTimeoutCallback(),"done"===e.result&&void 0!==e.value&&this.heuristicData.updateWithLastSummaryAckInfo({refSequenceNumber:e.value.summaryOp.referenceSequenceNumber,summaryTime:Date.now(),summarySequenceNumber:e.value.summaryOp.sequenceNumber}),this.initialized=!0}beforeSummaryAction(){this.summarizeCount++}afterSummaryAction(){const e=this.tryWhileSummarizing;var t;(this.tryWhileSummarizing=!1,this.stopping||this.tryRunEnqueuedSummary()||!e)||(null===(t=this.heuristicRunner)||void 0===t||t.run())}async lockedSummaryAction(e,t,n){(0,i.v)(void 0===this.summarizingLock,603);const r=new Ln;return this.summarizingLock=r.promise,e(),t().finally((()=>{r.resolve(),this.summarizingLock=void 0,n()}))}trySummarizeOnce(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Zi;return this.lockedSummaryAction((()=>{this.beforeSummaryAction()}),(async()=>{const r=(0,Xt.pW)({logger:this.mc.logger,properties:{all:e}}),i={...t,summaryLogger:r,cancellationToken:this.cancellationToken};return this.generator.summarize(i,n).receivedSummaryAckOrNack}),(()=>{this.afterSummaryAction()})).catch((e=>{})),n.build()}trySummarize(e){void 0===this.summarizingLock?this.lockedSummaryAction((()=>{this.beforeSummaryAction()}),(async()=>this.mc.config.getBoolean("Fluid.Summarizer.UseDynamicRetries")?this.trySummarizeWithRetries(e):this.trySummarizeWithStaticAttempts(e)),(()=>{this.afterSummaryAction()})).catch((e=>{this.mc.logger.sendErrorEvent({eventName:"UnexpectedSummarizeError"},e)})):this.tryWhileSummarizing=!0}async trySummarizeWithStaticAttempts(e){const t=[{refreshLatestAck:!1,fullTree:!1},{refreshLatestAck:!0,fullTree:!1}];let n=0,r=0,i=0;for(;i<t.length;){var s,o;if(this.cancellationToken.cancelled)return;if(++n>1&&"lastSummary"===e)return;r++;const c=t[i],l={summarizeReason:e,summaryAttempts:n,summaryAttemptsPerPhase:r,summaryAttemptPhase:i+1,...c},u=(0,Xt.pW)({logger:this.mc.logger,properties:{all:l}}),h={...c,summaryLogger:u,cancellationToken:this.cancellationToken},d=this.generator.summarize(h),f=await d.receivedSummaryAckOrNack;if(f.success)return;const p=await d.summarySubmitted,m=p.success?null===(o=f.data)||void 0===o?void 0:o.retryAfterSeconds:null===(s=p.data)||void 0===s?void 0:s.retryAfterSeconds;var a;if((void 0===m||r>1)&&(i++,r=0),void 0!==m)this.mc.logger.sendPerformanceEvent({eventName:"SummarizeAttemptDelay",duration:m,summaryNackDelay:void 0!==(null===(a=f.data)||void 0===a?void 0:a.retryAfterSeconds),...l}),await cn(1e3*m)}this.stopSummarizerCallback("failToSummarize")}async trySummarizeWithRetries(e){const t=(t,n)=>{const r={fullTree:!1},i={summarizeReason:e,summaryAttempts:t,...r,finalAttempt:n},s=(0,Xt.pW)({logger:this.mc.logger,properties:{all:i}}),o={...r,summaryLogger:s,cancellationToken:this.cancellationToken,finalAttempt:n};return{summarizeProps:i,summarizeResult:this.generator.summarize(o)}};let n,r,i=2,s=0,o=!1,a="success";do{if(s++,this.cancellationToken.cancelled){a="canceled",o=!0;break}const e=t(s,!1);r=e.summarizeResult;const d=await r.receivedSummaryAckOrNack;if(d.success){a="success",o=!0;break}const f=await r.summarySubmitted;var c,l;if(f.success)i=2,n=null===(c=d.data)||void 0===c?void 0:c.retryAfterSeconds;else i=this.maxAttemptsForSubmitFailures,n=null===(l=f.data)||void 0===l?void 0:l.retryAfterSeconds;a="failure";const p={result:a,currentAttempt:s,maxAttempts:i,error:d.error};var u,h;if(this.emit("summarize",p),(void 0===n||s>=i-1)&&(o=!0),void 0!==n)this.mc.logger.sendPerformanceEvent({eventName:"SummarizeAttemptDelay",duration:n,summaryNackDelay:void 0!==(null===(u=d.data)||void 0===u?void 0:u.retryAfterSeconds),stage:null===(h=f.data)||void 0===h?void 0:h.stage,dynamicRetries:!0,...e.summarizeProps}),await cn(1e3*n)}while(!o);if("failure"!==a)return this.emit("summarize",{result:a,currentAttempt:s,maxAttempts:i}),r;if(void 0!==n){const{summarizeResult:e}=t(++s,!0),n=await e.receivedSummaryAckOrNack;a=n.success?"success":"failure";const o={result:a,currentAttempt:s,maxAttempts:i,error:n.success?void 0:n.error};this.emit("summarize",o),r=e}return"failure"===a&&this.stopSummarizerCallback("failToSummarize"),r}async summarizeOnDemandWithRetries(e,t){const n=await this.trySummarizeWithRetries(e);if(void 0===n)return t.fail("Summarization was canceled",void 0),t.build();const r=await n.summarySubmitted,i=await n.summaryOpBroadcasted,s=await n.receivedSummaryAckOrNack;return t.summarySubmitted.resolve(r),t.summaryOpBroadcasted.resolve(i),t.receivedSummaryAckOrNack.resolve(s),t.build()}summarizeOnDemand(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Zi;if(this.stopping)return t.fail("RunningSummarizer stopped or disposed",void 0),t.build();if(void 0!==this.summarizingLock)throw new l("Attempted to run an already-running summarizer on demand");const{reason:n,...r}=e;return!0===e.retryOnFailure?this.summarizeOnDemandWithRetries("onDemand;".concat(n),t).catch((e=>{t.fail("summarize failed",e)})):this.trySummarizeOnce({summarizeReason:"onDemand/".concat(n)},r,t),t.build()}enqueueSummarize(e){const{reason:t,afterSequenceNumber:n=0,override:r=!1,...i}=e;let s=!1;if(void 0!==this.enqueuedSummary){if(!r)return{alreadyEnqueued:!0};this.enqueuedSummary.resultsBuilder.fail("Aborted; overridden by another enqueue summarize attempt",void 0),this.enqueuedSummary=void 0,s=!0}this.enqueuedSummary={reason:"enqueue;".concat(t),afterSequenceNumber:n,summarizeOptions:i,resultsBuilder:new Zi};const o=this.enqueuedSummary.resultsBuilder.build();return this.tryRunEnqueuedSummary(),s?{...o,alreadyEnqueued:!0,overridden:!0}:o}tryRunEnqueuedSummary(){if(this.stopping)return this.disposeEnqueuedSummary(),!1;if(void 0===this.enqueuedSummary||this.heuristicData.lastOpSequenceNumber<this.enqueuedSummary.afterSequenceNumber||void 0!==this.summarizingLock)return!1;const{reason:e,resultsBuilder:t,summarizeOptions:n}=this.enqueuedSummary;return this.enqueuedSummary=void 0,this.trySummarizeOnce({summarizeReason:"enqueuedSummary/".concat(e)},n,t),!0}disposeEnqueuedSummary(){void 0!==this.enqueuedSummary&&(this.enqueuedSummary.resultsBuilder.fail("RunningSummarizer stopped or disposed",void 0),this.enqueuedSummary=void 0)}}class Yi extends o.iq{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];super(e),this.logged=t,this.errorType="summarizingError",this.canRetry=!0}static wrap(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0;return(0,o.G)(e,(e=>new Yi(e,t)),n)}}class es extends Zt{get ISummarizer(){return this}constructor(e,t,n,r,i,s){super(),this.runtime=e,this.configurationGetter=t,this.internalsProvider=n,this.summaryCollection=i,this.runCoordinatorCreateFn=s,this._disposed=!1,this.starting=!1,this.stopDeferred=new Ln,this.handleSummarizeEvent=e=>{this.emit("summarize",e)},this.logger=(0,Xt.pW)({logger:this.runtime.logger,namespace:"Summarizer"})}async run(e){try{return await this.runCore(e)}catch(t){throw this.stop("summarizerException"),Yi.wrap(t,!1,this.logger)}finally{this.close()}}stop(e){this.stopDeferred.resolve(e)}close(){this.dispose(),this.runtime.disposeFn()}async runCore(e){const t=await this.runCoordinatorCreateFn(this.runtime),n=Promise.race([t.waitCancelled,this.stopDeferred.promise]);if(n.then((t=>{this.logger.sendTelemetryEvent({eventName:"StoppingSummarizer",onBehalfOf:e,reason:t})})),t.cancelled)return t.waitCancelled;const r=await this.start(e,t),i=await n;return await r.waitStop(!t.cancelled&&es.stopReasonCanRunLastSummary(i)),t.stop(i),i}static stopReasonCanRunLastSummary(e){return"parentNotConnected"===e}async start(e,t){var n=this;if(this.runningSummarizer){if(this.runningSummarizer.disposed)throw new l("Starting a disposed summarizer");return this.runningSummarizer}if(this.starting)throw new l("Attempting to start a summarizer that is already starting");this.starting=!0,this.logger.sendTelemetryEvent({eventName:"RunningSummarizer",onBehalfOf:e,initSummarySeqNumber:this.runtime.deltaManager.initialSequenceNumber,config:JSON.stringify(this.configurationGetter())});const r=this.runtime.clientId;if(void 0===r)throw new l("clientId should be defined if connected.");this._heuristicData=new Ui(this.runtime.deltaManager.lastSequenceNumber,{refSequenceNumber:this.runtime.deltaManager.initialSequenceNumber,summaryTime:Date.now()});const i=await Xi.start(this.logger,this.summaryCollection.createWatcher(r),this.configurationGetter(),(async function(){return n.internalsProvider.submitSummary(...arguments)}),(async function(){return n.internalsProvider.refreshLatestSummaryAck(...arguments)}),this._heuristicData,this.summaryCollection,t,(e=>t.stop(e)),this.runtime);return this.runningSummarizer=i,this.runningSummarizer.on("summarize",this.handleSummarizeEvent),this.starting=!1,i}dispose(){this.stop("summarizerClientDisconnected"),this._disposed=!0,this.runningSummarizer&&(this.runningSummarizer.off("summarize",this.handleSummarizeEvent),this.runningSummarizer.dispose(),this.runningSummarizer=void 0)}summarizeOnDemand(e){try{var t;if(this._disposed||null!==(t=this.runningSummarizer)&&void 0!==t&&t.disposed)throw new l("Summarizer is already disposed.");if(void 0!==this.runtime.summarizerClientId&&this.runtime.summarizerClientId!==this.runtime.clientId)throw new l("On-demand summary attempted while an elected summarizer is present");const n=new Zi;if(this.runningSummarizer)return this.runningSummarizer.summarizeOnDemand(e,n);return this.runCoordinatorCreateFn(this.runtime).then((t=>{this.start(this.runtime.clientId,t).then((async r=>{r.summarizeOnDemand(e,n);const i=await Promise.race([this.stopDeferred.promise,t.waitCancelled]);await r.waitStop(!1),t.stop(i),this.close()})).catch((e=>{n.fail("Failed to start summarizer",e)}))})).catch((e=>{n.fail("Failed to create cancellation token",e)})),n.build()}catch(n){throw Yi.wrap(n,!1,this.logger)}}enqueueSummarize(e){if(this._disposed||void 0===this.runningSummarizer||this.runningSummarizer.disposed)throw new l("Summarizer is not running or already disposed.");return this.runningSummarizer.enqueueSummarize(e)}recordSummaryAttempt(e){var t;null===(t=this._heuristicData)||void 0===t||t.recordAttempt(e)}}new Promise((()=>{}));class ts{get cancelled(){return this._cancelled||(0,i.v)(this.active(),605),this._cancelled}get waitCancelled(){return this.stopDeferred.promise}static async create(e,t){const n=new ts(e,t);return await n.waitStart(),n}constructor(e,t){this.runtime=e,this.active=t,this._cancelled=!1,this.stopDeferred=new Ln}async waitStart(){if(this.runtime.disposed)this.stop("summarizerClientDisconnected");else{if(this.runtime.once("dispose",(()=>this.stop("summarizerClientDisconnected"))),!this.runtime.connected){const e=new Promise((e=>this.runtime.once("connected",e)));await Promise.race([e,this.waitCancelled])}this.runtime.once("disconnected",(()=>this.stop("summarizerClientDisconnected")))}}stop(e){this._cancelled||(this._cancelled=!0,this.stopDeferred.resolve(e))}}const ns=5e3,rs=4e3;var is;!function(e){e[e.Off=0]="Off",e[e.Starting=1]="Starting",e[e.Running=2]="Running",e[e.Stopping=3]="Stopping"}(is||(is={}));class ss extends Zt{get disposed(){return this._disposed}get currentState(){return this.state}constructor(e,t,n,r,i,s){let{initialDelayMs:o=ns,opsToBypassInitialDelay:a=rs}=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{},c=arguments.length>7?arguments[7]:void 0;super(),this.clientElection=e,this.connectedState=t,this.summaryCollection=n,this.createSummarizerFn=i,this.startThrottler=s,this.disableHeuristics=c,this.state=is.Off,this._disposed=!1,this.handleConnected=e=>{this.latestClientId=e,this.refreshSummarizer()},this.handleDisconnected=()=>{this.refreshSummarizer()},this.handleSummarizeEvent=e=>{this.emit("summarize",e)},this.refreshSummarizer=()=>{const e=this.getShouldSummarizeState();switch(this.state){case is.Off:return void(e.shouldSummarize&&this.startSummarization());case is.Starting:return;case is.Running:return void(!1===e.shouldSummarize&&this.stop(e.stopReason));case is.Stopping:default:return}},this.logger=(0,Xt.pW)({logger:r,namespace:"SummaryManager",properties:{all:{clientId:()=>this.latestClientId}}}),this.connectedState.on("connected",this.handleConnected),this.connectedState.on("disconnected",this.handleDisconnected),this.latestClientId=this.connectedState.clientId,this.opsToBypassInitialDelay=a,this.initialDelayMs=o}start(){this.clientElection.on("electedSummarizerChanged",this.refreshSummarizer),this.refreshSummarizer()}getShouldSummarizeState(){return this.connectedState.clientId!==this.clientElection.electedParentId?{shouldSummarize:!1,stopReason:"notElectedParent"}:this.state!==is.Running&&this.connectedState.clientId!==this.clientElection.electedClientId?{shouldSummarize:!1,stopReason:"notElectedClient"}:this.connectedState.connected?this.disposed?void(0,i.v)(!1,608):{shouldSummarize:!0}:{shouldSummarize:!1,stopReason:"parentNotConnected"}}startSummarization(){(0,i.v)(this.state===is.Off,609),this.state=is.Starting,(0,i.v)(void 0===this.summarizer,610),this.delayBeforeCreatingSummarizer().then((async e=>{const t=this.getShouldSummarizeState();if(e&&!1===t.shouldSummarize)return"early exit ".concat(t.stopReason);(0,i.v)(this.state===is.Starting,611),this.state=is.Running;const n=await this.createSummarizerFn();this.summarizer=n,this.summarizer.on("summarize",this.handleSummarizeEvent);const r=this.getShouldSummarizeState();if(!1===r.shouldSummarize){if(e||!es.stopReasonCanRunLastSummary(r.stopReason))return this.state=is.Starting,n.stop(r.stopReason),"early exit after starting summarizer ".concat(r.stopReason);this.logger.sendTelemetryEvent({eventName:"LastAttemptToSummarize"})}const s=this.latestClientId;return Xt.Bt.timedExecAsync(this.logger,{eventName:"RunningSummarizer",attempt:this.startThrottler.numAttempts},(async()=>n.run(s,this.disableHeuristics)))})).then((e=>{this.logger.sendTelemetryEvent({eventName:"EndingSummarizer",reason:e})})).catch((e=>{if(this.logger.sendTelemetryEvent({eventName:"EndingSummarizer",reason:"exception"},e),this.getShouldSummarizeState().shouldSummarize||void 0!==this.summarizer){const t=(null===e||void 0===e?void 0:e.errorType)===Un.offlineError?"generic":"error";this.logger.sendTelemetryEvent({eventName:"SummarizerException",category:t},e)}})).finally((()=>{var e,t;(0,i.v)(this.state!==is.Off,612),this.state=is.Off,null===(e=this.summarizer)||void 0===e||e.off("summarize",this.handleSummarizeEvent),null===(t=this.summarizer)||void 0===t||t.close(),this.summarizer=void 0,this.getShouldSummarizeState().shouldSummarize&&this.startSummarization()}))}stop(e){var t;ss.isStartingOrRunning(this.state)&&(this.state=is.Stopping,null===(t=this.summarizer)||void 0===t||t.stop(e))}async delayBeforeCreatingSummarizer(){let e=this.startThrottler.getDelay();this.logger.sendTelemetryEvent({eventName:"CreatingSummarizer",throttlerDelay:e,initialDelay:this.initialDelayMs,startThrottlerMaxDelayMs:this.startThrottler.maxDelayMs,opsSinceLastAck:this.summaryCollection.opsSinceLastAck,opsToBypassInitialDelay:this.opsToBypassInitialDelay,electedParentId:this.clientElection.electedParentId,electedClientId:this.clientElection.electedClientId});let t=!1;if(this.summaryCollection.opsSinceLastAck<this.opsToBypassInitialDelay&&(t=!0,e=Math.max(e,this.initialDelayMs)),e>0){let t,n;const r=()=>{this.summaryCollection.opsSinceLastAck>=this.opsToBypassInitialDelay&&(clearTimeout(t),n())},i=new Promise((n=>{t=setTimeout((()=>n()),e)})),s=new Promise((e=>{n=e}));this.summaryCollection.addOpListener(r),await Promise.race([i,s]),this.summaryCollection.removeOpListener(r)}return t}summarizeOnDemand(e){if(void 0===this.summarizer)throw Error("No running summarizer client");return this.summarizer.summarizeOnDemand(e)}enqueueSummarize(e){if(void 0===this.summarizer)throw Error("No running summarizer client");return this.summarizer.enqueueSummarize(e)}dispose(){var e;this.clientElection.off("electedSummarizerChanged",this.refreshSummarizer),this.connectedState.off("connected",this.handleConnected),this.connectedState.off("disconnected",this.handleDisconnected),null===(e=this.summarizer)||void 0===e||e.off("summarize",this.handleSummarizeEvent),this._disposed=!0}}ss.isStartingOrRunning=e=>e===is.Starting||e===is.Running;class os{get numAttempts(){return this.startTimes.length}getAttempts(){return[...this.startTimes]}get latestAttemptTime(){return this.startTimes.length>0?this.startTimes[this.startTimes.length-1]:void 0}constructor(e,t,n){this.delayWindowMs=e,this.maxDelayMs=t,this.delayFn=n,this.startTimes=[]}getDelay(){const e=Date.now(),t=this.latestAttemptTime;if(void 0!==t){const n=t-e;n>0&&(this.startTimes=this.startTimes.map((e=>e-n)))}this.startTimes=this.startTimes.filter((t=>e-t<this.delayWindowMs));const n=Math.min(this.delayFn(this.startTimes.length),this.maxDelayMs);return this.startTimes.push(e),this.startTimes=this.startTimes.map((e=>e+n)),n===this.maxDelayMs&&this.startTimes.shift(),n}}const as=function(){let{multiplier:e=2,coefficient:t=1,offset:n=0,initialDelay:r}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return i=>Math.max(0,i<=0&&void 0!==r?r:t*Math.pow(e,i)+n)},cs={...s,clientSessionExpiredError:"clientSessionExpiredError"};var ls,us;!function(e){e.genericError="genericError",e.throttlingError="throttlingError",e.dataCorruptionError="dataCorruptionError",e.dataProcessingError="dataProcessingError",e.usageError="usageError",e.clientSessionExpiredError="clientSessionExpiredError"}(ls||(ls={}));class hs extends o.iq{constructor(e,t){super(e,{timeoutMs:t}),this.expiryMs=t,this.errorType=cs.clientSessionExpiredError}}function ds(e){return e&&e+$r+Zr}function fs(e,t){const n=new Set,r=[...t];for(const o of r){if(n.has(o))continue;n.add(o);const t=e[o];void 0!==t&&r.push(...t)}const i=[],s=[];for(const o of Object.keys(e))n.has(o)?i.push(o):s.push(o);return{referencedNodeIds:i,deletedNodeIds:s}}!function(e){e.FluidDataStoreOp="component",e.Attach="attach",e.ChunkedOp="chunkedOp",e.BlobAttach="blobAttach",e.Rejoin="rejoin",e.Alias="alias",e.IdAllocation="idAllocation",e.GC="GC"}(us||(us={}));const ps="".concat(nn.YV,"_root");class ms{constructor(e,t){var n;this.configs=e,this.updatedDSCountSinceLastSummary=0,this.autoRecovery={requestFullGCOnNextRun:()=>{this.fullGCModeForAutoRecovery=!0},fullGCRequested:()=>this.fullGCModeForAutoRecovery},this.fullGCModeForAutoRecovery=!1,this.wasGCRunInLatestSummary=t,this.latestSummaryGCVersion=null!==(n=this.configs.gcVersionInBaseSnapshot)&&void 0!==n?n:this.configs.gcVersionInEffect}get doesGCStateNeedReset(){return this.wasGCRunInLatestSummary!==this.configs.shouldRunGC}get doesSummaryStateNeedReset(){return this.doesGCStateNeedReset||this.configs.shouldRunGC&&this.latestSummaryGCVersion!==this.configs.gcVersionInEffect}initializeBaseState(e){void 0!==e&&(this.latestSummaryData={serializedGCState:e.gcState?JSON.stringify(xi(e.gcState)):void 0,serializedTombstones:JSON.stringify(e.tombstones),serializedDeletedNodes:JSON.stringify(e.deletedNodes)})}summarize(e,t,n,r,i){if(!this.configs.shouldRunGC)return;const s=JSON.stringify(xi(n)),o=r.size>0?JSON.stringify(Array.from(r).sort()):void 0,a=this.configs.tombstoneMode&&i.length>0?JSON.stringify(i.sort()):void 0;if(this.pendingSummaryData={serializedGCState:s,serializedTombstones:a,serializedDeletedNodes:o},t&&!e&&void 0!==this.latestSummaryData){if(this.latestSummaryData.serializedGCState===s&&this.latestSummaryData.serializedTombstones===a&&this.latestSummaryData.serializedDeletedNodes===o){const e=Ft();return e.handleNodeCount++,{summary:{type:Et.Handle,handle:"/".concat(nn.aT),handleType:Et.Tree},stats:e}}return this.buildGCSummaryTree(s,a,o,!0)}return this.buildGCSummaryTree(s,a,o,!1)}buildGCSummaryTree(e,t,n,r){var i,s;const o=new Pt;var a;((null===(i=this.latestSummaryData)||void 0===i?void 0:i.serializedGCState)===e&&r?o.addHandle(ps,Et.Blob,"/".concat(nn.aT,"/").concat(ps)):o.addBlob(ps,e),void 0!==t)&&((null===(a=this.latestSummaryData)||void 0===a?void 0:a.serializedTombstones)===t&&r?o.addHandle(nn.Yz,Et.Blob,"/".concat(nn.aT,"/").concat(nn.Yz)):o.addBlob(nn.Yz,t));return void 0===n||((null===(s=this.latestSummaryData)||void 0===s?void 0:s.serializedDeletedNodes)===n&&r?o.addHandle(nn.kc,Et.Blob,"/".concat(nn.aT,"/").concat(nn.kc)):o.addBlob(nn.kc,n)),o.getSummaryTree()}async refreshLatestSummary(e){e.isSummaryTracked&&(this.wasGCRunInLatestSummary=this.configs.shouldRunGC,this.configs.shouldRunGC&&(this.latestSummaryGCVersion=this.configs.gcVersionInEffect,this.latestSummaryData=this.pendingSummaryData,this.pendingSummaryData=void 0,this.updatedDSCountSinceLastSummary=0,this.fullGCModeForAutoRecovery=!1))}updateStateFromGCRunStats(e){this.updatedDSCountSinceLastSummary+=e.updatedDataStoreCount}}class gs extends _i{constructor(e){super(0,(()=>{throw new Error("DefaultHandler should not be used")})),this.callback=e}start(e){super.start(e,this.callback)}restart(e){super.restart(e,this.callback)}}class vs extends Map{delete(e){var t;return null===(t=this.get(e))||void 0===t||t.stopTracking(),super.delete(e)}}class ys{get state(){return this._state}constructor(e,t,n,r,s){this.unreferencedTimestampMs=e,this.inactiveTimeoutMs=t,this.tombstoneTimeoutMs=r,this.sweepGracePeriodMs=s,this._state=ri,a(void 0===this.tombstoneTimeoutMs||this.tombstoneTimeoutMs>=this.inactiveTimeoutMs,"inactiveTimeoutMs must not be greater than the tombstoneTimeoutMs"),this.sweepTimer=new gs((()=>{this._state=oi,(0,i.v)(!this.inactiveTimer.hasTimer&&!this.tombstoneTimer.hasTimer,2147)})),this.tombstoneTimer=new gs((()=>{this._state=si,(0,i.v)(!this.inactiveTimer.hasTimer,2148),this.sweepGracePeriodMs>0?this.sweepTimer.restart(this.sweepGracePeriodMs):this._state=oi})),this.inactiveTimer=new gs((()=>{this._state=ii,void 0!==this.tombstoneTimeoutMs&&this.tombstoneTimer.restart(this.tombstoneTimeoutMs-this.inactiveTimeoutMs)})),this.updateTracking(n)}updateTracking(e){const t=e-this.unreferencedTimestampMs;if(this.clearTimers(),!(void 0!==this.tombstoneTimeoutMs&&t>=this.tombstoneTimeoutMs+this.sweepGracePeriodMs))return void 0!==this.tombstoneTimeoutMs&&t>=this.tombstoneTimeoutMs?(this._state=si,void this.sweepTimer.restart(this.tombstoneTimeoutMs+this.sweepGracePeriodMs-t)):t>=this.inactiveTimeoutMs?(this._state=ii,void(void 0!==this.tombstoneTimeoutMs&&this.tombstoneTimer.restart(this.tombstoneTimeoutMs-t))):void this.inactiveTimer.restart(this.inactiveTimeoutMs-t);this._state=oi}clearTimers(){this.inactiveTimer.clear(),this.tombstoneTimer.clear(),this.sweepTimer.clear()}stopTracking(){this.clearTimers(),this._state=ri}}class bs{static create(e){return new bs(e)}get shouldRunGC(){return this.configs.shouldRunGC}get tombstoneEnforcementAllowed(){return this.configs.sweepEnabled}get throwOnTombstoneLoad(){return this.configs.throwOnTombstoneLoad}get throwOnTombstoneUsage(){return this.configs.throwOnTombstoneUsage}get summaryStateNeedsReset(){return this.summaryStateTracker.doesSummaryStateNeedReset}get updatedDSCountSinceLastSummary(){return this.summaryStateTracker.updatedDSCountSinceLastSummary}constructor(e){this.newReferencesSinceLastRun=new Map,this.tombstones=[],this.deletedNodes=new Set,this.unreferencedNodesState=new vs,this.completedRuns=0,this.runtime=e.runtime,this.isSummarizerClient=e.isSummarizerClient,this.getNodePackagePath=e.getNodePackagePath,this.getLastSummaryTimestampMs=e.getLastSummaryTimestampMs,this.submitMessage=e.submitMessage;const t=e.baseSnapshot,n=e.readAndParseBlob;if(this.mc=(0,Yt.CL)({logger:e.baseLogger,namespace:"GarbageCollector",properties:{all:{completedGCRuns:()=>this.completedRuns}}}),this.configs=function(e,t){var n,r,i,s,o,c,u,h;let d,f,p,m,g;if(t.existing){var v,y;const e=t.metadata;g=function(e){var t;return e&&null!==(t=e.gcFeature)&&void 0!==t?t:0}(e),d=g>0,f=null===e||void 0===e?void 0:e.sessionExpiryTimeoutMs;const n=null===e||void 0===e?void 0:e.sweepTimeoutMs;p=null!==(v=null!==(y=null===e||void 0===e?void 0:e.tombstoneTimeoutMs)&&void 0!==y?y:n)&&void 0!==v?v:ds(f),m=null===e||void 0===e?void 0:e.gcFeatureMatrix}else{const n=e.config.getNumber("Fluid.GarbageCollection.TestOverride.TombstoneTimeoutMs");var b;d=!1!==t.gcOptions.gcAllowed,d&&!1!==e.config.getBoolean("Fluid.GarbageCollection.RunSessionExpiry")&&(f=null!==(b=t.gcOptions.sessionExpiryTimeoutMs)&&void 0!==b?b:Xr),p=null!==n&&void 0!==n?n:ds(f);const r=t.gcOptions[Ur];void 0!==r&&(m={gcGeneration:r})}const S=function(e,t){var n;return void 0===t||t===(null!==(n=e.tombstoneGeneration)&&void 0!==n?n:e.gcGeneration)}(null!==(n=m)&&void 0!==n?n:{},t.gcOptions[Ur]),w=!0===e.config.getBoolean("Fluid.GarbageCollection.GCVersionUpgradeToV4")?4:3,C=void 0===g||w>=g,x=null!==(r=e.config.getBoolean("Fluid.GarbageCollection.RunGC"))&&void 0!==r?r:d&&!t.gcOptions.disableGC&&C,E=!(!x||void 0===p)&&(null!==(i=e.config.getBoolean(Hr))&&void 0!==i?i:S&&!0===t.gcOptions.enableGCSweep),T=!0===e.config.getBoolean("Fluid.GarbageCollection.DisableDataStoreSweep")||!0===t.gcOptions.disableDataStoreSweep,k=E?T?"ONLY_BLOBS":"YES":"NO",N=null!==(s=null!==(o=e.config.getNumber("Fluid.GarbageCollection.TestOverride.InactiveTimeoutMs"))&&void 0!==o?o:t.gcOptions.inactiveTimeoutMs)&&void 0!==s?s:Qr;if(void 0!==p&&N>p)throw new l("inactive timeout should not be greater than the tombstone timeout");const F=null!==(c=e.config.getBoolean("Fluid.GarbageCollection.GCTestMode"))&&void 0!==c?c:!0===t.gcOptions.runGCInTestMode,I=!0!==e.config.getBoolean(Vr),A=t.gcOptions.runFullGC,D=null!==(u=t.gcOptions.sweepGracePeriodMs)&&void 0!==u?u:Yr;return a(D>=0,"sweepGracePeriodMs must be non-negative",{sweepGracePeriodMs:D}),{gcEnabled:d,sweepEnabled:S,shouldRunGC:x,shouldRunSweep:k,runFullGC:A,testMode:F,tombstoneMode:I,sessionExpiryTimeoutMs:f,tombstoneTimeoutMs:p,sweepGracePeriodMs:D,inactiveTimeoutMs:N,persistedGcFeatureMatrix:m,gcVersionInBaseSnapshot:g,gcVersionInEffect:w,throwOnInactiveLoad:t.gcOptions.throwOnInactiveLoad,throwOnTombstoneLoad:(null!==(h=e.config.getBoolean(Kr))&&void 0!==h?h:!0!==t.gcOptions.gcDisableThrowOnTombstoneLoad)&&S&&!t.isSummarizerClient,throwOnTombstoneUsage:!0===e.config.getBoolean(Gr)&&S&&!t.isSummarizerClient}}(this.mc,e),void 0!==this.configs.sessionExpiryTimeoutMs){const e=this.mc.config.getNumber("Fluid.GarbageCollection.TestOverride.SessionExpiryMs"),t=null!==e&&void 0!==e?e:this.configs.sessionExpiryTimeoutMs;this.sessionExpiryTimer=new _i(t,(()=>{this.runtime.closeFn(new hs("Client session expired.",t))})),this.sessionExpiryTimer.start()}this.summaryStateTracker=new ms(this.configs,void 0!==(null===t||void 0===t?void 0:t.trees[nn.aT])),this.telemetryTracker=new ai(this.mc,this.configs,this.isSummarizerClient,e.createContainerMetadata,(e=>this.runtime.getNodeType(e)),(e=>this.unreferencedNodesState.get(e)),this.getNodePackagePath),this.baseSnapshotDataP=new an.I((async()=>{if(void 0!==t)try{const e=t.trees[nn.aT];if(void 0===e)return;const r=await async function(e,t){let n,r,s={gcNodes:{}};for(const o of Object.keys(e.blobs)){if(o===nn.kc){r=await t(e.blobs[o]);continue}if(o===nn.Yz){n=await t(e.blobs[o]);continue}if(!o.startsWith(nn.YV))continue;const a=e.blobs[o];if(void 0===a)continue;const c=await t(a);(0,i.v)(void 0!==c,1496),s=Ei(s,c)}return{gcState:s,tombstones:n,deletedNodes:r}}(e,n);return this.configs.gcVersionInEffect!==this.configs.gcVersionInBaseSnapshot?{gcState:void 0,tombstones:void 0,deletedNodes:r.deletedNodes}:r}catch(e){const t=h.wrapIfUnrecognized(e,"FailedToInitializeGC");throw t.addTelemetryProperties({gcConfigs:JSON.stringify(this.configs)}),t}})),this.initializeGCStateFromBaseSnapshotP=new an.I((async()=>{const e=this.runtime.getCurrentReferenceTimestampMs();(0,i.v)(void 0!==e,2212);const t=await this.baseSnapshotDataP;if(this.summaryStateTracker.initializeBaseState(t),void 0===(null===t||void 0===t?void 0:t.gcState))return;const n={};for(const[r,i]of Object.entries(t.gcState.gcNodes))void 0!==i.unreferencedTimestampMs&&this.unreferencedNodesState.set(r,new ys(i.unreferencedTimestampMs,this.configs.inactiveTimeoutMs,e,this.configs.tombstoneTimeoutMs,this.configs.sweepGracePeriodMs)),n[r]=Array.from(i.outboundRoutes);this.gcDataFromLastRun={gcNodes:n}})),this.baseGCDetailsP=new an.I((async()=>{const e=await this.baseSnapshotDataP;if(void 0===(null===e||void 0===e?void 0:e.gcState))return{};const t={};for(const[n,r]of Object.entries(e.gcState.gcNodes))t[n]=Array.from(r.outboundRoutes);return{gcData:{gcNodes:t},usedRoutes:fs(t,["/"]).referencedNodeIds}})),this.mc.logger.sendTelemetryEvent({eventName:"GarbageCollectorLoaded",gcConfigs:JSON.stringify(this.configs),gcOptions:JSON.stringify(e.gcOptions),...e.createContainerMetadata})}async initializeBaseState(){const e=await this.baseSnapshotDataP;void 0!==e&&(void 0!==e.deletedNodes&&(this.deletedNodes=new Set(e.deletedNodes)),this.configs.tombstoneMode&&void 0!==e.tombstones&&(this.tombstones=Array.from(e.tombstones),this.runtime.updateTombstonedRoutes(this.tombstones)),await this.initializeOrUpdateGCState())}async initializeOrUpdateGCState(){const e=this.runtime.getCurrentReferenceTimestampMs();if(void 0!==e)if(void 0!==this.gcDataFromLastRun)for(const[,t]of this.unreferencedNodesState)t.updateTracking(e);else await this.initializeGCStateFromBaseSnapshotP}setConnectionState(e,t){e&&this.configs.shouldRunGC&&this.initializeOrUpdateGCState().catch((e=>{this.mc.logger.sendErrorEvent({eventName:"GCInitializationOrUpdateFailed",gcConfigs:JSON.stringify(this.configs),clientId:t},e)}))}async getBaseGCDetails(){return this.baseGCDetailsP}async collectGarbage(e,t){var n;const r=null!==(n=e.fullGC)&&void 0!==n?n:!0===this.configs.runFullGC||this.summaryStateTracker.autoRecovery.fullGCRequested()||this.summaryStateTracker.doesSummaryStateNeedReset;null===t||void 0===t||t.setMultiple("fluid_GC","Options",{fullGC:r,runSweep:e.runSweep});const i=e.logger?(0,Xt.pW)({logger:e.logger,properties:{all:{completedGCRuns:()=>this.completedRuns}}}):this.mc.logger,s=this.runtime.getCurrentReferenceTimestampMs();if(void 0!==s)return Xt.Bt.timedExecAsync(i,{eventName:"GarbageCollection"},(async e=>{await this.initializeGCStateFromBaseSnapshotP,await this.runtime.updateStateBeforeGC();const t=await this.runGC(r,s,i);return e.end({...t,details:{timestamp:s,sweep:this.configs.shouldRunSweep,tombstone:this.configs.throwOnTombstoneLoad}}),await this.telemetryTracker.logPendingEvents(i),this.summaryStateTracker.updateStateFromGCRunStats(t),this.newReferencesSinceLastRun.clear(),this.completedRuns++,t}),{end:!0,cancel:"error"});i.sendErrorEvent({eventName:"CollectGarbageCalledWithoutTimestamp",gcConfigs:JSON.stringify(this.configs)})}async runGC(e,t,n){var r;const i=await this.runtime.getGCData(e),s=fs(i.gcNodes,["/"]),o=null!==(r=this.findAllNodesReferencedBetweenGCs(i,this.gcDataFromLastRun,n))&&void 0!==r?r:s.referencedNodeIds,a=this.getMarkPhaseStats(s),{tombstoneReadyNodeIds:c,sweepReadyNodeIds:l}=this.runMarkPhase(s,o,t);this.runSweepPhase(s,c,l),this.gcDataFromLastRun=Ti(i);const u=this.getSweepPhaseStats(this.deletedNodes,l,a);return{...a,...u}}runMarkPhase(e,t,n){for(const s of t)this.unreferencedNodesState.delete(s);const r=new Set,i=new Set;for(const s of e.deletedNodeIds){const e=this.unreferencedNodesState.get(s);void 0===e?this.unreferencedNodesState.set(s,new ys(n,this.configs.inactiveTimeoutMs,n,this.configs.tombstoneTimeoutMs,this.configs.sweepGracePeriodMs)):(e.updateTracking(n),e.state===si&&r.add(s),e.state===oi&&i.add(s))}return this.runtime.updateUsedRoutes(e.referencedNodeIds),{tombstoneReadyNodeIds:r,sweepReadyNodeIds:i}}runSweepPhase(e,t,n){if(this.configs.testMode)return void this.runtime.updateUnusedRoutes(e.deletedNodeIds);const{nodesToTombstone:r,nodesToDelete:i}={nodesToTombstone:[...t],nodesToDelete:[]};switch(this.configs.shouldRunSweep){case"YES":i.push(...n);break;case"ONLY_BLOBS":n.forEach((e=>{this.runtime.getNodeType(e)===ei.Blob?i.push(e):r.push(e)}));break;default:r.push(...n)}if(this.configs.tombstoneMode&&(this.tombstones=r,this.runtime.updateTombstonedRoutes(this.tombstones)),i.length>0){const e=i.filter((e=>{const t=this.runtime.getNodeType(e);return t===ei.DataStore||t===ei.Blob})),t={type:ti,deletedNodeIds:e},n={type:us.GC,contents:t,compatDetails:{behavior:"Ignore"}};this.submitMessage(n)}else;}findAllNodesReferencedBetweenGCs(e,t,n){if(void 0===t)return;if(this.telemetryTracker.logIfMissingExplicitReferences(e,t,this.newReferencesSinceLastRun,n),0===this.newReferencesSinceLastRun.size)return;const r=function(e,t){const n=Ti(e);for(const[r,i]of Object.entries(t.gcNodes))if(void 0===n.gcNodes[r])n.gcNodes[r]=Array.from(i);else{const e=[...i,...n.gcNodes[r]];n.gcNodes[r]=[...new Set(e)]}return n}(t,e),i=[];this.newReferencesSinceLastRun.forEach(((e,t)=>{void 0===r.gcNodes[t]?r.gcNodes[t]=e:r.gcNodes[t].push(...e),i.push(...e)}));return fs(r.gcNodes,["/",...i]).referencedNodeIds}summarize(e,t,n){if(!this.configs.shouldRunGC||void 0===this.gcDataFromLastRun)return;const r={gcNodes:{}};for(const[s,o]of Object.entries(this.gcDataFromLastRun.gcNodes)){var i;r.gcNodes[s]={outboundRoutes:o,unreferencedTimestampMs:null===(i=this.unreferencedNodesState.get(s))||void 0===i?void 0:i.unreferencedTimestampMs}}return this.summaryStateTracker.summarize(e,t,r,this.deletedNodes,this.tombstones)}getMetadata(){return{gcFeature:this.configs.gcEnabled?this.configs.gcVersionInEffect:0,gcFeatureMatrix:this.configs.persistedGcFeatureMatrix,sessionExpiryTimeoutMs:this.configs.sessionExpiryTimeoutMs,sweepEnabled:!1,tombstoneTimeoutMs:this.configs.tombstoneTimeoutMs}}async refreshLatestSummary(e){return this.summaryStateTracker.refreshLatestSummary(e)}processMessage(e,t){const n=e.contents.type;switch(n){case ti:this.deleteSweepReadyNodes(e.contents.deletedNodeIds);break;case ni:{if(!0===this.mc.config.getBoolean(Jr))break;const t=e.contents.nodePath;this.addedOutboundReference("/",t,!0),this.summaryStateTracker.autoRecovery.requestFullGCOnNextRun();break}default:var r;if("Ignore"!==(null===(r=e.compatDetails)||void 0===r?void 0:r.behavior)){throw h.create("Garbage collection message of unknown type ".concat(n),"processMessage")}}}deleteSweepReadyNodes(e){const t=new Set(e),n=Array.from(e);for(const[i]of this.unreferencedNodesState){const e=i.split("/");if(e.length<=2)continue;const r="/".concat(e[1]);t.has(r)&&n.push(i)}const r=this.runtime.deleteSweepReadyNodes(n);for(const i of r)this.unreferencedNodesState.delete(i),this.deletedNodes.add(i)}nodeUpdated(e,t,n,r,i,s){var o;if(!this.configs.shouldRunGC)return;const a=this.tombstones.includes(e);this.telemetryTracker.nodeUsed({id:e,usageType:t,currentReferenceTimestampMs:null!==n&&void 0!==n?n:this.runtime.getCurrentReferenceTimestampMs(),packagePath:r,completedGCRuns:this.completedRuns,isTombstoned:a,lastSummaryTime:this.getLastSummaryTimestampMs(),headers:s}),a&&"Loaded"===t&&this.triggerAutoRecovery(e);const c=this.runtime.getNodeType(e);if("Loaded"!==t||![ei.Blob,ei.DataStore].includes(c))return;const l=null!==i&&void 0!==i?i:{url:e};if(a&&this.throwOnTombstoneLoad&&!0!==(null===s||void 0===s?void 0:s.allowTombstone))throw bn(wn(404,"".concat(c," was tombstoned"),l,{[Qs]:!0}));if("Inactive"===(null===(o=this.unreferencedNodesState.get(e))||void 0===o?void 0:o.state)){if(!this.isSummarizerClient&&!0===this.configs.throwOnInactiveLoad&&!0!==(null===s||void 0===s?void 0:s.allowInactive))throw bn(wn(404,"".concat(c," is inactive"),l,{[Xs]:!0}))}}triggerAutoRecovery(e){if(!0===this.mc.config.getBoolean(Jr))return;const t={type:us.GC,contents:{type:ni,nodePath:e},compatDetails:{behavior:"Ignore"}};this.submitMessage(t)}addedOutboundReference(e,t,n){var r,s;if(!this.configs.shouldRunGC)return;if(!t.startsWith("/"))return void this.mc.logger.sendErrorEvent({eventName:"InvalidRelativeOutboundRoute",...(0,Xt.Df)({fromId:e,id:t})});(0,i.v)(e.startsWith("/"),2213);const o=null!==(r=this.newReferencesSinceLastRun.get(e))&&void 0!==r?r:[];o.push(t),this.newReferencesSinceLastRun.set(e,o),this.telemetryTracker.nodeUsed({id:t,usageType:"Revived",currentReferenceTimestampMs:this.runtime.getCurrentReferenceTimestampMs(),packagePath:void 0,completedGCRuns:this.completedRuns,isTombstoned:this.tombstones.includes(t),lastSummaryTime:this.getLastSummaryTimestampMs(),fromId:e,autorecovery:n}),null===(s=this.unreferencedNodesState.get(t))||void 0===s||s.stopTracking()}isNodeDeleted(e){return this.deletedNodes.has(e)}dispose(){var e;null===(e=this.sessionExpiryTimer)||void 0===e||e.clear(),this.sessionExpiryTimer=void 0}getMarkPhaseStats(e){const t={nodeCount:0,dataStoreCount:0,attachmentBlobCount:0,unrefNodeCount:0,unrefDataStoreCount:0,unrefAttachmentBlobCount:0,updatedNodeCount:0,updatedDataStoreCount:0,updatedAttachmentBlobCount:0},n=(e,n)=>{t.nodeCount++;const r=this.unreferencedNodesState.has(e),i=void 0===this.gcDataFromLastRun||r===n;i&&t.updatedNodeCount++,n||t.unrefNodeCount++,this.runtime.getNodeType(e)===ei.DataStore&&(t.dataStoreCount++,i&&t.updatedDataStoreCount++,n||t.unrefDataStoreCount++),this.runtime.getNodeType(e)===ei.Blob&&(t.attachmentBlobCount++,i&&t.updatedAttachmentBlobCount++,n||t.unrefAttachmentBlobCount++)};for(const r of e.referencedNodeIds)n(r,!0);for(const r of e.deletedNodeIds)n(r,!1);return t}getSweepPhaseStats(e,t,n){const r={lifetimeNodeCount:n.nodeCount,lifetimeDataStoreCount:n.dataStoreCount,lifetimeAttachmentBlobCount:n.attachmentBlobCount,deletedNodeCount:0,deletedDataStoreCount:0,deletedAttachmentBlobCount:0},i=e=>{const t=e.split("/");return t[1]===cr.basePath?ei.Blob:2===t.length?ei.DataStore:3===t.length?ei.SubDataStore:ei.Other};for(const s of e){r.deletedNodeCount++;const e=i(s);e===ei.DataStore?r.deletedDataStoreCount++:e===ei.Blob&&r.deletedAttachmentBlobCount++}r.lifetimeNodeCount+=r.deletedNodeCount,r.lifetimeDataStoreCount+=r.deletedDataStoreCount,r.lifetimeAttachmentBlobCount+=r.deletedAttachmentBlobCount;for(const s of t){r.deletedNodeCount++;const e=this.runtime.getNodeType(s);e===ei.DataStore?r.deletedDataStoreCount++:e===ei.Blob&&r.deletedAttachmentBlobCount++}return r}}class Ss{constructor(e,t,n,r){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:()=>en.F.now();this.batchEventEmitter=e,this.trackedBatchCount=0,this.logger=(0,Xt.pW)({logger:t,namespace:"Batching"}),this.batchEventEmitter.on("batchBegin",(e=>{this.startBatchSequenceNumber=e.sequenceNumber,this.batchProcessingStartTimeStamp=s(),this.trackedBatchCount++})),this.batchEventEmitter.on("batchEnd",((e,t)=>{(0,i.v)(void 0!==this.startBatchSequenceNumber&&void 0!==this.batchProcessingStartTimeStamp,698);const o=t.sequenceNumber-this.startBatchSequenceNumber+1;o>=n&&this.logger.sendPerformanceEvent({eventName:"LengthTooBig",length:o,threshold:n,batchEndSequenceNumber:t.sequenceNumber,duration:s()-this.batchProcessingStartTimeStamp,batchError:void 0!==e}),this.trackedBatchCount%r===0&&this.logger.sendPerformanceEvent({eventName:"Length",length:o,samplingRate:r,batchEndSequenceNumber:t.sequenceNumber,duration:s()-this.batchProcessingStartTimeStamp}),this.startBatchSequenceNumber=void 0,this.batchProcessingStartTimeStamp=void 0}))}}function ws(e){return e.type===pn.Operation}var Cs;!function(e){e.Accept="accept"}(Cs||(Cs={}));class xs{constructor(e,t){this.logger=t,this.processingTimeIncrement=10,this.currentAllowedProcessingTimeForTurn=xs.processingTime,this.schedulingCount=0,this.deltaManager=e,this.deltaManager.inbound.on("idle",(()=>{this.inboundQueueIdle()}))}batchBegin(e){this.processingStartTime||(this.processingStartTime=en.F.now()),void 0===this.schedulingLog&&this.schedulingCount%500===0&&(this.schedulingLog={opsRemainingToProcess:0,numberOfTurns:1,totalProcessingTime:0,numberOfBatchesProcessed:0,firstSequenceNumber:e.sequenceNumber,lastSequenceNumber:e.sequenceNumber,startTime:en.F.now()})}batchEnd(e){if(this.schedulingLog&&(this.schedulingLog.numberOfBatchesProcessed++,this.schedulingLog.lastSequenceNumber=e.sequenceNumber,this.schedulingLog.opsRemainingToProcess=this.deltaManager.inbound.length),this.shouldRunScheduler()){const e=en.F.now(),t=e-this.processingStartTime;t>this.currentAllowedProcessingTimeForTurn&&(this.deltaManager.inbound.pause(),this.currentAllowedProcessingTimeForTurn+=this.processingTimeIncrement,this.schedulingLog&&(this.schedulingLog.numberOfTurns++,this.schedulingLog.totalProcessingTime+=t),setTimeout((()=>{this.schedulingLog&&this.logger.sendTelemetryEvent({eventName:"InboundOpsPartialProcessingTime",duration:(0,Xt.T0)(t),opsProcessed:this.schedulingLog.lastSequenceNumber-this.schedulingLog.firstSequenceNumber+1,opsRemainingToProcess:this.deltaManager.inbound.length,processingTime:(0,Xt.T0)(this.schedulingLog.totalProcessingTime),numberOfTurns:this.schedulingLog.numberOfTurns,batchesProcessed:this.schedulingLog.numberOfBatchesProcessed,timeToResume:(0,Xt.T0)(en.F.now()-e)}),this.deltaManager.inbound.resume()})),this.processingStartTime=void 0)}}inboundQueueIdle(){if(this.schedulingLog){const e=en.F.now();this.schedulingLog.totalProcessingTime+=e-this.processingStartTime,this.logger.sendTelemetryEvent({eventName:"InboundOpsProcessingTime",opsRemainingToProcess:this.schedulingLog.opsRemainingToProcess,numberOfTurns:this.schedulingLog.numberOfTurns,processingTime:(0,Xt.T0)(this.schedulingLog.totalProcessingTime),opsProcessed:this.schedulingLog.lastSequenceNumber-this.schedulingLog.firstSequenceNumber+1,batchesProcessed:this.schedulingLog.numberOfBatchesProcessed,duration:(0,Xt.T0)(e-this.schedulingLog.startTime),schedulingCount:this.schedulingCount}),this.schedulingLog=void 0}this.schedulingCount++,this.processingStartTime=void 0,this.currentAllowedProcessingTimeForTurn=xs.processingTime}shouldRunScheduler(){return this.deltaManager.inbound.length>0}}xs.processingTime=50;class Es{constructor(e,t,n,r){this.deltaManager=e,this.emitter=t,this.getClientId=n,this.logger=r,this.hitError=!1,this.deltaScheduler=new xs(this.deltaManager,(0,Xt.pW)({logger:this.logger,namespace:"DeltaScheduler"})),new Ts(e,n,r)}beforeOpProcessing(e){if(this.batchClientId!==e.clientId){var t;(0,i.v)(void 0===this.batchClientId,674),this.emitter.emit("batchBegin",e),this.deltaScheduler.batchBegin(e);const n=null===e||void 0===e||null===(t=e.metadata)||void 0===t?void 0:t.batch;this.batchClientId=n?e.clientId:void 0}}afterOpProcessing(e,t){var n;if((0,i.v)(!this.hitError,675),e)return this.hitError=!0,this.batchClientId=void 0,this.emitter.emit("batchEnd",e,t),void this.deltaScheduler.batchEnd(t);const r=null===t||void 0===t||null===(n=t.metadata)||void 0===n?void 0:n.batch;return void 0===this.batchClientId||!1===r?(this.batchClientId=void 0,this.emitter.emit("batchEnd",void 0,t),void this.deltaScheduler.batchEnd(t)):void 0}}class Ts{constructor(e,t,n){this.deltaManager=e,this.getClientId=t,this.logger=n,this.localPaused=!1,this.timePaused=0,this.batchCount=0,this.deltaManager.on("prepareSend",(e=>{if(0===e.length)return;const t=e[0].metadata;if(null===t||void 0===t||!t.batch)return;if(1===e.length)return void delete t.batch;const n=e[e.length-1];n.metadata={...n.metadata,batch:!1}})),this.deltaManager.inbound.on("push",(e=>{this.trackPending(e)})),(0,i.v)(!this.localPaused,659);const r=this.deltaManager.inbound.toArray();for(const i of r)this.trackPending(i);this.deltaManager.on("op",(e=>this.afterOpProcessing(e)))}afterOpProcessing(e){if((0,i.v)(!this.localPaused,660),0!==this.deltaManager.inbound.length){if(void 0!==this.pauseSequenceNumber){var t;if(e.sequenceNumber>=this.pauseSequenceNumber)throw h.create("Incomplete batch","ScheduleManager",e,{type:e.type,contentType:typeof e.contents,batch:null===(t=e.metadata)||void 0===t?void 0:t.batch,compression:e.compression,pauseSeqNum:this.pauseSequenceNumber});e.sequenceNumber+1===this.pauseSequenceNumber&&this.pauseQueue()}}else(0,i.v)(void 0===this.pauseSequenceNumber,661)}pauseQueue(){(0,i.v)(!this.localPaused,663),this.localPaused=!0,this.timePaused=en.F.now(),this.deltaManager.inbound.pause()}resumeQueue(e,t){const n=t.sequenceNumber,r=this.localPaused?en.F.now()-this.timePaused:void 0;this.batchCount++,this.batchCount%1e3===1&&this.logger.sendTelemetryEvent({eventName:"BatchStats",sequenceNumber:n,length:n-e+1,msnDistance:n-t.minimumSequenceNumber,duration:r,batchCount:this.batchCount,interrupted:this.localPaused}),this.localPaused&&(this.localPaused=!1,this.deltaManager.inbound.resume())}trackPending(e){(0,i.v)(0!==this.deltaManager.inbound.length,664),(0,i.v)(void 0===this.currentBatchClientId===(void 0===this.pauseSequenceNumber),665);const t=e.metadata,n=null===t||void 0===t?void 0:t.batch;if(!ws(e)){if(void 0!==this.currentBatchClientId)throw h.create("Received a system message during batch processing","trackPending",e,{runtimeVersion:Mn,batchClientId:null===this.currentBatchClientId?"null":this.currentBatchClientId,pauseSequenceNumber:this.pauseSequenceNumber,localBatch:this.currentBatchClientId===this.getClientId(),messageType:e.type});return(0,i.v)(void 0===n,667),void(0,i.v)(!this.localPaused,668)}if(void 0!==this.currentBatchClientId||void 0!==n){if(void 0!==this.currentBatchClientId&&this.currentBatchClientId!==e.clientId)throw new u("OpBatchIncomplete",{runtimeVersion:Mn,batchClientId:null===this.currentBatchClientId?"null":this.currentBatchClientId,pauseSequenceNumber:this.pauseSequenceNumber,localBatch:this.currentBatchClientId===this.getClientId(),localMessage:e.clientId===this.getClientId(),...d(e)});n?((0,i.v)(void 0===this.currentBatchClientId,670),(0,i.v)(!this.localPaused,671),this.pauseSequenceNumber=e.sequenceNumber,this.currentBatchClientId=e.clientId,1===this.deltaManager.inbound.length&&this.pauseQueue()):!1===n?((0,i.v)(void 0!==this.pauseSequenceNumber,672),this.resumeQueue(this.pauseSequenceNumber,e),this.pauseSequenceNumber=void 0,this.currentBatchClientId=void 0):(0,i.v)(void 0!==this.currentBatchClientId,673)}else(0,i.v)(!this.localPaused,669)}}class ks{constructor(e,t){this.config=e,this.logger=(0,Xt.pW)({logger:t,namespace:"OpGroupingManager"})}groupBatch(e){if(!this.shouldGroup(e))return e;e.content.length>=1e3&&this.logger.sendTelemetryEvent({eventName:"GroupLargeBatch",length:e.content.length,threshold:this.config.opCountThreshold,reentrant:e.hasReentrantOps,referenceSequenceNumber:e.content[0].referenceSequenceNumber});for(const n of e.content)if(n.metadata){const e=Object.keys(n.metadata);(0,i.v)(e.length<2,1501),(0,i.v)(0===e.length||"batch"===e[0],1502)}const t=JSON.stringify({type:ks.groupedBatchOp,contents:e.content.map((e=>({contents:void 0===e.contents?void 0:JSON.parse(e.contents),metadata:e.metadata,compression:e.compression})))});return{...e,content:[{localOpMetadata:void 0,metadata:void 0,referenceSequenceNumber:e.content[0].referenceSequenceNumber,contents:t,type:ks.groupedBatchOp}]}}ungroupOp(e){let t=1;if((null===(n=e.contents)||void 0===n?void 0:n.type)!==ks.groupedBatchOp)return this.config.groupedBatchingEnabled?[{...e,clientSequenceNumber:t}]:[e];var n;return e.contents.contents.map((n=>({...e,clientSequenceNumber:t++,contents:n.contents,metadata:n.metadata,compression:n.compression})))}shouldGroup(e){return this.config.groupedBatchingEnabled&&e.content.length>=this.config.opCountThreshold&&(this.config.reentrantBatchGroupingEnabled||!0!==e.hasReentrantOps)}}ks.groupedBatchOp="groupedBatch";class Ns{get length(){return this.pendingBatch.length}get contentSizeInBytes(){return this.batchContentSize}get sequenceNumbers(){return{referenceSequenceNumber:this.referenceSequenceNumber,clientSequenceNumber:this.clientSequenceNumber}}get referenceSequenceNumber(){return 0===this.pendingBatch.length?void 0:this.pendingBatch[this.pendingBatch.length-1].referenceSequenceNumber}constructor(e){this.options=e,this.pendingBatch=[],this.batchContentSize=0,this.hasReentrantOps=!1}push(e,t,n){var r,i;const s=this.batchContentSize+(null!==(r=null===(i=e.contents)||void 0===i?void 0:i.length)&&void 0!==r?r:0),o=this.pendingBatch.length;this.hasReentrantOps=this.hasReentrantOps||t;const a=s+200*o;return!(void 0!==this.options.softLimit&&this.length>0&&a>=this.options.softLimit)&&(!(a>=this.options.hardLimit)&&(0===this.pendingBatch.length&&(this.clientSequenceNumber=n),this.batchContentSize=s,this.pendingBatch.push(e),!0))}get empty(){return 0===this.pendingBatch.length}popBatch(){const e={content:this.pendingBatch,contentSizeInBytes:this.batchContentSize,referenceSequenceNumber:this.referenceSequenceNumber,hasReentrantOps:this.hasReentrantOps};return this.pendingBatch=[],this.batchContentSize=0,this.clientSequenceNumber=void 0,this.hasReentrantOps=!1,Fs(e)}checkpoint(){const e=this.pendingBatch.length;return{rollback:t=>{for(let i=this.pendingBatch.length;i>e;){var n,r;i--;const e=this.pendingBatch[i];this.batchContentSize-=null!==(n=null===(r=e.contents)||void 0===r?void 0:r.length)&&void 0!==n?n:0,t(e)}this.pendingBatch.length=e}}}}const Fs=e=>(e.content.length>1&&(e.content[0].metadata={...e.content[0].metadata,batch:!0},e.content[e.content.length-1].metadata={...e.content[e.content.length-1].metadata,batch:!1}),e),Is=e=>e.contentSizeInBytes+200*e.content.length,As=(e,t)=>(void 0===e.referenceSequenceNumber||void 0===t.referenceSequenceNumber||e.referenceSequenceNumber===t.referenceSequenceNumber)&&(void 0===e.clientSequenceNumber||void 0===t.clientSequenceNumber||e.clientSequenceNumber===t.clientSequenceNumber);class Ds{constructor(e,t,n,r,i){this.submitBatchFn=t,this.chunkSizeInBytes=n,this.maxBatchSizeInBytes=r,this.chunkMap=new Map(e),this.logger=(0,Xt.pW)({logger:i,namespace:"OpSplitter"})}get isBatchChunkingEnabled(){return this.chunkSizeInBytes<Number.POSITIVE_INFINITY&&void 0!==this.submitBatchFn}get chunks(){return this.chunkMap}processRemoteMessage(e){if(e.type!==us.ChunkedOp)return{message:e,state:"Skipped"};const t=e.clientId,n=e.contents;if(this.addChunk(t,n,e),n.chunkId<n.totalChunks)return{message:e,state:"Accepted"};const r=this.chunkMap.get(t).join("");this.clearPartialChunks(t);const i={...e};return i.contents=""===r?void 0:JSON.parse(r),i.type=n.originalType,i.metadata=n.originalMetadata,i.compression=n.originalCompression,{message:i,state:"Processed"}}clearPartialChunks(e){this.chunkMap.has(e)&&this.chunkMap.delete(e)}addChunk(e,t,n){let r=this.chunkMap.get(e);if(void 0===r&&(r=[],this.chunkMap.set(e,r)),t.chunkId!==r.length+1)throw new u("Chunk Id mismatch",{...d(n),chunkMapLength:r.length,chunkId:t.chunkId,totalChunks:t.totalChunks});r.push(t.contents)}splitFirstBatchMessage(e){var t,n,r,s,o;(0,i.v)(this.isBatchChunkingEnabled,1299),(0,i.v)(e.contentSizeInBytes>0&&e.content.length>0,1300),(0,i.v)(void 0!==e.referenceSequenceNumber,1418),(0,i.v)(0!==this.chunkSizeInBytes,1301),(0,i.v)(this.chunkSizeInBytes<this.maxBatchSizeInBytes,1302);const a=e.content[0];(0,i.v)((null!==(t=null===(n=a.contents)||void 0===n?void 0:n.length)&&void 0!==t?t:0)>=this.chunkSizeInBytes,1304);const c=e.content.slice(1),l=Is(e),u=Ps(a,this.chunkSizeInBytes,l>=this.maxBatchSizeInBytes);(0,i.v)(void 0!==this.submitBatchFn,1305);for(const i of u.slice(0,-1))this.submitBatchFn([Os(i,e.referenceSequenceNumber)],e.referenceSequenceNumber);const h=Os(u[u.length-1],e.referenceSequenceNumber,{batch:null===(r=a.metadata)||void 0===r?void 0:r.batch});return this.logger.sendPerformanceEvent({eventName:"CompressedChunkedBatch",length:e.content.length,sizeInBytes:e.contentSizeInBytes,chunks:u.length,chunkSizeInBytes:this.chunkSizeInBytes,socketSize:l}),{content:[h,...c],contentSizeInBytes:null!==(s=null===(o=h.contents)||void 0===o?void 0:o.length)&&void 0!==s?s:0,referenceSequenceNumber:e.referenceSequenceNumber}}}const Os=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;const r={type:us.ChunkedOp,contents:e};return{contents:JSON.stringify(r),type:r.type,metadata:n,localOpMetadata:void 0,referenceSequenceNumber:t}},Ps=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const r=[];(0,i.v)(void 0!==e.contents&&null!==e.contents,1306);const s=e.contents.length,o=Math.floor((s-1)/t)+1+(n?1:0);let a=0;for(let c=1;c<=o;c++){const n={chunkId:c,contents:e.contents.substr(a,t),originalType:e.type,totalChunks:o};c===o&&(n.originalMetadata=e.metadata,n.originalCompression=e.compression),r.push(n),a+=t,(0,i.v)(c>=o-1||a<=s,1419)}return(0,i.v)(a>=s,1420),(0,i.v)(r.length===o,1445),r};class Rs{constructor(e,t,n){this.opSplitter=e,this.opDecompressor=t,this.opGroupingManager=n}get partialMessages(){return this.opSplitter.chunks}clearPartialMessagesFor(e){this.opSplitter.clearPartialChunks(e)}process(e){const t=[];var n;"string"===typeof(n=e).contents&&""!==n.contents&&(n.contents=JSON.parse(n.contents));for(const r of this.opGroupingManager.ungroupOp(e)){const e=this.opDecompressor.processMessage(r).message;for(let n of this.opGroupingManager.ungroupOp(e)){Bs(n);const e=this.opSplitter.processRemoteMessage(n);if(n=e.message,"Processed"===e.state)for(const r of this.opGroupingManager.ungroupOp(n)){const e=this.opDecompressor.processMessage(r);for(const n of this.opGroupingManager.ungroupOp(e.message))"Skipped"!==e.state?(Ms(n),t.push(n)):t.push(n)}else t.push(n)}}return t}}function Ms(e){const t=e.contents,n=e;n.type=t.type,n.contents=t.contents,"compatDetails"in t&&(n.compatDetails=t.compatDetails)}function Bs(e){return e.type===pn.Operation&&(void 0!==e.contents.address&&void 0===e.contents.type?e.type=us.FluidDataStoreOp:Ms(e),!0)}var Ls=n(5531);class qs{constructor(e){this.activeBatch=!1,this.processedCount=0,this.logger=(0,Xt.pW)({logger:e,namespace:"OpDecompressor"})}processMessage(e){var t,n,r,s;if((0,i.v)(void 0===e.compression||e.compression===eo.lz4,1297),!0===(null===(t=e.metadata)||void 0===t?void 0:t.batch)&&this.isCompressed(e)){(0,i.v)(!1===this.activeBatch,1208),this.activeBatch=!0;const t=Ne.Ss.from(e.contents.packedContents,"base64"),n=(0,Ls.decompress)(t),r=(0,Ne.Km)(n),s=JSON.parse(r);return this.rootMessageContents=s,{message:_s(e,this.rootMessageContents[this.processedCount++]),state:"Accepted"}}if(void 0!==this.rootMessageContents&&void 0===(null===(n=e.metadata)||void 0===n?void 0:n.batch)&&this.activeBatch)return(0,i.v)(void 0===e.contents,1298),{message:_s(e,this.rootMessageContents[this.processedCount++]),state:"Accepted"};if(void 0!==this.rootMessageContents&&!1===(null===(r=e.metadata)||void 0===r?void 0:r.batch)){const t=_s(e,this.rootMessageContents[this.processedCount++]);return this.activeBatch=!1,this.rootMessageContents=void 0,this.processedCount=0,{message:t,state:"Processed"}}if(void 0===(null===(s=e.metadata)||void 0===s?void 0:s.batch)&&this.isCompressed(e)){(0,i.v)(!1===this.activeBatch,1210);const t=Ne.Ss.from(e.contents.packedContents,"base64"),n=(0,Ls.decompress)(t),r=(new TextDecoder).decode(n),s=JSON.parse(r);return{message:_s(e,s[0]),state:"Processed"}}return{message:e,state:"Skipped"}}isCompressed(e){if(e.compression===eo.lz4)return!0;try{var t;if(null!==e.contents&&"object"===typeof e.contents&&1===Object.keys(e.contents).length&&"string"===typeof e.contents.packedContents&&e.contents.packedContents.length>0&&Ne.Ss.from(e.contents.packedContents,"base64").toString("base64")===e.contents.packedContents)return this.logger.sendTelemetryEvent({eventName:"LegacyCompression",type:e.type,batch:null===(t=e.metadata)||void 0===t?void 0:t.batch}),!0}catch(n){return!1}return!1}}const _s=(e,t)=>({...e,contents:t,compression:void 0,metadata:{...e.metadata}});function js(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50;const r=Error;if(!0!==(null===(t=Object.getOwnPropertyDescriptor(r,"stackTraceLimit")||Object.getOwnPropertyDescriptor(Object.getPrototypeOf(r),"stackTraceLimit"))||void 0===t?void 0:t.writable))return e();const i=r.stackTraceLimit;try{return r.stackTraceLimit=n,e()}finally{r.stackTraceLimit=i}}class zs{constructor(e){this.params=e,this.defaultAttachFlowSoftLimitInBytes=327680,this.batchRebasesToReport=5,this.rebasing=!1,this.maxMismatchedOpsToReport=3,this.mismatchedOpsReported=0,this.mc=(0,Yt.CL)({logger:e.logger,namespace:"Outbox"});const t=this.params.config.compressionOptions.minimumBatchSizeInBytes!==Number.POSITIVE_INFINITY,n=t?1/0:this.params.config.maxBatchSizeInBytes,r=t?1/0:this.defaultAttachFlowSoftLimitInBytes;this.attachFlowBatch=new Ns({hardLimit:n,softLimit:r}),this.mainBatch=new Ns({hardLimit:n}),this.blobAttachBatch=new Ns({hardLimit:n}),this.idAllocationBatch=new Ns({hardLimit:n})}get messageCount(){return this.attachFlowBatch.length+this.mainBatch.length+this.blobAttachBatch.length}get isEmpty(){return 0===this.messageCount}maybeFlushPartialBatch(){const e=this.mainBatch.sequenceNumbers,t=this.attachFlowBatch.sequenceNumbers,n=this.blobAttachBatch.sequenceNumbers;(0,i.v)(this.params.config.disablePartialFlush||As(e,t)&&As(e,n),1421);const r=this.params.getCurrentSequenceNumbers();As(e,r)&&As(t,r)&&As(n,r)||(++this.mismatchedOpsReported<=this.maxMismatchedOpsToReport&&this.mc.logger.sendTelemetryEvent({category:this.params.config.disablePartialFlush?"error":"generic",eventName:"ReferenceSequenceNumberMismatch",mainReferenceSequenceNumber:e.referenceSequenceNumber,mainClientSequenceNumber:e.clientSequenceNumber,attachReferenceSequenceNumber:t.referenceSequenceNumber,attachClientSequenceNumber:t.clientSequenceNumber,blobAttachReferenceSequenceNumber:n.referenceSequenceNumber,blobAttachClientSequenceNumber:n.clientSequenceNumber,currentReferenceSequenceNumber:r.referenceSequenceNumber,currentClientSequenceNumber:r.clientSequenceNumber},js((()=>new l("Submission of an out of order message")))),this.params.config.disablePartialFlush||this.flushAll())}submit(e){this.maybeFlushPartialBatch(),this.addMessageToBatchManager(this.mainBatch,e)}submitAttach(e){this.maybeFlushPartialBatch(),this.attachFlowBatch.push(e,this.isContextReentrant(),this.params.getCurrentSequenceNumbers().clientSequenceNumber)||(this.flushInternal(this.attachFlowBatch),this.addMessageToBatchManager(this.attachFlowBatch,e)),this.attachFlowBatch.contentSizeInBytes>=this.params.config.compressionOptions.minimumBatchSizeInBytes&&this.flushInternal(this.attachFlowBatch)}submitBlobAttach(e){this.maybeFlushPartialBatch(),this.addMessageToBatchManager(this.blobAttachBatch,e),this.blobAttachBatch.contentSizeInBytes>=this.params.config.compressionOptions.minimumBatchSizeInBytes&&this.flushInternal(this.blobAttachBatch)}submitIdAllocation(e){this.maybeFlushPartialBatch(),this.idAllocationBatch.push(e,this.isContextReentrant(),this.params.getCurrentSequenceNumbers().clientSequenceNumber)||(this.flushInternal(this.idAllocationBatch),this.addMessageToBatchManager(this.idAllocationBatch,e)),this.idAllocationBatch.contentSizeInBytes>=this.params.config.compressionOptions.minimumBatchSizeInBytes&&this.flushInternal(this.idAllocationBatch)}addMessageToBatchManager(e,t){var n,r;if(!e.push(t,this.isContextReentrant(),this.params.getCurrentSequenceNumbers().clientSequenceNumber))throw new c("BatchTooLarge",void 0,{opSize:null!==(n=null===(r=t.contents)||void 0===r?void 0:r.length)&&void 0!==n?n:0,batchSize:e.contentSizeInBytes,count:e.length,limit:e.options.hardLimit})}flush(){if(this.isContextReentrant()){const e=new l("Flushing is not supported inside DDS event handlers");throw this.params.closeContainer(e),e}this.flushAll()}flushAll(){this.flushInternal(this.idAllocationBatch),this.flushInternal(this.attachFlowBatch),this.flushInternal(this.blobAttachBatch,!0),this.flushInternal(this.mainBatch)}flushInternal(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(e.empty)return;const n=e.popBatch();if(!0===n.hasReentrantOps&&this.params.groupingManager.shouldGroup(n))return(0,i.v)(!this.rebasing,1786),void this.rebase(n,e);const r=this.compressBatch(n,t);this.sendBatch(r),this.persistBatch(n.content)}rebase(e,t){(0,i.v)(!this.rebasing,1787),this.rebasing=!0;for(const n of e.content)this.params.reSubmit({content:n.contents,localOpMetadata:n.localOpMetadata,opMetadata:n.metadata});this.batchRebasesToReport>0&&(this.mc.logger.sendTelemetryEvent({eventName:"BatchRebase",length:e.content.length,referenceSequenceNumber:e.referenceSequenceNumber},new l("BatchRebase")),this.batchRebasesToReport--),this.flushInternal(t),this.rebasing=!1}isContextReentrant(){return this.params.opReentrancy()&&!this.rebasing}compressBatch(e,t){if(0===e.content.length||void 0===this.params.config.compressionOptions||this.params.config.compressionOptions.minimumBatchSizeInBytes>e.contentSizeInBytes||void 0===this.params.submitBatchFn)return t?e:this.params.groupingManager.groupBatch(e);const n=this.params.compressor.compressBatch(t?e:this.params.groupingManager.groupBatch(e));if(this.params.splitter.isBatchChunkingEnabled)return n.contentSizeInBytes<=this.params.splitter.chunkSizeInBytes?n:this.params.splitter.splitFirstBatchMessage(n);if(n.contentSizeInBytes>=this.params.config.maxBatchSizeInBytes)throw new c("BatchTooLarge",void 0,{batchSize:e.contentSizeInBytes,compressedBatchSize:n.contentSizeInBytes,count:n.content.length,limit:this.params.config.maxBatchSizeInBytes,chunkingEnabled:this.params.splitter.isBatchChunkingEnabled,compressionOptions:JSON.stringify(this.params.config.compressionOptions),socketSize:Is(e)});return n}sendBatch(e){if(0===e.content.length||!this.params.shouldSend())return;const t=Is(e);t>=this.params.config.maxBatchSizeInBytes&&this.mc.logger.sendPerformanceEvent({eventName:"LargeBatch",length:e.content.length,sizeInBytes:e.contentSizeInBytes,socketSize:t}),void 0===this.params.submitBatchFn?((0,i.v)(void 0===e.content[0].compression,1446),this.params.legacySendBatchFn(e)):((0,i.v)(void 0!==e.referenceSequenceNumber,1422),this.params.submitBatchFn(e.content.map((e=>({contents:e.contents,metadata:e.metadata,compression:e.compression,referenceSequenceNumber:e.referenceSequenceNumber}))),e.referenceSequenceNumber))}persistBatch(e){for(const t of e)this.params.pendingStateManager.onSubmitMessage(t.contents,t.referenceSequenceNumber,t.localOpMetadata,t.metadata)}checkpoint(){return{mainBatch:this.mainBatch.checkpoint(),attachFlowBatch:this.attachFlowBatch.checkpoint(),blobAttachBatch:this.blobAttachBatch.checkpoint()}}}class Us{constructor(e){this.logger=(0,Xt.pW)({logger:e,namespace:"OpCompressor"})}compressBatch(e){(0,i.v)(e.contentSizeInBytes>0&&e.content.length>0,1444);const t=Date.now(),n=(new TextEncoder).encode(this.serializeBatch(e)),r=(0,Ls.compress)(n),s=Ne.Ss.from(r).toString("base64"),o=Date.now()-t,a=[];a.push({...e.content[0],contents:JSON.stringify({packedContents:s}),metadata:e.content[0].metadata,compression:eo.lz4});for(const i of e.content.slice(1))a.push({type:i.type,localOpMetadata:i.localOpMetadata,metadata:i.metadata,referenceSequenceNumber:i.referenceSequenceNumber});const c={contentSizeInBytes:s.length,content:a,referenceSequenceNumber:e.referenceSequenceNumber};return e.contentSizeInBytes>2e5&&this.logger.sendPerformanceEvent({eventName:"CompressedBatch",duration:o,sizeBeforeCompression:e.contentSizeInBytes,sizeAfterCompression:c.contentSizeInBytes,opCount:c.content.length,socketSize:Is(c)}),c}serializeBatch(e){try{return"[".concat(e.content.map((e=>e.contents)).join(","),"]")}catch(t){if("Invalid string length"===t.message){const t=new l("Payload too large");throw this.logger.sendErrorEvent({eventName:"BatchTooLarge",size:e.contentSizeInBytes,length:e.content.length},t),t}throw t}}}class Hs extends Zt{static isEmitterEvent(e){return e===Hs.newListenerEvent||e===Hs.removeListenerEvent}get disposed(){return this.isDisposed}constructor(e){if(super(),this.isDisposed=!1,this.forwardingEvents=new Map,void 0!==e){const t=t=>this.unforwardEvent(e,t),n=t=>this.forwardEvent(e,t);this.on(Hs.removeListenerEvent,t),this.on(Hs.newListenerEvent,n)}}dispose(){this.isDisposed=!0;for(const e of this.forwardingEvents.values())for(const t of e.values())try{t()}catch{}this.removeAllListeners(),this.forwardingEvents.clear()}forwardEvent(e){for(var t=this,n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];for(const s of r)if(void 0!==e&&void 0!==s&&!Hs.isEmitterEvent(s)){let n=this.forwardingEvents.get(s);if(void 0===n&&(n=new Map,this.forwardingEvents.set(s,n)),!n.has(e)){const r=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return t.emit(s,...n)};n.set(e,(()=>e.off(s,r))),e.on(s,r)}}}unforwardEvent(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];for(const i of n)if(void 0!==i&&!Hs.isEmitterEvent(i)){const t=this.forwardingEvents.get(i);if(!0===(null===t||void 0===t?void 0:t.has(e))&&0===this.listenerCount(i)){const n=t.get(e);void 0!==n&&n(),t.delete(e),0===t.size&&this.forwardingEvents.delete(i)}}}}Hs.newListenerEvent="newListener",Hs.removeListenerEvent="removeListener";class Vs extends Hs{get IDeltaSender(){return this}get inbound(){return this.deltaManager.inbound}get outbound(){return this.deltaManager.outbound}get inboundSignal(){return this.deltaManager.inboundSignal}get minimumSequenceNumber(){return this.deltaManager.minimumSequenceNumber}get lastSequenceNumber(){return this.deltaManager.lastSequenceNumber}get lastMessage(){return this.deltaManager.lastMessage}get lastKnownSeqNumber(){return this.deltaManager.lastKnownSeqNumber}get initialSequenceNumber(){return this.deltaManager.initialSequenceNumber}get hasCheckpointSequenceNumber(){return this.deltaManager.hasCheckpointSequenceNumber}get clientDetails(){return this.deltaManager.clientDetails}get version(){return this.deltaManager.version}get maxMessageSize(){return this.deltaManager.maxMessageSize}get serviceConfiguration(){return this.deltaManager.serviceConfiguration}get active(){return this.deltaManager.active}get readOnlyInfo(){return this.deltaManager.readOnlyInfo}constructor(e){super(e),this.deltaManager=e}dispose(){super.dispose()}submitSignal(e,t){return this.deltaManager.submitSignal(e,t)}flush(){return this.deltaManager.flush()}}class Ks extends Vs{get active(){return!this.isSummarizerClient&&this.deltaManager.active}get readOnlyInfo(){return this.isSummarizerClient?{readonly:!0,forced:!1,permissions:void 0,storageOnly:!1}:this.deltaManager.readOnlyInfo}constructor(e){super(e),super.setMaxListeners(0),this.isSummarizerClient=this.deltaManager.clientDetails.type===jr}}function Gs(e,t){return"Ignore"===t}const Ws={state:"enabled",minIdleTime:0,maxIdleTime:3e4,maxTime:6e4,maxOps:100,minOpsForLastSummaryAttempt:10,maxAckWaitTime:18e4,maxOpsSinceLastSummary:7e3,initialSummarizerDelayMs:5e3,nonRuntimeOpWeight:.1,runtimeOpWeight:1,nonRuntimeHeuristicThreshold:20};var Js;!function(e){e.wait="wait",e.viaHandle="viaHandle"}(Js||(Js={}));const Zs="allowTombstone",$s="allowInactive",Qs="isTombstoned",Xs="isInactive",Ys={wait:!0,viaHandle:!1,allowTombstone:!1,allowInactive:!1};var eo;!function(e){e.lz4="lz4"}(eo||(eo={}));const to=nn.WD.TurnBased,no=716800,ro={minimumBatchSizeInBytes:614400,compressionAlgorithm:eo.lz4},io=204800;var so;!function(e){e.FluidDataStoreOp="component",e.Attach="attach",e.ChunkedOp="chunkedOp",e.BlobAttach="blobAttach",e.Rejoin="rejoin",e.Alias="alias",e.Operation="op"}(so||(so={}));const oo="_scheduler";function ao(){try{if("object"===typeof navigator&&null!==navigator)return{deviceMemory:navigator.deviceMemory,hardwareConcurrency:navigator.hardwareConcurrency}}catch{}return{}}const co="_summarizer";class lo extends Zt{static async loadRuntime(e){var t,r,s,o,a;const{context:c,registryEntries:l,existing:h,requestHandler:d,provideEntryPoint:f,runtimeOptions:p={},containerScope:m={},containerRuntimeCtor:g=lo}=e,v=c,y=null!==(t=v.taggedLogger)&&void 0!==t?t:new Xt.gn(v.logger),b=(0,Xt.pW)({logger:y,properties:{all:{runtimeVersion:Mn}}}),{summaryOptions:S={},gcOptions:w={},loadSequenceNumberVerification:C="close",flushMode:x=to,compressionOptions:E=ro,maxBatchSizeInBytes:T=no,enableRuntimeIdCompressor:k=!1,chunkSizeInBytes:N=io,enableOpReentryCheck:F=!1,enableGroupedBatching:I=!1}=p,A=new Dn(l),D=async e=>{var t;const n=null===(t=c.baseSnapshot)||void 0===t?void 0:t.blobs[e];if(c.baseSnapshot&&n)return(0,i.v)(void 0!==c.storage,501),vn(c.storage,n)},[O,P,R,M,B]=await Promise.all([D(Pr),D(Or),D(Rr),D(Dr),D(Br)]),L=await cr.load(null===(r=c.baseSnapshot)||void 0===r?void 0:r.trees[Mr],(async e=>((0,i.v)(void 0!==c.storage,598),vn(c.storage,e)))),q=null===P||void 0===P||null===(s=P.message)||void 0===s?void 0:s.sequenceNumber;if(!c.pendingLocalState&&void 0!==q){const e=c.deltaManager.initialSequenceNumber;if("bypass"!==C&&q!==e){const t=new u("Summary metadata mismatch",{runtimeVersion:Mn,runtimeSequenceNumber:q,protocolSequenceNumber:e});"log"===C?b.sendErrorEvent({eventName:"SequenceNumberMismatch"},t):c.closeFn(t)}}let _;if(null!==(o=null!==(a=null===P||void 0===P?void 0:P.idCompressorEnabled)&&void 0!==a?a:p.enableRuntimeIdCompressor)&&void 0!==o&&o){const{createIdCompressor:e,deserializeIdCompressor:t,createSessionId:r}=await Promise.resolve().then(n.bind(n,5484)),i=c.pendingLocalState;_=void 0!==(null===i||void 0===i?void 0:i.pendingIdCompressorState)?t(i.pendingIdCompressorState):void 0!==B?t(B,r()):e(b)}const j=new g(c,A,P,R,null!==O&&void 0!==O?O:[],null!==M&&void 0!==M?M:[],{summaryOptions:S,gcOptions:w,loadSequenceNumberVerification:C,flushMode:x,compressionOptions:E,maxBatchSizeInBytes:T,chunkSizeInBytes:N,enableRuntimeIdCompressor:k,enableOpReentryCheck:F,enableGroupedBatching:I},m,b,h,L,c.storage,_,f,d,void 0);return await j.pendingStateManager.applyStashedOpsAt(null!==q&&void 0!==q?q:0),await j.initializeBaseState(),j}get clientId(){return this._getClientId()}get storage(){return this._storage}get flushMode(){return this._flushMode}get scope(){return this.containerScope}get IFluidDataStoreRegistry(){return this.registry}get attachState(){return this._getAttachState()}get IFluidHandleContext(){return this.handleContext}ensureNoDataModelChanges(e){this.ensureNoDataModelChangesCalls++;try{return e()}finally{this.ensureNoDataModelChangesCalls--}}get connected(){return this._connected}get summarizerClientId(){var e;return null===(e=this.summarizerClientElection)||void 0===e?void 0:e.electedClientId}get disposed(){return this._disposed}get summarizer(){return(0,i.v)(void 0!==this._summarizer,599),this._summarizer}isSummariesDisabled(){return"disabled"===this.summaryConfiguration.state}isHeuristicsDisabled(){return"disableHeuristics"===this.summaryConfiguration.state}getMaxOpsSinceLastSummary(){return"disabled"!==this.summaryConfiguration.state?this.summaryConfiguration.maxOpsSinceLastSummary:0}getInitialSummarizerDelayMs(){return void 0!==this.runtimeOptions.summaryOptions.initialSummarizerDelayMs?this.runtimeOptions.summaryOptions.initialSummarizerDelayMs:"disabled"!==this.summaryConfiguration.state?this.summaryConfiguration.initialSummarizerDelayMs:0}get gcTombstoneEnforcementAllowed(){return this.garbageCollector.tombstoneEnforcementAllowed}get gcThrowOnTombstoneUsage(){return this.garbageCollector.throwOnTombstoneUsage}constructor(e,t,n,r,s,o,a,c,u,h,d,f,p,m,g){var v,y,b,S,w,C,x,E;let T=arguments.length>15&&void 0!==arguments[15]?arguments[15]:{...Ws,...null===(v=a.summaryOptions)||void 0===v?void 0:v.summaryConfigOverrides};super(),this.registry=t,this.runtimeOptions=a,this.containerScope=c,this.logger=u,this._storage=f,this.requestHandler=g,this.summaryConfiguration=T,this.imminentClosure=!1,this.defaultMaxConsecutiveReconnects=7,this._orderSequentiallyCalls=0,this.flushTaskExists=!1,this.consecutiveReconnects=0,this.ensureNoDataModelChangesCalls=0,this.opReentryCallsToReport=5,this._disposed=!1,this.emitDirtyDocumentEvent=!0,this.defaultTelemetrySignalSampleCount=100,this._perfSignalData={signalsLost:0,signalSequenceNumber:0,signalTimestamp:0,trackingSignalSequenceNumber:void 0};const{options:k,clientDetails:N,connected:F,baseSnapshot:I,submitFn:A,submitBatchFn:D,submitSummaryFn:O,submitSignalFn:P,disposeFn:R,closeFn:M,deltaManager:B,quorum:L,audience:q,loader:_,pendingLocalState:j,supportedFeatures:z}=e;let U;var H,V,K;(this.innerDeltaManager=B,this.deltaManager=new Ks(this.innerDeltaManager),this.submitFn=A,this.submitBatchFn=D,this.submitSummaryFn=O,this.submitSignalFn=P,this.options=k,this.clientDetails=N,this.isSummarizerClient=this.clientDetails.type===jr,this.loadedFromVersionId=null===(y=e.getLoadedFromVersion())||void 0===y?void 0:y.id,this._getClientId=()=>e.clientId,this._getAttachState=()=>e.attachState,this.getAbsoluteUrl=async t=>{if(void 0===e.getAbsoluteUrl)throw new Error("Driver does not implement getAbsoluteUrl");if(this.attachState===Qt.Attached)return e.getAbsoluteUrl(t)},this.on("dirty",(()=>e.updateDirtyContainerState(!0))),this.on("saved",(()=>e.updateDirtyContainerState(!1))),this.disposeFn=null!==R&&void 0!==R?R:M,this.closeFn=this.isSummarizerClient?this.disposeFn:M,this.mc=(0,Yt.CL)({logger:this.logger,namespace:"ContainerRuntime"}),h)?(this.createContainerMetadata={createContainerRuntimeVersion:null===n||void 0===n?void 0:n.createContainerRuntimeVersion,createContainerTimestamp:null===n||void 0===n?void 0:n.createContainerTimestamp},U=null!==(H=null===n||void 0===n?void 0:n.summaryNumber)&&void 0!==H?H:0,this.idCompressorEnabled=null!==(V=null===n||void 0===n?void 0:n.idCompressorEnabled)&&void 0!==V&&V):(this.createContainerMetadata={createContainerRuntimeVersion:Mn,createContainerTimestamp:Date.now()},U=0,this.idCompressorEnabled=null!==(K=this.mc.config.getBoolean("Fluid.ContainerRuntime.IdCompressorEnabled"))&&void 0!==K?K:void 0!==p);this.nextSummaryNumber=U+1,this.messageAtLastSummary=null===n||void 0===n?void 0:n.message,this._connected=F,this.mc.logger.sendTelemetryEvent({eventName:"GCFeatureMatrix",metadataValue:JSON.stringify(null===n||void 0===n?void 0:n.gcFeatureMatrix),inputs:JSON.stringify({gcOptions_gcGeneration:this.runtimeOptions.gcOptions[Ur]})}),this.telemetryDocumentId=null!==(b=null===n||void 0===n?void 0:n.telemetryDocumentId)&&void 0!==b?b:In(),this.disableAttachReorder=this.mc.config.getBoolean("Fluid.ContainerRuntime.disableAttachOpReorder");const G=this.mc.config.getBoolean("Fluid.ContainerRuntime.CompressionChunkingDisabled"),W=new ks({groupedBatchingEnabled:this.groupedBatchingEnabled,opCountThreshold:null!==(S=this.mc.config.getNumber("Fluid.ContainerRuntime.GroupedBatchingOpCount"))&&void 0!==S?S:2,reentrantBatchGroupingEnabled:null===(w=this.mc.config.getBoolean("Fluid.ContainerRuntime.GroupedBatchingReentrancy"))||void 0===w||w},this.mc.logger),J=new Ds(s,this.submitBatchFn,!0===G?Number.POSITIVE_INFINITY:a.chunkSizeInBytes,a.maxBatchSizeInBytes,this.mc.logger);this.remoteMessageProcessor=new Rs(J,new qs(this.mc.logger),W),this.handleContext=new An("",this),"enabled"===this.summaryConfiguration.state&&this.validateSummaryHeuristicConfiguration(this.summaryConfiguration);const Z=this.mc.config.getBoolean("Fluid.ContainerRuntime.DisableOpReentryCheck");this.enableOpReentryCheck=!0===a.enableOpReentryCheck&&!0!==Z,this.summariesDisabled=this.isSummariesDisabled(),this.heuristicsDisabled=this.isHeuristicsDisabled(),this.maxOpsSinceLastSummary=this.getMaxOpsSinceLastSummary(),this.initialSummarizerDelayMs=this.getInitialSummarizerDelayMs(),this.idCompressorEnabled&&(this.idCompressor=p),this.maxConsecutiveReconnects=null!==(C=this.mc.config.getNumber("Fluid.ContainerRuntime.MaxConsecutiveReconnects"))&&void 0!==C?C:this.defaultMaxConsecutiveReconnects,a.flushMode===nn.qS.Async&&!0!==(null===z||void 0===z?void 0:z.get("referenceSequenceNumbers"))?(this.mc.logger.sendErrorEvent({eventName:"FlushModeFallback"}),this._flushMode=nn.WD.TurnBased):this._flushMode=a.flushMode;const $=j,Q=null===(x=this._storage)||void 0===x||null===(x=x.policies)||void 0===x?void 0:x.maximumCacheDurationMs;if(void 0!==Q&&Q>432e6)throw new l("Driver's maximumCacheDurationMs policy cannot exceed 5 days");this.garbageCollector=bs.create({runtime:this,gcOptions:this.runtimeOptions.gcOptions,baseSnapshot:I,baseLogger:this.mc.logger,existing:h,metadata:n,createContainerMetadata:this.createContainerMetadata,isSummarizerClient:this.isSummarizerClient,getNodePackagePath:async e=>this.getGCNodePackagePath(e),getLastSummaryTimestampMs:()=>{var e;return null===(e=this.messageAtLastSummary)||void 0===e?void 0:e.timestamp},readAndParseBlob:async e=>vn(this.storage,e),submitMessage:e=>this.submit(e)});const X=this.deltaManager.initialSequenceNumber;this.summarizerNode=function(e,t,n,r){let i=arguments.length>5?arguments[5]:void 0,s=arguments.length>6?arguments[6]:void 0;return new Ai(e,t,arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},n,void 0===r?void 0:Ni.createForRoot(r),void 0,void 0,i,s,"")}((0,Xt.pW)({logger:this.logger,namespace:"SummarizerNode"}),(async(e,t,n)=>this.summarizeInternal(e,t,n)),X,void 0!==I?X:void 0,{canReuseHandle:!1,throwOnFailure:!0,gcDisabled:!this.garbageCollector.shouldRunGC},(async e=>this.getGCDataInternal(e)),(async()=>this.garbageCollector.getBaseGCDetails())),I&&this.summarizerNode.updateBaseSummaryState(I),this.dataStores=new Ci(function(e,t){if(e){if(function(e){return!!e&&!e.disableIsolatedChannels}(t)){const t=e.trees[nn._1];return(0,i.v)(!!t,360),t}{const t={};for(const[n,r]of Object.entries(e.trees))Lr.includes(n)||(t[n]=r);return{...e,trees:t}}}}(I,n),this,(e=>this.submit({type:us.Attach,contents:e})),((e,t)=>(n,r)=>this.summarizerNode.createChild(n,e,t,void 0,r)),(e=>this.summarizerNode.deleteChild(e)),this.mc.logger,((e,t,n)=>this.garbageCollector.nodeUpdated(e,"Changed",t,n)),(e=>this.garbageCollector.isNodeDeleted(e)),new Map(o)),this.blobManager=new cr(this.handleContext,d,(()=>this.storage),((e,t)=>{this.disposed||this.submit({type:us.BlobAttach,contents:void 0},void 0,{localId:e,blobId:t})}),(e=>this.garbageCollector.nodeUpdated(e,"Loaded")),(e=>this.garbageCollector.isNodeDeleted(e)),this,null===$||void 0===$?void 0:$.pendingAttachmentBlobs,(e=>this.closeFn(e))),this.scheduleManager=new Es(this.innerDeltaManager,this,(()=>this.clientId),(0,Xt.pW)({logger:this.logger,namespace:"ScheduleManager"})),this.pendingStateManager=new Bn({applyStashedOp:this.applyStashedOp.bind(this),clientId:()=>this.clientId,close:this.closeFn,connected:()=>this.connected,reSubmit:this.reSubmit.bind(this),reSubmitBatch:this.reSubmitBatch.bind(this),isActiveConnection:()=>this.innerDeltaManager.active},null===$||void 0===$?void 0:$.pending,this.logger);const Y=this.mc.config.getBoolean("Fluid.ContainerRuntime.CompressionDisabled"),ee=!0===Y?{minimumBatchSizeInBytes:Number.POSITIVE_INFINITY,compressionAlgorithm:eo.lz4}:a.compressionOptions,te=this.mc.config.getBoolean("Fluid.ContainerRuntime.DisablePartialFlush"),ne=((e,t)=>n=>{for(const t of n.content)e(pn.Operation,void 0===t.contents?void 0:JSON.parse(t.contents),!0,t.metadata);t.flush()})(this.submitFn,this.innerDeltaManager);this.outbox=new zs({shouldSend:()=>this.canSendOps(),pendingStateManager:this.pendingStateManager,submitBatchFn:this.submitBatchFn,legacySendBatchFn:ne,compressor:new Us(this.mc.logger),splitter:J,config:{compressionOptions:ee,maxBatchSizeInBytes:a.maxBatchSizeInBytes,disablePartialFlush:!0===te},logger:this.mc.logger,groupingManager:W,getCurrentSequenceNumbers:()=>({referenceSequenceNumber:this.deltaManager.lastSequenceNumber,clientSequenceNumber:this._processedClientSequenceNumber}),reSubmit:this.reSubmit.bind(this),opReentrancy:()=>this.ensureNoDataModelChangesCalls>0,closeContainer:this.closeFn}),this._quorum=L,this._quorum.on("removeMember",(e=>{this.remoteMessageProcessor.clearPartialMessagesFor(e)})),this._audience=q;const re=this.mc.config.getNumber("Fluid.ContainerRuntime.Test.CloseSummarizerDelayOverrideMs");if(this.closeSummarizerDelayMs=null!==re&&void 0!==re?re:5e3,this.validateSummaryBeforeUpload=null!==(E=this.mc.config.getBoolean("Fluid.Summarizer.ValidateSummaryBeforeUpload"))&&void 0!==E&&E,this.summaryCollection=new Ri(this.deltaManager,this.logger),this.dirtyContainer=this.attachState!==Qt.Attached||this.hasPendingMessages(),e.updateDirtyContainerState(this.dirtyContainer),this.summariesDisabled)this.mc.logger.sendTelemetryEvent({eventName:"SummariesDisabled"});else{const e=(0,Xt.pW)({logger:this.logger,namespace:"OrderedClientElection"}),t=new Mi(e,this.innerDeltaManager,this._quorum),n=new Bi(e,t,null!==r&&void 0!==r?r:this.innerDeltaManager.lastSequenceNumber,zr.isClientEligible);if(this.summarizerClientElection=new zr(e,this.summaryCollection,n,this.maxOpsSinceLastSummary),this.isSummarizerClient)this._summarizer=new es(this,(()=>this.summaryConfiguration),this,this.handleContext,this.summaryCollection,(async e=>ts.create(e,(()=>this.innerDeltaManager.active))));else if(zr.clientDetailsPermitElection(this.clientDetails)){const e=()=>{this.summaryCollection.opsSinceLastAck>this.maxOpsSinceLastSummary&&(this.mc.logger.sendTelemetryEvent({eventName:"SummaryStatus:Behind"}),this.summaryCollection.once(pn.SummaryAck,(()=>{this.mc.logger.sendTelemetryEvent({eventName:"SummaryStatus:CaughtUp"}),this.summaryCollection.on("default",e)})),this.summaryCollection.off("default",e))};this.summaryCollection.on("default",e),this.summaryManager=new ss(this.summarizerClientElection,this,this.summaryCollection,this.logger,this.formCreateSummarizerFn(_),new os(6e4,3e4,as({coefficient:20,initialDelay:0})),{initialDelayMs:this.initialSummarizerDelayMs},this.heuristicsDisabled),this.summaryManager.on("summarize",(e=>{this.emit("summarize",e)})),this.summaryManager.start()}}u.sendTelemetryEvent({eventName:"DeviceSpec",...ao()}),this.mc.logger.sendTelemetryEvent({eventName:"ContainerLoadStats",...this.createContainerMetadata,...this.dataStores.containerLoadStats,summaryNumber:U,summaryFormatVersion:null===n||void 0===n?void 0:n.summaryFormatVersion,disableIsolatedChannels:null===n||void 0===n?void 0:n.disableIsolatedChannels,gcVersion:null===n||void 0===n?void 0:n.gcFeature,options:JSON.stringify(a),featureGates:JSON.stringify({disableCompression:Y,disableOpReentryCheck:Z,disableChunking:G,disableAttachReorder:this.disableAttachReorder,disablePartialFlush:te,idCompressorEnabled:this.idCompressorEnabled,closeSummarizerDelayOverride:re}),telemetryDocumentId:this.telemetryDocumentId,groupedBatchingEnabled:this.groupedBatchingEnabled}),function(e,t,n){new Pn(e,t,n)}(this.clientId,this.deltaManager,this.logger),function(e,t){new Ss(e,t,arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3,arguments.length>3&&void 0!==arguments[3]?arguments[3]:1e3)}(this,this.logger),this.entryPoint=new an.I((async()=>this.isSummarizerClient?((0,i.v)(void 0!==this._summarizer,1471),this._summarizer):m(this)))}async initializeBaseState(){await this.garbageCollector.initializeBaseState()}dispose(e){var t;this._disposed||(this._disposed=!0,this.mc.logger.sendTelemetryEvent({eventName:"ContainerRuntimeDisposed",isDirty:this.isDirty,lastSequenceNumber:this.deltaManager.lastSequenceNumber,attachState:this.attachState},e),void 0!==this.summaryManager&&this.summaryManager.dispose(),this.garbageCollector.dispose(),null===(t=this._summarizer)||void 0===t||t.dispose(),this.dataStores.dispose(),this.pendingStateManager.dispose(),this.emit("dispose"),this.removeAllListeners())}async request(e){try{const t=Cn.create(e);return t.pathParts[0]===co&&1===t.pathParts.length?void 0!==this._summarizer?{status:200,mimeType:"fluid/object",value:this.summarizer}:Sn(e):void 0!==this.requestHandler?this.requestHandler(t,this):Sn(e)}catch(t){return yn(t)}}async resolveHandle(e){try{const t=Cn.create(e),n=t.pathParts[0];if("_channels"===n)return this.resolveHandle(t.createSubRequest(1));if(n===cr.basePath&&t.isLeaf(2)){const n=await this.blobManager.getBlob(t.pathParts[1]);return n?{status:200,mimeType:"fluid/object",value:n}:Sn(e)}if(t.pathParts.length>0){const r=!t.isLeaf(1),s=await this.getDataStoreFromRequest(n,e,r),o=t.createSubRequest(1);return(0,i.v)(o.url.startsWith("/"),294),s.request(o)}return Sn(e)}catch(t){return yn(t)}}async getEntryPoint(){return this.entryPoint}internalId(e){var t;return null!==(t=this.dataStores.aliases.get(e))&&void 0!==t?t:e}async getDataStoreFromRequest(e,t,n){var r,i,s,o;const a={};"boolean"===typeof(null===(r=t.headers)||void 0===r?void 0:r[Js.wait])&&(a.wait=t.headers[Js.wait]),"boolean"===typeof(null===(i=t.headers)||void 0===i?void 0:i[Js.viaHandle])&&(a.viaHandle=t.headers[Js.viaHandle]),"boolean"===typeof(null===(s=t.headers)||void 0===s?void 0:s[Zs])&&(a.allowTombstone=t.headers[Zs]),"boolean"===typeof(null===(o=t.headers)||void 0===o?void 0:o[$s])&&(a.allowInactive=t.headers[$s]),n&&(a.allowTombstone=!0),await this.dataStores.waitIfPendingAlias(e);const c=this.internalId(e),l=await this.dataStores.getDataStore(c,a),u=t.url.split("?")[0].replace(/^\/+|\/+$/g,"");const h=await l.getInitialSnapshotDetails();return this.garbageCollector.nodeUpdated("/".concat(u),"Loaded",void 0,h.pkg,t,a),l.realize()}addMetadataToSummary(e){var t;const n={...this.createContainerMetadata,summaryNumber:this.nextSummaryNumber++,summaryFormatVersion:1,...this.garbageCollector.getMetadata(),message:null!==(r=this.deltaManager.lastMessage,t=void 0===r?void 0:{clientId:r.clientId,clientSequenceNumber:r.clientSequenceNumber,minimumSequenceNumber:r.minimumSequenceNumber,referenceSequenceNumber:r.referenceSequenceNumber,sequenceNumber:r.sequenceNumber,timestamp:r.timestamp,type:r.type})&&void 0!==t?t:this.messageAtLastSummary,telemetryDocumentId:this.telemetryDocumentId,idCompressorEnabled:!!this.idCompressorEnabled||void 0};var r;Ot(e,Or,JSON.stringify(n))}addContainerStateToSummary(e,t,n,r){if(this.addMetadataToSummary(e),this.idCompressorEnabled){(0,i.v)(void 0!==this.idCompressor,1658);const t=JSON.stringify(this.idCompressor.serialize(!1));Ot(e,Br,t)}if(this.remoteMessageProcessor.partialMessages.size>0){const t=JSON.stringify([...this.remoteMessageProcessor.partialMessages]);Ot(e,Pr,t)}const s=this.dataStores.aliases;if(s.size>0&&Ot(e,Dr,JSON.stringify([...s])),this.summarizerClientElection){var o;const t=JSON.stringify(null===(o=this.summarizerClientElection)||void 0===o?void 0:o.serialize());Ot(e,Rr,t)}const a=this.blobManager.summarize();var c,l,u;Object.keys(a.summary.tree).length>0&&(l=Mr,u=a,(c=e).summary.tree[l]=u.summary,c.stats=Ft(c.stats,u.stats));const h=this.garbageCollector.summarize(t,n,r);void 0!==h&&function(e,t,n){e.summary.tree[t]=n.summary,e.stats=Ft(e.stats,n.stats)}(e,nn.aT,h)}shouldContinueReconnecting(){return this.maxConsecutiveReconnects<=0||(this.hasPendingMessages()?(this.consecutiveReconnects===Math.floor(this.maxConsecutiveReconnects/2)&&this.mc.logger.sendTelemetryEvent({eventName:"ReconnectsWithNoProgress",attempts:this.consecutiveReconnects,pendingMessages:this.pendingMessagesCount}),this.consecutiveReconnects<this.maxConsecutiveReconnects):(this.resetReconnectCount(),!0))}resetReconnectCount(e){(null===e||void 0===e?void 0:e.type)!==us.ChunkedOp&&(this.consecutiveReconnects=0)}replayPendingStates(){if(!this.canSendOps())return;const e=this.dirtyContainer;let t;this.dirtyContainer=!1,(0,i.v)(this.emitDirtyDocumentEvent,295),this.emitDirtyDocumentEvent=!1;try{this.pendingStateManager.replayPendingStates()}finally{t=this.dirtyContainer,this.dirtyContainer=e,this.emitDirtyDocumentEvent=!0}this.updateDocumentDirtyState(t)}parseLocalOpContent(e){(0,i.v)(void 0!==e,1749);const t=JSON.parse(e);return(0,i.v)(void 0!==t.type,1750),t}async applyStashedOp(e){const t=this.parseLocalOpContent(e);switch(t.type){case us.FluidDataStoreOp:return this.dataStores.applyStashedOp(t.contents);case us.Attach:return this.dataStores.applyStashedAttachOp(t.contents);case us.IdAllocation:return void(0,i.v)(void 0!==this.idCompressor,1659);case us.Alias:case us.BlobAttach:return;case us.ChunkedOp:throw new Error("chunkedOp not expected here");case us.Rejoin:throw new Error("rejoin not expected here");case us.GC:throw new o.iq("GC op not expected to be stashed in summarizer");default:{var n;const e=null===(n=t.compatDetails)||void 0===n?void 0:n.behavior;if(!Gs(t.type,e)){const n=h.create("Stashed runtime message of unknown type","applyStashedOp",void 0,{messageDetails:JSON.stringify({type:t.type,compatBehavior:e})});throw this.closeFn(n),n}}}}setConnectionState(e,t){if(!1===e&&void 0!==this.delayConnectClientId)return this.delayConnectClientId=void 0,void this.mc.logger.sendTelemetryEvent({eventName:"UnsuccessfulConnectedTransition"});if(e&&!this._connected&&this.blobManager.hasPendingStashedBlobs())return(0,i.v)(!this.delayConnectClientId,1937),(0,i.v)(!!t,1938),this.delayConnectClientId=t,void this.blobManager.processStashedChanges().then((()=>{this.delayConnectClientId!==t||this.disposed||(this.delayConnectClientId=void 0,this.setConnectionStateCore(e,t))}),(e=>this.closeFn(e)));this.setConnectionStateCore(e,t)}setConnectionStateCore(e,t){(0,i.v)(!this.delayConnectClientId,916),this.verifyNotClosed();const n=this._connected!==e,r=n&&!e;n&&e&&this.flush(),this._connected=e,e?(0,i.v)(this.attachState===Qt.Attached,973):(this._perfSignalData.signalsLost=0,this._perfSignalData.signalTimestamp=0,this._perfSignalData.trackingSignalSequenceNumber=void 0),!r||(this.consecutiveReconnects++,this.shouldContinueReconnecting())?(n&&this.replayPendingStates(),this.dataStores.setConnectionState(e,t),this.garbageCollector.setConnectionState(e,t),un(this.mc.logger,this,e,t)):this.closeFn(h.create("Runtime detected too many reconnects with no progress syncing local ops.","setConnectionState",void 0,{dataLoss:1,attempts:this.consecutiveReconnects,pendingMessages:this.pendingMessagesCount}))}async notifyOpReplay(e){await this.pendingStateManager.applyStashedOpsAt(e.sequenceNumber)}process(e,t){this.verifyNotClosed();const n=e.type===pn.Operation,r={...e};for(const i of this.remoteMessageProcessor.process(r))this.processCore({message:i,local:t,modernRuntimeMessage:n})}processCore(e){const{message:t,local:n}=e;this.scheduleManager.beforeOpProcessing(t),this._processedClientSequenceNumber=t.clientSequenceNumber;try{let r;n&&e.modernRuntimeMessage&&t.type!==us.ChunkedOp&&(r=this.pendingStateManager.processPendingLocalMessage(e.message)),this.hasPendingMessages()||this.updateDocumentDirtyState(!1),this.validateAndProcessRuntimeMessage(e,r),this.emit("op",t,e.modernRuntimeMessage),this.scheduleManager.afterOpProcessing(void 0,t),n&&this.resetReconnectCount(t)}catch(r){throw this.scheduleManager.afterOpProcessing(r,t),r}}validateAndProcessRuntimeMessage(e,t){var n;const{local:r}=e;switch(e.message.type){case us.Attach:this.dataStores.processAttachMessage(e.message,r);break;case us.Alias:this.dataStores.processAliasMessage(e.message,t,r);break;case us.FluidDataStoreOp:this.dataStores.processFluidDataStoreOp(e.message,r,t,((e,t)=>this.garbageCollector.addedOutboundReference(e,t)));break;case us.BlobAttach:this.blobManager.processBlobAttachOp(e.message,r);break;case us.IdAllocation:(0,i.v)(void 0!==this.idCompressor,1660),!0!==(null===(n=e.message.metadata)||void 0===n?void 0:n.savedOp)&&this.idCompressor.finalizeCreationRange(e.message.contents);break;case us.GC:this.garbageCollector.processMessage(e.message,r);break;case us.ChunkedOp:case us.Rejoin:break;default:{var s;if(!e.modernRuntimeMessage)return;const t=null===(s=e.message.compatDetails)||void 0===s?void 0:s.behavior;if(!Gs(e.message.type,t)){var o;const{message:n}=e,i=h.create("Runtime message of unknown type","OpProcessing",n,{local:r,messageDetails:JSON.stringify({type:n.type,contentType:typeof n.contents,compatBehavior:t,batch:null===(o=n.metadata)||void 0===o?void 0:o.batch,compression:n.compression})});throw this.closeFn(i),i}}}}sendSignalTelemetryEvent(e){const t=Date.now()-this._perfSignalData.signalTimestamp;this.mc.logger.sendPerformanceEvent({eventName:"SignalLatency",duration:t,signalsLost:this._perfSignalData.signalsLost}),this._perfSignalData.signalsLost=0,this._perfSignalData.signalTimestamp=0}processSignal(e,t){const n=e.content,r={clientId:e.clientId,content:n.contents.content,type:n.contents.type};e.clientId===this.clientId&&this.connected&&(void 0!==this._perfSignalData.trackingSignalSequenceNumber&&n.clientSignalSequenceNumber>this._perfSignalData.trackingSignalSequenceNumber?(this._perfSignalData.signalsLost++,this._perfSignalData.trackingSignalSequenceNumber=void 0,this.mc.logger.sendErrorEvent({eventName:"SignalLost",type:n.contents.type,signalsLost:this._perfSignalData.signalsLost,trackingSequenceNumber:this._perfSignalData.trackingSignalSequenceNumber,clientSignalSequenceNumber:n.clientSignalSequenceNumber})):n.clientSignalSequenceNumber===this._perfSignalData.trackingSignalSequenceNumber&&(0===this.consecutiveReconnects&&this.sendSignalTelemetryEvent(n.clientSignalSequenceNumber),this._perfSignalData.trackingSignalSequenceNumber=void 0)),void 0!==n.address?this.dataStores.processSignal(n.address,r,t):this.emit("signal",r,t)}flush(){(0,i.v)(0===this._orderSequentiallyCalls,588),this.outbox.flush(),(0,i.v)(this.outbox.isEmpty,975)}orderSequentially(e){let t,n;this.mc.config.getBoolean("Fluid.ContainerRuntime.EnableRollback")&&(t=this.outbox.checkpoint().mainBatch);try{this._orderSequentiallyCalls++,n=e()}catch(r){if(t)try{t.rollback((e=>this.rollback(e.contents,e.localOpMetadata)))}catch(i){const e=(0,o.J4)(i,(e=>h.create("RollbackError: ".concat(e),"checkpointRollback",void 0)));throw this.closeFn(e),e}else this.closeFn((0,o.J4)(r,(e=>new c("orderSequentially callback exception: ".concat(e),r,{orderSequentiallyCalls:this._orderSequentiallyCalls}))));throw r}finally{this._orderSequentiallyCalls--}return this.flushMode!==nn.WD.TurnBased&&0===this._orderSequentiallyCalls&&this.flush(),n}async getAliasedDataStoreEntryPoint(e){await this.dataStores.waitIfPendingAlias(e);const t=this.internalId(e),n=await this.dataStores.getDataStoreIfAvailable(t,{wait:!1});if(void 0===n||!await n.isRoot())return;const r=await n.realize();if(void 0===r.entryPoint)throw new l("entryPoint must be defined on data store runtime for using getAliasedDataStoreEntryPoint");return this.garbageCollector.nodeUpdated("/".concat(t),"Loaded",void 0,n.packagePath),r.entryPoint}createDetachedRootDataStore(e,t){if(t.includes("/"))throw new l("Id cannot contain slashes: '".concat(t,"'"));return this.dataStores.createDetachedDataStoreCore(e,!0,t)}createDetachedDataStore(e){return this.dataStores.createDetachedDataStoreCore(e,!1)}async createDataStore(e){const t=In();return bi(await this.dataStores._createFluidDataStoreContext(Array.isArray(e)?e:[e],t).realize(),t,this,this.dataStores,this.mc.logger)}async _createDataStoreWithProps(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:In();return bi(await this.dataStores._createFluidDataStoreContext(Array.isArray(e)?e:[e],n,t).realize(),n,this,this.dataStores,this.mc.logger)}canSendOps(){return this.connected&&!this.innerDeltaManager.readOnlyInfo.readonly&&!this.imminentClosure}currentlyBatching(){return this.flushMode!==nn.WD.Immediate||0!==this._orderSequentiallyCalls}getQuorum(){return this._quorum}getAudience(){return this._audience}get isDirty(){return this.dirtyContainer}isContainerMessageDirtyable(e){let{type:t,contents:n}=e;switch(t){case us.Attach:if(n.id===oo)return!1;break;case us.FluidDataStoreOp:if(n.address===oo)return!1;break;case us.GC:return!1}return!0}createNewSignalEnvelope(e,t,n){const r=++this._perfSignalData.signalSequenceNumber,i={address:e,clientSignalSequenceNumber:r,contents:{type:t,content:n}};return r%this.defaultTelemetrySignalSampleCount===1&&void 0===this._perfSignalData.trackingSignalSequenceNumber&&(this._perfSignalData.signalTimestamp=Date.now(),this._perfSignalData.trackingSignalSequenceNumber=r),i}submitSignal(e,t,n){this.verifyNotClosed();const r=this.createNewSignalEnvelope(void 0,e,t);return this.submitSignalFn(r,n)}submitDataStoreSignal(e,t,n,r){const i=this.createNewSignalEnvelope(e,t,n);return this.submitSignalFn(i,r)}setAttachState(e){e===Qt.Attaching?(0,i.v)(this.attachState===Qt.Attaching,301):((0,i.v)(this.attachState===Qt.Attached,302),this.emit("attached")),e!==Qt.Attached||this.hasPendingMessages()||this.updateDocumentDirtyState(!1),this.dataStores.setAttachState(e)}createSummary(e,t){var n;e&&this.blobManager.setRedirectTable(e);const r=null===(n=this.idCompressor)||void 0===n?void 0:n.takeNextCreationRange();var i;void 0!==r&&(null===(i=this.idCompressor)||void 0===i||i.finalizeCreationRange(r));const s=this.dataStores.createSummary(t);return _r(s),this.addContainerStateToSummary(s,!0,!1,t),s.summary}async summarizeInternal(e,t,n){const r=await this.dataStores.summarize(e,t,n);_r(r);const i=[nn._1];return this.addContainerStateToSummary(r,e,t,n),{...r,id:"",pathPartsForChildren:i}}async summarize(e){this.verifyNotClosed();const{fullTree:t=!1,trackState:n=!0,summaryLogger:r=this.mc.logger,runGC:s=this.garbageCollector.shouldRunGC,runSweep:o,fullGC:a}=e,c=new qt;c.setMultiple("fluid_Summarize","Options",{fullTree:t,trackState:n,runGC:s,fullGC:a,runSweep:o});try{s&&await this.collectGarbage({logger:r,runSweep:o,fullGC:a},c);const{stats:e,summary:l}=await this.summarizerNode.summarize(t,n,c);return(0,i.v)(l.type===Et.Tree,303),{stats:e,summary:l}}finally{this.mc.logger.sendTelemetryEvent({eventName:"SummarizeTelemetry",details:c.serialize()})}}async updateStateBeforeGC(){return this.dataStores.updateStateBeforeGC()}async getGCDataInternal(e){return this.dataStores.getGCData(e)}async getGCData(e){const t=new jt,n=await this.summarizerNode.getGCData(e);t.addNodes(n.gcNodes);const r=this.blobManager.getGCData(e);return t.addNodes(r.gcNodes),t.getGCData()}updateUsedRoutes(e){this.summarizerNode.updateUsedRoutes([""]);const{dataStoreRoutes:t}=this.getDataStoreAndBlobManagerRoutes(e);this.dataStores.updateUsedRoutes(t)}updateUnusedRoutes(e){const{blobManagerRoutes:t,dataStoreRoutes:n}=this.getDataStoreAndBlobManagerRoutes(e);this.blobManager.updateUnusedRoutes(t),this.dataStores.updateUnusedRoutes(n)}deleteUnusedNodes(e){throw new Error("deleteUnusedRoutes should not be called")}deleteSweepReadyNodes(e){const{dataStoreRoutes:t,blobManagerRoutes:n}=this.getDataStoreAndBlobManagerRoutes(e);return this.dataStores.deleteSweepReadyNodes(t).concat(this.blobManager.deleteSweepReadyNodes(n))}updateTombstonedRoutes(e){const{blobManagerRoutes:t,dataStoreRoutes:n}=this.getDataStoreAndBlobManagerRoutes(e);this.blobManager.updateTombstonedRoutes(t),this.dataStores.updateTombstonedRoutes(n)}getCurrentReferenceTimestampMs(){var e,t,n;return null!==(e=null===(t=this.deltaManager.lastMessage)||void 0===t?void 0:t.timestamp)&&void 0!==e?e:null===(n=this.messageAtLastSummary)||void 0===n?void 0:n.timestamp}getNodeType(e){var t;return this.isBlobPath(e)?ei.Blob:null!==(t=this.dataStores.getGCNodeType(e))&&void 0!==t?t:ei.Other}async getGCNodePackagePath(e){if("/"===e)return["_gcRoot"];switch(this.getNodeType(e)){case ei.Blob:return[cr.basePath];case ei.DataStore:case ei.SubDataStore:return this.dataStores.getDataStorePackagePath(e);default:(0,i.v)(!1,734)}}isBlobPath(e){const t=e.split("/");return!(t.length<2||t[1]!==cr.basePath)}getDataStoreAndBlobManagerRoutes(e){const t=[],n=[];for(const r of e)this.isBlobPath(r)?t.push(r):n.push(r);return{blobManagerRoutes:t,dataStoreRoutes:n}}async collectGarbage(e,t){return this.garbageCollector.collectGarbage(e,t)}addedGCOutboundReference(e,t){this.garbageCollector.addedOutboundReference(e.absolutePath,t.absolutePath)}async submitSummary(e){const{fullTree:t=!1,finalAttempt:n=!1,refreshLatestAck:r,summaryLogger:s}=e,o=this.nextSummaryNumber,a=(0,Xt.pW)({logger:s,properties:{all:{summaryNumber:o}}});if((0,i.v)(this.outbox.isEmpty,977),!0===r)return this.prefetchLatestSummaryThenClose((0,Xt.pW)({logger:a,properties:{all:{safeSummary:!0}}}));if(this.validateSummaryBeforeUpload&&this.isDirty){var c;const e=this.pendingMessagesCount,t=null!==(c=this.mc.config.getNumber("Fluid.Summarizer.waitForPendingOpsTimeoutMs"))&&void 0!==c?c:1e3;await new Promise(((e,n)=>{const r=setTimeout((()=>e()),t);this.once("saved",(()=>{clearTimeout(r),e()})),this.once("dispose",(()=>{clearTimeout(r),n(new Error("Runtime is disposed while summarizing"))}))})),a.sendTelemetryEvent({eventName:"PendingOpsWhileSummarizing",saved:!this.isDirty,timeout:t,countBefore:e,countAfter:this.pendingMessagesCount});const r=await this.shouldFailSummaryOnPendingOps(a,this.deltaManager.lastSequenceNumber,this.deltaManager.minimumSequenceNumber,n,!0);if(void 0!==r)return r}const l=!0!==this.mc.config.getBoolean("Fluid.ContainerRuntime.SubmitSummary.disableInboundSignalPause");let u;try{await this.deltaManager.inbound.pause(),l&&await this.deltaManager.inboundSignal.pause(),u=this.deltaManager.lastSequenceNumber;const r=this.deltaManager.minimumSequenceNumber,s="Summary @".concat(u,":").concat(this.deltaManager.minimumSequenceNumber),c=this.summaryCollection.latestAck;this.summarizerNode.startSummary(u,a);const h=()=>{var t;return e.cancellationToken.cancelled?{continue:!1,error:"disconnected"}:((0,i.v)(this.connected,600),this.deltaManager.lastSequenceNumber!==u?{continue:!1,error:"lastSequenceNumber changed before uploading to storage. ".concat(this.deltaManager.lastSequenceNumber," !== ").concat(u)}:((0,i.v)(u===(null===(t=this.deltaManager.lastMessage)||void 0===t?void 0:t.sequenceNumber),917),c!==this.summaryCollection.latestAck?{continue:!1,error:"Last summary changed while summarizing. ".concat(this.summaryCollection.latestAck," !== ").concat(c)}:{continue:!0}))};let d=h();if(!d.continue)return{stage:"base",referenceSequenceNumber:u,minimumSequenceNumber:r,error:d.error};const p=ln.start();let m;const g=this.garbageCollector.summaryStateNeedsReset;try{m=await this.summarize({fullTree:t||g,trackState:!0,summaryLogger:a,runGC:this.garbageCollector.shouldRunGC})}catch(f){return{stage:"base",referenceSequenceNumber:u,minimumSequenceNumber:r,error:f}}if(this.validateSummaryBeforeUpload){const e=this.summarizerNode.validateSummary();if(!e.success){const{success:t,...n}=e,i=new $i(e.reason,e.retryAfterSeconds,{...n});return{stage:"base",referenceSequenceNumber:u,minimumSequenceNumber:r,error:i}}const t=await this.shouldFailSummaryOnPendingOps(a,u,r,n,!1);if(void 0!==t)return t}const{summary:v,stats:y}=m;this.messageAtLastSummary=this.deltaManager.lastMessage;const b=v.tree[nn._1];(0,i.v)(b.type===Et.Tree,508);const S=Object.values(b.tree).filter((e=>e.type===Et.Handle)).length,w=v.tree[nn.aT]?Dt(v.tree[nn.aT]):void 0,C={dataStoreCount:this.dataStores.size,summarizedDataStoreCount:this.dataStores.size-S,gcStateUpdatedDataStoreCount:this.garbageCollector.updatedDSCountSinceLastSummary,gcBlobNodeCount:null===w||void 0===w?void 0:w.blobNodeCount,gcTotalBlobsSize:null===w||void 0===w?void 0:w.totalBlobSize,summaryNumber:o,...y},x={referenceSequenceNumber:u,minimumSequenceNumber:r,summaryTree:v,summaryStats:C,generateDuration:p.trace().duration,forcedFullTree:g};if(d=h(),!d.continue)return{stage:"generate",...x,error:d.error};let E,T;null===c||void 0===c||c.summaryAck.contents.handle,E=void 0===c?{proposalHandle:void 0,ackHandle:this.loadedFromVersionId,referenceSequenceNumber:u}:{proposalHandle:c.summaryOp.contents.handle,ackHandle:c.summaryAck.contents.handle,referenceSequenceNumber:u};try{T=await this.storage.uploadSummaryWithContext(m.summary,E)}catch(f){return{stage:"generate",...x,error:f}}const k=E.ackHandle,N={handle:T,head:k,message:s,parents:k?[k]:[]},F={...x,handle:T,uploadDuration:p.trace().duration};if(d=h(),!d.continue)return{stage:"upload",...F,error:d.error};let I;try{I=this.submitSummaryMessage(N,u)}catch(f){return{stage:"upload",...F,error:f}}const A={stage:"submit",...F,clientSequenceNumber:I,submitOpDuration:p.trace().duration};try{this.summarizerNode.completeSummary(T,!this.validateSummaryBeforeUpload)}catch(f){return{stage:"upload",...F,error:f}}return A}finally{var h,d;this.summarizerNode.clearSummary(),null===(h=this._summarizer)||void 0===h||null===(d=h.recordSummaryAttempt)||void 0===d||d.call(h,u),this.deltaManager.inbound.resume(),l&&this.deltaManager.inboundSignal.resume()}}async shouldFailSummaryOnPendingOps(e,t,n,r,i){if(this.isDirty){if(!r||!this.mc.config.getBoolean("Fluid.Summarizer.SkipFailingIncorrectSummary")){var s;const e=null!==(s=this.mc.config.getNumber("Fluid.Summarizer.PendingOpsRetryDelayMs"))&&void 0!==s?s:1e3;return{stage:"base",referenceSequenceNumber:t,minimumSequenceNumber:n,error:new $i("PendingOpsWhileSummarizing",e/1e3,{count:this.pendingMessagesCount,beforeGenerate:i})}}{const r=h.create("Pending ops during summarization","submitSummary",void 0,{pendingMessages:this.pendingMessagesCount});e.sendErrorEvent({eventName:"SkipFailingIncorrectSummary",referenceSequenceNumber:t,minimumSequenceNumber:n,beforeGenerate:i},r)}}}get pendingMessagesCount(){return this.pendingStateManager.pendingMessagesCount+this.outbox.messageCount}hasPendingMessages(){return 0!==this.pendingMessagesCount}updateDocumentDirtyState(e){this.attachState!==Qt.Attached?(0,i.v)(e,978):(0,i.v)(!e||this.hasPendingMessages(),979),this.dirtyContainer!==e&&(this.dirtyContainer=e,this.emitDirtyDocumentEvent&&this.emit(e?"dirty":"saved"))}submitDataStoreOp(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;const r={address:e,contents:t};this.submit({type:us.FluidDataStoreOp,contents:r},n)}submitDataStoreAliasOp(e,t){if(!yi(e))throw new l("malformedDataStoreAliasMessage");this.submit({type:us.Alias,contents:e},t)}async uploadBlob(e,t){return this.verifyNotClosed(),this.blobManager.createBlob(e,t)}maybeSubmitIdAllocationOp(e){if(e!==us.IdAllocation){let e,n;var t;if(this.idCompressorEnabled)(0,i.v)(void 0!==this.idCompressor,1661),n=this.idCompressor.takeNextCreationRange(),n=void 0!==(null===(t=n)||void 0===t?void 0:t.ids)?n:void 0;if(void 0!==n){const t={type:us.IdAllocation,contents:n};e={contents:JSON.stringify(t),referenceSequenceNumber:this.deltaManager.lastSequenceNumber,metadata:void 0,localOpMetadata:void 0,type:us.IdAllocation}}void 0!==e&&this.outbox.submitIdAllocation(e)}}submit(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;this.verifyNotClosed(),this.verifyCanSubmitOps(),(0,i.v)(this.attachState!==Qt.Detached,306);const r=JSON.stringify(e);this.innerDeltaManager.readOnlyInfo.readonly&&this.mc.logger.sendTelemetryEvent({eventName:"SubmitOpInReadonly",connected:this.connected});const s=e.type,o={contents:r,type:s,metadata:n,localOpMetadata:t,referenceSequenceNumber:this.deltaManager.lastSequenceNumber};try{this.maybeSubmitIdAllocationOp(s),this.currentlyBatching()&&s===us.Attach&&!0!==this.disableAttachReorder?this.outbox.submitAttach(o):s===us.BlobAttach?this.outbox.submitBlobAttach(o):this.outbox.submit(o),this.currentlyBatching()?this.scheduleFlush():this.flush()}catch(a){throw this.closeFn(a),a}this.isContainerMessageDirtyable(e)&&this.updateDocumentDirtyState(!0)}scheduleFlush(){if(this.flushTaskExists)return;this.flushTaskExists=!0;const e=()=>{this.flushTaskExists=!1;try{this.flush()}catch(e){this.closeFn(e)}};switch(this.flushMode){case nn.WD.TurnBased:Promise.resolve().then(e);break;case nn.qS.Async:setTimeout(e,0);break;default:(0,i.v)(this._orderSequentiallyCalls>0,1415)}}submitSummaryMessage(e,t){return this.verifyNotClosed(),(0,i.v)(this.connected,307),(0,i.v)(this.outbox.isEmpty,980),void 0!==this.submitSummaryFn?this.submitSummaryFn(e,t):this.submitFn(pn.Summarize,e,!1)}verifyNotClosed(){if(this._disposed)throw new Error("Runtime is closed")}verifyCanSubmitOps(){if(this.ensureNoDataModelChangesCalls>0){const e="Op was submitted from within a `ensureNoDataModelChanges` callback";if(this.opReentryCallsToReport>0&&(this.mc.logger.sendTelemetryEvent({eventName:"OpReentry"},js((()=>new l(e)))),this.opReentryCallsToReport--),this.enableOpReentryCheck)throw new l(e)}}reSubmitBatch(e){this.orderSequentially((()=>{for(const t of e)this.reSubmit(t)})),this.flush()}reSubmit(e){const t=this.parseLocalOpContent(e.content);this.reSubmitCore(t,e.localOpMetadata,e.opMetadata)}reSubmitCore(e,t,n){switch((0,i.v)(!this.isSummarizerClient,"Summarizer never reconnects so should never resubmit"),e.type){case us.FluidDataStoreOp:this.dataStores.resubmitDataStoreOp(e.contents,t);break;case us.Attach:case us.Alias:case us.IdAllocation:this.submit(e,t);break;case us.ChunkedOp:throw new Error("chunkedOp not expected here");case us.BlobAttach:this.blobManager.reSubmit(n);break;case us.Rejoin:case us.GC:this.submit(e);break;default:{var r;const t=null===(r=e.compatDetails)||void 0===r?void 0:r.behavior;if(!Gs(e.type,t)){const n=h.create("Resubmitting runtime message of unknown type","reSubmitCore",void 0,{messageDetails:JSON.stringify({type:e.type,compatBehavior:t})});throw this.closeFn(n),n}this.logger.sendTelemetryEvent({eventName:"resubmitUnrecognizedMessageTypeAllowed",messageDetails:{type:e.type,compatBehavior:t}})}}}rollback(e,t){const{type:n,contents:r}=this.parseLocalOpContent(e);if(n!==us.FluidDataStoreOp)throw new Error("Can't rollback ".concat(n));this.dataStores.rollbackDataStoreOp(r,t)}async refreshLatestSummaryAck(e){const{proposalHandle:t,ackHandle:n,summaryRefSeq:r,summaryLogger:s}=e;(0,i.v)(void 0!==t,1894);const o=async e=>vn(this.storage,e),a=await this.summarizerNode.refreshLatestSummary(t,r);if(a.isSummaryTracked||!a.isSummaryNewer)await this.garbageCollector.refreshLatestSummary(a);else{const e=await this.fetchLatestSnapshotFromStorage(s,{eventName:"RefreshLatestSummaryAckFetch",ackHandle:n,targetSequenceNumber:r},o);if(e.latestSnapshotRefSeq<r){const t=h.create("Fetched snapshot is older than the received ack","RefreshLatestSummaryAck",void 0,{ackHandle:n,summaryRefSeq:r,fetchedSnapshotRefSeq:e.latestSnapshotRefSeq});throw this.disposeFn(t),t}await this.closeStaleSummarizer("RefreshLatestSummaryAckFetch")}}async prefetchLatestSummaryThenClose(e){return await this.fetchLatestSnapshotFromStorage(e,{eventName:"RefreshLatestSummaryFromServerFetch"},(async e=>vn(this.storage,e))),await this.closeStaleSummarizer("RefreshLatestSummaryFromServerFetch"),{stage:"base",error:"summary state stale - Unsupported option 'refreshLatestAck'",referenceSequenceNumber:this.deltaManager.lastSequenceNumber,minimumSequenceNumber:this.deltaManager.minimumSequenceNumber}}async closeStaleSummarizer(e){var t;await cn(this.closeSummarizerDelayMs),null===(t=this._summarizer)||void 0===t||t.stop("latestSummaryStateStale"),this.disposeFn()}async fetchLatestSnapshotFromStorage(e,t,n){return Xt.Bt.timedExecAsync(e,t,(async e=>{const t={},r=ln.start(),s=await this.storage.getVersions(null,1,"prefetchLatestSummaryBeforeClose",fn.noCache);(0,i.v)(!!s&&!!s[0],311),t.getVersionDuration=r.trace().duration;const o=await this.storage.getSnapshotTree(s[0]);(0,i.v)(!!o,312),t.getSnapshotDuration=r.trace().duration;const a=await async function(e,t){const n=e.trees[".protocol"].blobs.attributes;return(await t(n)).sequenceNumber}(o,n);return t.snapshotRefSeq=a,t.snapshotVersion=s[0].id,e.end(t),{snapshotTree:o,versionId:s[0].id,latestSnapshotRefSeq:a}}))}async getPendingLocalState(e){return Xt.Bt.timedExecAsync(this.mc.logger,{eventName:"getPendingLocalState",notifyImminentClosure:null===e||void 0===e?void 0:e.notifyImminentClosure},(async t=>{var n,r;(this.verifyNotClosed(),this.imminentClosure)||(this.imminentClosure=null!==(r=null===e||void 0===e?void 0:e.notifyImminentClosure)&&void 0!==r?r:this.imminentClosure);const i=null===e||void 0===e?void 0:e.stopBlobAttachingSignal;if(0!==this._orderSequentiallyCalls)throw new l("can't get state during orderSequentially");this.flush();const s=this.imminentClosure?await this.blobManager.attachAndGetPendingBlobs(i):void 0,o=this.pendingStateManager.getLocalState();if(!s&&!this.hasPendingMessages())return;const a={pending:o,pendingAttachmentBlobs:s,pendingIdCompressorState:null===(n=this.idCompressor)||void 0===n?void 0:n.serialize(!0)};return t.end({attachmentBlobsSize:Object.keys(null!==s&&void 0!==s?s:{}).length,pendingOpsSize:null===o||void 0===o?void 0:o.pendingStates.length}),a}))}summarizeOnDemand(e){if(this.isSummarizerClient)return this.summarizer.summarizeOnDemand(e);if(void 0!==this.summaryManager)return this.summaryManager.summarizeOnDemand(e);throw new l("Can't summarize, disableSummaries: ".concat(this.summariesDisabled))}enqueueSummarize(e){if(this.isSummarizerClient)return this.summarizer.enqueueSummarize(e);if(void 0!==this.summaryManager)return this.summaryManager.enqueueSummarize(e);throw new l("Can't summarize, disableSummaries: ".concat(this.summariesDisabled))}formCreateSummarizerFn(e){return async()=>async function(e,t){var n;const r={headers:{[on.cache]:!1,[on.clientDetails]:{capabilities:{interactive:!1},type:jr},[hn.summarizingClient]:!0,[on.reconnect]:!1},url:t},i=await e.resolve(r);let s;if(void 0!==i.getEntryPoint)s=await i.getEntryPoint();else{const e=await i.request({url:"/".concat(co)});if(200!==e.status||"fluid/object"!==e.mimeType)throw bn(e);s=e.value}if(void 0===(null===(n=s)||void 0===n?void 0:n.ISummarizer))throw new l("Fluid object does not implement ISummarizer");return s.ISummarizer}(e,"/".concat(co))}validateSummaryHeuristicConfiguration(e){for(const t in e)if("number"===typeof e[t]&&e[t]<0)throw new l('Summary heuristic configuration property "'.concat(t,'" cannot be less than 0'));if(e.minIdleTime>e.maxIdleTime)throw new l('"minIdleTime" ['.concat(e.minIdleTime,'] cannot be greater than "maxIdleTime" [').concat(e.maxIdleTime,"]"))}get groupedBatchingEnabled(){return!0!==this.mc.config.getBoolean("Fluid.ContainerRuntime.DisableGroupedBatching")&&this.runtimeOptions.enableGroupedBatching}}class uo{get IFluidHandleContext(){return this}get IFluidHandle(){return this}constructor(e,t){this.absolutePath=e,this.routeContext=t,this.isAttached=!0,(0,i.v)(e.startsWith("/"),413)}async get(){if(void 0===this.objectP){const e={url:this.absolutePath,headers:{[Js.viaHandle]:!0}};this.objectP=this.routeContext.resolveHandle(e).then((e=>{if("fluid/object"===e.mimeType){return e.value}throw bn(e)}))}return this.objectP}attachGraph(){}bind(e){e.attachGraph()}}class ho{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:()=>{};for(this.context=e,this.handleParsedCb=t,this.encodeValue=(e,t)=>{const n=null===e||void 0===e?void 0:e.IFluidHandle;return void 0!==n?this.serializeHandle(n,t):e},this.decodeValue=e=>{if(rn(e)){const t=e.url.startsWith("/")?e.url:sn(e.url,this.context),n=new uo(t,this.root);return this.handleParsedCb(n),n}return e},this.root=this.context;void 0!==this.root.routeContext;)this.root=this.root.routeContext}get IFluidSerializer(){return this}encode(e,t){return e&&"object"===typeof e?this.recursivelyReplace(e,this.encodeValue,t):e}decode(e){return e&&"object"===typeof e?this.recursivelyReplace(e,this.decodeValue):e}stringify(e,t){return JSON.stringify(e,((e,n)=>this.encodeValue(n,t)))}parse(e){return JSON.parse(e,((e,t)=>this.decodeValue(t)))}recursivelyReplace(e,t,n){var r;const i=t(e,n);if(i!==e)return i;let s;for(const a of Object.keys(e)){const r=e[a];if(r&&"object"===typeof r){const i=this.recursivelyReplace(r,t,n);var o;if(i!==r)s=null!==(o=s)&&void 0!==o?o:Array.isArray(e)?[...e]:{...e},s[a]=i}}return null!==(r=s)&&void 0!==r?r:e}serializeHandle(e,t){return t.bind(e),{type:"__fluid_handle__",url:e.absolutePath}}}class fo extends hr{get isAttached(){return this.value.isAttached()}constructor(e,t,n){super(e,t,n),this.value=e}attachGraph(){this.value.bindToContext(),super.attachGraph()}}class po extends ho{constructor(){super(...arguments),this.serializedRoutes=new Set}getSerializedRoutes(){return Array.from(this.serializedRoutes)}serializeHandle(e,t){return this.serializedRoutes.add(e.absolutePath),super.serializeHandle(e,t)}}class mo extends $t{get IFluidLoadable(){return this}get connected(){return this._connected}constructor(e,t,n){super(((e,t)=>this.eventListenerErrorHandler(e,t))),this.id=e,this.runtime=t,this.attributes=n,this._connected=!1,this._isBoundToContext=!1,(0,i.v)(!e.includes("/"),772),this.handle=new fo(this,e,t.IFluidHandleContext),this.logger=(0,Xt.pW)({logger:t.logger,properties:{all:{sharedObjectId:Wt(),...(0,Xt.Df)({ddsType:this.attributes.type})}}}),this.mc=(0,Yt.Ln)(this.logger),[this.opProcessingHelper,this.callbacksHelper]=this.setUpSampledTelemetryHelpers(),this.attachListeners()}setUpSampledTelemetryHelpers(){var e,t;(0,i.v)(void 0!==this.mc&&void 0!==this.logger,841);const n=new tn({eventName:"ddsOpProcessing",category:"performance"},this.logger,null!==(e=this.mc.config.getNumber("Fluid.SharedObject.OpProcessingTelemetrySampling"))&&void 0!==e?e:1e3,!0,new Map([["local",{localOp:!0}],["remote",{localOp:!1}]])),r=new tn({eventName:"ddsEventCallbacks",category:"performance"},this.logger,null!==(t=this.mc.config.getNumber("Fluid.SharedObject.DdsCallbacksTelemetrySampling"))&&void 0!==t?t:1e3,!0);return this.runtime.once("dispose",(()=>{this.callbacksHelper.dispose(),this.opProcessingHelper.dispose()})),[n,r]}closeWithError(e){void 0===this.closeError&&(this.closeError=e)}verifyNotClosed(){if(void 0!==this.closeError)throw this.closeError}eventListenerErrorHandler(e,t){const n=h.wrapIfUnrecognized(t,"SharedObjectEventListenerException");throw n.addTelemetryProperties({emittedEventName:String(e)}),this.closeWithError(n),n}attachListeners(){this.isAttached()||this.runtime.once("attaching",(()=>{this.didAttach()}))}async load(e){this.runtime.attachState!==Qt.Detached&&(this.services=e),await this.loadCore(e.objectStorage),this.runtime.attachState!==Qt.Detached&&this.attachDeltaHandler()}initializeLocal(){this.initializeLocalCore()}bindToContext(){this._isBoundToContext||(this._isBoundToContext=!0,this.runtime.bindChannel(this))}connect(e){this.services=e,this.attachDeltaHandler()}isAttached(){return void 0!==this.services&&this.runtime.attachState!==Qt.Detached}handleDecoded(e){var t,n,r;this.isAttached()&&(null===(t=this.services)||void 0===t||null===(n=(r=t.deltaConnection).addedGCOutboundReference)||void 0===n||n.call(r,this.handle,e))}initializeLocalCore(){}didAttach(){}submitLocalMessage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;this.verifyNotClosed(),this.isAttached()&&this.services.deltaConnection.submit(e,t)}dirty(){this.isAttached()&&this.services.deltaConnection.dirty()}onConnect(){}reSubmitCore(e,t){this.submitLocalMessage(e,t)}async newAckBasedPromise(e){let t;return new Promise(((n,r)=>{t=()=>r(new Error("FluidDataStoreRuntime disposed while this ack-based Promise was pending")),this.runtime.disposed?t():(this.runtime.on("dispose",t),e(n,r))})).finally((()=>{this.runtime.off("dispose",t)}))}attachDeltaHandler(){(0,i.v)(void 0!==this.services,122),this._isBoundToContext=!0,this.didAttach(),this.services.deltaConnection.attach({process:(e,t,n)=>{this.process(e,t,n)},setConnectionState:e=>{this.setConnectionState(e)},reSubmit:(e,t)=>{this.reSubmit(e,t)},applyStashedOp:e=>this.applyStashedOp(e),rollback:(e,t)=>{this.rollback(e,t)}}),this.setConnectionState(this.services.deltaConnection.connected)}setConnectionState(e){this._connected!==e&&(this._connected=e,e?this.onConnect():this.onDisconnect())}process(e,t,n){this.verifyNotClosed(),this.emitInternal("pre-op",e,t,this),this.opProcessingHelper.measure((()=>{this.processCore(e,t,n)}),t?"local":"remote"),this.emitInternal("op",e,t,this)}reSubmit(e,t){this.reSubmitCore(e,t)}rollback(e,t){throw new Error("rollback not supported")}emit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return this.callbacksHelper.measure((()=>this.runtime.ensureNoDataModelChanges((()=>super.emit(e,...n)))))}emitInternal(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return super.emit(e,...n)}}class go extends mo{get serializer(){return(0,i.v)(!this._isGCing,117),this._serializer}constructor(e,t,n,r){super(e,t,n),this.telemetryContextPrefix=r,this._isGCing=!1,this._serializer=new ho(this.runtime.channelsRoutingContext,(e=>this.handleDecoded(e)))}getAttachSummary(){let e=arguments.length>2?arguments[2]:void 0;const t=this.summarizeCore(this.serializer,e);return this.incrementTelemetryMetric(nn.RN,t.stats.blobNodeCount,e),this.incrementTelemetryMetric(nn.NM,t.stats.totalBlobSize,e),t}async summarize(){let e=arguments.length>2?arguments[2]:void 0,t=arguments.length>3?arguments[3]:void 0;const n=this.summarizeCore(this.serializer,e,t);return this.incrementTelemetryMetric(nn.RN,n.stats.blobNodeCount,e),this.incrementTelemetryMetric(nn.NM,n.stats.totalBlobSize,e),n}getGCData(){let e;(0,i.v)(!this._isGCing,120),this._isGCing=!0;try{const t=new po(this.runtime.channelsRoutingContext,(e=>this.handleDecoded(e)));this.processGCDataCore(t),e={gcNodes:{"/":t.getSerializedRoutes()}},(0,i.v)(this._isGCing,121)}finally{this._isGCing=!1}return e}processGCDataCore(e){this.summarizeCore(e)}incrementTelemetryMetric(e,t,n){var r;const i=null!==(r=null===n||void 0===n?void 0:n.get(this.telemetryContextPrefix,e))&&void 0!==r?r:0;null===n||void 0===n||n.set(this.telemetryContextPrefix,e,i+t)}}var vo,yo,bo,So;function wo(e,t){return{...e,change:t}}function Co(e,t){return{revision:t,change:e}}function xo(e,t,n){return{revision:t,change:e,rollbackOf:n}}function Eo(e){return{revision:void 0,change:e}}function To(e,t,n,r,s){const o=[],a=[];(0,i.v)(void 0!==Do([n,o],[r,a]),1398);const c=o.map((t=>function(e,t,n,r){var i;const s=null!==(i=t.inverse)&&void 0!==i?i:e.invert(t,!0);!0===r&&void 0===t.inverse&&(t.inverse=s);return xo(s,n(),t.revision)}(e,t,s,!0)));return c.reverse(),No(e,t,[...c,...a])}function ko(e){const t=t=>{const n=e.findIndex((e=>e.revision===t));return n>=0?n:void 0};return{getIndex:t,tryGetInfo:n=>{if(void 0===n)return;const r=t(n);return void 0===r?void 0:e[r]},hasRollback:t=>void 0!==e.find((e=>e.rollbackOf===t))}}function No(e,t,n){const r=ko(Fo(n));return n.reduce(((t,n)=>e.rebase(t,n,r)),t)}function Fo(e){const t=[];for(const n of e)t.push(...Io(n));return t}function Io(e){const t=[];if(void 0!==e.revision){const n={revision:e.revision};void 0!==e.rollbackOf&&(n.rollbackOf=e.rollbackOf),t.push(n)}return t}function Ao(e){let t,n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e=>void 0===e.parent;Array.isArray(e)?[t,n]=e:t=e;for(let o=t;void 0!==o;o=o.parent){var i,s;if(r(o))return null===(s=n)||void 0===s||s.reverse(),o;null===(i=n)||void 0===i||i.push(o)}void 0!==n&&(n.length=0)}function Do(e,t){let n,r,s,o;if(Array.isArray(e)?([n,s]=e,(0,i.v)(void 0===s||0===s.length,1400)):n=e,Array.isArray(t)?([r,o]=t,(0,i.v)(void 0===o||0===o.length,1401)):r=t,n===r)return n;const a=()=>{var e,t;null===(e=s)||void 0===e||e.reverse(),null===(t=o)||void 0===t||t.reverse()},c=new Set;for(;void 0!==n||void 0!==r;){if(void 0!==n){var l;if(c.has(n))return void 0!==o&&(o.length=o.findIndex((e=>Object.is(e,n)))),a(),n;c.add(n),null===(l=s)||void 0===l||l.push(n),n=n.parent}if(void 0!==r){var u;if(c.has(r))return void 0!==s&&(s.length=s.findIndex((e=>Object.is(e,r)))),a(),r;c.add(r),null===(u=o)||void 0===u||u.push(r),r=r.parent}}void 0!==s&&(s.length=0),void 0!==o&&(o.length=0)}!function(e){e[e.Default=0]="Default",e[e.Undo=1]="Undo",e[e.Redo=2]="Redo",e[e.Rebase=3]="Rebase"}(vo||(vo={})),function(e){e[e.Success=0]="Success",e[e.Failure=1]="Failure"}(yo||(yo={})),function(e){e[e.Success=0]="Success",e[e.Failure=1]="Failure"}(bo||(bo={})),function(e){e[e.conflicted=0]="conflicted",e[e.rebased=1]="rebased",e[e.commuted=2]="commuted"}(So||(So={}));class Oo{constructor(){this.stack=[]}get size(){return this.stack.length}push(e,t){this.stack.push({startRevision:e,dispose:t})}pop(){var e;const t=null!==(e=this.stack.pop())&&void 0!==e?e:T("No transaction is currently in progress");return t.dispose(),t}}function Po(e){return 0===e.removedCommits.length||1!==e.newCommits.length||1===e.removedCommits.length&&e.removedCommits[0].revision===e.newCommits[0].revision?"rebase":"transactionCommit"}class Ro extends U{constructor(e,t,n){super(),this.head=e,this.changeFamily=t,this.mintRevisionTag=n,this.revertibles=new Set,this._revertibleCommits=new Map,this.transactions=new Oo,this.initialTransactionRevToRebasedRev=new Map,this.disposed=!1,this.editor=this.changeFamily.buildEditor((e=>this.apply(e,n())))}setHead(e){this.assertNotDisposed(),(0,i.v)(!this.isTransacting(),1669),this.head=e}apply(e,t){return this.applyChange(e,t,vo.Default)}applyChange(e,t,n){this.assertNotDisposed();const r=_e(this.head,{revision:t,change:e}),i={type:"append",change:Co(e,t),newCommits:[r]};return this.emit("beforeChange",i),this.head=r,this.isTransacting()||this.emit("revertible",this.makeSharedTreeRevertible(r,n)),this.emit("afterChange",i),[e,r]}getHead(){return this.head}startTransaction(){this.assertNotDisposed();const e=new Set,t=[],n=Mo(this,(n=>{e.add(n),t.push(n.on("dispose",(()=>e.delete(n))))}));this.transactions.push(this.head.revision,(()=>{e.forEach((e=>e.dispose())),t.forEach((e=>e())),n()})),this.editor.enterTransaction()}commitTransaction(){this.assertNotDisposed();const[e,t]=this.popTransaction();if(this.editor.exitTransaction(),0===t.length)return;const n=t.map((e=>{let{change:t}=e;return{change:t,revision:void 0}})),r=this.changeFamily.rebaser.compose(n),i=_e(e,{revision:this.mintRevisionTag(),change:r}),s={type:"replace",change:void 0,removedCommits:t,newCommits:[i]};return this.emit("beforeChange",s),this.head=i,this.isTransacting()||this.emit("revertible",this.makeSharedTreeRevertible(i,vo.Default)),this.emit("afterChange",s),[t,i]}abortTransaction(){this.assertNotDisposed();const[e,t]=this.popTransaction();if(this.editor.exitTransaction(),0===t.length)return[void 0,[]];const n=[];for(let s=t.length-1;s>=0;s--){const e=this.changeFamily.rebaser.invert(t[s],!1);n.push(xo(e,this.mintRevisionTag(),t[s].revision))}const r=n.length>0?this.changeFamily.rebaser.compose(n):void 0,i={type:"remove",change:void 0===r?void 0:Eo(r),removedCommits:t};return this.emit("beforeChange",i),this.head=e,this.emit("afterChange",i),[r,t]}isTransacting(){return 0!==this.transactions.size}popTransaction(){const{startRevision:e}=this.transactions.pop();let t=e;for(;this.initialTransactionRevToRebasedRev.has(t);)t=this.initialTransactionRevToRebasedRev.get(t);this.isTransacting()||this.initialTransactionRevToRebasedRev.clear();const n=[],r=Ao([this.head,n],(e=>e.revision===t));return(0,i.v)(void 0!==r,1427),[r,n]}revertibleCommits(){return this._revertibleCommits.keys()}updateRevertibleCommit(e){void 0!==this._revertibleCommits.get(e.revision)&&this._revertibleCommits.set(e.revision,e)}makeSharedTreeRevertible(e,t){this._revertibleCommits.set(e.revision,e);let n=!1;const r={kind:t,origin:{isLocal:!0},revert:()=>{n&&T("revertible has already been discarded");return void 0!==this.revert(e.revision,t)?(r.discard(),yo.Success):yo.Failure},discard:()=>(n&&T("revertible has already been discarded"),this._revertibleCommits.delete(e.revision),this.revertibles.delete(r),n=!0,this.emit("revertibleDispose",e.revision),bo.Success)};return this.revertibles.add(r),r}revert(e,t){(0,i.v)(!this.isTransacting(),1995);const n=this._revertibleCommits.get(e);(0,i.v)(void 0!==n,1996);let r=this.changeFamily.rebaser.invert(Co(n.change,e),!1);const s=this.getHead();if(e!==s.revision){const e=[],t=Do([n],[s,e]);(0,i.v)(t===n,1655),r=No(this.changeFamily.rebaser,r,e)}return this.applyChange(r,this.mintRevisionTag(),t===vo.Default||t===vo.Redo?vo.Undo:vo.Redo)}fork(){this.assertNotDisposed();const e=new Ro(this.head,this.changeFamily,this.mintRevisionTag);return this.emit("fork",e),e}rebaseOnto(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.getHead();this.assertNotDisposed();const n=this.rebaseBranch(this,e,t);if(void 0===n)return;const{newSourceHead:r,commits:i}=n,{deletedSourceCommits:s,targetCommits:o,sourceCommits:a}=i;for(const d of o)this.updateRevertibleCommit(d);const c=o.concat(a);if(this.isTransacting()){var l,u;const e=null===(l=o[0].parent)||void 0===l?void 0:l.revision,t=null===(u=o.at(-1))||void 0===u?void 0:u.revision;void 0!==e&&void 0!==t&&this.initialTransactionRevToRebasedRev.set(e,t)}const h={type:"replace",get change(){const e=n.sourceChange;return void 0===e?void 0:Eo(e)},removedCommits:s,newCommits:c};return this.emit("beforeChange",h),this.head=r,a.forEach((e=>{this.updateRevertibleCommit(e)})),this.emit("afterChange",h),n}merge(e){this.assertNotDisposed(),e.assertNotDisposed(),(0,i.v)(!e.isTransacting(),1431);const t=this.rebaseBranch(e,this);if(void 0===t)return;const n=t.commits.sourceCommits,r=this.changeFamily.rebaser.compose(n),s=Eo(r),o={type:"append",get change(){return s},newCommits:n};return this.emit("beforeChange",o),this.head=t.newSourceHead,this.emit("afterChange",o),[r,n]}rebaseBranch(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.getHead();const{head:r}=e;if(r===n)return;const s=function(e,t,n,r){let s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:r;const o=[],a=[],c=Do([n,o],[s,a]);(0,i.v)(void 0!==c,1653);const l=a.findIndex((e=>e===r));if(-1===l)return(0,i.v)(void 0!==Do(r,s),1654),{newSourceHead:n,sourceChange:void 0,commits:{deletedSourceCommits:[],targetCommits:[],sourceCommits:o}};const u=new Set(o.map((e=>e.revision)));let h=l;for(let i=0;i<a.length;i+=1){const{revision:e}=a[i];if(u.has(e))u.delete(e),h=Math.max(h,i);else if(i>l)break}const d=a[h],f=a.slice(0,h+1),p=[...o],m=[...f],g=Math.min(o.length,m.length);for(let i=0;i<g;i++)o[0].revision===m[0].revision&&(o.shift(),m.shift());const v=[];if(0===m.length){var y;for(const e of o){var b;v.push(_e(null!==(b=v[v.length-1])&&void 0!==b?b:d,e))}return{newSourceHead:null!==(y=v[v.length-1])&&void 0!==y?y:d,sourceChange:void 0,commits:{deletedSourceCommits:p,targetCommits:f,sourceCommits:v}}}let S=d;const w=ko(Fo(m));let C=Eo(t.compose(m));for(const i of o){const n=[xo(t.invert(i,!0),e(),i.revision),C];if(u.has(i.revision)){const e=t.rebase(i.change,C,w);S={revision:i.revision,change:e,parent:S},v.push(S),n.push(Co(e,i.revision))}C=Eo(t.compose(n))}return{newSourceHead:S,sourceChange:C.change,commits:{deletedSourceCommits:p,targetCommits:f,sourceCommits:v}}}(this.mintRevisionTag,this.changeFamily.rebaser,r,n,t.getHead());return this.head!==s.newSourceHead?s:void 0}dispose(){if(!this.disposed){for(;this.isTransacting();)this.abortTransaction();this.revertibles.forEach((e=>e.discard())),this.disposed=!0,this.emit("dispose")}}assertNotDisposed(){(0,i.v)(!this.disposed,1646)}}function Mo(e,t){const n=[];return n.push(e.on("fork",(e=>{n.push(Mo(e,t)),t(e)}))),()=>n.forEach((e=>e()))}function Bo(e,t){const n=new Pt;return n.addBlob(e,t),n.getSummaryTree()}const Lo={additionalProperties:!1},qo=e=>m.ZU.Object({revision:Le,change:e,sessionId:Be}),_o=e=>m.ZU.Composite([qo(e)],Lo),jo=W({multipleOf:1}),zo=m.ZU.Object({sequenceNumber:jo,indexInBatch:m.ZU.Optional(m.ZU.Number({multipleOf:1,minimum:0}))}),Uo=e=>m.ZU.Composite([qo(e),zo],Lo),Ho=e=>m.ZU.Object({base:Le,commits:m.ZU.Array(_o(e))},Lo);function Vo(e,t,n){var r;const i=(s=null!==(r=e.json.encodedSchema)&&void 0!==r?r:D,m.ZU.Object({version:m.ZU.Literal(1),trunk:m.ZU.Array(Uo(s)),branches:m.ZU.Array(m.ZU.Tuple([Be,Ho(s)]))},Lo));var s;const o=(n,r)=>({...n,revision:t.encode(n.revision,n.sessionId),change:e.json.encode(n.change,r)}),a=(n,r)=>({...n,revision:t.decode(n.revision,n.sessionId),change:e.json.decode(n.change,r)});return Re(n,new Set([1]),i,{encode:e=>({trunk:e.trunk.map((e=>o(e,{originatorId:e.sessionId}))),branches:Array.from(e.branches.entries(),(e=>{let[n,r]=e;return[n,{base:t.encode(r.base,n),commits:r.commits.map((e=>o(e,{originatorId:e.sessionId})))}]})),version:1}),decode:e=>({trunk:e.trunk.map((e=>a(e,{originatorId:e.sessionId}))),branches:new Map(A(e.branches,(e=>{let[n,r]=e;return[n,{base:t.decode(r.base,n),commits:r.commits.map((e=>a(e,{originatorId:e.sessionId})))}]})))})})}const Ko="String";class Go{constructor(e,t,n){this.editManager=e,this.key="EditManager";const r=this.editManager.changeFamily.codecs.resolve(0);this.codec=Vo(r,t,n)}getAttachSummary(e,t,n,r){return this.summarizeCore(e)}async summarize(e,t,n,r){return this.summarizeCore(e)}summarizeCore(e){const t=e(this.codec.encode(this.editManager.getSummaryData()));return Bo(Ko,t)}getGCData(e){return{gcNodes:{}}}async load(e,t){const n=await e.readBlob(Ko);(0,i.v)(this.editManager.isEmpty(),1068);const r=t((0,Ne.JR)(n,"utf-8")),s=this.codec.decode(r);this.editManager.loadSummaryData(s)}}const Wo=(e,t)=>{var n,r;return e.sequenceNumber!==t.sequenceNumber?e.sequenceNumber-t.sequenceNumber:(null!==(n=e.indexInBatch)&&void 0!==n?n:0)-(null!==(r=t.indexInBatch)&&void 0!==r?r:0)},Jo=(e,t)=>Wo(e,t)<0?e:t,Zo=e=>void 0!==e.indexInBatch?{sequenceNumber:e.sequenceNumber,indexInBatch:e.indexInBatch-1}:{sequenceNumber:e.sequenceNumber-1},$o=Number.MIN_SAFE_INTEGER,Qo={sequenceNumber:$o};class Xo{constructor(e,t,n){this.changeFamily=e,this.localSessionId=t,this.mintRevisionTag=n,this.trunkMetadata=new Map,this.sequenceMap=new p.Pb(void 0,Wo),this.peerLocalBranches=new Map,this.trunkBranches=new p.Pb(void 0,Wo),this.minimumSequenceNumber=$o,this.trunkBase={revision:"root",change:e.rebaser.compose([])},this.sequenceMap.set(Qo,this.trunkBase),this.trunk=new Ro(this.trunkBase,e,n),this.localBranch=new Ro(this.trunk.getHead(),e,n),this.localBranch.on("revertibleDispose",this.onRevertibleDisposed()),Mo(this.localBranch,(e=>this.registerBranch(e)))}registerBranch(e){const t=e=>{var t,n,r;const s=null!==(t=Do(this.trunk.getHead(),e.getHead()))&&void 0!==t?t:T("Expected branch to be related to trunk"),o=null!==(n=null===(r=this.trunkMetadata.get(s.revision))||void 0===r?void 0:r.sequenceId)&&void 0!==n?n:Qo,a=F(this.trunkBranches,o,(()=>new Set));return(0,i.v)(!a.has(e),1648),a.add(e),o},n=(e,t)=>{var n;const r=null!==(n=this.trunkBranches.get(t))&&void 0!==n?n:T("Expected branch to be tracked");(0,i.v)(r.delete(e),1649),0===r.size&&this.trunkBranches.delete(t)},r={sequenceId:t(e)},s=e.on("afterChange",(i=>{"replace"===i.type&&"rebase"===Po(i)&&(n(e,r.sequenceId),r.sequenceId=t(e),this.trimTrunk())})),o=e.on("dispose",(()=>{n(e,r.sequenceId),this.trimTrunk(),s(),o()}))}getOldestRevertibleSequenceId(){if(void 0===this._oldestRevertibleSequenceId){let n;for(const r of this.localBranch.revertibleCommits())if(void 0===n){var e;n=null===(e=this.trunkMetadata.get(r))||void 0===e?void 0:e.sequenceId}else{var t;const e=null===(t=this.trunkMetadata.get(r))||void 0===t?void 0:t.sequenceId;void 0!==e&&(n=Jo(n,e))}this._oldestRevertibleSequenceId=n}return this._oldestRevertibleSequenceId}onRevertibleDisposed(){return e=>{const t=this.trunkMetadata.get(e);if(void 0!==t){const{sequenceId:e}=t;e===this._oldestRevertibleSequenceId&&(this._oldestRevertibleSequenceId=void 0)}}}advanceMinimumSequenceNumber(e){e!==this.minimumSequenceNumber&&((0,i.v)(e>this.minimumSequenceNumber,1142),this.minimumSequenceNumber=e,this.trimTrunk())}trimTrunk(){var e;let t={sequenceNumber:this.minimumSequenceNumber,indexInBatch:Number.POSITIVE_INFINITY};const n=this.trunkBranches.minKey();if(void 0!==n){const e=Zo(n);t=Jo(t,e)}const r=this.getOldestRevertibleSequenceId();if(void 0!==r){const e=Zo(r);t=Jo(t,e)}const[s,o]=this.getClosestTrunkCommit((a=t,c=null!==(e=this.sequenceMap.minKey())&&void 0!==e?e:Qo,Wo(a,c)>0?a:c));var a,c;if(o!==this.trunkBase){for(const[,n]of this.peerLocalBranches)n.rebaseOnto(this.trunk,o);const e=o;this.trunkMetadata.delete(e.revision),e.revision=this.trunkBase.revision,e.change=this.trunkBase.change,delete e.parent,this.trunkBase=e,this.sequenceMap.editRange(Qo,s,!0,((t,n)=>{let{revision:r}=n;if(this.trunkMetadata.delete(r),!((e,t)=>0===Wo(e,t))(t,s))return{delete:!0};(0,i.v)(r===e.revision,1833)}));const t=Yo(this.trunk.getHead(),this.trunkBase).length;(0,i.v)(this.sequenceMap.size===t+1,1860),(0,i.v)(this.trunkMetadata.size===t,1861)}}isEmpty(){return this.trunk.getHead()===this.trunkBase&&0===this.peerLocalBranches.size&&this.localBranch.getHead()===this.trunk.getHead()&&this.minimumSequenceNumber===$o}getSummaryData(){(0,i.v)(this.localBranch.getHead()===this.trunk.getHead(),1064);return{trunk:Yo(this.trunk.getHead(),this.trunkBase).map((e=>{var t;const n=null!==(t=this.trunkMetadata.get(e.revision))&&void 0!==t?t:T("Expected metadata for trunk commit"),r={change:e.change,revision:e.revision,sequenceNumber:n.sequenceId.sequenceNumber,sessionId:n.sessionId};return void 0!==n.sequenceId.indexInBatch&&(r.indexInBatch=n.sequenceId.indexInBatch),r})),branches:new Map(A(this.peerLocalBranches.entries(),(e=>{var t;let[n,r]=e;const i=[],s=null!==(t=Do([r.getHead(),i],this.trunk.getHead()))&&void 0!==t?t:T("Expected branch to be based on trunk");return[n,{base:s.revision,commits:i.map((e=>({change:e.change,revision:e.revision,sessionId:n})))}]})))}}loadSummaryData(e){(0,i.v)(this.isEmpty(),1674);const t=new Map;t.set(this.trunkBase.revision,this.trunkBase),this.trunk.setHead(e.trunk.reduce(((e,n)=>{const r=void 0===n.indexInBatch?{sequenceNumber:n.sequenceNumber}:{sequenceNumber:n.sequenceNumber,indexInBatch:n.indexInBatch},i=_e(e,n);return this.sequenceMap.set(r,i),this.trunkMetadata.set(n.revision,{sequenceId:r,sessionId:n.sessionId}),t.set(n.revision,i),i}),this.trunkBase)),this.localBranch.setHead(this.trunk.getHead());for(const[r,i]of e.branches){var n;const e=null!==(n=t.get(i.base))&&void 0!==n?n:T("Expected summary branch to be based off of a revision in the trunk");this.peerLocalBranches.set(r,new Ro(i.commits.reduce(_e,e),this.changeFamily,this.mintRevisionTag))}}getTrunkChanges(){return Yo(this.trunk.getHead(),this.trunkBase).map((e=>e.change))}getTrunkHead(){return this.trunk.getHead()}getLocalChanges(){return Yo(this.localBranch.getHead(),this.trunk.getHead()).map((e=>e.change))}getLongestBranchLength(){let e=0;const t=this.trunk.getHead();for(const r of this.peerLocalBranches.values()){const n=Yo(r.getHead(),t);n.length>e&&(e=n.length)}const n=Yo(this.localBranch.getHead(),t);return Math.max(e,n.length)}addSequencedChange(e,t,n){(0,i.v)(t>this.minimumSequenceNumber,1811);const r=this.getBatch(t),s=0===r.length?{sequenceNumber:t}:{sequenceNumber:t,indexInBatch:r.length};if(e.sessionId===this.localSessionId){const[e]=Yo(this.localBranch.getHead(),this.trunk.getHead());return(0,i.v)(void 0!==e,1717),this.pushToTrunk(s,{...e,sessionId:this.localSessionId},!0),void this.localBranch.rebaseOnto(this.trunk)}const[,o]=this.getClosestTrunkCommit(n),a=F(this.peerLocalBranches,e.sessionId,(()=>new Ro(o,this.changeFamily,this.mintRevisionTag)));if(a.rebaseOnto(this.trunk,o),a.getHead()===this.trunk.getHead())this.pushToTrunk(s,e),a.setHead(this.trunk.getHead());else{const t=To(this.changeFamily.rebaser,e.change,a.getHead(),this.trunk.getHead(),this.mintRevisionTag);a.apply(e.change,e.revision),this.pushToTrunk(s,{...e,change:t})}this.localBranch.rebaseOnto(this.trunk)}findLocalCommit(e){const t=[],n=Ao([this.localBranch.getHead(),t],(t=>t.revision===e));return(0,i.v)(void 0!==n,1433),[n,t]}pushToTrunk(e,t){const n=_e(this.trunk.getHead(),t);this.trunk.setHead(n),this.localBranch.updateRevertibleCommit(n);const r=this.trunk.getHead();this.sequenceMap.set(e,r),this.trunkMetadata.set(r.revision,{sequenceId:e,sessionId:t.sessionId})}getClosestTrunkCommit(e){const t="number"===typeof e?{sequenceNumber:e,indexInBatch:Number.POSITIVE_INFINITY}:e,n=this.sequenceMap.getPairOrNextLower(t);return(0,i.v)(void 0!==n,1862),n}getBatch(e){const t={sequenceNumber:e},n={sequenceNumber:e+1};return this.sequenceMap.getRange(t,n,!1)}}function Yo(e,t){const n=[];return(0,i.v)(void 0!==Do([e,n],t),1395),n}function ea(e,t,n){var r,i;return Oe((i=null!==(r=e.encodedSchema)&&void 0!==r?r:m.ZU.Any(),m.ZU.Object({revision:Le,originatorId:Be,changeset:i})),{encode:n=>{let{commit:r,sessionId:i}=n;return{revision:t.encode(r.revision,i),originatorId:i,changeset:e.encode(r.change,{originatorId:i})}},decode:n=>{const{revision:r,originatorId:i,changeset:s}=n;return{commit:{revision:t.decode(r,i),change:e.decode(s,{originatorId:i})},sessionId:i}}},n.jsonValidator)}const ta="indexes";class na extends go{get editor(){return this.getLocalBranch().editor}constructor(e,t,n,r,s,o,a){super(r,s,o,a),this.submitOps=!0,this.detachedRevision=$o,(0,i.v)(void 0!==s.idCompressor,2182),this.idCompressor=s.idCompressor;const c=s.idCompressor.localSessionId;this.editManager=new Xo(t,c,(()=>this.idCompressor.generateCompressedId())),this.editManager.localBranch.on("afterChange",(e=>{if(!this.getLocalBranch().isTransacting())switch(e.type){case"append":for(const t of e.newCommits)this.submitCommit(t);break;case"replace":"transactionCommit"===Po(e)&&this.submitCommit(e.newCommits[0])}}));const l=new Me(s.idCompressor);this.summarizables=[new Go(this.editManager,l,n),...e],(0,i.v)(new Set(this.summarizables.map((e=>e.key))).size===this.summarizables.length,848),this.messageCodec=ea(t.codecs.resolve(0).json,new Me(s.idCompressor),n)}summarizeCore(e,t,n){const r=new Pt,i=new Pt;for(const s of this.summarizables)i.addWithStats(s.key,s.getAttachSummary((t=>e.stringify(t,this.handle)),void 0,void 0,t,n));return r.addWithStats(ta,i.getSummaryTree()),r.getSummaryTree()}async loadCore(e){const t=this.summarizables.map((async t=>t.load(function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];const i="".concat(n.join("/"),"/");return{readBlob:async t=>e.readBlob("".concat(i).concat(t)),contains:async t=>e.contains("".concat(i).concat(t)),list:async t=>e.list("".concat(i).concat(t))}}(e,ta,t.key),(e=>this.serializer.parse(e)))));await Promise.all(t)}submitCommit(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this.submitOps)return;if((0,i.v)(!this.getLocalBranch().isTransacting()||t,1675),void 0!==this.detachedRevision){const t=this.detachedRevision+1;this.detachedRevision=t,this.editManager.addSequencedChange({...e,sessionId:this.editManager.localSessionId},t,this.detachedRevision)}const n=this.messageCodec.encode({commit:e,sessionId:this.editManager.localSessionId});this.submitLocalMessage(this.serializer.encode(n,this.handle))}processCore(e,t,n){const r=this.serializer.decode(e.contents),{commit:i,sessionId:s}=this.messageCodec.decode(r);this.editManager.addSequencedChange({...i,sessionId:s},e.sequenceNumber,e.referenceSequenceNumber),this.editManager.advanceMinimumSequenceNumber(e.minimumSequenceNumber)}getLocalBranch(){return this.editManager.localBranch}onDisconnect(){}didAttach(){void 0!==this.detachedRevision&&(this.detachedRevision=void 0)}reSubmitCore(e,t){const{commit:{revision:n}}=this.messageCodec.decode(e),[r]=this.editManager.findLocalCommit(n);this.submitCommit(r,!0)}applyStashedOp(e){(0,i.v)(!this.getLocalBranch().isTransacting(),1652);const{commit:{revision:t,change:n}}=this.messageCodec.decode(e);this.submitOps=!1,this.editManager.localBranch.apply(n,t),this.submitOps=!0}getGCData(e){const t=super.getGCData(e).gcNodes;for(const r of this.summarizables)for(const[i,s]of Object.entries(r.getGCData(e).gcNodes)){var n;null!==(n=t[i])&&void 0!==n||(t[i]=[]);for(const e of s)t[i].push(e)}return{gcNodes:t}}}let ra=0;class ia{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.refCount=e}referenceAdded(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.refCount+=e}referenceRemoved(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.refCount-=e,(0,i.v)(this.refCount>=0,1220),0===this.refCount&&this.dispose()}isShared(){return this.refCount>1}isUnreferenced(){return 0===this.refCount}}function sa(){return ra++}class oa{constructor(){this.events=z(),this.anchorCounter=1,this.generationNumber=0,this.root=new ca(this,ft,0,void 0),this.anchorToPath=new Map,this.on("treeChanging",(()=>{this.generationNumber+=1}))}on(e,t){return this.events.on(e,t)}isEmpty(){return 0===this.root.children.size}locate(e){if(0===e)return;const t=this.anchorToPath.get(e);return(0,i.v)(void 0!==t,934),t.status===aa.Alive?t:void 0}forget(e){if(0!==e){const t=this.anchorToPath.get(e);(0,i.v)(void 0!==t,849),t.removeRef(),this.anchorToPath.delete(e)}}track(e){if(null===e)return 0;const t=this.trackInner(e),n=this.anchorCounter++;return this.anchorToPath.set(n,t),n}trackInner(e){var t;if(e instanceof ca&&e.anchorSet===this)return e.addRef(),e;const n=null!==(t=e.parent)&&void 0!==t?t:this.root,r=this.trackInner(n),i=r.getOrCreateChild(e.parentField,e.parentIndex);return r.removeRef(),i}find(e){var t;if(e instanceof ca&&e.anchorSet===this)return e;const n=null!==(t=e.parent)&&void 0!==t?t:this.root,r=this.find(n);return null===r||void 0===r?void 0:r.tryGetChild(e.parentField,e.parentIndex)}internalizePath(e){var t;let n=e;const r=[];for(;void 0!==n&&!(n instanceof ca&&n.anchorSet===this);)r.push(n),n=n.parent;let i;for(;void 0!==(i=r.pop());){if(void 0===n||n instanceof ca){var s;const e=(null!==(s=n)&&void 0!==s?s:this.root).tryGetChild(i.parentField,i.parentIndex);if(void 0!==e){n=e;continue}}n=n!==i.parent||i instanceof ca?{parent:n,parentField:i.parentField,parentIndex:i.parentIndex}:i}return null!==(t=n)&&void 0!==t?t:T("internalize path must be a path")}deepDelete(e){const t=[...e];for(;t.length>0;){const e=t.pop();(0,i.v)(e.status===aa.Alive,1032),e.status=aa.Dangling,e.events.emit("afterDestroy",e);for(const n of e.children.values())t.push(...n)}}decoupleNodes(e,t){var n,r;(0,i.v)(t>0,1665);const s=this.find(null!==(n=e.parent)&&void 0!==n?n:this.root),o=null===s||void 0===s||null===(r=s.children)||void 0===r?void 0:r.get(e.parentField);let a=[];if(void 0!==o){let n=0,r=0,i=0;for(;i<o.length&&o[i].parentIndex<e.parentIndex;)n++,i++;for(;i<o.length&&o[i].parentIndex<e.parentIndex+t;)r++,i++;for(;i<o.length;)o[i].parentIndex-=t,i++;a=o.splice(n,r),0===o.length&&s.afterEmptyField(e.parentField)}return a}coupleNodes(e,t,n){var r;(0,i.v)(n.nodes.length>0,1666);const s=this.trackInner(null!==(r=e.parent)&&void 0!==r?r:this.root);for(const i of n.nodes)i.parentIndex+=e.parentIndex-n.startParentIndex,i.parentPath=s,i.parentField=e.parentField;const o=s.children.get(e.parentField);if(void 0===o)s.children.set(e.parentField,n.nodes);else{const r=this.increaseParentIndexes(o,e.parentIndex,t);o.splice(r,0,...n.nodes)}s.removeRef()}increaseParentIndexes(e,t,n){let r=0;for(;r<e.length&&e[r].parentIndex<t;)r++;const i=r;for(;r<e.length;)e[r].parentIndex+=n,r++;return i}moveChildren(e,t,n){const r=this.decoupleNodes(e,n);r.length>0?this.coupleNodes(t,n,{startParentIndex:e.parentIndex,nodes:r}):this.offsetChildren(t,n)}removeChildren(e,t){const n=this.decoupleNodes(e,t);this.deepDelete(n)}offsetChildren(e,t){var n;const r=this.find(null!==(n=e.parent)&&void 0!==n?n:this.root),i=null===r||void 0===r?void 0:r.children.get(e.parentField);void 0!==i&&this.increaseParentIndexes(i,e.parentIndex,t)}acquireVisitor(){(0,i.v)(void 0===this.activeVisitor,1895);const e={anchorSet:this,maybeWithNode(e,t){void 0===this.parent&&void 0!==t?t():((0,i.v)(void 0!==this.parent,1456),this.parent=this.anchorSet.internalizePath(this.parent),this.parent instanceof ca&&e(this.parent))},withParentNodeUpToRoot(e){(0,i.v)(void 0!==this.parentField,1997);let t=this.parent;for(;void 0!==t;)t instanceof ca&&e(t),t=t.parent},pathVisitors:new Map,parentField:void 0,parent:void 0,free(){(0,i.v)(void 0!==this.anchorSet.activeVisitor,1896),this.anchorSet.activeVisitor=void 0},notifyChildrenChanging(){this.maybeWithNode((e=>e.events.emit("childrenChanging",e)),(()=>this.anchorSet.events.emit("childrenChanging",this.anchorSet)))},notifyChildrenChanged(){this.maybeWithNode((e=>e.events.emit("childrenChanged",e)),(()=>{}))},beforeAttach(e,t,n){(0,i.v)(void 0!==this.parentField,1952);const r={parent:this.parent,field:this.parentField,index:n},s={field:e,start:0,end:t};this.withParentNodeUpToRoot((e=>{e.events.emit("beforeChange",e)}));for(const i of this.pathVisitors.values())for(const e of i)e.beforeAttach(s,r)},afterAttach(e,t){(0,i.v)(void 0!==this.parentField,1953);const n={field:e,index:0},r={parent:this.parent,field:this.parentField,...t};this.withParentNodeUpToRoot((e=>{e.events.emit("afterChange",e)}));for(const i of this.pathVisitors.values())for(const e of i)e.afterAttach(n,r)},attach(e,t,n){this.notifyChildrenChanging(),this.attachEdit(e,t,n),this.notifyChildrenChanged()},attachEdit(e,t,n){(0,i.v)(void 0!==this.parentField,1954);const r={parent:this.anchorSet.root,parentField:e,parentIndex:0},s={parent:this.parent,parentField:this.parentField,parentIndex:n};this.anchorSet.moveChildren(r,s,t)},beforeDetach(e,t){(0,i.v)(void 0!==this.parentField,1955);const n={parent:this.parent,field:this.parentField,...e},r={field:t,index:0};this.withParentNodeUpToRoot((e=>{e.events.emit("beforeChange",e)}));for(const i of this.pathVisitors.values())for(const e of i)e.beforeDetach(n,r)},afterDetach(e,t,n){(0,i.v)(void 0!==this.parentField,1956);const r={parent:this.parent,field:this.parentField,index:e},s={field:n,start:0,end:t};this.withParentNodeUpToRoot((e=>{e.events.emit("afterChange",e)}));for(const i of this.pathVisitors.values())for(const e of i)e.afterDetach(r,s)},detach(e,t){this.notifyChildrenChanging(),this.detachEdit(e,t),this.notifyChildrenChanged()},detachEdit(e,t){(0,i.v)(void 0!==this.parentField,1957);const n={parent:this.parent,parentField:this.parentField,parentIndex:e.start},r={parent:this.anchorSet.root,parentField:t,parentIndex:0};this.anchorSet.moveChildren(n,r,e.end-e.start)},beforeReplace(e,t,n){(0,i.v)(void 0!==this.parentField,1958);const r={parent:this.parent,field:this.parentField,...t},s={field:e,start:0,end:t.end-t.start},o={field:n,index:0};this.withParentNodeUpToRoot((e=>{e.events.emit("beforeChange",e)}));for(const i of this.pathVisitors.values())for(const e of i)e.beforeReplace(s,r,o)},afterReplace(e,t,n){(0,i.v)(void 0!==this.parentField,1959);const r={parent:this.parent,field:this.parentField,...t},s={field:e,index:0},o={field:n,start:0,end:t.end-t.start};this.withParentNodeUpToRoot((e=>{e.events.emit("afterChange",e)}));for(const i of this.pathVisitors.values())for(const e of i)e.afterReplace(s,r,o)},replace(e,t,n){this.notifyChildrenChanging(),this.detachEdit(t,n),this.attachEdit(e,t.end-t.start,t.start),this.notifyChildrenChanged()},destroy(e,t){this.anchorSet.removeChildren({parent:void 0,parentField:e,parentIndex:0},t)},beforeDestroy(e,t){const n={field:e,start:0,end:t};for(const r of this.pathVisitors.values())for(const e of r)e.beforeDestroy(n)},create(e,t){},afterCreate(e,t){for(const n of this.pathVisitors.values())for(const r of n){const n={field:t,start:0,end:e.length};r.afterCreate(n)}},enterNode(e){(0,i.v)(void 0!==this.parentField,939),this.parent={parent:this.parent,parentField:this.parentField,parentIndex:e},this.parentField=void 0,this.maybeWithNode((e=>{if(!this.pathVisitors.has(e)){const t=e.events.emitAndCollect("subtreeChanging",e);t.length>0&&this.pathVisitors.set(e,new Set(t.filter((e=>void 0!==e))))}}))},exitNode(e){(0,i.v)(void 0!==this.parent,940),this.maybeWithNode((e=>{this.pathVisitors.delete(e)}));const t=this.parent;this.parentField=t.parentField,this.parent=t.parent},enterField(e){this.parentField=e},exitField(e){this.parentField=void 0}};return this.events.emit("treeChanging",this),this.activeVisitor=e,e}}var aa;!function(e){e[e.Alive=0]="Alive",e[e.Disposed=1]="Disposed",e[e.Dangling=2]="Dangling"}(aa||(aa={}));class ca extends ia{constructor(e,t,n,r){super(1),this.anchorSet=e,this.parentField=t,this.parentIndex=n,this.parentPath=r,this.status=aa.Alive,this.events=z((()=>this.considerDispose())),this.children=new Map,this.slots=new Map}on(e,t){return this.events.on(e,t)}child(e,t){var n;return null!==(n=this.tryGetChild(e,t))&&void 0!==n?n:{parent:this,parentField:e,parentIndex:t}}getOrCreateChildRef(e,t){var n;const r=this.anchorSet.track(this.child(e,t));return[r,null!==(n=this.anchorSet.locate(r))&&void 0!==n?n:T("cannot reference child that does not exist")]}isRoot(){return void 0===this.parentPath}get parent(){if((0,i.v)(this.status!==aa.Disposed,1033),(0,i.v)(void 0!==this.parentPath,853),!this.parentPath.isRoot())return this.parentPath}addRef(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;(0,i.v)(this.status===aa.Alive,1034),this.referenceAdded(e)}removeRef(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;(0,i.v)(this.status!==aa.Disposed,1035),this.referenceRemoved(e)}dispose(){this.considerDispose()}getOrCreateChild(e,t){(0,i.v)(this.status===aa.Alive,1036);let n=this.children.get(e);void 0===n&&(n=[],this.children.set(e,n));let r=n.find((e=>e.parentIndex===t));return void 0===r?(r=new ca(this.anchorSet,e,t,this),n.push(r),n.sort(((e,t)=>e.parentIndex-t.parentIndex))):r.addRef(),r}tryGetChild(e,t){(0,i.v)(this.status===aa.Alive,1037);const n=this.children.get(e);return null===n||void 0===n?void 0:n.find((e=>e.parentIndex===t))}removeChild(e){var t;(0,i.v)(this.status===aa.Alive,1038);const n=e.parentField,r=this.children.get(n),s=null!==(t=null===r||void 0===r?void 0:r.indexOf(e))&&void 0!==t?t:-1;(0,i.v)(-1!==s,860),null===r||void 0===r||r.splice(s,1),0===(null===r||void 0===r?void 0:r.length)&&this.afterEmptyField(n)}afterEmptyField(e){(0,i.v)(this.status===aa.Alive,1039),this.children.delete(e),this.considerDispose()}considerDispose(){if((0,i.v)(this.status!==aa.Disposed,1053),this.isUnreferenced()&&0===this.children.size&&!this.events.hasListeners()){var e;if(this.status===aa.Alive)null===(e=this.parentPath)||void 0===e||e.removeChild(this);this.status=aa.Disposed}}}const la=Symbol("CursorMarker");function ua(e){return null!==e&&"object"===typeof e&&!0===e[la]}var ha,da,fa;function pa(e,t){const n=[];return ma(e,(e=>{n.push(t(e))})),n}function ma(e,t){(0,i.v)(0===e.mode,1041);for(let n=e.firstField();n;n=e.nextField())t(e)}function ga(e,t){const n=[];return ya(e,(e=>{n.push(t(e))})),n}function*va(e,t){(0,i.v)(1===e.mode,1960);for(let n=e.firstNode();n;n=e.nextNode())yield t(e)}function ya(e,t){(0,i.v)(1===e.mode,957);for(let n=e.firstNode();n;n=e.nextNode())t(e)}function ba(e,t,n){e.enterField(t);const r=n(e);return e.exitField(),r}function Sa(e,t,n){e.enterNode(t);const r=n(e);return e.exitNode(),r}function wa(e,t){return new xa(e,[],[],[t],0)}!function(e){e[e.Nodes=0]="Nodes",e[e.Fields=1]="Fields"}(ha||(ha={}));class Ca{constructor(){this[da]=!0,this.pending=!1}skipPendingFields(){return!0}}da=la;class xa extends Ca{constructor(e,t,n,r,i){super(),this.adapter=e,this.siblingStack=t,this.indexStack=n,this.siblings=r,this.index=i,this[fa]=!0,this.chunkLength=1}getFieldKey(){return this.siblings[this.index]}getStackedFieldKey(e){return(0,i.v)(e%2===1,952),this.siblingStack[e][this.indexStack[e]]}getStackedNodeIndex(e){return this.indexStack[e]}getStackedNode(e){const t=this.getStackedNodeIndex(e);return this.siblingStack[e][t]}getFieldLength(){return this.getField().length}enterNode(e){const t=this.getField();(0,i.v)(e in t,1029),this.siblingStack.push(this.siblings),this.indexStack.push(this.index),this.index=e,this.siblings=t}getPath(e){return(0,i.v)(0===this.mode,953),this.getOffsetPath(0,e)}getFieldPath(e){var t;return(0,i.v)(1===this.mode,1097),{field:1===this.indexStack.length&&null!==(t=null===e||void 0===e?void 0:e.rootFieldOverride)&&void 0!==t?t:this.getFieldKey(),parent:this.getOffsetPath(1,e)}}getOffsetPath(e,t){const n=this.indexStack.length-e;if(0===n)return null===t||void 0===t?void 0:t.parent;(0,i.v)(n>0,1098),(0,i.v)(n%2===0,1099);const r=e=>{let n=e===this.indexStack.length?this.index:this.getStackedNodeIndex(e);var r;void 0!==t&&2===e&&(n+=null!==(r=t.indexOffset)&&void 0!==r?r:0);return n};let s=null===t||void 0===t?void 0:t.parent;for(let i=2;i<=n;i+=2){const e=2===i?null===t||void 0===t?void 0:t.rootFieldOverride:void 0;s={parent:s,parentIndex:r(i),parentField:null!==e&&void 0!==e?e:this.getStackedFieldKey(i-1)}}return s}fork(){return new xa(this.adapter,[...this.siblingStack],[...this.indexStack],this.siblings,this.index)}enterField(e){this.siblingStack.push(this.siblings),this.indexStack.push(this.index),this.index=0,this.siblings=[e]}get mode(){return this.siblingStack.length%2===0?0:1}nextField(){return this.index+=1,this.index!==this.siblings.length||(this.exitField(),!1)}firstField(){const e=this.adapter.keysFromNode(this.getNode());return 0!==e.length&&(this.siblingStack.push(this.siblings),this.indexStack.push(this.index),this.index=0,this.siblings=e,!0)}seekNodes(e){return this.index+=e,this.index in this.siblings||(this.exitNode(),!1)}firstNode(){const e=this.getField();return 0!==e.length&&(this.siblingStack.push(this.siblings),this.indexStack.push(this.index),this.index=0,this.siblings=e,!0)}nextNode(){return(0,i.v)(0===this.mode,1030),this.index++,this.index<this.siblings.length||(this.exitNode(),!1)}exitField(){var e,t;this.siblings=null!==(e=this.siblingStack.pop())&&void 0!==e?e:T("Unexpected siblingStack.length"),this.index=null!==(t=this.indexStack.pop())&&void 0!==t?t:T("Unexpected indexStack.length")}exitNode(){var e,t;this.siblings=null!==(e=this.siblingStack.pop())&&void 0!==e?e:T("Unexpected siblingStack.length"),this.index=null!==(t=this.indexStack.pop())&&void 0!==t?t:T("Unexpected indexStack.length")}getNode(){return this.siblings[this.index]}getField(){const e=this.getStackedNode(this.indexStack.length-1),t=this.getFieldKey();return this.adapter.getFieldFromNode(e,t)}get value(){return this.adapter.value(this.getNode())}get type(){return this.adapter.type(this.getNode())}get fieldIndex(){return this.index}get chunkStart(){return this.fieldIndex}}function Ea(e,t){var n;return void 0===e||void 0===e.parent&&void 0===e.rootFieldOverride&&0===(null!==(n=e.indexOffset)&&void 0!==n?n:0)?t:ka(e,t)}function Ta(e,t){var n,r;return void 0===e||void 0===e.parent&&void 0===e.rootFieldOverride&&0===(null!==(n=e.indexOffset)&&void 0!==n?n:0)?t:{field:void 0===t.parent&&null!==(r=e.rootFieldOverride)&&void 0!==r?r:t.field,parent:Ea(e,t.parent)}}function ka(e,t){if(void 0===t)return e.parent;if(t instanceof Na){const n=function(e,t){if(void 0!==t.parent)return{parent:new Na(e,t.parent),rootFieldOverride:t.rootFieldOverride,indexOffset:t.indexOffset};var n,r,i;return{parent:e.parent,rootFieldOverride:null!==(n=e.rootFieldOverride)&&void 0!==n?n:t.rootFieldOverride,indexOffset:(null!==(r=t.indexOffset)&&void 0!==r?r:0)+(null!==(i=e.indexOffset)&&void 0!==i?i:0)}}(e,t.prefix);return new Na(n,t.path)}return new Na(e,t)}fa=la;class Na{constructor(e,t){var n,r;(this.prefix=e,this.path=t,void 0===t.parent)?(this.parentField=null!==(n=e.rootFieldOverride)&&void 0!==n?n:t.parentField,this.parentIndex=t.parentIndex+(null!==(r=e.indexOffset)&&void 0!==r?r:0)):(this.parentField=t.parentField,this.parentIndex=t.parentIndex)}get parent(){return ka(this.prefix,this.path.parent)}}const Fa=pt,Ia=Symbol("cursorChunk");function Aa(e){return(0,i.v)(0===e.mode,1403),e[Ia]}class Da extends ia{constructor(e,t,n){super(),this.type=e,this.fields=t,this.value=n,this.topLevelLength=1}clone(){const e=new Map;for(const[t,n]of this.fields){const r=n.map((e=>(e.referenceAdded(),e)));e.set(t,r)}return new Da(this.type,e,this.value)}cursor(){return new Oa([this],[],[],[],[],[Fa],0,0,0,void 0)}dispose(){for(const e of this.fields.values())for(const t of e)t.referenceRemoved()}}class Oa extends Ca{constructor(e,t,n,r,i,s,o,a,c,l){super(),this.root=e,this.siblingStack=t,this.indexStack=n,this.indexOfChunkStack=r,this.indexWithinChunkStack=i,this.siblings=s,this.index=o,this.indexOfChunk=a,this.indexWithinChunk=c,this.nestedCursor=l}get[Ia](){return void 0!==this.nestedCursor?this.nestedCursor[Ia]:((0,i.v)(0===this.mode,1402),this.siblings[this.indexOfChunk])}atChunkRoot(){return this.siblingStack.length<2&&(void 0===this.nestedCursor||this.nestedCursor.atChunkRoot())}fork(){var e;return new Oa(this.root,[...this.siblingStack],[...this.indexStack],[...this.indexOfChunkStack],[...this.indexWithinChunkStack],this.siblings,this.index,this.indexOfChunk,this.indexWithinChunk,null===(e=this.nestedCursor)||void 0===e?void 0:e.fork())}get mode(){if(void 0!==this.nestedCursor)return this.nestedCursor.mode;const e=this.siblingStack.length+1>>1;return(0,i.v)(this.indexOfChunkStack.length===e,1308),(0,i.v)(this.indexWithinChunkStack.length===e,1309),this.siblingStack.length%2===0?1:0}getFieldKey(){return void 0!==this.nestedCursor?this.nestedCursor.getFieldKey():((0,i.v)(1===this.mode,1310),this.siblings[this.index])}getStackedFieldKey(e){return(0,i.v)(e%2===0,1311),this.siblingStack[e][this.indexStack[e]]}getStackedNodeIndex(e){return(0,i.v)(e%2===1,1312),(0,i.v)(e>=0,1313),this.indexStack[e]}getStackedNode(e){const t=this.getStackedNodeIndex(e);return this.siblingStack[e][t]}getFieldLength(){if(void 0!==this.nestedCursor)return this.nestedCursor.getFieldLength();(0,i.v)(1===this.mode,1314);let e=0;for(const t of this.getField())e+=t.topLevelLength;return e}enterNode(e){if(void 0!==this.nestedCursor)return void this.nestedCursor.enterNode(e);const t=this.firstNode()&&this.seekNodes(e);(0,i.v)(t,1315)}getPath(e){var t;if(void 0!==this.nestedCursor)return null!==(t=this.nestedCursor.getPath(this.nestedPathPrefix(e)))&&void 0!==t?t:T("nested cursors should not be root");(0,i.v)(0===this.mode,1316);const n=this.getOffsetPath(0,e);return(0,i.v)(void 0!==n,1372),n}nestedPathPrefix(e){var t;const n=null!==(t=this.getOffsetPath(0,e))&&void 0!==t?t:T("nested cursors should not be root");return{indexOffset:n.parentIndex-this.indexWithinChunk,rootFieldOverride:n.parentField,parent:n.parent}}getFieldPath(e){var t;return void 0!==this.nestedCursor?this.nestedCursor.getFieldPath(this.nestedPathPrefix(e)):((0,i.v)(1===this.mode,1317),{field:1===this.indexStack.length&&null!==(t=null===e||void 0===e?void 0:e.rootFieldOverride)&&void 0!==t?t:this.getFieldKey(),parent:this.getOffsetPath(1,e)})}getOffsetPath(e,t){const n=this.indexStack.length-e;if(-1===n)return null===t||void 0===t?void 0:t.parent;let r;function s(e){r=void 0===r?Ea(t,e):e}(0,i.v)(n>0,1318),(0,i.v)(n%2===1,1319);for(let i=1;i<n;i+=2){const e=this.getStackedFieldKey(i-1);s({parent:r,parentIndex:this.getStackedNodeIndex(i),parentField:e})}return s({parent:r,parentIndex:0===e?this.index:this.getStackedNodeIndex(n),parentField:this.getStackedFieldKey(n-1)}),r}enterField(e){void 0===this.nestedCursor?((0,i.v)(0===this.mode,1320),this.siblingStack.push(this.siblings),this.indexStack.push(this.index),this.index=0,this.siblings=[e]):this.nestedCursor.enterField(e)}nextField(){return void 0!==this.nestedCursor?this.nestedCursor.nextField():(this.index+=1,this.index!==this.siblings.length||(this.exitField(),!1))}firstField(){if(void 0!==this.nestedCursor)return this.nestedCursor.firstField();const e=this.getNode().fields;return 0!==e.size&&(this.siblingStack.push(this.siblings),this.indexStack.push(this.index),this.index=0,this.siblings=[...e.keys()],!0)}seekNodes(e){if(void 0!==this.nestedCursor){const t=this.nestedCursor.atChunkRoot(),n=this.nestedCursor.seekNodes(e);if(!t)return n;n||(this.nestedCursor=void 0)}if((0,i.v)(0===this.mode,1321),(0,i.v)(this.indexOfChunk<this.siblings.length,1322),this.indexWithinChunk+=e,e>=0){const e=this.siblings;for(;this.indexWithinChunk>=e[this.indexOfChunk].topLevelLength;){if(this.indexWithinChunk-=e[this.indexOfChunk].topLevelLength,this.indexOfChunk++,this.indexOfChunk===e.length)return this.exitNode(),!1;(0,i.v)(this.indexOfChunk<this.siblings.length,1323)}}else{const e=this.siblings;for(;this.indexWithinChunk<0;){if(0===this.indexOfChunk)return this.exitNode(),!1;this.indexOfChunk--,this.indexWithinChunk+=e[this.indexOfChunk].topLevelLength}}return this.index+=e,this.initNestedCursor(),!0}firstNode(){if(void 0!==this.nestedCursor)return this.nestedCursor.firstNode();const e=this.getField();return 0!==e.length&&(this.siblingStack.push(this.siblings),this.indexStack.push(this.index),this.indexOfChunkStack.push(this.indexOfChunk),this.indexWithinChunkStack.push(this.indexWithinChunk),this.index=0,this.siblings=e,this.indexOfChunk=0,this.indexWithinChunk=0,this.initNestedCursor(),!0)}nextNode(){if(void 0!==this.nestedCursor){const e=this.nestedCursor.atChunkRoot(),t=this.nestedCursor.nextNode();if(!e)return t;t||(this.nestedCursor=void 0)}if((0,i.v)(0===this.mode,1324),this.indexWithinChunk++,this.indexWithinChunk===this.siblings[this.indexOfChunk].topLevelLength){if(this.indexOfChunk++,this.indexOfChunk===this.siblings.length)return this.exitNode(),!1;this.indexWithinChunk=0,this.initNestedCursor()}return this.index++,!0}initNestedCursor(){var e;(0,i.v)(0===this.mode,1373);const t=this.siblings[this.indexOfChunk];this.nestedCursor=t instanceof Da?void 0:t.cursor(),null===(e=this.nestedCursor)||void 0===e||e.enterNode(this.indexWithinChunk)}exitField(){var e,t;if(void 0!==this.nestedCursor)return this.nestedCursor.exitField();(0,i.v)(1===this.mode,1325),this.siblings=null!==(e=this.siblingStack.pop())&&void 0!==e?e:T("Unexpected siblingStack.length"),this.index=null!==(t=this.indexStack.pop())&&void 0!==t?t:T("Unexpected indexStack.length")}exitNode(){var e,t,n,r;if(void 0!==this.nestedCursor){if(!this.nestedCursor.atChunkRoot())return this.nestedCursor.exitNode();this.nestedCursor=void 0}(0,i.v)(0===this.mode,1326),this.siblings=null!==(e=this.siblingStack.pop())&&void 0!==e?e:T("Unexpected siblingStack.length"),this.index=null!==(t=this.indexStack.pop())&&void 0!==t?t:T("Unexpected indexStack.length"),this.indexOfChunk=null!==(n=this.indexOfChunkStack.pop())&&void 0!==n?n:T("Unexpected indexOfChunkStack.length"),this.indexWithinChunk=null!==(r=this.indexWithinChunkStack.pop())&&void 0!==r?r:T("Unexpected indexWithinChunkStack.length")}getNode(){return(0,i.v)(0===this.mode,1327),this.siblings[this.index]}getField(){var e;if(0===this.siblingStack.length)return this.root;(0,i.v)(1===this.mode,1328);const t=this.getStackedNode(this.indexStack.length-1),n=this.getFieldKey();return null!==(e=t.fields.get(n))&&void 0!==e?e:[]}get value(){return void 0!==this.nestedCursor?this.nestedCursor.value:this.getNode().value}get type(){return void 0!==this.nestedCursor?this.nestedCursor.type:this.getNode().type}get fieldIndex(){return(0,i.v)(0===this.mode,1329),void 0!==this.nestedCursor?this.nestedCursor.atChunkRoot()?this.nestedCursor.fieldIndex+this.nestedOffset():this.nestedCursor.fieldIndex:this.index}nestedOffset(){return(0,i.v)(void 0!==this.nestedCursor,1374),(0,i.v)(!this.nestedCursor.atChunkRoot()||this.indexWithinChunk===this.nestedCursor.fieldIndex,1375),this.index-this.indexWithinChunk}get chunkStart(){return void 0!==this.nestedCursor?this.nestedCursor.atChunkRoot()?this.nestedCursor.chunkStart+this.nestedOffset():this.nestedCursor.chunkStart:this.fieldIndex}get chunkLength(){return void 0!==this.nestedCursor?this.nestedCursor.chunkLength:1}}var Pa;!function(e){e[e.Single=0]="Single",e[e.Optional=1]="Optional",e[e.Sequence=2]="Sequence",e[e.Forbidden=3]="Forbidden"}(Pa||(Pa={}));class Ra extends ia{constructor(e,t){super(),this.shape=e,this.values=t,(0,i.v)(e.treeShape.valuesPerTopLevelNode*e.topLevelLength===t.length,1219)}get topLevelLength(){return this.shape.topLevelLength}clone(){return new Ra(this.shape,this.values.slice())}cursor(){return new ja(this)}dispose(){}}class Ma{constructor(e,t,n){this.type=e,this.hasValue=t,this.fieldsArray=n;const r=new Map;let s=t?1:0;const o=[new _a(void 0,Fa,0,void 0,void 0,this,1,0)];let a=0;for(const[c,l,u]of n){(0,i.v)(!r.has(c),1221);const e=new qa(l,u,o.length,c,a);r.set(c,e),Ba(0,[c,l,u],a,s,o),s+=l.valuesPerTopLevelNode*u,a++}this.fields=r,this.valuesPerTopLevelNode=s,this.positions=o,this.fieldsOffsetArray=[...r.values()]}equals(e){return!!function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(e,t)=>Object.is(e,t);return e===t||e.length===t.length&&e.every(((e,r)=>n(e,t[r],r)))}(this.fieldsArray,e.fieldsArray,((e,t)=>{let[n,r,i]=e,[s,o,a]=t;return n===s&&i===a&&r.equals(o)}))&&(this.type===e.type&&this.hasValue===e.hasValue)}withTopLevelLength(e){return new La(this,e)}}function Ba(e,t,n,r,i){let[s,o,a]=t;const c=i.length;for(let u=0;u<a;u++)for(const t of o.positions){var l;const h=void 0===t.indexOfParentPosition,d=h?e:t.indexOfParentPosition+u*o.positions.length+c;i.push(new _a(void 0===d?void 0:i[d],t.parentField===Fa?s:t.parentField,h?u:t.parentIndex,null!==(l=t.indexOfParentField)&&void 0!==l?l:n,d,t.shape,h?a:t.topLevelLength,t.valueOffset+r+o.valuesPerTopLevelNode*u))}}class La{constructor(e,t){this.treeShape=e,this.topLevelLength=t,(0,i.v)(t>0,1222);const n=[void 0];Ba(0,[Fa,e,t],0,0,n),this.positions=n}equals(e){return this.topLevelLength===e.topLevelLength&&this.treeShape===e.treeShape}}class qa{constructor(e,t,n,r,i){this.shape=e,this.topLevelLength=t,this.offset=n,this.key=r,this.indexOfParentField=i}}class _a{constructor(e,t,n,r,i,s,o,a){this.parent=e,this.parentField=t,this.parentIndex=n,this.indexOfParentField=r,this.indexOfParentPosition=i,this.shape=s,this.topLevelLength=o,this.valueOffset=a}}class ja extends Ca{constructor(e){super(),this.chunk=e,this.mode=1,this.indexOfField=0,this.chunkStart=0,this.shape=this.chunk.shape,this.positions=this.shape.positions,this.fieldKey=Fa,this.moveToPosition(0)}get[Ia](){return this.atChunkRoot()?this.chunk:void 0}atChunkRoot(){return(0,i.v)(void 0===this.fieldKey===(0===this.mode),1376),void 0===this.nodePositionInfo||void 0===this.nodePositionInfo.parent&&void 0===this.fieldKey}fork(){const e=new ja(this.chunk);return e.mode=this.mode,e.fieldKey=this.fieldKey,e.indexOfField=this.indexOfField,e.moveToPosition(this.positionIndex),e}moveToPosition(e){this.nodePositionInfo=this.positions[e],this.positionIndex=e,void 0===this.nodePositionInfo&&((0,i.v)(0===e,1377),(0,i.v)(1===this.mode,1378))}nodeInfo(e){return(0,i.v)(this.mode===e,1224),(0,i.v)(void 0!==this.nodePositionInfo,1342),this.nodePositionInfo}nextField(){this.indexOfField++;const e=this.nodeInfo(1).shape.fieldsArray;return this.indexOfField<e.length?(this.fieldKey=e[this.indexOfField][0],!0):(this.exitField(),!1)}exitField(){(0,i.v)(1===this.mode,1225),(0,i.v)(void 0!==this.nodePositionInfo,1379),this.fieldKey=void 0,this.mode=0}getFieldKey(){var e;return null!==(e=this.fieldKey)&&void 0!==e?e:T("not in a field")}getFieldLength(){if((0,i.v)(1===this.mode,1343),void 0===this.nodePositionInfo)return this.shape.topLevelLength;const e=this.nodePositionInfo.shape.fieldsArray[this.indexOfField];return void 0===e?0:e[2]}firstNode(){return(0,i.v)(1===this.mode,1344),void 0===this.nodePositionInfo?(this.enterRootNodeInner(0),!0):this.enterNodeInner(this.nodePositionInfo,0)}enterNode(e){if((0,i.v)(1===this.mode,1345),(0,i.v)(e>=0,1226),void 0===this.nodePositionInfo)(0,i.v)(e<this.shape.topLevelLength,1346),this.enterRootNodeInner(e);else{const t=this.enterNodeInner(this.nodePositionInfo,e);(0,i.v)(t,1227)}}enterNodeInner(e,t){const n=e.shape,r=n.fieldsOffsetArray;if(this.indexOfField>=r.length)return!1;const s=n.fieldsOffsetArray[this.indexOfField];return!(t>=s.topLevelLength)&&(this.mode=0,this.fieldKey=void 0,this.moveToPosition(this.positionIndex+s.offset+t*s.shape.positions.length),(0,i.v)(this.fieldIndex===t,1228),!0)}enterRootNodeInner(e){this.mode=0,this.fieldKey=void 0,this.moveToPosition(1+e*this.shape.treeShape.positions.length),(0,i.v)(this.fieldIndex===e,1347)}getFieldPath(e){return Ta(e,{field:this.getFieldKey(),parent:this.nodePositionInfo})}getPath(e){return Ea(e,this.nodeInfo(0))}get fieldIndex(){return this.nodeInfo(0).parentIndex}get chunkLength(){return this.nodeInfo(0).topLevelLength}seekNodes(e){const t=this.nodeInfo(0),n=e+t.parentIndex;return n>=0&&n<t.topLevelLength?(this.moveToPosition(this.positionIndex+e*t.shape.positions.length),!0):(this.exitNode(),!1)}nextNode(){const e=this.nodeInfo(0);return e.parentIndex+1===e.topLevelLength?(this.exitNode(),!1):(this.moveToPosition(this.positionIndex+e.shape.positions.length),!0)}exitNode(){var e,t;const n=this.nodeInfo(0);this.indexOfField=null!==(e=n.indexOfParentField)&&void 0!==e?e:T("navigation up to root field not yet supported"),this.fieldKey=n.parentField,this.mode=1,this.moveToPosition(null!==(t=n.indexOfParentPosition)&&void 0!==t?t:T("navigation up to root field not yet supported"))}firstField(){const e=this.nodeInfo(0).shape.fieldsArray;return 0!==e.length&&(this.indexOfField=0,this.mode=1,this.fieldKey=e[0][0],!0)}enterField(e){var t;const n=this.nodeInfo(0).shape.fields,r=n.get(e);this.indexOfField=void 0===r?n.size:null!==(t=r.indexOfParentField)&&void 0!==t?t:T("children should have parents"),this.fieldKey=e,this.mode=1}get type(){return this.nodeInfo(0).shape.type}get value(){const e=this.nodeInfo(0);return e.shape.hasValue?this.chunk.values[e.valueOffset]:void 0}}class za extends ia{get topLevelLength(){let e=0;for(const t of this.subChunks)e+=t.topLevelLength;return e}constructor(e){super(),this.subChunks=e}clone(){const e=this.subChunks.map((e=>(e.referenceAdded(),e)));return new za(e)}cursor(){return new Oa(this.subChunks,[],[],[],[],[Fa],0,0,0,void 0)}dispose(){for(const e of this.subChunks)e.referenceRemoved()}}class Ua{}const Ha=new Ua;class Va{constructor(e,t,n,r,i,s){this.schema=e,this.policy=t,this.sequenceChunkSplitThreshold=n,this.sequenceChunkInlineThreshold=r,this.uniformChunkNodeCount=i,this.tryShapeFromSchema=s,this.typeShapes=new Map}clone(e){return new Va(e,this.policy,this.sequenceChunkSplitThreshold,this.sequenceChunkInlineThreshold,this.uniformChunkNodeCount,this.tryShapeFromSchema)}shapeFromSchema(e){const t=this.typeShapes.get(e);return void 0!==t?t:(this.unregisterSchemaCallback=this.schema.on("afterSchemaChange",(()=>this.schemaChanged())),this.tryShapeFromSchema(this.schema,this.policy,e,this.typeShapes))}dispose(){this.schemaChanged()}schemaChanged(){this.typeShapes.clear(),this.unregisterSchemaCallback&&(this.unregisterSchemaCallback(),this.unregisterSchemaCallback=void 0)}}function Ka(e,t){const n=e.getFieldLength(),r=e.firstNode();return(0,i.v)(r,1404),Qa(e,t,n,!1)}function Ga(e,t){const n=Ka(e,t);return 1===n.length?n[0]:new za(n)}function Wa(e,t,n,r){return F(r,n,(()=>{var i;const s=null!==(i=e.nodeSchema.get(n))&&void 0!==i?i:T("missing schema");if(s instanceof ce)return new Ma(n,!0,[]);if(s instanceof oe){const i=[];for(const[n,o]of s.objectNodeFields){const s=Ja(e,t,o,n,r);if(void 0===s)return Ha;i.push(s)}return new Ma(n,!1,i)}return Ha}))}function Ja(e,t,n,r,i){var s,o;if((null!==(s=t.fieldKinds.get(n.kind.identifier))&&void 0!==s?s:T("missing FieldKind")).multiplicity!==Pa.Single)return;if(1!==(null===(o=n.types)||void 0===o?void 0:o.size))return;const a=Wa(e,t,[...n.types][0],i);return a instanceof Ua?void 0:[r,a,1]}const Za={sequenceChunkSplitThreshold:Number.POSITIVE_INFINITY,sequenceChunkInlineThreshold:Number.POSITIVE_INFINITY,uniformChunkNodeCount:400,shapeFromSchema:()=>Ha};Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY;function $a(e,t){return new Da(e.type,new Map(pa(e,(()=>[e.getFieldKey(),Ka(e,t)]))),e.value)}function Qa(e,t,n,r){(0,i.v)(0===e.mode,1406);let s=[],o=n;for(;o>0;){(0,i.v)(0===e.mode,1407);let n=!1;if(e.chunkStart===e.fieldIndex){const i=e.chunkLength;if(i<=o){const a=Aa(e);if(void 0!==a){if(a instanceof za&&a.subChunks.length<=t.sequenceChunkInlineThreshold)for(const e of a.subChunks)e.referenceAdded(),s.push(e);a.referenceAdded(),s.push(a),o-=i,n=!0;let c=i;r&&0===o&&(c-=1),e.seekNodes(c)}}}if(!n){(0,i.v)(0===e.mode,1408);const n=e.type,a=t.shapeFromSchema(n);if(a instanceof Ma){const n=a.positions.length,i=Math.ceil(n/t.uniformChunkNodeCount),c=Math.min(i,o),l=Ya(e,a,c,c===o&&r);o-=l.topLevelLength,s.push(l)}else s.push($a(e,t)),o-=1,r&&0===o||e.nextNode()}}for(;s.length>t.sequenceChunkSplitThreshold;){const e=Math.ceil(s.length/t.sequenceChunkSplitThreshold),n=[],r=Math.floor(s.length/e),o=s.length%e;let a=0;for(let t=0;t<e;t++){const e=a+r+(t<o?1:0);n.push(new za(s.slice(a,e))),a=e}(0,i.v)(a===s.length,1409),s=n}return s}function Xa(e,t,n){(0,i.v)(t.type===e.type,1410),t.hasValue&&n.push(e.value);for(const[r,s,o]of t.fieldsArray){e.enterField(r);let t=0;for(let r=e.firstNode();r;r=e.nextNode())Xa(e,s,n),t++;e.exitField(),(0,i.v)(o===t,1411)}}function Ya(e,t,n,r){const i=[];let s=1;for(;s<=n;){if(Xa(e,t,i),s===n){r||e.nextNode();break}if(e.nextNode(),e.type!==t.type)break;s+=1}return new Ra(t.withTopLevelLength(s),i)}class ec{constructor(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new oa;this.roots=e,this.schema=t,this.chunker=n,this.anchors=r,this.events=z(),this.nextDetachedFieldIdentifier=0}get isEmpty(){return 0===this.roots.fields.size}on(e,t){return this.events.on(e,t)}clone(e,t){return this.roots.referenceAdded(),new ec(this.roots,e,this.chunker.clone(e),t)}forgetAnchor(e){this.anchors.forget(e)}acquireVisitor(){(0,i.v)(void 0===this.activeVisitor,1898),this.events.emit("beforeChange"),this.roots.isShared()&&(this.roots=this.roots.clone());const e={forest:this,mutableChunkStack:[],mutableChunk:this.roots,getParent(){return(0,i.v)(this.mutableChunkStack.length>0,1330),this.mutableChunkStack[this.mutableChunkStack.length-1]},free(){this.mutableChunk=void 0,this.mutableChunkStack.length=0,(0,i.v)(void 0!==this.forest.activeVisitor,1899),this.forest.activeVisitor=void 0,this.forest.events.emit("afterChange")},destroy(e,t){this.forest.roots.fields.delete(e)},create(e,t){const n=e.map((e=>{return t=e,n=this.forest.chunker,Qa(t,n,1,!0)[0];var t,n}));this.forest.roots.fields.set(t,n)},attach(e,t,n){this.attachEdit(e,t,n)},detach(e,t){this.detachEdit(e,t)},attachEdit(e,t,n){var r;const i=null!==(r=this.forest.roots.fields.get(e))&&void 0!==r?r:[];if(this.forest.roots.fields.delete(e),0===i.length)return;const s=this.getParent();I(s.mutableChunk.fields,s.key).splice(n,0,...i)},detachEdit(e,t){var n;const r=this.getParent(),s=null!==(n=r.mutableChunk.fields.get(r.key))&&void 0!==n?n:[];R(e,s);const o=s.splice(e.start,e.end-e.start);if(void 0!==t)(0,i.v)(!this.forest.roots.fields.has(t),1967),o.length>0&&this.forest.roots.fields.set(t,o);else for(const i of o)i.referenceRemoved();0===s.length&&r.mutableChunk.fields.delete(r.key)},replace(e,t,n){(0,i.v)(e!==n,1968),this.detachEdit(t,n),this.attachEdit(e,t.end-t.start,t.start)},enterNode(e){var t;(0,i.v)(void 0===this.mutableChunk,1333);const n=this.getParent(),r=null!==(t=n.mutableChunk.fields.get(n.key))&&void 0!==t?t:T("missing edited field");let s=e,o=0;for(;s>=r[o].topLevelLength;)s-=r[o].topLevelLength,o++,o===r.length&&T("missing edited node");let a=r[o];if(!(a instanceof Da)){const e=ga(a.cursor(),(e=>function(e,t){const n=Aa(e);return n instanceof Da?(n.referenceAdded(),n):$a(e,t)}(e,this.forest.chunker)));r.splice(o,1,...e),a.referenceRemoved(),a=e[s]}(0,i.v)(a instanceof Da,1334),a.isShared()?(this.mutableChunk=r[o]=a.clone(),a.referenceRemoved()):this.mutableChunk=a},exitNode(e){(0,i.v)(void 0!==this.mutableChunk,1335),this.mutableChunk=void 0},enterField(e){(0,i.v)(void 0!==this.mutableChunk,1336),this.mutableChunkStack.push({key:e,mutableChunk:this.mutableChunk}),this.mutableChunk=void 0},exitField(e){var t;const n=null!==(t=this.mutableChunkStack.pop())&&void 0!==t?t:T("should not be at root");(0,i.v)(void 0===this.mutableChunk,1337),this.mutableChunk=n.mutableChunk}};return this.activeVisitor=e,e}newDetachedField(){const e=String(this.nextDetachedFieldIdentifier);return(0,i.v)(!this.roots.fields.has(e),1338),this.nextDetachedFieldIdentifier+=1,e}allocateCursor(){return new tc(this,bt.Cleared,[],[],[],[],[],[],0,0,0,void 0)}tryMoveCursorToNode(e,t){const n=this.anchors.locate(e);return void 0===n?-1:(this.moveCursorToPath(n,t),1)}tryMoveCursorToField(e,t){if((0,i.v)(t instanceof tc,1339),void 0===e.parent)return t.setToDetachedSequence(e.fieldKey),1;const n=this.tryMoveCursorToNode(e.parent,t);return 1!==n?n:(t.enterField(e.fieldKey),1)}moveCursorToPath(e,t){(0,i.v)(t instanceof tc,1340),(0,i.v)(t.forest===this,1341);const n=[],r=[];let s=e;for(;void 0!==s;)n.push(s.parentIndex),r.push(s.parentField),s=s.parent;for(t.clear();r.length>0;){const e=r.pop();t.state===bt.Cleared?(t.setToDetachedSequence(e),t.state=bt.Current):t.enterField(e),t.enterNode(n.pop())}}getCursorAboveDetachedFields(){const e=this.roots.cursor();return e.enterNode(0),e}}class tc extends Oa{constructor(e,t,n,r,i,s,o,a,c,l,u,h){super(n,r,i,s,o,a,c,l,u,h),this.forest=e,this.state=t}setToDetachedSequence(e){var t;this.root=null!==(t=this.forest.roots.fields.get(e))&&void 0!==t?t:[],this.siblingStack.length=0,this.indexStack.length=0,this.indexOfChunkStack.length=0,this.indexWithinChunkStack.length=0,this.siblings=[e],this.index=0,this.indexOfChunk=0,this.indexWithinChunk=0,this.nestedCursor=void 0}fork(){var e;return new tc(this.forest,this.state,this.root,[...this.siblingStack],[...this.indexStack],[...this.indexOfChunkStack],[...this.indexWithinChunkStack],this.siblings,this.index,this.indexOfChunk,this.indexWithinChunk,null===(e=this.nestedCursor)||void 0===e?void 0:e.fork())}buildFieldAnchor(){const e=this.getFieldPath();return{parent:void 0===e.parent?void 0:this.forest.anchors.track(e.parent),fieldKey:e.field}}free(){this.state=bt.Freed}buildAnchor(){return this.forest.anchors.track(this.getPath())}clear(){this.state=bt.Cleared,this.setToDetachedSequence(pt)}}function nc(e,t){return new ec(new Da(vt,new Map),e.schema,e,t)}var rc,ic;function sc(e,t){var n,r;return null!==(n=null===(r=t.tryGetInfo(e))||void 0===r?void 0:r.rollbackOf)&&void 0!==n?n:e}function oc(e,t,n,r){if(dc(e,t,n))return!0;if(dc(e,t,r))return!1;if((0,i.v)(void 0!==n,1814),(0,i.v)(void 0!==r,1815),n instanceof ce)return r instanceof ce&&function(e,t){return e===t}(n.leafValue,r.leafValue);if((0,i.v)(n instanceof ae||n instanceof oe,2195),(0,i.v)(r instanceof ae||r instanceof oe,2196),n instanceof ae)return r instanceof ae&&ac(e,t,pc(n.mapFields),pc(r.mapFields));if((0,i.v)(n instanceof oe,2197),r instanceof ae){for(const[i,s]of n.objectNodeFields)if(!ac(e,t,pc(s),pc(r.mapFields)))return!1;return!0}return(0,i.v)(r instanceof oe,2198),N({a:n.objectNodeFields,b:r.objectNodeFields,aExtra:r=>{var i;return ac(e,t,null!==(i=n.objectNodeFields.get(r))&&void 0!==i?i:T("missing expected field"),pc(void 0))},bExtra:n=>{var i;return ac(e,t,pc(void 0),null!==(i=r.objectNodeFields.get(n))&&void 0!==i?i:T("missing expected field"))},same:i=>{var s,o;return ac(e,t,null!==(s=n.objectNodeFields.get(i))&&void 0!==s?s:T("missing expected field"),null!==(o=r.objectNodeFields.get(i))&&void 0!==o?o:T("missing expected field"))}})}function ac(e,t,n,r){var i;return vc(null!==(i=e.fieldKinds.get(n.kind.identifier))&&void 0!==i?i:T("missing kind")).allowsFieldSuperset(e,t,n.types,r)}function cc(e,t){if(void 0===t)return!0;if(void 0===e)return!1;for(const n of e)if(!t.has(n))return!1;return!0}function lc(e,t,n){if(!ac(e,t,t.rootFieldSchema,n.rootFieldSchema))return!1;for(const[r,i]of t.nodeSchema)if(!oc(e,t,i,n.nodeSchema.get(r)))return!1;return!0}function uc(e,t,n){return hc(e,t,n,new Set)}function hc(e,t,n,r){var i;if((null!==(i=e.fieldKinds.get(n.kind.identifier))&&void 0!==i?i:T("missing field kind")).multiplicity===Pa.Single&&void 0!==n.types){for(const i of n.types)if(!fc(e,t,t.nodeSchema.get(i),r))return!1;return!0}return!1}function dc(e,t,n){return fc(e,t,n,new Set)}function fc(e,t,n,r){if(void 0===n)return!0;if(r.has(n))return!0;try{var s;if(r.add(n),n instanceof ae)return(null!==(s=e.fieldKinds.get(n.mapFields.kind.identifier))&&void 0!==s?s:T("missing field kind")).multiplicity===Pa.Single;if(n instanceof oe){for(const i of n.objectNodeFields.values())if(hc(e,t,i,r))return!0;return!1}return(0,i.v)(n instanceof ce,2199),!1}finally{r.delete(n)}}function pc(e){return null!==e&&void 0!==e?e:ie}!function(e){e[e.Alive=0]="Alive",e[e.Dead=1]="Dead"}(rc||(rc={}));class mc{constructor(e,t){this.identifier=e,this.multiplicity=t}}class gc extends mc{constructor(e,t,n,r,i){super(e,t),this.changeHandler=n,this.allowsTreeSupersetOf=r,this.handlesEditsFrom=i}allowsFieldSuperset(e,t,n,r){return!!uc(e,t,{kind:this,types:n})||!uc(e,t,r)&&this.allowsTreeSupersetOf(n,r)}}function vc(e){return(0,i.v)(e instanceof gc,1973),e}function yc(e,t,n){const r=t+n-1;for(const i of e){if(i.start>r)break;if(i.start+i.length-1>=t)return i}}function bc(e,t,n,r){const i=t+n-1,s={start:t,length:n,value:r};let o=-1,a=e.length;for(const[m,g]of e.entries()){if(g.start+g.length-1<t)o=m;else if(g.start>i){a=m;break}}if(0===a-o-1)return void e.splice(a,0,s);const c=o+1,l=e[c],u=a-1,h=e[u],d=t-l.start,f=h.start+h.length-1-i;if(d>0&&f>0&&c===u)return void e.splice(c,1,{...l,length:d},s,{...h,start:i+1,length:f});d>0&&(e[c]={...l,length:d},o=c),f>0&&(e[u]={...h,start:i+1,length:f},a=u);const p=a-o-1;e.splice(o+1,p,s)}function Sc(e,t,n,r,i){bc(Ce(e,t,[]),n,r,i)}function wc(e,t,n,r){var i;return function(e,t,n){for(const r of e){if(r.start>t)return{value:void 0,length:Math.min(r.start-t,n)};const e=r.start+r.length-1;if(e>=t){const i=e-t+1;return{value:r.value,length:Math.min(i,n)}}}return{value:void 0,length:n}}(null!==(i=e.get(t))&&void 0!==i?i:[],n,r)}!function(e){e[e.Source=0]="Source",e[e.Destination=1]="Destination"}(ic||(ic={}));const Cc=void 0;var xc;!function(e){e.Tombstone="Tombstone",e.Lineage="Lineage"}(xc||(xc={}));const Ec={cellOrdering:xc.Tombstone};function Tc(e){return e.vestigialEndpoint}function kc(e){return void 0!==e.vestigialEndpoint}const Nc=m.ZU.Union([m.ZU.String(),m.ZU.Number({multipleOf:1,minimum:0})]),Fc=m.ZU.Number({multipleOf:1,minimum:0}),Ic=m.ZU.Number({multipleOf:1,minimum:0}),Ac=m.ZU.Object({version:m.ZU.Number(),identifiers:m.ZU.Array(m.ZU.String()),data:m.ZU.Array(m.ZU.Array(m.ZU.Any()))},{additionalProperties:!1}),Dc=1,Oc=new Set([Dc]),Pc=Fc,Rc=m.ZU.Object({length:Ic,shape:Fc},{additionalProperties:!1}),Mc=m.ZU.Literal(0),Bc=m.ZU.Tuple([Nc,Fc]);var Lc,qc;!function(e){e[e.PreviousNodeOfType_DepthFirstPreOrder=0]="PreviousNodeOfType_DepthFirstPreOrder"}(Lc||(Lc={})),function(e){e[e.Number=0]="Number",e[e.UUID=1]="UUID"}(qc||(qc={}));m.ZU.Object({relativeTo:m.ZU.Enum(Lc),delta:m.ZU.Optional(m.ZU.Number()),mode:m.ZU.Enum(qc)},{additionalProperties:!1});const _c=m.ZU.Union([m.ZU.Boolean(),m.ZU.Array(m.ZU.Any(),{minItems:1,maxItems:1})]),jc=m.ZU.Object({type:m.ZU.Optional(Nc),value:m.ZU.Optional(_c),fields:m.ZU.Optional(m.ZU.Array(Bc)),extraFields:m.ZU.Optional(Fc)},{additionalProperties:!1}),zc=m.ZU.Object({a:m.ZU.Optional(Pc),b:m.ZU.Optional(Rc),c:m.ZU.Optional(jc),d:m.ZU.Optional(Mc)},V),Uc=((e,t)=>m.ZU.Composite([Ac,m.ZU.Object({version:m.ZU.Literal(e),shapes:m.ZU.Array(t)})],{additionalProperties:!1}))(Dc,zc),Hc={additionalProperties:!1},Vc=W({multipleOf:1}),Kc=m.ZU.Union([m.ZU.Tuple([Vc,Le]),Vc]),Gc=m.ZU.Object({revision:m.ZU.Optional(Le),value:m.ZU.Optional(D)},Hc),Wc=m.ZU.Object({value:m.ZU.Optional(D),violated:m.ZU.Boolean()},Hc),Jc=m.ZU.Object({fieldKey:Z,fieldKind:$,change:D},Hc),Zc=m.ZU.Array(Jc),$c=m.ZU.Object({violated:m.ZU.Boolean()},Hc),Qc=m.ZU.Object({valueChange:m.ZU.Optional(Gc),fieldChanges:m.ZU.Optional(Zc),valueConstraint:m.ZU.Optional(Wc),nodeExistsConstraint:m.ZU.Optional($c)},Hc),Xc=m.ZU.Object({revision:m.ZU.Readonly(Le),rollbackOf:m.ZU.ReadonlyOptional(Le)},Hc),Yc=m.ZU.Number({multipleOf:1,minimum:0}),el=m.ZU.Array(m.ZU.Tuple([Vc,Yc])),tl=m.ZU.Array(m.ZU.Union([m.ZU.Tuple([el,Le]),m.ZU.Tuple([el])])),nl=m.ZU.Object({builds:tl,trees:Uc},Hc),rl=m.ZU.Object({maxId:m.ZU.Optional(Vc),changes:Zc,revisions:m.ZU.ReadonlyOptional(m.ZU.Array(Xc)),builds:m.ZU.Optional(nl)},Hc);var il;!function(e){e[e.Unattach=0]="Unattach",e[e.Redetach=1]="Redetach"}(il||(il={}));const sl={additionalProperties:!1},ol=m.ZU.Number({multipleOf:1,minimum:1}),al=Vc,cl=m.ZU.Object({id:al}),ll=m.ZU.Tuple([Le,Vc,ol,m.ZU.Number({multipleOf:1,minimum:0})]),ul=m.ZU.Object({lineage:m.ZU.Optional(m.ZU.Array(ll))}),hl=m.ZU.Tuple([Vc,ol]),dl=m.ZU.Composite([ul,m.ZU.Object({atom:Kc,adjacentCells:m.ZU.Optional(m.ZU.Array(hl))})],sl),fl=m.ZU.Object({revision:m.ZU.Optional(Le)}),pl=m.ZU.Composite([cl,fl],sl),ml=m.ZU.Composite([cl,fl,m.ZU.Object({finalEndpoint:m.ZU.Optional(Kc)})]),gl=m.ZU.Composite([ml],sl),vl=m.ZU.Object({type:m.ZU.Enum(il),id:dl},sl),yl=m.ZU.Object({idOverride:m.ZU.Optional(vl)}),bl=m.ZU.Composite([m.ZU.Object({id:Vc}),fl,yl],sl),Sl=m.ZU.Composite([ml,yl],sl),wl=m.ZU.Object({insert:m.ZU.Optional(pl),moveIn:m.ZU.Optional(gl)},V),Cl=m.ZU.Object({delete:m.ZU.Optional(bl),moveOut:m.ZU.Optional(Sl)},V),xl=m.ZU.Object({attach:wl,detach:Cl}),El=m.ZU.Object({insert:m.ZU.Optional(pl),moveIn:m.ZU.Optional(gl),delete:m.ZU.Optional(bl),moveOut:m.ZU.Optional(Sl),attachAndDetach:m.ZU.Optional(xl)},V),Tl=e=>((e,t)=>m.ZU.Object({effect:m.ZU.Optional(e),cellId:m.ZU.Optional(dl),changes:m.ZU.Optional(t),count:ol},sl))(El,e);function kl(e,t){return Nl(e,e.cellId,t)}function Nl(e,t,n){var r,i;return Fl(e)&&void 0!==t&&(null!==(r=e.revision)&&void 0!==r?r:n)===(null!==(i=t.revision)&&void 0!==i?i:n)||$l(e)&&Nl(e.attach,t,n)}function Fl(e){return"Insert"===e.type||"MoveIn"===e.type}function Il(e){return Al(e,e.cellId)}function Al(e,t){return Fl(e)&&!Nl(e,t)}function Dl(e,t){return void 0===e||void 0===t?e===t:qe(e,t)&&Kl(e.lineage,t.lineage)}function Ol(e,t,n){var r;const i=e.cellId;if(void 0===i)return;if(void 0!==i.revision)return i;let s;return $l(e)?s=e.attach.revision:su(e)||(s=e.revision),{...i,revision:_l(null!==(r=s)&&void 0!==r?r:t,n)}}function Pl(e,t,n){return uu(e)?ql(e,t,n):Jl(e)?void 0:$l(e)?ql(e.detach,t,n):Ol(e,t,n)}function Rl(e,t,n,r){const i=new Set;for(const s of e){const e=r(s,t,n);void 0!==e&&i.add(e.revision)}return i}var Ml,Bl;function Ll(e,t,n,r,s){if(qe(e,t))return Ml.SameCell;const o=n.has(t.revision),a=r.has(e.revision);if(o&&a&&(0,i.v)(!1,2208),a)return Ml.NewThenOld;if(o)return Ml.OldThenNew;{if(void 0===t.revision)return Ml.NewThenOld;(0,i.v)(void 0!==e.revision,2209);const n=s.getIndex(e.revision),r=s.getIndex(t.revision);return void 0!==r&&void 0!==n?r>n?Ml.NewThenOld:Ml.OldThenNew:(void 0===r&&void 0===n&&(0,i.v)(!1,2210),void 0===n?Ml.NewThenOld:Ml.OldThenNew)}}function ql(e,t,n){var r,i,s;return null!==(r=null===(i=e.idOverride)||void 0===i?void 0:i.id)&&void 0!==r?r:{revision:_l(null!==(s=e.revision)&&void 0!==s?s:t,n),localId:e.id}}function _l(e,t){return void 0===t?e:sc(e,t)}function jl(e,t){return(0,i.v)(void 0!==e.cellId,2083),"Insert"!==e.attach.type||Nl(e.attach,e.cellId)?wu(e,t):wu({...e.detach,count:e.count,cellId:e.cellId},null!==t&&void 0!==t?t:e.changes)}function zl(e){if("AttachAndDetach"===e.type)return e;const{cellId:t,count:n,changes:r,revision:i,...s}=e,o={type:"AttachAndDetach",count:n,cellId:t,attach:{type:"Insert",id:e.id},detach:s};return void 0!==r&&(o.changes=r),void 0!==i&&(o.attach.revision=i,o.detach.revision=i),o}function Ul(e){const t={...Hl(e),count:e.count};return void 0!==e.cellId&&(t.cellId=Vl(e.cellId)),t}function Hl(e){const t={...e};return"AttachAndDetach"===t.type&&(t.attach=Hl(t.attach),t.detach=Hl(t.detach)),t}function Vl(e){const t={...e};return void 0!==t.lineage&&(t.lineage=[...t.lineage]),t}function Kl(e,t){if(void 0===e&&void 0===t)return!0;if(void 0===e||void 0===t)return!1;if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++){const r=e[n],i=t[n];if(r.revision!==i.revision||r.offset!==i.offset)return!1}return!0}function Gl(e){return eu(e)?0:e.count}function Wl(e){return!eu(e)&&tu(e)}function Jl(e){return eu(e)&&!tu(e)}function Zl(e){return eu(e)!==tu(e)}function $l(e){return"AttachAndDetach"===e.type}function Ql(e){return uu(e)&&void 0!==e.cellId}function Xl(e,t){var n,r,i;return uu(e)?(null===(n=e.idOverride)||void 0===n?void 0:n.type)===il.Redetach?{revision:null!==(i=e.idOverride.id.revision)&&void 0!==i?i:t,localId:e.idOverride.id.localId}:{revision:null!==(r=e.revision)&&void 0!==r?r:t,localId:e.id}:$l(e)?Xl(e.detach,t):void 0}function Yl(e,t,n){return($l(e)||Ql(e))&&ru(e,t,n)}function eu(e){return void 0!==e.cellId}function tu(e){const t=e.type;switch(t){case Cc:return void 0!==e.cellId;case"Delete":case"MoveOut":case"AttachAndDetach":return!0;case"MoveIn":case"Insert":return!1;default:wt(t)}}function nu(e,t,n){return ru(e,t,n)?e:function(e){const{cellId:t,count:n,changes:r}=e,i={count:n};void 0!==t&&(i.cellId=t);void 0!==r&&(i.changes=r);return i}(e)}function ru(e,t,n){const r=e.type;switch(r){case Cc:return!1;case"Delete":{const r=Ol(e,t,n);if(void 0===r)return!0;const s=Pl(e,t,n);return(0,i.v)(void 0!==s,2084),!qe(r,s)}case"AttachAndDetach":case"MoveOut":return!0;case"MoveIn":return(0,i.v)(void 0!==e.cellId,2085),!0;case"Insert":return void 0!==e.cellId;default:wt(r)}}function iu(e){return e.type===Cc&&void 0!==e.cellId&&void 0===e.changes}function su(e){return e.type===Cc}function ou(e,t,n,r){if(void 0!==e&&void 0!==t)for(const i of e)if(i.revision===t&&au(n,r,i.id,i.count))return i.id+i.offset-n}function au(e,t,n,r){return n<=e&&e<=n+r-1||e<=n&&n<=e+t-1}function cu(e,t,n,r){if((0,i.v)(e.revision===n.revision,2139),au(e.localId,t,n.localId,r))return e.localId-n.localId;const s=e.adjacentCells;return void 0!==s?lu(s,e.localId)-lu(s,n.localId):void 0}function lu(e,t){let n=0;for(const r of e){if(au(r.id,r.count,t,1))return n+(t-r.id);n+=r.count}T("Could not find id in adjacentCells")}function uu(e){const t=null===e||void 0===e?void 0:e.type;return"Delete"===t||"MoveOut"===t}function hu(e,t,n){return void 0===e||void 0===n?void 0===e&&void 0===n:e.revision===n.revision&&(r=e.localId,i=t,s=n.localId,r+i===s);var r,i,s}function du(e,t,n){return void 0!==e.idOverride&&void 0!==n.idOverride?e.idOverride.type===n.idOverride.type&&fu(e.idOverride.id,t,n.idOverride.id):void 0===e.idOverride===(void 0===n.idOverride)}function fu(e,t,n){return hu(e,t,n)&&Kl(null===e||void 0===e?void 0:e.lineage,null===n||void 0===n?void 0:n.lineage)}function pu(e,t){if(t.type!==e.type)return;if(!fu(e.cellId,e.count,t.cellId))return;if(void 0!==t.changes||void 0!==e.changes)return;if(kc(e)){if(!kc(t))return;if(!hu(e.vestigialEndpoint,e.count,t.vestigialEndpoint))return}else if(kc(t))return;const n=mu(e,t,e.count);return void 0!==n?{...e,...n,count:e.count+t.count}:void 0}function mu(e,t,n){if(e.type!==t.type)return;if(t.type===Cc)return e;if("AttachAndDetach"===t.type){const r=e,s=mu(r.attach,t.attach,n),o=mu(r.detach,t.detach,n);if(void 0===s||void 0===o)return;return(0,i.v)(Fl(s)&&uu(o),2086),{...r,attach:s,detach:o}}if(e.revision!==t.revision)return;if(uu(e)&&uu(t)&&!du(e,n,t))return;const r=t.type;switch(r){case"MoveIn":{const r=e;if(r.id+n===t.id&&hu(r.finalEndpoint,n,t.finalEndpoint))return r;break}case"Delete":{const r=e;if(r.id+n===t.id&&du(r,n,t))return r;break}case"MoveOut":{const r=e;if(r.id+n===t.id&&du(r,n,t)&&hu(r.finalEndpoint,n,t.finalEndpoint))return r;break}case"Insert":{const r=e;if(r.id+n===t.id)return r;break}default:wt(r)}}!function(e){e[e.SameCell=0]="SameCell",e[e.OldThenNew=1]="OldThenNew",e[e.NewThenOld=2]="NewThenOld"}(Ml||(Ml={}));function gu(e,t){const n=e.count-t;(t<1||n<1)&&T("Unable to split mark due to lengths");const[r,i]=vu(e,t),s={...e,...r,count:t},o={...e,...i,count:n};return void 0!==o.cellId&&(o.cellId=yu(o.cellId,t)),kc(o)&&(o.vestigialEndpoint=yu(o.vestigialEndpoint,t)),[s,o]}function vu(e,t){const n=e.type;switch(n){case Cc:return[e,e];case"Insert":return[{...e},{...e,id:e.id+t}];case"MoveIn":{const n={...e,id:e.id+t},r=n;return void 0!==r.finalEndpoint&&(r.finalEndpoint=yu(r.finalEndpoint,t)),[e,n]}case"Delete":{const n={...e},r=e.id+t,i={...e,id:r},s=i;return void 0!==s.idOverride&&(s.idOverride={...s.idOverride,id:yu(s.idOverride.id,t)}),[n,i]}case"MoveOut":{const n={...e,id:e.id+t},r=n;return void 0!==r.idOverride&&(r.idOverride={...r.idOverride,id:yu(r.idOverride.id,t)}),void 0!==r.finalEndpoint&&(r.finalEndpoint=yu(r.finalEndpoint,t)),[e,n]}case"AttachAndDetach":{const[n,r]=vu(e.attach,t),[i,s]=vu(e.detach,t);return[{...e,attach:n,detach:i},{...e,attach:r,detach:s}]}default:wt(n)}}function yu(e,t){return{...e,localId:e.localId+t}}function bu(e,t){var n;const r=new Map;for(const a of null!==(i=e.lineage)&&void 0!==i?i:[]){var i;r.set(a.revision,a)}const s=null!==(n=t.lineage)&&void 0!==n?n:[];for(let a=s.length-1;a>=0;a--){var o;const e=s[a],t=null===(o=r.get(e.revision))||void 0===o?void 0:o.offset;if(void 0!==t){const n=e.offset;if(r.delete(e.revision),t<n)return-1;if(t>n)return 1}}return 0}function Su(e){const{cellId:t,count:n,changes:r,...i}=e;return i}function wu(e,t){const n={...e};return void 0!==t?((0,i.v)("MoveIn"!==e.type,1703),n.changes=t):delete n.changes,n}function Cu(e,t){const n=Ul(e);return xu(n,t),void 0!==n.cellId&&void 0===n.cellId.revision&&(n.cellId.revision=t),n}function xu(e,t){if(void 0!==t&&e.type!==Cc){if("AttachAndDetach"===e.type)return xu(e.attach,t),void xu(e.detach,t);(0,i.v)(void 0===e.revision||e.revision===t,2089),e.revision=t}}function Eu(e,t){var n,r;const i=null!==(n=e.revision)&&void 0!==n?n:t;return void 0!==e.finalEndpoint?{...e.finalEndpoint,revision:null!==(r=e.finalEndpoint.revision)&&void 0!==r?r:i}:{revision:i,localId:e.id}}class Tu{constructor(){this.offset=0,this.list=[]}push(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(const r of t)this.pushContent(r)}pushOffset(e){this.offset+=e}pushContent(e){if(iu(e)&&"Tombstone"!==Ec.cellOrdering)return;if(su(e)&&void 0===e.changes&&!kc(e)&&!iu(e))return void this.pushOffset(e.count);this.offset>0&&(this.list.push({count:this.offset}),this.offset=0);const t=this.list[this.list.length-1];if(void 0!==t&&t.type===e.type){const n=pu(t,e);if(void 0!==n)return void this.list.splice(this.list.length-1,1,n)}this.list.push(e)}}function ku(e,t,n,r,i,s){let o=!(arguments.length>6&&void 0!==arguments[6])||arguments[6];s.basis=r,e.set(t,n,r,i,s,o)}function Nu(e,t,n,r,i){let s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];const o=e.get(t,n,r,i,s);return void 0!==o.value?{...o,value:Ou(o.value,r)}:o}function Fu(e){return Iu(e)||Au(e)}function Iu(e){return"MoveOut"===e.type}function Au(e){return"MoveIn"===e.type}function Du(e){switch(e.type){case"MoveIn":return e;case"AttachAndDetach":return Du(e.attach);default:return}}function Ou(e,t){if(e.basis===t)return e;const n={...e,basis:t},r=t-e.basis;if((0,i.v)(r>0,2066),void 0!==e.endpoint&&(n.endpoint={...e.endpoint,localId:e.endpoint.localId+r}),void 0!==e.movedMark){const[t,i]=gu(e.movedMark,r);n.movedMark=i}return n}function Pu(e,t,n,r,i){Bu(e,t,ic.Destination,n,r,i)}function Ru(e,t,n,r,s,o,a){var c;let l=e.changes;const u=qu(s,null!==(c=t.revision)&&void 0!==c?c:r,t.localId,e.count,o);void 0!==u&&((0,i.v)(void 0!==a,1385),l=a(e.changes,u));const h=Ul(e);return n&&Iu(h)&&Mu(h,e.count,r,s,o),void 0!==l?h.changes=l:delete h.changes,h}function Mu(e,t,n,r,i){Bu(e,t,ic.Source,n,r,i)}function Bu(e,t,n,r,s,o){var a;const c=null!==(a=e.revision)&&void 0!==a?a:r,l=function(e,t,n,r,s){var o;let a=!(arguments.length>5&&void 0!==arguments[5])||arguments[5];const c=Nu(e,t,n,r,s);if((0,i.v)(c.length===s,2069),void 0===(null===(o=c.value)||void 0===o?void 0:o.endpoint))return;if(a){const i={...c.value};delete i.endpoint,ku(e,t,n,r,s,i,!1)}return c.value.endpoint}(s,n,c,e.id,t,o);void 0!==l&&(Dl(l,{revision:c,localId:e.id})?delete e.finalEndpoint:e.finalEndpoint=l)}function Lu(e,t,n,r,s){return function(e,t,n,r,s){const o=[];let a=e.shift();for(;void 0!==a;){if($l(a))if(Au(a.attach))if(Iu(a.detach))o.push(a);else{var c;const i=null!==(c=a.attach.revision)&&void 0!==c?c:t,s=Nu(n,ic.Destination,i,a.attach.id,a.count);let l;if(s.length<a.count){const[t,n]=gu(a,s.length);a=t,l=t.attach,e.unshift(n)}else l={...a.attach};Pu(l,a.count,i,n,r),o.push({...a,attach:l})}else if(Iu(a.detach)){var l;const c=null!==(l=a.detach.revision)&&void 0!==l?l:t,u=Nu(n,ic.Source,c,a.detach.id,a.count);if(u.length<a.count){const[t,n]=gu(a,u.length);a=t,e.unshift(n)}const h=Ul(a);Mu(h.detach,a.count,c,n,r);const d=qu(n,c,a.detach.id,a.count,r);void 0!==d&&((0,i.v)(void 0!==s,2068),h.changes=s(a.changes,d)),o.push(h)}else o.push(a);else if(Fu(a)){const i=a.type;switch(i){case"MoveOut":{var u;const i=Nu(n,ic.Source,null!==(u=a.revision)&&void 0!==u?u:t,a.id,a.count);if(i.length<a.count){const[t,n]=gu(a,i.length);a=t,e.unshift(n)}o.push(Ru(a,{revision:a.revision,localId:a.id},!0,t,n,r,s));break}case"MoveIn":{var h;const i=Nu(n,ic.Destination,null!==(h=a.revision)&&void 0!==h?h:t,a.id,a.count);if(i.length<a.count){const[t,n]=gu(a,i.length);a=t,e.unshift(n)}const s=Ul(a);Pu(s,a.count,t,n,r),o.push(s);break}default:wt(i)}}else o.push(a);a=e.shift()}return o}(function(e,t,n,r,i){const s=[];let o=e.shift();for(;void 0!==o;){const c=Tc(o);if(void 0!==c){var a;const l=Nu(t,ic.Source,null!==(a=c.revision)&&void 0!==a?a:n,c.localId,o.count);if(l.length<o.count){const[t,n]=gu(o,l.length);o=t,e.unshift(n)}s.push(Ru(o,c,!1,n,t,r,i))}else s.push(o);o=e.shift()}return s}([e],n,t,r,s),t,n,r,s)}function qu(e,t,n,r){var s;let o=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];const a=ic.Source,c=Nu(e,a,t,n,r);if(void 0!==(null===(s=c.value)||void 0===s?void 0:s.modifyAfter)){if((0,i.v)(c.length===r,1774),o){const i={...c.value};delete i.modifyAfter,ku(e,a,t,n,r,i,!1)}return c.value.modifyAfter}}!function(e){e[e.Source=0]="Source",e[e.Dest=1]="Dest"}(Bl||(Bl={}));class _u{constructor(e,t,n,r,i,s){this.list=e,this.revision=t,this.moveEffects=n,this.consumeEffects=r,this.genId=i,this.composeChanges=s,this.stack=[],this.index=0,this.list=e}isEmpty(){return void 0===this.peek()}dequeue(){const e=this.tryDequeue();return(0,i.v)(void 0!==e,1250),e}tryDequeue(){if(this.stack.length>0)return this.stack.pop();if(this.index<this.list.length){const e=this.list[this.index++];if(void 0===e)return;const t=Lu(e,this.revision,this.moveEffects,this.consumeEffects,this.composeChanges);if(0===t.length)return;const n=t[0];for(let r=t.length-1;r>0;r--)this.stack.push(t[r]);return n}}dequeueUpTo(e){const t=this.dequeue();if(t.count<=e)return t;const[n,r]=gu(t,e);return this.stack.push(r),n}peek(){const e=this.tryDequeue();return void 0!==e&&this.stack.push(e),e}}function ju(e,t,n,r,s,o,a){const c=new Tu,l=new Ku(void 0,e,t,n,s,o,a,((e,t)=>Hu(e,t,r)));for(;!l.isEmpty();){const{baseMark:e,newMark:n}=l.pop();if(void 0===n)(0,i.v)(void 0!==e,1243),c.push(e);else{const i=nu(n,t,a);if(void 0===e)c.push(Vu(i,t,r));else{const n=zu(e,t,i,r,s,o,a);c.push(n)}}}return c.list}function zu(e,t,n,r,s,o,a){let c=Hu(e.changes,void 0===n.changes?void 0:Co(n.changes,t),r);if(void 0!==c){const n=Du(e);void 0!==n&&(!function(e,t,n,r,i){let{revision:s,localId:o}=t;const a=ic.Source,c=1,l=Nu(e,a,s,o,c,!1);let u;if(void 0!==l.value){const e=void 0!==l.value.modifyAfter?i([l.value.modifyAfter,Co(n,r)]):n;u={...l.value,modifyAfter:Eo(e)}}else u={modifyAfter:Co(n,r)};ku(e,a,s,o,c,u)}(o,Eu(n,void 0),c,t,r),c=void 0)}if(Yl(n,t,a)){var l;const r=zl(n),s=null!==(l=r.detach.revision)&&void 0!==l?l:t;if(Wl(e)){Au(r.attach)&&Iu(r.detach)&&((0,i.v)(Iu(e),2056),Gu(o,ic.Destination,Eu(e,void 0),e.count,{revision:s,localId:r.detach.id}));const t={...r.detach,count:e.count};return Iu(e)&&(t.vestigialEndpoint={revision:e.revision,localId:e.id}),Cu(wu(t,c),s)}if(Yl(e,void 0,a)){var u;const n=zl(e),i=Pl(r,t,a);if(Au(n.attach)&&Iu(r.detach)){const i=Eu(n.attach,void 0),s=Eu(r.detach,t);Gu(o,ic.Source,i,e.count,s),Gu(o,ic.Destination,s,e.count,i)}if(Dl(i,n.cellId))return wu({count:n.count,cellId:n.cellId},c);const s={...n.attach},l={...r.detach},h=null!==(u=l.revision)&&void 0!==u?u:t;return void 0!==h&&(l.revision=h),jl({type:"AttachAndDetach",cellId:e.cellId,count:e.count,attach:s,detach:l},c)}return Cu(jl(r,c),t)}if(Yl(e,void 0,a)){const r=zl(e);if(Jl(n)){Au(r.attach)&&Iu(r.detach)&&((0,i.v)(Au(n),2057),Gu(o,ic.Source,Eu(n,t),r.count,{revision:r.attach.revision,localId:r.attach.id}));return Cu(wu({...r.attach,cellId:r.cellId,count:r.count},c),r.attach.revision)}return(0,i.v)(n.type===Cc,2058),wu(e,c)}if(Zl(e)||Zl(n)){if(Zl(e)){if(Zl(n)){if(eu(e)){(0,i.v)(uu(n),1820),(0,i.v)(Fl(e),1821);const r=Su(e),s=Su(Cu(n,t));if(Au(r)&&Iu(s)){const n=Eu(r,void 0),i=Eu(s,t);Gu(o,ic.Source,n,e.count,i),Gu(o,ic.Destination,i,e.count,n),delete r.finalEndpoint,delete s.finalEndpoint}return Dl(Pl(n,t,a),e.cellId)?wu({count:e.count,cellId:e.cellId},c):jl({type:"AttachAndDetach",cellId:e.cellId,count:e.count,attach:r,detach:s},c)}if(Fu(e)&&Fu(n)){const t=qu(o,e.revision,e.id,e.count);return{count:e.count,vestigialEndpoint:{revision:e.revision,localId:e.id},changes:Hu(c,t,r)}}return Uu(e.count,c)}return wu(e,c)}return Cu(wu(n,c),t)}return su(e)?wu(n,c):su(n)?wu(e,c):Uu(n.count,c,Ol(e,void 0,void 0))}function Uu(e,t,n){const r={count:e};return void 0!==t&&((0,i.v)(1===e,1682),r.changes=t),void 0!==n&&(r.cellId=n),r}function Hu(e,t,n){return void 0===t?e:n(void 0===e?[t]:[Eo(e),t])}function Vu(e,t,n){const r=Ul(e);return void 0!==r.cellId&&void 0===r.cellId.revision&&void 0!==t&&(r.cellId.revision=t),xu(r,t),void 0!==r.changes?(r.changes=n([Co(r.changes,t)]),r):r}class Ku{constructor(e,t,n,r,i,s,o,a){this.newRevision=n,this.revisionMetadata=o,this.baseMarks=new _u(t,e,s,!0,i,a),this.newMarks=new _u(r,n,s,!0,i,a),this.baseMarksCellSources=Rl(t,e,o,Pl),this.newMarksCellSources=Rl(r,void 0,o,Ol)}isEmpty(){return this.baseMarks.isEmpty()&&this.newMarks.isEmpty()}pop(){const e=this.baseMarks.peek(),t=this.newMarks.peek();if(void 0===e&&void 0===t)return{};if(void 0===e){const e=Gl(t);return this.dequeueNew(e)}if(void 0===t){const t=tu(r=e)?0:r.count;return this.dequeueBase(t)}if(!tu(e)||!eu(t))return tu(e)?this.dequeueBase():eu(t)?this.dequeueNew():this.dequeueBoth();{var n;const r=null!==(n=Pl(e,this.baseMarks.revision,this.revisionMetadata))&&void 0!==n?n:T("Expected defined output ID");if(Wl(e)&&void 0===r.revision)return(0,i.v)(kl(t),1685),this.dequeueNew();switch(Ec.cellOrdering){case xc.Tombstone:{const e=Ol(t,this.newRevision,this.revisionMetadata);(0,i.v)(void 0!==e,2205);const n=Ll(r,e,this.baseMarksCellSources,this.newMarksCellSources,this.revisionMetadata);switch(n){case Ml.SameCell:return this.dequeueBoth();case Ml.OldThenNew:return this.dequeueBase();case Ml.NewThenOld:return this.dequeueNew();default:wt(n)}}case xc.Lineage:{const n=function(e,t,n,r,s){const o=Ol(n,r,s);if((0,i.v)(void 0!==o,1823),e.revision===o.revision){const r=cu(e,t,o,n.count);if(void 0!==r)return r}const a=ou(e.lineage,o.revision,o.localId,n.count);if(void 0!==a)return a>0?a:-1/0;const c=ou(o.lineage,e.revision,e.localId,t);if(void 0!==c)return c>0?-c:1/0;const l=bu(e,o);if(0!==l)return Math.sign(l)*(1/0);if((0,i.v)(void 0!==e.revision&&void 0!==o.revision,2136),!kl(n))return-1/0;const u=s.getIndex(o.revision),h=s.getIndex(e.revision);return(0,i.v)(void 0!==u,2137),(null!==h&&void 0!==h?h:-1/0)>u?-1/0:1/0}(r,e.count,t,this.newRevision,this.revisionMetadata);return n<0?{baseMark:this.baseMarks.dequeueUpTo(-n)}:n>0?{newMark:this.newMarks.dequeueUpTo(n)}:this.dequeueBoth()}default:wt(Ec.cellOrdering)}}var r}dequeueBase(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return{baseMark:this.baseMarks.dequeue(),newMark:e>0?{count:e}:void 0}}dequeueNew(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return{baseMark:e>0?{count:e}:void 0,newMark:this.newMarks.dequeue()}}dequeueBoth(){const e=this.baseMarks.peek(),t=this.newMarks.peek();(0,i.v)(void 0!==e&&void 0!==t,1687);const n=Math.min(t.count,e.count);return{baseMark:this.baseMarks.dequeueUpTo(n),newMark:this.newMarks.dequeueUpTo(n)}}}function Gu(e,t,n,r,i){const s=Nu(e,t,n.revision,n.localId,r),o=void 0!==s.value?{...s.value,endpoint:i}:{endpoint:i};ku(e,t,n.revision,n.localId,s.length,o);const a=r-s.length;a>0&&Gu(e,t,Wu(n,s.length),a,Wu(i,s.length))}function Wu(e,t){return{...e,localId:e.localId+t}}function Ju(e,t,n,r,s){if(!ru(e,t,s)){const r=Ol(e,t,s);return[$u(e.count,e.changes,n,r)]}const o=e.type;switch(o){case Cc:{const t={...e};return void 0!==e.changes&&(t.changes=n(e.changes)),[t]}case"Delete":{(0,i.v)(void 0!==t,1441);const r=Pl(e,t,s),o=Ol(e,t,s);return[wu(void 0===o?{type:"Insert",id:e.id,cellId:r,count:e.count}:{type:"Delete",id:e.id,cellId:r,count:e.count,idOverride:{type:il.Redetach,id:o}},Qu(e.changes,n))]}case"Insert":{const r=Ol(e,t,s);(0,i.v)(void 0!==r,2060);const o={type:"Delete",count:e.count,id:r.localId};o.idOverride={type:Il(e)?il.Redetach:il.Unattach,id:r};return[wu(o,Qu(e.changes,n))]}case"MoveOut":{var a,c,l,u,h;if(void 0!==e.changes){(0,i.v)(1===e.count,1773);const s=Eu(e,t);r.set(ic.Destination,s.revision,s.localId,e.count,n(e.changes),!0)}const o=null!==(a=ql(e,null!==(c=null!==(l=e.revision)&&void 0!==l?l:t)&&void 0!==c?c:T("Revision must be defined"),s))&&void 0!==a?a:{revision:null!==(u=null!==(h=e.revision)&&void 0!==h?h:t)&&void 0!==u?u:T("Revision must be defined"),localId:e.id},d={type:"MoveIn",id:e.id};void 0!==e.finalEndpoint&&(d.finalEndpoint={localId:e.finalEndpoint.localId});let f=d;const p=Ol(e,t,s);return void 0!==p&&(f={type:"AttachAndDetach",attach:d,detach:{type:"Delete",id:e.id,idOverride:{type:il.Redetach,id:p}}}),[{...f,count:e.count,cellId:o}]}case"MoveIn":{const n=Ol(e,t,s);(0,i.v)(void 0!==n,2206);const o={type:"MoveOut",id:e.id,count:e.count};return e.finalEndpoint&&(o.finalEndpoint={localId:e.finalEndpoint.localId}),o.idOverride={type:Il(e)?il.Redetach:il.Unattach,id:n},Zu(o,t,r)}case"AttachAndDetach":{const o={count:e.count,cellId:e.cellId,...e.attach},a=Pl(o,t,void 0),c={count:e.count,cellId:a,changes:e.changes,...e.detach},l=Ju(o,t,n,r,s),u=Ju(c,t,n,r,s);if(0===u.length)return l;(0,i.v)(1===u.length,2061);let h=u[0];(0,i.v)(Fl(h),2062);const d=[];for(const e of l){let t=h;if(e.count!==h.count&&([t,h]=gu(h,e.count)),e.type===Cc){void 0!==e.changes&&((0,i.v)(void 0===t.changes,2063),t.changes=e.changes),d.push(t);continue}(0,i.v)(uu(e),2064);const n={type:"AttachAndDetach",count:e.count,attach:Su(t),detach:Su(e)};void 0!==t.cellId&&(n.cellId=t.cellId),void 0!==t.changes&&(n.changes=t.changes),void 0!==e.changes&&((0,i.v)(void 0===n.changes,2065),n.changes=e.changes),d.push(jl(n))}return d}default:wt(o)}}function Zu(e,t,n){var r;const i=n.get(ic.Destination,null!==(r=e.revision)&&void 0!==r?r:t,e.id,e.count,!0);if(i.length<e.count){const[r,s]=gu(e,i.length);return[void 0!==i.value?wu(r,i.value):r,...Zu(s,t,n)]}return void 0!==i.value?[wu(e,i.value)]:[e]}function $u(e,t,n,r){if(void 0!==t){(0,i.v)(1===e,1644);const s={count:e,changes:n(t)};return void 0!==r&&(s.cellId=r),s}return void 0!==r?{count:e,cellId:r}:{count:e}}function Qu(e,t){return void 0===e?void 0:t(e)}function Xu(e){var t;switch(e.type){case"Delete":case"MoveOut":return(null===(t=e.idOverride)||void 0===t?void 0:t.type)===il.Redetach;case"AttachAndDetach":return Xu(e.detach);default:return!1}}function Yu(e,t,n){const r=e.count,i=Ol(e,t,n);return void 0===i?{count:r}:{count:r,cellId:i}}class eh{constructor(e,t,n,r,i,s){this.metadata=r,this.moveEffects=s,this.baseMarks=new _u(t,e,s,!1,i),this.newMarks=new _u(n,void 0,s,!1,i),this.baseMarksCellSources=Rl(t,e,r,Ol),this.newMarksCellSources=Rl(n,void 0,r,Ol)}isEmpty(){return this.baseMarks.isEmpty()&&this.newMarks.isEmpty()}pop(){const e=this.baseMarks.peek(),t=this.newMarks.peek();if((0,i.v)(!(void 0===e&&void 0===t),1826),void 0===e){const e=this.newMarks.dequeue();return{baseMark:Yu(e,void 0,this.metadata),newMark:e}}if(void 0===t)return this.dequeueBase();if(!eu(e)||!eu(t))return eu(t)?this.dequeueNew():eu(e)?this.dequeueBase():this.dequeueBoth();switch(Ec.cellOrdering){case xc.Tombstone:{const n=Ol(e,this.baseMarks.revision,this.metadata),r=Ol(t,void 0,this.metadata);(0,i.v)(void 0!==n&&void 0!==r,2207);const s=Ll(n,r,this.baseMarksCellSources,this.newMarksCellSources,this.metadata);switch(s){case Ml.SameCell:return this.dequeueBoth();case Ml.OldThenNew:return this.dequeueBase();case Ml.NewThenOld:return this.dequeueNew();default:wt(s)}}case xc.Lineage:{const n=function(e,t,n,r){const s=Ol(t,e,r),o=t.count;(0,i.v)(void 0!==(null===s||void 0===s?void 0:s.revision),1696);const a=Ol(n,void 0,r);(0,i.v)(void 0!==a,2138);const c=n.count;if(void 0!==a&&s.revision===a.revision){const e=cu(s,t.count,a,n.count);if(void 0!==e)return e}if(void 0!==a){const e=ou(s.lineage,a.revision,a.localId,c);if(void 0!==e)return e>0?e:-1/0;const t=ou(a.lineage,s.revision,s.localId,o);if(void 0!==t)return t>0?-t:1/0}if(void 0!==a){const e=bu(s,a);if(0!==e)return Math.sign(e)*(1/0);const t=function(e,t,n){const r=new Map;for(const s of null!==e&&void 0!==e?e:[])r.set(s.revision,s);const i=new Map;for(const s of null!==t&&void 0!==t?t:[])i.set(s.revision,s);for(const s of r.keys())i.has(s)&&(r.delete(s),i.delete(s));for(const s of i.values())if(!n.hasRollback(s.revision)&&0!==s.offset)return-1;for(const s of r.values())if(!n.hasRollback(s.revision)&&0!==s.offset)return 1;return 0}(s.lineage,a.lineage,r);if(0!==t)return Math.sign(t)*(1/0)}if(void 0===a.revision)return 1/0;const l=r.getIndex(s.revision),u=r.getIndex(a.revision);if(void 0!==u&&void 0!==l)return u>l?1/0:-1/0;if(void 0!==u)return 1/0;if(void 0!==l)return-1/0;return-1/0}(this.baseMarks.revision,e,t,this.metadata);if(n<0)return this.dequeueBase(-n);if(n>0){const e=this.newMarks.dequeueUpTo(n);return{newMark:e,baseMark:Yu(e,void 0,this.metadata)}}return this.dequeueBoth()}default:wt(Ec.cellOrdering)}}dequeueBase(e){const t=void 0!==e?this.baseMarks.dequeueUpTo(e):this.baseMarks.dequeue(),n=oh(this.moveEffects,t,this.baseMarks.revision);return{baseMark:t,newMark:void 0!==n?sh(n,Ol(t,this.baseMarks.revision,void 0)):Yu(t,this.baseMarks.revision,this.metadata)}}dequeueNew(){const e=this.newMarks.dequeue();return{newMark:e,baseMark:Yu(e,void 0,this.metadata)}}dequeueBoth(){const e=this.baseMarks.peek(),t=this.newMarks.peek();(0,i.v)(void 0!==e&&void 0!==t,1692);const n=Math.min(t.count,e.count),r=this.baseMarks.dequeueUpTo(n),s=this.newMarks.dequeueUpTo(n),o=oh(this.moveEffects,r,this.baseMarks.revision);return{baseMark:r,newMark:void 0===o?s:th(s,o)}}}function th(e,t){if(Au(e)&&Iu(t)){const n={type:"Insert",count:e.count,id:e.id};return void 0!==t.cellId&&(n.cellId=Vl(t.cellId)),void 0!==t.revision&&(n.revision=t.revision),void 0!==t.changes&&(n.changes=t.changes),n}if(iu(e)){const n={...t};return n.cellId=Vl(e.cellId),n}(0,i.v)(!1,2072)}function nh(e,t,n,r,i,s,o){const a=function(e,t,n){const r=t.changes,i=e.changes;if(Wl(t)&&!Fu(t))return wu(e,n(i,r,rc.Dead));if(Jl(t)&&!Fu(t))return wu(e,n(i,r,rc.Alive));return wu(e,n(i,r))}(Ul(e),t,i);return rh(a,t,n,r,s,o)}function rh(e,t,n,r,s,o){let a;if(uu(t)){void 0!==t.cellId&&delete e.cellId,(0,i.v)(!kl(e),1693);const o=ql(t,n,r);if(Iu(t)){(0,i.v)(Fu(t),1776),(0,i.v)(!kl(e),2073);const{remains:r,follows:o}=function(e){const t=e.type;switch(t){case"Delete":case"MoveOut":return{follows:e};case"AttachAndDetach":return{follows:e.detach,remains:e.attach};case"MoveIn":return{remains:e};case Cc:return{};case"Insert":{const t={type:"MoveOut",id:e.id},n={type:"MoveIn",id:e.id};return void 0!==e.revision&&(t.revision=e.revision,n.revision=e.revision),{remains:n,follows:t}}default:wt(t)}}(e);void 0===o&&void 0===e.changes||ih(wu({...o,count:t.count},e.changes),s,Eu(t,n),t.count),a={...null!==r&&void 0!==r?r:{},count:t.count}}else a=e;c=a,l=Vl(o),(0,i.v)(void 0===c.cellId,1695),a={...c,cellId:l}}else if(Jl(t))a=$l(e)?wu({...e.detach,count:e.count},e.changes):sh(e,void 0);else if($l(t)){(0,i.v)(void 0!==t.cellId,2074);const c=rh(e,{...t.attach,cellId:Vl(t.cellId),count:t.count},n,r,s,o);a=rh(c,{...t.detach,count:t.count},n,r,s,o)}else a=e;var c,l;return a}function ih(e,t,n,r){let{revision:i,localId:s}=n;const o=Nu(t,ic.Destination,i,s,r,!1);if(o.length<r){const[n,a]=gu(e,o.length),c=void 0!==o.value?{...o.value,movedMark:n}:{movedMark:n};ku(t,ic.Destination,i,s,o.length,c),ih(a,t,{revision:i,localId:s+o.length},r-o.length)}else{const n=void 0!==o.value?{...o.value,movedMark:e}:{movedMark:e};ku(t,ic.Destination,i,s,r,n)}}function sh(e,t){const n={...e,cellId:t};return void 0===t&&delete n.cellId,n}function oh(e,t,n){var r,i;return Au(t)?ah(e,null!==(r=t.revision)&&void 0!==r?r:n,t.id,t.count):$l(t)&&Au(t.attach)?ah(e,null!==(i=t.attach.revision)&&void 0!==i?i:n,t.attach.id,t.count):void 0}function ah(e,t,n,r){var s;const o=Nu(e,ic.Destination,t,n,r);if((0,i.v)(o.length===r,1779),void 0!==(null===(s=o.value)||void 0===s?void 0:s.movedMark)){const i={...o.value};if(delete i.movedMark,ku(e,ic.Destination,t,n,r,i,!1),o.value.movedMark.count===r)return o.value.movedMark;const[s,a]=gu(o.value.movedMark,r);return s}}function ch(e,t,n){const r=n.getBaseRevisions().map((e=>{var t;return null!==(t=sc(e,n))&&void 0!==t?t:T("Intention should be defined")}));!function(e,t){if(void 0===e.lineage)return;e.lineage=e.lineage.filter((e=>!t.has(e.revision))),0===e.lineage.length&&delete e.lineage}(e,new Set(r));for(const[o,a]of t.entries())if(mh(e.revision,o,n)){var i,s;const t=null!==(i=null===(s=n.tryGetInfo(o))||void 0===s?void 0:s.rollbackOf)&&void 0!==i?i:o;for(const n of a)dh(e,t,n.id,n.count,n.count)}}function lh(e,t){const n=e.getIndex(t);return void 0!==n?n:-1/0}function uh(e,t,n,r,s,o){const a=function(e,t,n){if(!eu(t))return-1/0;if(Jl(t)){var r,s;return(0,i.v)(Fl(t),2075),lh(e,null!==(r=null!==(s=t.revision)&&void 0!==s?s:n)&&void 0!==r?r:T("Mark must have revision"))}var o,a;return $l(t)?lh(e,null!==(o=null!==(a=t.attach.revision)&&void 0!==a?a:n)&&void 0!==o?o:T("Mark must have revision")):1/0}(o,n,r),c=function(e,t,n){if(!tu(t))return 1/0;if(Wl(t)){var r,s;return(0,i.v)(uu(t),2076),lh(e,null!==(r=null!==(s=t.revision)&&void 0!==s?s:n)&&void 0!==r?r:T("Mark must have revision"))}var o,a;return $l(t)?lh(e,null!==(o=null!==(a=t.detach.revision)&&void 0!==a?a:n)&&void 0!==o?o:T("Mark must have revision")):-1/0}(o,n,r);for(const i of t.keys()){const e=lh(o,i);e>-1/0&&a<=e&&e<c&&t.delete(i)}e.push({cellId:s.cellId,firstAttachedRevisionIndex:a,lastAttachedRevisionIndex:c-1})}function hh(e,t,n,r,i){var s;const o=null===(s=i.tryGetInfo(t))||void 0===s?void 0:s.rollbackOf,a=null!==o&&void 0!==o?o:t,c=lh(i,a);for(let l=e.length-1;l>=0;l--){const s=e[l];if(s.firstAttachedRevisionIndex<=c&&c<=s.lastAttachedRevisionIndex)return;void 0!==s.cellId&&(mh(s.cellId.revision,t,i)&&dh(s.cellId,a,n,r,0))}}function dh(e,t,n,r,i){if(void 0===e.lineage&&(e.lineage=[]),e.lineage.length>0){const s=e.lineage[e.lineage.length-1];if(s.revision===t&&s.id+s.count===n){if(s.offset===s.count)return void(e.lineage[e.lineage.length-1]={...s,count:s.count+r,offset:s.offset+i});if(0===i)return void(e.lineage[e.lineage.length-1]={...s,count:s.count+r})}}e.lineage.push({revision:t,id:n,count:r,offset:i})}function fh(e,t){if(e.length>0){const n=e[e.length-1];if(n.id+n.count===t.id)return void(n.count+=t.count)}e.push(t)}function ph(e,t){(0,i.v)(void 0!==e.cellId,1869),(0,i.v)(void 0===e.cellId.adjacentCells,1870),e.cellId.adjacentCells=t}function mh(e,t,n){var r;if(void 0===e)return!0;const i=lh(n,e),s=null===(r=n.tryGetInfo(t))||void 0===r?void 0:r.rollbackOf,o=lh(n,null!==s&&void 0!==s?s:t);if(void 0===o)return!0;return void 0!==s?o<i:o>i}function gh(e){return{encode:(t,n)=>void 0===t.revision?t.localId:[t.localId,e.encode(t.revision,n)],decode:(t,n)=>Array.isArray(t)?{localId:t[0],revision:e.decode(t[1],n)}:{localId:t}}}function vh(e,t){var n;const r=gh(t),i={encode(e,n){const s=e.type;switch(s){case"MoveIn":return{moveIn:{revision:void 0===e.revision?void 0:t.encode(e.revision,n),finalEndpoint:void 0===e.finalEndpoint?void 0:r.encode(e.finalEndpoint,n),id:e.id}};case"Insert":return{insert:{revision:void 0===e.revision?void 0:t.encode(e.revision,n),id:e.id}};case"Delete":return{delete:{revision:void 0===e.revision?void 0:t.encode(e.revision,n),idOverride:void 0===e.idOverride?void 0:{type:e.idOverride.type,id:o.encode(e.idOverride.id,n)},id:e.id}};case"MoveOut":return{moveOut:{revision:void 0===e.revision?void 0:t.encode(e.revision,n),finalEndpoint:void 0===e.finalEndpoint?void 0:r.encode(e.finalEndpoint,n),idOverride:void 0===e.idOverride?void 0:{type:e.idOverride.type,id:o.encode(e.idOverride.id,n)},id:e.id}};case"AttachAndDetach":return{attachAndDetach:{attach:i.encode(e.attach,n),detach:i.encode(e.detach,n)}};case Cc:T("Mark type: ".concat(s," should not be encoded."));default:wt(s)}},decode:(e,t)=>s.dispatch(e,t)},s=new K({moveIn(e,n){const{id:i,finalEndpoint:s,revision:o}=e,a={type:"MoveIn",id:i};return void 0!==o&&(a.revision=t.decode(o,n)),void 0!==s&&(a.finalEndpoint=r.decode(s,n)),a},insert(e,n){const{id:r,revision:i}=e,s={type:"Insert",id:r};return void 0!==i&&(s.revision=t.decode(i,n)),s},delete(e,n){const{id:r,revision:i,idOverride:s}=e,a={type:"Delete",id:r};return void 0!==i&&(a.revision=t.decode(i,n)),void 0!==s&&(a.idOverride={type:s.type,id:o.decode(s.id,n)}),a},moveOut(e,n){const{id:i,finalEndpoint:s,idOverride:a,revision:c}=e,l={type:"MoveOut",id:i};return void 0!==c&&(l.revision=t.decode(c,n)),void 0!==s&&(l.finalEndpoint=r.decode(s,n)),void 0!==a&&(l.idOverride={type:a.type,id:o.decode(a.id,n)}),l},attachAndDetach:(e,t)=>({type:"AttachAndDetach",attach:s.dispatch(e.attach,t),detach:s.dispatch(e.detach,t)})}),o={encode:(e,n)=>{let{localId:i,adjacentCells:s,lineage:o,revision:a}=e;const c={atom:r.encode({localId:i,revision:a},n),adjacentCells:null===s||void 0===s?void 0:s.map((e=>{let{id:t,count:n}=e;return[t,n]})),lineage:null===o||void 0===o?void 0:o.map((e=>{let{revision:r,id:i,count:s,offset:o}=e;return[t.encode(r,n),i,s,o]}))};return c},decode:(e,n)=>{let{atom:i,adjacentCells:s,lineage:o}=e;const{localId:a,revision:c}=r.decode(i,n),l={localId:a};return void 0!==c&&(l.revision=c),void 0!==s&&(l.adjacentCells=s.map((e=>{let[t,n]=e;return{id:t,count:n}}))),void 0!==o&&(l.lineage=o.map((e=>{let[r,i,s,o]=e;return{revision:t.decode(r,n),id:i,count:s,offset:o}}))),l}};return{encode:(t,n)=>{const r=[];for(const s of t){const t={count:s.count};su(s)||(t.effect=i.encode(s,n)),void 0!==s.cellId&&(t.cellId=o.encode(s.cellId,n)),void 0!==s.changes&&(t.changes=e.encode(s.changes,n)),r.push(t)}return r},decode:(t,n)=>{const r=[];for(const s of t){const t={count:s.count};void 0!==s.effect&&Object.assign(t,i.decode(s.effect,n)),void 0!==s.cellId&&(t.cellId=o.decode(s.cellId,n)),void 0!==s.changes&&(t.changes=e.decode(s.changes,n)),r.push(t)}return r},encodedSchema:(a=null!==(n=e.encodedSchema)&&void 0!==n?n:m.ZU.Any(),m.ZU.Array(Tl(a)))};var a}function yh(e,t,n,r,i){if(0===t)return[];const s=e+t,o=new Tu;if(o.pushOffset(Math.min(e,n)),n<=e)o.pushContent(i),o.pushOffset(e-n),o.pushContent(r);else if(s<=n)o.pushContent(r),o.pushOffset(n-s),o.pushContent(i);else{const t=n-e,[s,a]=gu(r,t);o.pushContent(s),o.pushContent(i),o.pushContent(a)}return o.list}function bh(e,t){return 0===e?[t]:[{count:e},t]}function Sh(e,t){var n;return Xe(null!==(n=e.revision)&&void 0!==n?n:t,e.localId)}function wh(e){if(void 0!==e.cellId){if(function(e){return"Insert"===e.type}($l(e)?e.attach:e))return!0;if(Ql(e))return!0;if(void 0!==e.changes)return!0}return!1}const Ch={rebaser:{compose:function(e,t,n,r,i){let s=[];for(const o of e)s=ju(s,o.revision,o.change,t,n,r,i);return s},amendCompose:function(e,t,n,r){return function(e,t,n){const r=new Tu,i=new _u(e,void 0,n,!0,be,((e,n)=>Hu(e,n,t)));for(;!i.isEmpty();){const e=i.dequeue();void 0!==e.vestigialEndpoint&&delete e.vestigialEndpoint,r.push(e)}return r.list}(e,t,r)},invert:function(e,t,n,r,i){return function(e,t,n,r,i){const s=new Tu;for(const o of e){const e=Ju(o,t,n,r,i);s.push(...e)}return s.list}(e.change,e.revision,t,r,i)},rebase:function(e,t,n,r,s,o){let a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:rc.Alive;return function(e,t,n,r,s,o,a,c){const l=[],u=new eh(n,t,e,r,o,a),h=[],d=new Map;for(;!u.isEmpty();){const{baseMark:e,newMark:t}=u.pop(),o=nh(t,e,n,r,s,a,c);if(Ec.cellOrdering===xc.Lineage){if(Wl(e)||Yl(e,n,r)){const t=Xl(e,n);(0,i.v)(void 0!==t,2070),(0,i.v)(void 0!==t.revision,1866);const s=I(d,t.revision);fh(s,{id:t.localId,count:e.count}),hh(h,t.revision,t.localId,e.count,r),(0,i.v)(eu(o)&&void 0!==o.cellId.revision,2071),Xu(e)||ph(o,s)}eu(o)&&ch(o.cellId,d,r),uh(h,d,e,n,o,r)}l.push(o)}return function(e){const t=new Tu;for(const n of e)t.push(n);return t.list}(l)}(e,t.change,t.revision,o,n,r,s,a)},prune:function(e,t){const n=new Tu;for(let r of e)kc(r)&&delete r.vestigialEndpoint,void 0!==r.changes&&(r=wu(r,t(r.changes))),n.push(r);return n.list}},codecsFactory:(e,t)=>Fe([[0,vh(e,t)]]),editor:{buildChildChange:(e,t)=>bh(e,{count:1,changes:t}),insert:(e,t,n)=>bh(e,{type:"Insert",id:n,count:t,cellId:{localId:n}}),delete:(e,t,n)=>0===t?[]:bh(e,{type:"Delete",count:t,id:n}),revive:(e,t,n)=>{(0,i.v)(void 0!==n.revision,1828);const r={type:"Insert",id:n.localId,count:t,cellId:n};return 0===t?[]:bh(e,r)},move:(e,t,n,r)=>yh(e,t,n,{type:"MoveOut",id:r,count:t},{type:"MoveIn",id:r,count:t,cellId:{localId:r}}),moveOut:(e,t,n)=>bh(e,{type:"MoveOut",id:n,count:t}),moveIn:(e,t,n)=>bh(e,{type:"MoveIn",id:n,count:t,cellId:{localId:n}}),return:(e,t,n,r)=>yh(e,t,n,{type:"MoveOut",id:0,count:t},{type:"MoveIn",id:0,count:t,cellId:r})},intoDelta:function(e,t){let{change:n,revision:r}=e;const s=[],o=[],a=[];for(const u of n){const e={count:u.count},n=Ol(u,r,void 0),l=u.changes;if(void 0!==l){const r=t(l);r.size>0&&(void 0===n?e.fields=r:o.push({id:Sh(n),fields:r}))}if(eu(u)||tu(u))if($l(u)){if((0,i.v)(void 0!==n,2078),Au(u.attach)&&Iu(u.detach)){(0,i.v)(void 0===u.changes,2079);continue}const t=Pl(u,r,void 0);(0,i.v)(void 0!==t,2080);const s=Sh(Au(u.attach)?Eu(u.attach,r):n);qe(n,t)||a.push({count:u.count,oldId:s,newId:Sh(t)}),e.fields&&o.push({id:s,fields:e.fields})}else{const t=u.type;switch(t){case"MoveIn":s.push({attach:Sh(Eu(u,r)),count:u.count});break;case"Delete":{const t=ql(u,r,void 0);if(void 0===n)e.detach=Sh(t),s.push(e);else{const r=Sh(n);qe(n,t)||a.push({count:u.count,oldId:r,newId:Sh(t)}),e.fields&&o.push({id:r,fields:e.fields})}break}case"MoveOut":{var c;const t=Xe(null!==(c=u.revision)&&void 0!==c?c:r,u.id);void 0===n?(e.detach=t,s.push(e)):a.push({count:u.count,oldId:Sh(n),newId:t});break}case"Insert":{(0,i.v)(void 0!==n,2081);const t=Sh(n);e.attach=t,e.fields&&(o.push({id:t,fields:e.fields}),delete e.fields),s.push(e);break}case Cc:void 0===n&&s.push(e);break;default:wt(t)}}else s.push(e)}for(;s.length>0;){const e=s[s.length-1];if(void 0!==e.attach||void 0!==e.detach||void 0!==e.fields)break;s.pop()}const l={};return s.length>0&&(l.local=s),o.length>0&&(l.global=o),a.length>0&&(l.rename=a),l},relevantRemovedRoots:function(e,t){let{change:n,revision:r}=e;return function*(){for(const e of n){if(wh(e)){(0,i.v)(void 0!==e.cellId,2077);const t=Sh(e.cellId,r);for(let n=0;n<e.count;n+=1)yield Ye(t,n)}void 0!==e.changes&&(yield*t(e.changes))}}()},isEmpty:function(e){return 0===e.length}},xh={additionalProperties:!1},Eh=m.ZU.Union([Kc,m.ZU.Null()]),Th=m.ZU.Tuple([Kc]),kh=Fe([[0,De]]);function Nh(e,t){var n;const r=function(e){const t=gh(e);return{encode:(e,n)=>"self"===e?null:t.encode(e,n),decode:(e,n)=>null===e?"self":t.decode(e,n),encodedSchema:Eh}}(t);return{encode:(t,n)=>{const i={};if(t.moves.length>0){i.m=[];for(const[e,s,o]of t.moves)i.m.push([r.encode(e,n),r.encode(s,n),"nodeTargeting"===o])}if(t.childChanges.length>0){i.c=[];for(const[s,o]of t.childChanges)i.c.push([r.encode(s,n),e.encode(o,n)])}return void 0!==t.reservedDetachId&&(i.d=r.encode(t.reservedDetachId,n)),i},decode:(t,n)=>{var i,s,o,a;const c=null!==(i=null===(s=t.m)||void 0===s?void 0:s.map((e=>{let[t,i,s]=e;return[r.decode(t,n),r.decode(i,n),s?"nodeTargeting":"cellTargeting"]})))&&void 0!==i?i:[],l={moves:c,childChanges:null!==(o=null===(a=t.c)||void 0===a?void 0:a.map((t=>{let[i,s]=t;return[r.decode(i,n),e.decode(s,n)]})))&&void 0!==o?o:[]};return void 0!==t.d&&(l.reservedDetachId=r.decode(t.d,n)),l},encodedSchema:(i=null!==(n=e.encodedSchema)&&void 0!==n?n:m.ZU.Any(),m.ZU.Object({b:m.ZU.Optional(m.ZU.Array(Th)),m:m.ZU.Optional(m.ZU.Array(m.ZU.Tuple([Eh,Eh,m.ZU.Optional(m.ZU.Boolean())]))),c:m.ZU.Optional(m.ZU.Array(m.ZU.Tuple([Eh,i]))),d:m.ZU.Optional(Eh)},xh))};var i}class Fh{constructor(){this.nestedMapData=new ke}clone(){const e=new Fh;for(const[t,n]of this.entries())e.set(t,n);return e}set(e,t){"self"===e?this.nestedMapData.set("self",void 0,t):this.nestedMapData.set(e.localId,e.revision,t)}get(e){return"self"===e?this.nestedMapData.tryGet(e,void 0):this.nestedMapData.tryGet(e.localId,e.revision)}has(e){return void 0!==this.get(e)}delete(e){return"self"===e?this.nestedMapData.delete("self",void 0):this.nestedMapData.delete(e.localId,e.revision)}keys(){const e=[];for(const[t,n]of this.nestedMapData)if("self"===t)e.push("self");else for(const[r,i]of n)e.push(void 0===r?{localId:t}:{localId:t,revision:r});return e}values(){return this.nestedMapData.values()}entries(){const e=[];for(const t of this.keys())if("self"===t){const t=this.nestedMapData.tryGet("self",void 0);(0,i.v)(void 0!==t,1904),e.push(["self",t])}else{const n=this.nestedMapData.tryGet(t.localId,t.revision);(0,i.v)(void 0!==n,1905),e.push([t,n])}return e}get size(){return this.nestedMapData.size}}function Ih(e){if(void 0!==e.reservedDetachId)return"empty";for(const[t]of e.moves)if("self"===t)return"filled"}const Ah={compose:(e,t,n,r,s)=>{let o,a;const c=new Fh,l=(e=>{const t=new Fh,n=new Fh;for(const[r,i,s]of e)t.set(r,[i,s]),n.set(i,r);return{srcToDst:t,dstToSrc:n}})([]);for(const{change:m,revision:g}of e){var u;null!==(u=a)&&void 0!==u||(a=Ih(m));const e=e=>{var t;if("self"===e)return e;return{revision:sc(null!==(t=e.revision)&&void 0!==t?t:g,s),localId:e.localId}},t=new Fh,n=new Fh;void 0!==m.reservedDetachId&&void 0===o&&(o=e(m.reservedDetachId));for(const[r,s,o]of m.moves){const a=e(r),c=e(s);let u,d=l.dstToSrc.get(a);if(void 0!==d){var h;const[e,t]=null!==(h=l.srcToDst.get(d))&&void 0!==h?h:T("expected backward mapping");(0,i.v)(Ph(e,a),2133),u=t}else d=a;t.set(d,[c,"cellTargeting"!==o||void 0!==u&&"cellTargeting"!==u?"nodeTargeting":"cellTargeting"]),n.set(c,d)}for(const[r,[i,s]]of l.srcToDst.entries())if(!t.has(r)){const o=e(i);t.set(r,[o,s]),n.set(o,r)}for(const[r,i]of m.childChanges){var d;const t=e(r),n=null!==(d=l.dstToSrc.get(t))&&void 0!==d?d:t,s=c.get(n),o=Co(i,g);void 0===s?c.set(n,[o]):s.push(o)}l.srcToDst=t,l.dstToSrc=n}const f=[];for(const[i,[m,g]]of l.srcToDst.entries())f.push([i,m,g]);const p={moves:f,childChanges:Array.from(c.entries(),(e=>{let[n,r]=e;return[n,t(r)]}))};return"empty"===a&&(p.reservedDetachId=o),p},amendCompose:()=>T("Not implemented"),invert:(e,t,n)=>{let{revision:r,change:i}=e;const{moves:s,childChanges:o}=i,a=new Fh,c=e=>{var t;return"self"===e?e:{revision:null!==(t=e.revision)&&void 0!==t?t:r,localId:e.localId}};for(const[f,p]of s)a.set(f,p);let l=!1,u=!1;const h=[];for(const[f,p]of s){l||(l="self"===f),u||(u="self"===p);const e="self"!==f&&"self"===p?"cellTargeting":"nodeTargeting";h.push([c(p),c(f),e])}const d={moves:h,childChanges:o.map((e=>{var n;let[r,i]=e;return[c(null!==(n=a.get(r))&&void 0!==n?n:r),t(i)]}))};return l&&!u&&(d.reservedDetachId={localId:n.getNextId()}),d},rebase:(e,t,n,r,s,o,a)=>{const c=e=>{var n;if("self"===e)return e;return{revision:sc(null!==(n=e.revision)&&void 0!==n?n:t.revision,o),localId:e.localId}},{moves:l,childChanges:u}=e,{change:h}=t,d=[],f=new Fh,p=new Fh;for(const[i,T]of h.moves){const e=c(i),t=c(T);p.set(e,t),f.set(t,e)}let m=e.reservedDetachId;const g=new Fh,v=new Fh;for(const[i,T]of l)v.set(i,T),g.set(T,i);for(const[T,k,N]of l)if("cellTargeting"===N)(0,i.v)("self"===T,2135),void 0!==p.get(T)&&void 0===f.get(T)&&void 0===m?m=k:d.push([T,k,N]);else{var y;const e=null!==(y=p.get(T))&&void 0!==y?y:T;d.push([e,k,N])}!p.has("self")&&f.has("self")&&void 0!==m&&(d.push(["self",m,"cellTargeting"]),m=void 0);const b=new Fh;for(const[i,T]of null!==(S=h.childChanges)&&void 0!==S?S:[]){var S,w;b.set(null!==(w=c(i))&&void 0!==w?w:i,T)}const C=[];for(const[i,T]of u){var x;const e=b.get(i),t=null!==(x=p.get(i))&&void 0!==x?x:i,r=n(T,e,"self"===t?rc.Alive:rc.Dead);void 0!==r&&C.push([t,r])}const E={moves:d,childChanges:C};return void 0!==m&&(E.reservedDetachId=m),E},prune:(e,t)=>{const n={moves:e.moves,childChanges:[]};void 0!==e.reservedDetachId&&(n.reservedDetachId=e.reservedDetachId);for(const[r,i]of e.childChanges){const e=t(i);void 0!==e&&n.childChanges.push([r,e])}return n}},Dh={set:(e,t)=>{const n={moves:[[{localId:t.fill},"self","nodeTargeting"]],childChanges:[]};return e?n.reservedDetachId={localId:t.detach}:n.moves.push(["self",{localId:t.detach},"cellTargeting"]),n},clear:(e,t)=>e?{moves:[],childChanges:[],reservedDetachId:{localId:t}}:{moves:[["self",{localId:t},"cellTargeting"]],childChanges:[]},buildChildChange:(e,t)=>((0,i.v)(0===e,1028),{moves:[],childChanges:[["self",t]]})};const Oh={rebaser:Ah,codecsFactory:(e,t)=>Fe([[0,Nh(e,t)]]),editor:Dh,intoDelta:function(e,t){let{change:n,revision:r}=e;const i={};let s=!0;const o={count:1};if(n.moves.length>0){const e=[];for(const[t,i]of n.moves){var a;if("self"===t&&"self"!==i)o.detach={major:null!==(a=i.revision)&&void 0!==a?a:r,minor:i.localId},s=!1;else if("self"===i&&"self"!==t){var c;o.attach={major:null!==(c=t.revision)&&void 0!==c?c:r,minor:t.localId},s=!1}else if("self"!==t&&"self"!==i){var l,u;e.push({count:1,oldId:{major:null!==(l=t.revision)&&void 0!==l?l:r,minor:t.localId},newId:{major:null!==(u=i.revision)&&void 0!==u?u:r,minor:i.localId}})}}e.length>0&&(i.rename=e)}if(n.childChanges.length>0){const e=[];for(const[i,a]of n.childChanges){const n=t(a);if("self"!==i){var h;const t=n;e.push({id:{major:null!==(h=i.revision)&&void 0!==h?h:r,minor:i.localId},fields:t})}else o.fields=n,s=!1}e.length>0&&(i.global=e)}return s||(i.local=[o]),i},relevantRemovedRoots:function(e,t){let{change:n,revision:r}=e;return function*(){const e=new Fh;for(const[t]of n.moves)"self"===t||e.has(t)||(e.set(t,!0),yield Sh(t,r));for(const[r,i]of n.childChanges)"self"===r||e.has(r)||(e.set(r,!0),yield Sh(r)),yield*t(i)}()},isEmpty:e=>0===e.childChanges.length&&0===e.moves.length&&void 0===e.reservedDetachId};function Ph(e,t){return"string"===typeof e||"string"===typeof t?e===t:qe(e,t)}const Rh={rebaser:(Mh={compose:e=>0,invert:e=>0,rebase:(e,t)=>0},function(e){return{...e,amendCompose:()=>T("Not implemented"),prune:e=>e}}({compose:(e,t,n)=>Mh.compose(e.map((e=>e.change))),invert:(e,t,n)=>Mh.invert(e.change),rebase:(e,t,n,r)=>Mh.rebase(e,t.change)})),codecsFactory:()=>kh,editor:{buildChildChange:(e,t)=>T("Child changes not supported")},intoDelta:(e,t)=>({}),relevantRemovedRoots:e=>[],isEmpty:e=>!0};var Mh;const Bh="Optional",Lh=new gc(Bh,Pa.Optional,Oh,((e,t)=>(t.kind.identifier===Hh.identifier||t.kind.identifier===Bh)&&cc(e,t.types)),new Set([])),qh={...Dh,set:e=>Dh.set(!1,e)},_h={...Lh.changeHandler,editor:qh},jh="Value",zh=new gc(jh,Pa.Single,_h,((e,t)=>(t.kind.identifier===Hh.identifier||t.kind.identifier===jh||t.kind.identifier===Lh.identifier||t.kind.identifier===Kh.identifier)&&cc(e,t.types)),new Set),Uh="Sequence",Hh=new gc(Uh,Pa.Sequence,Ch,((e,t)=>t.kind.identifier===Uh&&cc(e,t.types)),new Set([])),Vh="NodeKey",Kh=new gc(Vh,Pa.Single,Rh,((e,t)=>(t.kind.identifier===Hh.identifier||t.kind.identifier===jh||t.kind.identifier===Lh.identifier||t.kind.identifier===Vh)&&cc(e,t.types)),new Set),Gh=new gc(re,Pa.Forbidden,Rh,((e,t)=>{var n;return(null===(n=Wh.get(t.kind.identifier))||void 0===n?void 0:n.multiplicity)!==Pa.Single}),new Set),Wh=new Map([zh,Lh,Hh,Kh,Gh].map((e=>[e.identifier,e]))),Jh={required:zh,optional:Lh,sequence:Hh,nodeKey:Kh,forbidden:Gh},Zh={fieldKinds:Wh};function $h(e,t,n){const r=e.fields.get(t);if(void 0!==r)return r;if(!1===n)return[];const i=[];return e.fields.set(t,i),i}function Qh(e){return wa(Yh,e)}function Xh(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:mt;return function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:mt;const r=wa(e,t);return r.enterField(n),r}(Yh,{type:vt,fields:new Map([[t,e]])},t)}const Yh={value:e=>e.value,type:e=>e.type,keysFromNode:e=>[...e.fields.keys()],getFieldFromNode:(e,t)=>{var n;return null!==(n=e.fields.get(t))&&void 0!==n?n:[]}};function ed(e){(0,i.v)(0===e.mode,951);const t=new Map;for(let n=e.firstField();n;n=e.nextField()){const n=ga(e,ed);t.set(e.getFieldKey(),n)}return{type:e.type,value:e.value,fields:t}}class td{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new oa;this.anchors=e,this.roots={type:vt,fields:new Map},this.currentCursors=new Set,this.events=z(),this.nextRange=0}get isEmpty(){return 0===this.roots.fields.size}on(e,t){return this.events.on(e,t)}clone(e,t){const n=new td(t);for(const[r,i]of this.roots.fields)n.roots.fields.set(r,i.map((e=>ed(Qh(e)))));return n}forgetAnchor(e){this.anchors.forget(e)}acquireVisitor(){(0,i.v)(void 0===this.activeVisitor,1900),this.events.emit("beforeChange"),(0,i.v)(0===this.currentCursors.size,884);const e=this.allocateCursor();e.setToAboveDetachedSequences();const t={forest:this,cursor:e,free(){this.cursor.free(),(0,i.v)(void 0!==this.forest.activeVisitor,1901),this.forest.activeVisitor=void 0,this.forest.events.emit("afterChange")},destroy(e,t){this.forest.delete(e)},create(e,t){this.forest.add(e,t)},attach(e,t,n){this.attachEdit(e,t,n)},detach(e,t){this.detachEdit(e,t)},attachEdit(t,n,r){if(M(n),0===n)return;const[s,o]=e.getParent();(0,i.v)(s!==this.forest.roots||o!==t,1974);const a=$h(s,o,!0);P(r,a,!0);const c=$h(this.forest.roots,t,!1);(0,i.v)(void 0!==c,1975),(0,i.v)(c.length===n,1976),a.splice(r,0,...c),this.forest.delete(t)},detachEdit(t,n){const[r,s]=e.getParent();(0,i.v)(void 0===n||r!==this.forest.roots||s!==n,1977);const o=$h(r,s,!0);R(t,o);const a=o.splice(t.start,t.end-t.start);void 0!==n&&this.forest.addFieldAsDetached(a,n),0===o.length&&r.fields.delete(s)},replace(e,t,n){(0,i.v)(e!==n,1978),this.detachEdit(t,n),this.attachEdit(e,t.end-t.start,t.start)},enterNode(e){this.cursor.enterNode(e)},exitNode(e){this.cursor.exitNode()},enterField(e){this.cursor.enterField(e)},exitField(e){this.cursor.exitField()}};return this.activeVisitor=t,t}newDetachedField(){const e=String(this.nextRange);return this.nextRange+=1,e}add(e,t){const n=Array.from(e,ed);this.addFieldAsDetached(n,t)}addFieldAsDetached(e,t){(0,i.v)(!this.roots.fields.has(t),880),e.length>0&&this.roots.fields.set(t,e)}delete(e){this.roots.fields.delete(e)}allocateCursor(){return new nd(this)}tryMoveCursorToNode(e,t){const n=this.anchors.locate(e);return void 0===n?-1:(this.moveCursorToPath(n,t),1)}tryMoveCursorToField(e,t){if(void 0===e.parent)this.moveCursorToPath(void 0,t);else{const n=this.tryMoveCursorToNode(e.parent,t);if(1!==n)return n}return t.enterField(e.fieldKey),1}moveCursorToPath(e,t){(0,i.v)(t instanceof nd,823),(0,i.v)(t.forest===this,824);const n=[],r=[];let s=e;for(;void 0!==s;)n.push(s.parentIndex),r.push(s.parentField),s=s.parent;for(t.setToAboveDetachedSequences();r.length>0;)t.enterField(r.pop()),t.enterNode(n.pop())}getCursorAboveDetachedFields(){return Qh(this.roots)}}class nd extends Ca{constructor(e,t){super(),this.forest=e,this.innerCursor=t,void 0===t?this.state=bt.Cleared:(this.state=bt.Current,this.forest.currentCursors.add(this))}buildFieldAnchor(){const e=this.getFieldPath();return{parent:void 0===e.parent?void 0:this.forest.anchors.track(e.parent),fieldKey:e.field}}getFieldPath(e){return(0,i.v)(void 0!==this.innerCursor,1119),this.innerCursor.getFieldPath(e)}get mode(){return(0,i.v)(void 0!==this.innerCursor,1070),this.innerCursor.mode}nextField(){return(0,i.v)(void 0!==this.innerCursor,1071),this.innerCursor.nextField()}exitField(){return(0,i.v)(void 0!==this.innerCursor,1072),this.innerCursor.exitField()}skipPendingFields(){return(0,i.v)(void 0!==this.innerCursor,1073),this.innerCursor.skipPendingFields()}getFieldKey(){return(0,i.v)(void 0!==this.innerCursor,1074),this.innerCursor.getFieldKey()}getFieldLength(){return(0,i.v)(void 0!==this.innerCursor,1075),this.innerCursor.getFieldLength()}firstNode(){return(0,i.v)(void 0!==this.innerCursor,1076),this.innerCursor.firstNode()}enterNode(e){return(0,i.v)(void 0!==this.innerCursor,1077),this.innerCursor.enterNode(e)}getPath(e){var t;return(0,i.v)(void 0!==this.innerCursor,1078),null!==(t=this.innerCursor.getPath(e))&&void 0!==t?t:T("no path when at root")}get fieldIndex(){return(0,i.v)(void 0!==this.innerCursor,1079),this.innerCursor.fieldIndex}get chunkStart(){return(0,i.v)(void 0!==this.innerCursor,1080),this.innerCursor.chunkStart}get chunkLength(){return(0,i.v)(void 0!==this.innerCursor,1081),this.innerCursor.chunkLength}seekNodes(e){return(0,i.v)(void 0!==this.innerCursor,1082),this.innerCursor.seekNodes(e)}nextNode(){return(0,i.v)(void 0!==this.innerCursor,1083),this.innerCursor.nextNode()}exitNode(){return(0,i.v)(void 0!==this.innerCursor,1084),this.innerCursor.exitNode()}firstField(){return(0,i.v)(void 0!==this.innerCursor,1085),this.innerCursor.firstField()}enterField(e){return(0,i.v)(void 0!==this.innerCursor,1086),this.innerCursor.enterField(e)}get type(){return(0,i.v)(void 0!==this.innerCursor,1087),this.innerCursor.type}get value(){return(0,i.v)(void 0!==this.innerCursor,1088),this.innerCursor.value}clear(){(0,i.v)(this.state!==bt.Freed,827),this.state=bt.Cleared,this.innerCursor=void 0,this.forest.currentCursors.delete(this)}setToAboveDetachedSequences(){(0,i.v)(this.state!==bt.Freed,828),this.clear(),this.state=bt.Current,this.innerCursor=Qh(this.forest.roots),this.forest.currentCursors.add(this)}getNode(){return(0,i.v)(void 0!==this.innerCursor,830),this.innerCursor.getNode()}getParent(){(0,i.v)(void 0!==this.innerCursor,1089);const e=this.innerCursor.getFieldKey();this.innerCursor.exitField();const t=this.innerCursor.getNode();return this.innerCursor.enterField(e),[t,e]}fork(){return(0,i.v)(void 0!==this.innerCursor,1120),new nd(this.forest,this.innerCursor.fork())}free(){(0,i.v)(this.state!==bt.Freed,831),this.forest.currentCursors.delete(this),this.state=bt.Freed}buildAnchor(){return(0,i.v)(this.state===bt.Current,890),this.forest.anchors.track(this.getPath())}}function rd(e){return new td(e)}const id=m.ZU.Object({version:m.ZU.Literal(J),nodes:m.ZU.Record(m.ZU.String(),te),root:Y},{additionalProperties:!1});function sd(e){return Re(e,new Set([J]),id,{encode:e=>function(e){const t=Object.create(null),n=fe(e.rootFieldSchema);for(const i of[...e.nodeSchema.keys()].sort()){var r;const n=null!==(r=e.nodeSchema.get(i))&&void 0!==r?r:T("missing schema");Object.defineProperty(t,i,{enumerable:!0,configurable:!0,writable:!0,value:n.encode()})}return{version:J,nodes:t,root:n}}(e),decode:e=>function(e){const t=new Map;for(const[n,r]of Object.entries(e.nodes))t.set(n,le.dispatch(r));return{rootFieldSchema:pe(e.root),nodeSchema:t}}(e)})}const od="SchemaString";class ad{constructor(e,t,n,r){this.runtime=e,this.schema=t,this.key="Schema",this.codec=sd(n),this.schema.on("afterSchemaChange",(()=>{this.schemaIndexLastChangedSeq=r.getCurrentSeq()}))}getAttachSummary(e,t,n,r,i){const s=new Pt;if(void 0!==i&&void 0!==this.schemaIndexLastChangedSeq&&i.latestSummarySequenceNumber>=this.schemaIndexLastChangedSeq)s.addHandle(od,Et.Blob,"".concat(i.summaryPath,"/indexes/").concat(this.key,"/").concat(od));else{const e=JSON.stringify(this.codec.encode(this.schema));s.addBlob(od,e)}return s.getSummaryTree()}async summarize(e,t,n,r,i){throw new Error("Method not implemented.")}getGCData(e){return{gcNodes:{}}}async load(e,t){const n=await e.readBlob(od);(0,i.v)(ge(this.schema),986);const r=(0,Ne.JR)(n,"utf-8"),s=this.codec.decode(JSON.parse(r));this.schema.apply(s),this.schemaIndexLastChangedSeq=0}}var cd;!function(e){e[e.Compressed=0]="Compressed",e[e.Uncompressed=1]="Uncompressed"}(cd||(cd={}));const ld={topLevelLength:0,cursor:()=>hd,referenceAdded(){},referenceRemoved(){},isShared:()=>!1},ud={parent:void 0,field:Fa},hd={[la]:!0,pending:!1,mode:1,[Ia]:ld,nextField(){T("cannot navigate above root")},exitField(){T("cannot navigate above root")},skipPendingFields:()=>!0,getFieldKey:()=>ud.field,getFieldLength:()=>0,firstNode:()=>!1,enterNode(e){T("empty cursor has no nodes")},getFieldPath:e=>Ta(e,ud),getPath(){T("empty cursor has no nodes")},get fieldIndex(){return T("empty cursor has no nodes")},get chunkStart(){return T("empty cursor has no nodes")},get chunkLength(){return T("empty cursor has no nodes")},seekNodes(e){T("empty cursor has no nodes")},nextNode(){T("empty cursor has no nodes")},exitNode(){T("empty cursor has no nodes")},firstField(){T("empty cursor has no nodes")},enterField(e){T("empty cursor has no nodes")},get type(){return T("empty cursor has no nodes")},get value(){return T("empty cursor has no nodes")},atChunkRoot:()=>!0,fork:()=>hd};function dd(e,t){return void 0===e?void 0===t:fd(e,t)}function fd(e,t){switch(e){case ne.String:return"string"===typeof t;case ne.Number:return"number"===typeof t;case ne.Boolean:return"boolean"===typeof t;case ne.FluidHandle:return pd(t);case ne.Null:return null===t;default:wt(e)}}function pd(e){if("object"!==typeof e||null===e||!("IFluidHandle"in e))return!1;const t=e.IFluidHandle===e;return"function"===typeof e.get&&t}function md(e){(0,i.v)(function(e){switch(typeof e){case"string":case"number":case"boolean":return!0;case"object":return null===e||pd(e);default:return!1}}(e),2115)}class gd{constructor(){this.counts=new Map}add(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const r=null!==(t=this.counts.get(e))&&void 0!==t?t:0;this.counts.set(e,r+n)}buildTable(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:()=>!0;const t=[...this.counts.keys()];t.sort(((e,t)=>{var n,r;return(null!==(n=this.counts.get(t))&&void 0!==n?n:0)-(null!==(r=this.counts.get(e))&&void 0!==r?r:0)}));const n=[];for(const i of t){var r;e(i,n.length,null!==(r=this.counts.get(i))&&void 0!==r?r:0)&&n.push(i)}return{indexToValue:n,valueToIndex:new Map(n.map(((e,t)=>[e,t])))}}}function vd(e,t,n){const r=JSON.stringify(e);return String(t).length*n+r.length+1<r.length*n}function yd(e,t){return P(t,e),e[t]}function bd(e){const t=yd(e.data,e.offset);return e.offset++,t}function Sd(e){const t=bd(e);return md(t),t}class wd{constructor(e,t){this.identifiers=e,this.shapes=t}identifier(e){return"string"===typeof e?e:yd(this.identifiers,e)}}function Cd(e,t){const n=bd(e);return(0,i.v)("number"===typeof n||"string"===typeof n,1851),t.identifier(n)}function xd(e){return function(e,t,n,r){const s=n.shapes.map((n=>e.dispatch(n,t))),o=[];for(const a of n.data){const e={data:a,offset:0},t=r.decode(s,e);(0,i.v)(e.offset===e.data.length,1850),o.push(t)}return o}(Ed,new wd(e.identifiers,e.shapes),e,Ad)}const Ed=new K({a:(e,t)=>new Fd(e),b:(e,t)=>new Id(e),c:(e,t)=>new Od(e,t),d:e=>Ad});function Td(e,t){return void 0===t?function(e){const t=bd(e);return(0,i.v)("boolean"===typeof t,1841),t}(e)?Sd(e):void 0:!0===t?Sd(e):!1!==t?Array.isArray(t)?((0,i.v)(1===t.length,1844),t[0]):void wt(t,"decoding values as deltas is not yet supported"):void 0}function kd(e){if(e===ld)return[];if(e instanceof za){(0,i.v)(e.subChunks.length>0,1845),(0,i.v)(e.subChunks.length>1,1846);for(const t of e.subChunks)(0,i.v)(!(t instanceof za),1847),(0,i.v)(t!==ld,1848),t.referenceAdded();return e.referenceRemoved(),e.subChunks}return[e]}function Nd(e){const t=e.flatMap(kd);switch(t.length){case 0:return ld;case 1:return t[0];default:return new za(t)}}class Fd{constructor(e){this.shape=e}decode(e,t){const n=e[this.shape],r=[],s=bd(t);if("number"===typeof s){const t={data:[],offset:0};for(let i=0;i<s;i++)r.push(n.decode(e,t))}else{(0,i.v)(Array.isArray(s),1849);const t={data:s,offset:0};for(;t.offset!==t.data.length;)r.push(n.decode(e,t))}return Nd(r)}}class Id{constructor(e){this.shape=e}decode(e,t){const n=this.shape.length,r=e[this.shape.shape],i=[];for(let s=0;s<n;s++)i.push(r.decode(e,t));return Nd(i)}}const Ad={decode(e,t){const n=function(e){const t=bd(e);return(0,i.v)("number"===typeof t,1840),t}(t);return yd(e,n).decode(e,t)}};function Dd(e,t,n){return P(n,e.shapes),(e,r)=>[t,e[n].decode(e,r)]}class Od{constructor(e,t){this.shape=e,this.cache=t,this.type=void 0===e.type?void 0:t.identifier(e.type);const n=[];for(const[i,s]of null!==(r=e.fields)&&void 0!==r?r:[]){var r;const e=t.identifier(i);n.push(Dd(t,e,s))}this.fieldDecoders=n}decode(e,t){var n;const r=null!==(n=this.type)&&void 0!==n?n:Cd(t,this.cache),s=Td(t,this.shape.value),o=new Map;function a(e,t){const n=kd(t);0!==n.length&&o.set(e,n)}for(const i of this.fieldDecoders){const[n,r]=i(e,t);a(n,r)}if(void 0!==this.shape.extraFields){const n=e[this.shape.extraFields],r=function(e){const t=bd(e);return(0,i.v)(Array.isArray(t),1842),{data:t,offset:0}}(t);for(;r.offset!==r.data.length;){a(Cd(r,this.cache),n.decode(e,r))}}return new Da(r,o,s)}}class Pd{constructor(e){this.identifier=e}}class Rd{}function Md(e,t){const n=[];for(const r of e){const e=[];qd.encodeField(r,t,e),n.push(e)}return function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:vd;const r=new gd,i=new gd,s=new Set,o=[],a=e=>{i.add(e),s.has(e)||(s.add(e),o.push(e))},c=[t];for(const p of c)for(const e of p)e instanceof Pd?r.add(e.identifier):e instanceof Rd?a(e):Array.isArray(e)?c.push(e):null!==e&&"object"===typeof e&&e.shape instanceof Rd&&T("encoder interface instead of shape written to stream");{let e;for(;void 0!==(e=o.pop());)e.count(r,a)}const l=r.buildTable(n),u=i.buildTable();for(const p of c)for(let e=0;e<p.length;e++){const t=p[e];var h;if(t instanceof Pd)p[e]=null!==(h=l.valueToIndex.get(t.identifier))&&void 0!==h?h:t.identifier;else if(t instanceof Rd){var d;p[e]=null!==(d=u.valueToIndex.get(t))&&void 0!==d?d:T("missing shape")}}const f=u.indexToValue.map((e=>e.encodeShape(l,u)));return{version:e,identifiers:l.indexToValue,shapes:f,data:t}}(Dc,n)}class Bd extends Rd{constructor(){super()}encodeShape(e,t){return{d:0}}count(e,t){}static encodeField(e,t,n,r){n.push(r.shape),r.encodeField(e,t,n)}static encodeNode(e,t,n,r){n.push(r.shape),r.encodeNode(e,t,n)}static encodeNodes(e,t,n,r){n.push(r.shape),r.encodeNodes(e,t,n)}}Bd.instance=new Bd;const Ld={encodeNode(e,t,n){const r=t.shapeFromTree(e.type);Bd.encodeNode(e,t,n,r)},shape:Bd.instance},qd={encodeField(e,t,n){if(0===e.getFieldLength()){const r=_d.empty;Bd.encodeField(e,t,n,r)}else if(1===e.getFieldLength())e.enterNode(0),Ld.encodeNode(e,t,n),e.exitNode();else{const r=t.nestedArray(Ld);Bd.encodeField(e,t,n,r)}},shape:Bd.instance};class _d extends Rd{constructor(e,t){super(),this.length=e,this.inner=t}encodeNodes(e,t,n){for(let r=0;r<this.length;r++)this.inner.encodeNodes(e,t,n)}encodeField(e,t,n){(0,i.v)(e.getFieldLength()>=this.length,1852),e.firstNode(),this.encodeNodes(e,t,n),(0,i.v)(1===e.mode,1853)}encodeShape(e,t){var n;return{b:{length:this.length,shape:null!==(n=t.valueToIndex.get(this.inner.shape))&&void 0!==n?n:T("missing shape")}}}count(e,t){t(this.inner.shape)}get shape(){return this}}_d.empty=new _d(0,{get shape(){return _d.empty},encodeNodes(e,t,n){T("Empty array should not encode any nodes")}});class jd extends Rd{constructor(e){super(),this.inner=e,this.shape=this}encodeField(e,t,n){const r=[];let s=!0;const o=e.getFieldLength();ya(e,(()=>{const n=r.length;this.inner.encodeNode(e,t,r),s&&(s=r.length-n!==0)})),0===r.length?n.push(o):((0,i.v)(s,1854),n.push(r))}encodeShape(e,t){var n;return{a:null!==(n=t.valueToIndex.get(this.inner.shape))&&void 0!==n?n:T("index for shape not found in table")}}count(e,t){t(this.inner.shape)}}class zd{constructor(e,t,n){this.treeEncoder=e,this.fieldEncoder=t,this.fieldShapes=n,this.shapesFromSchema=new Map,this.nestedArrays=new Map}shapeFromTree(e){return F(this.shapesFromSchema,e,(()=>this.treeEncoder(this,e)))}nestedArray(e){return F(this.nestedArrays,e,(()=>new jd(e)))}shapeFromField(e){return new Ud(this,e,this.fieldEncoder)}}class Ud{constructor(e,t,n){this.cache=e,this.field=t,this.fieldEncoder=n}encodeField(e,t,n){this.encoder.encodeField(e,t,n)}get encoder(){return void 0===this.encoderLazy&&(this.encoderLazy=this.fieldEncoder(this.cache,this.field)),this.encoderLazy}get shape(){return this.encoder.shape}}class Hd extends Rd{constructor(e,t,n,r){super(),this.type=e,this.value=t,this.fields=n,this.extraLocal=r,this.explicitKeys=new Set(this.fields.map((e=>e.key)))}encodeNode(e,t,n){void 0===this.type?n.push(new Pd(e.type)):(0,i.v)(e.type===this.type,1857),function(e,t,n){void 0===t?void 0!==e?n.push(!0,e):n.push(!1):!0===t?((0,i.v)(void 0!==e,1933),n.push(e)):!1===t?(0,i.v)(void 0===e,1855):Array.isArray(t)?(0,i.v)(1===t.length,1856):wt(t,"Encoding values as deltas is not yet supported")}(e.value,this.value,n);for(const i of this.fields)e.enterField(i.key),i.shape.encodeField(e,t,n),e.exitField();const r=[];ma(e,(()=>{const n=e.getFieldKey();this.explicitKeys.has(n)||((0,i.v)(void 0!==this.extraLocal,1858),r.push(new Pd(n)),this.extraLocal.encodeField(e,t,r))})),void 0!==this.extraLocal&&n.push(r)}encodeShape(e,t){return{c:{type:Gd(this.type,e),value:this.value,fields:Vd(this.fields,e,t),extraFields:Wd(this.extraLocal,t)}}}count(e,t){void 0!==this.type&&e.add(this.type);for(const n of this.fields)e.add(n.key),t(n.shape.shape);void 0!==this.extraLocal&&t(this.extraLocal.shape)}get shape(){return this}}function Vd(e,t,n){if(0!==e.length)return e.map((e=>{var r;return[Kd(e.key,t),null!==(r=n.valueToIndex.get(e.shape.shape))&&void 0!==r?r:T("missing shape")]}))}function Kd(e,t){var n;return null!==(n=t.valueToIndex.get(e))&&void 0!==n?n:e}function Gd(e,t){return void 0===e?void 0:Kd(e,t)}function Wd(e,t){return void 0===e?void 0:function(e,t){var n;return null!==(n=t.valueToIndex.get(e))&&void 0!==n?n:T("missing shape")}(e.shape,t)}function Jd(e,t,n){return Md(n,function(e,t){const n=new zd(((t,n)=>function(e,t,n,r){var i;const s=null!==(i=e.nodeSchema.get(r))&&void 0!==i?i:T("missing schema");if(s instanceof oe){const e=[];for(const[t,r]of null!==(o=s.objectNodeFields)&&void 0!==o?o:[]){var o;e.push({key:t,shape:n.shapeFromField(r)})}return new Hd(r,!1,e,void 0)}if(s instanceof ce){const e=new Hd(r,function(e){switch(e){case void 0:return!1;case ne.Number:case ne.String:case ne.Boolean:case ne.FluidHandle:return!0;case ne.Null:return[null];default:wt(e)}}(s.leafValue),[],void 0);return e}if(s instanceof ae){return new Hd(r,!1,[],n.shapeFromField(s.mapFields))}T("unsupported node kind")}(e,0,t,n)),((e,t)=>function(e,t,n){var r;const i=null!==(r=n.fieldShapes.get(t.kind.identifier))&&void 0!==r?r:T("missing FieldKind"),s=function(e){if(void 0===e)return;if(1!==e.size)return;for(const t of e)return t}(t.types),o=void 0!==s?e.shapeFromTree(s):Ld;return i.multiplicity===Pa.Single?(a=o,{encodeField(e,t,n){ya(e,(()=>a.encodeNode(e,t,n)))},shape:a.shape}):n.nestedArray(o);var a}(e,t,n)),t.fieldKinds);return n}(e,t))}function Zd(e){const t=e.map(Yd);return{version:Dc,identifiers:[],shapes:[{c:Qd},{a:Xd}],data:t.map((e=>[$d,e]))}}const $d=1,Qd={extraFields:$d},Xd=0;function Yd(e){const t=[];return ya(e,(()=>{t.push(e.type);const n=e.value;t.push(void 0!==n),void 0!==n&&t.push(n);const r=[];ma(e,(()=>{const t=e.getFieldKey();r.push(t,Yd(e))})),t.push(r)})),t}function ef(e,t){return Re(e,Oc,Uc,{encode:e=>{for(const t of e)(0,i.v)(1===t.mode,2211);let n;switch(t.encodeType){case cd.Uncompressed:n=Zd(e);break;case cd.Compressed:n=void 0!==t.schema?Jd(t.schema.schema,t.schema.policy,e):Zd(e);break;default:wt(t.encodeType)}return n},decode:e=>xd(e).map((e=>e.cursor()))})}const tf=m.ZU.Object({version:m.ZU.Literal(1),keys:m.ZU.Array(Z),fields:Pe},{additionalProperties:!1});const nf="ForestTree";class rf{constructor(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{jsonValidator:f};this.forest=e,this.idCompressor=t,this.key="Forest",this.codec=function(e,t){const n=t;return Re(e,new Set([1]),tf,{encode:e=>{const t=[],r=[];for(const[n,i]of e)t.push(n),r.push(i);return{keys:t,fields:n.encode(r),version:1}},decode:e=>{const t=new Map,r=n.decode(e.fields);(0,i.v)(e.keys.length===r.length,2193);for(let n=0;n<r.length;n++)t.set(e.keys[n],r[n]);return t}})}(r,n)}getTreeString(e){const t=this.forest.getCursorAboveDetachedFields(),n=new Map;ma(t,(e=>{const t=e.getFieldKey(),r=this.forest.allocateCursor();(0,i.v)(1===this.forest.tryMoveCursorToField({fieldKey:t,parent:void 0},r),2194),n.set(t,r)}));const r=this.codec.encode(n);return n.forEach((e=>e.free())),e(r)}getAttachSummary(e,t,n,r){return Bo(nf,this.getTreeString(e))}async summarize(e,t,n,r){return Bo(nf,this.getTreeString(e))}getGCData(e){return{gcNodes:{}}}async load(e,t){if(await e.contains(nf)){const n=await e.readBlob(nf),r=(0,Ne.JR)(n,"utf8"),s=this.codec.decode(t(r)),o=ve(),a=[];for(const[e,t]of s){const n=Ka(t,Za).flatMap((e=>ga(e.cursor(),(e=>e.fork())))),r={minor:o.allocate(n.length)};a.push([e,{build:[{id:r,trees:n}],local:[{count:n.length,attach:r}]}])}(0,i.v)(this.forest.isEmpty,1943),function(e,t,n){const r=t.acquireVisitor();et(e,r,n),r.free()}({fields:new Map(a)},this.forest,ct("init",this.idCompressor))}}}const sf="DetachedFieldIndexBlob";class of{constructor(e){this.detachedFieldIndex=e,this.key="DetachedFieldIndex"}getAttachSummary(e,t,n,r){const i=this.detachedFieldIndex.encode();return Bo(sf,e(i))}async summarize(e,t,n,r){return this.getAttachSummary(e,t,n,r)}getGCData(e){return{gcNodes:{}}}async load(e,t){if(await e.contains(sf)){const n=await e.readBlob(sf),r=t((0,Ne.JR)(n,"utf8"));this.detachedFieldIndex.loadData(r)}}}function af(e,t,n){const r=e=>{try{return e()}catch(r){return n(r),t}};return{compose:t=>r((()=>e.compose(t))),invert:(t,n)=>r((()=>e.invert(t,n))),rebase:(t,n,i)=>r((()=>e.rebase(t,n,i)))}}class cf{constructor(e,t,n,r){this.builder=e,this.name=t,this.info=n,this.stored=r}}class lf extends cf{get mapFields(){return this.info}static create(e,t,n){return new lf(e,t,n,new ae(n))}getFieldSchema(e){return this.info}}class uf extends cf{get leafValue(){return this.info}static create(e,t,n){return new uf(e,t,n,new ce(n))}getFieldSchema(e){return gf.empty}}class hf extends cf{static create(e,t,n){const r=function(e){const t={};for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)){const r=e[n];t[n]=ff(r)}return t}(n),i=B(r);return new hf(e,t,n,r,i)}constructor(e,t,n,r,i){super(e,t,n,new oe(i)),this.objectNodeFieldsObject=r,this.objectNodeFields=i}getFieldSchema(e){var t;return null!==(t=this.objectNodeFields.get(e))&&void 0!==t?t:gf.empty}}class df extends cf{static create(e,t,n){return new df(e,t,n)}constructor(e,t,n){const r=new Map([[ft,n]]);super(e,t,n,new oe(r))}getFieldSchema(e){return(null!==e&&void 0!==e?e:ft)===ft?this.info:gf.empty}}function ff(e){return void 0===e?gf.empty:((0,i.v)(e instanceof gf,1710),e)}const pf="Any";function mf(e){return 1===e.length&&e[0]===pf}class gf{static create(e,t){return new gf(e,t)}static createUnsafe(e,t){return new gf(e,t)}constructor(e,t){this.kind=e,this.allowedTypes=t,(0,i.v)(Array.isArray(t),1980);for(const n of t)n===pf?(0,i.v)(1===t.length,1981):"function"!==typeof n&&(0,i.v)(n instanceof cf,1982);this.lazyTypes=new an.d((()=>{const e=this.allowedTypes,t=vf(e);return{names:yf(e),schema:t,monomorphicChildType:t!==pf?L(t):void 0}}))}get types(){return this.lazyTypes.value.names}get allowedTypeSet(){return this.lazyTypes.value.schema}get monomorphicChildType(){return this.lazyTypes.value.monomorphicChildType}equals(e){return e.kind===this.kind&&(void 0===e.types?void 0===this.types:void 0!==this.types&&N({a:this.types,b:e.types,aExtra:()=>!1,bExtra:()=>!1}))}}function vf(e){if(mf(e))return pf;const t=e.map((e=>"function"===typeof e?e():e));return new Set(t)}function yf(e){const t=vf(e);if(t===pf)return;const n=Array.from(t,(e=>((0,i.v)(e instanceof cf,1983),e.name)));return new Set(n)}function bf(e){return{rootFieldSchema:e.rootFieldSchema,...Sf(e)}}function Sf(e){return{nodeSchema:new Map(A(e.nodeSchema.entries(),(e=>{let[t,n]=e;return[t,n.stored]})))}}function wf(e){return e instanceof lf}function Cf(e){return e instanceof uf}function xf(e){return e instanceof df}function Ef(e){return e instanceof hf}gf.empty=gf.create(Jh.forbidden,[]);class Tf{constructor(e,t,n){this.policy=e,this.adapters=t,this.schema=n,this.storedSchema=bf(n)}checkCompatibility(e){const t=this.adaptRepo(e),n=lc(this.policy,e,this.storedSchema)?ut.Compatible:lc(this.policy,t.adaptedForViewSchema,this.storedSchema)?ut.RequiresAdapters:ut.Incompatible,r=lc(this.policy,this.storedSchema,e)?ut.Compatible:lc(this.policy,this.storedSchema,t.adaptedForViewSchema)?ut.RequiresAdapters:ut.Incompatible;let i=lc(this.policy,e,this.storedSchema)?ut.Compatible:lc(this.policy,t.adaptedForViewSchema,this.storedSchema)?ut.RequiresAdapters:ut.Incompatible;return i=Math.max(i,r),{read:n,write:r,writeAllowingStoredSchemaUpdates:i}}adaptRepo(e){for(const i of null!==(t=null===(n=this.adapters)||void 0===n?void 0:n.tree)&&void 0!==t?t:[]){var t,n;dc(this.policy,this.storedSchema,this.storedSchema.nodeSchema.get(i.output))&&T("tree adapter for stored adapter.output should not be never")}const r={rootFieldSchema:this.adaptField(e.rootFieldSchema),nodeSchema:new Map};for(const[i,s]of e.nodeSchema){const e=this.adaptTree(s);r.nodeSchema.set(i,e)}return new dt(this.adapters,r)}adaptField(e){if(void 0!==e.types){const r=new Set(e.types);for(const e of null!==(t=null===(n=this.adapters)||void 0===n?void 0:n.tree)&&void 0!==t?t:[]){var t,n;r.has(e.input)&&(r.delete(e.input),r.add(e.output))}return{kind:e.kind,types:r}}return e}adaptTree(e){return e}}var kf=n(4292);const Nf="com.fluidframework.nodeKey.NodeKey";function Ff(e,t){let n=e.fields;return void 0===n&&(n={},t&&(e.fields=n)),n}function If(e,t,n){const r=Ff(e,!0);Object.defineProperty(r,t,{enumerable:!0,configurable:!0,writable:!0,value:n})}function Af(e){(0,i.v)(0===e.mode,954);const t={type:e.type};void 0!==e.value&&(t.value=e.value);for(let n=e.firstField();n;n=e.nextField()){const n=ga(e,Af);If(t,e.getFieldKey(),n)}return t}function Df(e){return(0,i.v)(1===e.mode,1994),ga(e,Af)}function Of(e){return!!ua(e)||!!(Array.isArray(e)&&e.length>=0&&ua(e[0]))}const Pf="contextuallyTyped",Rf=Symbol("".concat(Pf,":typeName")),Mf=Symbol("".concat(Pf,":value"));function Bf(e){switch(typeof e){case"string":case"number":case"boolean":return!0;default:return null===e||pd(e)}}function Lf(e){var t;return null!==(t=Wh.get(e.kind.identifier))&&void 0!==t?t:T("missing field kind")}function qf(e,t){return t===pf?new Set(e.nodeSchema.values()):t}const _f=Symbol("editable-tree:arrayLikeMarker");function jf(e){return"object"===typeof e&&null!==e&&(!0===e[_f]||Array.isArray(e))}function zf(e,t){if((0,i.v)(!Of(t),1713),(0,i.v)(void 0!==t,1714),e instanceof uf){if(Bf(t))return dd(e.leafValue,t);if(void 0===t[Mf])return!1}if(Bf(t))return!1;if(jf(t)){if(e instanceof df){return e.getFieldSchema().kind.multiplicity===Pa.Sequence}return!1}return void 0===t[Rf]||t[Rf]===e.name}function Uf(e,t,n){return Qh(Vf(e,t,n))}function Hf(e,t,n){return Gf(e,t,n).map(Qh)}function Vf(e,t,n){const r=function(e,t,n){const r=qf(e,t),i=[];for(const s of r)zf(s,n)&&i.push(s);return i}(e.schema,t,n);(0,i.v)(0!==r.length,1236),(0,i.v)(1===r.length,1237);const s=r[0];if(s instanceof uf){const e=Bf(n)?n:n[Mf];return(0,i.v)(dd(s.leafValue,e),1235),{value:e,type:s.name,fields:new Map}}if((0,i.v)(!Bf(n),2176),s instanceof df&&jf(n)){const t=Gf(e,s.getFieldSchema(),n);return{value:void 0,type:s.name,fields:new Map(t.length>0?[[ft,t]]:[])}}if((0,i.v)(!jf(n),2177),s instanceof lf||s instanceof hf||s instanceof df){const t=new Map;for(const o of function(e){const t=Reflect.ownKeys(e).filter((e=>"string"===typeof e));return t}(n)){(0,i.v)(!t.has(o),1715);const r=Gf(e,s.getFieldSchema(o),n[o]);r.length>0&&t.set(o,r)}if(s instanceof hf)for(const i of s.objectNodeFields.keys())void 0===n[i]&&Kf(i,e,s,t);const r=n[Mf];return(0,i.v)(void 0===r,1239),{value:r,type:s.name,fields:t}}T("unexpected node kind")}function Kf(e,t,n,r){const i=n.getFieldSchema(e);if(Lf(i).multiplicity===Pa.Single&&void 0!==t.fieldSource){const n=t.fieldSource(e,i);if(void 0!==n){const t=n();r.set(e,t)}}}function Gf(e,t,n){const r=Lf(t).multiplicity;if(void 0===n)return(0,i.v)(r===Pa.Forbidden||r===Pa.Optional,1240),[];if(r===Pa.Sequence){(0,i.v)(jf(n),1241);return Array.from(n,(n=>Vf(e,t.allowedTypeSet,n)))}return(0,i.v)(r===Pa.Single||r===Pa.Optional,1242),[Vf(e,t.allowedTypeSet,n)]}const Wf=Symbol("FlexList Eager");function Jf(e){return"function"===typeof e&&!0!==e[Wf]}function Zf(e){const t=e.map((e=>Jf(e)?e():e));return t}const $f=Symbol("flexTreeMarker");function Qf(e){return function(e){return"object"===typeof e&&null!==e&&$f in e}(e)&&e[$f]===Xf.Node}var Xf;!function(e){e[e.Node=0]="Node",e[e.Field=1]="Field"}(Xf||(Xf={}));const Yf=Symbol();var ep;!function(e){e[e.InDocument=0]="InDocument",e[e.Removed=1]="Removed",e[e.Deleted=2]="Deleted"}(ep||(ep={}));const tp=Symbol("onNextChange");var np,rp=function(e,t,n,r,i){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"===typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?i.call(e,n):i?i.value=n:t.set(e,n),n},ip=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"===typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};function sp(e,t,n){var r;(0,i.v)(void 0===Object.getOwnPropertyDescriptor(e,t),1910);const s=null!==(r=Object.getOwnPropertyDescriptor(n,t))&&void 0!==r?r:T("missing property");Object.defineProperty(e,t,{...s,enumerable:!0})}function op(e,t){!function(e,t){var n;(0,i.v)(!0===(null===(n=Object.getOwnPropertyDescriptor(e,t))||void 0===n?void 0:n.enumerable),1911),Object.defineProperty(e,t,{enumerable:!1})}(e,t)}const ap=Symbol("prepareForEdit"),cp=Symbol("isFreed"),lp=Symbol("tryMoveCursorToAnchor"),up=Symbol("forgetAnchor"),hp=Symbol("cursor"),dp=Symbol("anchor");class fp{constructor(e,t,n,r){this.context=e,this.schema=t,np.set(this,void 0),this[dp]=r,rp(this,np,n.fork(),"f"),e.withCursors.add(this),this.context.withAnchors.add(this),op(this,"context"),op(this,"schema"),op(this,dp)}[(np=new WeakMap,q)](){ip(this,np,"f").free(),this.context.withCursors.delete(this),this[up](this[dp]),this.context.withAnchors.delete(this)}[ap](){ip(this,np,"f").clear(),this.context.withCursors.delete(this)}[cp](){return ip(this,np,"f").state===bt.Freed}get[hp](){if(ip(this,np,"f").state!==bt.Current){(0,i.v)(ip(this,np,"f").state===bt.Cleared,1912),(0,i.v)(void 0!==this[dp],1913);const e=this[lp](this[dp],ip(this,np,"f"));(0,i.v)(1===e,1914),this.context.withCursors.add(this)}return ip(this,np,"f")}}function pp(e,t,n){const r=t.monomorphicChildType;return void 0!==r?function(e,t,n){return Cf(t)?n.value:_p(e,n)}(e,r,n):_p(e,n)}function mp(e,t,n){const r=t.kind;if(r===Jh.required)return Sa(n,0,(n=>pp(e,t,n)));if(r===Jh.optional){if(0===n.getFieldLength())return;return Sa(n,0,(n=>pp(e,t,n)))}return Ep(e,t,n)}function gp(e){const t=[];let n=e;for(;void 0!==n;)t.push(n),n=n.parent;return t.reverse(),t}function vp(e,t){return e===t||void 0!==e&&void 0!==t&&(e.parentField===t.parentField&&e.parentIndex===t.parentIndex&&vp(e.parent,t.parent))}function yp(e,t){return e.field===t.field&&vp(e.parent,t.parent)}function bp(e){return e===mt?ep.InDocument:ep.Removed}function Sp(e,t){const n=t.slots.get(Cp);if(void 0===n)return bp(wp(t,e.generationNumber));{const r=e.generationNumber;return n.generationNumber===r?bp(n.detachedField):bp(wp(t,r))}}function wp(e,t){const n=function(e){let t=e;for(;void 0!==t;){if(void 0===t.parent)return t.parentField;t=t.parent}return e.parentField}(e);return e.slots.set(Cp,{generationNumber:t,detachedField:n}),n}Object.setPrototypeOf(fp.prototype,null);const Cp=sa();function xp(e,t){let n=Math.trunc(+e);if(isNaN(n)&&(n=0),!(n<-t||n>=t))return n<0&&(n+=t),n}function Ep(e,t,n){var r;const i=n.buildFieldAnchor(),s=new(null!==(r=Dp.get(t.kind))&&void 0!==r?r:T("missing field implementation"))(e,t,n,i);if(void 0!==i.parent){var o;(null!==(o=e.forest.anchors.locate(i.parent))&&void 0!==o?o:T("parent anchor node should always exist since field is under a node")).on("afterDestroy",(()=>{s[q]()}))}return s}class Tp extends fp{get[$f](){return Xf.Field}constructor(e,t,n,r){super(e,t,n,r),(0,i.v)(1===n.mode,1915),this.key=n.getFieldKey(),op(this,"key")}is(e){return(0,i.v)(this.context.schema.policy.fieldKinds.get(e.kind.identifier)===e.kind,1916),this.schema.equals(e)}isSameAs(e){return(0,i.v)(e.context===this.context,1917),this.key===e.key&&this.parent===e.parent}get parent(){if(void 0===this[dp].parent)return;const e=this[hp];e.exitField();const t=_p(this.context,e);return e.enterField(this.key),t}[lp](e,t){return this.context.forest.tryMoveCursorToField(e,t)}[up](e){void 0!==e.parent&&this.context.forest.anchors.forget(e.parent)}get length(){return this[hp].getFieldLength()}atIndex(e){return Sa(this[hp],e,(e=>pp(this.context,this.schema,e)))}boxedAt(e){const t=xp(e,this.length);if(void 0!==t)return Sa(this[hp],t,(e=>_p(this.context,e)))}map(e){return Array.from(this,e)}mapBoxed(e){return Array.from(this[Yf](),e)}[Yf](){return va(this[hp],(e=>_p(this.context,e)))}[Symbol.iterator](){return va(this[hp],(e=>pp(this.context,this.schema,e)))}treeStatus(){if(this[cp]())return ep.Deleted;const e=this[dp],t=e.parent;if(void 0===t)return bp(e.fieldKey);const n=this.context.forest.anchors.locate(t);return(0,i.v)(void 0!==n,1918),Sp(this.context.forest.anchors,n)}getFieldPath(){return this[hp].getFieldPath()}getFieldPathForEditing(){return(0,i.v)(this.treeStatus()===ep.InDocument,1919),this.getFieldPath()}}class kp extends Tp{constructor(e,t,n,r){super(e,t,n,r),sp(this,"asArray",kp.prototype)}at(e){const t=xp(e,this.length);if(void 0!==t)return Sa(this[hp],t,(e=>pp(this.context,this.schema,e)))}get asArray(){return this.map((e=>e))}sequenceEditor(){const e=this.getFieldPathForEditing();return this.context.editor.sequenceField(e)}insertAt(e,t){P(e,this,!0);const n=ua(t)?ga(r=t,(()=>Qh(ed(r)))):Array.from(t,(e=>Uf(this.context,this.schema.allowedTypeSet,e)));var r;this.sequenceEditor().insert(e,n)}insertAtStart(e){this.insertAt(0,e)}insertAtEnd(e){this.insertAt(this.length,e)}removeAt(e){this.sequenceEditor().delete(e,1)}removeRange(e,t){const n=this.sequenceEditor(),{length:r}=this,i=null!==e&&void 0!==e?e:0,s=Math.min(r,null!==t&&void 0!==t?t:r);O(i,s,this),n.delete(i,s-i)}moveToStart(e,t){this._moveRangeToIndex(0,e,e+1,t)}moveToEnd(e,t){this._moveRangeToIndex(this.length,e,e+1,t)}moveToIndex(e,t,n){this._moveRangeToIndex(e,t,t+1,n)}moveRangeToStart(e,t,n){this._moveRangeToIndex(0,e,t,n)}moveRangeToEnd(e,t,n){this._moveRangeToIndex(this.length,e,t,n)}moveRangeToIndex(e,t,n,r){this._moveRangeToIndex(e,t,n,r)}_moveRangeToIndex(e,t,n,r){const s=void 0!==r?this.isSameAs(r)?this:r:this;if((0,i.v)(s instanceof kp,1969),O(t,n,s),void 0!==this.schema.types&&s!==this)for(let i=t;i<n;i++){var o;const e=null!==(o=s.boxedAt(t))&&void 0!==o?o:T("impossible out of bounds index");if(!this.schema.types.has(e.schema.name))throw new Error("Type in source sequence is not allowed in destination.")}const a=n-t;P(e,this,!0);const c=s.getFieldPath(),l=this.getFieldPath();this.context.editor.move(c,t,a,l,e)}}class Np extends Tp{constructor(e,t,n,r){super(e,t,n,r),sp(this,"content",Np.prototype)}valueFieldEditor(){const e=this.getFieldPathForEditing();return this.context.editor.valueField(e)}get content(){return this.atIndex(0)}set content(e){const t=ua(e)?Op(e):[Uf(this.context,this.schema.allowedTypeSet,e)],n=this.valueFieldEditor();(0,i.v)(1===t.length,1920),n.set(t[0])}get boxedContent(){var e;return null!==(e=this.boxedAt(0))&&void 0!==e?e:T("value node must have 1 item")}}class Fp extends Tp{constructor(e,t,n,r){super(e,t,n,r),sp(this,"content",Fp.prototype)}optionalEditor(){const e=this.getFieldPathForEditing();return this.context.editor.optionalField(e)}get content(){return 0===this.length?void 0:this.atIndex(0)}set content(e){const t=void 0===e?[]:ua(e)?Op(e):[Uf(this.context,this.schema.allowedTypeSet,e)],n=this.optionalEditor();(0,i.v)(t.length<=1,1921),n.set(0===t.length?void 0:t[0],0===this.length)}get boxedContent(){return 0===this.length?void 0:this.boxedAt(0)}}class Ip extends Tp{constructor(e,t,n,r){super(e,t,n,r),sp(this,"stableNodeKey",Ip.prototype)}get localNodeKey(){return this.context.nodeKeys.localize(this.stableNodeKey)}get stableNodeKey(){const e=this[hp];e.enterNode(0),(0,i.v)(e.type===Nf,1970);const t=e.value;return(0,i.v)("string"===typeof t,1971),e.exitNode(),t}}const Ap=[[Jh.forbidden,class extends Tp{}],[Jh.nodeKey,Ip],[Jh.optional,Fp],[Jh.sequence,kp],[Jh.required,Np]],Dp=new Map(Ap);function Op(e){return(0,i.v)(0===e.mode,2053),[e]}var Pp,Rp,Mp,Bp=function(e,t,n,r,i){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"===typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?i.call(e,n):i?i.value=n:t.set(e,n),n},Lp=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"===typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};const qp=sa();function _p(e,t){var n,r;const s=t.buildAnchor(),o=null!==(n=e.forest.anchors.locate(s))&&void 0!==n?n:T("cursor should point to a node that is not the root of the AnchorSet"),a=o.slots.get(qp);if(void 0!==a)return e.forest.anchors.forget(s),(0,i.v)(a.context===e,1922),a;const c=null!==(r=e.schema.nodeSchema.get(t.type))&&void 0!==r?r:T("missing schema"),l=function(e,t,n,r,i){if(wf(t))return new Up(e,t,n,r,i);if(Cf(t))return new Hp(e,t,n,r,i);if(xf(t))return new Vp(e,t,n,r,i);if(Ef(t))return function(e,t,n,r,i){const s=F(Gp,t,(()=>function(e){const t={},n={};for(const[i,s]of e.objectNodeFields){let e;switch(s.kind){case Jh.optional:case Jh.required:e=function(e){Wp(this,i,s).content=e};break;default:e=void 0}n[i]={enumerable:!0,get(){return ba(this[hp],i,(e=>mp(this.context,s,e)))},set:e},void 0!==e&&(t["set".concat(_(i))]={enumerable:!1,get:()=>e}),t["boxed".concat(_(i))]={enumerable:!1,get(){return Wp(this,i,s)}}}class r extends Kp{constructor(t,r,i,s){super(t,e,r,i,s),Object.defineProperties(this,n)}}return Object.defineProperties(r.prototype,t),r}(t)));return new s(e,n,r,i)}(e,t,n,r,i);T("unrecognized node kind")}(e,c,t,o,s);return o.slots.set(qp,l),o.on("afterDestroy",jp),l}function jp(e){var t;(null!==(t=e.slots.get(qp))&&void 0!==t?t:T("tree should only be cleaned up once"))[q]()}class zp extends fp{get[(Pp=new WeakMap,Rp=new WeakMap,Mp=new WeakMap,$f)](){return Xf.Node}constructor(e,t,n,r,s){super(e,t,n,s),Pp.set(this,void 0),Rp.set(this,void 0),Mp.set(this,void 0),Bp(this,Rp,r,"f"),(0,i.v)(0===n.mode,1923),r.slots.set(qp,this),Bp(this,Pp,r.on("afterDestroy",jp),"f"),(0,i.v)(void 0!==this.context.schema.nodeSchema.get(this.schema.name),1924),this.type=t.name}is(e){return(0,i.v)(this.context.schema.nodeSchema.get(e.name)===e,1925),this.schema===e}[lp](e,t){return this.context.forest.tryMoveCursorToNode(e,t)}[up](e){Lp(this,Rp,"f").slots.delete(qp),Lp(this,Pp,"f").call(this),this.context.forest.anchors.forget(e)}get value(){return this[hp].value}tryGetField(e){const t=this.schema.getFieldSchema(e);return ba(this[hp],e,(e=>{if(0!==e.getFieldLength())return Ep(this.context,t,e)}))}[Yf](){return pa(this[hp],(e=>Ep(this.context,this.schema.getFieldSchema(e.getFieldKey()),e))).values()}get parentField(){const e=this[hp],t=Lp(this,Rp,"f").parentIndex;(0,i.v)(e.fieldIndex===t,1926);const n=Lp(this,Rp,"f").parentField;let r;if(e.exitNode(),(0,i.v)(n===e.getFieldKey(),1927),void 0===Lp(this,Rp,"f").parent)r=n===pt?this.context.schema.rootFieldSchema:gf.create(Jh.sequence,[pf]);else{var s;e.exitField();const t=e.type;e.enterField(n);r=(null!==(s=this.context.schema.nodeSchema.get(t))&&void 0!==s?s:T("requested schema that does not exist")).getFieldSchema(n)}const o=Ep(this.context,r,e);return e.enterNode(t),{parent:o,index:t}}treeStatus(){return this[cp]()?ep.Deleted:Sp(this.context.forest.anchors,Lp(this,Rp,"f"))}on(e,t){switch(e){case"changing":return Lp(this,Rp,"f").on("childrenChanging",(e=>t(e)));case"subtreeChanging":return Lp(this,Rp,"f").on("subtreeChanging",(e=>t(e)));case"beforeChange":return Lp(this,Rp,"f").on("beforeChange",(e=>{const n=e.slots.get(qp);(0,i.v)(void 0!==n,2003),t({target:n})}));case"afterChange":return Lp(this,Rp,"f").on("afterChange",(e=>{const n=e.slots.get(qp);(0,i.v)(void 0!==n,2004),t({target:n})}));default:wt(e)}}[tp](e){(0,i.v)(void 0===Lp(this,Mp,"f"),2054),Bp(this,Mp,Lp(this,Rp,"f").on("childrenChanged",(()=>{var t;null===(t=Lp(this,Mp,"f"))||void 0===t||t.call(this),Bp(this,Mp,void 0,"f"),e(this)})),"f");const t=Lp(this,Mp,"f");return()=>{Lp(this,Mp,"f")===t&&(Lp(this,Mp,"f").call(this),Bp(this,Mp,void 0,"f"))}}}class Up extends zp{constructor(e,t,n,r,i){super(e,t,n,r,i),sp(this,"asObject",Up.prototype)}get size(){let e=0;return ma(this[hp],(()=>e+=1)),e}keys(){return pa(this[hp],(e=>e.getFieldKey())).values()}values(){return pa(this[hp],(e=>mp(this.context,this.schema.info,e))).values()}entries(){return pa(this[hp],(e=>[e.getFieldKey(),mp(this.context,this.schema.info,e)])).values()}forEach(e,t){const n=void 0!==t?e.bind(t):e;for(const[r,i]of this.entries())n(i,r,this)}has(e){return void 0!==this.tryGetField(e)}get(e){return ba(this[hp],e,(e=>mp(this.context,this.schema.info,e)))}getBoxed(e){return ba(this[hp],e,(e=>Ep(this.context,this.schema.info,e)))}set(e,t){const n=this.getBoxed(e),r=this.schema.info;if(r.kind!==Jh.optional)throw(0,i.v)(r.kind===Jh.sequence,2055),new Error("Setting of sequence values in maps is not yet supported.");n.content=t}delete(e){this.set(e,void 0)}[Yf](){return super[Yf]()}[Symbol.iterator](){return this.entries()}get asObject(){const e=Object.create(null);return ma(this[hp],(t=>{Object.defineProperty(e,t.getFieldKey(),{value:mp(this.context,this.schema.info,t),configurable:!0,enumerable:!0})})),e}}class Hp extends zp{constructor(e,t,n,r,i){super(e,t,n,r,i),sp(this,"value",zp.prototype)}get value(){return super.value}}class Vp extends zp{get content(){return ba(this[hp],ft,(e=>mp(this.context,this.schema.info,e)))}get boxedContent(){return ba(this[hp],ft,(e=>Ep(this.context,this.schema.info,e)))}}class Kp extends zp{get localNodeKey(){const e=this.context.nodeKeyFieldKey;if(void 0===this.schema.objectNodeFields.get(e))return;const t=this.tryGetField(e);return(0,i.v)(t instanceof Ip,1972),void 0!==this.context.nodeKeyFieldKey?t.localNodeKey:void 0}}const Gp=new WeakMap;function Wp(e,t,n){return ba(e[hp],t,(t=>Ep(e.context,n,t)))}var Jp,Zp;!function(e){e[e.Optional=0]="Optional",e[e.Required=1]="Required"}(Jp||(Jp={})),function(e){e[e.Map=0]="Map",e[e.Array=1]="Array",e[e.Object=2]="Object",e[e.Leaf=3]="Leaf"}(Zp||(Zp={}));class $p{constructor(e,t){this.kind=e,this.allowedTypes=t}}const Qp=Symbol("TreeNode Type"),Xp=Symbol("Create IterableTreeListContent");class Yp{constructor(e){this.content=e}static[Xp](e){return new Yp(e)}[Symbol.iterator](){return this.content[Symbol.iterator]()}}class em{}const tm=Symbol("FlexNodeTarget"),nm=new WeakMap;function rm(e){var t;return null!==(t=nm.get(e))&&void 0!==t?t:T("Target is not associated with an flex node")}function im(e){if("object"===typeof e&&null!==e)return nm.get(e)}function sm(e){return e[tm]}function om(e,t){var n;return(0,i.v)(void 0===sm(t),2037),null===(n=nm.get(e))||void 0===n||delete n[tm],nm.set(e,t),Object.defineProperty(t,tm,{value:e,configurable:!0}),e}const am={rejectForbidden:!0,rejectEmpty:!0};function cm(e,t,n,r){const s=new Map,o={tree:[]},a=[],c=new Set,l=new Set;for(const d of n)if(c.has(d))a.push('Duplicate library named "'.concat(d.name,'"'));else{c.add(d),l.has(d.name)&&a.push('Found another library with name "'.concat(d.name,'"'));for(const[e,t]of d.nodeSchema){(0,i.v)(t.builder.name===d.name,1705);const n=s.get(e);void 0!==n?a.push('Multiple tree schema for identifier "'.concat(e,'". One from library "').concat(n.builder.name,'" and one from "').concat(t.builder.name,'"')):s.set(e,t)}for(const e of null!==(u=d.adapters.tree)&&void 0!==u?u:[]){var u;T("Adapters not yet supported")}}0!==a.length&&T(a.join("\n"));const h=function(e,t,n){const r=[];0===t.nodeSchema.size&&e.rejectEmpty&&r.push("No tree schema are included, meaning no data can possibly be stored.");void 0!==n&&function(e,t,n,r){lm(e,t,n,(()=>"Root field schema"),r)}(e,t,n,r);for(const[i,s]of t.nodeSchema)if(s instanceof lf)lm(e,t,s.info,(()=>'Map fields of "'.concat(i,'" schema from library "').concat(s.builder.name,'"')),r),s.info.kind.multiplicity===Pa.Single&&r.push('Map fields of "'.concat(i,'" schema from library "').concat(s.builder.name,'" has kind with multiplicity "Single". This is invalid since it requires all possible field keys to have a value under them.'));else if(s instanceof uf);else if(s instanceof df){const n=()=>'Field node field of "'.concat(i,'" schema from library "').concat(s.builder.name,'"');lm(e,t,s.info,n,r)}else if(s instanceof hf)for(const[n,o]of s.objectNodeFields){const a=()=>'Object node field "'.concat(n,'" of "').concat(i,'" schema from library "').concat(s.builder.name,'"');lm(e,t,o,a,r),dm(n,a,r)}else T("unrecognized node kind");return r}(t,{rootFieldSchema:r,nodeSchema:s,adapters:o,policy:Zh},r);return 0!==h.length&&T(h.join("\n")),{name:e,nodeSchema:s,adapters:o}}function lm(e,t,n,r,i){const s=n.allowedTypes;if(!mf(s)){const n=Zf(s);for(const e of n){void 0===t.nodeSchema.get(e.name)&&i.push("".concat(r(),' references type "').concat(e.name,'" from library "').concat(e.builder.name,'" which is not defined. Perhaps another type was intended, or that library needs to be added.'))}0===s.length&&e.rejectEmpty&&i.push("".concat(r()," requires children to have a type from a set of zero types. This means the field must always be empty."))}const o=n.kind,a=Zh.fieldKinds.get(o.identifier);void 0===a?i.push('"'.concat(r(),'" has unknown field kind "').concat(o.identifier,'".')):a!==o?i.push("".concat(r(),' has field kind "').concat(o.identifier,"\" which isn't a reference to the default kind with that identifier.")):o===Jh.forbidden&&e.rejectForbidden&&i.push("".concat(r(),' explicitly uses "forbidden" kind, which is not recommended.'))}const um=new Set(["constructor","context","is","on","parentField","schema","treeStatus","tryGetField","type","value","localNodeKey"]),hm=new Set(["set","boxed"]);function dm(e,t,n){const r="Pick a different field name to avoid property name collisions in the implementation. In the future this list of reserved names will be removed.";um.has(e)&&n.push("".concat(t(),' uses "').concat(e,'" one of the banned field names (').concat([...um],"). ").concat(r));for(const i of hm)if(e.startsWith(i)){const s=e.slice(i.length);s===_(s)&&n.push("".concat(t()," has name that starts with one of the banned prefixes (").concat([...hm],") followed by something other than a lowercase letter. ").concat(r))}}class fm{constructor(e,t){var n,r;this.defaultKind=e,this.finalized=!1,this.treeNodeSchema=new Map,this.adapters={},this.name=null!==(n=t.name)&&void 0!==n?n:t.scope,this.lintConfiguration={...am,...t.lint},this.libraries=new Set,this.addLibraries(...null!==(r=t.libraries)&&void 0!==r?r:[]),this.scope=t.scope}scoped(e){return"".concat(this.scope,".").concat(e)}addLibraries(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(const r of t)for(const e of r.libraries)this.libraries.add(e)}addNodeSchema(e){(0,i.v)(!this.treeNodeSchema.has(e.name),1945),this.treeNodeSchema.set(e.name,e)}finalizeCommon(e){return(0,i.v)(!this.finalized,1946),this.finalized=!0,this.libraries.add({name:this.name,nodeSchema:this.treeNodeSchema,adapters:this.adapters}),cm(this.name,this.lintConfiguration,this.libraries,e)}intoLibrary(){return{nodeSchema:this.finalizeCommon().nodeSchema,libraries:this.libraries}}intoSchema(e){const t=this.normalizeField(e),n=this.finalizeCommon(t);return{nodeSchema:n.nodeSchema,adapters:n.adapters,rootFieldSchema:t,policy:Zh}}object(e,t){const n=hf.create(this,this.scoped(e),function(e,t){const n=Object.create(null);for(const r of Object.keys(e)){const i=e[r];Object.defineProperty(n,r,{enumerable:!0,configurable:!0,writable:!0,value:t(i,r)})}return n}(t,(e=>this.normalizeField(e))));return this.addNodeSchema(n),n}objectRecursive(e,t){return this.object(e,t)}map(e,t){const n=lf.create(this,this.scoped(e),t);return this.addNodeSchema(n),n}mapRecursive(e,t){return this.map(e,t)}fieldNode(e,t){const n=df.create(this,this.scoped(e),this.normalizeField(t));return this.addNodeSchema(n),n}fieldNodeRecursive(e,t){return this.fieldNode(e,t)}static field(e,t){return gf.create(e,pm(t))}static fieldRecursive(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return gf.createUnsafe(e,n)}normalizeField(e){return function(e,t){if(e instanceof gf)return e;const n=pm(e);return gf.create(t,n)}(e,this.defaultKind)}}function pm(e){return e===pf?[pf]:e instanceof cf?[e]:((0,i.v)(Array.isArray(e),1990),e)}const mm=new class extends fm{constructor(e){super(Jh.required,e)}leaf(e,t){const n=uf.create(this,this.scoped(e),t);return this.addNodeSchema(n),n}}({scope:"com.fluidframework.leaf"}),gm=mm.leaf("number",ne.Number),vm=mm.leaf("boolean",ne.Boolean),ym=mm.leaf("string",ne.String),bm=mm.leaf("handle",ne.FluidHandle),Sm=mm.leaf("null",ne.Null),wm=[gm,vm,ym],Cm={number:gm,boolean:vm,string:ym,handle:bm,null:Sm,primitives:wm,all:[bm,Sm,...wm],library:mm.intoLibrary()};function xm(e,t,n){if(void 0===e)return;return Qh(Tm(e,t,n))}function Em(e,t,n){return Xh(km(e,t,n))}function Tm(e,t,n){if((0,i.v)(void 0!==e,2118),null===e)return Nm(e,t,n);switch(typeof e){case"number":case"string":case"boolean":return Nm(e,t,n);default:return pd(e)?Nm(e,t,n):Array.isArray(e)?function(e,t,n){const r=Fm(e,t,n);(0,i.v)(r instanceof df,2123);const s=km(e,t,r.info),o=0===s.length?[]:[[ft,s]],a=new Map(o);return{type:r.name,fields:a}}(e,t,n):e instanceof Map?function(e,t,n){const r=Fm(e,t,n),s=new Map;for(const[o,a]of e)if((0,i.v)(!s.has(o),2124),void 0!==a){const e=km(a,t,r.getFieldSchema(o));s.set(o,e)}return{type:r.name,fields:s}}(e,t,n):function(e,t,n){const r=Fm(e,t,n),s=new Map,o=Reflect.ownKeys(e).filter((e=>"string"===typeof e));for(const a of o){(0,i.v)(!s.has(a),2125);const n=e[a];if(void 0!==n){const e=km(n,t,r.getFieldSchema(a));s.set(a,e)}}return{type:r.name,fields:s}}(e,t,n)}}function km(e,t,n){const r=n.kind.multiplicity;if(void 0===e)return(0,i.v)(r===Pa.Forbidden||r===Pa.Optional,2119),[];const s=n.allowedTypeSet;if(r===Pa.Sequence){(0,i.v)(Array.isArray(e),2120);return Array.from(e,(e=>{let n=e;if(void 0===e){if(s!==pf&&!s.has(Cm.null))throw new TypeError("Received unsupported list entry value: ".concat(e,"."));n=null}return Tm(n,t,s)}))}return(0,i.v)(r===Pa.Single||r===Pa.Optional,2121),[Tm(e,t,s)]}function Nm(e,t,n){const r=function(e,t){if("number"===typeof e){if(Object.is(e,-0))return 0;if(Number.isNaN(e)||!Number.isFinite(e)){if(t===pf||t.has(Cm.null))return null;throw new TypeError("Received unsupported numeric value: ".concat(e,"."))}return e}return e}(e,n),s=Fm(r,t,n);return(0,i.v)(s instanceof uf&&dd(s.leafValue,r),2122),{value:r,type:s.name,fields:new Map}}function Fm(e,t,n){const r=function(e,t,n){const r=qf(e,t),i=[];for(const s of r)Im(s,n)&&i.push(s);return i}(t,n,e);var s,o;return(0,i.v)(0!==r.length,2126),s=1===r.length,o=()=>"The provided data is compatible with more than one type allowed by the schema.\nThe set of possible types is ".concat(JSON.stringify([...r.map((e=>e.name))],void 0),'.\nExplicitly construct an unhydrated node of the desired type to disambiguate.\nFor class-based schema, this can be done by replacing an expression like "{foo: 1}" with "new MySchema({foo: 1})".'),s||function(e){throw new l(e)}("string"===typeof o?o:o()),r[0]}function Im(e,t){if((0,i.v)(void 0!==t,2185),Bf(t))return e instanceof uf&&dd(e.leafValue,t);if(e instanceof uf)return!1;if(Rf in t)return t[Rf]===e.name;if(k(t)){if(e instanceof df){return e.getFieldSchema().kind.multiplicity===Pa.Sequence}return!1}return!(t instanceof Map)||e instanceof lf}var Am;const Dm=Symbol();function Om(e,t){return e instanceof hf?new Rm(e,t):e instanceof lf?new Mm(e,t):e instanceof df?new Bm(e,t):void T("Unrecognized schema")}class Pm{constructor(e,t){this.schema=e,this[Am]=Xf.Node,this.type=e.name,this[Dm]=t}get context(){throw Lm("Getting context")}get parentField(){throw Lm("Accessing parentage")}is(e){return e===this.schema}tryGetField(e){throw Lm("Reading fields")}[(Am=$f,Yf)](){throw Lm("Boxed iteration")}treeStatus(){throw Lm("Status querying")}on(e,t){throw Lm("Event registration")}[tp](e){throw Lm("onNextChange event registration")}}class Rm extends Pm{get localNodeKey(){throw Lm("Reading local node keys")}}class Mm extends Pm{get size(){return this[Dm].size}has(e){return this[Dm].has(e)}get(e){return this[Dm].get(e)}getBoxed(e){throw Lm("Reading boxed map values")}keys(){return this[Dm].keys()}values(){throw Lm("Iterating map values")}entries(){throw Lm("Iterating map entries")}forEach(e,t){throw Lm("Iterating maps with forEach")}set(e,t){throw Lm("Setting a map entry")}delete(e){throw Lm("Deleting a map entry")}get asObject(){throw Lm("Converting a map to an object")}[Symbol.iterator](){return this.entries()}[Yf](){throw Lm("Boxed iteration")}}class Bm extends Pm{get content(){throw Lm("Reading content of a list")}get boxedContent(){throw Lm("Reading boxed content of a list")}}function Lm(e){return new Error("".concat(null!==e&&void 0!==e?e:"Operation"," is not supported on content which has not yet been inserted into the tree"))}function qm(e){switch(e.schema.kind){case Jh.required:return zm(e.boxedContent);case Jh.optional:{const t=e.boxedContent;return void 0===t?void 0:zm(t)}case Jh.sequence:T("'sequence' field is unexpected.");default:T("invalid field kind")}}const _m=Symbol("simpleSchema");function jm(e){if(_m in e)return e[_m]}function zm(e){const t=sm(e);if(void 0!==t)return t;const n=e.schema;let r;const i=jm(n);if(void 0!==i)if("function"===typeof i){r=new i(e)}else r=n.create(e);else r=Um(e,!1);return r}function Um(e,t,n){const r=e.schema;if(Cf(r))return(0,i.v)(void 0!==e.value,2183),e.value;let s;return wf(r)?s=Xm(t,n):xf(r)?s=Zm(t,n):Ef(r)?s=Hm(r,t,n):T("unrecognized node kind"),om(s,e),s}function Hm(e,t){const n=new Proxy(arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{get(e,t){const r=rm(n).tryGetField(t);return void 0!==r?qm(r):Reflect.get(e,t,n)},set(e,r,s){const o=rm(n),a=o.schema;(0,i.v)(a instanceof hf,2184);const c=a.objectNodeFields.get(r);if(void 0===c)return!!t&&Reflect.set(e,r,s);(0,i.v)(o instanceof Kp,2016),(0,i.v)("string"===typeof r,2017);const l=Wp(o,r,c);switch(l.schema.kind){case Jh.required:case Jh.optional:{const e=l,{content:t,hydrateProxies:n}=ng(s),r=xm(t,o.context.schema,c.allowedTypeSet);ig(o,(()=>{e.content=r}),(()=>n(e.boxedContent)));break}default:T("invalid FieldKind")}return!0},has:(n,r)=>e.objectNodeFields.has(r)||!!t&&Reflect.has(n,r),ownKeys:n=>[...e.objectNodeFields.keys(),...t?Reflect.ownKeys(n):[]],getOwnPropertyDescriptor:(e,r)=>{const i=rm(n).tryGetField(r);if(void 0===i)return t?Reflect.getOwnPropertyDescriptor(e,r):void 0;return{value:qm(i),writable:!0,enumerable:!0,configurable:!0}}});return n}const Vm=e=>rm(e).content;function Km(e,t){return ng(t.flatMap((e=>e instanceof Yp?Array.from(e):[e])),e)}const Gm={[Symbol.iterator]:{value:Array.prototype[Symbol.iterator]},at:{value(e){const t=Vm(this).boxedAt(e);return void 0===t?t:zm(t)}},insertAt:{value(e){const t=Vm(this);for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];const{content:s,hydrateProxies:o}=Km(e,r),a=Em(s,t.context.schema,t.schema);ig(rm(this),(()=>t.insertAt(e,a)),(e=>o(e)))}},insertAtStart:{value(){const e=Vm(this);for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];const{content:i,hydrateProxies:s}=Km(0,n),o=Em(i,e.context.schema,e.schema);ig(rm(this),(()=>e.insertAtStart(o)),(e=>s(e)))}},insertAtEnd:{value(){const e=Vm(this);for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];const{content:i,hydrateProxies:s}=Km(this.length,n),o=Em(i,e.context.schema,e.schema);ig(rm(this),(()=>e.insertAtEnd(o)),(e=>s(e)))}},removeAt:{value(e){Vm(this).removeAt(e)}},removeRange:{value(e,t){Vm(this).removeRange(e,t)}},moveToStart:{value(e,t){void 0!==t?Vm(this).moveToStart(e,Vm(t)):Vm(this).moveToStart(e)}},moveToEnd:{value(e,t){void 0!==t?Vm(this).moveToEnd(e,Vm(t)):Vm(this).moveToEnd(e)}},moveToIndex:{value(e,t,n){void 0!==n?Vm(this).moveToIndex(e,t,Vm(n)):Vm(this).moveToIndex(e,t)}},moveRangeToStart:{value(e,t,n){void 0!==n?Vm(this).moveRangeToStart(e,t,Vm(n)):Vm(this).moveRangeToStart(e,t)}},moveRangeToEnd:{value(e,t,n){void 0!==n?Vm(this).moveRangeToEnd(e,t,Vm(n)):Vm(this).moveRangeToEnd(e,t)}},moveRangeToIndex:{value(e,t,n,r){void 0!==r?Vm(this).moveRangeToIndex(e,t,n,Vm(r)):Vm(this).moveRangeToIndex(e,t,n)}}};[Array.prototype.concat,Array.prototype.entries,Array.prototype.every,Array.prototype.filter,Array.prototype.find,Array.prototype.findIndex,Array.prototype.flat,Array.prototype.flatMap,Array.prototype.forEach,Array.prototype.includes,Array.prototype.indexOf,Array.prototype.join,Array.prototype.keys,Array.prototype.lastIndexOf,Array.prototype.map,Array.prototype.reduce,Array.prototype.reduceRight,Array.prototype.slice,Array.prototype.some,Array.prototype.toLocaleString,Array.prototype.toString,Array.prototype.values].forEach((e=>{Gm[e.name]={value:e}}));const Wm=Object.create(Object.prototype,Gm);function Jm(e,t){if("string"===typeof e){const n=Number(e);if(Number.isInteger(n))return 0<=n&&n<t?n:void 0}}function Zm(e,t){const n=null!==t&&void 0!==t?t:[],r=null!==t&&void 0!==t?t:Object.create(Wm,{length:{get(){return Vm(this).length},set(){},enumerable:!1,configurable:!1}}),i=new Proxy(n,{get:(e,t)=>{const n=Vm(i),s=Jm(t,n.length);if(void 0===s)return Reflect.get(r,t,i);const o=n.boxedAt(s);return void 0!==o?zm(o):void 0},set:(t,n,s,o)=>{if(n===Symbol.isConcatSpreadable)return Reflect.set(r,n,s,i);return void 0===Jm(n,Vm(i).length)&&(!!e&&Reflect.set(t,n,s))},has:(e,t)=>void 0!==Jm(t,Vm(i).length)||Reflect.has(r,t),ownKeys:e=>{const t=Vm(i);return Array.from({length:t.length},((e,t)=>"".concat(t))).concat("length")},getOwnPropertyDescriptor:(e,t)=>{const n=Vm(i),s=Jm(t,n.length);if(void 0!==s){const e=n.boxedAt(s);return{value:void 0===e?e:zm(e),writable:!0,enumerable:!0,configurable:!0}}return"length"===t?{value:Vm(i).length,writable:!0,enumerable:!1,configurable:!1}:Reflect.getOwnPropertyDescriptor(r,t)}});return i}const $m={[Symbol.iterator]:{value(){return this.entries()}},delete:{value(e){rm(this).delete(e)}},entries:{*value(){const e=rm(this);for(const t of e.keys())yield[t,qm(e.getBoxed(t))]}},get:{value(e){return qm(rm(this).getBoxed(e))}},has:{value(e){return rm(this).has(e)}},keys:{value(){return rm(this).keys()}},set:{value(e,t){const n=rm(this),{content:r,hydrateProxies:i}=ng(t),s=xm(r,n.context.schema,n.schema.mapFields.allowedTypeSet);return ig(n,(t=>t.set(e,s)),(t=>i(rg(t,e)))),this}},size:{get(){return rm(this).size}},values:{*value(){for(const[,e]of this.entries())yield e}}},Qm=Object.create(Object.prototype,$m);function Xm(e,t){const n=null!==t&&void 0!==t?t:Object.create(Qm,{}),r=null!==t&&void 0!==t?t:new Map,i=new Proxy(r,{get:(e,t,r)=>Reflect.get(n,t,i),getOwnPropertyDescriptor:(e,t)=>Reflect.getOwnPropertyDescriptor(n,t),has:(e,t)=>Reflect.has(n,t),set:(t,r,i)=>!!e&&Reflect.set(n,r,i),ownKeys:e=>[]});return i}function Ym(e,t,n,r){let i,s;if(e instanceof hf){i=Om(e,eg(e.name,t)),s=Hm(e,n,r)}else if(e instanceof df){i=Om(e,eg(e.name,t)),s=Zm(n,r)}else if(e instanceof lf){i=Om(e,eg(e.name,t)),s=Xm(n,r)}else T("Unrecognized content schema");return om(s,i)}function eg(e,t){const n=t instanceof Map?new Map(t):Array.isArray(t)?t.slice():{...t};return Object.defineProperty(n,Rf,{value:e})}const tg=()=>{};function ng(e){let t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=!1;const s=im(e);if(void 0!==s){const e=function(e){if(e instanceof Pm){var t;const n=null!==(t=e[Dm])&&void 0!==t?t:T("Node content may only be extracted once");return Reflect.deleteProperty(e,Dm),n}}(s);if(void 0===e)throw new Error("Cannot insert a node that is already in the tree");t=e,r=!0}else t=e;let o,a;if((0,i.v)(!(t instanceof em),2116),k(t)?(o=Zp.Array,a=function(e,t){const n=[];Rf in e&&Object.defineProperty(n,Rf,{value:e[Rf]});const r=[];for(let i=0;i<e.length;i++){const{content:t,hydrateProxies:s}=ng(e[i]);n.push(t),s!==tg&&r.push([i,s])}return{content:n,hydrateProxies:e=>{(0,i.v)(void 0!==e,2038),(0,i.v)(xf(e.schema),2039),r.forEach((n=>{let[r,s]=n;return s(function(e,t){const n=e.tryGetField(ft);return(0,i.v)((null===n||void 0===n?void 0:n.schema.kind)===Jh.sequence,2044),n.boxedAt(t)}(e,t+r))}))}}}(t,n)):t instanceof Map?(o=Zp.Map,a=function(e){const t=new Map;Rf in e&&Object.defineProperty(t,Rf,{value:e[Rf]});const n=[];for(const[r,i]of e){const{content:e,hydrateProxies:s}=ng(i);t.set(r,e),s!==tg&&n.push([r,s])}return{content:t,hydrateProxies:e=>{(0,i.v)(void 0!==e,2040),(0,i.v)(wf(e.schema),2041),n.forEach((t=>{let[n,r]=t;return r(rg(e,n))}))}}}(t)):"object"!==typeof t||null===t||pd(t)?(a={content:t,hydrateProxies:tg},o=Zp.Leaf):(o=Zp.Object,a=function(e){const t={};Rf in e&&Object.defineProperty(t,Rf,{value:e[Rf]});const n=[];for(const[r,i]of Object.entries(e))if(void 0!==i){const{content:e,hydrateProxies:s}=ng(i);t[r]=e,n.push([r,s])}return{content:t,hydrateProxies:e=>{(0,i.v)(void 0!==e,2042),(0,i.v)(Ef(e.schema),2043),n.forEach((t=>{let[n,r]=t;return r(function(e,t){var n;const r=null!==(n=e.tryGetField(t))&&void 0!==n?n:T("Expected a field for inserted content");return(0,i.v)(r.schema.kind===Jh.required||r.schema.kind===Jh.optional,2046),r.boxedContent}(e,n))}))}}}(t)),e instanceof em){const t=function(e){var t,n;return null!==(t=null===(n=jm(rm(e).schema))||void 0===n?void 0:n.kind)&&void 0!==t?t:T("NodeBase should always have class schema")}(e);(0,i.v)(t===o,2117)}return r?{content:a.content,hydrateProxies:t=>{om(e,null!==t&&void 0!==t?t:T("Expected edit node")),a.hydrateProxies(t)}}:a}function rg(e,t){const n=e.getBoxed(t);return(0,i.v)(n.schema.kind===Jh.optional,2045),n.boxedContent}function ig(e,t,n){const r=e[tp]((()=>null===n||void 0===n?void 0:n(e)));t(e),r()}function sg(e,t){var n;return null!==(n=xm(ng(t).content,e,e.rootFieldSchema.allowedTypeSet))&&void 0!==n?n:T("failed to decode tree")}function og(e){const t=new Map,n=cg(t,e),r=new Map(A(t,(e=>{let[t,n]=e;const r=n.toFlex(),s=jm(r);return void 0===s?(0,i.v)(Cf(r),2110):(0,i.v)(pg(s)===r,2111),[t,r]})));return{nodeSchema:r,adapters:{},rootFieldSchema:n,policy:Zh}}function ag(e){var t;return null!==(t=og(e).rootFieldSchema.monomorphicChildType)&&void 0!==t?t:T("root should be monomorphic")}function cg(e,t){let n,r;var i;t instanceof $p?(n=null!==(i=lg.get(t.kind))&&void 0!==i?i:T("Invalid field kind"),r=t.allowedTypes):(n=Jh.required,r=t);const s=ug(e,r);return gf.create(n,s)}const lg=new Map([[Jp.Optional,Jh.optional],[Jp.Required,Jh.required]]);function ug(e,t){return k(t)?Zf(t).map((t=>dg(e,t))):[dg(e,t)]}const hg={name:"simple schema"};function dg(e,t){const n=e.get(t.identifier);if(void 0!==n){if(n.original!==t)throw new Error("Multiple schema encountered with the identifier ".concat(JSON.stringify(t.identifier),". Remove or rename them to avoid the collision."));return n.toFlex}const r=()=>{let n;const r=t.kind;switch(r){case Zp.Leaf:{var s;const e=null!==(s=pg(t))&&void 0!==s?s:T("leaf schema should be pre-cached");return(0,i.v)(Cf(e),2112),e}case Zp.Map:{const r=t.info,i=gf.create(Jh.optional,ug(e,r)),s=pg(t);n=null!==s&&void 0!==s?s:lf.create(hg,t.identifier,i);break}case Zp.Array:{const r=t.info,i=gf.create(Jh.sequence,ug(e,r)),s=pg(t);n=null!==s&&void 0!==s?s:df.create(hg,t.identifier,i);break}case Zp.Object:{const r=t.info,i=Object.create(null);for(const[t,n]of Object.entries(r))Object.defineProperty(i,t,{enumerable:!0,configurable:!1,writable:!1,value:cg(e,n)});const s=pg(t);n=null!==s&&void 0!==s?s:hf.create(hg,t.identifier,i);break}default:wt(r)}(0,i.v)(n instanceof cf,2113);void 0!==pg(t)?(0,i.v)(pg(t)===n,2114):mg(t,n);return n[_m]=t,n};return e.set(t.identifier,{original:t,toFlex:r}),r}const fg=Symbol("flexSchema");function pg(e){return e[fg]}function mg(e,t){e[fg]=t}class gg{constructor(e){this.view=e}[q](){this.view[q]()}get events(){return this.view.checkout.events}get root(){return qm(this.view.editableTree)}}function vg(e,t,n){let r;const s=t.storedSchema.on("afterSchemaChange",(()=>{var t;null!==(t=r)&&void 0!==t||(r=e.on("afterBatch",(()=>{(0,i.v)(void 0!==r,1832),r(),r=void 0,n()||s()})))}))}class yg{constructor(e,t){this.changeFamily=e,this.changeReceiver=t}applyChange(e){this.changeReceiver(e)}enterTransaction(){}exitTransaction(){}}const bg={fromNextId(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;const t=new Map;let n=e;return{allocate(e,r,i){let s=null!==i&&void 0!==i?i:1;const o=[],a=I(t,e);let c=r;for(;s>0;){const e=yc(a,c,s);if(void 0===e){const e=n;n+=s,bc(a,c,s,e),o.push({first:e,count:s}),s=0}else{const t={first:e.value,count:e.length};if(c<e.start){const t=e.start-c;bc(a,c,t,n),o.push({first:n,count:t}),n+=t,c+=t,s-=t}else if(e.start<c){const n=c-e.start;t.first=t.first+n,t.count-=n}t.count>s?t.count=s:t.count<s&&e.value+e.length===n&&(n+=s-t.count,e.length=s,t.count=s),o.push(t),s-=t.count,c+=t.count}}return o},mint(e){const t=n;return n+=null!==e&&void 0!==e?e:1,t}}}};const Sg=e=>m.ZU.Tuple([m.ZU.Number({minimum:0}),e]),wg=e=>m.ZU.Array(Sg(e));function Cg(e){var t;return{encode:(t,n)=>t.map((t=>{let{index:r,nodeChange:i}=t;return[r,e.encode(i,n)]})),decode:(t,n)=>t.map((t=>{let[r,i]=t;return{index:r,nodeChange:e.decode(i,n)}})),encodedSchema:wg(null!==(t=e.encodedSchema)&&void 0!==t?t:m.ZU.Any())}}const xg={rebaser:{compose:(e,t)=>{if(0===e.length)return[];const n=[];for(const r of e){let e=0;for(const{index:i,nodeChange:s}of r.change){const o=Co(s,r.revision);for(;e<n.length&&n[e].index<i;)e+=1;const a=n[e];void 0===a?n.push({index:i,nodeChange:t([o])}):a.index>i?n.splice(e,0,{index:i,nodeChange:t([o])}):n.splice(e,1,{index:i,nodeChange:t([Eo(a.nodeChange),o])})}}return n},amendCompose:()=>T("Not implemented"),invert:(e,t)=>{let{change:n}=e;return n.map((e=>{let{index:n,nodeChange:r}=e;return{index:n,nodeChange:t(r)}}))},rebase:function(e,t,n){let{change:r}=t;const i=[];let s=0,o=0;for(;s<e.length||o<r.length;){var a,c;const t=e[s],l=r[o],u=null!==(a=null===t||void 0===t?void 0:t.index)&&void 0!==a?a:1/0,h=null!==(c=null===l||void 0===l?void 0:l.index)&&void 0!==c?c:1/0;let d,f,p;u===h?(p=t.index,d=t.nodeChange,f=l.nodeChange,s+=1,o+=1):u<h?(p=t.index,d=t.nodeChange,s+=1):(p=l.index,f=l.nodeChange,o+=1);const m=n(d,f);void 0!==m&&i.push({index:p,nodeChange:m})}return i},prune:function(e,t){const n=[];for(const r of e){const e=t(r.nodeChange);void 0!==e&&n.push({...r,nodeChange:e})}return n}},codecsFactory:function(e){return Fe([[0,Cg(e)]])},editor:{buildChildChange:(e,t)=>[{index:e,nodeChange:t}]},intoDelta:(e,t)=>{let{change:n}=e,r=0;const i=[];for(const{index:s,nodeChange:o}of n){if(r<s){const e=s-r;i.push({count:e}),r=s}i.push({count:1,fields:t(o)}),r+=1}return{local:i}},relevantRemovedRoots:function(e,t){let{change:n}=e;return function*(){for(const{nodeChange:e}of n)yield*t(e)}()},isEmpty:e=>0===e.length};const Eg=new gc("ModularEditBuilder.Generic",Pa.Sequence,xg,((e,t)=>!1),new Set);const Tg=()=>T("Should not be called when converting generic changes"),kg={set:Tg,get:Tg};function Ng(e,t,n,r){let{jsonValidator:s}=r;const o={encode:function(e,t){const n={},{fieldChanges:r,nodeExistsConstraint:i}=e;void 0!==r&&(n.fieldChanges=u(r,t));void 0!==i&&(n.nodeExistsConstraint=i);return n},decode:function(e,t){const n={},{fieldChanges:r,nodeExistsConstraint:i}=e;void 0!==r&&(n.fieldChanges=h(r,t));void 0!==i&&(n.nodeExistsConstraint=i);return n},encodedSchema:Qc},a=e=>{const n=e.changeHandler.codecsFactory(o,t).resolve(0);return{codec:n,compiledSchema:n.json.encodedSchema?s.compile(n.json.encodedSchema):void 0}},c=new Map([[Eg.identifier,a(Eg)]]);e.forEach(((e,t)=>{c.set(t,a(e))}));const l=e=>{const t=c.get(e);return(0,i.v)(void 0!==t,1514),t};function u(e,t){const n=[];for(const[r,i]of e){const{codec:e,compiledSchema:s}=l(i.fieldKind),o=e.json.encode(i.change,t);void 0===s||s.check(o)||T("Encoded change didn't pass schema validation.");const a={fieldKey:r,fieldKind:i.fieldKind,change:o};n.push(a)}return n}function h(e,t){const n=new Map;for(const r of e){const{codec:e,compiledSchema:i}=l(r.fieldKind);void 0===i||i.check(r.change)||T("Encoded change didn't pass schema validation.");const s=e.json.decode(r.change,t),o=r.fieldKey;n.set(o,{fieldKind:r.fieldKind,change:s})}return n}function d(e,r){if(void 0===e)return;const i=[],s=Array.from(e.entries()).map((e=>{let[n,s]=e;const o=Array.from(s.entries()).map((e=>{let[t,n]=e;i.push(n.cursor());return[t,i.length-1]}));return void 0!==n?[o,t.encode(n,r.originatorId)]:[o]}));return 0===s.length?void 0:{builds:s,trees:n.encode(i)}}function f(e,n){const r=[];for(const i of e){const e={revision:t.encode(i.revision,n)};void 0!==i.rollbackOf&&(e.rollbackOf=t.encode(i.rollbackOf,n)),r.push(e)}return r}return{encode:(e,t)=>((0,i.v)(void 0===e.destroys,2201),{maxId:e.maxId,revisions:void 0===e.revisions?e.revisions:f(e.revisions,t.originatorId),changes:u(e.fieldChanges,t.originatorId),builds:d(e.builds,t)}),decode:(e,r)=>{const s=e,o={fieldChanges:h(s.changes,r.originatorId)};return void 0!==s.builds&&(o.builds=function(e,r){if(void 0===e||0===e.builds.length)return;const s=n.decode(e.trees),o=new Map;return e.builds.forEach((e=>{const n=void 0===e[1]?void 0:t.decode(e[1],r.originatorId);o.set(n,new Map(e[0].map((e=>{let[t,n]=e;return[t,(r=n,(0,i.v)(r<s.length,2200),Ga(s[r],Za))];var r}))))})),o}(s.builds,r)),void 0!==s.revisions&&(o.revisions=function(e,n){const r=[];for(const i of e){const e={revision:t.decode(i.revision,n)};void 0!==i.rollbackOf&&(e.rollbackOf=t.decode(i.rollbackOf,n)),r.push(e)}return r}(s.revisions,r.originatorId)),void 0!==s.maxId&&(o.maxId=s.maxId),o},encodedSchema:rl}}class Fg{constructor(e,t,n,r){this.fieldKinds=e,this.latestCodec=Ng(e,new Me(t),n,r),this.codecs=Fe([[0,this.latestCodec]])}get rebaser(){return this}normalizeFieldChanges(e,t,n){const r=e.find((e=>e.fieldKind!==Eg.identifier));if(void 0===r)return{fieldKind:Eg,changesets:e.map((e=>e.change))};const i=r.fieldKind,s=Dg(this.fieldKinds,i),o=s.changeHandler,a=e.map((e=>{if(e.fieldKind===Eg.identifier){return function(e,t,n,r,i){const s=e.map((e=>{let{index:n,nodeChange:r}=e;return Eo(t.editor.buildChildChange(n,r))}));return t.rebaser.compose(s,n,r,kg,i)}(e.change,o,(e=>this.composeNodeChanges(e,t,Pg(),n)),t,n)}return e.change}));return{fieldKind:s,changesets:a}}compose(e){const{revInfos:t,maxId:n}=_g(e);if(1===e.length){const{fieldChanges:r,builds:i,destroys:s,constraintViolationCount:o}=e[0].change;return Lg(r,n,t,o,i,s)}const r=ko(t),s={maxId:n},o=ye(s),a=Pg(),c=e.filter((e=>{var t;return 0===(null!==(t=e.change.constraintViolationCount)&&void 0!==t?t:0)})),l=this.composeFieldMaps(c.map((e=>Co(e.change.fieldChanges,zg(e)))),o,a,r);if(a.invalidatedFields.size>0){const e=a.invalidatedFields;a.invalidatedFields=new Set;for(const t of e){const e=Og(this.fieldKinds,t.fieldKind).rebaser.amendCompose(t.change,(e=>this.composeNodeChanges(e,o,a,r)),o,Mg(a),r);t.change=e}}(0,i.v)(0===a.invalidatedFields.size,1435);const{allBuilds:u,allDestroys:h}=function(e){const t=new Map,n=new Map;for(const r of e){const e=zg(r),s=r.change;if(s.builds)for(const[r,o]of s.builds){const s=null!==r&&void 0!==r?r:e,a=Ce(t,s,new Map);for(const[e,t]of o)if(!a.has(e)){const r=xe(n,s,e);void 0===r?a.set(e,t):((0,i.v)(r===t.topLevelLength,2203),Ee(n,s,e))}0===a.size&&t.delete(s)}if(void 0!==s.destroys)for(const[r,o]of s.destroys){const s=null!==r&&void 0!==r?r:e,a=Ce(n,s,new Map);for(const[e,n]of o){const r=xe(t,s,e);void 0===r?a.set(e,n):((0,i.v)(n===r.topLevelLength,2204),Ee(t,s,e))}0===a.size&&n.delete(s)}}return{allBuilds:t,allDestroys:n}}(c);return Lg(this.pruneFieldMap(l),s.maxId,t,void 0,u,h)}composeFieldMaps(e,t,n,r){const s=new Map;for(const i of e)for(const[e,t]of i.change){const n=void 0!==t.revision||void 0===i.revision?t:{...t,revision:i.revision};I(s,e).push(n)}const o=new Map;for(const[a,c]of s){const{fieldKind:e,changesets:s}=this.normalizeFieldChanges(c,t,r);(0,i.v)(s.length===c.length,1192);const l=Mg(n),u=s.map(((e,t)=>Co(e,c[t].revision))),h=e.changeHandler.rebaser.compose(u,(e=>this.composeNodeChanges(e,t,n,r)),t,l,r),d={fieldKind:e.identifier,change:h};Bg(l,d),o.set(a,d)}return o}composeNodeChanges(e,t,n,r){const i=[];let s;for(const c of e)void 0!==c.change.nodeExistsConstraint&&(s={...c.change.nodeExistsConstraint}),void 0!==c.change.fieldChanges&&i.push(Co(c.change.fieldChanges,c.revision));const o=this.composeFieldMaps(i,t,n,r),a={};return o.size>0&&(a.fieldChanges=o),void 0!==s&&(a.nodeExistsConstraint=s),a}invert(e,t){var n,r;if((null!==(n=e.change.constraintViolationCount)&&void 0!==n?n:0)>0)return Lg();const s={maxId:null!==(r=e.change.maxId)&&void 0!==r?r:-1},o=ye(s),a={...Pg(),originalFieldToContext:new Map},{revInfos:c}=_g([e]),l=ko(c),u=this.invertFieldMap(Co(e.change.fieldChanges,zg(e)),o,a,l);if(a.invalidatedFields.size>0){const e=a.invalidatedFields;a.invalidatedFields=new Set;for(const t of e){const e=t.change,n=a.originalFieldToContext.get(t);(0,i.v)(void 0!==n,2129);const{invertedField:r,revision:s}=n,c=Og(this.fieldKinds,t.fieldKind).rebaser.invert(Co(e,s),(e=>e),o,Mg(a),l);r.change=c}}const h=t?function(e,t){if(void 0!==e){const n=new Map;for(const[r,i]of e){const e=null!==r&&void 0!==r?r:t,s=new Map;for(const[t,n]of i)s.set(t,n.topLevelLength);n.set(e,s)}return n}return}(e.change.builds,e.revision):void 0;(0,i.v)(void 0===e.change.destroys,2202);const d=e.change.revisions;return Lg(u,s.maxId,void 0===d?void 0:(t?d.map((e=>{let{revision:t}=e;return{revision:t,rollbackOf:t}})):Array.from(d)).reverse(),e.change.constraintViolationCount,void 0,h)}invertFieldMap(e,t,n,r){const i=new Map;for(const[s,o]of e.change){const{revision:a}=void 0!==o.revision?o:e,c=Mg(n),l=Og(this.fieldKinds,o.fieldKind).rebaser.invert({revision:a,change:o.change},(e=>this.invertNodeChange({revision:a,change:e},t,n,r)),t,c,r),u={...o,change:l};i.set(s,u),n.originalFieldToContext.set(o,{invertedField:u,revision:a}),Bg(c,o)}return i}invertNodeChange(e,t,n,r){const i={};return void 0!==e.change.fieldChanges&&(i.fieldChanges=this.invertFieldMap({...e,change:e.change.fieldChanges},t,n,r)),i}rebase(e,t,n){var r,s,o;const a={maxId:Math.max(null!==(r=e.maxId)&&void 0!==r?r:-1,null!==(s=t.change.maxId)&&void 0!==s?s:-1)},c=ye(a),l={...Pg(),rebasedFieldToContext:new Map};let u=Rg(null!==(o=e.constraintViolationCount)&&void 0!==o?o:0);const h={...n,getBaseRevisions:()=>jg(t).map((e=>e.revision))},d=this.rebaseFieldMap(e.fieldChanges,Co(t.change.fieldChanges,zg(t)),c,l,(()=>!0),h,u);if(l.invalidatedFields.size>0){var f;const t=l.invalidatedFields;l.invalidatedFields=new Set,u=Rg(null!==(f=e.constraintViolationCount)&&void 0!==f?f:0);for(const e of t){const t=l.rebasedFieldToContext.get(e);(0,i.v)(void 0!==t,2130);const{fieldKind:r,changesets:[s,o]}=this.normalizeFieldChanges([t.newChange,t.baseChange],c,n);e.change=r.changeHandler.rebaser.rebase(s,Co(o,t.baseRevision),(e=>e),c,Mg(l),h)}}return Lg(this.pruneFieldMap(d),a.maxId,e.revisions,u.violationCount,e.builds,e.destroys)}rebaseFieldMap(e,t,n,r,s,o,a){let c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:rc.Alive;const l=new Map;for(const[i,d]of t.change){var u;if(!s(d,e.get(i)))continue;const c=null!==(u=e.get(i))&&void 0!==u?u:{fieldKind:Eg.identifier,change:[]},{fieldKind:h,changesets:[f,p]}=this.normalizeFieldChanges([c,d],n,o),{revision:m}=t,g={revision:m,change:p},v=Mg(r),y=(e,t,i)=>this.rebaseNodeChange(e,{revision:m,change:t},n,r,s,o,a,i),b=h.changeHandler.rebaser.rebase(f,g,y,n,v,o),S={fieldKind:h.identifier,change:b};l.set(i,S),Bg(v,S),r.rebasedFieldToContext.set(S,{baseChange:d,baseRevision:m,newChange:c})}for(const[d,f]of e){var h;if(null===(h=t.change)||void 0===h||!h.has(d)){const e={fieldKind:Eg.identifier,change:[]},{fieldKind:u,changesets:[h,p]}=this.normalizeFieldChanges([f,e],n,o),m=Mg(r),g=u.changeHandler.rebaser.rebase(h,Co(p,t.revision),((e,l)=>((0,i.v)(void 0===l,1462),this.rebaseNodeChange(e,Co(void 0,t.revision),n,r,s,o,a,c))),n,m,o,c),v={fieldKind:u.identifier,change:g};l.set(d,v),Bg(m,v)}}return l}rebaseNodeChange(e,t,n,r,i,s,o){var a,c,l;let u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:rc.Alive;if(void 0===e&&void 0===(null===(a=t.change)||void 0===a?void 0:a.fieldChanges))return;const h=void 0!==(null===(c=t.change)||void 0===c?void 0:c.fieldChanges)?{...t,change:t.change.fieldChanges}:Co(new Map,t.revision),d=this.rebaseFieldMap(null!==(l=null===e||void 0===e?void 0:e.fieldChanges)&&void 0!==l?l:new Map,h,n,r,i,s,o,u),f={};if(d.size>0&&(f.fieldChanges=d),void 0!==(null===e||void 0===e?void 0:e.nodeExistsConstraint)&&(f.nodeExistsConstraint=e.nodeExistsConstraint),void 0!==f.nodeExistsConstraint){const e=u===rc.Dead;f.nodeExistsConstraint.violated!==e&&(f.nodeExistsConstraint={...f.nodeExistsConstraint,violated:e},o.violationCount+=e?1:-1)}return f}pruneFieldMap(e){const t=new Map;for(const[n,r]of e){const e=Og(this.fieldKinds,r.fieldKind),i=e.rebaser.prune(r.change,(e=>this.pruneNodeChange(e)));e.isEmpty(i)||t.set(n,{...r,change:i})}return t.size>0?t:void 0}pruneNodeChange(e){const t=void 0!==e.fieldChanges?this.pruneFieldMap(e.fieldChanges):void 0,n={...e,fieldChanges:t};return void 0===n.fieldChanges&&delete n.fieldChanges,void 0===(r=n).fieldChanges&&void 0===r.nodeExistsConstraint?void 0:n;var r}buildEditor(e){return new qg(this,e)}}function Ig(e,t,n,r){const i=new Map;for(const[a,c]of e){var s;const e=null!==(s=c.revision)&&void 0!==s?s:t,l=Og(r,c.fieldKind).intoDelta(Co(c.change,e),(t=>Ag(Co(t,e),n,r)),n);(void 0!==(o=l).local||void 0!==o.global||void 0!==o.build||void 0!==o.rename)&&i.set(a,l)}var o;return i}function Ag(e,t,n){let{change:r,revision:i}=e;return void 0!==r.fieldChanges?Ig(r.fieldChanges,i,t,n):new Map}function Dg(e,t){if(t===Eg.identifier)return Eg;const n=e.get(t);return(0,i.v)(void 0!==n,941),vc(n)}function Og(e,t){return Dg(e,t).changeHandler}function Pg(){return{srcTable:new Map,dstTable:new Map,srcDependents:new Map,dstDependents:new Map,invalidatedFields:new Set}}function Rg(e){return{violationCount:e}}function Mg(e){const t=new Map,n=new Map,r=t=>t===ic.Source?e.srcTable:e.dstTable,i=e=>e===ic.Source?t:n,s={table:e,srcQueries:t,dstQueries:n,fieldInvalidated:!1,set:(t,n,o,a,c,l)=>{if(l){const r=t===ic.Source?e.srcDependents:e.dstDependents,c=o+a-1;let l=o;for(;l<=c;){const t=wc(r,n,l,c-l+1);void 0!==t.value&&e.invalidatedFields.add(t.value),l+=t.length}void 0!==wc(i(t),n,o,a)&&(s.fieldInvalidated=!0)}Sc(r(t),n,o,a,c)},get:(e,t,n,s,o)=>(o&&function(e,t,n,r){Sc(e,t,n,r,!0)}(i(e),t,n,s),wc(r(e),t,n,s))};return s}function Bg(e,t){for(const[n,r]of e.srcQueries)for(const i of r)Sc(e.table.srcDependents,n,i.start,i.length,t);for(const[n,r]of e.dstQueries)for(const i of r)Sc(e.table.dstDependents,n,i.start,i.length,t);e.fieldInvalidated&&e.table.invalidatedFields.add(t)}function Lg(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0,s=arguments.length>5?arguments[5]:void 0;const o={fieldChanges:null!==e&&void 0!==e?e:new Map};return void 0!==n&&n.length>0&&(o.revisions=n),t>=0&&(o.maxId=t),void 0!==r&&r>0&&(o.constraintViolationCount=r),void 0!==i&&i.size>0&&(o.builds=i),void 0!==s&&s.size>0&&(o.destroys=s),o}Fg.emptyChange=Lg();class qg extends yg{constructor(e,t){super(e,t),this.transactionDepth=0,this.idAllocator=ve()}enterTransaction(){this.transactionDepth+=1,1===this.transactionDepth&&(this.idAllocator=ve())}exitTransaction(){(0,i.v)(this.transactionDepth>0,1465),this.transactionDepth-=1,0===this.transactionDepth&&(this.idAllocator=ve())}buildTrees(e,t){const n=k(t)?t:[t];if(0===n.length)return{type:"global"};const r=new Map,i=new Map;r.set(void 0,i);const s=Ga(Xh(n.map((e=>ed(e)))),Za);return i.set(e,s),{type:"global",builds:r}}submitChange(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:-1;const i=this.buildChangeMap(e,t,n);this.applyChange(Lg(i,r))}submitChanges(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1;const n=e.map((e=>Eo("global"===e.type?Lg(void 0,void 0,void 0,void 0,e.builds):Lg(this.buildChangeMap(e.field,e.fieldKind,e.change))))),r=this.changeFamily.rebaser.compose(n);t>=0&&(r.maxId=t),this.applyChange(r)}generateId(e){return this.idAllocator.allocate(e)}buildChangeMap(e,t,n){let r=new Map([[e.field,{fieldKind:t,change:n}]]),i=e.parent;for(;void 0!==i;){const e={fieldChanges:r},t=Eg.changeHandler.editor.buildChildChange(i.parentIndex,e);r=new Map([[i.parentField,{fieldKind:Eg.identifier,change:t}]]),i=i.parent}return r}addNodeExistsConstraint(e){const t=Eg.changeHandler.editor.buildChildChange(e.parentIndex,{nodeExistsConstraint:{violated:!1}});this.submitChange({parent:e.parent,field:e.parentField},Eg.identifier,t)}}function _g(e){let t=-1;const n=[];for(const o of e){var r;const e=o.change;t=Math.max(null!==(r=e.maxId)&&void 0!==r?r:-1,t),n.push(...jg(o))}const i=new Set,s=[];for(const o of n)i.add(o.revision),void 0!==o.rollbackOf&&s.push(o.rollbackOf);s.reverse();for(const o of s)i.has(o)||n.push({revision:o});return{maxId:t,revInfos:n}}function jg(e){const t=[];if(void 0!==e.change.revisions)t.push(...e.change.revisions);else if(void 0!==e.revision){const n={revision:e.revision};void 0!==e.rollbackOf&&(n.rollbackOf=e.rollbackOf),t.push(n)}return t}function zg(e){var t;return null!==(t=e.revision)&&void 0!==t?t:function(e){if(void 0===e||1!==e.length)return;return e[0].revision}(e.change.revisions)}function Ug(e){return function(e,t){var n;const r=e.change;if((null!==(n=r.constraintViolationCount)&&void 0!==n?n:0)>0)return Je;const i=zg(e),s=bg.fromNextId(),o={},a=Ig(r.fieldChanges,i,s,t);if(a.size>0&&(o.fields=a),r.builds&&r.builds.size>0){const e=[];Te(r.builds,((t,n,r)=>{if(t.topLevelLength>0){const s=ga(t.cursor(),(e=>Qh(ed(e))));e.push({id:Xe(null!==n&&void 0!==n?n:i,r),trees:s})}})),o.build=e}if(void 0!==r.destroys&&r.destroys.size>0){const e=[];Te(r.destroys,((t,n,r)=>{e.push({id:Xe(null!==n&&void 0!==n?n:i,r),count:t})})),o.destroy=e}return o}(e,Wh)}class Hg{constructor(e,t){this.modularBuilder=new qg(e,t)}enterTransaction(){this.modularBuilder.enterTransaction()}exitTransaction(){this.modularBuilder.exitTransaction()}addNodeExistsConstraint(e){this.modularBuilder.addNodeExistsConstraint(e)}valueField(e){return{set:t=>{const n=this.modularBuilder.generateId(),r=this.modularBuilder.buildTrees(n,[t]),i=zh.changeHandler.editor.set({fill:n,detach:this.modularBuilder.generateId()}),s={type:"field",field:e,fieldKind:zh.identifier,change:i};this.modularBuilder.submitChanges([r,s])}}}optionalField(e){return{set:(t,n)=>{const r=this.modularBuilder.generateId();let i;const s=[];let o;if(void 0!==t){i=this.modularBuilder.generateId();const e=this.modularBuilder.buildTrees(i,[t]);s.push(e),o=Lh.changeHandler.editor.set(n,{fill:i,detach:r})}else o=Lh.changeHandler.editor.clear(n,r);const a=o,c={type:"field",field:e,fieldKind:Lh.identifier,change:a};s.push(c),this.modularBuilder.submitChanges(s,void 0===t?r:i)}}}move(e,t,n,r,s){const o=this.modularBuilder.generateId(n);if(yp(e,r)){const r=Hh.changeHandler.editor.move(t,n,s,o);this.modularBuilder.submitChange(e,Hh.identifier,r)}else{const h=gp(e.parent),d=gp(r.parent),f=function(e,t){const n=Math.min(e.length,t.length);let r=0;for(;r<n;){const n=e[r],i=t[r];if(n!==i&&(n.parentField!==i.parentField||n.parentIndex!==i.parentIndex))break;r+=1}return r}(h,d);let p=r;if(f===h.length){var a,c;if((null!==(a=null===(c=d[f])||void 0===c?void 0:c.parentField)&&void 0!==a?a:r.field)===e.field){var l,u;let e=null!==(l=null===(u=d[f])||void 0===u?void 0:u.parentIndex)&&void 0!==l?l:t;if(e<t);else{(0,i.v)(t+n<=e,2049),e-=n;let s=d[f-1];s={parent:s,parentIndex:e,parentField:d[f].parentField};for(let e=f+1;e<d.length;e+=1)s={...d[e],parent:s};p={parent:s,field:r.field}}}}const m=Hh.changeHandler.editor.moveOut(t,n,o),g=Hh.changeHandler.editor.moveIn(s,n,o);this.modularBuilder.submitChanges([{type:"field",field:e,fieldKind:Hh.identifier,change:m},{type:"field",field:p,fieldKind:Hh.identifier,change:g}],o)}}sequenceField(e){return{insert:(t,n)=>{const r=k(n)?n:[n],i=r.length;if(0===i)return;const s=this.modularBuilder.generateId(i),o=this.modularBuilder.buildTrees(s,r),a=Hh.changeHandler.editor.insert(t,i,s),c={type:"field",field:e,fieldKind:Hh.identifier,change:a};this.modularBuilder.submitChanges([o,c],s+i-1)},delete:(t,n)=>{if(0===n)return;const r=this.modularBuilder.generateId(n),i=Hh.changeHandler.editor.delete(t,n,r);this.modularBuilder.submitChange(e,Hh.identifier,i)},move:(t,n,r)=>{const i=this.modularBuilder.generateId(n),s=Hh.changeHandler.editor.move(t,n,r,i);this.modularBuilder.submitChange(e,Hh.identifier,s)}}}}var Vg;!function(e){e[e.Abort=0]="Abort",e[e.Commit=1]="Commit"}(Vg||(Vg={}));const Kg=m.ZU.Object({new:id,old:id});const Gg=m.ZU.Object({schema:m.ZU.Optional(Kg),data:m.ZU.Optional(rl)}),Wg=m.ZU.Array(Gg);function Jg(e,t){const n=function(e){let{jsonValidator:t}=e;const n=sd({jsonValidator:t});return{encode:e=>({new:n.encode(e.schema.new),old:n.encode(e.schema.old)}),decode:e=>({schema:{new:n.decode(e.new),old:n.decode(e.old)}}),encodedSchema:Kg}}(t),r=new K({data:(t,n)=>({type:"data",innerChange:e.decode(t,n)}),schema:e=>({type:"schema",innerChange:n.decode(e)})});return{encode:(t,r)=>{const i=[];for(const s of t.changes)"data"===s.type?i.push({data:e.encode(s.innerChange,r)}):"schema"===s.type&&i.push({schema:n.encode(s.innerChange)});return i},decode:(e,t)=>{const n=[];for(const i of e)n.push(r.dispatch(i,t));return{changes:n}},encodedSchema:Wg}}class Zg extends Hg{constructor(e,t){super(e,(e=>t({changes:[{type:"data",innerChange:e}]}))),this.changeReceiver=t,this.schema={setStoredSchema:(e,t)=>{this.changeReceiver({changes:[{type:"schema",innerChange:{schema:{new:t,old:e}}}]})}}}}class $g{constructor(e,t,n){this.modularChangeFamily=new Fg(Wh,e,t,n),this.codecs=Fe([[0,Jg(this.modularChangeFamily.latestCodec,n)]])}buildEditor(e){return new Zg(this.modularChangeFamily,e)}compose(e){const t=[],n=[],r=()=>{n.length>0&&(t.push({type:"data",innerChange:this.modularChangeFamily.compose(n)}),n.length=0)};for(const i of e)for(const e of i.change.changes)"schema"===e.type?(r(),t.push(e)):n.push(wo(i,e.innerChange));return r(),{changes:t}}invert(e,t){return{changes:e.change.changes.map((n=>{switch(n.type){case"data":return{type:"data",innerChange:this.modularChangeFamily.invert(wo(e,n.innerChange),t)};case"schema":return{type:"schema",innerChange:{schema:{new:n.innerChange.schema.old,old:n.innerChange.schema.new}}};default:T("Unknown SharedTree change type.")}})).reverse()}}rebase(e,t,n){if(0===e.changes.length||0===t.change.changes.length)return e;if(Qg(e)||Qg(t.change))return $g.emptyChange;(0,i.v)(1===e.changes.length&&1===t.change.changes.length,2180);const r=e.changes[0],s=t.change.changes[0];return(0,i.v)("data"===r.type&&"data"===s.type,2181),{changes:[{type:"data",innerChange:this.modularChangeFamily.rebase(r.innerChange,wo(t,s.innerChange),n)}]}}get rebaser(){return this}}function Qg(e){return e.changes.some((e=>"schema"===e.type))}$g.emptyChange={changes:[]};class Xg{constructor(e){this.branch=e}start(){this.branch.startTransaction(),this.branch.editor.enterTransaction()}commit(){return this.branch.commitTransaction(),this.branch.editor.exitTransaction(),Vg.Commit}abort(){return this.branch.abortTransaction(),this.branch.editor.exitTransaction(),Vg.Abort}inProgress(){return this.branch.isTransacting()}}class Yg{constructor(e,t,n,r,i,s,o){let a=arguments.length>7&&void 0!==arguments[7]?arguments[7]:ct("repair",o);this.transaction=e,this.branch=t,this.changeFamily=n,this.storedSchema=r,this.forest=i,this.events=s,this.idCompressor=o,this.removedRoots=a,t.on("beforeChange",(e=>{if(void 0!==e.change){for(const t of e.change.change.changes)if("data"===t.type){const n=Ug(Co(t.innerChange,e.change.revision)),r=this.forest.anchors.acquireVisitor(),i=lt([this.forest.acquireVisitor(),r],[r]);et(n,i,this.removedRoots),i.free()}else"schema"===t.type?void 0!==t.innerChange.schema&&r.apply(t.innerChange.schema.new):T("Unknown Shared Tree change type.");this.events.emit("afterBatch")}if("replace"===e.type&&"transactionCommit"===Po(e)){const t=e.newCommits[0].revision;for(const n of e.removedCommits)this.removedRoots.updateMajor(n.revision,t)}})),t.on("revertible",(e=>{this.events.hasListeners("revertible")?this.events.emit("revertible",e):e.discard()}))}get rootEvents(){return this.forest.anchors}get editor(){return this.branch.editor}locate(e){return this.forest.anchors.locate(e)}fork(){const e=new oa,t=this.branch.fork(),n=this.storedSchema.clone(),r=this.forest.clone(n,e),i=new Xg(t);return new Yg(i,t,this.changeFamily,n,r,z(),this.idCompressor,this.removedRoots.clone())}rebase(e){e.branch.rebaseOnto(this.branch)}rebaseOnto(e){e.rebase(this)}merge(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];for((0,i.v)(!this.transaction.inProgress()||t,1808);e.transaction.inProgress();)e.transaction.commit();this.branch.merge(e.branch),t&&e.dispose()}updateSchema(e){this.editor.schema.setStoredSchema(this.storedSchema.clone(),e)}dispose(){this.branch.dispose()}getRemovedRoots(){const e=new Me(this.idCompressor),t=[],n=this.forest.allocateCursor();for(const{id:r,root:i}of this.removedRoots.entries()){const s=this.removedRoots.toFieldKey(i);this.forest.moveCursorToPath({parent:void 0,parentField:s,parentIndex:0},n);const o=Af(n);if(void 0!==o){const{major:n,minor:i}=r,s=void 0!==n?e.encode(n):n;t.push([s,i,o])}}return n.free(),t}}class ev{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];this.fieldKey=e,this.nodes=new Map(t)}static hasNodeKeyTreeSchema(e){const t=e.nodeSchema.get(Nf);return t instanceof uf&&t.leafValue===ne.String}scanKeys(e){if(this.nodes.clear(),ev.hasNodeKeyTreeSchema(e.schema))for(const[t,n]of this.findKeysInField(e.root))(0,i.v)(!this.nodes.has(t),1761),this.nodes.set(t,n)}clone(e){const t=new ev(this.fieldKey);return t.scanKeys(e),t}forEach(e,t){return this.nodes.forEach(e,t)}get(e){return this.nodes.get(e)}has(e){return this.nodes.has(e)}get size(){return this.nodes.size}entries(){return this.nodes.entries()}keys(){return this.nodes.keys()}values(){return this.nodes.values()}[Symbol.iterator](){return this.nodes[Symbol.iterator]()}*findKeys(e){if(Ef(e.schema)){const t=e.localNodeKey;void 0!==t&&(yield[t,e])}for(const t of e[Yf]())yield*this.findKeysInField(t)}*findKeysInField(e){for(const t of e[Yf]())yield*this.findKeys(t)}}class tv{constructor(e,t){this.map=e,this.manager=t}generate(){return this.manager.generateLocalNodeKey()}stabilize(e){return this.manager.stabilizeNodeKey(e)}localize(e){return this.manager.localizeNodeKey(e)}}class nv{constructor(e,t,n,r,i){this.schema=e,this.forest=t,this.editor=n,this.nodeKeys=r,this.nodeKeyFieldKey=i,this.withCursors=new Set,this.withAnchors=new Set,this.disposed=!1,this.eventUnregister=[this.forest.on("beforeChange",(()=>{this.prepareForEdit()}))]}prepareForEdit(){(0,i.v)(!1===this.disposed,2050);for(const e of this.withCursors)e[ap]();(0,i.v)(0===this.withCursors.size,1907)}[q](){(0,i.v)(!1===this.disposed,2051),this.disposed=!0,this.clear();for(const e of this.eventUnregister)e();this.eventUnregister.length=0}clear(){for(const e of this.withAnchors)e[q]();(0,i.v)(0===this.withCursors.size,1908),(0,i.v)(0===this.withAnchors.size,1909)}get root(){(0,i.v)(!1===this.disposed,2052);const e=this.forest.allocateCursor();yt(this.forest,e);const t=Ep(this,this.schema.rootFieldSchema,e);return e.free(),t}on(e,t){return this.forest.on(e,t)}}class rv{constructor(e,t,n,r,i){this.checkout=e,this.schema=t,this.nodeKeyManager=n,this.nodeKeyFieldKey=r,this.onDispose=i,this.context=function(e,t,n,r,i){const s=new tv(new ev(i),r),o=new nv(e,t,n,s,i);return s.map.scanKeys(o),o.on("afterChange",(()=>{s.map.scanKeys(o)})),o}(t,this.checkout.forest,this.checkout.editor,n,r),this.editableTree=this.context.root}[q](){var e;this.context[q](),null===(e=this.onDispose)||void 0===e||e.call(this)}fork(){const e=this.checkout.fork();return new rv(e,this.schema,this.nodeKeyManager,this.nodeKeyFieldKey)}}class iv extends na{get storedSchema(){return this.view.storedSchema}constructor(e,t,n,r,s){(0,i.v)(void 0!==t.idCompressor,2179);const o={...ov,...r},a=new me,c=o.forest===sv.Optimized?nc(function(e,t){return new Va(e,t,Za.sequenceChunkInlineThreshold,Za.sequenceChunkInlineThreshold,Za.uniformChunkNodeCount,Wa)}(a,Zh)):rd(),l=ct("repair",t.idCompressor,o),u=new ad(t,a,o,{getCurrentSeq:()=>this.runtime.deltaManager.lastSequenceNumber}),h=ef(o,{encodeType:cd.Compressed}),d=new rf(c,t.idCompressor,h,o),p=new of(l),m=new $g(t.idCompressor,h,o),g=(v=m,y=$g.emptyChange,b=e=>{throw e},{buildEditor:e=>v.buildEditor(e),rebaser:af(v.rebaser,y,b),codecs:v.codecs});var v,y,b;super([u,d,p],g,o,e,t,n,s),this.hasView2=!1,this._events=z();const S=this.getLocalBranch();this.view=function(e,t){var n,r,i,s,o,a;const c=null!==(n=null===t||void 0===t?void 0:t.forest)&&void 0!==n?n:rd(),l=null!==(r=null===t||void 0===t?void 0:t.schema)&&void 0!==r?r:new me,u={jsonValidator:f},h=null!==(i=null===t||void 0===t?void 0:t.changeFamily)&&void 0!==i?i:new $g(e,null!==(s=null===t||void 0===t?void 0:t.fieldBatchCodec)&&void 0!==s?s:ef(u,{encodeType:cd.Compressed}),{jsonValidator:f}),d=null!==(o=null===t||void 0===t?void 0:t.branch)&&void 0!==o?o:new Ro({change:h.rebaser.compose([]),revision:"root"},h,(()=>e.generateCompressedId())),p=null!==(a=null===t||void 0===t?void 0:t.events)&&void 0!==a?a:z(),m=new Xg(d);return new Yg(m,d,h,l,c,p,e,null===t||void 0===t?void 0:t.removedRoots)}(t.idCompressor,{branch:S,changeFamily:g,schema:a,forest:c,fieldBatchCodec:h,events:this._events,removedRoots:l})}requireSchema(e,t,n,r){(0,i.v)(!1===this.hasView2,2033);const s=new Tf(Zh,{},e),o=s.checkCompatibility(this.storedSchema);if(o.write!==ut.Compatible||o.read!==ut.Compatible)return;this.hasView2=!0;const a=new rv(this.view,e,null!==n&&void 0!==n?n:(c=this.runtime.idCompressor,{generateLocalNodeKey:()=>((0,i.v)(void 0!==c,1764),c.generateCompressedId()),localizeNodeKey:e=>((0,i.v)(void 0!==c,1765),c.recompress(e)),stabilizeNodeKey:e=>((0,i.v)(void 0!==c,1766),(0,kf.XT)(c.decompress(e)))}),null!==r&&void 0!==r?r:"__n_id__",(()=>{(0,i.v)(this.hasView2,2034),this.hasView2=!1}));var c;return vg(this._events,this.view,(()=>{const e=s.checkCompatibility(this.storedSchema);return e.write===ut.Compatible&&e.read===ut.Compatible||(a[q](),t(),!1)})),a}contentSnapshot(){const e=this.view.forest.allocateCursor();try{return yt(this.view.forest,e),{schema:this.storedSchema.clone(),tree:Df(e),removed:this.view.getRemovedRoots()}}finally{e.free()}}schematizeInternal(e,t,n){var r;if(!0===this.hasView2)throw new l("Only one view can be constructed from a given tree at a time. Dispose of the first before creating a second.");return this.view.forest.isEmpty&&ge(this.storedSchema)&&(this.view.transaction.start(),function(e,t,n){(0,i.v)(ge(e.storedSchema),1859);const r=bf(t),s=r.rootFieldSchema,o=s.kind.identifier;let a;o===Jh.sequence.identifier||o===Jh.optional.identifier?a=r:((0,i.v)(o===Jh.required.identifier,1480),a={nodeSchema:r.nodeSchema,rootFieldSchema:{kind:Jh.optional,types:s.types}}),(0,i.v)(lc(Zh,r,a),1481),e.updateSchema(a),n(),a!==r&&e.updateSchema(r)}(this.view,e.schema,(()=>{const t={field:pt,parent:void 0},n=function(e,t,n){return Of(n)?Lf(t).multiplicity===Pa.Sequence?((0,i.v)(k(n),1719),n):k(n)?((0,i.v)(1===n.length,1720),n):[n]:Hf(e,t,n)}({schema:e.schema},e.schema.rootFieldSchema,e.initialTree);switch(this.storedSchema.rootFieldSchema.kind.identifier){case Jh.optional.identifier:{const e=this.editor.optionalField(t);(0,i.v)(n.length<=1,2036),e.set(0===n.length?void 0:n[0],!0);break}case Jh.sequence.identifier:this.editor.sequenceField(t).insert(0,n);break;default:T("unexpected root field kind during initialize")}})),this.view.transaction.commit()),function(e,t,n){const r=new Tf(Zh,{},n.schema);{const e=r.checkCompatibility(t.storedSchema);switch(n.allowedSchemaModifications){case ht.None:e.read!==ut.Compatible&&T("Existing stored schema permits trees which are incompatible with the view schema"),e.write!==ut.Compatible&&T("View schema permits trees which are incompatible with the stored schema");break;case ht.SchemaCompatible:e.read!==ut.Compatible&&T("Existing stored schema permits trees which are incompatible with the view schema, so schema can not be updated"),e.write!==ut.Compatible&&t.updateSchema(bf(n.schema));break;default:wt(n.allowedSchemaModifications)}}vg(e,t,(()=>{const e=r.checkCompatibility(t.storedSchema);return e.read!==ut.Compatible&&T("Stored schema changed to one that permits data incompatible with the view schema"),e.write!==ut.Compatible&&T("Stored schema changed to one that does not support all data allowed by view schema"),!0}))}(this.view.events,this.view,e),null!==(r=this.requireSchema(e.schema,(()=>T("schema incompatible")),t,n))&&void 0!==r?r:T("Schematize failed")}schematize(e){const t=function(e){const t=og(e.schema),n=e.initialTree(),r=void 0===n?void 0:[sg(t,n)];return{allowedSchemaModifications:ht.None,schema:t,initialTree:r}}(e),n=this.schematizeInternal(t);return new gg(n)}async loadCore(e){await super.loadCore(e),this._events.emit("afterBatch")}}var sv;!function(e){e[e.Reference=0]="Reference",e[e.Optimized=1]="Optimized"}(sv||(sv={}));const ov={jsonValidator:f,forest:sv.Reference,summaryEncodeType:cd.Uncompressed};class av{constructor(e){this.options=e,this.type="https://graph.microsoft.com/types/tree",this.attributes={type:this.type,snapshotFormatVersion:"0.0.0",packageVersion:"2.0.0-rc.1.0.8"}}async load(e,t,n,r){const i=new iv(t,e,r,this.options,"SharedTree");return await i.load(n),i}create(e,t){const n=new iv(t,e,this.attributes,this.options,"SharedTree");return n.initializeLocal(),n}}class cv{create(e){return e}constructor(e){this.kind=Zp.Leaf,this.implicitlyConstructable=!0,mg(this,e),this.identifier=e.name,this.info=e.info}}function lv(e){return new cv(e)}const uv=lv(Cm.string),hv=lv(Cm.number),dv=lv(Cm.boolean),fv=lv(Cm.null),pv=lv(Cm.handle);function mv(e,t){let n;if(!k(t))return mv(e,[t]);{const e=t.map((e=>((0,i.v)(!Jf(e),2109),e.identifier)));e.sort(),n=JSON.stringify(e)}return"".concat(e,"<").concat(n,">")}const gv={parent:e=>{const t=rm(e).parentField.parent.parent;if(void 0===t)return;const n=zm(t);return(0,i.v)(!Bf(n),2175),n},key:e=>{const t=rm(e).parentField;return t.parent.schema.kind.multiplicity===Pa.Sequence?t.index:t.parent.key},on:(e,t,n)=>rm(e).on(t,n),status:e=>rm(e).treeStatus(),is:(e,t)=>{var n,r;const i=ag(t);return Bf(e)?i instanceof uf&&fd(i.info,e):null!==(n=null===(r=im(e))||void 0===r?void 0:r.is(i))&&void 0!==n&&n},schema:e=>Bf(e)?function(e){switch(typeof e){case"boolean":return dv;case"number":return hv;case"string":return uv;case"object":return null===e?fv:((0,i.v)(pd(e),2174),pv);default:wt(e)}}(e):jm(rm(e).schema)},vv={randomUUID:"undefined"!==typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let yv;const bv=new Uint8Array(16);function Sv(){if(!yv&&(yv="undefined"!==typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!yv))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return yv(bv)}const wv=[];for(let n=0;n<256;++n)wv.push((n+256).toString(16).slice(1));function Cv(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return wv[e[t+0]]+wv[e[t+1]]+wv[e[t+2]]+wv[e[t+3]]+"-"+wv[e[t+4]]+wv[e[t+5]]+"-"+wv[e[t+6]]+wv[e[t+7]]+"-"+wv[e[t+8]]+wv[e[t+9]]+"-"+wv[e[t+10]]+wv[e[t+11]]+wv[e[t+12]]+wv[e[t+13]]+wv[e[t+14]]+wv[e[t+15]]}const xv=function(e,t,n){if(vv.randomUUID&&!t&&!e)return vv.randomUUID();const r=(e=e||{}).random||(e.rng||Sv)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return Cv(r)};var Ev=n(107);const Tv=e=>"object"===typeof e&&"string"===typeof(null===e||void 0===e?void 0:e.name)&&"object"===typeof(null===e||void 0===e?void 0:e.fluid),kv=e=>{const t=e;return"object"===typeof t&&("string"===typeof(null===t||void 0===t?void 0:t.package)||Tv(null===t||void 0===t?void 0:t.package))&&(void 0===(null===t||void 0===t?void 0:t.config)||"object"===typeof(null===t||void 0===t?void 0:t.config))};function Nv(e){for(var t,n,r=arguments.length,i=new Array(r>1?r-1:0),s=1;s<r;s++)i[s-1]=arguments[s];if(void 0===(null===e||void 0===e?void 0:e.tree)||(null===(t=e.tree)||void 0===t||null===(t=t[".app"])||void 0===t?void 0:t.type)!==Et.Tree||(null===(n=e.tree)||void 0===n||null===(n=n[".protocol"])||void 0===n?void 0:n.type)!==Et.Tree)return!1;return 2===Object.keys(e.tree).filter((e=>!i.includes(e))).length}class Fv extends Jt.EventEmitter{constructor(){super(),this.members=new Map,super.setMaxListeners(0)}on(e,t){return super.on(e,t)}addMember(e,t){if(this.members.has(e)){const n=this.members.get(e);(0,i.v)(JSON.stringify(n)===JSON.stringify(t),1202)}else this.members.set(e,t),this.emit("addMember",e,t)}removeMember(e){const t=this.members.get(e);return void 0!==t&&(this.members.delete(e),this.emit("removeMember",e,t),!0)}getMembers(){return new Map(this.members)}getMember(e){return this.members.get(e)}}class Iv{get clientId(){return this._getClientId()}get id(){var e;return null!==(e=this._getContainerDiagnosticId())&&void 0!==e?e:""}get connected(){return this._getConnected()}constructor(e,t,n,r,i,s,o,a,c,l,u,h,d,f,p,m,g,v,y,b,S,w,C,x,E,T){this.options=e,this.scope=t,this.baseSnapshot=n,this._version=r,this.deltaManager=i,this.storage=s,this.quorum=o,this.audience=a,this.loader=c,this.submitFn=l,this.submitSummaryFn=u,this.submitBatchFn=h,this.submitSignalFn=d,this.disposeFn=f,this.closeFn=p,this.updateDirtyContainerState=m,this.getAbsoluteUrl=g,this._getContainerDiagnosticId=v,this._getClientId=y,this._getAttachState=b,this._getConnected=S,this.getSpecifiedCodeDetails=w,this.clientDetails=C,this.existing=x,this.taggedLogger=E,this.pendingLocalState=T,this.supportedFeatures=new Map([["referenceSequenceNumbers",!0]])}getLoadedFromVersion(){return this._version}get attachState(){return this._getAttachState()}}var Av;!function(e){e.Never="Never",e.Disabled="Disabled",e.Enabled="Enabled"}(Av||(Av={}));class Dv extends Zt{get disposed(){return this.isDisposed}get paused(){return 0!==this.pauseCount}get length(){return this.q.length}get idle(){return void 0===this.processingPromise&&0===this.q.length}async waitTillProcessingDone(){var e;return null!==(e=this.processingPromise)&&void 0!==e?e:{count:0,duration:0}}constructor(e){super(),this.worker=e,this.isDisposed=!1,this.q=new Rn,this.pauseCount=1}dispose(){throw new Error("Not implemented.")}clear(){this.q.clear()}peek(){return this.q.peekFront()}toArray(){return this.q.toArray()}push(e){try{this.q.push(e),this.emit("push",e),this.ensureProcessing()}catch(t){this.emit("error",t)}}async pause(){this.pauseCount++,await this.waitTillProcessingDone()}resume(){(0,i.v)(this.pauseCount>0,244),this.pauseCount--,this.ensureProcessing()}ensureProcessing(){this.anythingToProcess()&&void 0===this.processingPromise&&(this.processingPromise=Promise.resolve().then((()=>{(0,i.v)(void 0!==this.processingPromise,895);const e=this.processDeltas();return(0,i.v)(void 0!==this.processingPromise,896),this.processingPromise=void 0,e})).catch((e=>(this.error=e,this.processingPromise=void 0,this.emit("error",e),{count:0,duration:0}))),(0,i.v)(void 0!==this.processingPromise,897))}anythingToProcess(){return 0!==this.q.length&&!this.paused&&void 0===this.error}processDeltas(){const e=en.F.now();let t=0;for(;this.anythingToProcess();){const e=this.q.shift();t++,this.worker(e),this.emit("op",e)}const n=en.F.now()-e;return 0===this.q.length&&this.emit("idle",t,n),{count:t,duration:n}}}class Ov extends o.iq{constructor(e,t,n){super(e,n),this.retryAfterSeconds=t,this.errorType=cs.throttlingError}static wrap(e,t,n){return(0,o.G)(e,(e=>new Ov(e,t)),n)}}function Pv(e){if(ws(e))return!0;switch(e.type){case pn.Propose:case pn.Reject:case pn.NoOp:case Cs.Accept:case pn.Summarize:return!0;default:return!1}}class Rv extends Zt{get active(){return this._active()}get disposed(){return this._closed}get IDeltaSender(){return this}get inbound(){return this._inbound}get inboundSignal(){return this._inboundSignal}get initialSequenceNumber(){return this.initSequenceNumber}get lastSequenceNumber(){return this.lastProcessedSequenceNumber}get lastMessage(){return this.lastProcessedMessage}get lastKnownSeqNumber(){return this.lastObservedSeqNumber}get minimumSequenceNumber(){return this.minSequenceNumber}get hasCheckpointSequenceNumber(){return(0,i.v)(this.connectionManager.connected,223),void 0!==this._checkpointSequenceNumber}get maxMessageSize(){return this.connectionManager.maxMessageSize}get version(){return this.connectionManager.version}get serviceConfiguration(){return this.connectionManager.serviceConfiguration}get outbound(){return this.connectionManager.outbound}get readOnlyInfo(){return this.connectionManager.readOnlyInfo}get clientDetails(){return this.connectionManager.clientDetails}submit(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>4?arguments[4]:void 0,s=arguments.length>5?arguments[5]:void 0;const o={contents:t,metadata:arguments.length>3?arguments[3]:void 0,referenceSequenceNumber:null!==s&&void 0!==s?s:this.lastProcessedSequenceNumber,type:e,compression:r};n||this.flush();const a=this.connectionManager.prepareMessageToSend(o);return void 0===a?-1:((0,i.v)(Pv(a),1049),void 0!==t&&(this.opsSize+=t.length),this.messageBuffer.push(a),a.type===pn.NoOp&&this.noOpCount++,this.emit("submitOp",a),n||this.flush(),a.clientSequenceNumber)}submitSignal(e,t){return this.connectionManager.submitSignal(e,t)}flush(){const e=this.messageBuffer;if(0!==e.length){var t,n,r;if(this.messageBuffer=[],this.emit("prepareSend",e),1===e.length)(0,i.v)(void 0===(null===(t=e[0].metadata)||void 0===t?void 0:t.batch),969);else(0,i.v)(!0===(null===(n=e[0].metadata)||void 0===n?void 0:n.batch),970),(0,i.v)(!1===(null===(r=e[e.length-1].metadata)||void 0===r?void 0:r.batch),971);this.connectionManager.sendMessages(e),(0,i.v)(0===this.messageBuffer.length,972)}}get connectionProps(){return{sequenceNumber:this.lastSequenceNumber,opsSize:this.opsSize>0?this.opsSize:void 0,deltaManagerState:this._disposed?"disposed":this._closed?"closed":"open",...this.connectionManager.connectionProps}}logConnectionIssue(e){var t;(0,i.v)(this.connectionManager.connected,568);const n=this.pending.sort(((e,t)=>e.sequenceNumber-t.sequenceNumber));this.logger.sendTelemetryEvent({...e,fetchReason:this.fetchReason,lastQueuedSequenceNumber:this.lastQueuedSequenceNumber,lastProcessedSequenceNumber:this.lastProcessedSequenceNumber,lastObserved:this.lastObservedSeqNumber,...this.connectionManager.connectionVerboseProps,pendingOps:this.pending.length,pendingFirst:null===(t=n[0])||void 0===t?void 0:t.sequenceNumber,haveHandler:void 0!==this.handler,inboundLength:this.inbound.length,inboundPaused:this.inbound.paused})}constructor(e,t,n,r){super(),this.serviceProvider=e,this.logger=t,this._active=n,this.pending=[],this.currentlyProcessingOps=!1,this.minSequenceNumber=0,this.lastQueuedSequenceNumber=0,this.lastObservedSeqNumber=0,this.lastProcessedSequenceNumber=0,this.noOpCount=0,this.lastClientSequenceNumber=0,this.opsSize=0,this.initSequenceNumber=0,this._closed=!1,this._disposed=!1,this.throttlingIdSet=new Set,this.timeTillThrottling=0,this.closeAbortController=new AbortController,this.deltaStorageDelayId=xv(),this.deltaStreamDelayId=xv(),this.messageBuffer=[];const i={incomingOpHandler:(e,t)=>{try{this.enqueueMessages(e,t)}catch(n){this.logger.sendErrorEvent({eventName:"EnqueueMessages_Exception"},n),this.close((0,o.cQ)(n))}},signalHandler:e=>{for(const t of e)this._inboundSignal.push(t)},reconnectionDelayHandler:(e,t)=>this.emitDelayInfo(this.deltaStreamDelayId,e,t),closeHandler:e=>this.close(e),disconnectHandler:e=>this.disconnectHandler(e),connectHandler:e=>this.connectHandler(e),pongHandler:e=>this.emit("pong",e),readonlyChangeHandler:(e,t)=>{!function(e,t,n){try{for(var r=arguments.length,i=new Array(r>3?r-3:0),s=3;s<r;s++)i[s-3]=arguments[s];e.emit(n,...i)}catch(o){t.sendErrorEvent({eventName:"RaiseEventError",event:n},o)}}(this,this.logger,"readonly",e,t)},establishConnectionHandler:e=>this.establishingConnection(e),cancelConnectionHandler:e=>this.cancelEstablishingConnection(e)};this.connectionManager=r(i),this._inbound=new Dv((e=>{this.processInboundMessage(e)})),this._inbound.on("error",(e=>{this.close(h.wrapIfUnrecognized(e,"deltaManagerInboundErrorHandler",this.lastMessage))})),this._inboundSignal=new Dv((e=>{if(void 0===this.handler)throw new Error("Attempted to process an inbound signal without a handler attached");this.handler.processSignal({clientId:e.clientId,content:JSON.parse(e.content)})})),this._inboundSignal.on("error",(e=>{this.close((0,o.cQ)(e))}))}cancelEstablishingConnection(e){this.emit("cancelEstablishingConnection",e)}establishingConnection(e){this.emit("establishingConnection",e)}connectHandler(e){this.refreshDelayInfo(this.deltaStreamDelayId);const t=this.connectionManager.connectionVerboseProps;t.connectionLastQueuedSequenceNumber=this.lastQueuedSequenceNumber,t.connectionLastObservedSeqNumber=this.lastObservedSeqNumber;const n=e.checkpointSequenceNumber;this._checkpointSequenceNumber=n,void 0!==n&&this.updateLatestKnownOpSeqNumber(n),(0,i.v)(0===this.messageBuffer.length,233),this.opsSize=0,this.noOpCount=0,this.emit("connect",e,void 0!==n?this.lastObservedSeqNumber-this.lastSequenceNumber:void 0),void 0!==n?n>this.lastQueuedSequenceNumber&&this.fetchMissingDeltas("AfterConnection"):"read"===e.mode&&this.fetchMissingDeltas("AfterReadConnection")}async attachOpHandler(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"none";if(this.initSequenceNumber=t,this.lastProcessedSequenceNumber=t,this.minSequenceNumber=e,this.lastQueuedSequenceNumber=t,this.lastObservedSeqNumber=t,(0,i.v)(void 0===this.handler,226),this.handler=n,(0,i.v)(!!this.handler,227),(0,i.v)(void 0===this.fetchReason,616),!this._closed){if(this._inbound.resume(),this._inboundSignal.resume(),"none"!==r){const e="cached"===r;await this.fetchMissingDeltasCore("DocumentOpen_".concat(r),e),e&&this.fetchMissingDeltas("PostDocumentOpen")}(0,i.v)(void 0!==this.fetchReason||0===this.pending.length,617)}}connect(e){var t;const n=null===(t=e.fetchOpsFromStorage)||void 0===t||t;!function(e,t,n){if(e)return!0;const r="string"===typeof n?{eventName:n,category:"error"}:{category:"error",...n};t.send(r)}(void 0!==this.handler||!n,this.logger,"CantFetchWithoutBaseline"),n&&this.fetchMissingDeltas(e.reason.text),this.connectionManager.connect(e.reason,e.mode)}async getDeltas(e,t,n,r,s){const o=this.serviceProvider();if(void 0===o)throw new Error("Delta manager is not attached");let a;if(void 0===this.deltaStorage&&(this.deltaStorage=await o.connectToDeltaStorage()),void 0!==t){const r=t-1;if(this.lastQueuedSequenceNumber>=r)return void this.logger.sendPerformanceEvent({reason:n,eventName:"ExtraStorageCall",early:!0,from:e,to:t,...this.connectionManager.connectionVerboseProps});a=e=>e.sequenceNumber>=r}else a=e=>e.sequenceNumber>=this.lastObservedSeqNumber;const c=new AbortController;let l=!1;const u=e=>{(0,i.v)(e.sequenceNumber===this.lastQueuedSequenceNumber,570),!l&&a(e)&&(c.abort("DeltaManager getDeltas fetch cancelled"),this._inbound.off("push",u))};try{this._inbound.on("push",u),(0,i.v)(null===this.closeAbortController.signal.onabort,488),this.closeAbortController.signal.onabort=()=>c.abort(this.closeAbortController.signal.reason);const o=this.deltaStorage.fetchMessages(e,t,c.signal,s,n);for(;;){const e=await o.read();if(e.done)break;try{l=!0,r(e.value)}finally{l=!1}}}finally{c.signal.aborted&&this.logger.sendTelemetryEvent({eventName:"DeltaManager_GetDeltasAborted",fetchReason:n,reason:c.signal.reason}),this.closeAbortController.signal.onabort=null,this._inbound.off("push",u),(0,i.v)(!l,649)}}close(e){this._closed||(this._closed=!0,this.connectionManager.dispose(e,!0),this.clearQueues(),this.emit("closed",e))}dispose(e){if(!this._disposed){if(void 0!==e&&!(0,qn.Xy)(e))throw new l("Error must be a Fluid error");this._disposed=!0,this._closed=!0,this.connectionManager.dispose(e,!1),this.clearQueues(),this.emit("disposed",e),this.removeAllListeners()}}clearQueues(){this.closeAbortController.abort("DeltaManager is closed"),this._inbound.clear(),this._inboundSignal.clear(),this._inbound.pause(),this._inboundSignal.pause(),this.pending=[]}refreshDelayInfo(e){this.throttlingIdSet.delete(e),0===this.throttlingIdSet.size&&(this.timeTillThrottling=0)}disconnectHandler(e){this.messageBuffer.length=0,this.emit("disconnect",e)}emitDelayInfo(e,t,n){const r=Date.now();if(this.throttlingIdSet.add(e),t>0&&r+t>this.timeTillThrottling){this.timeTillThrottling=r+t;const e=Ov.wrap(n,t/1e3,this.logger);this.emit("throttled",e)}}comparableMessagePayload(e){return"".concat(e.clientId,"-").concat(e.type,"-").concat(e.minimumSequenceNumber,"-").concat(e.referenceSequenceNumber,"-").concat(e.timestamp)}enqueueMessages(e,t){var n;let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(void 0===this.handler)return void(this.pending=this.pending.concat(e));if((0,i.v)(0===this.pending.length||void 0!==this.fetchReason,489),0===e.length)return;const s=e[0].sequenceNumber,o=e[e.length-1].sequenceNumber;if(o>this.lastQueuedSequenceNumber){let n=s-1;const i=n-this.lastQueuedSequenceNumber;let a,c,l=0,u=0;for(const t of e)t.sequenceNumber===n?l++:t.sequenceNumber!==n+1&&(u++,void 0===a&&(a=n+1)),n=t.sequenceNumber;0!==l||0!==u&&!r||i>0&&void 0===this.fetchReason?c="enqueueMessages":void 0!==this.fetchReason&&this.fetchReason!==t&&s<=this.lastQueuedSequenceNumber+1&&o>this.lastQueuedSequenceNumber&&(c="enqueueMessagesExtraFetch"),void 0!==c&&this.logger.sendPerformanceEvent({eventName:c,reason:t,previousReason:this.prevEnqueueMessagesReason,from:s,to:o+1,length:e.length,fetchReason:this.fetchReason,duplicate:l>0?l:void 0,initialGap:0!==i?i:void 0,gap:u>0?u:void 0,firstMissing:a,dmInitialSeqNumber:this.initialSequenceNumber,...this.connectionManager.connectionVerboseProps})}this.updateLatestKnownOpSeqNumber(e[e.length-1].sequenceNumber);const a=null===(n=this.previouslyProcessedMessage)||void 0===n?void 0:n.sequenceNumber;(0,i.v)(void 0===a||a===this.lastQueuedSequenceNumber,236);for(const i of e){var c;if(i.sequenceNumber<=this.lastQueuedSequenceNumber){if((null===(c=this.previouslyProcessedMessage)||void 0===c?void 0:c.sequenceNumber)===i.sequenceNumber){const e=this.comparableMessagePayload(this.previouslyProcessedMessage),t=this.comparableMessagePayload(i);if(e!==t){const n=new $n("Found two messages with the same sequenceNumber but different payloads. Likely to be a service issue",Un.fileOverwrittenInStorage,{clientId:this.connectionManager.clientId,sequenceNumber:i.sequenceNumber,message1:e,message2:t,driverVersion:void 0});this.close(n)}}}else i.sequenceNumber!==this.lastQueuedSequenceNumber+1?(this.pending.push(i),this.fetchMissingDeltas(t,i.sequenceNumber)):(this.lastQueuedSequenceNumber=i.sequenceNumber,this.previouslyProcessedMessage=i,this._inbound.push(i))}this.prevEnqueueMessagesReason=this.pending.length>0?"unknown":t}processInboundMessage(e){const t=Date.now();(0,i.v)(!this.currentlyProcessingOps,943),this.currentlyProcessingOps=!0,this.lastProcessedMessage=e;const n="string"===typeof e.clientId;if((0,i.v)(null===e.clientId||n,1050),!n&&Pv(e)&&e.type!==pn.NoOp)throw new u("Mismatch in clientId",{...d(e),messageType:e.type});if("string"===typeof e.contents&&""!==e.contents&&e.type!==pn.ClientLeave&&(e.contents=JSON.parse(e.contents)),void 0!==this.connectionManager.clientId&&this.connectionManager.clientId===e.clientId){e.type===pn.NoOp&&this.noOpCount--;const t=e.clientSequenceNumber-this.lastClientSequenceNumber-1;if(this.noOpCount-=t,this.noOpCount<0)throw new Error("gap in client sequence number: ".concat(t));this.lastClientSequenceNumber=e.clientSequenceNumber}if(this.connectionManager.beforeProcessingIncomingOp(e),this.minSequenceNumber>e.minimumSequenceNumber)throw new u("Found a lower minimumSequenceNumber (msn) than previously recorded",{...d(e),clientId:this.connectionManager.clientId});const r=e.sequenceNumber-e.minimumSequenceNumber;if(r<0||0===r&&null!==e.clientId)throw new u("MSN has to be lower than sequence #",d(e));if(this.minSequenceNumber=e.minimumSequenceNumber,e.sequenceNumber!==this.lastProcessedSequenceNumber+1)throw new u("Found a non-Sequential sequenceNumber",{...d(e),clientId:this.connectionManager.clientId});if(this.lastProcessedSequenceNumber=e.sequenceNumber,(0,i.v)(this.lastProcessedSequenceNumber<=this.lastObservedSeqNumber,615),void 0===this.handler)throw new Error("Attempted to process an inbound message without a handler attached");this.handler.process(e),this.currentlyProcessingOps=!1;const s=Date.now();this.emit("op",e,s-t)}fetchMissingDeltas(e,t){this.fetchMissingDeltasCore(e,!1,t).catch((e=>{this.logger.sendErrorEvent({eventName:"fetchMissingDeltasException"},e)}))}async fetchMissingDeltasCore(e,t,n){if(void 0===this.fetchReason)if(this._closed)this.logger.sendTelemetryEvent({eventName:"fetchMissingDeltasClosedConnection",reason:e});else if(void 0!==this.handler)try{var r;let s=this.lastQueuedSequenceNumber+1;const o=null===(r=this.previouslyProcessedMessage)||void 0===r?void 0:r.sequenceNumber;void 0!==o&&((0,i.v)(o===this.lastQueuedSequenceNumber,242),(0,i.v)(s>1,243),s--);const a="".concat(e,"_fetch");this.fetchReason=a,await this.getDeltas(s,n,a,(e=>{this.refreshDelayInfo(this.deltaStorageDelayId),this.enqueueMessages(e,a)}),t)}catch(s){this.logger.sendErrorEvent({eventName:"GetDeltas_Exception"},s),this.close((0,o.cQ)(s))}finally{this.refreshDelayInfo(this.deltaStorageDelayId),this.fetchReason=void 0,this.processPendingOps(e)}else(0,i.v)(0===this.lastQueuedSequenceNumber,619)}processPendingOps(e){if(this._closed)return;(0,i.v)(void 0!==this.handler,620);const t=this.pending.sort(((e,t)=>e.sequenceNumber-t.sequenceNumber));this.pending=[],this.enqueueMessages(t,"".concat(e,"_pending"),!0),void 0===this.fetchReason&&this.lastQueuedSequenceNumber<this.lastObservedSeqNumber&&this.fetchMissingDeltas("OpsBehind")}updateLatestKnownOpSeqNumber(e){this.lastObservedSeqNumber<e&&(this.lastObservedSeqNumber=e)}}const Mv="2.0.0-rc.1.0.8";class Bv extends o.iq{constructor(e){super(e,{usageError:!0}),this.errorType=Hn.usageError,this.canRetry=!1}}class Lv{constructor(e,t){this.internalStorageService=e,this.addProtocolSummaryIfMissing=t,this.getSnapshotTree=this.internalStorageService.getSnapshotTree.bind(this.internalStorageService),this.getVersions=this.internalStorageService.getVersions.bind(this.internalStorageService),this.createBlob=this.internalStorageService.createBlob.bind(this.internalStorageService),this.readBlob=this.internalStorageService.readBlob.bind(this.internalStorageService),this.downloadSummary=this.internalStorageService.downloadSummary.bind(this.internalStorageService),this.dispose=this.internalStorageService.dispose.bind(this.internalStorageService)}get policies(){return this.internalStorageService.policies}get repositoryUrl(){return this.internalStorageService.repositoryUrl}get disposed(){return this.internalStorageService.disposed}async uploadSummaryWithContext(e,t){return this.internalStorageService.uploadSummaryWithContext(this.addProtocolSummaryIfMissing(e),t)}}class qv{constructor(e,t){this.internalStorageServiceP=e,this.logger=t,this._disposed=!1,this.internalStorageServiceP.then((e=>this.internalStorageService=e)).catch((()=>{}))}get policies(){if(this.internalStorageService)return this.internalStorageService.policies;throw new Error("storage service not yet instantiated")}get disposed(){return this._disposed}dispose(){this._disposed=!0}get repositoryUrl(){if(this.internalStorageService)return this.internalStorageService.repositoryUrl;throw new Error("storage service not yet instantiated")}async getSnapshotTree(e,t){return this.runWithRetry((async()=>this.internalStorageServiceP.then((async n=>n.getSnapshotTree(e,t)))),"storage_getSnapshotTree")}async readBlob(e){return this.runWithRetry((async()=>this.internalStorageServiceP.then((async t=>t.readBlob(e)))),"storage_readBlob")}async getVersions(e,t,n,r){return this.runWithRetry((async()=>this.internalStorageServiceP.then((async i=>i.getVersions(e,t,n,r)))),"storage_getVersions")}async uploadSummaryWithContext(e,t){return(0,i.v)(0===t.referenceSequenceNumber===(void 0===t.ackHandle),593),0!==t.referenceSequenceNumber?this.internalStorageServiceP.then((async n=>n.uploadSummaryWithContext(e,t))):this.runWithRetry((async()=>this.internalStorageServiceP.then((async n=>n.uploadSummaryWithContext(e,t)))),"storage_uploadSummaryWithContext")}async downloadSummary(e){return this.runWithRetry((async()=>this.internalStorageServiceP.then((async t=>t.downloadSummary(e)))),"storage_downloadSummary")}async createBlob(e){return this.runWithRetry((async()=>this.internalStorageServiceP.then((async t=>t.createBlob(e)))),"storage_createBlob")}checkStorageDisposed(e,t){if(this._disposed)throw this.logger.sendTelemetryEvent({eventName:"".concat(e,"_abortedStorageDisposed"),fetchCallName:e},t),new c("Storage Service is disposed. Cannot retry",{canRetry:!1})}async runWithRetry(e,t){return rr(e,t,this.logger,{onRetry:(e,n)=>this.checkStorageDisposed(t,n)})}}class _v{get summarizeProtocolTree(){return!0===this._summarizeProtocolTree}constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0;this.logger=t,this.blobContents=n,this.addProtocolSummaryIfMissing=r,this.disposed=!1,this._storageService=new jv(e,t),this._summarizeProtocolTree=i}dispose(e){var t,n;null===(t=this._storageService)||void 0===t||null===(n=t.dispose)||void 0===n||n.call(t,e),this.disposed=!0}connectToService(e){var t,n;if(!(this._storageService instanceof jv))return;const r=e.connectToStorage(),i=this._storageService=new qv(r,this.logger);this._summarizeProtocolTree=null!==(t=this._summarizeProtocolTree)&&void 0!==t?t:null===(n=e.policies)||void 0===n?void 0:n.summarizeProtocolTree,this.summarizeProtocolTree&&(this.logger.sendTelemetryEvent({eventName:"summarizeProtocolTreeEnabled"}),this._storageService=new Lv(i,this.addProtocolSummaryIfMissing))}loadSnapshotForRehydratingContainer(e){this.getBlobContents(e)}getBlobContents(e){if(void 0!==e.blobsContents)for(const[n,r]of Object.entries(null!==(t=e.blobsContents)&&void 0!==t?t:{})){var t;this.blobContents[n]=r}for(const[n,r]of Object.entries(e.trees))this.getBlobContents(r)}get policies(){try{return this._storageService.policies}catch(e){}}get repositoryUrl(){return this._storageService.repositoryUrl}async getSnapshotTree(e,t){return this._storageService.getSnapshotTree(e,t)}async readBlob(e){const t=this.blobContents[e];if(void 0!==t){if("string"===typeof t){return(0,Ne.Xg)(t,"utf8")}return t}return this._storageService.readBlob(e)}async getVersions(e,t,n,r){return this._storageService.getVersions(e,t,n,r)}async uploadSummaryWithContext(e,t){return this._storageService.uploadSummaryWithContext(e,t)}async downloadSummary(e){return this._storageService.downloadSummary(e)}async createBlob(e){return this._storageService.createBlob(e)}}class jv{constructor(e,t){this.detachedStorage=e,this.logger=t,this.getSnapshotTree=this.notCalled,this.getVersions=this.notCalled,this.write=this.notCalled,this.uploadSummaryWithContext=this.notCalled,this.downloadSummary=this.notCalled}async createBlob(e){return this.verifyStorage().createBlob(e)}async readBlob(e){return this.verifyStorage().readBlob(e)}verifyStorage(){if(void 0===this.detachedStorage)throw new Bv("Real storage calls not allowed in Unattached container");return this.detachedStorage}get policies(){return this.notCalled()}get repositoryUrl(){return this.notCalled()}notCalled(){this.verifyStorage();try{throw new Error("BlobOnlyStorage not implemented method used")}catch(e){throw this.logger.sendTelemetryEvent({eventName:"BlobOnlyStorageWrongCall"},e),e}}}const zv=".blobs",Uv=".redirectTable";async function Hv(e,t){const n={};return await Vv(e,n,t),n}async function Vv(e,t,n){let r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];const i=[];for(const[s,o]of Object.entries(e.trees))r&&s===zv?i.push(Kv(o,t,n)):i.push(Vv(o,t,n,!1));for(const s of Object.values(e.blobs)){const e=await n.readBlob(s);t[s]=(0,Ne.JR)(e,"utf8")}return Promise.all(i)}async function Kv(e,t,n){const r=e.blobs[Uv],i=await n.readBlob(r);t[r]=(0,Ne.JR)(i,"utf8")}function Gv(e){const t={};return Wv(e,t),t}function Wv(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];for(const[i,s]of Object.entries(e.trees))n&&i===zv?Jv(s,t):Wv(s,t,!1);for(const s of Object.values(e.blobs)){var r;const n=null===(r=e.blobsContents)||void 0===r?void 0:r[s];(0,i.v)(void 0!==n,748),t[s]=(0,Ne.JR)(n,"utf8")}}function Jv(e,t){var n;const r=e.blobs[Uv],s=null===(n=e.blobsContents)||void 0===n?void 0:n[r];(0,i.v)(void 0!==s,1807),t[r]=(0,Ne.JR)(s,"utf8")}class Zv{constructor(e,t){this.deltaManager=e,this.listener=t,this.caughtUp=!1,this.opHandler=e=>{!this.caughtUp&&e.sequenceNumber>=this.targetSeqNumber&&(this.caughtUp=!0,this.listener())},this.disposed=!1,this.targetSeqNumber=this.deltaManager.lastKnownSeqNumber,(0,i.v)(this.targetSeqNumber>=this.deltaManager.lastSequenceNumber,892),this.deltaManager.on("op",this.opHandler),this.opHandler({sequenceNumber:this.deltaManager.lastSequenceNumber})}dispose(){this.disposed||(this.disposed=!0,this.deltaManager.off("op",this.opHandler))}}var $v;!function(e){e[e.Disconnected=0]="Disconnected",e[e.EstablishingConnection=3]="EstablishingConnection",e[e.CatchingUp=1]="CatchingUp",e[e.Connected=2]="Connected"}($v||($v={}));function Qv(e,t,n){const r=(0,Yt.Ln)(e.logger);return function(e,t,n,r,i){if(!e)return new ey(n,t,i);return new Yv(n,(e=>new ey(e,t,i)),r)}(!0===r.config.getBoolean("Fluid.Container.CatchUpBeforeDeclaringConnected"),!0===r.config.getBoolean("Fluid.Container.EnableJoinSignalWait"),e,t,n)}class Xv{constructor(e,t){this.inputs=e,this.pimpl=t(this)}get connectionState(){return this.pimpl.connectionState}get pendingClientId(){return this.pimpl.pendingClientId}containerSaved(){return this.pimpl.containerSaved()}dispose(){return this.pimpl.dispose()}initProtocol(e){return this.pimpl.initProtocol(e)}receivedDisconnectEvent(e){return this.pimpl.receivedDisconnectEvent(e)}establishingConnection(e){return this.pimpl.establishingConnection(e)}cancelEstablishingConnection(e){return this.pimpl.cancelEstablishingConnection(e)}receivedConnectEvent(e){return this.pimpl.receivedConnectEvent(e)}get logger(){return this.inputs.logger}connectionStateChanged(e,t,n){return this.inputs.connectionStateChanged(e,t,n)}shouldClientJoinWrite(){return this.inputs.shouldClientJoinWrite()}get maxClientLeaveWaitTime(){return this.inputs.maxClientLeaveWaitTime}logConnectionIssue(e,t,n){return this.inputs.logConnectionIssue(e,t,n)}clientShouldHaveLeft(e){return this.inputs.clientShouldHaveLeft(e)}}class Yv extends Xv{constructor(e,t,n){super(e,t),this.deltaManager=n,this.transitionToConnectedState=()=>{const e=this.pimpl.connectionState;(0,i.v)(e===$v.Connected,997),(0,i.v)(this._connectionState===$v.CatchingUp,998),this._connectionState=$v.Connected,this.inputs.connectionStateChanged($v.Connected,$v.CatchingUp,{text:"caught up"})},this._connectionState=this.pimpl.connectionState}get connectionState(){return this._connectionState}connectionStateChanged(e,t,n){var r;switch(e){case $v.Connected:return(0,i.v)(this._connectionState===$v.CatchingUp,993),(0,i.v)(void 0===this.catchUpMonitor,1003),void(this.catchUpMonitor=new Zv(this.deltaManager,this.transitionToConnectedState));case $v.Disconnected:null===(r=this.catchUpMonitor)||void 0===r||r.dispose(),this.catchUpMonitor=void 0;break;case $v.EstablishingConnection:(0,i.v)(this._connectionState===$v.Disconnected,1746);break;case $v.CatchingUp:(0,i.v)(this._connectionState===$v.EstablishingConnection,995)}this._connectionState=e,this.inputs.connectionStateChanged(e,t,n)}}class ey{get connectionState(){return this._connectionState}get clientId(){return this._clientId}get pendingClientId(){return this._pendingClientId}constructor(e,t,n){var r;this.handler=e,this.readClientsWaitForJoinSignal=t,this._connectionState=$v.Disconnected,this._clientId=n,this.prevClientLeftTimer=new _i(null!==(r=this.handler.maxClientLeaveWaitTime)&&void 0!==r?r:3e5,(()=>{(0,i.v)(this.connectionState!==$v.Connected,684),this.applyForConnectedState("timeout")})),this.joinOpTimer=new _i(0,(()=>{if(this.connectionState!==$v.CatchingUp)return;const e={protocolInitialized:void 0!==this.protocol,pendingClientId:this.pendingClientId,clientJoined:this.hasMember(this.pendingClientId),waitingForLeaveOp:this.waitingForLeaveOp};this.handler.logConnectionIssue("NoJoinOp","error",e)}))}startJoinOpTimer(){(0,i.v)(!this.joinOpTimer.hasTimer,564),(0,i.v)(void 0!==this.connection,1203),this.joinOpTimer.start("write"===this.connection.mode?45e3:5e3)}stopJoinOpTimer(){(0,i.v)(this.joinOpTimer.hasTimer,565),this.joinOpTimer.clear()}get waitingForLeaveOp(){return this.prevClientLeftTimer.hasTimer}dispose(){(0,i.v)(!this.joinOpTimer.hasTimer,677),this.prevClientLeftTimer.clear()}containerSaved(){this.waitingForLeaveOp&&(this.prevClientLeftTimer.clear(),this.applyForConnectedState("containerSaved"))}receivedAddMemberEvent(e){e===this.pendingClientId?(this.joinOpTimer.hasTimer?this.stopJoinOpTimer():this.shouldWaitForJoinSignal()&&this.handler.logConnectionIssue("ReceivedJoinOp","generic"),this.waitingForLeaveOp&&(this.waitEvent=Xt.Bt.start(this.handler.logger,{eventName:"WaitBeforeClientLeave",details:JSON.stringify({waitOnClientId:this._clientId,hadOutstandingOps:this.handler.shouldClientJoinWrite()})})),this.applyForConnectedState("addMemberEvent")):e===this.clientId&&((0,i.v)(!this.waitingForLeaveOp,1490),(0,i.v)(this.connectionState!==$v.Connected,1491),this.prevClientLeftTimer.restart())}applyForConnectedState(e){if((0,i.v)(void 0!==this.protocol,566),(0,i.v)(!this.waitingForLeaveOp||this.hasMember(this.clientId),738),this.pendingClientId!==this.clientId&&this.hasMember(this.pendingClientId)&&!this.waitingForLeaveOp){var t;null===(t=this.waitEvent)||void 0===t||t.end({source:e}),this.setConnectionState($v.Connected)}else{const t="timeout"===e&&this.connectionState!==$v.Disconnected;this.handler.logger.sendTelemetryEvent({eventName:"connectedStateRejected",category:t?"error":"generic",details:JSON.stringify({source:e,pendingClientId:this.pendingClientId,clientId:this.clientId,waitingForLeaveOp:this.waitingForLeaveOp,clientJoined:this.hasMember(this.pendingClientId)})})}}receivedRemoveMemberEvent(e){this.clientId===e&&(this.prevClientLeftTimer.clear(),this.applyForConnectedState("removeMemberEvent"))}receivedDisconnectEvent(e){this.connection=void 0,this.setConnectionState($v.Disconnected,e)}cancelEstablishingConnection(e){(0,i.v)(this._connectionState===$v.EstablishingConnection,1747),(0,i.v)(void 0===this.connection,1748);const t=this._connectionState;this._connectionState=$v.Disconnected,this.handler.connectionStateChanged($v.Disconnected,t,e)}establishingConnection(e){const t=this._connectionState;this._connectionState=$v.EstablishingConnection,this.handler.connectionStateChanged($v.EstablishingConnection,t,{text:"Establishing Connection due to ".concat(e.text),error:e.error})}shouldWaitForJoinSignal(){return(0,i.v)(void 0!==this.connection,1204),"write"===this.connection.mode||this.readClientsWaitForJoinSignal}receivedConnectEvent(e){this.connection=e;const t=this._connectionState;this._connectionState=$v.CatchingUp,this._pendingClientId=e.clientId,this.handler.connectionStateChanged($v.CatchingUp,t,e.reason),!this.hasMember(this._pendingClientId)&&this.shouldWaitForJoinSignal()?this.startJoinOpTimer():this.waitingForLeaveOp||this.setConnectionState($v.Connected)}setConnectionState(e,t){var n;if(this.connectionState===e)return void this.handler.logger.sendErrorEvent({eventName:"setConnectionStateSame",value:e});const r=this._connectionState;this._connectionState=e;const s=void 0!==this._clientId&&void 0!==(null===(n=this.protocol)||void 0===n||null===(n=n.quorum)||void 0===n?void 0:n.getMember(this._clientId));e===$v.Connected?((0,i.v)(r===$v.CatchingUp,472),s&&this.handler.clientShouldHaveLeft(this._clientId),this._clientId=this.pendingClientId):e===$v.Disconnected&&(this._pendingClientId=void 0,this.joinOpTimer.hasTimer&&this.stopJoinOpTimer(),s&&this.handler.shouldClientJoinWrite()&&!this.waitingForLeaveOp?this.prevClientLeftTimer.restart():this.handler.logger.sendTelemetryEvent({eventName:"noWaitOnDisconnected",details:JSON.stringify({clientId:this._clientId,inQuorum:s,waitingForLeaveOp:this.waitingForLeaveOp,hadOutstandingOps:this.handler.shouldClientJoinWrite()})})),this.handler.connectionStateChanged(this._connectionState,r,t)}get membership(){var e,t;return this.readClientsWaitForJoinSignal?null===(e=this.protocol)||void 0===e?void 0:e.audience:null===(t=this.protocol)||void 0===t?void 0:t.quorum}initProtocol(e){var t,n;this.protocol=e,null===(t=this.membership)||void 0===t||t.on("addMember",((t,n)=>{(0,i.v)("read"===n.mode||void 0!==e.quorum.getMember(t),1205),this.receivedAddMemberEvent(t)})),null===(n=this.membership)||void 0===n||n.on("removeMember",(t=>{(0,i.v)(void 0===e.quorum.getMember(t),1206),this.receivedRemoveMemberEvent(t)})),this.hasMember(this.pendingClientId)&&this.receivedAddMemberEvent(this.pendingClientId),void 0!==this.clientId&&this.hasMember(this.clientId)&&this.prevClientLeftTimer.restart()}hasMember(e){var t;return void 0!==(null===(t=this.membership)||void 0===t?void 0:t.getMember(null!==e&&void 0!==e?e:""))}}var ty=n(4080);function ny(e){var t;const n=(0,ty.qg)(e,!0);if("string"!==typeof n.pathname)throw new o.iq("Failed to parse pathname");const r=null!==(t=n.search)&&void 0!==t?t:"",i=/^\/([^/]*\/[^/]*)(\/?.*)$/.exec(n.pathname);return 3===(null===i||void 0===i?void 0:i.length)?{id:i[1],path:i[2],query:r,version:n.query.version}:void 0}function ry(e,t){(0,i.v)(!Nv(e),1448),(0,i.v)(!Nv(t),1449);return{type:Et.Tree,tree:{".protocol":t,".app":e}}}function iy(e){const t={blobs:{},blobsContents:{},trees:{},id:xv(),unreferenced:e.unreferenced},n=Object.keys(e.tree);for(const i of n){const n=e.tree[i];switch(n.type){case Et.Tree:t.trees[i]=iy(n);break;case Et.Attachment:t.blobs[i]=n.id;break;case Et.Blob:{const e=xv();t.blobs[i]=e;const s="string"===typeof n.content?(0,Ne.Xg)(n.content,"utf8"):0===(r=n.content).byteOffset&&r.byteLength===r.buffer.byteLength?r.buffer:r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength);t.blobsContents[e]=s;break}case Et.Handle:throw new o.iq("No handles should be there in summary in detached container!!");default:wt(n,"Unknown tree type ".concat(n.type))}}var r;return t}function sy(e,t){const n={type:Et.Tree,tree:{...t.tree}};n.tree[".protocol"]=e;return iy(n)}const oy=e=>{(0,i.v)(Nv(e),480);return sy(e.tree[".protocol"],e.tree[".app"])};function ay(e){return".protocol"in e.trees?e.trees[".protocol"]:e}class cy extends Zt{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2e3,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:50;super(),this.NoopCountFrequency=t,this.opsProcessedSinceOpSent=0,e!==1/0&&(this.timer=new _i(e,(()=>{0!==this.opsProcessedSinceOpSent&&this.emit("wantsNoop")})))}notifyMessageProcessed(e){ws(e)&&(this.opsProcessedSinceOpSent++,this.opsProcessedSinceOpSent===this.NoopCountFrequency&&queueMicrotask((()=>{this.opsProcessedSinceOpSent>=this.NoopCountFrequency&&(this.emit("wantsNoop"),(0,i.v)(0===this.opsProcessedSinceOpSent,579))})),void 0!==this.timer&&(1===this.opsProcessedSinceOpSent&&this.timer.restart(),(0,i.v)(this.timer.hasTimer,578)))}notifyDisconnect(){this.opsProcessedSinceOpSent=0}notifyMessageSent(){this.opsProcessedSinceOpSent=0}}function ly(e,t,n){const r={...t},i=null===n||void 0===n?void 0:n.online;if(r.online="string"===typeof i?i:Vn[Kn()],"object"===typeof navigator&&null!==navigator){var s,o;const e=navigator,t=null!==(s=null!==(o=e.connection)&&void 0!==o?o:e.mozConnection)&&void 0!==s?s:e.webkitConnection;null!==t&&"object"===typeof t&&(r.connectionType=t.type)}r.category=Yn(n)?"generic":"error",e.sendTelemetryEvent(r,n)}var uy,hy;!function(e){e.DocRead="doc:read",e.DocWrite="doc:write",e.SummaryWrite="summary:write"}(uy||(uy={}));class dy extends Jt.EventEmitter{constructor(){super(),this.addListener=super.addListener.bind(this),this.on=super.on.bind(this),this.once=super.once.bind(this),this.prependListener=super.prependListener.bind(this),this.prependOnceListener=super.prependOnceListener.bind(this),this.removeListener=super.removeListener.bind(this),this.off=super.off.bind(this)}}function fy(e,t){if(!e)throw new Error("number"===typeof t?"0x".concat(t.toString(16).padStart(3,"0")):t)}class py{constructor(e,t,n,r){this.sequenceNumber=e,this.key=t,this.value=n,this.local=r}}class my extends dy{constructor(e){super(),this.isDisposed=!1,this.members=new Map(e),this.snapshotCache=e}get disposed(){return this.isDisposed}snapshot(){var e;return null!==(e=this.snapshotCache)&&void 0!==e||(this.snapshotCache=Array.from(this.members)),this.snapshotCache}addMember(e,t){fy(!!e,1135),fy(!this.members.has(e),462),this.members.set(e,t),this.emit("addMember",e,t),this.snapshotCache=void 0}removeMember(e){fy(!!e,1136),fy(this.members.has(e),463),this.members.delete(e),this.emit("removeMember",e),this.snapshotCache=void 0}getMembers(){return new Map(this.members)}getMember(e){return this.members.get(e)}dispose(){this.isDisposed=!0}}class gy extends dy{constructor(e,t){super(),this.sendProposal=t,this.isDisposed=!1,this.stateEvents=new Jt.EventEmitter,this.proposals=new Map(e.proposals.map((e=>{let[,t]=e;return[t.sequenceNumber,new py(t.sequenceNumber,t.key,t.value,!1)]}))),this.values=new Map(e.values),this.proposalsSnapshotCache=e.proposals,this.valuesSnapshotCache=e.values}get disposed(){return this.isDisposed}snapshot(){var e,t;return null!==(e=this.proposalsSnapshotCache)&&void 0!==e||(this.proposalsSnapshotCache=Array.from(this.proposals).map((e=>{let[t,n]=e;return[t,{sequenceNumber:t,key:n.key,value:n.value},[]]}))),null!==(t=this.valuesSnapshotCache)&&void 0!==t||(this.valuesSnapshotCache=Array.from(this.values)),{proposals:this.proposalsSnapshotCache,values:this.valuesSnapshotCache}}has(e){return this.values.has(e)}get(e){var t;return null===(t=this.values.get(e))||void 0===t?void 0:t.value}getApprovalData(e){return this.values.get(e)}async propose(e,t){const n=this.sendProposal(e,t);if(n<0)throw this.emit("error",{eventName:"ProposalInDisconnectedState",key:e}),new Error("Can't propose in disconnected state");return new Promise(((e,t)=>{let r;const i=(e,t)=>{e===n&&(r=t,this.stateEvents.off("localProposalSequenced",i),this.stateEvents.off("disconnected",o),this.stateEvents.on("localProposalApproved",s))},s=t=>{t===r&&(e(),c())},o=()=>{void 0===r&&this.stateEvents.once("connected",(()=>{void 0===r&&(t(new Error("Client disconnected without successfully sending proposal")),c())}))},a=()=>{t(new Error("QuorumProposals was disposed")),c()},c=()=>{this.stateEvents.off("localProposalSequenced",i),this.stateEvents.off("localProposalApproved",s),this.stateEvents.off("disconnected",o),this.stateEvents.off("disposed",a)};this.stateEvents.on("localProposalSequenced",i),this.stateEvents.on("disconnected",o),this.stateEvents.on("disposed",a)}))}addProposal(e,t,n,r,i){fy(!this.proposals.has(n),464);const s=new py(n,e,t,r);this.proposals.set(n,s),this.emit("addProposal",s),r&&this.stateEvents.emit("localProposalSequenced",i,n),this.proposalsSnapshotCache=void 0}updateMinimumSequenceNumber(e){const t=e.minimumSequenceNumber,n=[];for(const[r,i]of this.proposals)r<=t&&n.push(i);n.sort(((e,t)=>e.sequenceNumber-t.sequenceNumber));for(const r of n){const t={approvalSequenceNumber:e.sequenceNumber,commitSequenceNumber:-1,key:r.key,sequenceNumber:r.sequenceNumber,value:r.value};this.values.set(t.key,t),this.valuesSnapshotCache=void 0;let n=!1,i=!1;for(const[,e]of this.proposals)if(e.key===t.key){if(i){n=!1;break}n=!0,i=!0}this.emit("approveProposal",t.sequenceNumber,t.key,t.value,t.approvalSequenceNumber),n&&this.emit("approveProposalComplete",t.sequenceNumber,t.key,t.value,t.approvalSequenceNumber),this.proposals.delete(r.sequenceNumber),this.proposalsSnapshotCache=void 0,r.local&&this.stateEvents.emit("localProposalApproved",r.sequenceNumber)}}setConnectionState(e){e?this.stateEvents.emit("connected"):this.stateEvents.emit("disconnected")}dispose(){this.isDisposed=!0,this.stateEvents.emit("disposed")}}class vy extends dy{constructor(e,t,n,r){super(),this.isDisposed=!1,this.quorumClients=new my(e),this.quorumClients.on("addMember",((e,t)=>{this.emit("addMember",e,t)})),this.quorumClients.on("removeMember",(e=>{this.emit("removeMember",e)})),this.quorumProposals=new gy({proposals:t,values:n},r),this.quorumProposals.on("addProposal",(e=>{this.emit("addProposal",e)})),this.quorumProposals.on("approveProposal",((e,t,n,r)=>{this.emit("approveProposal",e,t,n,r)}))}get disposed(){return this.isDisposed}close(){this.removeAllListeners()}snapshot(){const e=this.quorumClients.snapshot(),{proposals:t,values:n}=this.quorumProposals.snapshot();return{members:e,proposals:t,values:n}}has(e){return this.quorumProposals.has(e)}get(e){return this.quorumProposals.get(e)}getApprovalData(e){return this.quorumProposals.getApprovalData(e)}addMember(e,t){this.quorumClients.addMember(e,t)}removeMember(e){this.quorumClients.removeMember(e)}getMembers(){return this.quorumClients.getMembers()}getMember(e){return this.quorumClients.getMember(e)}async propose(e,t){return this.quorumProposals.propose(e,t)}addProposal(e,t,n,r,i){return this.quorumProposals.addProposal(e,t,n,r,i)}updateMinimumSequenceNumber(e){this.quorumProposals.updateMinimumSequenceNumber(e)}setConnectionState(e,t){this.quorumProposals.setConnectionState(e)}dispose(){throw new Error("Not implemented.")}}class yy{constructor(e,t,n,r,i,s){this.minimumSequenceNumber=e,this.sequenceNumber=t,this._quorum=new vy(n,r,i,s)}get quorum(){return this._quorum}get attributes(){return{minimumSequenceNumber:this.minimumSequenceNumber,sequenceNumber:this.sequenceNumber}}setConnectionState(e,t){this._quorum.setConnectionState(e,t)}snapshot(){return this._quorum.snapshot()}close(){this._quorum.close()}processMessage(e,t){if(e.sequenceNumber!==this.sequenceNumber+1)throw new Error("Protocol state is not moving sequentially. "+"Current is ".concat(this.sequenceNumber,". Next is ").concat(e.sequenceNumber));this.sequenceNumber=e.sequenceNumber,this.minimumSequenceNumber=e.minimumSequenceNumber;let n=!1;switch(e.type){case pn.ClientJoin:const r=e,i=JSON.parse(r.data),s={client:i.detail,sequenceNumber:r.sequenceNumber};this._quorum.addMember(i.clientId,s);break;case pn.ClientLeave:const o=e,a=JSON.parse(o.data);this._quorum.removeMember(a);break;case pn.Propose:"string"===typeof e.contents&&(e.contents=JSON.parse(e.contents));const c=e.contents;this._quorum.addProposal(c.key,c.value,e.sequenceNumber,t,e.clientSequenceNumber),n=!0}return this._quorum.updateMinimumSequenceNumber(e),{immediateNoOp:n}}getProtocolState(){const e=this._quorum.snapshot().members;return e.forEach((e=>{e[1]={...e[1],client:{...e[1].client,user:{id:""}}}})),{sequenceNumber:this.sequenceNumber,minimumSequenceNumber:this.minimumSequenceNumber,...this._quorum.snapshot(),members:e}}}!function(e){e.ClientJoin="join",e.ClientLeave="leave",e.Clear="clear"}(hy||(hy={}));class by extends yy{constructor(e,t,n,r,i){super(e.minimumSequenceNumber,e.sequenceNumber,t.members,t.proposals,t.values,n),this.audience=r,this.shouldClientHaveLeft=i,this.quorum.on("addMember",((e,t)=>r.addMember(e,t.client))),this.quorum.on("removeMember",(e=>r.removeMember(e)));for(const[s,o]of this.quorum.getMembers())this.audience.addMember(s,o.client)}processMessage(e,t){if(null!=e.clientId){if(void 0===this.quorum.getMember(e.clientId)&&e.type!==pn.ClientJoin)throw new Error("Remote message's clientId is missing from the quorum");if(this.shouldClientHaveLeft(e.clientId)&&!function(e){return e.type===pn.NoOp||e.type===Cs.Accept}(e))throw new Error("Remote message's clientId already should have left")}return super.processMessage(e,t)}processSignal(e){const t=e.content;switch(t.type){case hy.Clear:{const e=this.audience.getMembers();for(const[t,n]of e)"read"===n.mode&&this.audience.removeMember(t);break}case hy.ClientJoin:{const e=t.content;"read"===e.client.mode&&this.audience.addMember(e.clientId,e.client);break}case hy.ClientLeave:{var n;const e=t.content;"read"===(null===(n=this.audience.getMember(e))||void 0===n?void 0:n.mode)&&this.audience.removeMember(e);break}}}}const Sy={fatalConnectError:!0};const wy={mode:"read",details:{capabilities:{interactive:!0}},permission:[],user:{id:"storage-only client"},scopes:[]},Cy="storage-only client";class xy extends Zt{constructor(e,t){super(),this.storageOnlyReason=e,this.readonlyConnectionReason=t,this.clientId=Cy,this.claims={scopes:[uy.DocRead]},this.mode="read",this.existing=!0,this.maxMessageSize=0,this.version="",this.initialMessages=[],this.initialSignals=[],this.initialClients=[{client:wy,clientId:Cy}],this.serviceConfiguration={maxMessageSize:0,blockSize:0},this.checkpointSequenceNumber=void 0,this._disposed=!1}submit(e){this.emit("nack",this.clientId,e.map((e=>({operation:e,content:{message:"Cannot submit with storage-only connection",code:403}}))))}submitSignal(e){this.emit("nack",this.clientId,{operation:e,content:{message:"Cannot submit signal with storage-only connection",code:403}})}get disposed(){return this._disposed}dispose(){this._disposed=!0}}function Ey(e){return e instanceof xy}const Ty=async()=>{var e;if(!1===(null===(e=globalThis.navigator)||void 0===e?void 0:e.onLine)&&void 0!==globalThis.addEventListener)return new Promise((e=>{const t=()=>{e(),globalThis.removeEventListener("online",t)};globalThis.addEventListener("online",t)}))};class ky{get connectionVerboseProps(){return this._connectionVerboseProps}get connectionMode(){var e,t;return null!==(e=null===(t=this.connection)||void 0===t?void 0:t.mode)&&void 0!==e?e:"read"}get connected(){return void 0!==this.connection}get clientId(){var e;return null===(e=this.connection)||void 0===e?void 0:e.clientId}get reconnectMode(){return this._reconnectMode}get maxMessageSize(){var e,t;return null!==(e=null===(t=this.connection)||void 0===t||null===(t=t.serviceConfiguration)||void 0===t?void 0:t.maxMessageSize)&&void 0!==e?e:16384}get version(){if(void 0===this.connection)throw new Error("Cannot check version without a connection");return this.connection.version}get serviceConfiguration(){var e;return null===(e=this.connection)||void 0===e?void 0:e.serviceConfiguration}get scopes(){var e;return null===(e=this.connection)||void 0===e?void 0:e.claims.scopes}get outbound(){return this._outbound}get connectionProps(){return void 0!==this.connection?this._connectionProps:{...this._connectionProps,sentOps:this.clientSequenceNumber}}shouldJoinWrite(){const e=this.clientSequenceNumberObserved<this.clientSequenceNumber-this.localOpsToIgnore,t=this.containerDirty();return e!==t&&this.logger.sendTelemetryEvent({eventName:"DesiredConnectionModeMismatch",details:JSON.stringify({outstandingOps:e,isDirty:t})}),e||t}get readonly(){return this.readOnlyInfo.readonly}get readOnlyInfo(){let e,t=!1;return Ey(this.connection)&&(t=!0,e=this.connection.storageOnlyReason),t||this._forceReadonly||!0===this._readonlyPermissions?{readonly:!0,forced:this._forceReadonly,permissions:this._readonlyPermissions,storageOnly:t,storageOnlyReason:e}:{readonly:this._readonlyPermissions}}static detailsFromConnection(e,t){return{claims:e.claims,clientId:e.clientId,checkpointSequenceNumber:e.checkpointSequenceNumber,get initialClients(){return e.initialClients},mode:e.mode,serviceConfiguration:e.serviceConfiguration,version:e.version,reason:t}}constructor(e,t,n,r,i,s){this.serviceProvider=e,this.containerDirty=t,this.client=n,this.logger=i,this.props=s,this._forceReadonly=!1,this.pendingReconnect=!1,this.clientSequenceNumber=0,this.clientSequenceNumberObserved=0,this.localOpsToIgnore=0,this.connectFirstConnection=!0,this._connectionVerboseProps={},this._connectionProps={},this._disposed=!1,this.opHandler=(e,t)=>{const n=Array.isArray(t)?t:[t];this.props.incomingOpHandler(n,"opHandler")},this.signalHandler=e=>{const t=Array.isArray(e)?e:[e];this.props.signalHandler(t)},this.nackHandler=(e,t)=>{const n=t[0];if(!0===this._readonlyPermissions)return void this.props.closeHandler(((e,t)=>new $n(e,Un.writeError,t))("writeOnReadOnlyDocument",{driverVersion:void 0}));const r=(i=n.content,Xn("Nack (".concat(i.type,"): ").concat(i.message),{canRetry:403!==i.code,retryAfterMs:void 0!==i.retryAfter?1e3*i.retryAfter:void 0},{statusCode:i.code,driverVersion:void 0}));var i;r.canRetry?this.reconnectOnError("write",r):this.props.closeHandler(r)},this.disconnectHandlerInternal=e=>{this.reconnectOnError(this.defaultReconnectionMode,e)},this.errorHandler=e=>{this.reconnectOnError(this.defaultReconnectionMode,e)},this.clientDetails=this.client.details,this.defaultReconnectionMode=this.client.mode,this._reconnectMode=r?Av.Enabled:Av.Never,this._outbound=new Dv((e=>{if(void 0===this.connection)throw new Error("Attempted to submit an outbound message without connection");this.connection.submit(e)})),this._outbound.on("error",(e=>{this.props.closeHandler((0,o.cQ)(e))}))}dispose(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this._disposed)return;this._disposed=!0,this._reconnectMode=Av.Never,this._outbound.clear();const n={text:"Closing DeltaManager",error:e},r=this.readonly;this.disconnectFromDeltaStream(n),t&&this.set_readonlyPermissions(!0,r,n)}setAutoReconnect(e,t){(0,i.v)(e!==Av.Never&&this._reconnectMode!==Av.Never,632),this._reconnectMode=e,e!==Av.Enabled&&this.disconnectFromDeltaStream(t)}forceReadonly(e){e!==this._forceReadonly&&this.logger.sendTelemetryEvent({eventName:"ForceReadOnly",value:e});const t=this.readonly;if(this._forceReadonly=e,t!==this.readonly){if(this._reconnectMode===Av.Never)throw new l("API is not supported for non-connecting or closed container");let e=!1;!0===this.readonly&&(this.shouldJoinWrite()&&this.logger.sendErrorEvent({eventName:"ForceReadonlyPendingChanged"}),e=this.disconnectFromDeltaStream({text:"Force readonly"})),this.props.readonlyChangeHandler(this.readonly),e&&this.triggerConnect({text:"Force Readonly"},"read")}}set_readonlyPermissions(e,t,n){this._readonlyPermissions=e,t!==this.readonly&&this.props.readonlyChangeHandler(this.readonly,n)}connect(e,t){this.connectCore(e,t).catch((e=>{const t=(0,o.cQ)(e,{props:Sy});this.props.closeHandler(t)}))}async connectCore(e,t){var n,r;if((0,i.v)(!this._disposed,618),void 0!==this.connection)return;let s;void 0!==this.pendingConnection&&(s=this.pendingConnection.connectionMode,this.cancelConnection(e),(0,i.v)(void 0===this.pendingConnection,836));let a=null!==(n=null!==t&&void 0!==t?t:s)&&void 0!==n?n:this.defaultReconnectionMode;this.shouldJoinWrite()&&(a="write");const c=this.serviceProvider();let l;if((0,i.v)(void 0!==c,679),!0===(null===(r=c.policies)||void 0===r?void 0:r.storageOnly))return l=new xy,this.setupNewSuccessfulConnection(l,"read",e),void(0,i.v)(void 0===this.pendingConnection,691);let u=500,h=0;const d=en.F.now();let f;const p=new AbortController,m=p.signal;for(this.pendingConnection={abort:()=>{p.abort()},connectionMode:a},this.props.establishConnectionHandler(e);void 0===l;){if(this._disposed)throw new Error("Attempting to connect a closed DeltaManager");if(!0===m.aborted)return void this.logger.sendTelemetryEvent({eventName:"ConnectionAttemptCancelled",attempts:h,duration:(0,Xt.T0)(en.F.now()-d),connectionEstablished:!1});h++;try{this.client.mode=a,l=await c.connectToDeltaStream({...this.client,mode:a}),l.disposed&&(this.logger.sendTelemetryEvent({eventName:"ReceivedClosedConnection"}),l=void 0),this.logger.sendTelemetryEvent({eventName:"ConnectionReceived",connected:void 0!==l&&!1===l.disposed},void 0,Ev.$.verbose)}catch(y){var g;if(this.logger.sendTelemetryEvent({eventName:"ConnectToDeltaStreamException",connected:void 0!==l&&!1===l.disposed},void 0,Ev.$.verbose),"object"===typeof(v=y)&&null!==v&&(null===v||void 0===v?void 0:v.errorType)===Un.deltaStreamConnectionForbidden){l=new xy(y.storageOnlyReason,{text:y.message,error:y}),a="read";break}if((0,qn.Xy)(y)&&y.errorType===Hn.outOfStorageError){l=new xy(void 0,{text:y.message,error:y}),a="read";break}if(!Yn(y)){const e=(0,o.cQ)(y,{props:Sy});throw this.props.closeHandler(e),e}ly(this.logger,{attempts:h,delay:u,eventName:"DeltaConnectionFailureToConnect",duration:(0,Xt.T0)(en.F.now()-d)},y),f=y;const e=en.F.now(),t=tr(y);void 0===t&&!1===(null===(g=globalThis.navigator)||void 0===g?void 0:g.onLine)||(u=or(u,y)),void 0!==t&&this.props.reconnectionDelayHandler(u,y),await new Promise((e=>{setTimeout(e,u)})),await Ty(),this.logger.sendPerformanceEvent({eventName:"WaitBetweenConnectionAttempts",duration:en.F.now()-e,details:JSON.stringify({retryDelayFromError:t,delayMs:u})})}}var v;if(h>1&&ly(this.logger,{eventName:"MultipleDeltaConnectionFailures",attempts:h,duration:(0,Xt.T0)(en.F.now()-d)},f),!0===m.aborted||this._disposed)return l.dispose(),void this.logger.sendTelemetryEvent({eventName:"ConnectionAttemptCancelled",attempts:h,duration:(0,Xt.T0)(en.F.now()-d),connectionEstablished:!0});this.setupNewSuccessfulConnection(l,a,e)}triggerConnect(e,t){this.reconnectMode===Av.Enabled&&this.connect(e,t)}disconnectFromDeltaStream(e){if(this.pendingReconnect=!1,void 0===this.connection)return void 0!==this.pendingConnection&&(this.cancelConnection(e),!0);(0,i.v)(void 0===this.pendingConnection,635);const t=this.connection;return this.connection=void 0,t.off("op",this.opHandler),t.off("signal",this.signalHandler),t.off("nack",this.nackHandler),t.off("disconnect",this.disconnectHandlerInternal),t.off("error",this.errorHandler),t.off("pong",this.props.pongHandler),this._outbound.pause(),this._outbound.clear(),t.dispose(),this.props.disconnectHandler(e),this._connectionVerboseProps={},!0}cancelConnection(e){(0,i.v)(void 0!==this.pendingConnection,837),this.pendingConnection.abort(),this.pendingConnection=void 0,this.logger.sendTelemetryEvent({eventName:"ConnectionCancelReceived"}),this.props.cancelConnectionHandler({text:"Cancel Pending Connection due to ".concat(e.text),error:e.error})}setupNewSuccessfulConnection(e,t,n){var r;(0,i.v)(void 0===this.connection,230),(0,i.v)(!e.disposed,650),this.pendingConnection=void 0;const s=this.readonly;this.connection=e;const o=!e.claims.scopes.includes(uy.DocWrite);if(e.mode!==t&&this.logger.sendTelemetryEvent({eventName:"ConnectionModeMismatch",requestedMode:t,mode:e.mode}),(0,i.v)("read"===t||o===("read"===this.connectionMode),231),(0,i.v)(!o||"read"===this.connectionMode,232),this.set_readonlyPermissions(o,s,Ey(e)?e.readonlyConnectionReason:void 0),this._disposed)return void this.disconnectFromDeltaStream({text:"ConnectionManager already closed"});this._outbound.resume(),e.on("op",this.opHandler),e.on("signal",this.signalHandler),e.on("nack",this.nackHandler),e.on("disconnect",this.disconnectHandlerInternal),e.on("error",this.errorHandler),e.on("pong",this.props.pongHandler);const a=e.initialMessages.sort(((e,t)=>e.sequenceNumber-t.sequenceNumber));let c=e.checkpointSequenceNumber;this._connectionVerboseProps={clientId:e.clientId,mode:e.mode},this._connectionProps={},void 0!==e.relayServiceAgent&&(this._connectionVerboseProps.relayServiceAgent=e.relayServiceAgent,this._connectionProps.relayServiceAgent=e.relayServiceAgent),this._connectionProps.socketDocumentId=e.claims.documentId,this._connectionProps.connectionMode=e.mode;let l=-1;0!==a.length&&(this._connectionVerboseProps.connectionInitialOpsFrom=a[0].sequenceNumber,l=a[a.length-1].sequenceNumber,this._connectionVerboseProps.connectionInitialOpsTo=l+1,(void 0===c||c<l)&&(c=l)),this.props.incomingOpHandler(a,this.connectFirstConnection?"InitialOps":"ReconnectOps");const u=ky.detailsFromConnection(e,n);u.checkpointSequenceNumber=c,this.props.connectHandler(u),this.connectFirstConnection=!1;let h=[{clientId:null,content:JSON.stringify({type:hy.Clear})}];const d=(null!==(r=e.initialClients)&&void 0!==r?r:[]).map((e=>({clientId:null,content:JSON.stringify({type:hy.ClientJoin,content:e})})));d.length>0&&(h=h.concat(d)),void 0!==e.initialSignals&&e.initialSignals.length>0&&(h=h.concat(e.initialSignals)),this.props.signalHandler(h)}reconnectOnError(e,t){this.reconnect(e,{text:t.message,error:t}).catch(this.props.closeHandler)}async reconnect(e,t){var n;if((0,i.v)(void 0!==this.connection,235),this.disconnectFromDeltaStream(t),!1===(null===(n=t.error)||void 0===n?void 0:n.canRetry)&&this.logger.sendTelemetryEvent({eventName:"reconnectingDespiteFatalError",reconnectMode:this.reconnectMode},t.error),this.reconnectMode===Av.Never&&this.props.closeHandler(),this._disposed||this.reconnectMode!==Av.Enabled)return;const r=tr(t.error);void 0!==t.error&&void 0!==r&&(this.props.reconnectionDelayHandler(r,t.error),await new Promise((e=>{setTimeout(e,r)}))),await Ty(),this.triggerConnect({text:void 0!==t.error?"Reconnecting due to Error":"Reconnecting due to: ".concat(t.text),error:t.error},e)}prepareMessageToSend(e){var t;if(!0!==this.readonly){var n;if((0,i.v)(!!this.connection,228),this.lastSubmittedClientId!==(null===(t=this.connection)||void 0===t?void 0:t.clientId))this.lastSubmittedClientId=null===(n=this.connection)||void 0===n?void 0:n.clientId,this.clientSequenceNumber=0,this.clientSequenceNumberObserved=0;return ws(e)?this.localOpsToIgnore=0:this.localOpsToIgnore++,{...e,clientSequenceNumber:++this.clientSequenceNumber}}{(0,i.v)(!0===this.readOnlyInfo.readonly,496);const e=new c("deltaManagerReadonlySubmit",void 0,{readonly:this.readOnlyInfo.readonly,forcedReadonly:this.readOnlyInfo.forced,readonlyPermissions:this.readOnlyInfo.permissions,storageOnly:this.readOnlyInfo.storageOnly,storageOnlyReason:this.readOnlyInfo.storageOnlyReason});this.props.closeHandler(e)}}submitSignal(e,t){void 0!==this.connection?this.connection.submitSignal(e,t):this.logger.sendErrorEvent({eventName:"submitSignalDisconnected"})}sendMessages(e){(0,i.v)(this.connected,692),"read"!==this.connectionMode?((0,i.v)(!this.pendingReconnect,693),this._outbound.push(e)):this.pendingReconnect||(this.pendingReconnect=!0,Promise.resolve().then((async()=>{this.pendingReconnect&&await this.reconnect("write",{text:"Switch to write"})})).catch((()=>{})))}beforeProcessingIncomingOp(e){if((0,i.v)(this.clientId!==e.clientId||this.lastSubmittedClientId===e.clientId,238),void 0!==this.lastSubmittedClientId&&this.lastSubmittedClientId===e.clientId){const t=e.clientSequenceNumber;(0,i.v)(this.clientSequenceNumberObserved<t,239),(0,i.v)(t<=this.clientSequenceNumber,240),this.clientSequenceNumberObserved=t}if(e.type===pn.ClientLeave){const t=e;JSON.parse(t.data)===this.clientId&&(this.logger.sendPerformanceEvent({eventName:"ReadConnectionTransition"}),this.reconnect("read",{text:"Switch to read"}).catch((e=>{this.logger.sendErrorEvent({eventName:"SwitchToReadConnection"},e)})))}}}const Ny="saved",Fy=".hasAttachmentBlobs";const Iy="summarizer";class Ay extends $t{static async load(e,t){const{version:n,pendingLocalState:r,loadMode:i,resolvedUrl:s,loadToSequenceNumber:a}=e,l=new Ay(t,e),u=l.mc.config.getBoolean("Fluid.Loader.DisableRecordHeapSize");return Xt.Bt.timedExecAsync(l.mc.logger,{eventName:"Load"},(async e=>new Promise(((t,u)=>{const h={opsBeforeReturn:"cached"},d=r?{...null!==i&&void 0!==i?i:h,opsBeforeReturn:void 0}:null!==i&&void 0!==i?i:h,f=e=>{u(null!==e&&void 0!==e?e:new c("Container closed without error during load"))};l.on("closed",f),l.load(n,d,s,r,a).finally((()=>{l.removeListener("closed",f)})).then((n=>{e.end({...n,...i}),t(l)}),(e=>{const t=(0,o.cQ)(e);l.close(t),l.dispose(t),f(t)}))}))),{start:!0,end:!0,cancel:"generic"},!0!==u)}static async createDetached(e,t){const n=new Ay(e);return Xt.Bt.timedExecAsync(n.mc.logger,{eventName:"CreateDetached"},(async e=>(await n.createDetached(t),n)),{start:!0,end:!0,cancel:"generic"})}static async rehydrateDetachedFromSnapshot(e,t){const n=new Ay(e);return Xt.Bt.timedExecAsync(n.mc.logger,{eventName:"RehydrateDetachedFromSnapshot"},(async e=>{const r=JSON.parse(t);if(!Nv(r,Fy))throw new l("Cannot rehydrate detached container. Incorrect format");return await n.rehydrateDetachedFromSnapshot(r),n}),{start:!0,end:!0,cancel:"generic"})}setLoaded(){"loading"===this._lifecycleState&&(this.propagateConnectionState(!0),this._lifecycleState="loaded")}get closed(){return"closing"===this._lifecycleState||"closed"===this._lifecycleState||this.disposed}get disposed(){return"disposing"===this._lifecycleState||"disposed"===this._lifecycleState}get runtime(){if(void 0===this._runtime)throw new Error("Attempted to access runtime before it was defined");return this._runtime}get protocolHandler(){if(void 0===this._protocolHandler)throw new Error("Attempted to access protocolHandler before it was defined");return this._protocolHandler}get connectionMode(){return this._deltaManager.connectionManager.connectionMode}get resolvedUrl(){var e;return null===(e=this.service)||void 0===e?void 0:e.resolvedUrl}get readOnlyInfo(){return this._deltaManager.readOnlyInfo}forceReadonly(e){this._deltaManager.connectionManager.forceReadonly(e)}get deltaManager(){return this._deltaManager}get connectionState(){return this.connectionStateHandler.connectionState}get connected(){return this.connectionStateHandler.connectionState===$v.Connected}get clientId(){return this._clientId}get offlineLoadEnabled(){var e,t;return(null!==(e=this.mc.config.getBoolean("Fluid.Container.enableOfflineLoad"))&&void 0!==e?e:!0===(null===(t=this.options)||void 0===t?void 0:t.enableOfflineLoad))&&this.deltaManager.clientDetails.capabilities.interactive}getSpecifiedCodeDetails(){return this.getCodeDetailsFromQuorum()}getLoadedCodeDetails(){return this._loadedCodeDetails}get audience(){return this.protocolHandler.audience}get isDirty(){return this._dirtyContainer}async getEntryPoint(){if(this._disposed)throw new l("The context is already disposed");var e,t;return void 0!==this._runtime?null===(e=(t=this._runtime).getEntryPoint)||void 0===e?void 0:e.call(t):new Promise(((e,t)=>{const n=()=>{var t,n;(0,i.v)(void 0!==this._runtime,1443),e(null===(t=(n=this._runtime).getEntryPoint)||void 0===t?void 0:t.call(n)),this._lifecycleEvents.off("disposed",r)},r=()=>{t(new Error("ContainerContext was disposed")),this._lifecycleEvents.off("runtimeInstantiated",n)};this._lifecycleEvents.once("runtimeInstantiated",n),this._lifecycleEvents.once("disposed",r)}))}constructor(e,t){var n;super(((e,t)=>{this.mc.logger.sendErrorEvent({eventName:"ContainerEventHandlerException",name:"string"===typeof e?e:void 0},t)})),this._lifecycleState="loading",this._attachState=Qt.Detached,this.inboundQueuePausedFromInit=!0,this.firstConnection=!0,this.connectionTransitionTimes=[],this.attachStarted=!1,this._dirtyContainer=!1,this.savedOps=[],this.clientsWhoShouldHaveLeft=new Set,this.setAutoReconnectTime=en.F.now(),this._lifecycleEvents=new Zt,this._disposed=!1,this.getAbsoluteUrl=async e=>{if(void 0!==this.resolvedUrl)return this.urlResolver.getAbsoluteUrl(this.resolvedUrl,e,(e=>{let t;return t=e&&"name"in e?e:Tv(null===e||void 0===e?void 0:e.package)?null===e||void 0===e?void 0:e.package.name:null===e||void 0===e?void 0:e.package,{name:t}})(this._loadedCodeDetails))},this.updateDirtyContainerState=e=>{this._dirtyContainer!==e&&(this._dirtyContainer=e,this.emit(e?"dirty":Ny))};const{canReconnect:r,clientDetailsOverride:i,urlResolver:s,documentServiceFactory:o,codeLoader:a,options:c,scope:l,subLogger:u,detachedBlobStorage:h,protocolHandlerBuilder:d}=e;this.connectionTransitionTimes[$v.Disconnected]=en.F.now();const f=null===t||void 0===t?void 0:t.pendingLocalState;this._clientId=null===f||void 0===f?void 0:f.clientId,this._canReconnect=null===r||void 0===r||r,this.clientDetailsOverride=i,this.urlResolver=s,this.serviceFactory=o,this.codeLoader=a,this.options={...c},this.scope=l,this.detachedBlobStorage=h,this.protocolHandlerBuilder=null!==d&&void 0!==d?d:(e,t,n)=>new by(e,t,n,new Fv,(e=>this.clientsWhoShouldHaveLeft.has(e))),this.clone=async(t,n)=>Ay.load(t,{...e,...n}),this._containerId=xv(),this.client=Ay.setupClient(this._containerId,this.options,this.clientDetailsOverride);const p=this.client.details.type,m=this.client.details.capabilities.interactive,g="".concat(m?"interactive":"noninteractive").concat(void 0!==p&&""!==p?"/".concat(p):"");this.subLogger=(0,Xt.pW)({logger:u,properties:{all:{clientType:g,containerId:this._containerId,docId:()=>{var e;return null===(e=this.resolvedUrl)||void 0===e?void 0:e.id},containerAttachState:()=>this._attachState,containerLifecycleState:()=>this._lifecycleState,containerConnectionState:()=>$v[this.connectionState],serializedContainer:void 0!==f},error:{dmInitialSeqNumber:()=>{var e;return null===(e=this._deltaManager)||void 0===e?void 0:e.initialSequenceNumber},dmLastProcessedSeqNumber:()=>{var e;return null===(e=this._deltaManager)||void 0===e?void 0:e.lastSequenceNumber},dmLastKnownSeqNumber:()=>{var e;return null===(e=this._deltaManager)||void 0===e?void 0:e.lastKnownSeqNumber},containerLoadedFromVersionId:()=>{var e;return null===(e=this._loadedFromVersion)||void 0===e?void 0:e.id},containerLoadedFromVersionDate:()=>{var e;return null===(e=this._loadedFromVersion)||void 0===e?void 0:e.date},dmLastMsqSeqNumber:()=>{var e;return null===(e=this.deltaManager)||void 0===e||null===(e=e.lastMessage)||void 0===e?void 0:e.sequenceNumber},dmLastMsqSeqTimestamp:()=>{var e;return null===(e=this.deltaManager)||void 0===e||null===(e=e.lastMessage)||void 0===e?void 0:e.timestamp},dmLastMsqSeqClientId:()=>{var e,t;return null===(null===(e=this.deltaManager)||void 0===e||null===(e=e.lastMessage)||void 0===e?void 0:e.clientId)?"null":null===(t=this.deltaManager)||void 0===t||null===(t=t.lastMessage)||void 0===t?void 0:t.clientId},dmLastMsgClientSeq:()=>{var e;return null===(e=this.deltaManager)||void 0===e||null===(e=e.lastMessage)||void 0===e?void 0:e.clientSequenceNumber},connectionStateDuration:()=>en.F.now()-this.connectionTransitionTimes[this.connectionState]}}}),this.mc=(0,Yt.CL)({logger:this.subLogger,namespace:"Container"}),this._deltaManager=this.createDeltaManager(),this.connectionStateHandler=Qv({logger:this.mc.logger,connectionStateChanged:(e,t,n)=>{e===$v.Connected&&(this._clientId=this.connectionStateHandler.pendingClientId),this.logConnectionStateChangeTelemetry(e,t,n),"loaded"===this._lifecycleState&&this.propagateConnectionState(!1,e===$v.Disconnected?n:void 0)},shouldClientJoinWrite:()=>this._deltaManager.connectionManager.shouldJoinWrite(),maxClientLeaveWaitTime:c.maxClientLeaveWaitTime,logConnectionIssue:(e,t,n)=>{const r=this.connectionMode;if(this._deltaManager.logConnectionIssue({eventName:e,mode:r,category:"loading"===this._lifecycleState?"generic":t,duration:en.F.now()-this.connectionTransitionTimes[$v.CatchingUp],...void 0===n?{}:{details:JSON.stringify(n)}}),"read"===r){const e={text:"NoJoinSignal"};this.disconnectInternal(e),this.connectInternal({reason:e,fetchOpsFromStorage:!1})}},clientShouldHaveLeft:e=>{this.clientsWhoShouldHaveLeft.add(e)}},this.deltaManager,null===f||void 0===f?void 0:f.clientId),this.on(Ny,(()=>{this.connectionStateHandler.containerSaved()}));const v=null!==(n=this.mc.config.getBoolean("Fluid.Container.summarizeProtocolTree2"))&&void 0!==n?n:c.summarizeProtocolTree;this.storageAdapter=new _v(h,this.mc.logger,null===f||void 0===f?void 0:f.snapshotBlobs,(e=>!0===Nv(e)?e:ry(e,this.captureProtocolSummary())),v);"object"===typeof document&&null!==document&&"function"===typeof document.addEventListener&&null!==document.addEventListener&&m&&(this.lastVisible=document.hidden?en.F.now():void 0,this.visibilityEventHandler=()=>{document.hidden?this.lastVisible=en.F.now():setTimeout((()=>{this.lastVisible=void 0}),0)},document.addEventListener("visibilitychange",this.visibilityEventHandler))}getQuorum(){return this.protocolHandler.quorum}dispose(e){this._deltaManager.dispose(e),this.verifyClosed()}close(e){this._deltaManager.close(e),this.verifyClosed()}verifyClosed(){(0,i.v)(this.connectionState===$v.Disconnected,207),(0,i.v)("closed"===this._lifecycleState||"disposed"===this._lifecycleState,788)}closeCore(e){(0,i.v)(!this.closed,789);try{try{var t;this.mc.logger.sendTelemetryEvent({eventName:"ContainerClose",category:"loading"!==this._lifecycleState&&void 0!==e?"error":"generic"},e),this._lifecycleState="closing",null===(t=this._protocolHandler)||void 0===t||t.close(),this.connectionStateHandler.dispose()}catch(n){this.mc.logger.sendErrorEvent({eventName:"ContainerCloseException"},n)}this.emit("closed",e),void 0!==this.visibilityEventHandler&&document.removeEventListener("visibilitychange",this.visibilityEventHandler)}finally{this._lifecycleState="closed",this.client.details.type===Iy&&this.dispose(e)}}disposeCore(e){(0,i.v)(!this._disposed,1356),this._disposed=!0;try{try{var t,n,r;this.mc.logger.sendTelemetryEvent({eventName:"ContainerDispose",category:this.closed||void 0===e?"generic":"error"},e),"closed"!==this._lifecycleState&&(this._lifecycleState="disposing"),null===(t=this._protocolHandler)||void 0===t||t.close(),this.connectionStateHandler.dispose();const i=void 0!==e?new Error(e.message):void 0;null===(n=this._runtime)||void 0===n||n.dispose(i),this.storageAdapter.dispose(),null===(r=this.service)||void 0===r||r.dispose(e)}catch(s){this.mc.logger.sendErrorEvent({eventName:"ContainerDisposeException"},s)}this.emit("disposed",e),this.removeAllListeners(),void 0!==this.visibilityEventHandler&&document.removeEventListener("visibilitychange",this.visibilityEventHandler)}finally{this._lifecycleState="disposed",this._lifecycleEvents.emit("disposed")}}async closeAndGetPendingLocalState(e){const t=await this.getPendingLocalStateCore({notifyImminentClosure:!0,stopBlobAttachingSignal:e});return this.close(),t}async getPendingLocalState(){return this.getPendingLocalStateCore({notifyImminentClosure:!1})}async getPendingLocalStateCore(e){return Xt.Bt.timedExecAsync(this.mc.logger,{eventName:"getPendingLocalState",notifyImminentClosure:e.notifyImminentClosure,savedOpsSize:this.savedOps.length,clientId:this.clientId},(async()=>{if(!this.offlineLoadEnabled)throw new l("Can't get pending local state unless offline load is enabled");if(this.closed||this._disposed)throw new l("Pending state cannot be retried if the container is closed or disposed");(0,i.v)(this.attachState===Qt.Attached,209),(0,i.v)(void 0!==this.resolvedUrl&&"fluid"===this.resolvedUrl.type,210),(0,i.v)(!!this.baseSnapshot,1492),(0,i.v)(!!this.baseSnapshotBlobs,1493);const t=await this.runtime.getPendingLocalState(e),n={pendingRuntimeState:t,baseSnapshot:this.baseSnapshot,snapshotBlobs:this.baseSnapshotBlobs,savedOps:this.savedOps,url:this.resolvedUrl.url,clientId:void 0!==t?this.clientId:void 0};return JSON.stringify(n)}))}get attachState(){return this._attachState}serialize(){(0,i.v)(this.attachState===Qt.Detached,211);const e=ry(this.runtime.createSummary(),this.captureProtocolSummary());return this.detachedBlobStorage&&this.detachedBlobStorage.size>0&&(e.tree[Fy]={type:Et.Blob,content:"true"}),JSON.stringify(e)}async attach(e,t){await Xt.Bt.timedExecAsync(this.mc.logger,{eventName:"Attach"},(async()=>{if("loaded"!==this._lifecycleState)throw new l("The Container is not in a valid state for attach [".concat(this._lifecycleState,"]"));(0,i.v)(this._attachState===Qt.Detached&&!this.attachStarted,517),this.attachStarted=!0;const n=void 0!==this.detachedBlobStorage&&this.detachedBlobStorage.size>0;try{let r;if((0,i.v)(0===this.deltaManager.inbound.length,214),!n){const e=this.runtime.createSummary(),t=this.captureProtocolSummary();if(r=ry(e,t),this._attachState=Qt.Attaching,this.runtime.setAttachState(Qt.Attaching),this.emit("attaching"),this.offlineLoadEnabled){const e=oy(r);this.baseSnapshot=e,this.baseSnapshotBlobs=Gv(e)}}if(void 0===this.service){const t=await this.urlResolver.resolve(e);(0,i.v)(this.client.details.type!==Iy&&void 0!==t,708),this.service=await rr((async()=>this.serviceFactory.createContainer(r,t,this.subLogger,!1)),"containerAttach",this.mc.logger,{cancel:this._deltaManager.closeAbortController.signal})}if(this.storageAdapter.connectToService(this.service),n){(0,i.v)(!!this.detachedBlobStorage,590);const e=new Map;for(;e.size<this.detachedBlobStorage.size;){const t=this.detachedBlobStorage.getBlobIds().filter((t=>!e.has(t)));for(const n of t){const t=await this.detachedBlobStorage.readBlob(n),r=await this.storageAdapter.createBlob(t);e.set(n,r.id)}}const t=this.runtime.createSummary(e),n=this.captureProtocolSummary();if(r=ry(t,n),this._attachState=Qt.Attaching,this.runtime.setAttachState(Qt.Attaching),this.emit("attaching"),this.offlineLoadEnabled){const e=oy(r);this.baseSnapshot=e,this.baseSnapshotBlobs=Gv(e)}await this.storageAdapter.uploadSummaryWithContext(r,{referenceSequenceNumber:0,ackHandle:void 0,proposalHandle:void 0})}this._attachState=Qt.Attached,this.runtime.setAttachState(Qt.Attached),this.emit("attached"),this.closed||this.handleDeltaConnectionArg({fetchOpsFromStorage:!1,reason:{text:"createDetached"}},null===t||void 0===t?void 0:t.deltaConnection)}catch(s){var r;const e=(0,o.cQ)(s);throw e.addTelemetryProperties({resolvedUrl:null===(r=this.resolvedUrl)||void 0===r?void 0:r.url}),this.close(e),e}}),{start:!0,end:!0,cancel:"generic"})}setAutoReconnectInternal(e,t){if(this._deltaManager.connectionManager.reconnectMode===e)return;const n=en.F.now(),r=n-this.setAutoReconnectTime;this.setAutoReconnectTime=n,this.mc.logger.sendTelemetryEvent({eventName:e===Av.Enabled?"AutoReconnectEnabled":"AutoReconnectDisabled",connectionMode:this.connectionMode,connectionState:$v[this.connectionState],duration:r}),this._deltaManager.connectionManager.setAutoReconnect(e,t)}connect(){if(this.closed)throw new l("The Container is closed and cannot be connected");if(this._attachState!==Qt.Attached)throw new l("The Container is not attached and cannot be connected");this.connected||this.connectInternal({reason:{text:"DocumentConnect"},fetchOpsFromStorage:!1})}connectInternal(e){(0,i.v)(!this.closed,709),(0,i.v)(this._attachState===Qt.Attached,710),this.resumeInternal(e);const t=Av.Enabled;this.setAutoReconnectInternal(t,e.reason)}disconnect(){if(this.closed)throw new l("The Container is closed and cannot be disconnected");this.disconnectInternal({text:"DocumentDisconnect"})}disconnectInternal(e){(0,i.v)(!this.closed,711);const t=Av.Disabled;this.setAutoReconnectInternal(t,e)}resumeInternal(e){(0,i.v)(!this.closed,217),this.inboundQueuePausedFromInit&&(this.inboundQueuePausedFromInit=!1,this._deltaManager.inbound.resume(),this._deltaManager.inboundSignal.resume()),this.connectToDeltaStream(e)}async proposeCodeDetails(e){if(!kv(e))throw new Error("Provided codeDetails are not IFluidCodeDetails");if(this.codeLoader.IFluidCodeDetailsComparer){const t=await this.codeLoader.IFluidCodeDetailsComparer.compare(e,this.getCodeDetailsFromQuorum());if(void 0!==t&&t<=0)throw new Error("Proposed code details should be greater than the current")}return this.protocolHandler.quorum.propose("code",e).then((()=>!0)).catch((()=>!1))}async processCodeProposal(){const e=this.getCodeDetailsFromQuorum();if(await Promise.all([this.deltaManager.inbound.pause(),this.deltaManager.inboundSignal.pause()]),!0===await this.satisfies(e))return this.deltaManager.inbound.resume(),void this.deltaManager.inboundSignal.resume();const t=new c("Existing context does not satisfy incoming proposal");this.close(t)}async satisfies(e){var t;if(void 0===this._loadedModule)return!1;const n=[],r=this.codeLoader;void 0!==r.IFluidCodeDetailsComparer&&n.push(r.IFluidCodeDetailsComparer);const i=null===(t=this._loadedModule)||void 0===t?void 0:t.module.fluidExport;if(void 0!==(null===i||void 0===i?void 0:i.IFluidCodeDetailsComparer)&&n.push(i.IFluidCodeDetailsComparer),0===n.length)return!1;for(const o of n){var s;if(!1===await o.satisfies(null===(s=this._loadedModule)||void 0===s?void 0:s.details,e))return!1}return!0}async getVersion(e){return(await this.storageAdapter.getVersions(e,1))[0]}connectToDeltaStream(e){this._canReconnect&&this.client.details.capabilities.interactive||(e.mode="write"),this._deltaManager.connect(e)}async load(e,t,n,r,s){var o,a,c;const l={phase1:en.F.now()};this.service=await this.serviceFactory.createDocumentService(n,this.subLogger,this.client.details.type===Iy);const u={reason:{text:"DocumentOpen"},mode:!0===this.mc.config.getBoolean("Fluid.Container.ForceWriteConnection")||(null!==(o=null===r||void 0===r?void 0:r.savedOps.length)&&void 0!==o?o:0)>0?"write":"read",fetchOpsFromStorage:!1};void 0!==t.deltaConnection||r||this.connectToDeltaStream(u),this.storageAdapter.connectToService(this.service),this._attachState=Qt.Attached,l.phase2=en.F.now();const{snapshot:h,versionId:d}=void 0===r?await this.fetchSnapshotTree(e):{snapshot:r.baseSnapshot,versionId:void 0};r?(this.baseSnapshot=r.baseSnapshot,this.baseSnapshotBlobs=r.snapshotBlobs):((0,i.v)(void 0!==h,567),this.offlineLoadEnabled&&(this.baseSnapshot=h,this.baseSnapshotBlobs=await Hv(h,this.storageAdapter)));const f=await this.getDocumentAttributes(this.storageAdapter,h),p=null===r||void 0===r||null===(a=r.savedOps[r.savedOps.length-1])||void 0===a?void 0:a.sequenceNumber,m=void 0!==p?{...f,sequenceNumber:p}:f;let g;if(!0===t.pauseAfterLoad){if("sequenceNumber"===t.opsBeforeReturn&&((0,i.v)(void 0!==s,1831),m.sequenceNumber>s))throw new Error("Cannot satisfy request to pause the container at the specified sequence number. Most recent snapshot is newer than the specified sequence number.");this.forceReadonly(!0);const e=()=>{if(void 0===s){if(0!==this.deltaManager.inbound.length)return}else if(this.deltaManager.lastSequenceNumber<s)return;this.deltaManager.inbound.pause(),this.deltaManager.outbound.pause(),this.off("op",e)};void 0===s&&0===this.deltaManager.inbound.length||this.deltaManager.lastSequenceNumber===s?e():this.on("op",e)}switch(t.opsBeforeReturn){case void 0:this.attachDeltaManagerOpHandler(m,"none"!==t.deltaConnection?"all":"none");break;case"sequenceNumber":case"cached":case"all":g=this.attachDeltaManagerOpHandler(m,t.opsBeforeReturn);break;default:wt(t.opsBeforeReturn)}await this.initializeProtocolStateFromSnapshot(f,this.storageAdapter,h),l.phase3=en.F.now();const v=this.getCodeDetailsFromQuorum();if(await this.instantiateRuntime(v,h,r?null!==(c=null===r||void 0===r?void 0:r.pendingRuntimeState)&&void 0!==c?c:{}:void 0),r){for(const e of r.savedOps){var y,b;this.processRemoteMessage({...e,metadata:{...e.metadata,savedOp:!0}}),await(null===(y=(b=this.runtime).notifyOpReplay)||void 0===y?void 0:y.call(b,e))}r.savedOps=[]}if(this.closed||(void 0!==g&&(this._deltaManager.inbound.resume(),await Xt.Bt.timedExecAsync(this.mc.logger,{eventName:"WaitOps"},(async()=>g)),await Xt.Bt.timedExecAsync(this.mc.logger,{eventName:"WaitOpProcessing"},(async()=>this._deltaManager.inbound.waitTillProcessingDone())),this._deltaManager.inbound.pause()),this.handleDeltaConnectionArg(u,t.deltaConnection,void 0!==r)),void 0!==s&&this.deltaManager.lastSequenceNumber<s&&await new Promise(((e,t)=>{const n=t=>{t.sequenceNumber>=s&&(e(),this.off("op",n))};this.on("op",n)})),this.closed)throw new Error("Container was closed while load()");return this.setLoaded(),l.end=en.F.now(),this.subLogger.sendTelemetryEvent({eventName:"LoadStagesTimings",details:JSON.stringify(l)},void 0,Ev.$.verbose),{sequenceNumber:f.sequenceNumber,version:d,dmLastProcessedSeqNumber:this._deltaManager.lastSequenceNumber,dmLastKnownSeqNumber:this._deltaManager.lastKnownSeqNumber}}async createDetached(e){const t={sequenceNumber:0,minimumSequenceNumber:0};await this.attachDeltaManagerOpHandler(t);const n=[["code",{key:"code",value:e,approvalSequenceNumber:0,commitSequenceNumber:0,sequenceNumber:0}]];this.initializeProtocolState(t,{members:[],proposals:[],values:n}),await this.instantiateRuntime(e,void 0),this.setLoaded()}async rehydrateDetachedFromSnapshot(e){void 0!==e.tree[Fy]&&((0,i.v)(!!this.detachedBlobStorage&&this.detachedBlobStorage.size>0,592),delete e.tree[Fy]);const t=oy(e);this.storageAdapter.loadSnapshotForRehydratingContainer(t);const n=await this.getDocumentAttributes(this.storageAdapter,t);await this.attachDeltaManagerOpHandler(n);const r=ay(t),s=await vn(this.storageAdapter,r.blobs.quorumValues);this.initializeProtocolState(n,{members:[],proposals:[],values:s});const o=this.getCodeDetailsFromQuorum();await this.instantiateRuntime(o,t),this.setLoaded()}async getDocumentAttributes(e,t){if(void 0===t)return{minimumSequenceNumber:0,sequenceNumber:0};const n=".protocol"in t.trees?t.trees[".protocol"].blobs.attributes:t.blobs[".attributes"];return await vn(e,n)}async initializeProtocolStateFromSnapshot(e,t,n){const r={members:[],proposals:[],values:[]};if(void 0!==n){const e=ay(n);[r.members,r.proposals,r.values]=await Promise.all([vn(t,e.blobs.quorumMembers),vn(t,e.blobs.quorumProposals),vn(t,e.blobs.quorumValues)])}this.initializeProtocolState(e,r)}initializeProtocolState(e,t){const n=this.protocolHandlerBuilder(e,t,((e,t)=>this.submitMessage(pn.Propose,JSON.stringify({key:e,value:t})))),r=(0,Xt.pW)({logger:this.subLogger,namespace:"ProtocolHandler"});n.quorum.on("error",(e=>{r.sendErrorEvent(e)})),this.connectionStateHandler.initProtocol(n),n.quorum.on("addProposal",(e=>{"code"!==e.key&&"code2"!==e.key||this.emit("codeDetailsProposed",e.value,e)})),n.quorum.on("approveProposal",((e,t,n)=>{"code"!==t&&"code2"!==t||(kv(n)||this.mc.logger.sendErrorEvent({eventName:"CodeProposalNotIFluidCodeDetails"}),this.processCodeProposal().catch((e=>{const t=(0,o.cQ)(e);throw this.close(t),e})))})),this._protocolHandler=n}captureProtocolSummary(){const e=this.protocolHandler.snapshot();return{tree:{attributes:{content:JSON.stringify(this.protocolHandler.attributes),type:Et.Blob},quorumMembers:{content:JSON.stringify(e.members),type:Et.Blob},quorumProposals:{content:JSON.stringify(e.proposals),type:Et.Blob},quorumValues:{content:JSON.stringify(e.values),type:Et.Blob}},type:Et.Tree}}getCodeDetailsFromQuorum(){const e=(e=>{var t;return null!==(t=e.get("code"))&&void 0!==t?t:e.get("code2")})(this.protocolHandler.quorum);return e}static setupClient(e,t,n){const r=E(null===t||void 0===t?void 0:t.client),i=void 0!==r?r:{details:{capabilities:{interactive:!0}},mode:"read",permission:[],scopes:[],user:{id:""}};return void 0!==n&&(i.details={...i.details,...n,capabilities:{...i.details.capabilities,...null===n||void 0===n?void 0:n.capabilities}}),i.details.environment=[i.details.environment," loaderVersion:".concat(Mv)," containerId:".concat(e)].join(";"),i}activeConnection(){return this.connectionState===$v.Connected&&"write"===this.connectionMode}createDeltaManager(){const e=()=>this.service,t=new Rv(e,(0,Xt.pW)({logger:this.subLogger,namespace:"DeltaManager"}),(()=>this.activeConnection()),(t=>new ky(e,(()=>this.isDirty),this.client,this._canReconnect,(0,Xt.pW)({logger:this.subLogger,namespace:"ConnectionManager"}),t)));return t.inbound.pause(),t.inboundSignal.pause(),t.on("connect",((e,t)=>{(0,i.v)(this.connectionMode===e.mode,1207),this.connectionStateHandler.receivedConnectEvent(e)})),t.on("establishingConnection",(e=>{this.connectionStateHandler.establishingConnection(e)})),t.on("cancelEstablishingConnection",(e=>{this.connectionStateHandler.cancelEstablishingConnection(e)})),t.on("disconnect",(e=>{var t;null===(t=this.noopHeuristic)||void 0===t||t.notifyDisconnect(),this.closed||this.connectionStateHandler.receivedDisconnectEvent(e)})),t.on("throttled",(e=>{const t=e;!0!==t.logged&&this.mc.logger.sendTelemetryEvent({eventName:"ContainerWarning"},t),this.emit("warning",t)})),t.on("readonly",(e=>{this.setContextConnectedState(this.connectionState===$v.Connected,e),this.emit("readonly",e)})),t.on("closed",(e=>{this.closeCore(e)})),t.on("disposed",(e=>{this.disposeCore(e)})),t}async attachDeltaManagerOpHandler(e,t){return this._deltaManager.attachOpHandler(e.minimumSequenceNumber,e.sequenceNumber,{process:e=>this.processRemoteMessage(e),processSignal:e=>{this.processSignal(e)}},t)}logConnectionStateChangeTelemetry(e,t,n){var r;const i=en.F.now();this.connectionTransitionTimes[e]=i;const s=i-this.connectionTransitionTimes[t];let o,a,c,l,u;e===$v.Disconnected?c=this._deltaManager.connectionManager.reconnectMode:(e===$v.Connected?(o=i-this.connectionTransitionTimes[$v.Disconnected],o=(0,Xt.T0)(o)):e===$v.CatchingUp&&(l=this.deltaManager.lastKnownSeqNumber,this.deltaManager.hasCheckpointSequenceNumber&&"loaded"===this._lifecycleState&&(u=l-this.deltaManager.lastSequenceNumber)),a=this.firstConnection?"InitialConnect":"AutoReconnect"),this.mc.logger.sendPerformanceEvent({eventName:"ConnectionStateChange_".concat($v[e]),from:$v[t],duration:s,durationFromDisconnected:o,reason:null===n||void 0===n?void 0:n.text,connectionInitiationReason:a,pendingClientId:this.connectionStateHandler.pendingClientId,clientId:this.clientId,autoReconnect:c,opsBehind:u,online:Vn[Kn()],lastVisible:void 0!==this.lastVisible?en.F.now()-this.lastVisible:void 0,checkpointSequenceNumber:l,quorumSize:null===(r=this._protocolHandler)||void 0===r?void 0:r.quorum.getMembers().size,isDirty:this.isDirty,...this._deltaManager.connectionProps},null===n||void 0===n?void 0:n.error),e===$v.Connected&&(this.firstConnection=!1)}propagateConnectionState(e,t){var n;if(!e&&this.connectionState!==$v.Connected&&this.connectionState!==$v.Disconnected)return;const r=this.connectionState===$v.Connected;this.setContextConnectedState(r,null!==(n=this.readOnlyInfo.readonly)&&void 0!==n&&n),this.protocolHandler.setConnectionState(r,this.clientId),un(this.mc.logger,this,r,this.clientId,null===t||void 0===t?void 0:t.text)}submitContainerMessage(e,t,n,r){switch(e){case pn.Operation:return this.submitMessage(e,JSON.stringify(t),n,r);case pn.Summarize:return this.submitSummaryMessage(t);default:{const t=new c("invalidContainerSubmitOpType",void 0,{messageType:e});return this.close(t),-1}}}submitBatch(e,t){let n=-1;for(const r of e)n=this.submitMessage(pn.Operation,r.contents,!0,r.metadata,r.compression,t);return this._deltaManager.flush(),n}submitSummaryMessage(e,t){return void 0===e.details&&(e.details={}),e.details.includesProtocolTree=this.storageAdapter.summarizeProtocolTree,this.submitMessage(pn.Summarize,JSON.stringify(e),!1,void 0,void 0,t)}submitMessage(e,t,n,r,i,s){var o;return this.connectionState!==$v.Connected?(this.mc.logger.sendErrorEvent({eventName:"SubmitMessageWithNoConnection",type:e}),-1):(null===(o=this.noopHeuristic)||void 0===o||o.notifyMessageSent(),this._deltaManager.submit(e,t,n,r,i,s))}processRemoteMessage(e){this.offlineLoadEnabled&&this.savedOps.push(e);const t=this.clientId===e.clientId,n=this.protocolHandler.processMessage(e,t);if(this.runtime.process(e,t),this.activeConnection()){if(void 0===this.noopHeuristic){const e=this.deltaManager.serviceConfiguration;(0,i.v)(void 0!==e,740),this.noopHeuristic=new cy(e.noopTimeFrequency,e.noopCountFrequency),this.noopHeuristic.on("wantsNoop",(()=>{(0,i.v)(this.activeConnection(),577),this.submitMessage(pn.NoOp)}))}this.noopHeuristic.notifyMessageProcessed(e),!0===n.immediateNoOp&&this.submitMessage(Cs.Accept)}this.emit("op",e)}submitSignal(e,t){this._deltaManager.submitSignal(JSON.stringify(e),t)}processSignal(e){if(function(e){if(null===e.clientId){const t=e.content;return t.type===hy.Clear||t.type===hy.ClientJoin||t.type===hy.ClientLeave}return!1}(e))this.protocolHandler.processSignal(e);else{const t=this.clientId===e.clientId;this.runtime.processSignal(e,t)}}async fetchSnapshotTree(e){var t;const n=await this.getVersion(null!==e&&void 0!==e?e:null);void 0===n&&void 0!==e&&this.mc.logger.sendErrorEvent({eventName:"NoVersionFoundWhenSpecified",id:e}),this._loadedFromVersion=n;const r=null!==(t=await this.storageAdapter.getSnapshotTree(n))&&void 0!==t?t:void 0;return void 0===r&&void 0!==n&&this.mc.logger.sendErrorEvent({eventName:"getSnapshotTreeFailed",id:n.id}),{snapshot:r,versionId:null===n||void 0===n?void 0:n.id}}async instantiateRuntime(e,t,n){var r,s;(0,i.v)(!1!==(null===(r=this._runtime)||void 0===r?void 0:r.disposed),221);const o=this.scope,a=new My(this,o.ILoader),c=await Xt.Bt.timedExecAsync(this.subLogger,{eventName:"CodeLoad"},(async()=>this.codeLoader.load(e)));this._loadedModule={module:c.module,details:null!==(s=c.details)&&void 0!==s?s:e};const l=this._loadedModule.module.fluidExport,u=null===l||void 0===l?void 0:l.IRuntimeFactory;if(void 0===u)throw new Error("Code package does not implement IRuntimeFactory");const h=void 0!==t,d=new Iv(this.options,this.scope,t,this._loadedFromVersion,this._deltaManager,this.storageAdapter,this.protocolHandler.quorum,this.protocolHandler.audience,a,((e,t,n,r)=>this.submitContainerMessage(e,t,n,r)),((e,t)=>this.submitSummaryMessage(e,t)),((e,t)=>this.submitBatch(e,t)),((e,t)=>this.submitSignal(e,t)),(e=>this.dispose(e)),(e=>this.close(e)),this.updateDirtyContainerState,this.getAbsoluteUrl,(()=>{var e;return null===(e=this.resolvedUrl)||void 0===e?void 0:e.id}),(()=>this.clientId),(()=>this.attachState),(()=>this.connected),(()=>{var e;return null!==(e=this.protocolHandler.quorum.get("code"))&&void 0!==e?e:this.protocolHandler.quorum.get("code2")}),this._deltaManager.clientDetails,h,this.subLogger,n);this._runtime=await Xt.Bt.timedExecAsync(this.subLogger,{eventName:"InstantiateRuntime"},(async()=>u.instantiateRuntime(d,h))),this._lifecycleEvents.emit("runtimeInstantiated"),this._loadedCodeDetails=e}setContextConnectedState(e,t){var n;!1===(null===(n=this._runtime)||void 0===n?void 0:n.disposed)&&this.runtime.setConnectionState(e&&!t,this.clientId)}handleDeltaConnectionArg(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];switch(t){case void 0:n&&this.connectToDeltaStream(e);case"delayed":(0,i.v)(this.inboundQueuePausedFromInit,838),this.inboundQueuePausedFromInit=!1,this._deltaManager.inbound.resume(),this._deltaManager.inboundSignal.resume();break;case"none":break;default:wt(t)}}}var Dy=n(6522);const{debug:Oy}=Dy;class Py{static mixinDebugLogger(e,t,n){const r=Oy(e),i=Oy(e);return i.log=function(){!0===r.enabled?Oy.log(...arguments):console.error(...arguments)},i.enabled=!0,(0,Xt.Z)({namespace:e,loggers:[t,new Py(r,i)],properties:n,tryInheritProperties:!0})}constructor(e,t){this.debug=e,this.debugErr=t}send(e){var t;const n={...e},r="error"===n.category;let i=r?this.debugErr:this.debug;const s=e.eventName.lastIndexOf(Xt.Hf),o=e.eventName.substring(s+1);s>0&&(i=i.extend(e.eventName.substring(0,s))),n.eventName=void 0;let a="";a="tick=".concat((0,Xt.T0)(en.F.now()));const c=null!==(t=n.stack)&&void 0!==t?t:"";let l;n.stack=void 0;try{l=JSON.stringify(n)}catch(u){n.error=void 0,l=JSON.stringify(n)}"{}"===l&&(l=""),r&&(i.enabled=!0),i("".concat(o," ").concat(l," ").concat(a," ").concat(c))}}function Ry(e){if(void 0===e)throw new Error("Object is not a IResolveUrl.")}class My{constructor(e,t){this.container=e,this.loader=t}async resolve(e){if(e.url.startsWith("/")){var t,n,r,i,s;Ry(this.container.resolvedUrl);return await this.container.clone({resolvedUrl:{...this.container.resolvedUrl},version:null!==(t=null===(n=e.headers)||void 0===n?void 0:n[on.version])&&void 0!==t?t:void 0,loadMode:null===(r=e.headers)||void 0===r?void 0:r[on.loadMode]},{canReconnect:null===(i=e.headers)||void 0===i?void 0:i[on.reconnect],clientDetailsOverride:null===(s=e.headers)||void 0===s?void 0:s[on.clientDetails]})}if(void 0===this.loader)throw new Error("Cannot resolve external containers");return this.loader.resolve(e)}}class By{constructor(e){const{urlResolver:t,documentServiceFactory:n,codeLoader:r,options:i,scope:s,logger:o,detachedBlobStorage:a,configProvider:c,protocolHandlerBuilder:l}=e,u={loaderId:xv(),loaderVersion:Mv},h=(0,Yt.fG)(Py.mixinDebugLogger("fluid:telemetry",o,{all:u}),Yt.lh.value,c);this.services={urlResolver:t,documentServiceFactory:n,codeLoader:r,options:null!==i&&void 0!==i?i:{},scope:!1!==(null===i||void 0===i?void 0:i.provideScopeLoader)?{...s,ILoader:this}:{...s},detachedBlobStorage:a,protocolHandlerBuilder:l,subLogger:h.logger},this.mc=(0,Yt.CL)({logger:this.services.subLogger,namespace:"Loader"})}async createDetachedContainer(e,t){return Ay.createDetached({...t,...this.services},e)}async rehydrateDetachedContainerFromSnapshot(e,t){return Ay.rehydrateDetachedFromSnapshot({...t,...this.services},e)}async resolve(e,t){const n=void 0===t?"Resolve":"ResolveWithPendingState";return Xt.Bt.timedExecAsync(this.mc.logger,{eventName:n},(async()=>(await this.resolveCore(e,void 0!==t?JSON.parse(t):void 0)).container))}async resolveCore(e,t){var n,r,i;const s=await this.services.urlResolver.resolve(e);Ry(s);const o=ny(s.url);if(void 0===o)throw new Error("Invalid URL ".concat(s.url));if(void 0!==t){const e=ny(t.url);if((null===e||void 0===e?void 0:e.id)!==o.id||(null===e||void 0===e?void 0:e.path.replace(/\/$/,""))!==o.path.replace(/\/$/,"")){const e="URL ".concat(s.url," does not match pending state URL ").concat(t.url);throw new Error(e)}}null!==(n=e.headers)&&void 0!==n||(e.headers={}),e.headers[on.version]=null!==(r=o.version)&&void 0!==r?r:e.headers[on.version];const a=e.headers[on.sequenceNumber],c=null===(i=e.headers[on.loadMode])||void 0===i?void 0:i.opsBeforeReturn;if("sequenceNumber"===c&&(void 0===a||a<0))throw new l("sequenceNumber must be set to a non-negative integer");if("sequenceNumber"!==c&&void 0!==a)throw new l('opsBeforeReturn must be set to "sequenceNumber"');return{container:await this.loadContainer(e,s,t),parsed:o}}async loadContainer(e,t,n){var r,i,s,o,a,c;return Ay.load({resolvedUrl:t,version:null!==(r=null===(i=e.headers)||void 0===i?void 0:i[on.version])&&void 0!==r?r:void 0,loadMode:null===(s=e.headers)||void 0===s?void 0:s[on.loadMode],pendingLocalState:n,loadToSequenceNumber:null===(o=e.headers)||void 0===o?void 0:o[on.sequenceNumber]},{canReconnect:null===(a=e.headers)||void 0===a?void 0:a[on.reconnect],clientDetailsOverride:null===(c=e.headers)||void 0===c?void 0:c[on.clientDetails],...this.services})}}function Ly(e,t){var n,r;let i,s,o,a,c,l,u,h;const d=null!==(n=null===(r=en.F.getEntriesByType)||void 0===r?void 0:r.call(en.F,"resource"))&&void 0!==n?n:[];for(let f=d.length-1;f>0;f--){const n=d[f],r=n.name.toString();if(0===n.initiatorType.localeCompare(t)&&r.includes(e)){s=n.redirectEnd-n.redirectStart,h=n.fetchStart,i=n.domainLookupEnd-n.domainLookupStart,o=n.connectEnd-n.connectStart,a=n.secureConnectionStart>0?n.connectEnd-n.secureConnectionStart:0,c=n.responseStart>0?n.responseEnd-n.responseStart:void 0,l=n.fetchStart>0?n.responseEnd-n.fetchStart:void 0,u=n.requestStart>0?n.responseEnd-n.requestStart:void 0;break}}return{dnsLookupTime:i,w3cStartTime:h,redirectTime:s,tcpHandshakeTime:o,secureConnectionTime:a,responseNetworkTime:c,fetchStartToResponseEndTime:l,reqStartToResponseEndTime:u}}function qy(e,t,n,r){let i=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(0!==t.length){const s=t[0].sequenceNumber,o=t.length,a=t[o-1].sequenceNumber;if(a+1!==n+o){if(i||n!==s)t.length=0;else{let e=1;for(;e<t.length&&t[e].sequenceNumber===t[e-1].sequenceNumber+1;)e++;t.length=e}r.sendErrorEvent({eventName:"OpsFetchViolation",reason:e,from:n,start:s,last:a,length:o,details:JSON.stringify({validLength:t.length,lastValidOpSeqNumber:t.length>0?t[t.length-1].sequenceNumber:void 0,strict:i})})}}}class _y{constructor(e){this.maxRequests=e,this.tasks=[],this.release=()=>{const e=this.tasks.shift();if(void 0!==e)return e();this.maxRequests++},(0,i.v)(e>0,174)}get waitQueueLength(){return this.tasks.length}async acquire(){if(!(this.maxRequests>0))return new Promise((e=>{this.tasks.push(e)}));this.maxRequests--}async schedule(e){return await this.acquire(),e().finally(this.release)}}var jy=n(4445);function zy(e,t){switch(t){case"base64":return jy.fromByteArray(e);case"utf8":case"utf-8":case void 0:return(new TextDecoder).decode(e);default:throw new Error("invalid/unsupported encoding")}}function Uy(e){const t=e;return e instanceof ArrayBuffer||"object"===typeof t&&null!==t&&"number"===typeof t.byteLength&&"function"===typeof t.slice&&void 0===t.byteOffset&&void 0===t.buffer}class Hy extends Uint8Array{toString(e){return zy(this,e)}static from(e,t,n){if("string"===typeof e)return Hy.fromString(e,t);if(null!==e&&"object"===typeof e&&Uy(e.buffer))return Hy.fromArrayBuffer(e.buffer,e.byteOffset,e.byteLength);if(Uy(e))return Hy.fromArrayBuffer(e,t,n);throw new TypeError}static fromArrayBuffer(e,t,n){const r=null!==t&&void 0!==t?t:0,i=null!==n&&void 0!==n?n:e.byteLength-r;if(r<0||r>e.byteLength||i<0||i+r>e.byteLength)throw new RangeError;return new Hy(e,r,i)}static fromString(e,t){switch(t){case"base64":{const t=this.sanitizeBase64(e),n=jy.toByteArray(t);return new Hy(n.buffer)}case"utf8":case"utf-8":case void 0:{const t=(new TextEncoder).encode(e);return new Hy(t.buffer)}default:throw new Error("invalid/unsupported encoding")}}static isBuffer(e){throw new Error("unimplemented")}static sanitizeBase64(e){let t=e;if(t=t.split("=")[0],t=t.replace(/[^\w+-/]/g,""),t.length%4!==0){t+=["","===","==","="][t.length%4]}return t}}const Vy=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.map((e=>e.replace(/^\//,"").replace(/\/$/,""))).filter((e=>!!e)).join("/")};function Ky(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";const i={type:"tree",entries:[]},s=Object.keys(t.tree);for(const o of s){const s=t.tree[o];let a,c,l;const u=Vy(""===n?r:n,o);switch(s.type){case Et.Tree:c=Ky(e,s,u,r),l=s.unreferenced||void 0;break;case Et.Blob:c="string"===typeof s.content?{type:"blob",content:s.content,encoding:"utf-8"}:{type:"blob",content:zy(s.content,"base64"),encoding:"base64"};break;case Et.Handle:if(s.embedded)a=s.handle;else{if(!e)throw Error("Parent summary does not exist to reference by handle.");a=Vy(e,r,s.handle)}break;case Et.Attachment:a=s.id;break;default:fr(s,"Unknown type: ".concat(s.type))}const h={path:encodeURIComponent(o),type:mr(s)};let d;if(c)fy(void 0===a,173),d={value:c,unreferenced:l,...h};else{if(!a)throw new Error("Invalid tree entry for ".concat(s.type));d={...h,id:a}}i.entries.push(d)}return i}const Gy=Object.create(null);Gy.open="0",Gy.close="1",Gy.ping="2",Gy.pong="3",Gy.message="4",Gy.upgrade="5",Gy.noop="6";const Wy=Object.create(null);Object.keys(Gy).forEach((e=>{Wy[Gy[e]]=e}));const Jy={type:"error",data:"parser error"},Zy="function"===typeof Blob||"undefined"!==typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),$y="function"===typeof ArrayBuffer,Qy=e=>"function"===typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer instanceof ArrayBuffer,Xy=(e,t,n)=>{let{type:r,data:i}=e;return Zy&&i instanceof Blob?t?n(i):Yy(i,n):$y&&(i instanceof ArrayBuffer||Qy(i))?t?n(i):Yy(new Blob([i]),n):n(Gy[r]+(i||""))},Yy=(e,t)=>{const n=new FileReader;return n.onload=function(){const e=n.result.split(",")[1];t("b"+(e||""))},n.readAsDataURL(e)};function eb(e){return e instanceof Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}let tb;const nb="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",rb="undefined"===typeof Uint8Array?[]:new Uint8Array(256);for(let n=0;n<64;n++)rb[nb.charCodeAt(n)]=n;const ib="function"===typeof ArrayBuffer,sb=(e,t)=>{if("string"!==typeof e)return{type:"message",data:ab(e,t)};const n=e.charAt(0);if("b"===n)return{type:"message",data:ob(e.substring(1),t)};return Wy[n]?e.length>1?{type:Wy[n],data:e.substring(1)}:{type:Wy[n]}:Jy},ob=(e,t)=>{if(ib){const n=(e=>{let t,n,r,i,s,o=.75*e.length,a=e.length,c=0;"="===e[e.length-1]&&(o--,"="===e[e.length-2]&&o--);const l=new ArrayBuffer(o),u=new Uint8Array(l);for(t=0;t<a;t+=4)n=rb[e.charCodeAt(t)],r=rb[e.charCodeAt(t+1)],i=rb[e.charCodeAt(t+2)],s=rb[e.charCodeAt(t+3)],u[c++]=n<<2|r>>4,u[c++]=(15&r)<<4|i>>2,u[c++]=(3&i)<<6|63&s;return l})(e);return ab(n,t)}return{base64:!0,data:e}},ab=(e,t)=>"blob"===t?e instanceof Blob?e:new Blob([e]):e instanceof ArrayBuffer?e:e.buffer,cb=String.fromCharCode(30);function lb(){return new TransformStream({transform(e,t){!function(e,t){Zy&&e.data instanceof Blob?e.data.arrayBuffer().then(eb).then(t):$y&&(e.data instanceof ArrayBuffer||Qy(e.data))?t(eb(e.data)):Xy(e,!1,(e=>{tb||(tb=new TextEncoder),t(tb.encode(e))}))}(e,(n=>{const r=n.length;let i;if(r<126)i=new Uint8Array(1),new DataView(i.buffer).setUint8(0,r);else if(r<65536){i=new Uint8Array(3);const e=new DataView(i.buffer);e.setUint8(0,126),e.setUint16(1,r)}else{i=new Uint8Array(9);const e=new DataView(i.buffer);e.setUint8(0,127),e.setBigUint64(1,BigInt(r))}e.data&&"string"!==typeof e.data&&(i[0]|=128),t.enqueue(i),t.enqueue(n)}))}})}let ub;function hb(e){return e.reduce(((e,t)=>e+t.length),0)}function db(e,t){if(e[0].length===t)return e.shift();const n=new Uint8Array(t);let r=0;for(let i=0;i<t;i++)n[i]=e[0][r++],r===e[0].length&&(e.shift(),r=0);return e.length&&r<e[0].length&&(e[0]=e[0].slice(r)),n}function fb(e){if(e)return function(e){for(var t in fb.prototype)e[t]=fb.prototype[t];return e}(e)}fb.prototype.on=fb.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},fb.prototype.once=function(e,t){function n(){this.off(e,n),t.apply(this,arguments)}return n.fn=t,this.on(e,n),this},fb.prototype.off=fb.prototype.removeListener=fb.prototype.removeAllListeners=fb.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,r=this._callbacks["$"+e];if(!r)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var i=0;i<r.length;i++)if((n=r[i])===t||n.fn===t){r.splice(i,1);break}return 0===r.length&&delete this._callbacks["$"+e],this},fb.prototype.emit=function(e){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),n=this._callbacks["$"+e],r=1;r<arguments.length;r++)t[r-1]=arguments[r];if(n){r=0;for(var i=(n=n.slice(0)).length;r<i;++r)n[r].apply(this,t)}return this},fb.prototype.emitReserved=fb.prototype.emit,fb.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},fb.prototype.hasListeners=function(e){return!!this.listeners(e).length};const pb="undefined"!==typeof self?self:"undefined"!==typeof window?window:Function("return this")();function mb(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return n.reduce(((t,n)=>(e.hasOwnProperty(n)&&(t[n]=e[n]),t)),{})}const gb=pb.setTimeout,vb=pb.clearTimeout;function yb(e,t){t.useNativeTimers?(e.setTimeoutFn=gb.bind(pb),e.clearTimeoutFn=vb.bind(pb)):(e.setTimeoutFn=pb.setTimeout.bind(pb),e.clearTimeoutFn=pb.clearTimeout.bind(pb))}class bb extends Error{constructor(e,t,n){super(e),this.description=t,this.context=n,this.type="TransportError"}}class Sb extends fb{constructor(e){super(),this.writable=!1,yb(this,e),this.opts=e,this.query=e.query,this.socket=e.socket}onError(e,t,n){return super.emitReserved("error",new bb(e,t,n)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}send(e){"open"===this.readyState&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){const t=sb(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){const e=this.opts.hostname;return-1===e.indexOf(":")?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(443!==this.opts.port)||!this.opts.secure&&80!==Number(this.opts.port))?":"+this.opts.port:""}_query(e){const t=function(e){let t="";for(let n in e)e.hasOwnProperty(n)&&(t.length&&(t+="&"),t+=encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t}(e);return t.length?"?"+t:""}}const wb="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),Cb=64,xb={};let Eb,Tb=0,kb=0;function Nb(e){let t="";do{t=wb[e%Cb]+t,e=Math.floor(e/Cb)}while(e>0);return t}function Fb(){const e=Nb(+new Date);return e!==Eb?(Tb=0,Eb=e):e+"."+Nb(Tb++)}for(;kb<Cb;kb++)xb[wb[kb]]=kb;let Ib=!1;try{Ib="undefined"!==typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(ux){}const Ab=Ib;function Db(e){const t=e.xdomain;try{if("undefined"!==typeof XMLHttpRequest&&(!t||Ab))return new XMLHttpRequest}catch(n){}if(!t)try{return new(pb[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(n){}}function Ob(){}const Pb=null!=new Db({xdomain:!1}).responseType;class Rb extends fb{constructor(e,t){super(),yb(this,t),this.opts=t,this.method=t.method||"GET",this.uri=e,this.data=void 0!==t.data?t.data:null,this.create()}create(){var e;const t=mb(this.opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");t.xdomain=!!this.opts.xd;const n=this.xhr=new Db(t);try{n.open(this.method,this.uri,!0);try{if(this.opts.extraHeaders){n.setDisableHeaderCheck&&n.setDisableHeaderCheck(!0);for(let e in this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(e)&&n.setRequestHeader(e,this.opts.extraHeaders[e])}}catch(r){}if("POST"===this.method)try{n.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(r){}try{n.setRequestHeader("Accept","*/*")}catch(r){}null===(e=this.opts.cookieJar)||void 0===e||e.addCookies(n),"withCredentials"in n&&(n.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(n.timeout=this.opts.requestTimeout),n.onreadystatechange=()=>{var e;3===n.readyState&&(null===(e=this.opts.cookieJar)||void 0===e||e.parseCookies(n)),4===n.readyState&&(200===n.status||1223===n.status?this.onLoad():this.setTimeoutFn((()=>{this.onError("number"===typeof n.status?n.status:0)}),0))},n.send(this.data)}catch(r){return void this.setTimeoutFn((()=>{this.onError(r)}),0)}"undefined"!==typeof document&&(this.index=Rb.requestsCount++,Rb.requests[this.index]=this)}onError(e){this.emitReserved("error",e,this.xhr),this.cleanup(!0)}cleanup(e){if("undefined"!==typeof this.xhr&&null!==this.xhr){if(this.xhr.onreadystatechange=Ob,e)try{this.xhr.abort()}catch(t){}"undefined"!==typeof document&&delete Rb.requests[this.index],this.xhr=null}}onLoad(){const e=this.xhr.responseText;null!==e&&(this.emitReserved("data",e),this.emitReserved("success"),this.cleanup())}abort(){this.cleanup()}}if(Rb.requestsCount=0,Rb.requests={},"undefined"!==typeof document)if("function"===typeof attachEvent)attachEvent("onunload",Mb);else if("function"===typeof addEventListener){addEventListener("onpagehide"in pb?"pagehide":"unload",Mb,!1)}function Mb(){for(let e in Rb.requests)Rb.requests.hasOwnProperty(e)&&Rb.requests[e].abort()}const Bb="function"===typeof Promise&&"function"===typeof Promise.resolve?e=>Promise.resolve().then(e):(e,t)=>t(e,0),Lb=pb.WebSocket||pb.MozWebSocket,qb="undefined"!==typeof navigator&&"string"===typeof navigator.product&&"reactnative"===navigator.product.toLowerCase();const _b={websocket:class extends Sb{constructor(e){super(e),this.supportsBinary=!e.forceBase64}get name(){return"websocket"}doOpen(){if(!this.check())return;const e=this.uri(),t=this.opts.protocols,n=qb?{}:mb(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(n.headers=this.opts.extraHeaders);try{this.ws=qb?new Lb(e,t,n):t?new Lb(e,t):new Lb(e)}catch(ux){return this.emitReserved("error",ux)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],r=t===e.length-1;Xy(n,this.supportsBinary,(e=>{try{this.ws.send(e)}catch(t){}r&&Bb((()=>{this.writable=!0,this.emitReserved("drain")}),this.setTimeoutFn)}))}}doClose(){"undefined"!==typeof this.ws&&(this.ws.close(),this.ws=null)}uri(){const e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=Fb()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}check(){return!!Lb}},webtransport:class extends Sb{get name(){return"webtransport"}doOpen(){"function"===typeof WebTransport&&(this.transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name]),this.transport.closed.then((()=>{this.onClose()})).catch((e=>{this.onError("webtransport error",e)})),this.transport.ready.then((()=>{this.transport.createBidirectionalStream().then((e=>{const t=function(e,t){ub||(ub=new TextDecoder);const n=[];let r=0,i=-1,s=!1;return new TransformStream({transform(o,a){for(n.push(o);;){if(0===r){if(hb(n)<1)break;const e=db(n,1);s=128===(128&e[0]),i=127&e[0],r=i<126?3:126===i?1:2}else if(1===r){if(hb(n)<2)break;const e=db(n,2);i=new DataView(e.buffer,e.byteOffset,e.length).getUint16(0),r=3}else if(2===r){if(hb(n)<8)break;const e=db(n,8),t=new DataView(e.buffer,e.byteOffset,e.length),s=t.getUint32(0);if(s>Math.pow(2,21)-1){a.enqueue(Jy);break}i=s*Math.pow(2,32)+t.getUint32(4),r=3}else{if(hb(n)<i)break;const e=db(n,i);a.enqueue(sb(s?e:ub.decode(e),t)),r=0}if(0===i||i>e){a.enqueue(Jy);break}}}})}(Number.MAX_SAFE_INTEGER,this.socket.binaryType),n=e.readable.pipeThrough(t).getReader(),r=lb();r.readable.pipeTo(e.writable),this.writer=r.writable.getWriter();const i=()=>{n.read().then((e=>{let{done:t,value:n}=e;t||(this.onPacket(n),i())})).catch((e=>{}))};i();const s={type:"open"};this.query.sid&&(s.data='{"sid":"'.concat(this.query.sid,'"}')),this.writer.write(s).then((()=>this.onOpen()))}))})))}write(e){this.writable=!1;for(let t=0;t<e.length;t++){const n=e[t],r=t===e.length-1;this.writer.write(n).then((()=>{r&&Bb((()=>{this.writable=!0,this.emitReserved("drain")}),this.setTimeoutFn)}))}}doClose(){var e;null===(e=this.transport)||void 0===e||e.close()}},polling:class extends Sb{constructor(e){if(super(e),this.polling=!1,"undefined"!==typeof location){const t="https:"===location.protocol;let n=location.port;n||(n=t?"443":"80"),this.xd="undefined"!==typeof location&&e.hostname!==location.hostname||n!==e.port}const t=e&&e.forceBase64;this.supportsBinary=Pb&&!t,this.opts.withCredentials&&(this.cookieJar=void 0)}get name(){return"polling"}doOpen(){this.poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this.polling||!this.writable){let e=0;this.polling&&(e++,this.once("pollComplete",(function(){--e||t()}))),this.writable||(e++,this.once("drain",(function(){--e||t()})))}else t()}poll(){this.polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){((e,t)=>{const n=e.split(cb),r=[];for(let i=0;i<n.length;i++){const e=sb(n[i],t);if(r.push(e),"error"===e.type)break}return r})(e,this.socket.binaryType).forEach((e=>{if("opening"===this.readyState&&"open"===e.type&&this.onOpen(),"close"===e.type)return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(e)})),"closed"!==this.readyState&&(this.polling=!1,this.emitReserved("pollComplete"),"open"===this.readyState&&this.poll())}doClose(){const e=()=>{this.write([{type:"close"}])};"open"===this.readyState?e():this.once("open",e)}write(e){this.writable=!1,((e,t)=>{const n=e.length,r=new Array(n);let i=0;e.forEach(((e,s)=>{Xy(e,!1,(e=>{r[s]=e,++i===n&&t(r.join(cb))}))}))})(e,(e=>{this.doWrite(e,(()=>{this.writable=!0,this.emitReserved("drain")}))}))}uri(){const e=this.opts.secure?"https":"http",t=this.query||{};return!1!==this.opts.timestampRequests&&(t[this.opts.timestampParam]=Fb()),this.supportsBinary||t.sid||(t.b64=1),this.createUri(e,t)}request(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Object.assign(e,{xd:this.xd,cookieJar:this.cookieJar},this.opts),new Rb(this.uri(),e)}doWrite(e,t){const n=this.request({method:"POST",data:e});n.on("success",t),n.on("error",((e,t)=>{this.onError("xhr post error",e,t)}))}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",((e,t)=>{this.onError("xhr poll error",e,t)})),this.pollXhr=e}}},jb=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,zb=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Ub(e){if(e.length>2e3)throw"URI too long";const t=e,n=e.indexOf("["),r=e.indexOf("]");-1!=n&&-1!=r&&(e=e.substring(0,n)+e.substring(n,r).replace(/:/g,";")+e.substring(r,e.length));let i=jb.exec(e||""),s={},o=14;for(;o--;)s[zb[o]]=i[o]||"";return-1!=n&&-1!=r&&(s.source=t,s.host=s.host.substring(1,s.host.length-1).replace(/;/g,":"),s.authority=s.authority.replace("[","").replace("]","").replace(/;/g,":"),s.ipv6uri=!0),s.pathNames=function(e,t){const n=/\/{2,9}/g,r=t.replace(n,"/").split("/");"/"!=t.slice(0,1)&&0!==t.length||r.splice(0,1);"/"==t.slice(-1)&&r.splice(r.length-1,1);return r}(0,s.path),s.queryKey=function(e,t){const n={};return t.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(function(e,t,r){t&&(n[t]=r)})),n}(0,s.query),s}class Hb extends fb{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),this.binaryType="arraybuffer",this.writeBuffer=[],e&&"object"===typeof e&&(t=e,e=null),e?(e=Ub(e),t.hostname=e.host,t.secure="https"===e.protocol||"wss"===e.protocol,t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=Ub(t.host).host),yb(this,t),this.secure=null!=t.secure?t.secure:"undefined"!==typeof location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||("undefined"!==typeof location?location.hostname:"localhost"),this.port=t.port||("undefined"!==typeof location&&location.port?location.port:this.secure?"443":"80"),this.transports=t.transports||["polling","websocket","webtransport"],this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},t),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),"string"===typeof this.opts.query&&(this.opts.query=function(e){let t={},n=e.split("&");for(let r=0,i=n.length;r<i;r++){let e=n[r].split("=");t[decodeURIComponent(e[0])]=decodeURIComponent(e[1])}return t}(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,"function"===typeof addEventListener&&(this.opts.closeOnBeforeunload&&(this.beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this.beforeunloadEventListener,!1)),"localhost"!==this.hostname&&(this.offlineEventListener=()=>{this.onClose("transport close",{description:"network connection lost"})},addEventListener("offline",this.offlineEventListener,!1))),this.open()}createTransport(e){const t=Object.assign({},this.opts.query);t.EIO=4,t.transport=e,this.id&&(t.sid=this.id);const n=Object.assign({},this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[e]);return new _b[e](n)}open(){let e;if(this.opts.rememberUpgrade&&Hb.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))e="websocket";else{if(0===this.transports.length)return void this.setTimeoutFn((()=>{this.emitReserved("error","No transports available")}),0);e=this.transports[0]}this.readyState="opening";try{e=this.createTransport(e)}catch(t){return this.transports.shift(),void this.open()}e.open(),this.setTransport(e)}setTransport(e){this.transport&&this.transport.removeAllListeners(),this.transport=e,e.on("drain",this.onDrain.bind(this)).on("packet",this.onPacket.bind(this)).on("error",this.onError.bind(this)).on("close",(e=>this.onClose("transport close",e)))}probe(e){let t=this.createTransport(e),n=!1;Hb.priorWebsocketSuccess=!1;const r=()=>{n||(t.send([{type:"ping",data:"probe"}]),t.once("packet",(e=>{if(!n)if("pong"===e.type&&"probe"===e.data){if(this.upgrading=!0,this.emitReserved("upgrading",t),!t)return;Hb.priorWebsocketSuccess="websocket"===t.name,this.transport.pause((()=>{n||"closed"!==this.readyState&&(l(),this.setTransport(t),t.send([{type:"upgrade"}]),this.emitReserved("upgrade",t),t=null,this.upgrading=!1,this.flush())}))}else{const e=new Error("probe error");e.transport=t.name,this.emitReserved("upgradeError",e)}})))};function i(){n||(n=!0,l(),t.close(),t=null)}const s=e=>{const n=new Error("probe error: "+e);n.transport=t.name,i(),this.emitReserved("upgradeError",n)};function o(){s("transport closed")}function a(){s("socket closed")}function c(e){t&&e.name!==t.name&&i()}const l=()=>{t.removeListener("open",r),t.removeListener("error",s),t.removeListener("close",o),this.off("close",a),this.off("upgrading",c)};t.once("open",r),t.once("error",s),t.once("close",o),this.once("close",a),this.once("upgrading",c),-1!==this.upgrades.indexOf("webtransport")&&"webtransport"!==e?this.setTimeoutFn((()=>{n||t.open()}),200):t.open()}onOpen(){if(this.readyState="open",Hb.priorWebsocketSuccess="websocket"===this.transport.name,this.emitReserved("open"),this.flush(),"open"===this.readyState&&this.opts.upgrade){let e=0;const t=this.upgrades.length;for(;e<t;e++)this.probe(this.upgrades[e])}}onPacket(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),this.resetPingTimeout(),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this.sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong");break;case"error":const t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data)}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.maxPayload=e.maxPayload,this.onOpen(),"closed"!==this.readyState&&this.resetPingTimeout()}resetPingTimeout(){this.clearTimeoutFn(this.pingTimeoutTimer),this.pingTimeoutTimer=this.setTimeoutFn((()=>{this.onClose("ping timeout")}),this.pingInterval+this.pingTimeout),this.opts.autoUnref&&this.pingTimeoutTimer.unref()}onDrain(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0===this.writeBuffer.length?this.emitReserved("drain"):this.flush()}flush(){if("closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const e=this.getWritablePackets();this.transport.send(e),this.prevBufferLen=e.length,this.emitReserved("flush")}}getWritablePackets(){if(!(this.maxPayload&&"polling"===this.transport.name&&this.writeBuffer.length>1))return this.writeBuffer;let e=1;for(let n=0;n<this.writeBuffer.length;n++){const r=this.writeBuffer[n].data;if(r&&(e+="string"===typeof(t=r)?function(e){let t=0,n=0;for(let r=0,i=e.length;r<i;r++)t=e.charCodeAt(r),t<128?n+=1:t<2048?n+=2:t<55296||t>=57344?n+=3:(r++,n+=4);return n}(t):Math.ceil(1.33*(t.byteLength||t.size))),n>0&&e>this.maxPayload)return this.writeBuffer.slice(0,n);e+=2}var t;return this.writeBuffer}write(e,t,n){return this.sendPacket("message",e,t,n),this}send(e,t,n){return this.sendPacket("message",e,t,n),this}sendPacket(e,t,n,r){if("function"===typeof t&&(r=t,t=void 0),"function"===typeof n&&(r=n,n=null),"closing"===this.readyState||"closed"===this.readyState)return;(n=n||{}).compress=!1!==n.compress;const i={type:e,data:t,options:n};this.emitReserved("packetCreate",i),this.writeBuffer.push(i),r&&this.once("flush",r),this.flush()}close(){const e=()=>{this.onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},n=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",(()=>{this.upgrading?n():e()})):this.upgrading?n():e()),this}onError(e){Hb.priorWebsocketSuccess=!1,this.emitReserved("error",e),this.onClose("transport error",e)}onClose(e,t){"opening"!==this.readyState&&"open"!==this.readyState&&"closing"!==this.readyState||(this.clearTimeoutFn(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),"function"===typeof removeEventListener&&(removeEventListener("beforeunload",this.beforeunloadEventListener,!1),removeEventListener("offline",this.offlineEventListener,!1)),this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this.prevBufferLen=0)}filterUpgrades(e){const t=[];let n=0;const r=e.length;for(;n<r;n++)~this.transports.indexOf(e[n])&&t.push(e[n]);return t}}Hb.protocol=4;Hb.protocol;const Vb="function"===typeof ArrayBuffer,Kb=e=>"function"===typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e.buffer instanceof ArrayBuffer,Gb=Object.prototype.toString,Wb="function"===typeof Blob||"undefined"!==typeof Blob&&"[object BlobConstructor]"===Gb.call(Blob),Jb="function"===typeof File||"undefined"!==typeof File&&"[object FileConstructor]"===Gb.call(File);function Zb(e){return Vb&&(e instanceof ArrayBuffer||Kb(e))||Wb&&e instanceof Blob||Jb&&e instanceof File}function $b(e,t){if(!e||"object"!==typeof e)return!1;if(Array.isArray(e)){for(let t=0,n=e.length;t<n;t++)if($b(e[t]))return!0;return!1}if(Zb(e))return!0;if(e.toJSON&&"function"===typeof e.toJSON&&1===arguments.length)return $b(e.toJSON(),!0);for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)&&$b(e[n]))return!0;return!1}function Qb(e){const t=[],n=e.data,r=e;return r.data=Xb(n,t),r.attachments=t.length,{packet:r,buffers:t}}function Xb(e,t){if(!e)return e;if(Zb(e)){const n={_placeholder:!0,num:t.length};return t.push(e),n}if(Array.isArray(e)){const n=new Array(e.length);for(let r=0;r<e.length;r++)n[r]=Xb(e[r],t);return n}if("object"===typeof e&&!(e instanceof Date)){const n={};for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=Xb(e[r],t));return n}return e}function Yb(e,t){return e.data=eS(e.data,t),delete e.attachments,e}function eS(e,t){if(!e)return e;if(e&&!0===e._placeholder){if("number"===typeof e.num&&e.num>=0&&e.num<t.length)return t[e.num];throw new Error("illegal attachments")}if(Array.isArray(e))for(let n=0;n<e.length;n++)e[n]=eS(e[n],t);else if("object"===typeof e)for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(e[n]=eS(e[n],t));return e}const tS=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],nS=5;var rS;!function(e){e[e.CONNECT=0]="CONNECT",e[e.DISCONNECT=1]="DISCONNECT",e[e.EVENT=2]="EVENT",e[e.ACK=3]="ACK",e[e.CONNECT_ERROR=4]="CONNECT_ERROR",e[e.BINARY_EVENT=5]="BINARY_EVENT",e[e.BINARY_ACK=6]="BINARY_ACK"}(rS||(rS={}));class iS{constructor(e){this.replacer=e}encode(e){return e.type!==rS.EVENT&&e.type!==rS.ACK||!$b(e)?[this.encodeAsString(e)]:this.encodeAsBinary({type:e.type===rS.EVENT?rS.BINARY_EVENT:rS.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id})}encodeAsString(e){let t=""+e.type;return e.type!==rS.BINARY_EVENT&&e.type!==rS.BINARY_ACK||(t+=e.attachments+"-"),e.nsp&&"/"!==e.nsp&&(t+=e.nsp+","),null!=e.id&&(t+=e.id),null!=e.data&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){const t=Qb(e),n=this.encodeAsString(t.packet),r=t.buffers;return r.unshift(n),r}}function sS(e){return"[object Object]"===Object.prototype.toString.call(e)}class oS extends fb{constructor(e){super(),this.reviver=e}add(e){let t;if("string"===typeof e){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);const n=t.type===rS.BINARY_EVENT;n||t.type===rS.BINARY_ACK?(t.type=n?rS.EVENT:rS.ACK,this.reconstructor=new aS(t),0===t.attachments&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else{if(!Zb(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t))}}decodeString(e){let t=0;const n={type:Number(e.charAt(0))};if(void 0===rS[n.type])throw new Error("unknown packet type "+n.type);if(n.type===rS.BINARY_EVENT||n.type===rS.BINARY_ACK){const r=t+1;for(;"-"!==e.charAt(++t)&&t!=e.length;);const i=e.substring(r,t);if(i!=Number(i)||"-"!==e.charAt(t))throw new Error("Illegal attachments");n.attachments=Number(i)}if("/"===e.charAt(t+1)){const r=t+1;for(;++t;){if(","===e.charAt(t))break;if(t===e.length)break}n.nsp=e.substring(r,t)}else n.nsp="/";const r=e.charAt(t+1);if(""!==r&&Number(r)==r){const r=t+1;for(;++t;){const n=e.charAt(t);if(null==n||Number(n)!=n){--t;break}if(t===e.length)break}n.id=Number(e.substring(r,t+1))}if(e.charAt(++t)){const r=this.tryParse(e.substr(t));if(!oS.isPayloadValid(n.type,r))throw new Error("invalid payload");n.data=r}return n}tryParse(e){try{return JSON.parse(e,this.reviver)}catch(t){return!1}}static isPayloadValid(e,t){switch(e){case rS.CONNECT:return sS(t);case rS.DISCONNECT:return void 0===t;case rS.CONNECT_ERROR:return"string"===typeof t||sS(t);case rS.EVENT:case rS.BINARY_EVENT:return Array.isArray(t)&&("number"===typeof t[0]||"string"===typeof t[0]&&-1===tS.indexOf(t[0]));case rS.ACK:case rS.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class aS{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){const e=Yb(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}function cS(e,t,n){return e.on(t,n),function(){e.off(t,n)}}const lS=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class uS extends fb{constructor(e,t,n){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,n&&n.auth&&(this.auth=n.auth),this._opts=Object.assign({},n),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const e=this.io;this.subs=[cS(e,"open",this.onopen.bind(this)),cS(e,"packet",this.onpacket.bind(this)),cS(e,"error",this.onerror.bind(this)),cS(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io._reconnecting||this.io.open(),"open"===this.io._readyState&&this.onopen()),this}open(){return this.connect()}send(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.unshift("message"),this.emit.apply(this,t),this}emit(e){if(lS.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];if(n.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(n),this;const i={type:rS.EVENT,data:n,options:{}};if(i.options.compress=!1!==this.flags.compress,"function"===typeof n[n.length-1]){const e=this.ids++,t=n.pop();this._registerAckCallback(e,t),i.id=e}const s=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable;return this.flags.volatile&&(!s||!this.connected)||(this.connected?(this.notifyOutgoingListeners(i),this.packet(i)):this.sendBuffer.push(i)),this.flags={},this}_registerAckCallback(e,t){var n,r=this;const i=null!==(n=this.flags.timeout)&&void 0!==n?n:this._opts.ackTimeout;if(void 0===i)return void(this.acks[e]=t);const s=this.io.setTimeoutFn((()=>{delete this.acks[e];for(let t=0;t<this.sendBuffer.length;t++)this.sendBuffer[t].id===e&&this.sendBuffer.splice(t,1);t.call(this,new Error("operation has timed out"))}),i),o=function(){r.io.clearTimeoutFn(s);for(var e=arguments.length,n=new Array(e),i=0;i<e;i++)n[i]=arguments[i];t.apply(r,n)};o.withError=!0,this.acks[e]=o}emitWithAck(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return new Promise(((t,r)=>{const i=(e,n)=>e?r(e):t(n);i.withError=!0,n.push(i),this.emit(e,...n)}))}_addToQueue(e){var t=this;let n;"function"===typeof e[e.length-1]&&(n=e.pop());const r={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((function(e){if(r!==t._queue[0])return;if(null!==e)r.tryCount>t._opts.retries&&(t._queue.shift(),n&&n(e));else if(t._queue.shift(),n){for(var i=arguments.length,s=new Array(i>1?i-1:0),o=1;o<i;o++)s[o-1]=arguments[o];n(null,...s)}return r.pending=!1,t._drainQueue()})),this._queue.push(r),this._drainQueue()}_drainQueue(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.connected||0===this._queue.length)return;const t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){"function"==typeof this.auth?this.auth((e=>{this._sendConnectPacket(e)})):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:rS.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach((e=>{if(!this.sendBuffer.some((t=>String(t.id)===e))){const t=this.acks[e];delete this.acks[e],t.withError&&t.call(this,new Error("socket has been disconnected"))}}))}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case rS.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case rS.EVENT:case rS.BINARY_EVENT:this.onevent(e);break;case rS.ACK:case rS.BINARY_ACK:this.onack(e);break;case rS.DISCONNECT:this.ondisconnect();break;case rS.CONNECT_ERROR:this.destroy();const t=new Error(e.data.message);t.data=e.data.data,this.emitReserved("connect_error",t)}}onevent(e){const t=e.data||[];null!=e.id&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){const t=this._anyListeners.slice();for(const n of t)n.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&"string"===typeof e[e.length-1]&&(this._lastOffset=e[e.length-1])}ack(e){const t=this;let n=!1;return function(){if(!n){n=!0;for(var r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];t.packet({type:rS.ACK,id:e,data:i})}}}onack(e){const t=this.acks[e.id];"function"===typeof t&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach((e=>this.emitEvent(e))),this.receiveBuffer=[],this.sendBuffer.forEach((e=>{this.notifyOutgoingListeners(e),this.packet(e)})),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach((e=>e())),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:rS.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){const t=this._anyListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){const t=this._anyOutgoingListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const t=this._anyOutgoingListeners.slice();for(const n of t)n.apply(this,e.data)}}}function hS(e){e=e||{},this.ms=e.min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=e.jitter>0&&e.jitter<=1?e.jitter:0,this.attempts=0}hS.prototype.duration=function(){var e=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),n=Math.floor(t*this.jitter*e);e=0==(1&Math.floor(10*t))?e-n:e+n}return 0|Math.min(e,this.max)},hS.prototype.reset=function(){this.attempts=0},hS.prototype.setMin=function(e){this.ms=e},hS.prototype.setMax=function(e){this.max=e},hS.prototype.setJitter=function(e){this.jitter=e};class dS extends fb{constructor(t,n){var r;super(),this.nsps={},this.subs=[],t&&"object"===typeof t&&(n=t,t=void 0),(n=n||{}).path=n.path||"/socket.io",this.opts=n,yb(this,n),this.reconnection(!1!==n.reconnection),this.reconnectionAttempts(n.reconnectionAttempts||1/0),this.reconnectionDelay(n.reconnectionDelay||1e3),this.reconnectionDelayMax(n.reconnectionDelayMax||5e3),this.randomizationFactor(null!==(r=n.randomizationFactor)&&void 0!==r?r:.5),this.backoff=new hS({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==n.timeout?2e4:n.timeout),this._readyState="closed",this.uri=t;const i=n.parser||e;this.encoder=new i.Encoder,this.decoder=new i.Decoder,this._autoConnect=!1!==n.autoConnect,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection}reconnectionAttempts(e){return void 0===e?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return void 0===e?this._reconnectionDelay:(this._reconnectionDelay=e,null===(t=this.backoff)||void 0===t||t.setMin(e),this)}randomizationFactor(e){var t;return void 0===e?this._randomizationFactor:(this._randomizationFactor=e,null===(t=this.backoff)||void 0===t||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return void 0===e?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,null===(t=this.backoff)||void 0===t||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new Hb(this.uri,this.opts);const t=this.engine,n=this;this._readyState="opening",this.skipReconnect=!1;const r=cS(t,"open",(function(){n.onopen(),e&&e()})),i=t=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",t),e?e(t):this.maybeReconnectOnOpen()},s=cS(t,"error",i);if(!1!==this._timeout){const e=this._timeout,n=this.setTimeoutFn((()=>{r(),i(new Error("timeout")),t.close()}),e);this.opts.autoUnref&&n.unref(),this.subs.push((()=>{this.clearTimeoutFn(n)}))}return this.subs.push(r),this.subs.push(s),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const e=this.engine;this.subs.push(cS(e,"ping",this.onping.bind(this)),cS(e,"data",this.ondata.bind(this)),cS(e,"error",this.onerror.bind(this)),cS(e,"close",this.onclose.bind(this)),cS(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){Bb((()=>{this.emitReserved("packet",e)}),this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let n=this.nsps[e];return n?this._autoConnect&&!n.active&&n.connect():(n=new uS(this,e,t),this.nsps[e]=n),n}_destroy(e){const t=Object.keys(this.nsps);for(const n of t){if(this.nsps[n].active)return}this._close()}_packet(e){const t=this.encoder.encode(e);for(let n=0;n<t.length;n++)this.engine.write(t[n],e.options)}cleanup(){this.subs.forEach((e=>e())),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close"),this.engine&&this.engine.close()}disconnect(){return this._close()}onclose(e,t){this.cleanup(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const t=this.backoff.duration();this._reconnecting=!0;const n=this.setTimeoutFn((()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),e.skipReconnect||e.open((t=>{t?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",t)):e.onreconnect()})))}),t);this.opts.autoUnref&&n.unref(),this.subs.push((()=>{this.clearTimeoutFn(n)}))}}onreconnect(){const e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const fS={};function pS(e,t){"object"===typeof e&&(t=e,e=void 0);const n=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=arguments.length>2?arguments[2]:void 0,r=e;n=n||"undefined"!==typeof location&&location,null==e&&(e=n.protocol+"//"+n.host),"string"===typeof e&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?n.protocol+e:n.host+e),/^(https?|wss?):\/\//.test(e)||(e="undefined"!==typeof n?n.protocol+"//"+e:"https://"+e),r=Ub(e)),r.port||(/^(http|ws)$/.test(r.protocol)?r.port="80":/^(http|ws)s$/.test(r.protocol)&&(r.port="443")),r.path=r.path||"/";const i=-1!==r.host.indexOf(":")?"["+r.host+"]":r.host;return r.id=r.protocol+"://"+i+":"+r.port+t,r.href=r.protocol+"://"+i+(n&&n.port===r.port?"":":"+r.port),r}(e,(t=t||{}).path||"/socket.io"),r=n.source,i=n.id,s=n.path,o=fS[i]&&s in fS[i].nsps;let a;return t.forceNew||t["force new connection"]||!1===t.multiplex||o?a=new dS(r,t):(fS[i]||(fS[i]=new dS(r,t)),a=fS[i]),n.query&&!t.query&&(t.query=n.queryKey),a.socket(n.path,t)}Object.assign(pS,{Manager:dS,Socket:uS,io:pS,connect:pS});const mS=50;class gS{get working(){return"working"===this.workingState}get canceled(){return"canceled"===this.workingState}constructor(e,t,n,r,i,s){this.to=t,this.payloadSize=n,this.logger=r,this.requestCallback=i,this.responseCallback=s,this.results=new Map,this.workingState="working",this.requestsInFlight=0,this.endEvent=new Ln,this.requests=0,this.latestRequested=e,this.nextToDeliver=e,this.knewTo=void 0!==t}cancel(){this.working&&(this.workingState="canceled",this.endEvent.resolve())}async run(e){(0,i.v)(e>0,258),(0,i.v)(this.working,259);let t=e;for(;t>0;)t--,this.addRequest();return this.dispatch(),this.endEvent.promise}done(){(0,i.v)(void 0!==this.to,260),(0,i.v)(this.nextToDeliver>=this.to,261),this.working&&(this.workingState="done",this.endEvent.resolve())}fail(e){this.working&&(this.workingState="done",this.endEvent.reject(e))}dispatch(){for(;this.working;){const e=this.results.get(this.nextToDeliver);if(void 0===e)break;this.results.delete(this.nextToDeliver),(0,i.v)(e.length<=this.payloadSize,473),this.nextToDeliver+=e.length,this.responseCallback(e)}this.working&&(0===this.requestsInFlight?((0,i.v)(0===this.results.size,263),this.done()):void 0!==this.to&&this.nextToDeliver>=this.to&&((0,i.v)(!this.knewTo,264),this.done()))}getNextChunk(){if(!this.working)return;const e=this.latestRequested;return void 0!==this.to&&this.to<=e?void 0:(this.latestRequested+=this.payloadSize,void 0!==this.to&&(this.latestRequested=Math.min(this.to,this.latestRequested)),(0,i.v)(e<this.latestRequested,265),{from:e,to:this.latestRequested})}addRequest(){const e=this.getNextChunk();void 0!==e&&this.addRequestCore(e.from,e.to).catch(this.fail.bind(this))}async addRequestCore(e,t){(0,i.v)(this.working,266);let n=e,r=t;for(this.requestsInFlight++;this.working;){const e=r-n;(0,i.v)(e>0,267),void 0!==this.to&&((0,i.v)(n<this.to,268),(0,i.v)(r<=this.to,269)),this.requests++;const t=this.requestCallback(this.requests,n,r,void 0!==this.to,{});this.dispatch();const{payload:s,cancel:o,partial:a}=await t;if(o&&this.cancel(),void 0!==this.to&&n>=this.to){(0,i.v)(!this.knewTo,270),0!==s.length&&this.logger.sendErrorEvent({eventName:"ParallelRequests_GotExtra",from:n,to:r,end:this.to,length:s.length});break}if(this.working){const t=n,o=s.length;let c=e<=o;if(0!==o){e<o&&this.logger.sendTelemetryEvent({eventName:"ParallelRequests_Over",from:n,to:r,length:o});const t=s.splice(0,e);this.results.set(n,t),n+=t.length}else(0,i.v)(!a,271),(0,i.v)(!this.knewTo,272);if(!a&&!c){if(!this.knewTo){(void 0===this.to||this.to>n)&&(this.to=n);break}this.logger.sendPerformanceEvent({eventName:"ParallelRequests_Partial",from:t,to:r,length:o})}if(r===this.latestRequested){for(;0!==s.length;){const t=s.splice(0,e);this.results.set(n,t),n+=t.length}this.latestRequested=n,c=!0}if(c){const e=this.getNextChunk();if(void 0===e)break;n=e.from,r=e.to}}}this.requestsInFlight--,this.dispatch()}}class vS{constructor(){this.queue=[],this.done=!1}pushValue(e){this.pushCore(Promise.resolve({done:!1,value:e}))}pushError(e){this.pushCore(Promise.reject(e)),this.done=!0}pushDone(){this.pushCore(Promise.resolve({done:!0})),this.done=!0}pushCore(e){(0,i.v)(!this.done,274),this.deferred?((0,i.v)(0===this.queue.length,275),this.deferred.resolve(e),this.deferred=void 0):this.queue.push(e)}async read(){(0,i.v)(void 0===this.deferred,276);const e=this.queue.shift();return void 0!==e?e:((0,i.v)(!this.done,277),this.deferred=new Ln,this.deferred.promise)}}const yS=async()=>{var e;if(!1===(null===(e=globalThis.navigator)||void 0===e?void 0:e.onLine)&&void 0!==globalThis.addEventListener)return new Promise((e=>{const t=()=>{e(),globalThis.removeEventListener("online",t)};globalThis.addEventListener("online",t)}))};function bS(e,t,n,r,s,o,a,c){let l,u=0,h=0;const d=new vS,f={fromTotal:n,toTotal:r},p=Xt.Bt.start(o,{eventName:"GetDeltas",...f,reason:c}),m=new gS(n,r,s,o,(async(t,n,r,i,s)=>(u++,async function(e,t,n,r,i,s){let o,a,c=0,l=0,u=0,h=mS;for(;!0!==(null===i||void 0===i?void 0:i.aborted);){let i;l++;const p=en.F.now();try{const{messages:r,partialResult:i}=await e({...t,retry:l});var d;if(0!==r.length||!n)return null===(d=a)||void 0===d||d.end({duration:c,...t,reason:s}),{payload:r,cancel:!1,partial:i};if(void 0===o)o=en.F.now();else if(en.F.now()-o>3e4)throw Xn("Failed to retrieve ops from storage (Too Many Retries)",{canRetry:!1},{retry:l,driverVersion:nr,...t})}catch(f){i=f;const e=Yn(f),n=tr(f);if(ly(r,{eventName:"GetDeltas_Error",...t,retry:l,duration:en.F.now()-p,retryAfter:n,reason:s},f),!e)throw f}void 0===a&&(u=en.F.now(),a=Xt.Bt.start(r,{eventName:"GetDeltasWaitTime"})),h=or(h,i),await new Promise((e=>{setTimeout(e,h)})),await yS(),c+=en.F.now()-u}return{partial:!1,cancel:!0,payload:[]}}((async t=>e(n,r,t)),{request:t,from:n,to:r,...f,...s},i,o,a,c))),(e=>{void 0===l?(0,i.v)(e[0].sequenceNumber===n,621):(0,i.v)(e[0].sequenceNumber===l+1,622),l=e[e.length-1].sequenceNumber,(0,i.v)(l-e[0].sequenceNumber+1===e.length,623),h+=e.length,d.pushValue(e)})),g=e=>{m.cancel()};return void 0!==a&&a.addEventListener("abort",g),m.run(t).finally((()=>{void 0!==a&&a.removeEventListener("abort",g)})).then((()=>{const e={lastFetch:l,length:h,requests:u};m.canceled?p.cancel({...e,error:"ops request cancelled by client"}):((0,i.v)(void 0===r||void 0!==l&&l>=r-1,624),p.end(e)),d.pushDone()})).catch((e=>{p.cancel({lastFetch:l,length:h,requests:u},e),d.pushError(e)})),d}const SS={read:async()=>({done:!0})};class wS{constructor(e,t,n,r,i){this.tenantId=e,this.id=t,this.deltaStorageService=n,this.documentStorageService=r,this.logger=i,this.logtailSha=this.documentStorageService.logTailSha}fetchMessages(e,t,n,r,i){if(r)return SS;let s=0,o=0;const a=async(e,t,n)=>{if(this.snapshotOps=this.logtailSha?await vn(this.documentStorageService,this.logtailSha):[],this.logtailSha=void 0,void 0!==this.snapshotOps&&0!==this.snapshotOps.length){const n=this.snapshotOps.filter((n=>n.sequenceNumber>=e&&n.sequenceNumber<t));if(qy("snapshotOps",n,e,this.logger,!1),n.length>0&&n[0].sequenceNumber===e)return this.snapshotOps=this.snapshotOps.filter((e=>e.sequenceNumber>=t)),s+=n.length,{messages:n,partialResult:!0};this.snapshotOps=void 0}const r=await this.deltaStorageService.get(this.tenantId,this.id,e,t);return qy("storage",r.messages,e,this.logger,!1),o+=r.messages.length,r};return function(e,t){return{read:async()=>{const n=await e.read();return t(n),n}}}(bS((async(e,t,n)=>{const r=await a(e,t);return qy("catch all",r.messages,e,this.logger),r}),1,e,t,2e3,this.logger,n,i),(e=>{e.done&&s+o!==0&&this.logger.sendPerformanceEvent({eventName:"CacheOpsRetrieved",opsFromSnapshot:s,opsFromStorage:o})}))}}class CS{constructor(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:async()=>this.restWrapper,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:()=>this.url;this.url=e,this.restWrapper=t,this.logger=n,this.getRestWrapper=r,this.getDeltaStorageUrl=i}async get(e,t,n,r){const i=await Xt.Bt.timedExecAsync(this.logger,{eventName:"OpsFetch",from:n,to:r},(async e=>{var t,i;const s=await this.getRestWrapper(),o=this.getDeltaStorageUrl(),a=await s.get(o,{from:n-1,to:r});return e.end({length:a.content.length,details:JSON.stringify({firstOpSeqNumber:null===(t=a.content[0])||void 0===t?void 0:t.sequenceNumber,lastOpSeqNumber:null===(i=a.content[a.content.length-1])||void 0===i?void 0:i.sequenceNumber}),...a.propsToLog,...Ly(a.requestUrl,"xmlhttprequest")}),a.content}));return{messages:i,partialResult:!1}}}class xS extends gi{constructor(){super(...arguments),this.prefetchCache=new Map,this.prefetchEnabled=!0}get policies(){const e=this.internalStorageService.policies;if(e)return{...e,caching:dn.NoCaching}}async getSnapshotTree(e){const t=this.internalStorageService.getSnapshotTree(e);return this.prefetchEnabled&&t.then((e=>{null!==e&&void 0!==e&&this.prefetchTree(e)})),t}async readBlob(e){return this.cachedRead(e)}stopPrefetch(){this.prefetchEnabled=!1,this.prefetchCache.clear()}async cachedRead(e){if(this.prefetchEnabled){const t=this.prefetchCache.get(e);if(void 0!==t)return t;const n=this.internalStorageService.readBlob(e);return this.prefetchCache.set(e,n.catch((t=>{throw Yn(t)&&this.prefetchCache.delete(e),t}))),n}return this.internalStorageService.readBlob(e)}prefetchTree(e){const t=[];this.prefetchTreeCore(e,t);for(const n of t)this.cachedRead(n)}prefetchTreeCore(e,t){for(const n of Object.keys(e.blobs)){const r=e.blobs[n];n.startsWith(".")||"header"===n||n.startsWith("quorum")?null!==r&&this.cachedRead(r):n.startsWith("deltas")||null!==r&&t.push(r)}for(const n of Object.keys(e.trees))this.prefetchTreeCore(e.trees[n],t)}}class ES extends Map{constructor(e){super(),this.expiryMs=e,this.lastRefreshedTimes=new Map}refresh(e){this.lastRefreshedTimes.set(e,(new Date).valueOf())}checkExpiry(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=this.lastRefreshedTimes.get(e);if((0,i.v)(void 0!==n===super.has(e),1292),void 0===n)return;const r=(new Date).valueOf()-n>=this.expiryMs;return r&&t&&this.delete(e),r}clearExpiredEntries(){this.forEach((()=>{}))}get size(){return this.clearExpiredEntries(),super.size}has(e){return this.checkExpiry(e,!0),super.has(e)}get(e){return this.checkExpiry(e,!0),super.get(e)}set(e,t){return this.refresh(e),super.set(e,t)}delete(e){return this.lastRefreshedTimes.delete(e),super.delete(e)}clear(){this.lastRefreshedTimes.clear(),super.clear()}forEach(e,t){const n=[];super.forEach(((r,i,s)=>{!0===this.checkExpiry(i)?n.push(i):e.bind(t)(r,i,s)})),n.forEach((e=>{this.delete(e)}))}entries(){return this.clearExpiredEntries(),super.entries()}keys(){return this.clearExpiredEntries(),super.keys()}values(){return this.clearExpiredEntries(),super.values()}[Symbol.iterator](){return this.clearExpiredEntries(),super[Symbol.iterator]()}valueOf(){return this.clearExpiredEntries(),super.valueOf()}}class TS{constructor(e){this.cache=void 0!==e?new ES(e):new Map}async get(e){return this.cache.get(e)}async put(e,t){this.cache.set(e,t)}}class kS{async get(e){}async put(e,t){}}class NS{constructor(e){this.props=e,this.attachmentCounter=0,this.summaryTree={}}get summary(){var e;return{type:Et.Tree,tree:{...this.summaryTree},unreferenced:null===(e=this.props)||void 0===e?void 0:e.unreferenced}}addBlob(e,t){this.summaryTree[e]={type:Et.Blob,content:t}}addHandle(e,t,n){this.summaryTree[e]={type:Et.Handle,handleType:t,handle:n}}addTree(e,t){this.summaryTree[e]=t}addAttachment(e){this.summaryTree[this.attachmentCounter++]={id:e,type:Et.Attachment}}}function FS(e,t){const n=new NS({unreferenced:e.unreferenced});for(const[r,s]of Object.entries(e.blobs)){const e=t.get(s);(0,i.v)(void 0!==e,733),n.addBlob(r,Ne.Ss.from(e).toString("utf-8"))}for(const[r,i]of Object.entries(e.trees)){const e=FS(i,t);n.addTree(r,e)}return n.summary}function IS(e){const t=AS(e.snapshotTree),n=e.blobs.size;let r=0;for(const[i,s]of e.blobs)r+=s.byteLength;return{trees:t,numBlobs:n,encodedBlobsSize:r}}function AS(e){let t=0;for(const[n,r]of Object.entries(e.trees))t+=1+AS(r);return t}class DS{constructor(e){this.manager=e}async writeSummaryTree(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];const s=await this.writeSummaryTreeCore(t,e,n,r,i);if(!s)throw new Error("Failed to write summary tree");return s}async writeSummaryTreeCore(e,t,n,r,i){var s;const o={entries:null!==(s=Ky(e,t,"","channel"===n?".app":"").entries)&&void 0!==s?s:[],message:"",sequenceNumber:r,type:n};return this.manager.createSummary(o,i).then((e=>e.content.id))}}function OS(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:".app";const r=new Map;e.blobs&&e.blobs.forEach((e=>{var t;r.set(e.id,(0,Ne.Xg)(e.content,null!==(t=e.encoding)&&void 0!==t?t:"utf-8"))}));const i=null===(t=e.trees)||void 0===t?void 0:t[0],s=null===i||void 0===i?void 0:i.sequenceNumber,o=function(e,t){const n={},r={id:e.id,blobs:{},trees:{}};n[""]=r;for(const i of e.entries){const e=i.path.replace(new RegExp("^".concat(t,"/")),""),r=e.lastIndexOf("/"),s=e.slice(0,Math.max(0,r)),o=e.slice(r+1),a=n[s];if("tree"===i.type){const t={blobs:{},trees:{},unreferenced:i.unreferenced};a.trees[decodeURIComponent(o)]=t,n[e]=t}else{if("blob"!==i.type)throw new Error("Unknown entry type!!");a.blobs[decodeURIComponent(o)]=i.id}}return r}(i,n);return{blobs:r,snapshotTree:o,sequenceNumber:s,id:e.id}}const PS="latest";class RS{async getSummaryUploadManager(){const e=await this.getStorageManager();return new DS(e)}constructor(e,t,n,r,i){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:new TS,o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:new TS,a=arguments.length>7?arguments[7]:void 0,c=arguments.length>8&&void 0!==arguments[8]?arguments[8]:async e=>e&&void 0!==this.noCacheGitManager?this.noCacheGitManager:this.manager;this.id=e,this.manager=t,this.logger=n,this.policies=r,this.driverPolicies=i,this.blobCache=s,this.snapshotTreeCache=o,this.noCacheGitManager=a,this.getStorageManager=c,this.firstVersionsCall=!0,this.repositoryUrl="",this.mc=(0,Yt.CL)({logger:n})}async getVersions(e,t){if(e!==this.id&&null!==e)return[{id:e,treeId:void 0}];if(this.firstVersionsCall&&1===t){var n;const r=await Xt.Bt.timedExecAsync(this.logger,{eventName:"ObtainSnapshot",versionId:null!==e&&void 0!==e?e:void 0,count:t,enableDiscovery:null===(n=this.driverPolicies)||void 0===n?void 0:n.enableDiscovery},(async e=>{var t;let n;const r=this.snapshotTreeCache.get(this.getCacheKey(PS)),i=null!==(t=this.driverPolicies)&&void 0!==t&&t.enableDiscovery?this.fetchSnapshotTree(PS,!0,"getVersions"):this.fetchSnapshotTree(PS,!1,"getVersions"),s=await async function(e){return new Promise(((t,n)=>{e.forEach(((e,r)=>{e.then((e=>t({index:r,value:e}))).catch(n)}))}))}([r.catch((()=>{})),i.catch((()=>{}))]);let o=s.value;return n=0===s.index?"cache":"network",void 0===o&&(1===s.index&&(o=await r,n="cache"),void 0===o&&(o=await i,n="network")),e.end({method:n}),o})),i=await this.initializeFromSnapshot(r);return this.firstVersionsCall=!1,[{id:i,treeId:r.snapshotTree.id}]}const r=e||this.id;return(await Xt.Bt.timedExecAsync(this.logger,{eventName:"getVersions",versionId:r,count:t},(async()=>{const e=await this.getStorageManager();return(await e.getCommits(r,t)).content}))).map((e=>({date:e.commit.author.date,id:e.sha,treeId:e.commit.tree.sha})))}async getSnapshotTree(e){let t=e;if(!t){const e=await this.getVersions(this.id,1);if(0===e.length)return null;t=e[0]}let n=await this.snapshotTreeCache.get(this.getCacheKey(t.id));return void 0!==n||(n=await this.fetchSnapshotTree(t.id,void 0,"getSnapshotTree"),await this.updateBlobsCache(n.blobs)),n.snapshotTree}async readBlob(e){const t=await this.blobCache.get(this.getCacheKey(e));if(void 0!==t)return t;const n=await Xt.Bt.timedExecAsync(this.logger,{eventName:"readBlob",blobId:e},(async t=>{const n=await this.getStorageManager(),r=(await n.getBlob(e)).content;return t.end({size:r.size}),r}),void 0,void 0,this.mc.config.getNumber("Fluid.Driver.ReadBlobTelemetrySampling")),r=(0,Ne.Xg)(n.content,n.encoding);return await this.blobCache.put(this.getCacheKey(n.sha),r),r}async uploadSummaryWithContext(e,t){return await Xt.Bt.timedExecAsync(this.logger,{eventName:"uploadSummaryWithContext",proposalHandle:t.proposalHandle,ackHandle:t.ackHandle,referenceSequenceNumber:t.referenceSequenceNumber},(async()=>{var n;return(await this.getSummaryUploadManager()).writeSummaryTree(e,null!==(n=t.ackHandle)&&void 0!==n?n:"","channel")}))}async downloadSummary(e){const t=await Xt.Bt.timedExecAsync(this.logger,{eventName:"getWholeFlatSummary",treeId:e.handle},(async t=>{var n;const r=await this.getStorageManager(),i=await r.getSnapshot(e.handle);return t.end({size:null===(n=i.content.trees[0])||void 0===n?void 0:n.entries.length}),i.content})),{blobs:n,snapshotTree:r}=OS(t,"");return FS(r,n)}async createBlob(e){const t=new Uint8Array(e);return Xt.Bt.timedExecAsync(this.logger,{eventName:"createBlob",size:t.length},(async e=>{const n=await this.getStorageManager(),r=await n.createBlob((0,Ne.Km)(t,"base64"),"base64").then((e=>({id:e.content.sha,url:e.content.url})));return e.end({blobId:r.id}),r}))}async fetchSnapshotTree(e,t,n){const r=await Xt.Bt.timedExecAsync(this.logger,{eventName:"getWholeFlatSummary",treeId:e,scenarioName:n},(async n=>{var r;const s=await this.getStorageManager(t),o=await s.getSnapshot(e),a=en.F.now(),c=OS(o.content),l=en.F.now()-a;!function(e){(0,i.v)(void 0!==e.trees,1488),(0,i.v)(void 0!==e.blobs,1489)}(c.snapshotTree);const{trees:u,numBlobs:h,encodedBlobsSize:d}=IS(c);return n.end({size:null===(r=o.content.trees[0])||void 0===r?void 0:r.entries.length,trees:u,blobs:h,encodedBlobsSize:d,sequenceNumber:c.sequenceNumber,...o.propsToLog,snapshotConversionTime:l,...Ly(o.requestUrl,"xmlhttprequest")}),c}));return await this.snapshotTreeCache.put(this.getCacheKey(e),r).catch((()=>{})),r}async initializeFromSnapshot(e){const t=e.id;(0,i.v)(void 0!==t,629);const n=[this.snapshotTreeCache.put(this.getCacheKey(t),e),this.updateBlobsCache(e.blobs)];return await Promise.all(n),t}async updateBlobsCache(e){const t=[];e.forEach(((e,n)=>{const r=this.getCacheKey(n);t.push(this.blobCache.put(r,e))})),await Promise.all(t)}getCacheKey(e){return"".concat(this.id,":").concat(e)}}class MS{constructor(e,t){this.internalGitManager=e,this.logger=t}async getCommits(e,t){return this.runWithRetry((async()=>this.internalGitManager.getCommits(e,t)),"gitManager_getCommits")}async getTree(e,t){return this.runWithRetry((async()=>this.internalGitManager.getTree(e,t)),"gitManager_getTree")}async getBlob(e){return this.runWithRetry((async()=>this.internalGitManager.getBlob(e)),"gitManager_getBlob")}async createBlob(e,t){return this.runWithRetry((async()=>this.internalGitManager.createBlob(e,t)),"gitManager_createBlob")}async createGitTree(e){return this.runWithRetry((async()=>this.internalGitManager.createGitTree(e)),"gitManager_createGitTree")}async createSummary(e){return this.runWithRetry((async()=>this.internalGitManager.createSummary(e)),"gitManager_createSummary")}async getSnapshot(e){return this.runWithRetry((async()=>this.internalGitManager.getSnapshot(e)),"gitManager_getSummary")}async runWithRetry(e,t){return rr(e,t,this.logger,{})}}async function BS(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"SHA-1",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"hex";if(void 0===crypto.subtle)return n.e(106).then(n.bind(n,5106)).then((async n=>n.hashFile(e,t,r)));const i=await async function(e,t){const n=await crypto.subtle.digest(t,e);return new Uint8Array(n)}(e,t);return function(e,t){switch(t){case"hex":return Array.prototype.map.call(e,(e=>e.toString(16).padStart(2,"0"))).join("");case"base64":return jy.fromByteArray(e)}}(i,r)}class LS{constructor(e,t,n){this.manager=e,this.blobsShaCache=t,this.getPreviousFullSnapshot=n}async writeSummaryTree(e,t,n,r,i){const s=await this.getPreviousFullSnapshot(t);return this.writeSummaryTreeCore(e,null!==s&&void 0!==s?s:void 0)}async writeSummaryTreeCore(e,t){const n=await Promise.all(Object.keys(e.tree).map((async n=>{const r=e.tree[n],i=await this.writeSummaryTreeObject(r,t);return{mode:pr(r),path:encodeURIComponent(n),sha:i,type:mr(r)}})));return(await this.manager.createGitTree({tree:n})).content.sha}async writeSummaryTreeObject(e,t){switch(e.type){case Et.Blob:return this.writeSummaryBlob(e.content);case Et.Handle:if(void 0===t)throw Error("Parent summary does not exist to reference by handle.");return this.getIdFromPath(e.handleType,e.handle,t);case Et.Tree:return this.writeSummaryTreeCore(e,t);case Et.Attachment:return e.id;default:wt(e,"Unknown type: ".concat(e.type))}}async writeSummaryBlob(e){const{parsedContent:t,encoding:n}="string"===typeof e?{parsedContent:e,encoding:"utf-8"}:{parsedContent:(0,Ne.Km)(e,"base64"),encoding:"base64"},r=await async function(e){const t=e.byteLength,n="blob ".concat(t.toString()).concat(String.fromCharCode(0));return BS(Ne.Ss.from(n+e.toString()))}(Ne.Ss.from(t,n));if(!this.blobsShaCache.has(r)){this.blobsShaCache.set(r,"");const e=(await this.manager.createBlob(t,n)).content;(0,i.v)(r===e.sha,182)}return r}getIdFromPath(e,t,n){const r=t.split("/").map((e=>decodeURIComponent(e)));return""===r[0]&&r.shift(),0===r.length?n.id:this.getIdFromPathCore(e,r,n)}getIdFromPathCore(e,t,n){(0,i.v)(t.length>0,179);const r=t[0];if(1===t.length)switch(e){case Et.Blob:{const e=n.blobs[r];return(0,i.v)(!!e,180),e}case Et.Tree:{var s;const e=null===(s=n.trees[r])||void 0===s?void 0:s.id;return(0,i.v)(!!e,181),e}default:throw Error('Unexpected handle summary object type: "'.concat(e,'".'))}return this.getIdFromPathCore(e,t.slice(1),n.trees[r])}}const qS="undefined"===typeof window;class _S{async getSummaryUploadManager(){const e=await this.getStorageManager();return new LS(new MS(e,this.logger),this.blobsShaCache,this.getPreviousFullSnapshot.bind(this))}constructor(e,t,n,r,i,s,o){let a=arguments.length>7&&void 0!==arguments[7]?arguments[7]:async()=>this.manager;this.id=e,this.manager=t,this.logger=n,this.policies=r,this.getStorageManager=a,this.blobsShaCache=new Map,this.repositoryUrl="",(!0===(null===i||void 0===i?void 0:i.enableRestLess)||qS)&&(this.blobCache=null!==s&&void 0!==s?s:new TS,this.snapshotTreeCache=null!==o&&void 0!==o?o:new TS),this.mc=(0,Yt.CL)({logger:n})}async getVersions(e,t){const n=e||this.id;return(await Xt.Bt.timedExecAsync(this.logger,{eventName:"getVersions",versionId:n,count:t},(async()=>{const e=await this.getStorageManager();return(await e.getCommits(n,t)).content}))).map((e=>({date:e.commit.author.date,id:e.sha,treeId:e.commit.tree.sha})))}async getSnapshotTree(e){var t,n;let r=e;if(!r){const e=await this.getVersions(this.id,1);if(0===e.length)return null;r=e[0]}const i=await(null===(t=this.snapshotTreeCache)||void 0===t?void 0:t.get(this.getCacheKey(r.treeId)));if(i)return i.snapshotTree;const s=gr(await Xt.Bt.timedExecAsync(this.logger,{eventName:"getSnapshotTree",treeId:r.treeId},(async e=>{const t=await this.getStorageManager(),n=(await t.getTree(r.treeId)).content;return e.end({size:n.tree.length}),n})),this.blobsShaCache,!0);return await(null===(n=this.snapshotTreeCache)||void 0===n?void 0:n.put(this.getCacheKey(s.id),{id:r.id,snapshotTree:s})),s}async readBlob(e){var t,n;const r=await(null===(t=this.blobCache)||void 0===t?void 0:t.get(this.getCacheKey(e)));if(r)return r;const i=await Xt.Bt.timedExecAsync(this.logger,{eventName:"readBlob",blobId:e},(async t=>{const n=await this.getStorageManager(),r=(await n.getBlob(e)).content;return t.end({size:r.size}),r}),void 0,void 0,this.mc.config.getNumber("Fluid.Driver.ReadBlobTelemetrySampling"));this.blobsShaCache.set(i.sha,"");const s=(0,Ne.Xg)(i.content,i.encoding);return await(null===(n=this.blobCache)||void 0===n?void 0:n.put(this.getCacheKey(i.sha),s)),s}async uploadSummaryWithContext(e,t){return await Xt.Bt.timedExecAsync(this.logger,{eventName:"uploadSummaryWithContext",proposalHandle:t.proposalHandle,ackHandle:t.ackHandle,referenceSequenceNumber:t.referenceSequenceNumber},(async()=>{var n;return(await this.getSummaryUploadManager()).writeSummaryTree(e,null!==(n=t.ackHandle)&&void 0!==n?n:"","channel")}))}async downloadSummary(e){throw new Error("NOT IMPLEMENTED!")}async createBlob(e){const t=new Uint8Array(e);return Xt.Bt.timedExecAsync(this.logger,{eventName:"createBlob",size:t.length},(async e=>{const n=await this.getStorageManager(),r=await n.createBlob((0,Ne.Km)(t,"base64"),"base64").then((e=>({id:e.content.sha,url:e.content.url})));return e.end({blobId:r.id}),r}))}async getPreviousFullSnapshot(e){return e?this.getVersions(e,1).then((async e=>(this.blobsShaCache.clear(),this.getSnapshotTree(e[0])))):void 0}getCacheKey(e){return"".concat(this.id,":").concat(e)}}class jS extends gi{get logTailSha(){return this._logTailSha}static loadInternalDocumentStorageService(e,t,n,r,i,s,o,a,c,l){const u=null!==i&&void 0!==i&&i.enableWholeSummaryUpload?new RS(e,t,n,r,i,s,o,c,l):new _S(e,t,n,r,i,s,a,l);return null!==i&&void 0!==i&&i.enableWholeSummaryUpload||r.caching!==dn.Prefetch?u:new xS(u)}constructor(e,t,n,r,i,s,o,a,c,l){super(jS.loadInternalDocumentStorageService(e,t,n,r,i,s,o,a,c,l)),this.id=e,this.manager=t,this.noCacheGitManager=c,this._logTailSha=void 0}async getSnapshotTree(e){const t=await this.internalStorageService.getSnapshotTree(e);return null!==t&&(this._logTailSha=".logTail"in t.trees?t.trees[".logTail"].blobs.logTail:void 0),t}}const zS="2.0.0-rc.1.0.8";class US extends $t{get hasDetails(){return!!this._details}get disposed(){return(0,i.v)(this._disposed||this.socket.connected,580),this._disposed}get logger(){return this.mc.logger}get details(){if(!this._details)throw new Error("Internal error: calling method before _details is initialized!");return this._details}constructor(e,t,n){var r;let s=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4?arguments[4]:void 0;super(((e,t)=>{this.addPropsToError(t),n.sendErrorEvent({eventName:"DeltaConnection:EventException",name:e},t)})),r=this,this.socket=e,this.documentId=t,this.enableLongPollingDowngrades=s,this.connectionId=o,this.queuedMessages=[],this.queuedSignals=[],this.earlyOpHandlerAttached=!1,this.connectionListeners=new Map,this.trackedListeners=new Map,this._disposed=!1,this.earlyOpHandler=(e,t)=>{this.queuedMessages.push(...t)},this.earlySignalHandler=e=>{Array.isArray(e)?this.queuedSignals.push(...e):this.queuedSignals.push(e)},this.mc=(0,Yt.CL)({logger:n,namespace:"DeltaConnection"}),this.on("newListener",((e,t)=>{if((0,i.v)(!this.disposed,522),US.eventsAlwaysForwarded.includes(e))(0,i.v)(this.trackedListeners.has(e),581);else{if(!US.eventsToForward.includes(e))throw new Error("DocumentDeltaConnection: Registering for unknown event: ".concat(e));if((0,i.v)(0!==this.listeners(e).length===this.trackedListeners.has(e),523),!this.trackedListeners.has(e))if("pong"===e){this.trackedListeners.set("pong",(()=>{}));const e=()=>{var t;const n=Date.now();null===(t=this.socket.volatile)||void 0===t||t.emit("ping",(()=>{this.emit("pong",Date.now()-n),this.trackLatencyTimeout=setTimeout((()=>{e()}),6e4)}))};e()}else this.addTrackedListener(e,(function(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];r.emit(e,...n)}))}}))}get clientId(){return this.details.clientId}get mode(){return this.details.mode}get claims(){return this.details.claims}get existing(){return this.details.existing}get maxMessageSize(){return this.details.serviceConfiguration.maxMessageSize}get version(){return this.details.version}get serviceConfiguration(){return this.details.serviceConfiguration}checkNotDisposed(){(0,i.v)(!this.disposed,524)}get initialMessages(){return this.checkNotDisposed(),(0,i.v)(this.earlyOpHandlerAttached,142),(0,i.v)(0!==this.listeners("op").length,143),this.removeEarlyOpHandler(),this.queuedMessages.length>0&&(this.details.initialMessages.push(...this.queuedMessages),this.details.initialMessages.sort(((e,t)=>e.sequenceNumber-t.sequenceNumber)),this.queuedMessages.length=0),this.details.initialMessages}get initialSignals(){return this.checkNotDisposed(),(0,i.v)(0!==this.listeners("signal").length,144),this.removeEarlySignalHandler(),this.queuedSignals.length>0&&(this.details.initialSignals.push(...this.queuedSignals),this.queuedSignals.length=0),this.details.initialSignals}get initialClients(){return this.checkNotDisposed(),this.details.initialClients}emitMessages(e,t){this.disposed||this.socket.emit(e,this.clientId,t)}submit(e){this.checkNotDisposed(),this.emitMessages("submitOp",[e])}submitSignal(e,t){var n;if(this.checkNotDisposed(),t&&!0!==(null===(n=this.details.supportedFeatures)||void 0===n?void 0:n.submit_signals_v2))throw new Bv("Sending signals to specific client ids is not supported.");this.emitMessages("submitSignal",[[e]])}closeSocket(e){this._disposed||this.closeSocketCore(e)}closeSocketCore(e){this.disconnect(e)}dispose(){this.logger.sendTelemetryEvent({eventName:"ClientClosingDeltaConnection",driverVersion:zS,details:JSON.stringify({...this.getConnectionDetailsProps()})}),this.disconnect(Xn("Client closing delta connection",{canRetry:!0},{driverVersion:zS}))}disconnect(e){this._disposed||(void 0!==this.trackLatencyTimeout&&(clearTimeout(this.trackLatencyTimeout),this.trackLatencyTimeout=void 0),this._disposed=!0,this.removeTrackedListeners(),this.disconnectCore(),this.emit("disconnect",e))}disconnectCore(){this.socket.disconnect()}async initialize(e,t){this.socket.on("op",this.earlyOpHandler),this.socket.on("signal",this.earlySignalHandler),this.earlyOpHandlerAttached=!0;let n=0;const r=()=>this.socket.io.reconnection(),s=()=>r()?this.socket.io.reconnectionAttempts():0;this._details=await new Promise(((i,o)=>{const a=e=>{try{this.closeSocket(e)}catch(t){const e=this.addPropsToError(t);this.logger.sendErrorEvent({eventName:"CloseSocketError"},e)}o(e)},c=e=>{try{this.disconnect(e)}catch(t){const e=this.addPropsToError(t);this.logger.sendErrorEvent({eventName:"FailConnectionError"},e)}o(e)};this.socketConnectionTimeout=setTimeout((()=>{c(this.createErrorObject("orderingServiceHandshakeTimeout"))}),t+2e3),this.addConnectionListener("connect_error",(e=>{var t;n++;let i=!1;try{const t=null===e||void 0===e?void 0:e.description,n=null===e||void 0===e?void 0:e.context;if(n&&"object"===typeof n){var o;if("DEPTH_ZERO_SELF_SIGNED_CERT"===(null===(o=n.statusText)||void 0===o?void 0:o.code))return void a(this.createErrorObject("connect_error",e,!1))}else if(t&&"object"===typeof t){var c;if("DEPTH_ZERO_SELF_SIGNED_CERT"===(null===(c=t.error)||void 0===c?void 0:c.code))return void a(this.createErrorObject("connect_error",e,!1));"TransportError"===e.type&&(i=!0),t.target=void 0}}catch(l){}i&&this.enableLongPollingDowngrades&&"polling"!==(null===(t=this.socket.io.opts.transports)||void 0===t?void 0:t[0])&&(this.socket.io.opts.transports=["polling","websocket"],r()||(this.socket.io.reconnection(!0),this.socket.io.reconnectionAttempts(1))),r()&&n<s()+1||a(this.createErrorObject("connect_error",e))})),this.addConnectionListener("connect_timeout",(()=>{a(this.createErrorObject("connect_timeout"))})),this.addConnectionListener("connect_document_success",(t=>{if(void 0!==e.nonce&&void 0!==t.nonce&&t.nonce!==e.nonce)return;const n=e.mode,r=t.mode;if(t.claims.scopes.includes(uy.DocWrite)){if(r!==n)return void c(this.createErrorObject("connect_document_success","Connected in a different mode than was requested",!1))}else if("write"===r)return void c(this.createErrorObject("connect_document_success","Connected in write mode without write permissions",!1));this.logger.sendTelemetryEvent({eventName:"ConnectDocumentSuccess",pendingClientId:t.clientId},void 0,Ev.$.verbose),this.checkpointSequenceNumber=t.checkpointSequenceNumber,this.removeConnectionListeners(),i(t)})),this.addTrackedListener("disconnect",((e,t)=>{var n,r;a(this.createErrorObjectWithProps("disconnect",e,{socketErrorType:null===t||void 0===t||null===(n=t.context)||void 0===n?void 0:n.type,socketCode:null===t||void 0===t||null===(r=t.context)||void 0===r?void 0:r.code}))})),this.addTrackedListener("error",(e=>{const t=this.createErrorObject("error",e,"Invalid namespace"!==e);a(t)})),this.addConnectionListener("connect_document_error",(t=>{void 0!==e.nonce&&void 0!==t.nonce&&t.nonce!==e.nonce||c(this.createErrorObject("connect_document_error",t))})),this.socket.emit("connect_document",e)})),(0,i.v)(!this.disposed,582)}addPropsToError(e){return(0,o.cQ)(e,{props:{details:JSON.stringify({...this.getConnectionDetailsProps()})}})}getConnectionDetailsProps(){var e,t;return{disposed:this._disposed,socketConnected:null===(e=this.socket)||void 0===e?void 0:e.connected,clientId:null===(t=this._details)||void 0===t?void 0:t.clientId,connectionId:this.connectionId}}removeEarlyOpHandler(){this.socket.removeListener("op",this.earlyOpHandler),this.earlyOpHandlerAttached=!1}removeEarlySignalHandler(){this.socket.removeListener("signal",this.earlySignalHandler)}addConnectionListener(e,t){(0,i.v)(!US.eventsAlwaysForwarded.includes(e),583),(0,i.v)(!US.eventsToForward.includes(e),584),this.socket.on(e,t),(0,i.v)(!this.connectionListeners.has(e),525),this.connectionListeners.set(e,t)}addTrackedListener(e,t){this.socket.on(e,t),(0,i.v)(!this.trackedListeners.has(e),526),this.trackedListeners.set(e,t)}removeTrackedListeners(){for(const[e,t]of this.trackedListeners.entries())this.socket.off(e,t);this.removeConnectionListeners(),this.removeEarlyOpHandler(),this.removeEarlySignalHandler(),this.trackedListeners.clear()}removeConnectionListeners(){void 0!==this.socketConnectionTimeout&&clearTimeout(this.socketConnectionTimeout);for(const[e,t]of this.connectionListeners.entries())this.socket.off(e,t);this.connectionListeners.clear()}getErrorMessage(e){if("TransportError"!==(null===e||void 0===e?void 0:e.type))return(0,o.AV)(e,!0).message;const t=void 0!==(null===e||void 0===e?void 0:e.message)?"".concat(e.message,": "):"";return"".concat(t).concat(JSON.stringify(e,(0,o.OQ)()))}createErrorObjectWithProps(e,t,n){let r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return Xn("socket.io (".concat(e,"): ").concat(this.getErrorMessage(t)),{canRetry:r},{...n,driverVersion:zS,details:JSON.stringify({...this.getConnectionDetailsProps()})})}createErrorObject(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return Xn("socket.io (".concat(e,"): ").concat(this.getErrorMessage(t)),{canRetry:n},{driverVersion:zS,details:JSON.stringify({...this.getConnectionDetailsProps()})})}}US.eventsToForward=["nack","op","signal","pong"],US.eventsAlwaysForwarded=["disconnect","error"];const HS="2.0.0-rc.1.0.8",VS={...Un,sslCertError:"sslCertError"};var KS;function GS(e,t,n){let r;const i={statusCode:t,driverVersion:HS};switch(t){case 401:case 403:r=new Jn(e,void 0,void 0,i);break;case 404:const t=KS.fileNotFoundOrAccessDeniedError;r=new $n(e,t,i);break;case 429:r=Xn(e,{canRetry:!0,retryAfterMs:n},i);break;case 500:case 502:r=new Gn(e,!0,i);break;default:r=Xn(e,{canRetry:void 0!==n,retryAfterMs:n},i)}return r.addTelemetryProperties({endpointReached:!0}),r}!function(e){e.fileNotFoundOrAccessDeniedError="fileNotFoundOrAccessDeniedError",e.sslCertError="sslCertError"}(KS||(KS={}));const WS=["^0.4.0","^0.3.0","^0.2.0","^0.1.0"];class JS extends US{static async create(e,t,n,r,i,s,o){let a=arguments.length>7&&void 0!==arguments[7]?arguments[7]:2e4,c=!(arguments.length>8&&void 0!==arguments[8])||arguments[8];const l=r(s,{query:{documentId:t,tenantId:e},reconnection:!1,transports:["websocket"],timeout:a}),u={client:i,id:t,mode:i.mode,tenantId:e,token:n,versions:WS,relayUserAgent:[i.details.environment," driverVersion:".concat(HS)].join(";")},h=new JS(l,t,o,c);return await h.initialize(u,a),h}createErrorObject(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return n&&Number.isInteger(null===t||void 0===t?void 0:t.code)&&"string"===typeof(null===t||void 0===t?void 0:t.message)?function(e,t){return GS("R11s socket error (".concat(t,"): ").concat(e.message),e.code,e.retryAfterMs)}(t,e):super.createErrorObject(e,t,n)}}class ZS{get repositoryUrl(){throw new Error("Invalid operation")}async getSnapshotTree(e){return e?Promise.reject(new Error("Invalid operation")):null}async getVersions(e,t){return[]}async uploadSummaryWithContext(e,t){throw new Error("Invalid operation")}async downloadSummary(e){throw new Error("Invalid operation")}async createBlob(e){throw new Error("Null blob storage can not create blob")}async readBlob(e){throw new Error("Null blob storage can not read blob")}}const $S="x-driver-version";var QS;!function(e){e.Method="method",e.Header="header",e.Body="body"}(QS||(QS={}));const XS=(e,t)=>"".concat(e,": ").concat(t);class YS{translate(e){var t,n;const r={...e},i=new URLSearchParams;if(i.append(QS.Method,null!==(t=r.method)&&void 0!==t?t:"GET"),r.headers)for(const[s,o]of Object.entries(r.headers)){const e=XS(s,o);i.append(QS.Header,e)}if(r.data&&["post","put","patch"].includes(null===(n=r.method)||void 0===n?void 0:n.toLowerCase())){const e=JSON.stringify(r.data);i.append(QS.Body,e)}return r.data=i.toString(),r.method="POST",r.headers={"Content-Type":"application/x-www-form-urlencoded;restless"},r}}const ew=e=>{return"Basic ".concat((t="".concat(e.user,":").concat(e.password),Hy.from(t,"utf8").toString("base64")));var t};var tw=n(9038),nw=n(5437);class rw{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1048576e3,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1048576e3;this.baseurl=e,this.defaultQueryString=t,this.maxBodyLength=n,this.maxContentLength=r}async get(e,t,n,r){const i={...r,baseURL:this.baseurl,headers:n,maxBodyLength:this.maxBodyLength,maxContentLength:this.maxContentLength,method:"GET",url:"".concat(e).concat(this.generateQueryString(t))};return this.request(i,200)}async post(e,t,n,r,i){const s={...i,baseURL:this.baseurl,data:t,headers:r,maxBodyLength:this.maxBodyLength,maxContentLength:this.maxContentLength,method:"POST",url:"".concat(e).concat(this.generateQueryString(n))};return this.request(s,201)}async delete(e,t,n,r){const i={...r,baseURL:this.baseurl,headers:n,maxBodyLength:this.maxBodyLength,maxContentLength:this.maxContentLength,method:"DELETE",url:"".concat(e).concat(this.generateQueryString(t))};return this.request(i,204)}async patch(e,t,n,r,i){const s={...i,baseURL:this.baseurl,data:t,headers:r,maxBodyLength:this.maxBodyLength,maxContentLength:this.maxContentLength,method:"PATCH",url:"".concat(e).concat(this.generateQueryString(n))};return this.request(s,200)}generateQueryString(e){if(this.defaultQueryString||e){return function(e){let t="";for(const n of Object.keys(e))if(void 0!==e[n]){t+="".concat(""===t?"?":"&").concat(n,"=").concat(encodeURIComponent(e[n]))}return t}({...this.defaultQueryString,...e})}return""}}function iw(e){const t=[{headerName:"x-correlation-id",logName:"requestCorrelationId"},{headerName:"content-encoding",logName:"contentEncoding"},{headerName:"content-type",logName:"contentType"}],n={contentsize:(0,Xt.ZK)(e.get("content-length"))};return t.forEach((t=>{const r=e.get(t.headerName);void 0!==r&&null!==r&&(n[t.logName]=r)})),n}class sw extends rw{constructor(e,t,n,r,i,s,o){super(s,arguments.length>7&&void 0!==arguments[7]?arguments[7]:{}),this.rateLimiter=t,this.fetchRefreshedToken=n,this.getAuthorizationHeader=r,this.useRestLess=i,this.tokenP=o,this.restLess=new YS}async request(e,t){var n;let r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];const i={...e,headers:await this.generateHeaders(e.headers)},s=(e=>{var t,n;return[void 0!==e.baseURL?"".concat(e.baseURL).concat(null!==(t=e.url)&&void 0!==t?t:""):null!==(n=e.url)&&void 0!==n?n:"",{method:e.method,headers:e.headers,body:e.data}]})(this.useRestLess?this.restLess.translate(i):i),o=await this.rateLimiter.schedule((async()=>{const e=en.F.now();return{response:await tw(...s).catch((async e=>{const t=["TypeError","FetchError"].includes(null===e||void 0===e?void 0:e.name)?"NetworkError: ".concat(e.message):nw(e);throw t.includes("failed, reason: self signed certificate")?new $n(t,VS.sslCertError,{driverVersion:HS}):new Gn(t,t.startsWith("NetworkError"),{driverVersion:HS})})),duration:en.F.now()-e}})),a=o.response;let c=en.F.now();const l=await a.text(),u=en.F.now()-c,h=l.length;c=en.F.now();const d=null!==(n=a.headers.get("content-type"))&&void 0!==n&&n.includes("application/json")?JSON.parse(l):l,f=en.F.now()-c;if(a.ok||a.status===t){const e=d,t=function(e){const t=new Map;for(const[n,r]of e.entries())t.set(n,r);return t}(a.headers);return{content:e,headers:t,requestUrl:s[0].toString(),propsToLog:{...iw(t),bodySize:h,receiveContentTime:u,parseTime:f,fetchTime:o.duration}}}if(401===a.status&&r)return this.token=await this.fetchRefreshedToken(!0),this.request(i,t,!1);if(429===a.status&&(null===d||void 0===d?void 0:d.retryAfter)>0)return new Promise(((e,n)=>setTimeout((()=>{this.request(i,t).then(e).catch(n)}),1e3*d.retryAfter)));const p=void 0!==d?"string"===typeof d?d:nw(d):a.statusText;!function(e,t,n){throw GS(e,t,n)}("R11s fetch error: ".concat(p),a.status,null===d||void 0===d?void 0:d.retryAfter)}async generateHeaders(e){const t=await this.getToken();(0,i.v)(void 0!==t,1657);return{...e,[$S]:HS,Authorization:this.getAuthorizationHeader(t)}}async getToken(){var e;if(void 0!==this.token)return this.token;const t=await(null!==(e=this.tokenP)&&void 0!==e?e:this.fetchRefreshedToken());return this.setToken(t),this.tokenP=void 0,t}setToken(e){this.token=e}}class ow extends sw{constructor(e,t,n,r,i,s,o){super(e,t,n,r,i,s,o,arguments.length>7&&void 0!==arguments[7]?arguments[7]:{})}static async load(e,t,n,r,i,s,o){const a={token:"".concat((c=e,Ne.Ss.from(c,"utf8").toString("base64")))};var c;return new ow(n,r,t,(t=>{const n={password:t.jwt,user:e};return ew(n)}),i,s,o,a)}}class aw extends sw{constructor(e,t,n,r,i,s,o){super(e,t,n,r,i,s,o,arguments.length>7&&void 0!==arguments[7]?arguments[7]:{})}static async load(e,t,n,r,i,s){return new aw(t,n,e,(e=>"Basic ".concat(e.jwt)),r,i,s)}}function cw(e,t,n,r){return async i=>Xt.Bt.timedExecAsync(r,{eventName:"FetchOrdererToken",docId:t},(async()=>await n.fetchOrdererToken(e,t,i)))}class lw{constructor(e){this.historian=e}async getCommits(e,t){return this.historian.getCommits(e,t)}async getTree(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.historian.getTree(e,t)}async getBlob(e){return this.historian.getBlob(e)}async createBlob(e,t){const n={content:e,encoding:t};return this.historian.createBlob(n)}async createGitTree(e){return this.historian.createTree(e)}async createSummary(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.historian.createSummary(e,t)}async getSnapshot(e){return this.historian.getSnapshot(e)}}class uw{constructor(e,t,n){this.historianApi=e,this.restWrapper=n,this.defaultQueryString={},t&&this.historianApi?(this.defaultQueryString.disableCache=t,this.cacheBust=!1):this.cacheBust=t}async getBlob(e){return this.restWrapper.get("/git/blobs/".concat(encodeURIComponent(e)),this.getQueryString())}async createBlob(e){return this.restWrapper.post("/git/blobs",e,this.getQueryString())}async getCommits(e,t){return this.restWrapper.get("/commits",this.getQueryString({count:t,sha:e})).catch((async e=>400===e.statusCode||404===e.statusCode?{content:[],headers:new Map,propsToLog:{},requestUrl:""}:Promise.reject(e)))}async createTree(e){return this.restWrapper.post("/git/trees",e,this.getQueryString())}async getTree(e,t){return this.restWrapper.get("/git/trees/".concat(encodeURIComponent(e)),this.getQueryString({recursive:t?1:0}))}async createSummary(e,t){return this.restWrapper.post("/git/summaries",e,this.getQueryString(void 0!==t?{initial:t}:void 0))}async getSnapshot(e){return this.restWrapper.get("/git/summaries/".concat(e),this.getQueryString())}getQueryString(e){return this.cacheBust?{cacheBust:Date.now(),...this.defaultQueryString,...e}:{...this.defaultQueryString,...e}}}class hw{get resolvedUrl(){return this._resolvedUrl}constructor(e,t,n,r,i,s,o,a,c,l,u,h,d,f,p,m,g,v,y){this._resolvedUrl=e,this.ordererUrl=t,this.deltaStorageUrl=n,this.deltaStreamUrl=r,this.storageUrl=i,this.logger=s,this.tokenProvider=o,this.tenantId=a,this.documentId=c,this.ordererRestWrapper=l,this.documentStorageServicePolicies=u,this.driverPolicies=h,this.blobCache=d,this.wholeSnapshotTreeCache=f,this.shreddedSummaryTreeCache=p,this.discoverFluidResolvedUrl=m,this.storageRestWrapper=g,this.storageTokenFetcher=v,this.ordererTokenFetcher=y,this.lastDiscoveredAt=Date.now()}dispose(){}async connectToStorage(){if(void 0!==this.documentStorageService)return this.documentStorageService;if(void 0===this.storageUrl)return new ZS;const e=async e=>{const t=this.shouldUpdateDiscoveredSessionInfo();if(t&&await this.refreshDiscovery(),!this.storageManager||!this.noCacheStorageManager||t){if(t){const e=new _y(this.driverPolicies.maxConcurrentStorageRequests);this.storageRestWrapper=await ow.load(this.tenantId,this.storageTokenFetcher,this.logger,e,this.driverPolicies.enableRestLess,this.storageUrl)}const e=new uw(!0,!1,this.storageRestWrapper);this.storageManager=new lw(e);const n=new uw(!0,!0,this.storageRestWrapper);this.noCacheStorageManager=new lw(n)}return e?this.noCacheStorageManager:this.storageManager},t=await e(),n=await e(!0);return this.documentStorageService=new jS(this.documentId,t,this.logger,this.documentStorageServicePolicies,this.driverPolicies,this.blobCache,this.wholeSnapshotTreeCache,this.shreddedSummaryTreeCache,n,e),this.documentStorageService}async connectToDeltaStorage(){await this.connectToStorage(),(0,i.v)(!!this.documentStorageService,177);const e=async()=>{if(this.shouldUpdateDiscoveredSessionInfo()){await this.refreshDiscovery();const e=new _y(this.driverPolicies.maxConcurrentOrdererRequests);this.ordererRestWrapper=await aw.load(this.ordererTokenFetcher,this.logger,e,this.driverPolicies.enableRestLess)}return this.ordererRestWrapper},t=await e(),n=new CS(this.deltaStorageUrl,t,this.logger,e,(()=>this.deltaStorageUrl));return new wS(this.tenantId,this.documentId,n,this.documentStorageService,this.logger)}async connectToDeltaStream(e){const t=async t=>{let n=await this.ordererRestWrapper.getToken();return this.shouldUpdateDiscoveredSessionInfo()&&await this.refreshDiscovery(),t&&(n=await Xt.Bt.timedExecAsync(this.logger,{eventName:"GetDeltaStreamToken",docId:this.documentId,details:JSON.stringify({refreshToken:t})},(async()=>this.tokenProvider.fetchOrdererToken(this.tenantId,this.documentId,t).then((e=>(this.ordererRestWrapper.setToken(e),e)),(e=>{throw(0,o.J4)(e,(t=>new Zn("The Host-provided token fetcher threw an error",Un.fetchTokenError,Yn(e),{errorMessage:t,driverVersion:HS})))}))))),Xt.Bt.timedExecAsync(this.logger,{eventName:"ConnectToDeltaStream",docId:this.documentId},(async()=>JS.create(this.tenantId,this.documentId,n.jwt,pS,e,this.deltaStreamUrl,this.logger,void 0,this.driverPolicies.enableLongPollingDowngrade)))};try{return await t()}catch(n){if(401===(null===n||void 0===n?void 0:n.statusCode))return t(!0);throw n}}async refreshDiscovery(){return this.discoverP||(this.discoverP=Xt.Bt.timedExecAsync(this.logger,{eventName:"RefreshDiscovery"},(async()=>this.refreshDiscoveryCore()))),this.discoverP}async refreshDiscoveryCore(){const e=await this.discoverFluidResolvedUrl();this._resolvedUrl=e,this.storageUrl=e.endpoints.storageUrl,this.ordererUrl=e.endpoints.ordererUrl,this.deltaStorageUrl=e.endpoints.deltaStorageUrl,this.deltaStreamUrl=e.endpoints.deltaStreamUrl||this.ordererUrl}shouldUpdateDiscoveredSessionInfo(){if(!this.driverPolicies.enableDiscovery)return!1;const e=Date.now()-this.lastDiscoveredAt>3e5;return e&&(this.lastDiscoveredAt=Date.now(),this.discoverP=void 0,this.refreshDiscovery().catch((()=>{this.lastDiscoveredAt=0}))),e}}var dw=n(3775);const fw=e=>new dw(e,!0),pw=(e,t)=>e.split("/").slice(0,-1).concat([t]).join("/"),mw=(e,t)=>{const n=new dw(t.ordererUrl),r=new dw(e.endpoints.deltaStorageUrl);r.set("host",n.host);const i=new dw(t.historianUrl),s=new dw(e.endpoints.storageUrl);s.set("host",i.host);const o=fw(e.url);return{endpoints:{deltaStorageUrl:r.toString(),ordererUrl:t.ordererUrl,deltaStreamUrl:t.deltaStreamUrl,storageUrl:s.toString()},id:e.id,tokens:e.tokens,type:e.type,url:new dw("fluid://".concat(n.host).concat(o.pathname)).toString()}},gw=432e6,vw={enablePrefetch:!0,maxConcurrentStorageRequests:100,maxConcurrentOrdererRequests:100,enableDiscovery:!1,enableWholeSummaryUpload:!1,enableRestLess:!0,enableInternalSummaryCaching:!0,enableLongPollingDowngrade:!0,isEphemeralContainer:!1};class yw{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.tokenProvider=e,this.wholeSnapshotTreeCache=new kS,this.shreddedSummaryTreeCache=new kS;const n=gw;this.driverPolicies={...vw,...t},this.blobCache=new TS,this.driverPolicies.enableInternalSummaryCaching&&(this.driverPolicies.enableWholeSummaryUpload?this.wholeSnapshotTreeCache=new TS(n):this.shreddedSummaryTreeCache=new TS(n))}async createContainer(e,t,n,r){if(void 0===e)throw new Error("Empty file summary creation isn't supported in this driver.");(0,i.v)(!!t.endpoints.ordererUrl,178);let s=fw(t.url);if(!s.pathname)throw new Error("Parsed url should contain tenant and doc Id!!");const[,o]=s.pathname.split("/");if(!Nv(e))throw new Error("Protocol and App Summary required in the full summary");const a=e.tree[".protocol"],c=e.tree[".app"],l=function(e){const t=e.tree.attributes;return JSON.parse(t.content)}(a),u=function(e){const t=e.tree.quorumValues;return JSON.parse(t.content)}(a),h=(0,Xt.pW)({logger:n,namespace:"RouterliciousDriver"}),d=cw(o,void 0,this.tokenProvider,h),f=new _y(this.driverPolicies.maxConcurrentOrdererRequests),p=await aw.load(d,h,f,this.driverPolicies.enableRestLess,t.endpoints.ordererUrl),m=await Xt.Bt.timedExecAsync(h,{eventName:"CreateNew",details:JSON.stringify({enableDiscovery:this.driverPolicies.enableDiscovery,sequenceNumber:l.sequenceNumber,isEphemeralContainer:this.driverPolicies.isEphemeralContainer})},(async e=>{const t=(await p.post("/documents/".concat(o),{summary:Ky(void 0,c),sequenceNumber:l.sequenceNumber,values:u,enableDiscovery:this.driverPolicies.enableDiscovery,generateToken:void 0!==this.tokenProvider.documentPostCreateCallback,isEphemeralContainer:this.driverPolicies.isEphemeralContainer,enableAnyBinaryBlobOnFirstSummary:!0})).content;return e.end({docId:"string"===typeof t?t:t.id}),t}));let g,v,y;"string"===typeof m?g=m:(g=m.id,v=m.token,y=this.driverPolicies.enableDiscovery?m.session:void 0),s=fw(t.url);try{await Xt.Bt.timedExecAsync(h,{eventName:"DocPostCreateCallback",docId:g},(async()=>{if(v&&void 0!==this.tokenProvider.documentPostCreateCallback)return this.tokenProvider.documentPostCreateCallback(g,v)}))}catch(w){throw new bw(w)}s.set("pathname",pw(s.pathname,g));const b=t.endpoints.deltaStorageUrl;if(!b)throw new Error("All endpoints urls must be provided. [deltaStorageUrl:".concat(b,"]"));const S=new URL(b);return S.pathname=pw(S.pathname,g),this.createDocumentService({...t,url:s.toString(),id:g,endpoints:{...t.endpoints,deltaStorageUrl:S.toString()}},n,r,y)}async createDocumentService(e,t,n,r){const i=fw(e.url),[,s,o]=i.pathname.split("/");if(!o||!s)throw new Error("Couldn't parse documentId and/or tenantId. [documentId:".concat(o,"][tenantId:").concat(s,"]"));const a=(0,Xt.pW)({logger:t,namespace:"RouterliciousDriver",properties:{all:{driverVersion:HS}}}),c=cw(s,o,this.tokenProvider,a),l=function(e,t,n,r){return async i=>Xt.Bt.timedExecAsync(r,{eventName:"FetchStorageToken",docId:t},(async()=>await n.fetchStorageToken(e,t,i)))}(s,o,this.tokenProvider,a),u=c(),h=l(),d=new _y(this.driverPolicies.maxConcurrentOrdererRequests),f=await aw.load(c,a,d,this.driverPolicies.enableRestLess,void 0,u),p=async()=>{if(!this.driverPolicies.enableDiscovery)return e;const t=await Xt.Bt.timedExecAsync(a,{eventName:"DiscoverSession",docId:o},(async t=>{const n=await f.get("".concat(e.endpoints.ordererUrl,"/documents/").concat(s,"/session/").concat(o));return t.end({...n.propsToLog,...Ly(n.requestUrl,"xmlhttprequest")}),n.content}));return mw(e,t)},m=void 0!==r?mw(e,r):await p(),g=m.endpoints.storageUrl,v=m.endpoints.ordererUrl,y=m.endpoints.deltaStorageUrl,b=m.endpoints.deltaStreamUrl||v;if(!v||!y)throw new Error("All endpoints urls must be provided. [ordererUrl:".concat(v,"][deltaStorageUrl:").concat(y,"]"));const S=await ow.load(s,l,a,new _y(this.driverPolicies.maxConcurrentStorageRequests),this.driverPolicies.enableRestLess,g,h),w={caching:this.driverPolicies.enablePrefetch?dn.Prefetch:dn.NoCaching,maximumCacheDurationMs:gw};return new hw(m,v,y,b,g,a,this.tokenProvider,s,o,f,w,this.driverPolicies,this.blobCache,this.wholeSnapshotTreeCache,this.shreddedSummaryTreeCache,p,S,l,c)}}class bw extends Error{constructor(e){super(e.message),this.innerError=e,this.name="DocumentPostCreateError"}get stack(){return this.innerError.stack}}var Sw=n(350);const ww={randomUUID:"undefined"!==typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let Cw;const xw=new Uint8Array(16);function Ew(){if(!Cw&&(Cw="undefined"!==typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Cw))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Cw(xw)}const Tw=[];for(let n=0;n<256;++n)Tw.push((n+256).toString(16).slice(1));function kw(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return Tw[e[t+0]]+Tw[e[t+1]]+Tw[e[t+2]]+Tw[e[t+3]]+"-"+Tw[e[t+4]]+Tw[e[t+5]]+"-"+Tw[e[t+6]]+Tw[e[t+7]]+"-"+Tw[e[t+8]]+Tw[e[t+9]]+"-"+Tw[e[t+10]]+Tw[e[t+11]]+Tw[e[t+12]]+Tw[e[t+13]]+Tw[e[t+14]]+Tw[e[t+15]]}const Nw=function(e,t,n){if(ww.randomUUID&&!t&&!e)return ww.randomUUID();const r=(e=e||{}).random||(e.rng||Ew)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return kw(r)};class Fw{constructor(e){this.scopes=e}async fetchOrdererToken(e,t){return{fromCache:!0,jwt:this.getSignedToken(e,t)}}async fetchStorageToken(e,t){return{fromCache:!0,jwt:this.getSignedToken(e,t)}}getSignedToken(e,t){var n;let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3600,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"1.0";const s=Nw(),o=s.match(/^([\da-f]{8})-([\da-f]{4})/),a=null===o?s:o[0],c=Math.round(Date.now()/1e3),l={id:s,name:a},u={documentId:null!==t&&void 0!==t?t:"",scopes:null!==(n=this.scopes)&&void 0!==n?n:[uy.DocRead,uy.DocWrite,uy.SummaryWrite],tenantId:e,user:l,iat:c,exp:c+r,ver:i};return Sw.pj.jws.JWS.sign(null,JSON.stringify({alg:"HS256",typ:"JWT"}),u,{utf8:"12345"})}}class Iw{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:7070,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"http://localhost";this.tinyliciousEndpoint="".concat(t,":").concat(e),this.fluidProtocolEndpoint=this.tinyliciousEndpoint.replace(/(^\w+:|^)\/\//,"fluid://")}async resolve(e){const t=e.url.replace("".concat(this.tinyliciousEndpoint,"/"),""),n=t.split("/")[0];let r,i,s=n;if(e.headers&&!0===e.headers[hn.createNew])""===s&&(s="new"),r="".concat(this.tinyliciousEndpoint,"/deltas/tinylicious/").concat(s),i="".concat(this.fluidProtocolEndpoint,"/tinylicious/").concat(s);else{const e=encodeURIComponent(s),o=t.slice(n.length);i="".concat(this.fluidProtocolEndpoint,"/tinylicious/").concat(e).concat(o),r="".concat(this.tinyliciousEndpoint,"/deltas/tinylicious/").concat(e)}return{endpoints:{deltaStorageUrl:r,ordererUrl:this.tinyliciousEndpoint,storageUrl:"".concat(this.tinyliciousEndpoint,"/repos/tinylicious")},id:s,tokens:{},type:"fluid",url:i}}async getAbsoluteUrl(e,t){const n=decodeURIComponent(e.url.replace("".concat(this.fluidProtocolEndpoint,"/tinylicious/"),""));return"".concat(n,"/").concat(t)}}function Aw(e){return new Dw(e.container,e.rootDataObject)}class Dw extends Zt{constructor(e,t){super(),this.container=e,this.rootDataObject=t,this.connectedHandler=()=>this.emit("connected"),this.disconnectedHandler=()=>this.emit("disconnected"),this.disposedHandler=e=>this.emit("disposed",e),this.savedHandler=()=>this.emit("saved"),this.dirtyHandler=()=>this.emit("dirty"),this.INTERNAL_CONTAINER_DO_NOT_USE=()=>this.container,e.on("connected",this.connectedHandler),e.on("closed",this.disposedHandler),e.on("disconnected",this.disconnectedHandler),e.on("saved",this.savedHandler),e.on("dirty",this.dirtyHandler)}get isDirty(){return this.container.isDirty}get attachState(){return this.container.attachState}get disposed(){return this.container.closed}get connectionState(){return this.container.connectionState}get initialObjects(){return this.rootDataObject.initialObjects}async attach(){if(this.container.attachState!==Qt.Detached)throw new Error("Cannot attach container. Container is not in detached state.");throw new Error("Cannot attach container. Attach method not provided.")}async connect(){var e,t;null===(e=(t=this.container).connect)||void 0===e||e.call(t)}async disconnect(){var e,t;null===(e=(t=this.container).disconnect)||void 0===e||e.call(t)}async create(e){return this.rootDataObject.create(e)}dispose(){this.container.close(),this.container.off("connected",this.connectedHandler),this.container.off("closed",this.disposedHandler),this.container.off("disconnected",this.disconnectedHandler),this.container.off("saved",this.savedHandler),this.container.off("dirty",this.dirtyHandler)}}class Ow extends Zt{constructor(e,t){super(),this.container=e,this.createServiceMember=t,this.lastMembers=new Map,this.audience=e.audience,this.getMembers(),this.audience.on("addMember",((e,t)=>{if(this.shouldIncludeAsMember(t)){const t=this.getMember(e);this.emit("memberAdded",e,t),this.emit("membersChanged")}})),this.audience.on("removeMember",(e=>{this.lastMembers.has(e)&&(this.emit("memberRemoved",e,this.lastMembers.get(e)),this.emit("membersChanged"))})),this.container.on("connected",(()=>this.emit("membersChanged")))}getMembers(){const e=new Map,t=new Map;return this.audience.getMembers().forEach(((n,r)=>{if(this.shouldIncludeAsMember(n)){const i=n.user.id;let s=e.get(i);void 0===s&&(s=this.createServiceMember(n),e.set(i,s)),s.connections.push({id:r,mode:n.mode}),t.set(r,s)}})),this.lastMembers=t,e}getMyself(){const e=this.container.clientId;if(void 0===e)return;const t=this.getMember(e);if(void 0===t)return;return{...t,currentConnection:e}}getMember(e){const t=this.audience.getMember(e);if(void 0===t)return;const n=this.getMembers().get(null===t||void 0===t?void 0:t.user.id);if(void 0===n)throw Error("Attempted to fetch client ".concat(e," that is not part of the current member list"));return n}shouldIncludeAsMember(e){return e.details.capabilities.interactive}}var Pw;!function(e){e[e.Shared=0]="Shared",e[e.Plain=1]="Plain"}(Pw||(Pw={}));var Rw=n(3316);const Mw=0,Bw=1;class Lw{constructor(e,t){this.compareKeys=e,this.aug=t}makeNode(e,t,n,r){return{key:e,data:t,color:n,size:r}}isRed(e){return!!e&&e.color===Mw}nodeSize(e){return e?e.size:0}size(){return this.nodeSize(this.root)}isEmpty(){return!this.root}get(e){if(void 0!==e)return this.nodeGet(this.root,e)}nodeGet(e,t){let n=e;for(;n;){const e=this.compareKeys(t,n.key);if(e<0)n=n.left;else{if(!(e>0))return n;n=n.right}}}contains(e){return this.get(e)}gather(e,t){const n=[];return void 0!==e&&this.nodeGather(this.root,n,e,t),n}nodeGather(e,t,n,r){e&&(r.continueSubtree(e.left,n)&&this.nodeGather(e.left,t,n,r),r.matchNode(e,n)&&t.push(e),r.continueSubtree(e.right,n)&&this.nodeGather(e.right,t,n,r))}walkExactMatchesForward(e,t,n,r){this.nodeWalkExactMatchesForward(this.root,e,t,n,r)}nodeWalkExactMatchesForward(e,t,n,r,i){if(!e)return;const s=t(e);r(s)&&this.nodeWalkExactMatchesForward(e.left,t,n,r,i),0===s&&n(e),i(s)&&this.nodeWalkExactMatchesForward(e.right,t,n,r,i)}walkExactMatchesBackward(e,t,n,r){this.nodeWalkExactMatchesBackward(this.root,e,t,n,r)}nodeWalkExactMatchesBackward(e,t,n,r,i){if(!e)return;const s=t(e);i(s)&&this.nodeWalkExactMatchesBackward(e.right,t,n,r,i),0===s&&n(e),r(s)&&this.nodeWalkExactMatchesBackward(e.left,t,n,r,i)}put(e,t,n){void 0!==e&&(void 0===t?this.remove(e):(this.root=this.nodePut(this.root,e,t,n),this.root.color=Bw))}nodePut(e,t,n,r){let i=e;if(i){const e=this.compareKeys(t,i.key);if(e<0)i.left=this.nodePut(i.left,t,n,r);else if(e>0)i.right=this.nodePut(i.right,t,n,r);else if(r){const e=r(t,i.key,n,i.data);e.key&&(i.key=e.key),i.data=e.data?e.data:n}else i.data=n;return this.isRed(i.right)&&!this.isRed(i.left)&&(i=this.rotateLeft(i)),this.isRed(i.left)&&this.isRed(i.left.left)&&(i=this.rotateRight(i)),this.isRed(i.left)&&this.isRed(i.right)&&this.flipColors(i),i.size=this.nodeSize(i.left)+this.nodeSize(i.right)+1,this.aug&&this.updateLocal(i),i}return this.makeNode(t,n,Mw,1)}updateLocal(e){this.aug&&(this.isRed(e.left)&&this.aug.update(e.left),this.isRed(e.right)&&this.aug.update(e.right),this.aug.update(e))}nodeRemoveMin(e){let t=e;if(t.left)return this.isRed(t.left)||this.isRed(t.left.left)||(t=this.moveRedLeft(t)),t.left=this.nodeRemoveMin(t.left),this.balance(t)}remove(e){if(void 0!==e){if(!this.contains(e))return;this.removeExisting(e)}}removeExisting(e){this.isRed(this.root.left)||this.isRed(this.root.right)||(this.root.color=Mw),this.root=this.nodeRemove(this.root,e)}nodeRemove(e,t){let n=e;if(this.compareKeys(t,n.key)<0)this.isRed(n.left)||this.isRed(n.left.left)||(n=this.moveRedLeft(n)),n.left=this.nodeRemove(n.left,t);else{if(this.isRed(n.left)&&(n=this.rotateRight(n)),0===this.compareKeys(t,n.key)&&!n.right)return;if(this.isRed(n.right)||this.isRed(n.right.left)||(n=this.moveRedRight(n)),0===this.compareKeys(t,n.key)){const e=this.nodeMin(n.right);n.key=e.key,n.data=e.data,n.right=this.nodeRemoveMin(n.right)}else n.right=this.nodeRemove(n.right,t)}return this.balance(n)}floor(e){if(!this.isEmpty())return this.nodeFloor(this.root,e)}nodeFloor(e,t){if(e){const n=this.compareKeys(t,e.key);if(0===n)return e;if(n<0)return this.nodeFloor(e.left,t);{const n=this.nodeFloor(e.right,t);return n||e}}}ceil(e){if(!this.isEmpty())return this.nodeCeil(this.root,e)}nodeCeil(e,t){if(e){const n=this.compareKeys(t,e.key);if(0===n)return e;if(n>0)return this.nodeCeil(e.right,t);{const n=this.nodeCeil(e.left,t);return n||e}}}min(){if(this.root)return this.nodeMin(this.root)}nodeMin(e){return e.left?this.nodeMin(e.left):e}max(){if(this.root)return this.nodeMax(this.root)}nodeMax(e){return e.right?this.nodeMax(e.right):e}rotateRight(e){const t=e.left;return e.left=t.right,t.right=e,t.color=t.right.color,t.right.color=Mw,t.size=e.size,e.size=this.nodeSize(e.left)+this.nodeSize(e.right)+1,this.aug&&(this.updateLocal(e),this.updateLocal(t)),t}rotateLeft(e){const t=e.right;return e.right=t.left,t.left=e,t.color=t.left.color,t.left.color=Mw,t.size=e.size,e.size=this.nodeSize(e.left)+this.nodeSize(e.right)+1,this.aug&&(this.updateLocal(e),this.updateLocal(t)),t}oppositeColor(e){return e===Bw?Mw:Bw}flipColors(e){e.color=this.oppositeColor(e.color),e.left.color=this.oppositeColor(e.left.color),e.right.color=this.oppositeColor(e.right.color)}moveRedLeft(e){let t=e;return this.flipColors(t),this.isRed(t.right.left)&&(t.right=this.rotateRight(t.right),t=this.rotateLeft(t),this.flipColors(t)),t}moveRedRight(e){let t=e;return this.flipColors(t),this.isRed(t.left.left)&&(t=this.rotateRight(t),this.flipColors(t)),t}balance(e){let t=e;return this.isRed(t.right)&&(t=this.rotateLeft(t)),this.isRed(t.left)&&this.isRed(t.left.left)&&(t=this.rotateRight(t)),this.isRed(t.left)&&this.isRed(t.right)&&this.flipColors(t),t.size=this.nodeSize(t.left)+this.nodeSize(t.right)+1,this.aug&&this.aug.update(t),t}mapRange(e,t,n,r){this.nodeMap(this.root,e,t,n,r)}map(e,t){this.nodeMap(this.root,e,t)}keys(){const e=[],t={showStructure:!0,infix:t=>(e.push(t.key),!0)};return this.walk(t),e}walk(e){this.nodeWalk(this.root,e)}walkBackward(e){this.nodeWalkBackward(this.root,e)}nodeWalk(e,t){let n=!0;return e&&(t.pre&&(t.showStructure||e.color===Bw)&&(n=t.pre(e)),e.left&&(n=this.nodeWalk(e.left,t)),n&&t.infix&&(t.showStructure||e.color===Bw)&&(n=t.infix(e)),n&&(n=this.nodeWalk(e.right,t)),n&&t.post&&(t.showStructure||e.color===Bw)&&(n=t.post(e))),n}nodeWalkBackward(e,t){let n=!0;return e&&(t.pre&&(t.showStructure||e.color===Bw)&&(n=t.pre(e)),e.right&&(n=this.nodeWalkBackward(e.right,t)),n&&t.infix&&(t.showStructure||e.color===Bw)&&(n=t.infix(e)),n&&(n=this.nodeWalkBackward(e.left,t)),n&&t.post&&(t.showStructure||e.color===Bw)&&(n=t.post(e))),n}nodeMap(e,t,n,r,i){let s=r,o=i;if(!e)return!0;void 0===s&&(s=this.nodeMin(e).key),void 0===o&&(o=this.nodeMax(e).key);const a=this.compareKeys(s,e.key),c=this.compareKeys(o,e.key);let l=!0;return a<0&&(l=this.nodeMap(e.left,t,n,s,o)),l&&a<=0&&c>=0&&(l=t(e,n)),l&&c>0&&(l=this.nodeMap(e.right,t,n,s,o)),l}}function qw(e,t,n){const r=e.makeSerialized(t,n);return{type:r.type,value:r.value&&JSON.parse(r.value)}}class _w{constructor(e){this.value=e}get type(){return Pw[Pw.Plain]}makeSerialized(e,t){const n=function(e,t,n){return void 0!==e?t.stringify(e,n):e}(this.value,e,t);return{type:this.type,value:n}}}class jw{constructor(e){this.serializer=e}fromSerializable(e){if(e.type===Pw[Pw.Shared]){e.type=Pw[Pw.Plain];const t={type:"__fluid_handle__",url:e.value};e.value=t}const t=function(e,t){return void 0!==e?t.parse(JSON.stringify(e)):e}(e.value,this.serializer);return new _w(t)}fromInMemory(e){return new _w(e)}}const zw="2.0.0-rc.1.0.8";var Uw,Hw;const Vw=Rw.posix,Kw="header";class Gw{get type(){return Gw.Type}get attributes(){return Gw.Attributes}async load(e,t,n,r){const i=new $w(t,e,r);return await i.load(n),i}create(e,t){const n=new $w(t,e,Gw.Attributes);return n.initializeLocal(),n}}Gw.Type="https://graph.microsoft.com/types/directory",Gw.Attributes={type:Gw.Type,snapshotFormatVersion:"0.1",packageVersion:zw};const Ww=(e,t)=>Jw(e)?Jw(t)?e.seq!==t.seq?e.seq-t.seq:e.clientSeq-t.clientSeq:-1:Jw(t)?1:e.seq!==t.seq?e.seq-t.seq:e.clientSeq-t.clientSeq;function Jw(e){return e.seq>=0}class Zw{constructor(){this.indexToKey=new Lw(Ww),this.keyToIndex=new Map}set(e,t){this.indexToKey.put(t,e),this.keyToIndex.set(e,t)}has(e){return"string"===typeof e?this.keyToIndex.has(e):void 0!==this.indexToKey.get(e)}delete(e){if(this.has(e))if("string"===typeof e){const t=this.keyToIndex.get(e);this.keyToIndex.delete(e),this.indexToKey.remove(t)}else{var t;const n=null===(t=this.indexToKey.get(e))||void 0===t?void 0:t.data;this.indexToKey.remove(e),this.keyToIndex.delete(n)}}keys(e){const t=[];return this.indexToKey.mapRange((n=>(e&&!e(n.data)||t.push(n.data),!0)),t),t}get size(){return this.keyToIndex.size}}class $w extends go{static create(e,t){return e.createChannel(t,Gw.Type)}static getFactory(){return new Gw}get absolutePath(){return this.root.absolutePath}constructor(e,t,n){super(e,t,n,"fluid_directory_"),this[Uw]="SharedDirectory",this.root=new nC({seq:0,clientSeq:0},new Set,this,this.runtime,this.serializer,Vw.sep,this.logger),this.messageHandlers=new Map,this.localValueMaker=new jw(this.serializer),this.setMessageHandlers(),this.root.on("containedValueChanged",((e,t)=>{this.emit("containedValueChanged",e,t,this)})),this.root.on("subDirectoryCreated",((e,t)=>{this.emit("subDirectoryCreated",e,t,this)})),this.root.on("subDirectoryDeleted",((e,t)=>{this.emit("subDirectoryDeleted",e,t,this)}))}get(e){return this.root.get(e)}set(e,t){return this.root.set(e,t),this}dispose(e){this.root.dispose(e)}get disposed(){return this.root.disposed}delete(e){return this.root.delete(e)}clear(){this.root.clear()}has(e){return this.root.has(e)}get size(){return this.root.size}forEach(e){this.root.forEach(e)}[(Uw=Symbol.toStringTag,Symbol.iterator)](){return this.root[Symbol.iterator]()}entries(){return this.root.entries()}countSubDirectory(){return this.root.countSubDirectory()}keys(){return this.root.keys()}values(){return this.root.values()}createSubDirectory(e){return this.root.createSubDirectory(e)}getSubDirectory(e){return this.root.getSubDirectory(e)}hasSubDirectory(e){return this.root.hasSubDirectory(e)}deleteSubDirectory(e){return this.root.deleteSubDirectory(e)}subdirectories(){return this.root.subdirectories()}getWorkingDirectory(e){const t=this.makeAbsolute(e);if(t===Vw.sep)return this.root;let n=this.root;const r=t.slice(1).split(Vw.sep);for(const i of r)if(n=n.getSubDirectory(i),!n)return;return n}summarizeCore(e,t){return this.serializeDirectory(this.root,e)}submitDirectoryMessage(e,t){this.submitLocalMessage(e,t)}onDisconnect(){}reSubmitCore(e,t){const n=e,r=this.messageHandlers.get(n.type);(0,i.v)(void 0!==r,13),r.submit(n,t)}async loadCore(e){const t=await vn(e,Kw),n=t;Array.isArray(n.blobs)?(this.populate(n.content),await Promise.all(n.blobs.map((async t=>{const n=await vn(e,t);this.populate(n)})))):this.populate(t)}populate(e){const t=[];for(t.push([this.root,e]);t.length>0;){const[e,n]=t.pop();if(n.subdirectories){const r=new Map;for(const[i,s]of Object.entries(n.subdirectories)){let n,o=e.getSubDirectory(i);if(!o){const t=s.ci;if(void 0!==t&&t.csn>0){r.has(t.csn)||r.set(t.csn,0);let e=r.get(t.csn);n={seq:t.csn,clientSeq:e},r.set(t.csn,++e)}else n={seq:0,clientSeq:++e.localCreationSeq};o=new nC(n,void 0!==t?new Set(t.ccIds):new Set,this,this.runtime,this.serializer,Vw.join(e.absolutePath,i),this.logger),e.populateSubDirectory(i,o),e.ackedCreationSeqTracker.set(i,{...n})}t.push([o,s])}}if(n.storage)for(const[t,r]of Object.entries(n.storage)){const n=this.makeLocal(t,e.absolutePath,r);e.populateStorage(t,n)}}}processCore(e,t,n){if(e.type===pn.Operation){const r=e.contents,s=this.messageHandlers.get(r.type);(0,i.v)(void 0!==s,14),s.process(e,r,t,n)}}rollback(e,t){const n=e,r=this.getWorkingDirectory(n.path);r&&r.rollback(n,t)}makeAbsolute(e){return Vw.resolve(Vw.sep,e)}makeLocal(e,t,n){return(0,i.v)(n.type===Pw[Pw.Plain]||n.type===Pw[Pw.Shared],484),this.localValueMaker.fromSerializable(n)}isSubDirectoryDeletePending(e){const t=this.makeAbsolute(e);if(t===Vw.sep)return!1;let n=this.root;const r=t.split(Vw.sep);let i=1;for(;i<r.length;){const e=r[i];if(n.isSubDirectoryDeletePending(e))return!0;if(n=n.getSubDirectory(e),void 0===n)return!0;i+=1}return!1}setMessageHandlers(){this.messageHandlers.set("clear",{process:(e,t,n,r)=>{const i=this.getWorkingDirectory(t.path);i&&!this.isSubDirectoryDeletePending(t.path)&&i.processClearMessage(e,t,n,r)},submit:(e,t)=>{const n=this.getWorkingDirectory(e.path);n&&n.resubmitClearMessage(e,t)},applyStashedOp:e=>{const t=this.getWorkingDirectory(e.path);if(t)return t.applyStashedClearMessage(e)}}),this.messageHandlers.set("delete",{process:(e,t,n,r)=>{const i=this.getWorkingDirectory(t.path);i&&!this.isSubDirectoryDeletePending(t.path)&&i.processDeleteMessage(e,t,n,r)},submit:(e,t)=>{const n=this.getWorkingDirectory(e.path);n&&n.resubmitKeyMessage(e,t)},applyStashedOp:e=>{const t=this.getWorkingDirectory(e.path);if(t)return t.applyStashedDeleteMessage(e)}}),this.messageHandlers.set("set",{process:(e,t,n,r)=>{const i=this.getWorkingDirectory(t.path);if(i&&!this.isSubDirectoryDeletePending(t.path)){const s=n?void 0:this.makeLocal(t.key,t.path,t.value);i.processSetMessage(e,t,s,n,r)}},submit:(e,t)=>{const n=this.getWorkingDirectory(e.path);n&&n.resubmitKeyMessage(e,t)},applyStashedOp:e=>{const t=this.getWorkingDirectory(e.path);if(t){const n=this.makeLocal(e.key,e.path,e.value);return t.applyStashedSetMessage(e,n)}}}),this.messageHandlers.set("createSubDirectory",{process:(e,t,n,r)=>{const i=this.getWorkingDirectory(t.path);i&&!this.isSubDirectoryDeletePending(t.path)&&i.processCreateSubDirectoryMessage(e,t,n,r)},submit:(e,t)=>{const n=this.getWorkingDirectory(e.path);n&&n.resubmitSubDirectoryMessage(e,t)},applyStashedOp:e=>{const t=this.getWorkingDirectory(e.path);if(t)return t.applyStashedCreateSubDirMessage(e)}}),this.messageHandlers.set("deleteSubDirectory",{process:(e,t,n,r)=>{const i=this.getWorkingDirectory(t.path);i&&!this.isSubDirectoryDeletePending(t.path)&&i.processDeleteSubDirectoryMessage(e,t,n,r)},submit:(e,t)=>{const n=this.getWorkingDirectory(e.path);n&&n.resubmitSubDirectoryMessage(e,t)},applyStashedOp:e=>{const t=this.getWorkingDirectory(e.path);if(t)return t.applyStashedDeleteSubDirMessage(e)}})}applyStashedOp(e){const t=this.messageHandlers.get(e.type);if(void 0===t)throw new Error("no apply stashed op handler");return t.applyStashedOp(e)}serializeDirectory(e,t,n){const r=new Pt;let i=0;const s=[],o=[],a={};for(o.push([e,a]);o.length>0;){const[e,n]=o.pop();n.ci=e.getSerializableCreateInfo();for(const[o,a]of e.getSerializedStorage(t)){n.storage||(n.storage={});const t={type:a.type,value:a.value&&JSON.parse(a.value)};if(a.value&&a.value.length>=8192){const n={};let a=n;if(e.absolutePath!==Vw.sep)for(const t of e.absolutePath.slice(1).split(Vw.sep)){const e={};a.subdirectories={[t]:e},a=e}a.storage={[o]:t};const c="blob".concat(i);i++,s.push(c),r.addBlob(c,JSON.stringify(n))}else n.storage[o]=t}for(const[t,r]of e.subdirectories()){n.subdirectories||(n.subdirectories={});const e={};n.subdirectories[t]=e,o.push([r,e])}}const c={blobs:s,content:a};return r.addBlob(Kw,JSON.stringify(c)),r.getSummaryTree()}}function Qw(e){return void 0!==e&&"number"===typeof e.pendingMessageId&&"edit"===e.type}function Xw(e){return void 0!==e&&"clear"===e.type&&"number"===typeof e.pendingMessageId&&"object"===typeof e.previousStorage}function Yw(e){return void 0!==e&&("createSubDir"===e.type||"deleteSubDir"===e.type)}function eC(e){(0,i.v)(null!==e,1711)}let tC=!1;class nC extends Zt{constructor(e,t,n,r,i,s,o){super(),this.seqData=e,this.clientIds=t,this.directory=n,this.runtime=r,this.serializer=i,this.absolutePath=s,this.logger=o,this._deleted=!1,this[Hw]="SubDirectory",this._storage=new Map,this._subdirectories=new Map,this.pendingKeys=new Map,this.pendingDeleteSubDirectoriesTracker=new Map,this.pendingCreateSubDirectoriesTracker=new Map,this.pendingMessageId=-1,this.pendingClearMessageIds=[],this.localCreationSeq=0,this.localCreationSeqTracker=new Zw,this.ackedCreationSeqTracker=new Zw}dispose(e){this._deleted=!0,this.emit("disposed",this)}undispose(){this._deleted=!1,this.emit("undisposed",this)}get disposed(){return this._deleted}throwIfDisposed(){if(this._deleted)throw new l("Cannot access Disposed subDirectory")}has(e){return this.throwIfDisposed(),this._storage.has(e)}get(e){var t;return this.throwIfDisposed(),null===(t=this._storage.get(e))||void 0===t?void 0:t.value}set(e,t){if(this.throwIfDisposed(),void 0===e||null===e)throw new Error("Undefined and null keys are not supported");const n=this.directory.localValueMaker.fromInMemory(t),r=qw(n,this.serializer,this.directory.handle),i=this.setCore(e,n,!0);if(!this.directory.isAttached())return this;const s={key:e,path:this.absolutePath,type:"set",value:r};return this.submitKeyMessage(s,i),this}countSubDirectory(){return this._subdirectories.size}createSubDirectory(e){var t;if(this.throwIfDisposed(),void 0===e||null===e)throw new Error("SubDirectory name may not be undefined or null");if(e.includes(Vw.sep))throw new Error("SubDirectory name may not contain ".concat(Vw.sep));const n=this.createSubDirectoryCore(e,!0,this.getLocalSeq(),null!==(t=this.runtime.clientId)&&void 0!==t?t:"detached"),r=this._subdirectories.get(e);if((0,i.v)(void 0!==r,1450),!this.directory.isAttached())return r;if(n){const t={path:this.absolutePath,subdirName:e,type:"createSubDirectory"};this.submitCreateSubDirectoryMessage(t)}return r}getLocalSeq(){return this.directory.isAttached()?{seq:-1,clientSeq:++this.localCreationSeq}:{seq:0,clientSeq:++this.localCreationSeq}}getSubDirectory(e){return this.throwIfDisposed(),this._subdirectories.get(e)}hasSubDirectory(e){return this.throwIfDisposed(),this._subdirectories.has(e)}deleteSubDirectory(e){this.throwIfDisposed();const t=this.deleteSubDirectoryCore(e,!0);if(!this.directory.isAttached())return void 0!==t;if(void 0!==t){const n={path:this.absolutePath,subdirName:e,type:"deleteSubDirectory"};this.submitDeleteSubDirectoryMessage(n,t)}return void 0!==t}subdirectories(){this.throwIfDisposed();const e=[...this.ackedCreationSeqTracker.keys(),...this.localCreationSeqTracker.keys((e=>!this.ackedCreationSeqTracker.has(e)))];if(e.length!==this._subdirectories.size)return tC||(this.logger.sendTelemetryEvent({eventName:"inconsistentSubdirectoryOrdering",localKeyCount:this.localCreationSeqTracker.size,ackedKeyCount:this.ackedCreationSeqTracker.size,subdirNamesLength:e.length,subdirectoriesSize:this._subdirectories.size}),tC=!0),this._subdirectories.entries();return{index:0,dirs:this._subdirectories,next(){if(this.index<e.length){const t=e[this.index++];return{value:[t,this.dirs.get(t)],done:!1}}return{value:void 0,done:!0}},[Symbol.iterator](){return this}}}getWorkingDirectory(e){return this.throwIfDisposed(),this.directory.getWorkingDirectory(this.makeAbsolute(e))}isSubDirectoryDeletePending(e){return!!this.pendingDeleteSubDirectoriesTracker.has(e)}delete(e){this.throwIfDisposed();const t=this.deleteCore(e,!0);if(!this.directory.isAttached())return void 0!==t;const n={key:e,path:this.absolutePath,type:"delete"};return this.submitKeyMessage(n,t),void 0!==t}clear(){if(this.throwIfDisposed(),!this.directory.isAttached())return void this.clearCore(!0);const e=new Map(this._storage);this.clearCore(!0);const t={path:this.absolutePath,type:"clear"};this.submitClearMessage(t,e)}forEach(e){this.throwIfDisposed(),this._storage.forEach(((t,n,r)=>{e(t.value,n,r)}))}get size(){return this.throwIfDisposed(),this._storage.size}entries(){this.throwIfDisposed();const e=this._storage.entries();return{next(){const t=e.next();return t.done?{value:void 0,done:!0}:{value:[t.value[0],t.value[1].value],done:!1}},[Symbol.iterator](){return this}}}keys(){return this.throwIfDisposed(),this._storage.keys()}values(){this.throwIfDisposed();const e=this._storage.values();return{next(){const t=e.next();return t.done?{value:void 0,done:!0}:{value:t.value.value,done:!1}},[Symbol.iterator](){return this}}}[(Hw=Symbol.toStringTag,Symbol.iterator)](){return this.throwIfDisposed(),this.entries()}processClearMessage(e,t,n,r){if(this.throwIfDisposed(),this.isMessageForCurrentInstanceOfSubDirectory(e))if(n){(0,i.v)(Xw(r),15);const e=this.pendingClearMessageIds.shift();(0,i.v)(e===r.pendingMessageId,810)}else this.clearExceptPendingKeys(!1)}applyStashedClearMessage(e){this.throwIfDisposed();const t=new Map(this._storage);this.clearExceptPendingKeys(!0);const n=++this.pendingMessageId;this.pendingClearMessageIds.push(n);return{type:"clear",pendingMessageId:n,previousStorage:t}}processDeleteMessage(e,t,n,r){this.throwIfDisposed(),this.isMessageForCurrentInstanceOfSubDirectory(e)&&this.needProcessStorageOperation(t,n,r)&&this.deleteCore(t.key,n)}applyStashedDeleteMessage(e){this.throwIfDisposed();const t=this.deleteCore(e.key,!0);return{type:"edit",pendingMessageId:this.getKeyMessageId(e),previousValue:t}}processSetMessage(e,t,n,r,i){this.throwIfDisposed(),this.isMessageForCurrentInstanceOfSubDirectory(e)&&this.needProcessStorageOperation(t,r,i)&&this.setCore(t.key,n,r)}applyStashedSetMessage(e,t){this.throwIfDisposed();const n=this.setCore(e.key,t,!0);return{type:"edit",pendingMessageId:this.getKeyMessageId(e),previousValue:n}}processCreateSubDirectoryMessage(e,t,n,r){this.throwIfDisposed(),this.isMessageForCurrentInstanceOfSubDirectory(e)&&this.needProcessSubDirectoryOperation(e,t,n,r)&&(eC(e.clientId),this.createSubDirectoryCore(t.subdirName,n,{seq:e.sequenceNumber,clientSeq:e.clientSequenceNumber},e.clientId))}applyStashedCreateSubDirMessage(e){var t;this.throwIfDisposed(),this.createSubDirectoryCore(e.subdirName,!0,this.getLocalSeq(),null!==(t=this.runtime.clientId)&&void 0!==t?t:"detached"),this.updatePendingSubDirMessageCount(e);return{type:"createSubDir"}}processDeleteSubDirectoryMessage(e,t,n,r){this.throwIfDisposed(),this.isMessageForCurrentInstanceOfSubDirectory(e)&&this.needProcessSubDirectoryOperation(e,t,n,r)&&this.deleteSubDirectoryCore(t.subdirName,n)}applyStashedDeleteSubDirMessage(e){this.throwIfDisposed();const t=this.deleteSubDirectoryCore(e.subdirName,!0);this.updatePendingSubDirMessageCount(e);return{type:"deleteSubDir",subDirectory:t}}submitClearMessage(e,t){this.throwIfDisposed();const n=++this.pendingMessageId;this.pendingClearMessageIds.push(n);const r={type:"clear",pendingMessageId:n,previousStorage:t};this.directory.submitDirectoryMessage(e,r)}resubmitClearMessage(e,t){(0,i.v)(Xw(t),811);this.pendingClearMessageIds.shift()===t.pendingMessageId&&this.submitClearMessage(e,t.previousStorage)}getKeyMessageId(e){const t=++this.pendingMessageId,n=this.pendingKeys.get(e.key);return void 0!==n?n.push(t):this.pendingKeys.set(e.key,[t]),t}submitKeyMessage(e,t){this.throwIfDisposed();const n={type:"edit",pendingMessageId:this.getKeyMessageId(e),previousValue:t};this.directory.submitDirectoryMessage(e,n)}resubmitKeyMessage(e,t){(0,i.v)(Qw(t),813);const n=this.pendingKeys.get(e.key);if(void 0!==n){const r=n.findIndex((e=>e===t.pendingMessageId));if(-1===r)return;n.splice(r,1),0===n.length&&this.pendingKeys.delete(e.key),this.submitKeyMessage(e,t.previousValue)}}incrementPendingSubDirCount(e,t){var n;const r=null!==(n=e.get(t))&&void 0!==n?n:0;e.set(t,r+1)}decrementPendingSubDirCount(e,t){var n;const r=null!==(n=e.get(t))&&void 0!==n?n:0;e.set(t,r-1),r<=1&&e.delete(t)}updatePendingSubDirMessageCount(e){"deleteSubDirectory"===e.type?this.incrementPendingSubDirCount(this.pendingDeleteSubDirectoriesTracker,e.subdirName):"createSubDirectory"===e.type&&this.incrementPendingSubDirCount(this.pendingCreateSubDirectoriesTracker,e.subdirName)}submitCreateSubDirectoryMessage(e){this.throwIfDisposed(),this.updatePendingSubDirMessageCount(e);this.directory.submitDirectoryMessage(e,{type:"createSubDir"})}submitDeleteSubDirectoryMessage(e,t){this.throwIfDisposed(),this.updatePendingSubDirMessageCount(e);const n={type:"deleteSubDir",subDirectory:t};this.directory.submitDirectoryMessage(e,n)}resubmitSubDirectoryMessage(e,t){(0,i.v)(Yw(t),815),("createSubDir"!==t.type||this.pendingCreateSubDirectoriesTracker.has(e.subdirName))&&("deleteSubDir"!==t.type||this.pendingDeleteSubDirectoriesTracker.has(e.subdirName))&&("createSubDir"===t.type?(this.decrementPendingSubDirCount(this.pendingCreateSubDirectoriesTracker,e.subdirName),this.submitCreateSubDirectoryMessage(e)):(this.decrementPendingSubDirCount(this.pendingDeleteSubDirectoriesTracker,e.subdirName),this.submitDeleteSubDirectoryMessage(e,t.subDirectory)))}*getSerializedStorage(e){this.throwIfDisposed();for(const[t,n]of this._storage){const r=[t,n.makeSerialized(e,this.directory.handle)];yield r}}getSerializableCreateInfo(){this.throwIfDisposed();return{csn:this.seqData.seq,ccIds:Array.from(this.clientIds)}}populateStorage(e,t){this.throwIfDisposed(),this._storage.set(e,t)}populateSubDirectory(e,t){this.throwIfDisposed(),this._subdirectories.set(e,t)}getLocalValue(e){return this.throwIfDisposed(),this._storage.get(e)}rollbackPendingMessageId(e,t,n){const r=e.get(t),i=null===r||void 0===r?void 0:r.pop();if(!r||i!==n)throw new Error("Rollback op does not match last pending");0===r.length&&e.delete(t)}rollback(e,t){if(!(Qw(n=t)||Xw(n)||Yw(n)))throw new Error("Invalid localOpMetadata");var n;if("clear"===e.type&&"clear"===t.type){for(const[n,r]of t.previousStorage.entries())this.setCore(n,r,!0);const e=this.pendingClearMessageIds.pop();if(void 0===e||e!==t.pendingMessageId)throw new Error("Rollback op does match last clear")}else if("delete"!==e.type&&"set"!==e.type||"edit"!==t.type)if("createSubDirectory"===e.type&&"createSubDir"===t.type)this.deleteSubDirectoryCore(e.subdirName,!0),this.decrementPendingSubDirCount(this.pendingCreateSubDirectoriesTracker,e.subdirName);else{if("deleteSubDirectory"!==e.type||"deleteSubDir"!==t.type)throw new Error("Unsupported op for rollback");void 0!==t.subDirectory&&(this.undeleteSubDirectoryTree(t.subDirectory),this._subdirectories.set(e.subdirName,t.subDirectory),Jw(t.subDirectory.seqData)?this.ackedCreationSeqTracker.set(e.subdirName,{...t.subDirectory.seqData}):this.localCreationSeqTracker.set(e.subdirName,{...t.subDirectory.seqData}),this.emit("subDirectoryCreated",e.subdirName,!0,this)),this.decrementPendingSubDirCount(this.pendingDeleteSubDirectoriesTracker,e.subDirName)}else void 0===t.previousValue?this.deleteCore(e.key,!0):this.setCore(e.key,t.previousValue,!0),this.rollbackPendingMessageId(this.pendingKeys,e.key,t.pendingMessageId)}makeAbsolute(e){return Vw.resolve(this.absolutePath,e)}needProcessStorageOperation(e,t,n){if(this.pendingClearMessageIds.length>0){if(t){(0,i.v)(void 0!==n&&Qw(n)&&n.pendingMessageId<this.pendingClearMessageIds[0],16);const t=this.pendingClearMessageIds[0],r=this.pendingKeys.get(e.key);if(void 0!==r){let n=0;for(;r[n]<t;)n+=1;const i=r.splice(n);0===i.length?this.pendingKeys.delete(e.key):this.pendingKeys.set(e.key,i)}}return!1}const r=this.pendingKeys.get(e.key);return void 0!==r?(t&&((0,i.v)(void 0!==n&&Qw(n),17),(0,i.v)(r[0]===n.pendingMessageId,817),r.shift(),0===r.length&&this.pendingKeys.delete(e.key)),!1):!t}isMessageForCurrentInstanceOfSubDirectory(e){return null!==e.clientId&&this.clientIds.has(e.clientId)||this.clientIds.has("detached")||-1!==this.seqData.seq&&this.seqData.seq<=e.referenceSequenceNumber}needProcessSubDirectoryOperation(e,t,n,r){eC(e.clientId);const s=this.pendingDeleteSubDirectoriesTracker.get(t.subdirName),o=this.pendingCreateSubDirectoriesTracker.get(t.subdirName);if(void 0!==s&&s>0||void 0!==o&&o>0){if(n&&((0,i.v)(Yw(r),18),"deleteSubDir"===r.type?((0,i.v)(void 0!==s&&s>0,1730),this.decrementPendingSubDirCount(this.pendingDeleteSubDirectoriesTracker,t.subdirName)):"createSubDir"===r.type&&((0,i.v)(void 0!==o&&o>0,1731),this.decrementPendingSubDirCount(this.pendingCreateSubDirectoriesTracker,t.subdirName))),"deleteSubDirectory"===t.type){const e=t=>{if(!t)return;t.clearExceptPendingKeys(n),t.seqData.seq=-1,t.seqData.clientSeq=-1,t.clientIds.clear();const r=t.subdirectories();for(const[n,i]of r)t.pendingCreateSubDirectoriesTracker.has(n)?e(i):t.deleteSubDirectoryCore(n,!1)},r=this._subdirectories.get(t.subdirName);this.ackedCreationSeqTracker.delete(t.subdirName),e(r)}if("createSubDirectory"===t.type){const r=this._subdirectories.get(t.subdirName);-1!==this.seqData.seq&&this.seqData.seq<=e.sequenceNumber&&(-1===(null===r||void 0===r?void 0:r.seqData.seq)&&(r.seqData.seq=e.sequenceNumber,r.seqData.clientSeq=e.clientSequenceNumber,this.ackedCreationSeqTracker.has(t.subdirName)||this.pendingDeleteSubDirectoriesTracker.has(t.subdirName)||(this.ackedCreationSeqTracker.set(t.subdirName,{seq:e.sequenceNumber,clientSeq:e.clientSequenceNumber}),n&&this.localCreationSeqTracker.delete(t.subdirName))),void 0!==r&&!r.clientIds.has(e.clientId)&&r.seqData.seq<=e.sequenceNumber&&r.clientIds.add(e.clientId))}return!1}return!n}clearExceptPendingKeys(e){const t=new Map;for(const[n]of this.pendingKeys){const e=this._storage.get(n);void 0!==e&&t.set(n,e)}this.clearCore(e);for(const[n,r]of t.entries())this.setCore(n,r,!0)}clearCore(e){this._storage.clear(),this.directory.emit("clear",e,this.directory)}deleteCore(e,t){const n=this._storage.get(e),r=null===n||void 0===n?void 0:n.value;if(this._storage.delete(e)){const n={key:e,path:this.absolutePath,previousValue:r};this.directory.emit("valueChanged",n,t,this.directory);const i={key:e,previousValue:r};this.emit("containedValueChanged",i,t,this)}return n}setCore(e,t,n){const r=this._storage.get(e),i=null===r||void 0===r?void 0:r.value;this._storage.set(e,t);const s={key:e,path:this.absolutePath,previousValue:i};this.directory.emit("valueChanged",s,n,this.directory);const o={key:e,previousValue:i};return this.emit("containedValueChanged",o,n,this),r}createSubDirectoryCore(e,t,n,r){const i=this._subdirectories.get(e);if(void 0===i){const i=Vw.join(this.absolutePath,e),s=new nC({...n},new Set([r]),this.directory,this.runtime,this.serializer,i,this.logger);return Jw(n)?this.ackedCreationSeqTracker.set(e,{...n}):this.localCreationSeqTracker.set(e,{...n}),this.registerEventsOnSubDirectory(s,e),this._subdirectories.set(e,s),this.emit("subDirectoryCreated",e,t,this),!0}return i.clientIds.add(r),!1}registerEventsOnSubDirectory(e,t){e.on("subDirectoryCreated",((e,n)=>{this.emit("subDirectoryCreated",Vw.join(t,e),n,this)})),e.on("subDirectoryDeleted",((e,n)=>{this.emit("subDirectoryDeleted",Vw.join(t,e),n,this)}))}deleteSubDirectoryCore(e,t){const n=this._subdirectories.get(e);return void 0!==n&&(this._subdirectories.delete(e),this.ackedCreationSeqTracker.has(e)&&this.ackedCreationSeqTracker.delete(e),this.localCreationSeqTracker.has(e)&&this.localCreationSeqTracker.delete(e),this.disposeSubDirectoryTree(n),this.emit("subDirectoryDeleted",e,t,this)),n}disposeSubDirectoryTree(e){if(!e)return;const t=e.subdirectories();for(const[n,r]of t)this.disposeSubDirectoryTree(r);"function"===typeof e.dispose&&e.dispose()}undeleteSubDirectoryTree(e){e.undispose();for(const[t,n]of e.subdirectories())this.undeleteSubDirectoryTree(n)}}function rC(e){return void 0!==e&&"number"===typeof e.pendingMessageId&&("add"===e.type||"edit"===e.type)}function iC(e){return void 0!==e&&"clear"===e.type&&"number"===typeof e.pendingMessageId}function sC(e,t,n){return{type:"clear",pendingMessageId:t,previousMap:n}}function oC(e,t,n){return n?{type:"edit",pendingMessageId:t,previousValue:n}:{type:"add",pendingMessageId:t}}class aC{get size(){return this.data.size}constructor(e,t,n,r,i){this.serializer=e,this.handle=t,this.submitMessage=n,this.isAttached=r,this.eventEmitter=i,this.messageHandlers=new Map,this.data=new Map,this.pendingKeys=new Map,this.pendingMessageId=-1,this.pendingClearMessageIds=[],this.localValueMaker=new jw(e),this.messageHandlers=this.getMessageHandlers()}keys(){return this.data.keys()}entries(){const e=this.data.entries();return{next(){const t=e.next();return t.done?{value:void 0,done:!0}:{value:[t.value[0],t.value[1].value],done:!1}},[Symbol.iterator](){return this}}}values(){const e=this.data.values();return{next(){const t=e.next();return t.done?{value:void 0,done:!0}:{value:t.value.value,done:!1}},[Symbol.iterator](){return this}}}[Symbol.iterator](){return this.entries()}forEach(e){this.data.forEach(((t,n,r)=>{e(t.value,n,r)}))}get(e){const t=this.data.get(e);return void 0===t?void 0:t.value}has(e){return this.data.has(e)}set(e,t){if(void 0===e||null===e)throw new Error("Undefined and null keys are not supported");const n=this.localValueMaker.fromInMemory(t),r=qw(n,this.serializer,this.handle),i=this.setCore(e,n,!0);if(!this.isAttached())return;const s={key:e,type:"set",value:r};this.submitMapKeyMessage(s,i)}delete(e){const t=this.deleteCore(e,!0);if(!this.isAttached())return void 0!==t;const n={key:e,type:"delete"};return this.submitMapKeyMessage(n,t),void 0!==t}clear(){const e=this.isAttached()?new Map(this.data):void 0;if(this.clearCore(!0),this.pendingKeys.clear(),!this.isAttached())return;this.submitMapClearMessage({type:"clear"},e)}getSerializedStorage(e){const t={};for(const[n,r]of this.data.entries())t[n]=r.makeSerialized(e,this.handle);return t}getSerializableStorage(e){const t={};for(const[n,r]of this.data.entries())t[n]=qw(r,e,this.handle);return t}serialize(e){return JSON.stringify(this.getSerializableStorage(e))}populateFromSerializable(e){for(const[t,n]of Object.entries(e)){const e={key:t,value:this.makeLocal(t,n)};this.data.set(e.key,e.value)}}populate(e){this.populateFromSerializable(JSON.parse(e))}trySubmitMessage(e,t){const n=this.messageHandlers.get(e.type);return void 0!==n&&(n.submit(e,t),!0)}tryApplyStashedOp(e){const t=this.messageHandlers.get(e.type);if(void 0===t)throw new Error("no apply stashed op handler");return t.applyStashedOp(e)}tryProcessMessage(e,t,n){const r=this.messageHandlers.get(e.type);return void 0!==r&&(r.process(e,t,n),!0)}rollback(e,t){if(void 0===(n=t)||"number"!==typeof n.pendingMessageId||"add"!==n.type&&"edit"!==n.type&&"clear"!==n.type)throw new Error("Invalid localOpMetadata");var n;if("clear"===e.type&&"clear"===t.type){if(void 0===t.previousMap)throw new Error("Cannot rollback without previous map");for(const[n,r]of t.previousMap.entries())this.setCore(n,r,!0);const e=this.pendingClearMessageIds.pop();if(void 0===e||e!==t.pendingMessageId)throw new Error("Rollback op does match last clear")}else{if("delete"!==e.type&&"set"!==e.type)throw new Error("Unsupported op for rollback");{if("add"===t.type)this.deleteCore(e.key,!0);else{if("edit"!==t.type||void 0===t.previousValue)throw new Error("Cannot rollback without previous value");this.setCore(e.key,t.previousValue,!0)}const n=this.pendingKeys.get(e.key),r=null===n||void 0===n?void 0:n.pop();if(!n||r!==t.pendingMessageId)throw new Error("Rollback op does not match last pending");0===n.length&&this.pendingKeys.delete(e.key)}}}setCore(e,t,n){const r=this.data.get(e),i=null===r||void 0===r?void 0:r.value;return this.data.set(e,t),this.eventEmitter.emit("valueChanged",{key:e,previousValue:i},n,this.eventEmitter),r}clearCore(e){this.data.clear(),this.eventEmitter.emit("clear",e,this.eventEmitter)}deleteCore(e,t){const n=this.data.get(e),r=null===n||void 0===n?void 0:n.value;return this.data.delete(e)&&this.eventEmitter.emit("valueChanged",{key:e,previousValue:r},t,this.eventEmitter),n}clearExceptPendingKeys(){const e=new Map;for(const t of this.pendingKeys.keys())this.data.has(t)&&e.set(t,this.data.get(t));this.clearCore(!1);for(const[t,n]of e.entries())this.setCore(t,n,!0)}makeLocal(e,t){if(t.type===Pw[Pw.Plain]||t.type===Pw[Pw.Shared])return this.localValueMaker.fromSerializable(t);throw new Error("Unknown local value type")}needProcessKeyOperation(e,t,n){if(this.pendingClearMessageIds.length>0)return t&&(0,i.v)(void 0!==n&&rC(n)&&n.pendingMessageId<this.pendingClearMessageIds[0],19),!1;const r=this.pendingKeys.get(e.key);return void 0!==r?(t&&((0,i.v)(void 0!==n&&rC(n),20),(0,i.v)(r[0]===n.pendingMessageId,762),r.shift(),0===r.length&&this.pendingKeys.delete(e.key)),!1):!t}getMessageHandlers(){const e=new Map;return e.set("clear",{process:(e,t,n)=>{if(t){(0,i.v)(iC(n),21);const e=this.pendingClearMessageIds.shift();(0,i.v)(e===n.pendingMessageId,763)}else this.pendingKeys.size>0?this.clearExceptPendingKeys():this.clearCore(t)},submit:(e,t)=>{(0,i.v)(iC(t),764);const n=this.pendingClearMessageIds.shift();(0,i.v)(n===t.pendingMessageId,765),this.submitMapClearMessage(e,t.previousMap)},applyStashedOp:e=>{const t=new Map(this.data);return this.clearCore(!0),sC(0,this.getMapClearMessageId(),t)}}),e.set("delete",{process:(e,t,n)=>{this.needProcessKeyOperation(e,t,n)&&this.deleteCore(e.key,t)},submit:(e,t)=>{this.resubmitMapKeyMessage(e,t)},applyStashedOp:e=>{const t=this.deleteCore(e.key,!0);return oC(0,this.getMapKeyMessageId(e),t)}}),e.set("set",{process:(e,t,n)=>{if(!this.needProcessKeyOperation(e,t,n))return;const r=this.makeLocal(e.key,e.value);this.setCore(e.key,r,t)},submit:(e,t)=>{this.resubmitMapKeyMessage(e,t)},applyStashedOp:e=>{const t=this.makeLocal(e.key,e.value),n=this.setCore(e.key,t,!0);return oC(0,this.getMapKeyMessageId(e),n)}}),e}getMapClearMessageId(){const e=++this.pendingMessageId;return this.pendingClearMessageIds.push(e),e}submitMapClearMessage(e,t){const n=sC(0,this.getMapClearMessageId(),t);this.submitMessage(e,n)}getMapKeyMessageId(e){const t=++this.pendingMessageId,n=this.pendingKeys.get(e.key);return void 0!==n?n.push(t):this.pendingKeys.set(e.key,[t]),t}submitMapKeyMessage(e,t){const n=oC(0,this.getMapKeyMessageId(e),t);this.submitMessage(e,n)}resubmitMapKeyMessage(e,t){(0,i.v)(rC(t),766);const n=this.pendingKeys.get(e.key);if(void 0===n)return;const r=n.findIndex((e=>e===t.pendingMessageId));if(-1===r)return;n.splice(r,1),0===n.length&&this.pendingKeys.delete(e.key);const s=this.getMapKeyMessageId(e),o="edit"===t.type?{type:"edit",pendingMessageId:s,previousValue:t.previousValue}:{type:"add",pendingMessageId:s};this.submitMessage(e,o)}}var cC;const lC="header";class uC{get type(){return uC.Type}get attributes(){return uC.Attributes}async load(e,t,n,r){const i=new hC(t,e,r);return await i.load(n),i}create(e,t){const n=new hC(t,e,uC.Attributes);return n.initializeLocal(),n}}uC.Type="https://graph.microsoft.com/types/map",uC.Attributes={type:uC.Type,snapshotFormatVersion:"0.2",packageVersion:zw};class hC extends go{static create(e,t){return e.createChannel(t,uC.Type)}static getFactory(){return new uC}constructor(e,t,n){super(e,t,n,"fluid_map_"),this[cC]="SharedMap",this.kernel=new aC(this.serializer,this.handle,((e,t)=>this.submitLocalMessage(e,t)),(()=>this.isAttached()),this)}keys(){return this.kernel.keys()}entries(){return this.kernel.entries()}values(){return this.kernel.values()}[(cC=Symbol.toStringTag,Symbol.iterator)](){return this.kernel.entries()}get size(){return this.kernel.size}forEach(e){this.kernel.forEach(e)}get(e){return this.kernel.get(e)}has(e){return this.kernel.has(e)}set(e,t){return this.kernel.set(e,t),this}delete(e){return this.kernel.delete(e)}clear(){this.kernel.clear()}summarizeCore(e,t){let n=0,r=0,i={};const s=[],o=new Pt,a=this.kernel.getSerializedStorage(e);for(const l of Object.keys(a)){const e=a[l];if(e.value&&e.value.length>=8192){const t="blob".concat(r);r++,s.push(t);const n={[l]:{type:e.type,value:JSON.parse(e.value)}};o.addBlob(t,JSON.stringify(n))}else{if(n+=e.type.length+21,e.value&&(n+=e.value.length),n>16384){const e="blob".concat(r);r++,s.push(e),o.addBlob(e,JSON.stringify(i)),i={},n=0}i[l]={type:e.type,value:void 0===e.value?void 0:JSON.parse(e.value)}}}const c={blobs:s,content:i};return o.addBlob(lC,JSON.stringify(c)),o.getSummaryTree()}async loadCore(e){const t=await vn(e,lC),n=t;Array.isArray(n.blobs)?(this.kernel.populateFromSerializable(n.content),await Promise.all(n.blobs.map((async t=>{const n=await vn(e,t);this.kernel.populateFromSerializable(n)})))):this.kernel.populateFromSerializable(t)}onDisconnect(){}reSubmitCore(e,t){this.kernel.trySubmitMessage(e,t)}applyStashedOp(e){return this.kernel.tryApplyStashedOp(e)}processCore(e,t,n){e.type===pn.Operation&&this.kernel.tryProcessMessage(e.contents,t,n)}rollback(e,t){this.kernel.rollback(e,t)}}class dC extends Zt{get id(){return this.runtime.id}get IFluidLoadable(){return this}get IFluidHandle(){return this.handle}get handle(){return(0,i.v)(void 0!==this.runtime.entryPoint,1131),this.runtime.entryPoint}static async getDataObject(e){return await e.entryPoint.get()}constructor(e){super(),this.runtime=e.runtime,this.context=e.context,this.providers=e.providers,this.initProps=e.initProps,(0,i.v)(void 0===this.runtime._dataObject,189),this.runtime._dataObject=this}async request(e){return""===e.url||"/"===e.url||e.url.startsWith("/?")?{mimeType:"fluid/object",status:200,value:this}:Sn(e)}async finishInitialization(e){return void 0!==this.initializeP||(this.initializeP=this.initializeInternal(e)),this.initializeP}async initializeInternal(e){var t;(await this.preInitialize(),e)?((0,i.v)(void 0===this.initProps,190),await this.initializingFromExisting()):await this.initializingFirstTime(null!==(t=this.context.createProps)&&void 0!==t?t:this.initProps);await this.hasInitialized()}async preInitialize(){}async initializingFirstTime(e){}async initializingFromExisting(){}async hasInitialized(){}}class fC extends dC{constructor(){super(...arguments),this.rootDirectoryId="root"}get root(){if(!this.internalRoot)throw new Error(this.getUninitializedErrorString("root"));return this.internalRoot}async initializeInternal(e){e?(this.internalRoot=await this.runtime.getChannel(this.rootDirectoryId),this.internalRoot.attributes.type===uC.Type&&this.runtime.logger.send({category:"generic",eventName:"MapDataObject",message:"Legacy document, SharedMap is masquerading as SharedDirectory in DataObject"})):(this.internalRoot=$w.create(this.runtime,this.rootDirectoryId),this.internalRoot.bindToContext()),await super.initializeInternal(e)}getUninitializedErrorString(e){return"".concat(e," must be initialized before being accessed.")}}class pC{constructor(){this.handlers=[]}pushHandler(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];void 0!==t&&this.handlers.push(...t)}async handleRequest(e,t){const n=Cn.create(e);for(const r of this.handlers){const e=await r(n,t);if(void 0!==e)return e}return Sn(e)}}function mC(){const e=new pC;return e.pushHandler(...arguments),async(t,n)=>e.handleRequest(t,n)}const gC="IFluidDependencySynthesizer";class vC{get IFluidDependencySynthesizer(){return this}constructor(){this.providers=new Map;for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];this.parents=t.filter((e=>void 0!==e))}register(e,t){if(this.providers.has(e))throw new Error("Attempting to register a provider of type ".concat(String(e)," that already exists"));this.providers.set(e,t)}unregister(e){this.providers.has(e)&&this.providers.delete(e)}synthesize(e,t){const n={};return this.generateRequired(n,t),this.generateOptional(n,e),Object.defineProperty(n,gC,{get:()=>this}),n}has(e,t){return!!this.providers.has(e)||!0!==t&&this.parents.some((t=>t.has(e)))}getProvider(e){if(this.has(e)){if(this.providers.has(e))return this.providers.get(e);for(const t of this.parents){if(t instanceof vC)return t.getProvider(e);{const n=t;if(void 0!==(null===n||void 0===n?void 0:n.getProvider))return n.getProvider(e)}}}}generateRequired(e,t){if(void 0!==t)for(const n of Object.keys(t)){const t=this.resolveProvider(n);if(void 0===t)throw new Error("Object attempted to be created without registered required provider ".concat(String(n)));Object.defineProperty(e,n,t)}}generateOptional(e,t){if(void 0!==t)for(const r of Object.keys(t)){var n;const t=null!==(n=this.resolveProvider(r))&&void 0!==n?n:{get:async()=>{}};Object.defineProperty(e,r,t)}}resolveProvider(e){const t=this.providers.get(e);if(void 0!==t)return"function"===typeof t?{get(){if(t&&"function"===typeof t)return Promise.resolve(this[gC]).then((async e=>t(e))).then((t=>null===t||void 0===t?void 0:t[e]))}}:{get(){if(t)return new an.I((async()=>Promise.resolve(t).then((t=>{if(t)return t[e]}))))}};for(const n of this.parents){const t={[e]:e},r=n.synthesize(t,{}),i=Object.getOwnPropertyDescriptor(r,e);if(void 0!==i)return i}}}class yC{get IRuntimeFactory(){return this}async instantiateRuntime(e,t){const n=await this.preInitialize(e,t);return await(t?this.instantiateFromExisting(n):this.instantiateFirstTime(n)),await this.hasInitialized(n),n}async instantiateFirstTime(e){}async instantiateFromExisting(e){}async hasInitialized(e){}}class bC extends yC{get IFluidDataStoreRegistry(){return this.registry}constructor(e){var t;super(),this.registryEntries=e.registryEntries,this.dependencyContainer=e.dependencyContainer,this.runtimeOptions=e.runtimeOptions,this.provideEntryPoint=e.provideEntryPoint,this.requestHandlers=null!==(t=e.requestHandlers)&&void 0!==t?t:[],this.registry=new Dn(this.registryEntries)}async instantiateFirstTime(e){await this.containerInitializingFirstTime(e),await this.containerHasInitialized(e)}async instantiateFromExisting(e){await this.containerHasInitialized(e)}async preInitialize(e,t){const n=e.scope;if(this.dependencyContainer){const e=new vC(this.dependencyContainer,n.IFluidDependencySynthesizer);n.IFluidDependencySynthesizer=e}return lo.loadRuntime({context:e,existing:t,runtimeOptions:this.runtimeOptions,registryEntries:this.registryEntries,containerScope:n,requestHandler:mC(...this.requestHandlers),provideEntryPoint:this.provideEntryPoint})}async containerInitializingFirstTime(e){}async containerHasInitialized(e){}}const SC={randomUUID:"undefined"!==typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let wC;const CC=new Uint8Array(16);function xC(){if(!wC&&(wC="undefined"!==typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!wC))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return wC(CC)}const EC=[];for(let n=0;n<256;++n)EC.push((n+256).toString(16).slice(1));function TC(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return EC[e[t+0]]+EC[e[t+1]]+EC[e[t+2]]+EC[e[t+3]]+"-"+EC[e[t+4]]+EC[e[t+5]]+"-"+EC[e[t+6]]+EC[e[t+7]]+"-"+EC[e[t+8]]+EC[e[t+9]]+"-"+EC[e[t+10]]+EC[e[t+11]]+EC[e[t+12]]+EC[e[t+13]]+EC[e[t+14]]+EC[e[t+15]]}const kC=function(e,t,n){if(SC.randomUUID&&!t&&!e)return SC.randomUUID();const r=(e=e||{}).random||(e.rng||xC)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return TC(r)};function NC(e){let t=e;return t.startsWith("/")&&(t=t.substr(1)),t.endsWith("/")&&(t=t.substr(0,t.length-1)),t.length>0?t.split("/"):[]}class FC{static flattenTree(e,t,n){for(const r in t.trees)FC.flattenTree("".concat(e).concat(r,"/"),t.trees[r],n);for(const r in t.blobs)n["".concat(e).concat(r)]=t.blobs[r]}constructor(e,t,n,r){this.tree=e,this.storage=t,this.logger=n,this.extraBlobs=r,this.flattenedTree={},void 0!==e&&FC.flattenTree("",e,this.flattenedTree)}async contains(e){return void 0!==this.flattenedTree[e]}async readBlob(e){const t=await this.getIdForPath(e),n=void 0!==this.extraBlobs?this.extraBlobs.get(t):void 0;if(void 0!==n)return n;const r=this.storage.readBlob(t);return r.catch((e=>this.logger.sendErrorEvent({eventName:"ChannelStorageBlobError"},e))),r}async list(e){var t,n;let r=this.tree;const i=NC(e);for(;void 0!==r&&i.length>0;){const e=i.shift();r=r.trees[e]}if(void 0===r||0!==i.length)throw new Error("path does not exist");return Object.keys(null!==(t=null===(n=r)||void 0===n?void 0:n.blobs)&&void 0!==t?t:{})}async getIdForPath(e){return this.flattenedTree[e]}}class IC{get handler(){return(0,i.v)(!!this._handler,375),this._handler}get connected(){return this._connected}constructor(e,t,n,r){this._connected=e,this.submit=t,this.dirty=n,this.addedGCOutboundReference=r}attach(e){(0,i.v)(void 0===this._handler,376),this._handler=e}setConnectionState(e){this._connected=e,this.handler.setConnectionState(e)}process(e,t,n){try{this.handler.process(e,t,n)}catch(r){throw h.wrapIfUnrecognized(r,"channelDeltaConnectionFailedToProcessMessage",e)}}reSubmit(e,t){this.handler.reSubmit(e,t)}rollback(e,t){if(void 0===this.handler.rollback)throw new Error("Handler doesn't support rollback");this.handler.rollback(e,t)}applyStashedOp(e){return this.handler.applyStashedOp(e)}}const AC=".attributes";function DC(e,t,n,r,i,s,o,a){return{deltaConnection:new IC(e,((e,n)=>t(e,n)),n,r),objectStorage:new FC(o,i,s,a)}}function OC(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3?arguments[3]:void 0;const i=e.getAttachSummary(t,n,r);return Ot(i,AC,JSON.stringify(e.attributes)),i}async function PC(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0;const s=await e.summarize(t,n,r,i);return Ot(s,AC,JSON.stringify(e.attributes)),s}async function RC(e,t,n,r,i){var s;let o;await t.objectStorage.contains(AC)&&(o=await vn(t.objectStorage,AC));const a=o?o.type:i;if(void 0===a)throw new u("channelTypeNotAvailable",(0,Xt.Df)({channelId:n,dataStoreId:e.id,dataStorePackagePath:e.packagePath.join("/"),channelFactoryType:a}));const c=r.get(a);if(void 0===c)throw new u("channelFactoryNotRegisteredForGivenType",(0,Xt.Df)({channelId:n,dataStoreId:e.id,dataStorePackagePath:e.packagePath.join("/"),channelFactoryType:a}));return o=null!==(s=o)&&void 0!==s?s:c.attributes,{factory:c,attributes:o}}async function MC(e,t,n,r,i,s){return void 0!==t.snapshotFormatVersion&&t.snapshotFormatVersion!==n.attributes.snapshotFormatVersion&&i.sendTelemetryEvent({eventName:"ChannelAttributesVersionMismatch",...(0,Xt.Df)({channelType:t.type,channelSnapshotVersion:"".concat(t.snapshotFormatVersion,"@").concat(t.packageVersion),channelCodeVersion:"".concat(n.attributes.snapshotFormatVersion,"@").concat(n.attributes.packageVersion)})}),n.load(e,s,r,t)}class BC{constructor(e,t,n,r,s){this.id=e,this.runtime=t,this.services=n,this.channelP=r,this._channel=s,this.globallyVisible=!1,this.pending=[],(0,i.v)(!this.id.includes("/"),783)}async getChannel(){return void 0===this._channel?this.channelP.then((e=>this._channel=e)):this.channelP}get isLoaded(){return void 0!==this._channel}setConnectionState(e,t){this.globallyVisible&&this.isLoaded&&this.services.value.deltaConnection.setConnectionState(e)}processOp(e,t,n){(0,i.v)(this.globallyVisible,723),this.isLoaded?this.services.value.deltaConnection.process(e,t,n):((0,i.v)(!1===t,393),this.pending.push(e))}reSubmit(e,t){(0,i.v)(this.isLoaded,394),(0,i.v)(this.globallyVisible,724),this.services.value.deltaConnection.reSubmit(e,t)}rollback(e,t){(0,i.v)(this.isLoaded,750),(0,i.v)(this.globallyVisible,751),this.services.value.deltaConnection.rollback(e,t)}applyStashedOp(){throw new Error("no stashed ops on local channel")}async summarize(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0;return PC(await this.getChannel(),e,t,n)}getAttachSummary(e){return(0,i.v)(void 0!==this._channel,397),OC(this._channel,!0,!1,e)}getAttachGCData(e){return(0,i.v)(void 0!==this._channel,"Local Channel should be loaded before being attached"),this._channel.getGCData(!0)}makeVisible(){if(this.globallyVisible)throw new Error("Channel is already globally visible");this.isLoaded&&((0,i.v)(!!this._channel,402),this._channel.connect(this.services.value)),this.globallyVisible=!0}async getGCData(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.getChannel()).getGCData(e)}updateUsedRoutes(e){}}class LC extends BC{constructor(e,t,n,r,i,s,o,a,c,l){super(e,n,new an.d((()=>{const e=new Map,t=_C(this.snapshotTree);return this.isSnapshotInOldFormatAndCollectBlobs(t,e)&&this.sanitizeSnapshot(t),DC(r.connected,o,this.dirtyFn,c,i,s,t,e)})),new an.I((async()=>{try{const{attributes:e,factory:i}=await RC(r,this.services.value,this.id,t),o=await MC(n,e,i,this.services.value,s,this.id);for(const t of this.pending)this.services.value.deltaConnection.process(t,!1,void 0);return o}catch(ux){throw h.wrapIfUnrecognized(ux,"rehydratedLocalChannelContextFailedToLoadChannel",void 0)}}))),this.snapshotTree=l,this.dirtyFn=()=>{a(e)}}isSnapshotInOldFormatAndCollectBlobs(e,t){let n=!1;const r=e.blobsContents;void 0!==r&&Object.entries(r).forEach((r=>{let[i,s]=r;t.set(i,s),void 0!==e.blobs[i]&&(n=!0)}));for(const i of Object.values(e.trees))n=n||this.isSnapshotInOldFormatAndCollectBlobs(i,t);return n}sanitizeSnapshot(e){const t=new Map(Object.entries(e.blobs));for(const[n,r]of t.entries()){void 0===t.get(r)&&delete e.blobs[n]}for(const n of Object.values(e.trees))this.sanitizeSnapshot(n)}}class qC extends BC{constructor(e,t,n,r,i,s,o,a){super(e.id,t,new an.d((()=>DC(n.connected,s,this.dirtyFn,a,r,i))),Promise.resolve(e),e),this.channel=e,this.channel=e,this.dirtyFn=()=>{o(e.id)}}}function _C(e){const t={...e,blobs:{...e.blobs},trees:{}};for(const[n,r]of Object.entries(e.trees))t.trees[n]=_C(r);return t}class jC{constructor(e,t,n,r,s,o,a,c,l,u,h,d){this.id=a,this.isLoaded=!1,this.pending=[],(0,i.v)(!this.id.includes("/"),784),this.subLogger=(0,Xt.pW)({logger:e.logger,namespace:"RemoteChannelContext"}),this.services=DC(t.connected,r,(()=>s(this.id)),o,n,this.subLogger,c,u),this.channelP=new an.I((async()=>{const{attributes:n,factory:r}=await RC(t,this.services,this.id,l,d),s=await MC(e,n,r,this.services,this.subLogger,this.id);(0,i.v)(void 0!==this.pending,575);for(const e of this.pending)this.services.deltaConnection.process(e,!1,void 0);return this.thresholdOpsCounter.send("ProcessPendingOps",this.pending.length),this.channel=s,this.pending=void 0,this.isLoaded=!0,this.services.deltaConnection.setConnectionState(t.connected),this.channel}));this.summarizerNode=h((async(e,t,n,r)=>this.summarizeInternal(e,t,n,r)),(async e=>this.getGCDataInternal(e))),this.thresholdOpsCounter=new Fr(jC.pendingOpsCountThreshold,this.subLogger)}getChannel(){return this.channelP}setConnectionState(e,t){this.isLoaded&&this.services.deltaConnection.setConnectionState(e)}applyStashedOp(e){return(0,i.v)(this.isLoaded,404),this.services.deltaConnection.applyStashedOp(e)}processOp(e,t,n){this.summarizerNode.invalidate(e.sequenceNumber),this.isLoaded?this.services.deltaConnection.process(e,t,n):((0,i.v)(!t,405),(0,i.v)(void 0!==this.pending,574),this.pending.push(e),this.thresholdOpsCounter.sendIfMultiple("StorePendingOps",this.pending.length))}reSubmit(e,t){(0,i.v)(this.isLoaded,406),this.services.deltaConnection.reSubmit(e,t)}rollback(e,t){(0,i.v)(this.isLoaded,752),this.services.deltaConnection.rollback(e,t)}async summarize(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0;return this.summarizerNode.summarize(e,t,n)}async summarizeInternal(e,t,n,r){const i=await this.getChannel();return{...await PC(i,e,t,n,r),id:this.id}}async getGCData(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.summarizerNode.getGCData(e)}async getGCDataInternal(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return(await this.getChannel()).getGCData(e)}updateUsedRoutes(e){this.summarizerNode.updateUsedRoutes([""])}}var zC;jC.pendingOpsCountThreshold=1e3,function(e){e.Attach="attach",e.ChannelOp="op"}(zC||(zC={}));class UC extends Zt{get connected(){return this.dataStoreContext.connected}get clientId(){return this.dataStoreContext.clientId}get clientDetails(){return this.dataStoreContext.clientDetails}get isAttached(){return this.attachState!==Qt.Detached}get attachState(){return this._attachState}get absolutePath(){return sn(this.id,this.routeContext)}get routeContext(){return this.dataStoreContext.IFluidHandleContext}get idCompressor(){return this.dataStoreContext.idCompressor}get IFluidHandleContext(){return this}get rootRoutingContext(){return this}get channelsRoutingContext(){return this}get objectsRoutingContext(){return this}get disposed(){return this._disposed}get logger(){return this.mc.logger}ensureNoDataModelChanges(e){return void 0===this.dataStoreContext.ensureNoDataModelChanges?e():this.dataStoreContext.ensureNoDataModelChanges(e)}constructor(e,t,n,r){var s;super(),this.dataStoreContext=e,this.sharedObjectRegistry=t,this._disposed=!1,this.contexts=new Map,this.pendingAttach=new Set,this.deferredAttached=new Ln,this.localChannelContextQueue=new Map,this.notBoundedChannelContextSet=new Set,this.pendingHandlesToMakeVisible=new Set,(0,i.v)(!e.id.includes("/"),782),this.mc=(0,Yt.CL)({logger:e.logger,namespace:"FluidDataStoreRuntime",properties:{all:{dataStoreId:kC()}}}),this.id=e.id,this.options=e.options,this.deltaManager=e.deltaManager,this.quorum=e.getQuorum(),this.audience=e.getAudience();const o=e.baseSnapshot;void 0!==(null===o||void 0===o?void 0:o.trees)&&Object.keys(o.trees).forEach((t=>{if("_search"===t)return;let n;e.isLocalDataStore?(n=new LC(t,this.sharedObjectRegistry,this,this.dataStoreContext,this.dataStoreContext.storage,this.logger,((e,n)=>this.submitChannelOp(t,e,n)),(e=>this.setChannelDirty(e)),((e,t)=>this.addedGCOutboundReference(e,t)),o.trees[t]),e.attachState!==Qt.Detached?n.makeVisible():this.localChannelContextQueue.set(t,n)):n=new jC(this,e,e.storage,((e,n)=>this.submitChannelOp(t,e,n)),(e=>this.setChannelDirty(e)),((e,t)=>this.addedGCOutboundReference(e,t)),t,o.trees[t],this.sharedObjectRegistry,void 0,this.dataStoreContext.getCreateChildSummarizerNodeFn(t,{type:nn.nL.FromSummary})),this.contexts.set(t,n)})),this.entryPoint=new hr(new an.I((async()=>r(this))),"",this.objectsRoutingContext),this.attachListener(),this._attachState=e.attachState,this.visibilityState=n?e.attachState===Qt.Detached?nn.cy.LocallyVisible:nn.cy.GloballyVisible:nn.cy.NotVisible,n&&this.deferredAttached.resolve(),this.localChangesTelemetryCount=null!==(s=this.mc.config.getNumber("Fluid.Telemetry.LocalChangesTelemetryCount"))&&void 0!==s?s:10}dispose(){this._disposed||(this._disposed=!0,this.emit("dispose"),this.removeAllListeners())}async resolveHandle(e){return this.request(e)}async request(e){try{const n=Cn.create(e),r=n.pathParts[0];if("_channels"===r||"_custom"===r)return await this.request(n.createSubRequest(1));const i=this.contexts.get(r);if(void 0!==i&&n.isLeaf(1))try{return{mimeType:"fluid/object",status:200,value:await i.getChannel()}}catch(t){return this.mc.logger.sendErrorEvent({eventName:"GetChannelFailedInRequest"},t),wn(500,"Failed to get Channel: ".concat(t),e)}return Sn(e)}catch(t){return yn(t)}}async getChannel(e){this.verifyNotClosed();const t=this.contexts.get(e);if(void 0===t)throw new o.iq("Channel does not exist");return t.getChannel()}addChannel(e){const t=e.id;if(t.includes("/"))throw new l("Id cannot contain slashes: ".concat(t));this.verifyNotClosed(),(0,i.v)(!this.contexts.has(t),2149);const n=e.attributes.type;if(void 0===this.sharedObjectRegistry.get(e.attributes.type))throw new Error("Channel Factory ".concat(n," not registered"));this.createChannelContext(e),this.identifyLocalChangeInSummarizer("DDSCreatedInSummarizer",t,n)}createChannel(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:kC(),t=arguments.length>1?arguments[1]:void 0;if(e.includes("/"))throw new l("Id cannot contain slashes: ".concat(e));this.verifyNotClosed(),(0,i.v)(!this.contexts.has(e),377),(0,i.v)(void 0!==t,521);const n=this.sharedObjectRegistry.get(t);if(void 0===n)throw new Error("Channel Factory ".concat(t," not registered"));const r=n.create(this,e);return this.createChannelContext(r),this.identifyLocalChangeInSummarizer("DDSCreatedInSummarizer",e,t),r}createChannelContext(e){this.notBoundedChannelContextSet.add(e.id);const t=new qC(e,this,this.dataStoreContext,this.dataStoreContext.storage,this.logger,((t,n)=>this.submitChannelOp(e.id,t,n)),(e=>this.setChannelDirty(e)),((e,t)=>this.addedGCOutboundReference(e,t)));this.contexts.set(e.id,t)}bindChannel(e){(0,i.v)(this.notBoundedChannelContextSet.has(e.id),379),this.notBoundedChannelContextSet.delete(e.id),this.isAttached?this.makeChannelLocallyVisible(e):this.pendingHandlesToMakeVisible.has(e.handle)||(this.bind(e.handle),this.localChannelContextQueue.has(e.id)||this.localChannelContextQueue.set(e.id,this.contexts.get(e.id)))}makeVisibleAndAttachGraph(){this.visibilityState===nn.cy.NotVisible&&(this.visibilityState=nn.cy.LocallyVisible,this.pendingHandlesToMakeVisible.forEach((e=>{e.attachGraph()})),this.pendingHandlesToMakeVisible.clear(),this.dataStoreContext.makeLocallyVisible())}attachGraph(){this.makeVisibleAndAttachGraph()}bind(e){this.visibilityState===nn.cy.NotVisible?this.pendingHandlesToMakeVisible.add(e):e.attachGraph()}setConnectionState(e,t){this.verifyNotClosed();for(const[,n]of this.contexts)n.setConnectionState(e,t);un(this.logger,this,e,t)}getQuorum(){return this.quorum}getAudience(){return this.audience}async uploadBlob(e,t){return this.verifyNotClosed(),this.dataStoreContext.uploadBlob(e,t)}createRemoteChannelContext(e,t){const n=new Map,r=kr(e.snapshot.entries,n);return new jC(this,this.dataStoreContext,this.dataStoreContext.storage,((t,n)=>this.submitChannelOp(e.id,t,n)),(e=>this.setChannelDirty(e)),((e,t)=>this.addedGCOutboundReference(e,t)),e.id,r,this.sharedObjectRegistry,n,this.dataStoreContext.getCreateChildSummarizerNodeFn(e.id,t),e.type)}process(e,t,n){this.verifyNotClosed();try{switch(e.type){case zC.Attach:{const n=e.contents,r=n.id;if(Lt(n.snapshot,((e,t)=>{var n,i;const s="/".concat(this.id,"/").concat(r).concat("/"===e?"":e);null===(n=(i=this.dataStoreContext).addedGCOutboundRoute)||void 0===n||n.call(i,s,t)})),t)(0,i.v)(this.pendingAttach.delete(r),380);else{(0,i.v)(!this.contexts.has(r),381);const t={type:nn.nL.FromAttach,sequenceNumber:e.sequenceNumber,snapshot:n.snapshot},s=this.createRemoteChannelContext(n,t);this.contexts.set(r,s)}break}case zC.ChannelOp:this.processChannelOp(e,t,n)}this.emit("op",e)}catch(r){throw h.wrapIfUnrecognized(r,"fluidDataStoreRuntimeFailedToProcessMessage",e)}}processSignal(e,t){this.emit("signal",e,t)}isChannelAttached(e){return!this.notBoundedChannelContextSet.has(e)&&!this.localChannelContextQueue.has(e)&&!this.pendingAttach.has(e)}getOutboundRoutes(){const e=[];for(const[t]of this.contexts)e.push("".concat(this.absolutePath,"/").concat(t));return e}updateGCNodes(e){e.addRouteToAllNodes(this.absolutePath),e.addNode("/",this.getOutboundRoutes())}async getGCData(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=new jt;return await Promise.all(Array.from(this.contexts).filter((e=>{let[t,n]=e;return this.isChannelAttached(t)})).map((async n=>{let[r,i]=n;const s=await i.getGCData(e);t.prefixAndAddNodes(r,s.gcNodes)}))),this.updateGCNodes(t),t.getGCData()}updateUsedRoutes(e){const t=dr(e);for(const[r]of t)(0,i.v)(this.contexts.has(r),382);for(const[r,i]of this.contexts){var n;i.updateUsedRoutes(null!==(n=t.get(r))&&void 0!==n?n:[])}}addedGCOutboundReference(e,t){var n,r;null===(n=(r=this.dataStoreContext).addedGCOutboundReference)||void 0===n||n.call(r,e,t)}async summarize(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0;const r=new Pt;return await Promise.all(Array.from(this.contexts).filter((e=>{let[t,n]=e;const r=this.isChannelAttached(t);return(0,i.v)(r,383),r})).map((async i=>{let[s,o]=i;const a=await o.summarize(e,t,n);r.addWithStats(s,a)}))),r.getSummaryTree()}getAttachSummary(e){const t=new Pt;return this.visitLocalBoundContextsDuringAttach(((n,r)=>{let s;if(r.isLoaded){const t=r.getAttachSummary(e);(0,i.v)(t.summary.type===Et.Tree,384),s={stats:t.stats,summary:t.summary}}else(0,i.v)(!!this.dataStoreContext.baseSnapshot,385),s=Mt(this.dataStoreContext.baseSnapshot.trees[n]);t.addWithStats(n,s)})),t.getSummaryTree()}getAttachGCData(e){const t=new jt;return this.visitLocalBoundContextsDuringAttach(((n,r)=>{if(r.isLoaded){const i=r.getAttachGCData(e);t.prefixAndAddNodes(n,i.gcNodes)}})),this.updateGCNodes(t),t.getGCData()}visitLocalBoundContextsDuringAttach(e){this.attachGraph();for(const[t,n]of this.contexts){if(!(n instanceof BC))throw new o.iq("Should only be called with local channel handles");this.notBoundedChannelContextSet.has(t)||e(t,n)}}submitMessage(e,t,n){this.submit(e,t,n)}submitSignal(e,t,n){return this.verifyNotClosed(),this.dataStoreContext.submitSignal(e,t,n)}async waitAttached(){return this.deferredAttached.promise}makeChannelLocallyVisible(e){if(this.verifyNotClosed(),e.handle.isAttached)return;e.handle.attachGraph(),(0,i.v)(this.isAttached,386),(0,i.v)(this.visibilityState===nn.cy.GloballyVisible,720);const t=OC(e,!0,!1),n=e.getGCData(!0);Ot(t,nn.xX,JSON.stringify(n));const r=Bt(t.summary),s={id:e.id,snapshot:r,type:e.attributes.type};this.pendingAttach.add(e.id),this.submit(zC.Attach,s);this.contexts.get(e.id).makeVisible()}submitChannelOp(e,t,n){const r={address:e,contents:t};this.submit(zC.ChannelOp,r,n)}submit(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0;this.verifyNotClosed(),this.dataStoreContext.submitMessage(e,t,n)}reSubmit(e,t,n){switch(this.verifyNotClosed(),e){case zC.ChannelOp:{const e=t,r=this.contexts.get(e.address);(0,i.v)(!!r,387),r.reSubmit(e.contents,n);break}case zC.Attach:this.submit(e,t,n);break;default:wt(e)}}rollback(e,t,n){switch(this.verifyNotClosed(),e){case zC.ChannelOp:{const e=t,r=this.contexts.get(e.address);(0,i.v)(!!r,749),r.rollback(e.contents,n);break}default:throw new o.iq("Can't rollback ".concat(e," message"))}}async applyStashedOp(e){const t=null===e||void 0===e?void 0:e.type;switch(t){case zC.Attach:{const t=e.content,n={type:nn.nL.Local},r=this.createRemoteChannelContext(t,n);return this.pendingAttach.add(t.id),void this.contexts.set(t.id,r)}case zC.ChannelOp:{const t=e.content,n=this.contexts.get(t.address);return(0,i.v)(!!n,388),await n.getChannel(),n.applyStashedOp(t.contents)}default:wt(t)}}setChannelDirty(e){this.verifyNotClosed(),this.dataStoreContext.setChannelDirty(e)}processChannelOp(e,t,n){this.verifyNotClosed();const r=e.contents,s={...e,contents:r.contents},o=this.contexts.get(r.address);return(0,i.v)(!!o,389),o.processOp(s,t,n),o}attachListener(){this.setMaxListeners(Number.MAX_SAFE_INTEGER),this.dataStoreContext.once("attaching",(()=>{this.attachGraph(),this._attachState=Qt.Attaching,(0,i.v)(this.visibilityState===nn.cy.LocallyVisible,721),this.visibilityState=nn.cy.GloballyVisible,this.localChannelContextQueue.forEach((e=>{e.makeVisible()})),this.localChannelContextQueue.clear(),this.deferredAttached.resolve(),this.emit("attaching")})),this.dataStoreContext.once("attached",(()=>{(0,i.v)(this.visibilityState===nn.cy.GloballyVisible,722),this._attachState=Qt.Attached,this.emit("attached")}))}verifyNotClosed(){if(this._disposed)throw new o.iq("Runtime is closed")}identifyLocalChangeInSummarizer(e,t,n){"summarizer"!==this.clientDetails.type||this.localChangesTelemetryCount<=0||(this.mc.logger.sendTelemetryEvent({eventName:e,...(0,Xt.Df)({channelType:n,channelId:t,fluidDataStoreId:this.id,fluidDataStorePackagePath:this.dataStoreContext.packagePath.join("/")}),stack:(0,o.aX)()}),this.localChangesTelemetryCount--)}}async function HC(e,t,n,r,s,o,a){var c,l;let u=s;u=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:UC;return class extends t{async request(t){const n=await super.request(t);return 404===n.status?e(t,this):n}}}((async(e,t)=>{const n=await t.entryPoint.get();return(0,i.v)(void 0!==n.request,1941),n.request(e)}),u);const h=new u(t,n,o,(async e=>((0,i.v)(void 0!==d,1130),await d.finishInitialization(!0),d))),d=new e({runtime:h,context:t,providers:null!==(c=null===(l=t.scope.IFluidDependencySynthesizer)||void 0===l?void 0:l.synthesize(r,{}))&&void 0!==c?c:{},initProps:a});return o||await d.finishInitialization(o),{instance:d,runtime:h}}class VC{constructor(e,t,n,r,i){let s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:UC;if(this.type=e,this.ctor=t,this.optionalProviders=r,this.runtimeClass=s,""===this.type)throw new Error("undefined type member");void 0!==i&&(this.registry=new Dn(i)),this.sharedObjectRegistry=new Map(n.map((e=>[e.type,e])))}get IFluidDataStoreFactory(){return this}get IFluidDataStoreRegistry(){return this.registry}get registryEntry(){return[this.type,Promise.resolve(this)]}async instantiateDataStore(e,t){const{runtime:n}=await HC(this.ctor,e,this.sharedObjectRegistry,this.optionalProviders,this.runtimeClass,t);return n}async createChildInstance(e,t){return this.createNonRootInstanceCore(e.containerRuntime,[...e.packagePath,this.type],t)}async createPeerInstance(e,t){return this.createNonRootInstanceCore(e.containerRuntime,e.packagePath,t)}async createInstance(e,t){return this.createNonRootInstanceCore(e,[this.type],t)}async createRootInstance(e,t,n){const r=t.createDetachedRootDataStore([this.type],e);return this.createInstanceCore(r,n)}async createNonRootInstanceCore(e,t,n){const r=e.createDetachedDataStore(t);return this.createInstanceCore(r,n)}async createInstanceCore(e,t){const{instance:n,runtime:r}=await HC(this.ctor,e,this.sharedObjectRegistry,this.optionalProviders,this.runtimeClass,!1,t);return await e.attachRuntime(this,r),n}}class KC extends VC{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:UC;const o=[...n];n.find((e=>e.type===Gw.Type))||o.push($w.getFactory()),n.find((e=>e.type===uC.Type))||o.push(hC.getFactory()),super(e,t,o,r,i,s)}}const GC=e=>{var t,n;const r=e;return void 0!==(null===r||void 0===r||null===(t=r.factory)||void 0===t?void 0:t.IFluidDataStoreFactory)&&(null===r||void 0===r||null===(n=r.factory)||void 0===n?void 0:n.IFluidDataStoreFactory)===(null===r||void 0===r?void 0:r.factory)},WC=e=>void 0!==(null===e||void 0===e?void 0:e.getFactory);class JC extends fC{constructor(){super(...arguments),this.initialObjectsDirKey="initial-objects-key",this._initialObjects={}}get IRootDataObject(){return this}get initialObjectsDir(){const e=this.root.getSubDirectory(this.initialObjectsDirKey);if(void 0===e)throw new Error("InitialObjects sub-directory was not initialized");return e}async initializingFirstTime(e){this.root.createSubDirectory(this.initialObjectsDirKey);const t=[];Object.entries(e.initialObjects).forEach((e=>{let[n,r]=e;t.push((async()=>{const e=await this.create(r);this.initialObjectsDir.set(n,e.handle)})())})),await Promise.all(t)}async hasInitialized(){const e=[];for(const[t,n]of Array.from(this.initialObjectsDir.entries())){const r=async()=>{const e=await n.get();Object.assign(this._initialObjects,{[t]:e})};e.push(r())}await Promise.all(e)}get initialObjects(){if(0===Object.keys(this._initialObjects).length)throw new Error("Initial Objects were not correctly initialized");return this._initialObjects}async create(e){if(GC(e))return this.createDataObject(e);if(WC(e))return this.createSharedObject(e);throw new Error("Could not create new Fluid object because an unknown object was passed")}async createDataObject(e){const t=e.factory,n=[...this.context.packagePath,t.type],r=await this.context.containerRuntime.createDataStore(n);return await r.entryPoint.get()}createSharedObject(e){const t=e.getFactory();return this.runtime.createChannel(void 0,t.type)}}const ZC="rootDOId";class $C extends bC{constructor(e){const[t,n]=(e=>{var t;const n=new Set,r=new Set;if(new Set([...Object.values(e.initialObjects),...null!==(t=e.dynamicObjectTypes)&&void 0!==t?t:[]]).forEach((e=>{if(WC(e))r.add(e.getFactory());else{if(!GC(e))throw new Error("Entry is neither a DataObject or a SharedObject");n.add([e.factory.type,Promise.resolve(e.factory)])}})),0===n.size&&0===r.size)throw new Error("Container cannot be initialized without any DataTypes");return[Array.from(n),Array.from(r)]})(e),r=new KC("rootDO",JC,n,{},t);super({registryEntries:[r.registryEntry],requestHandlers:[async(e,t)=>{const n=Cn.create(e);if(0===n.pathParts.length)return t.resolveHandle({url:"/".concat(ZC).concat(n.query),headers:e.headers})}],runtimeOptions:{flushMode:nn.WD.Immediate,enableRuntimeIdCompressor:!0},provideEntryPoint:async e=>{const t=await e.getAliasedDataStoreEntryPoint(ZC);if(void 0===t)throw new Error("default dataStore [".concat(ZC,"] must exist"));return t.get()}}),this.rootDataObjectFactory=r,this.initialObjects=e.initialObjects}async containerInitializingFirstTime(e){await this.rootDataObjectFactory.createRootInstance(ZC,e,{initialObjects:this.initialObjects})}}function QC(e){const t=e.user;return(0,i.v)(void 0!==t&&"string"===typeof t.name,787),{userId:t.id,userName:t.name,connections:[]}}const XC=new class{constructor(e){var t,n,r,i;this.props=e;const s=new Fw;this.urlResolver=new Iw(null===(t=this.props)||void 0===t||null===(t=t.connection)||void 0===t?void 0:t.port,null===(n=this.props)||void 0===n||null===(n=n.connection)||void 0===n?void 0:n.domain),this.documentServiceFactory=new yw(null!==(r=null===(i=this.props)||void 0===i||null===(i=i.connection)||void 0===i?void 0:i.tokenProvider)&&void 0!==r?r:s)}async createContainer(e){const t=this.createLoader(e),n=await t.createDetachedContainer({package:"no-dynamic-package",config:{}}),r=await this.getContainerEntryPoint(n),i=Aw({container:n,rootDataObject:r});i.attach=async()=>{if(n.attachState!==Qt.Detached)throw new Error("Cannot attach container. Container is not in detached state.");const e={url:null!==t&&void 0!==t?t:"",headers:{[hn.createNew]:!0}};var t;if(await n.attach(e),void 0===n.resolvedUrl)throw new Error("Resolved Url not available on attached container");return n.resolvedUrl.id};return{container:i,services:this.getContainerServices(n)}}async getContainer(e,t){const n=this.createLoader(t),r=await n.resolve({url:e});return{container:Aw({container:r,rootDataObject:await this.getContainerEntryPoint(r)}),services:this.getContainerServices(r)}}getContainerServices(e){return{audience:(t={container:e,createServiceMember:QC},new Ow(t.container,t.createServiceMember))};var t}createLoader(e){var t;const n=new $C({schema:e}.schema);const r={load:async()=>({module:{fluidExport:n},details:{package:"no-dynamic-package",config:{}}})};return new By({urlResolver:this.urlResolver,documentServiceFactory:this.documentServiceFactory,codeLoader:r,logger:null===(t=this.props)||void 0===t?void 0:t.logger,options:{client:{details:{capabilities:{interactive:!0}},permission:[],scopes:[],user:{id:""},mode:"write"}}})}async getContainerEntryPoint(e){const t=await e.getEntryPoint();return(0,i.v)(void 0!==t.IRootDataObject,2165),t.IRootDataObject}},YC={initialObjects:{diceTree:class{static getFactory(){return new av({})}schematize(e){return this.useFactory()}useFactory(){throw new Error("Use factory to create instance.")}get id(){return this.useFactory()}get attributes(){return this.useFactory()}get handle(){return this.useFactory()}get IFluidLoadable(){return this.useFactory()}getAttachSummary(e,t,n){return this.useFactory()}async summarize(e,t,n,r){return this.useFactory()}isAttached(){return this.useFactory()}connect(e){return this.useFactory()}getGCData(e){return this.useFactory()}}}},ex=document.getElementById("root"),tx=new class{constructor(e){this.scope=e,this.structuralTypes=new Map,this.string=uv,this.number=hv,this.boolean=dv,this.null=fv,this.handle=pv}scoped(e){return"".concat(this.scope,".").concat(e)}nodeSchema(e,t,n,r){const s=this.scoped(e);class o extends em{constructor(e){super(),Qf(e)&&(0,i.v)(jm(e.schema)===this.constructor,2107),(0,i.v)(!(e instanceof em),2108)}get[Qp](){return s}}return o.identifier=s,o.kind=t,o.info=n,o.implicitlyConstructable=r,function(e){Jf(e)&&Object.defineProperty(e,Wf,{value:!0,configurable:!0,enumerable:!1,writable:!1})}(o),o}object(e,t){const n=!0;class r extends(this.nodeSchema(e,Zp.Object,t,!0)){constructor(e){if(super(e),Qf(e))return Um(e,n,this);return Ym(ag(this.constructor),e,n,this)}}return r}map(e,t){if(void 0===t){const t=mv("Map",e);return F(this.structuralTypes,t,(()=>this.namedMap_internal(t,e,!1,!0)))}return this.namedMap_internal(e,t,!0,!0)}namedMap_internal(e,t,n,r){class i extends(this.nodeSchema(e,Zp.Map,t,r)){constructor(e){if(super(e),Qf(e))return Um(e,n,n?this:void 0);return Ym(ag(this.constructor),e,n,n?this:void 0)}}return Object.defineProperties(i.prototype,$m),i}array(e,t){if(void 0===t){const t=mv("Array",e);return F(this.structuralTypes,t,(()=>this.namedArray_internal(t,e,!1,!0)))}return this.namedArray_internal(e,t,!0,!0)}namedArray_internal(e,t,n,r){class i extends(this.nodeSchema(e,Zp.Array,t,r)){get length(){return Vm(this).length}constructor(e){if(super(e),Qf(e))return Um(e,n,n?this:void 0);return Ym(ag(this.constructor),[...e],n,n?this:void 0)}}return Object.defineProperties(i.prototype,Gm),i}optional(e){return new $p(Jp.Optional,e)}fixRecursiveReference(){}}("fluidHelloWorldSample");class nx extends(tx.object("Dice",{value:tx.number})){}const rx=new class{constructor(e,t){this.schema=e,this.initialTree=t}}(nx,(()=>new nx({value:1}))),ix=async()=>{const{container:e}=await XC.createContainer(YC),t=e.initialObjects.diceTree.schematize(rx).root,n=await e.attach();return ax(t,ex),n},sx=async e=>{const{container:t}=await XC.getContainer(e,YC),n=t.initialObjects.diceTree.schematize(rx).root;ax(n,ex)};const ox=document.createElement("template");ox.innerHTML='\n  <style>\n    .wrapper { text-align: center }\n    .dice { font-size: 200px }\n    .roll { font-size: 50px;}\n  </style>\n  <div class="wrapper">\n    <div class="dice"></div>\n    <button class="roll"> Roll </button>\n  </div>\n';const ax=(e,t)=>{t.appendChild(ox.content);const n=t.querySelector(".roll"),r=t.querySelector(".dice");n.onclick=()=>{e.value=Math.floor(6*Math.random())+1};const i=()=>{const t=e.value;r.textContent=String.fromCodePoint(9855+t),r.style.color="hsl(".concat(60*t,", 70%, 30%)")};i(),gv.on(e,"afterChange",i),window.fluidStarted=!0};var cx=n(579);const lx=function(){return async function(){if(window.location.hash)await sx(window.location.hash.substring(1));else{const e=await ix();window.location.hash=e}}(),(0,cx.jsxs)("div",{className:"App",children:[(0,cx.jsx)("header",{className:"App-header",children:"Fluid Dice Example"}),(0,cx.jsx)("header",{className:"App-header down",children:"Made with \u2764\ufe0f by Dikshant"})]})};r.createRoot(document.getElementById("root")).render((0,cx.jsx)(t.StrictMode,{children:(0,cx.jsx)(lx,{})}))})()})();
//# sourceMappingURL=main.0147fb98.js.map